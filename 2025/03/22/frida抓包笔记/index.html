

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="hexi">
  <meta name="keywords" content="">
  
    <meta name="description" content="安卓Frida逆向与抓包实战笔记Frida原理及重要组件 frida注入的原理就是找到目标进程，使用ptrace跟踪目标进程获取mmap在目标进程申请一段内存空间将在目标进程中找到存放frida-agent-32&#x2F;64.so的空间启动执行各种操作由agent去实现。    组件名称 功能描述    frida-gum 提供了inline-hook的核心实现，包含代码跟踪模块Stalker">
<meta property="og:type" content="article">
<meta property="og:title" content="frida抓包笔记">
<meta property="og:url" content="http://example.com/2025/03/22/frida%E6%8A%93%E5%8C%85%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="hexi的个人博客">
<meta property="og:description" content="安卓Frida逆向与抓包实战笔记Frida原理及重要组件 frida注入的原理就是找到目标进程，使用ptrace跟踪目标进程获取mmap在目标进程申请一段内存空间将在目标进程中找到存放frida-agent-32&#x2F;64.so的空间启动执行各种操作由agent去实现。    组件名称 功能描述    frida-gum 提供了inline-hook的核心实现，包含代码跟踪模块Stalker">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/2025/03/22/frida%E6%8A%93%E5%8C%85%E7%AC%94%E8%AE%B0/informatin/book/%E7%AC%94%E8%AE%B0/%E7%85%A7%E7%89%87/image-20240721002300291.png">
<meta property="og:image" content="http://example.com/2025/03/22/frida%E6%8A%93%E5%8C%85%E7%AC%94%E8%AE%B0/image-20240721023344735.png">
<meta property="og:image" content="http://example.com/2025/03/22/frida%E6%8A%93%E5%8C%85%E7%AC%94%E8%AE%B0/informatin/book/%E7%AC%94%E8%AE%B0/%E7%85%A7%E7%89%87/0.png">
<meta property="og:image" content="http://example.com/2025/03/22/frida%E6%8A%93%E5%8C%85%E7%AC%94%E8%AE%B0/image-20240719150546826.png">
<meta property="article:published_time" content="2025-03-22T11:23:21.000Z">
<meta property="article:modified_time" content="2025-03-22T11:24:45.046Z">
<meta property="article:author" content="hexi">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/2025/03/22/frida%E6%8A%93%E5%8C%85%E7%AC%94%E8%AE%B0/informatin/book/%E7%AC%94%E8%AE%B0/%E7%85%A7%E7%89%87/image-20240721002300291.png">
  
  
  
  <title>frida抓包笔记 - hexi的个人博客</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Fluid</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="frida抓包笔记"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-03-22 19:23" pubdate>
          2025年3月22日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          11k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          94 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">frida抓包笔记</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="安卓Frida逆向与抓包实战笔记"><a href="#安卓Frida逆向与抓包实战笔记" class="headerlink" title="安卓Frida逆向与抓包实战笔记"></a>安卓Frida逆向与抓包实战笔记</h2><h5 id="Frida原理及重要组件"><a href="#Frida原理及重要组件" class="headerlink" title="Frida原理及重要组件"></a>Frida原理及重要组件</h5><hr>
<p>frida注入的原理就是找到目标进程，使用ptrace跟踪目标进程获取mmap在目标进程申请一段内存空间将在目标进程中找到存放frida-agent-32&#x2F;64.so的空间启动执行各种操作由agent去实现。</p>
<table>
<thead>
<tr>
<th>组件名称</th>
<th>功能描述</th>
</tr>
</thead>
<tbody><tr>
<td>frida-gum</td>
<td>提供了inline-hook的核心实现，包含代码跟踪模块Stalker，用于内存访问监控的MemoryAccessMonitor，以及符号查询、栈回溯实现、内存扫描、动态代码生成和重定位等功能。</td>
</tr>
<tr>
<td>frida-core</td>
<td>fridahook的核心、具有进程注入、进程间通信、会话管理、脚本生命周期管理等功能，屏蔽部分底层的实现细节并给最终用户提供开箱即用的操作接口。包含frida-server、frida-gadget、frida-agent、frida-helper、frida-inject等关键模块和组件，以及之间的互相通信底座。</td>
</tr>
<tr>
<td>frida-gadget</td>
<td>本身是一个动态库，可以通过重打包修改动态库的依赖或者修改smali代码去实现向三方应用注入gadget，从而实现frida的持久化或免root。</td>
</tr>
<tr>
<td>frida-server</td>
<td>本质上是一个二进制文件，类似于前面学习到的Android_server，需要在目标设备上运行并转发端口，在Frida hook中起到关键作用。</td>
</tr>
</tbody></table>
<p><strong>操作模式</strong></p>
<table>
<thead>
<tr>
<th>操作模式</th>
<th>描述</th>
<th>优点</th>
<th>主要用途</th>
</tr>
</thead>
<tbody><tr>
<td>CLI（命令行）模式</td>
<td>通过命令行直接将JavaScript脚本注入进程中，对进程进行操作</td>
<td>便于直接注入和操作</td>
<td>在较小规模的操作或者需求比较简单的场景中使用</td>
</tr>
<tr>
<td>RPC模式</td>
<td>使用python进行JavaScript脚本的注入工作，实际对进程进行操作的还是JavaScript脚本，可以通过RPC传输给python脚本来进行复杂数据处理</td>
<td>在对复杂数据的处理上可以通过RPC传输给Python脚本来进行，有利于减少被注入进程的性能损耗</td>
<td>在app已经启动，或者我们只关心特定时刻或者特定功能的行为时使用</td>
</tr>
</tbody></table>
<p>注入模式与启动命令</p>
<table>
<thead>
<tr>
<th>注入模式</th>
<th>描述</th>
<th>命令或参数</th>
<th>优点</th>
<th>主要用途</th>
</tr>
</thead>
<tbody><tr>
<td>Spawn模式</td>
<td>将启动App的权限交由Frida来控制，即使目标App已经启动，在使用Frida注入程序时还是会重新启动app</td>
<td>在CLI模式中，Frida通过加上 -f 参数指定包名以spawn模式操作app</td>
<td>适合于需要在app启动时即进行注入的场景，可以在APP启动时即捕获其行为</td>
<td>当需要监控app从启动开始的所以行为时使用</td>
</tr>
<tr>
<td>Attach模式</td>
<td>在目标app已经启动的情况下，frida通过ptrace注入程序从而执行Hook的操作</td>
<td>在CLI模式中，如果不添加 -f 参数，则默认会通过attach模式注入App</td>
<td>适合于已经运行的app，捕获重新启动app，对用户体验影响较小</td>
<td>在app已经启动，或者我们只关心特定时刻或特定功能的行为时使用</td>
</tr>
</tbody></table>
<p>Spawn模式</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">frida</span> -U -f 进程名 -l hook_java.js<br></code></pre></td></tr></table></figure>

<p>attach模式</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">frida</span> -U 进程名 -l hook_java.js<br></code></pre></td></tr></table></figure>



<p>基础语法</p>
<table>
<thead>
<tr>
<th>api名称</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>Java.use(className)</td>
<td>获取指定的java类并使其在javascript代码中可用</td>
</tr>
<tr>
<td>Java.perform(callback)</td>
<td>确保回调函数在Java的主线程上执行</td>
</tr>
<tr>
<td>Java.choose(className, callbacks)</td>
<td>枚举指定类的所有实例</td>
</tr>
<tr>
<td>Java.cast(obj, cls)</td>
<td>将一个Java对象转换成另一个Java类的实例</td>
</tr>
<tr>
<td>Java.enumerateLoadedClasses(callbacks)</td>
<td>枚举进程中存在的所以Java类。</td>
</tr>
<tr>
<td>Java.enumerateClassLoaders(callbacks)</td>
<td>枚举进程中存在的所以Java类加载器</td>
</tr>
<tr>
<td>Java.enumerateMethods(targetClassMethod)</td>
<td>枚举指定类的所有方法</td>
</tr>
</tbody></table>
<p>日志输出语法区别</p>
<table>
<thead>
<tr>
<th>日志方法</th>
<th>描述</th>
<th>区别</th>
</tr>
</thead>
<tbody><tr>
<td>console.log()</td>
<td>使用Javascript直接进行日志打印</td>
<td>多用于在CLI模式中，console.log()直接输出到命令行界面，使用户可以实时查看。在RPC模式中，console.log()同样输出在命令行，但啃被python脚本的输出内容掩盖。</td>
</tr>
<tr>
<td>send()</td>
<td>frida的专有方法，用于发送数据或日志到外部python脚本</td>
<td>多用于RPC模式中，它允许Javascript脚本发送数据到python脚本，python脚本可以进一步处理或记录这些数据。</td>
</tr>
</tbody></table>
<p><strong>Hook普通方法、打印参数和修改返回值</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//定义一个名为hookTest1的函数</span><br>function <span class="hljs-title function_">hookTest1</span><span class="hljs-params">()</span>&#123;<br>	<span class="hljs-comment">//获取一个名为&quot;类名&quot;的Java类，并将其实例赋值给JavaScript变量utils</span><br>    <span class="hljs-type">var</span> <span class="hljs-variable">utils</span> <span class="hljs-operator">=</span> Java.use(<span class="hljs-string">&quot;类名&quot;</span>);<br>    <span class="hljs-comment">//修改&quot;类名&quot;的&quot;method&quot;方法的实现。这个新的实现会接收两个参数（a和b）</span><br>    utils.method.implementation = function(a, b)&#123;<br>	    <span class="hljs-comment">//将参数a和b的值改为123和456。</span><br>        a = <span class="hljs-number">123</span>;<br>        b = <span class="hljs-number">456</span>;<br>        <span class="hljs-comment">//调用修改过的&quot;method&quot;方法，并将返回值存储在`retval`变量中</span><br>        <span class="hljs-type">var</span> <span class="hljs-variable">retval</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.method(a, b);<br>        <span class="hljs-comment">//在控制台上打印参数a，b的值以及&quot;method&quot;方法的返回值</span><br>        console.log(a, b, retval);<br>        <span class="hljs-comment">//返回&quot;method&quot;方法的返回值</span><br>        <span class="hljs-keyword">return</span> retval;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>Hook重载参数</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// .overload()</span><br><span class="hljs-comment">// .overload(&#x27;自定义参数&#x27;)</span><br><span class="hljs-comment">// .overload(&#x27;int&#x27;)</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">hookTest2</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-keyword">var</span> utils = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.zj.wuaipojie.Demo&quot;</span>);<br>    <span class="hljs-comment">//overload定义重载函数，根据函数的参数类型填</span><br>    utils.<span class="hljs-property">Inner</span>.<span class="hljs-title function_">overload</span>(<span class="hljs-string">&#x27;com.zj.wuaipojie.Demo$Animal&#x27;</span>,<span class="hljs-string">&#x27;java.lang.String&#x27;</span>).<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">a，b</span>)&#123;<br>        b = <span class="hljs-string">&quot;aaaaaaaaaa&quot;</span>;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-title class_">Inner</span>(a,b);<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(b);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>Hook构造函数</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hookTest3</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-keyword">var</span> utils = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.zj.wuaipojie.Demo&quot;</span>);<br>    <span class="hljs-comment">//修改类的构造函数的实现，$init表示构造函数</span><br>    utils.<span class="hljs-property">$init</span>.<span class="hljs-title function_">overload</span>(<span class="hljs-string">&#x27;java.lang.String&#x27;</span>).<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">str</span>)&#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(str);<br>        str = <span class="hljs-string">&quot;52&quot;</span>;<br>        <span class="hljs-variable language_">this</span>.$init(str);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>Hook字段</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hookTest5</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>        <span class="hljs-comment">//静态字段的修改</span><br>        <span class="hljs-keyword">var</span> utils = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.zj.wuaipojie.Demo&quot;</span>);<br>        <span class="hljs-comment">//修改类的静态字段&quot;flag&quot;的值</span><br>        utils.<span class="hljs-property">staticField</span>.<span class="hljs-property">value</span> = <span class="hljs-string">&quot;我是被修改的静态变量&quot;</span>;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(utils.<span class="hljs-property">staticField</span>.<span class="hljs-property">value</span>);<br>        <span class="hljs-comment">//非静态字段的修改</span><br>        <span class="hljs-comment">//使用`Java.choose()`枚举类的所有实例</span><br>        <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">choose</span>(<span class="hljs-string">&quot;com.zj.wuaipojie.Demo&quot;</span>, &#123;<br>            <span class="hljs-attr">onMatch</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">obj</span>)&#123;<br>	            <span class="hljs-comment">//修改实例的非静态字段&quot;_privateInt&quot;的值为&quot;123456&quot;，并修改非静态字段&quot;privateInt&quot;的值为9999。</span><br>                obj.<span class="hljs-property">_privateInt</span>.<span class="hljs-property">value</span> = <span class="hljs-string">&quot;123456&quot;</span>; <span class="hljs-comment">//字段名与函数名相同 前面加个下划线</span><br>                obj.<span class="hljs-property">privateInt</span>.<span class="hljs-property">value</span> = <span class="hljs-number">9999</span>;<br>            &#125;,<br>            <span class="hljs-attr">onComplete</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br><br>            &#125;<br>        &#125;);<br>    &#125;);<br>    <br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>hook内部类</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hookTest6</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>        <span class="hljs-comment">//内部类</span><br>        <span class="hljs-keyword">var</span> innerClass = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.zj.wuaipojie.Demo$innerClass&quot;</span>);<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(innerClass);<br>        innerClass.<span class="hljs-property">$init</span>.<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;eeeeeeee&quot;</span>);<br>        &#125;<br><br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>主动调用（静态方法）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hookTest7</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>         <span class="hljs-keyword">var</span> <span class="hljs-title class_">ClassName</span> = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&quot;com.zj.wuaipojie.Demo&quot;</span>); <br>         <span class="hljs-keyword">var</span> ret = <span class="hljs-title class_">ClassName</span>.<span class="hljs-title function_">privateFunc</span>(<span class="hljs-string">&quot;zzzzzz&quot;</span>);<br>         <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(ret);<br>    &#125;)<br>&#125;<br></code></pre></td></tr></table></figure>

<p>主动调用（非静态方法）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hookTest8</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>      <span class="hljs-keyword">var</span> ret = <span class="hljs-literal">null</span>;<br>      <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>        <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">choose</span>(<span class="hljs-string">&quot;com.zj.wuaipojie.Demo&quot;</span>,&#123;    <span class="hljs-comment">//要hook的类</span><br>            <span class="hljs-attr">onMatch</span>:<span class="hljs-keyword">function</span>(<span class="hljs-params">instance</span>)&#123;<br>                ret=instance.<span class="hljs-title function_">privateFunc</span>(<span class="hljs-string">&quot;aaaaaaa&quot;</span>); <span class="hljs-comment">//要hook的方法 privateFunc是可替代的方法，aaaaaa是参数</span><br>            &#125;,<br>            <span class="hljs-attr">onComplete</span>:<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>            	<span class="hljs-comment">//console.log(&quot;result: &quot; + ret);</span><br>            &#125;<br>        &#125;);<br>    &#125;)<br>    <span class="hljs-comment">//return ret;     </span><br>    &#125;)<br>&#125;<br></code></pre></td></tr></table></figure>



<h5 id="Frida-Native-Hook"><a href="#Frida-Native-Hook" class="headerlink" title="Frida-Native-Hook"></a>Frida-Native-Hook</h5><hr>
<p>Process、Module、Memory基础</p>
<p><strong>process</strong></p>
<p><code>Process</code> 对象代表当前被Hook的进程，能获取进程的信息，枚举模块，枚举范围等</p>
<table>
<thead>
<tr>
<th>API</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>process.id</td>
<td>返回附加目标进程的PID</td>
</tr>
<tr>
<td>process.isDebuggerAttached()</td>
<td>检测当前是否对目标程序已经附加</td>
</tr>
<tr>
<td>process.enumerateModuless()</td>
<td>枚举当前加载的模块，返回模块对象的数组</td>
</tr>
<tr>
<td>process.enumerateThreads()</td>
<td>枚举当前所有的线程，返回包含<code>id</code>，<code>state</code>，<code>context</code>等属性的对象数组</td>
</tr>
</tbody></table>
<p><strong>Module</strong></p>
<p><code>Module</code>对象代表一个加载到进程的模块（例如，在Windows上的DLL，或者Linux&#x2F;Android上的.so文件），能查询模块的信息，如模块的基地址、名称、导入\导出的函数等。</p>
<table>
<thead>
<tr>
<th>API</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>Module.load()</td>
<td>加载指定so文件，返回一个Module对象</td>
</tr>
<tr>
<td>enumerateImports()</td>
<td>枚举所有Import库函数，返回Module数组对象</td>
</tr>
<tr>
<td>enumerateExports()</td>
<td>枚举所有Export库函数，返回Module数组对象</td>
</tr>
<tr>
<td>enumerateSymbols()</td>
<td>枚举所有Symbol库函数，返回Module数组对象</td>
</tr>
<tr>
<td>Module.findExportByName(exportName)、Module.getExportByName(exportName)</td>
<td>寻找指定so中export库中的函数地址</td>
</tr>
<tr>
<td>Module.findBaseAddress(name)、Module.getBaseAddress(name)</td>
<td>返回so的基地址</td>
</tr>
</tbody></table>
<p><strong>Memory</strong></p>
<p><code>Memory</code>是一个工具对象，提供直接读取和修改进程内存的功能，能够读取特定地址的值、写入数据、分配内存等</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td><code>Memory.copy()</code></td>
<td>复制内存</td>
</tr>
<tr>
<td><code>Memory.scan()</code></td>
<td>搜索内存中特定模式的数据</td>
</tr>
<tr>
<td><code>Memory.scanSync()</code></td>
<td>同上，但返回多个匹配的数据</td>
</tr>
<tr>
<td><code>Memory.alloc()</code></td>
<td>在目标进程的堆上申请指定大小的内存，返回一个<code>NativePointer</code></td>
</tr>
<tr>
<td><code>Memory.writeByteArray()</code></td>
<td>将字节数组写入一个指定内存</td>
</tr>
<tr>
<td><code>Memory.readByteArray</code></td>
<td>读取内存</td>
</tr>
</tbody></table>
<p><strong>枚举导入导出表</strong></p>
<p><strong>导出表（Export Table）</strong>：列出了库中可以被其他程序或库访问的所有公开函数和符号的名称。</p>
<p><strong>导入表（Import Table）</strong>：列出了库需要从其他库中调用的函数和符号的名称。</p>
<p>简而言之，导出表告诉其他程序：“这些是我提供的功能。”，而导入表则表示：“这些是我需要的功能。”。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hookTest1</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>        <span class="hljs-comment">//打印导入表</span><br>        <span class="hljs-keyword">var</span> imports = <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">enumerateImports</span>(<span class="hljs-string">&quot;lib52pojie.so&quot;</span>);<br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i =<span class="hljs-number">0</span>; i &lt; imports.<span class="hljs-property">length</span>;i++)&#123;<br>            <span class="hljs-keyword">if</span>(imports[i].<span class="hljs-property">name</span> == <span class="hljs-string">&quot;vip&quot;</span>)&#123;<br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(imports[i])); <span class="hljs-comment">//通过JSON.stringify打印object数据</span><br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(imports[i].<span class="hljs-property">address</span>);<br>            &#125;<br>        &#125;<br>        <span class="hljs-comment">//打印导出表</span><br>        <span class="hljs-keyword">var</span> <span class="hljs-built_in">exports</span> = <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">enumerateExports</span>(<span class="hljs-string">&quot;lib52pojie.so&quot;</span>);<br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i =<span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">exports</span>.<span class="hljs-property">length</span>;i++)&#123;<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-built_in">exports</span>[i]));<br>        &#125;<br>        <br>    &#125;)<br>&#125;<br></code></pre></td></tr></table></figure>



<p><strong>Native函数的基础Hook打印</strong></p>
<ul>
<li>整数型、布尔值类型、char类型</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hookTest2</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>        <span class="hljs-comment">//根据导出函数名打印地址</span><br>        <span class="hljs-keyword">var</span> helloAddr = <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">findExportByName</span>(<span class="hljs-string">&quot;lib52pojie.so&quot;</span>,<span class="hljs-string">&quot;Java_com_zj_wuaipojie_util_SecurityUtil_checkVip&quot;</span>);<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(helloAddr); <br>        <span class="hljs-keyword">if</span>(helloAddr != <span class="hljs-literal">null</span>)&#123;<br>	        <span class="hljs-comment">//Interceptor.attach是Frida里的一个拦截器</span><br>            <span class="hljs-title class_">Interceptor</span>.<span class="hljs-title function_">attach</span>(helloAddr,&#123;<br>	            <span class="hljs-comment">//onEnter里可以打印和修改参数</span><br>                <span class="hljs-attr">onEnter</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">args</span>)&#123;  <span class="hljs-comment">//args传入参数</span><br>                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(args[<span class="hljs-number">0</span>]);  <span class="hljs-comment">//打印第一个参数的值</span><br>                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-property">x1</span>);  <span class="hljs-comment">// 打印寄存器内容</span><br>                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(args[<span class="hljs-number">1</span>].<span class="hljs-title function_">toInt32</span>()); <span class="hljs-comment">//toInt32()转十进制</span><br>					<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(args[<span class="hljs-number">2</span>].<span class="hljs-title function_">readCString</span>()); <span class="hljs-comment">//读取字符串 char类型</span><br>					<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">hexdump</span>(args[<span class="hljs-number">2</span>])); <span class="hljs-comment">//内存dump</span><br><br>                &#125;,<br>                <span class="hljs-comment">//onLeave里可以打印和修改返回值</span><br>                <span class="hljs-attr">onLeave</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">retval</span>)&#123;  <span class="hljs-comment">//retval返回值</span><br>                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(retval);<br>                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;retval&quot;</span>,retval.<span class="hljs-title function_">toInt32</span>());<br>                &#125;<br>            &#125;)<br>        &#125;<br>    &#125;)<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>字符串类型</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hookTest2</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>        <span class="hljs-comment">//根据导出函数名打印地址</span><br>        <span class="hljs-keyword">var</span> helloAddr = <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">findExportByName</span>(<span class="hljs-string">&quot;lib52pojie.so&quot;</span>,<span class="hljs-string">&quot;Java_com_zj_wuaipojie_util_SecurityUtil_vipLevel&quot;</span>);<br>        <span class="hljs-keyword">if</span>(helloAddr != <span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-title class_">Interceptor</span>.<span class="hljs-title function_">attach</span>(helloAddr,&#123;<br>                <span class="hljs-comment">//onEnter里可以打印和修改参数</span><br>                <span class="hljs-attr">onEnter</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">args</span>)&#123;  <span class="hljs-comment">//args传入参数</span><br>                    <span class="hljs-comment">// 方法一</span><br>                    <span class="hljs-keyword">var</span> jString = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">cast</span>(args[<span class="hljs-number">2</span>], <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&#x27;java.lang.String&#x27;</span>));<br>                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;参数:&quot;</span>, jString.<span class="hljs-title function_">toString</span>());<br>                    <span class="hljs-comment">// 方法二</span><br>                    <span class="hljs-keyword">var</span> <span class="hljs-title class_">JNIEnv</span> = <span class="hljs-title class_">Java</span>.<span class="hljs-property">vm</span>.<span class="hljs-title function_">getEnv</span>();<br>                    <span class="hljs-keyword">var</span> originalStrPtr = <span class="hljs-title class_">JNIEnv</span>.<span class="hljs-title function_">getStringUtfChars</span>(args[<span class="hljs-number">2</span>], <span class="hljs-literal">null</span>).<span class="hljs-title function_">readCString</span>();	<br>                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;参数:&quot;</span>, originalStrPtr);				<br>                &#125;,<br>                <span class="hljs-comment">//onLeave里可以打印和修改返回值</span><br>                <span class="hljs-attr">onLeave</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">retval</span>)&#123;  <span class="hljs-comment">//retval返回值</span><br>                    <span class="hljs-keyword">var</span> returnedJString = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">cast</span>(retval, <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&#x27;java.lang.String&#x27;</span>));<br>                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;返回值:&quot;</span>, returnedJString.<span class="hljs-title function_">toString</span>());<br>                &#125;<br>            &#125;)<br>        &#125;<br>    &#125;)<br>&#125;<br></code></pre></td></tr></table></figure>



<p><strong>Native函数的基础Hook修改</strong></p>
<ul>
<li>整数型修改</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hookTest3</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>        <span class="hljs-comment">//根据导出函数名打印地址</span><br>        <span class="hljs-keyword">var</span> helloAddr = <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">findExportByName</span>(<span class="hljs-string">&quot;lib52pojie.so&quot;</span>,<span class="hljs-string">&quot;func_four&quot;</span>);<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(helloAddr);<br>        <span class="hljs-keyword">if</span>(helloAddr != <span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-title class_">Interceptor</span>.<span class="hljs-title function_">attach</span>(helloAddr,&#123;<br>                <span class="hljs-attr">onEnter</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">args</span>)&#123;  <span class="hljs-comment">//args参数</span><br>                    args[<span class="hljs-number">0</span>] = <span class="hljs-title function_">ptr</span>(<span class="hljs-number">1000</span>); <span class="hljs-comment">//第一个参数修改为整数 1000，先转为指针再赋值</span><br>                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(args[<span class="hljs-number">0</span>]);<br>                      <br>                &#125;,<br>                <span class="hljs-attr">onLeave</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">retval</span>)&#123;  <span class="hljs-comment">//retval返回值</span><br>                    retval.<span class="hljs-title function_">replace</span>(<span class="hljs-number">20000</span>);  <span class="hljs-comment">//返回值修改</span><br>                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;retval&quot;</span>,retval.<span class="hljs-title function_">toInt32</span>());<br>                &#125;<br>            &#125;)<br>        &#125;<br>    &#125;)<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>字符串类型修改</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hookTest2</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>        <span class="hljs-comment">//根据导出函数名打印地址</span><br>        <span class="hljs-keyword">var</span> helloAddr = <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">findExportByName</span>(<span class="hljs-string">&quot;lib52pojie.so&quot;</span>,<span class="hljs-string">&quot;Java_com_zj_wuaipojie_util_SecurityUtil_vipLevel&quot;</span>);<br>        <span class="hljs-keyword">if</span>(helloAddr != <span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-title class_">Interceptor</span>.<span class="hljs-title function_">attach</span>(helloAddr,&#123;<br>                <span class="hljs-comment">//onEnter里可以打印和修改参数</span><br>                <span class="hljs-attr">onEnter</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">args</span>)&#123;  <span class="hljs-comment">//args传入参数</span><br>                    <span class="hljs-keyword">var</span> <span class="hljs-title class_">JNIEnv</span> = <span class="hljs-title class_">Java</span>.<span class="hljs-property">vm</span>.<span class="hljs-title function_">getEnv</span>();<br>                    <span class="hljs-keyword">var</span> originalStrPtr = <span class="hljs-title class_">JNIEnv</span>.<span class="hljs-title function_">getStringUtfChars</span>(args[<span class="hljs-number">2</span>], <span class="hljs-literal">null</span>).<span class="hljs-title function_">readCString</span>();	<br>                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;参数:&quot;</span>, originalStrPtr);<br>                    <span class="hljs-keyword">var</span> modifiedContent = <span class="hljs-string">&quot;至尊&quot;</span>;<br>                    <span class="hljs-keyword">var</span> newJString = <span class="hljs-title class_">JNIEnv</span>.<span class="hljs-title function_">newStringUtf</span>(modifiedContent);<br>                    args[<span class="hljs-number">2</span>] = newJString;				<br>                &#125;,<br>                <span class="hljs-comment">//onLeave里可以打印和修改返回值</span><br>                <span class="hljs-attr">onLeave</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">retval</span>)&#123;  <span class="hljs-comment">//retval返回值</span><br>                    <span class="hljs-keyword">var</span> returnedJString = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">cast</span>(retval, <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&#x27;java.lang.String&#x27;</span>));<br>                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;返回值:&quot;</span>, returnedJString.<span class="hljs-title function_">toString</span>());<br>                    <span class="hljs-keyword">var</span> <span class="hljs-title class_">JNIEnv</span> = <span class="hljs-title class_">Java</span>.<span class="hljs-property">vm</span>.<span class="hljs-title function_">getEnv</span>();<br>                    <span class="hljs-keyword">var</span> modifiedContent = <span class="hljs-string">&quot;无敌&quot;</span>;<br>                    <span class="hljs-keyword">var</span> newJString = <span class="hljs-title class_">JNIEnv</span>.<span class="hljs-title function_">newStringUtf</span>(modifiedContent);<br>                    retval.<span class="hljs-title function_">replace</span>(newJString);<br>                &#125;<br>            &#125;)<br>        &#125;<br>    &#125;)<br>&#125;<br></code></pre></td></tr></table></figure>



<p><strong>SO基址的获取方式</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> moduleAddr1 = <span class="hljs-title class_">Process</span>.<span class="hljs-title function_">findModuleByName</span>(<span class="hljs-string">&quot;lib52pojie.so&quot;</span>).<span class="hljs-property">base</span>;  <br><span class="hljs-keyword">var</span> moduleAddr2 = <span class="hljs-title class_">Process</span>.<span class="hljs-title function_">getModuleByName</span>(<span class="hljs-string">&quot;lib52pojie.so&quot;</span>).<span class="hljs-property">base</span>;  <br><span class="hljs-keyword">var</span> moduleAddr3 = <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">findBaseAddress</span>(<span class="hljs-string">&quot;lib52pojie.so&quot;</span>);<br></code></pre></td></tr></table></figure>



<p><strong>Hook未导出函数与函数地址计算</strong></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hookTest6</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>        <span class="hljs-comment">//根据导出函数名打印基址</span><br>        <span class="hljs-keyword">var</span> soAddr = <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">findBaseAddress</span>(<span class="hljs-string">&quot;lib52pojie.so&quot;</span>);<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(soAddr);<br>        <span class="hljs-keyword">var</span> funcaddr = soAddr.<span class="hljs-title function_">add</span>(<span class="hljs-number">0x1071C</span>);  <br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(funcaddr);<br>        <span class="hljs-keyword">if</span>(funcaddr != <span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-title class_">Interceptor</span>.<span class="hljs-title function_">attach</span>(funcaddr,&#123;<br>                <span class="hljs-attr">onEnter</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">args</span>)&#123;  <span class="hljs-comment">//args参数</span><br> <br>                &#125;,<br>                <span class="hljs-attr">onLeave</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">retval</span>)&#123;  <span class="hljs-comment">//retval返回值</span><br>                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(retval.<span class="hljs-title function_">toInt32</span>());<br>                &#125;<br>            &#125;)<br>        &#125;<br>    &#125;)<br>&#125;<br></code></pre></td></tr></table></figure>

<p>函数地址计算</p>
<ol>
<li>安卓里一般32 位的 so 中都是<code>thumb</code>指令，64 位的 so 中都是<code>arm</code>指令</li>
<li>通过IDA里的opcode bytes来判断，arm 指令为 4 个字节(options -&gt; general -&gt; Number of opcode bytes (non-graph) 输入4)</li>
<li>thumb 指令，函数地址计算方式： so 基址 + 函数在 so 中的偏移 + 1<br>arm 指令，函数地址计算方式： so 基址 + 函数在 so 中的偏移</li>
</ol>
<p>Frida写数据</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">//一般写在app的私有目录里，不然会报错:failed to open file (Permission denied)(实际上就是权限不足)</span><br><span class="hljs-keyword">var</span> file_path = <span class="hljs-string">&quot;/data/user/0/com.zj.wuaipojie/test.txt&quot;</span>;<br><span class="hljs-keyword">var</span> file_handle = <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(file_path, <span class="hljs-string">&quot;wb&quot;</span>);<br><span class="hljs-keyword">if</span> (file_handle &amp;&amp; file_handle != <span class="hljs-literal">null</span>) &#123;<br>        file_handle.<span class="hljs-title function_">write</span>(data); <span class="hljs-comment">//写入数据</span><br>        file_handle.<span class="hljs-title function_">flush</span>(); <span class="hljs-comment">//刷新</span><br>        file_handle.<span class="hljs-title function_">close</span>(); <span class="hljs-comment">//关闭</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>Frida_inlineHook与读写汇编</p>
<p>什么是inlinehook？ Inline hook（内联钩子）是一种在程序运行时修改函数执行流程的技术。<strong>它通过修改函数的原始代码，将目标函数的执行路径重定向到自定义的代码段，从而实现对目标函数的拦截和修改。</strong> 简单来说就是可以对任意地址的指令进行hook读写操作</p>
<p>Frida的inlinehook不是太稳定，崩溃是基操，另外新版的frida兼容性会比较好</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">inline_hook</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">var</span> soAddr = <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">findBaseAddress</span>(<span class="hljs-string">&quot;lib52pojie.so&quot;</span>);<br>    <span class="hljs-keyword">if</span> (soAddr) &#123;<br>        <span class="hljs-keyword">var</span> func_addr = soAddr.<span class="hljs-title function_">add</span>(<span class="hljs-number">0x10428</span>);<br>        <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>            <span class="hljs-title class_">Interceptor</span>.<span class="hljs-title function_">attach</span>(func_addr, &#123;<br>                <span class="hljs-attr">onEnter</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">args</span>) &#123;<br>                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-property">x22</span>); <span class="hljs-comment">//注意此时就没有args概念了</span><br>                    <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-property">x22</span> = <span class="hljs-title function_">ptr</span>(<span class="hljs-number">1</span>); <span class="hljs-comment">//赋值方法参考上一节课</span><br>                &#125;,<br>                <span class="hljs-attr">onLeave</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">retval</span>) &#123;<br>                &#125;<br>            &#125;<br>            )<br>        &#125;)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>将地址的指令解析成汇编</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> soAddr = <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">findBaseAddress</span>(<span class="hljs-string">&quot;lib52pojie.so&quot;</span>);<br><span class="hljs-keyword">var</span> codeAddr = <span class="hljs-title class_">Instruction</span>.<span class="hljs-title function_">parse</span>(soAddr.<span class="hljs-title function_">add</span>(<span class="hljs-number">0x10428</span>));<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(codeAddr.<span class="hljs-title function_">toString</span>());<br></code></pre></td></tr></table></figure>

<p>arm转hex</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> soAddr = <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">findBaseAddress</span>(<span class="hljs-string">&quot;lib52pojie.so&quot;</span>);<br><span class="hljs-keyword">var</span> codeAddr = soAddr.<span class="hljs-title function_">add</span>(<span class="hljs-number">0x10428</span>);<br><span class="hljs-title class_">Memory</span>.<span class="hljs-title function_">patchCode</span>(codeAddr, <span class="hljs-number">4</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">code</span>) &#123;<br>    <span class="hljs-keyword">const</span> writer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Arm64Writer</span>(code, &#123; <span class="hljs-attr">pc</span>: codeAddr &#125;);<br>    writer.<span class="hljs-title function_">putBytes</span>(<span class="hljs-title function_">hexToBytes</span>(<span class="hljs-string">&quot;20008052&quot;</span>));<br>    writer.<span class="hljs-title function_">flush</span>();<br>&#125;);<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">hexToBytes</span>(<span class="hljs-params">str</span>) &#123;<br>    <span class="hljs-keyword">var</span> pos = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">var</span> len = str.<span class="hljs-property">length</span>;<br>    <span class="hljs-keyword">if</span> (len % <span class="hljs-number">2</span> != <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    len /= <span class="hljs-number">2</span>;<br>    <span class="hljs-keyword">var</span> hexA = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; len; i++) &#123;<br>        <span class="hljs-keyword">var</span> s = str.<span class="hljs-title function_">substr</span>(pos, <span class="hljs-number">2</span>);<br>        <span class="hljs-keyword">var</span> v = <span class="hljs-built_in">parseInt</span>(s, <span class="hljs-number">16</span>);<br>        hexA.<span class="hljs-title function_">push</span>(v);<br>        pos += <span class="hljs-number">2</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> hexA;<br>&#125;<br></code></pre></td></tr></table></figure>



<p><code>普通函数与jni函数的主动调用</code></p>
<table>
<thead>
<tr>
<th>数据类型</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>void</td>
<td>无返回值</td>
</tr>
<tr>
<td>pointer</td>
<td>指针</td>
</tr>
<tr>
<td>int</td>
<td>整数</td>
</tr>
<tr>
<td>long</td>
<td>长整数</td>
</tr>
<tr>
<td>char</td>
<td>字符</td>
</tr>
<tr>
<td>float</td>
<td>浮点数</td>
</tr>
<tr>
<td>double</td>
<td>双精度浮点数</td>
</tr>
<tr>
<td>bool</td>
<td>布尔值</td>
</tr>
</tbody></table>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> funcAddr = <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">findBaseAddress</span>(<span class="hljs-string">&quot;lib52pojie.so&quot;</span>).<span class="hljs-title function_">add</span>(<span class="hljs-number">0x1054C</span>);<br><span class="hljs-comment">//声明函数指针</span><br><span class="hljs-comment">//NativeFunction的第一个参数是地址，第二个参数是返回值类型，第三个[]里的是传入的参数类型(有几个就填几个)</span><br><span class="hljs-keyword">var</span> aesAddr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NativeFunction</span>(funcAddr , <span class="hljs-string">&#x27;pointer&#x27;</span>, [<span class="hljs-string">&#x27;pointer&#x27;</span>, <span class="hljs-string">&#x27;pointer&#x27;</span>]);<br><span class="hljs-keyword">var</span> encry_text = <span class="hljs-title class_">Memory</span>.<span class="hljs-title function_">allocUtf8String</span>(<span class="hljs-string">&quot;OOmGYpk6s0qPSXEPp4X31g==&quot;</span>);    <span class="hljs-comment">//开辟一个指针存放字符串       </span><br><span class="hljs-keyword">var</span> key = <span class="hljs-title class_">Memory</span>.<span class="hljs-title function_">allocUtf8String</span>(<span class="hljs-string">&#x27;wuaipojie0123456&#x27;</span>); <br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">aesAddr</span>(encry_text ,key).<span class="hljs-title function_">readCString</span>());<br></code></pre></td></tr></table></figure>

<h5 id="frida-bypass"><a href="#frida-bypass" class="headerlink" title="frida bypass"></a>frida bypass</h5><hr>
<p><code>D-Bus检测</code></p>
<p>D-Bus是一种进程间通信(IPC)和远程过程调用(RPC)机制,最初是为Linux开发的,目的是用一个统一的协议替代现有的和竞争的IPC解决方案。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">check_dbus</span><span class="hljs-params">()</span> </span>&#123;  <br>    <span class="hljs-comment">// 定义一个socket地址结构体变量sa  </span><br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">sockaddr_in</span> sa;  <br>    <span class="hljs-comment">// 创建一个socket文件描述符  </span><br>    <span class="hljs-type">int</span> sock;  <br>    <span class="hljs-comment">// 定义一个字符数组res，用于存储接收到的数据  </span><br>    <span class="hljs-type">char</span> res[<span class="hljs-number">7</span>];  <br>  <br>    <span class="hljs-comment">// 循环遍历所有可能的端口号，从0到65535  </span><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">65535</span>; i++) &#123;  <br>        <span class="hljs-comment">// 创建一个新的socket连接  </span><br>        sock = <span class="hljs-built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="hljs-number">0</span>);  <br>        <span class="hljs-comment">// 设置socket地址结构体的端口号  </span><br>        sa.sin_port = <span class="hljs-built_in">htons</span>(i);  <br>        <span class="hljs-comment">// 尝试连接到当前端口  </span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">connect</span>(sock, (<span class="hljs-keyword">struct</span> sockaddr*)&amp;sa, <span class="hljs-built_in">sizeof</span>(sa)) != <span class="hljs-number">-1</span>) &#123;  <br>            <span class="hljs-comment">// 如果连接成功，记录日志信息，表示发现了一个开放的端口  </span><br>            __android_log_print(ANDROID_LOG_VERBOSE, <span class="hljs-string">&quot;ZJ595&quot;</span>, <span class="hljs-string">&quot;FRIDA DETECTION [1]: Open Port: %d&quot;</span>, i);  <br>            <span class="hljs-comment">// 初始化res数组，清零  </span><br>            <span class="hljs-built_in">memset</span>(res, <span class="hljs-number">0</span>, <span class="hljs-number">7</span>);  <br>            <span class="hljs-comment">// 向socket发送一个空字节  </span><br>            <span class="hljs-built_in">send</span>(sock, <span class="hljs-string">&quot;\x00&quot;</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>); <span class="hljs-comment">// 注意这里的NULL被替换为0  </span><br>            <span class="hljs-comment">// 发送AUTH请求  </span><br>            <span class="hljs-built_in">send</span>(sock, <span class="hljs-string">&quot;AUTH\r\n&quot;</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>);  <br>            <span class="hljs-comment">// 等待100微秒  </span><br>            <span class="hljs-built_in">usleep</span>(<span class="hljs-number">100</span>);  <br>            <span class="hljs-comment">// 尝试接收响应  </span><br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">recv</span>(sock, res, <span class="hljs-number">6</span>, MSG_DONTWAIT) != <span class="hljs-number">-1</span>) &#123;  <br>                <span class="hljs-comment">// 如果接收到响应，检查响应内容是否为&quot;REJECT&quot;  </span><br>                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(res, <span class="hljs-string">&quot;REJECT&quot;</span>) == <span class="hljs-number">0</span>) &#123;  <br>                    <span class="hljs-comment">// 如果是，关闭socket并返回true，表示检测到了Frida服务器  </span><br>                    <span class="hljs-built_in">close</span>(sock);  <br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// Frida server detected  </span><br>                &#125;  <br>            &#125;  <br>        &#125;  <br>        <span class="hljs-comment">// 如果当前端口连接失败或没有检测到Frida服务器，关闭socket  </span><br>        <span class="hljs-built_in">close</span>(sock);  <br>    &#125;  <br>    <span class="hljs-comment">// 如果遍历完所有端口都没有检测到Frida服务器，返回false  </span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">// No Frida server detected  </span><br>&#125;  <br>  <br></code></pre></td></tr></table></figure>



<p><code>检测fd</code></p>
<p>&#x2F;proc&#x2F;pid&#x2F;fd 目录的作用在于提供了一种方便的方式来查看进程的文件描述符信息，这对于调试和监控进程非常有用。通过查看文件描述符信息，可以了解进程打开了哪些文件、网络连接等，帮助开发者和系统管理员进行问题排查和分析工作。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">check_fd</span><span class="hljs-params">()</span> </span>&#123;  <br>    DIR *dir = <span class="hljs-literal">NULL</span>;  <br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">dirent</span> *entry;  <br>    <span class="hljs-type">char</span> link_name[<span class="hljs-number">100</span>];  <br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">100</span>];  <br>    <span class="hljs-type">bool</span> ret = <span class="hljs-literal">false</span>;  <br>    <span class="hljs-keyword">if</span> ((dir = <span class="hljs-built_in">opendir</span>(<span class="hljs-string">&quot;/proc/self/fd/&quot;</span>)) == <span class="hljs-literal">NULL</span>) &#123;  <br>        <span class="hljs-built_in">LOGI</span>(<span class="hljs-string">&quot; %s - %d  error:%s&quot;</span>, __FILE__, __LINE__, <span class="hljs-built_in">strerror</span>(errno));  <br>    &#125; <span class="hljs-keyword">else</span> &#123;  <br>        entry = <span class="hljs-built_in">readdir</span>(dir);  <br>        <span class="hljs-keyword">while</span> (entry) &#123;  <br>            <span class="hljs-keyword">switch</span> (entry-&gt;d_type) &#123;  <br>                <span class="hljs-keyword">case</span> DT_LNK:  <br>                    <span class="hljs-built_in">sprintf</span>(link_name, <span class="hljs-string">&quot;%s/%s&quot;</span>, <span class="hljs-string">&quot;/proc/self/fd/&quot;</span>, entry-&gt;d_name);  <br>                    <span class="hljs-built_in">readlink</span>(link_name, buf, <span class="hljs-built_in">sizeof</span>(buf));  <br>                    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strstr</span>(buf, <span class="hljs-string">&quot;frida&quot;</span>) || <span class="hljs-built_in">strstr</span>(buf, <span class="hljs-string">&quot;gum-js-loop&quot;</span>) ||  <br>                        <span class="hljs-built_in">strstr</span>(buf, <span class="hljs-string">&quot;gmain&quot;</span>) ||  <br>                        <span class="hljs-built_in">strstr</span>(buf, <span class="hljs-string">&quot;-gadget&quot;</span>) || <span class="hljs-built_in">strstr</span>(buf, <span class="hljs-string">&quot;linjector&quot;</span>)) &#123;    <span class="hljs-comment">//如果链接文件内容中包含特定的字符串，例如&quot;frida&quot;、&quot;gum-js-loop&quot;等，则进入条件判断块。</span><br>                        <span class="hljs-built_in">LOGI</span>(<span class="hljs-string">&quot;check_fd -&gt; find frida:%s&quot;</span>, buf);  <br>                        ret = <span class="hljs-literal">true</span>;  <br>                    &#125;  <br>                    <span class="hljs-keyword">break</span>;  <br>                <span class="hljs-keyword">default</span>:  <br>                    <span class="hljs-keyword">break</span>;  <br>            &#125;  <br>            entry = <span class="hljs-built_in">readdir</span>(dir);  <br>        &#125;  <br>    &#125;  <br>    <span class="hljs-built_in">closedir</span>(dir);  <br>    <span class="hljs-keyword">return</span> ret;  <br>&#125;  <br>  <br></code></pre></td></tr></table></figure>



<p><code>检测文件</code></p>
<p>众所周知frida我们一般都会放在data&#x2F;local&#x2F;tmp目录下，旧版fridaserver端运行时都会释放到re.frida.server，所以这里在旧版也会被当做一个检测点，而新版已不再释放</p>
<p><code>检测map</code></p>
<p><img src="informatin/book/笔记/照片/image-20240721002300291.png" srcset="/img/loading.gif" lazyload alt="image-20240721002300291"></p>
<table>
<thead>
<tr>
<th>字段</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>u0_a504</td>
<td>用户ID和应用ID：在Android系统中，<code>u0</code>代表系统用户（user 0），而<code>a504</code>是该应用在用户0下的唯一标识符。</td>
</tr>
<tr>
<td>28082</td>
<td>PID（进程ID）：该进程在操作系统中的标识符。</td>
</tr>
<tr>
<td>1935</td>
<td>PPID（父进程ID）：该进程的父进程的PID。</td>
</tr>
<tr>
<td>6511212</td>
<td>虚拟内存：进程使用的虚拟内存大小，通常以字节为单位。</td>
</tr>
<tr>
<td>125728</td>
<td>共享内存：进程使用的共享内存大小，同样以字节为单位。</td>
</tr>
<tr>
<td>0</td>
<td>CPU时间&#x2F;线程数：这通常表示进程的CPU时间或者是线程数，具体含义取决于<code>ps</code>命令的输出格式。</td>
</tr>
<tr>
<td>S</td>
<td>状态：其中<code>S</code>代表睡眠状态（Sleeping），即进程没有在执行，而是在等待某些事件或资源。</td>
</tr>
</tbody></table>
<p><code>/proc/self/maps</code> 是一个特殊的文件，它包含了当前进程的内存映射信息。当你打开这个文件时，它会显示一个列表，其中包含了进程中每个内存区域的详细信息。这些信息通常包括：</p>
<ul>
<li>起始地址（Start Address）</li>
<li>结束地址（End Address）</li>
<li>权限（如可读、可写、可执行）</li>
<li>共享&#x2F;私有标志（Shared or Private）</li>
<li>关联的文件或设备（如果内存区域是文件映射的）</li>
<li>内存区域的偏移量</li>
<li>内存区域的类型（如匿名映射、文件映射、设备映射等）<br>当注入frida后，在maps文件中就会存在 <code>frida-agent-64.so</code>、<code>frida-agent-32.so</code> 等文件。</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">check_maps</span><span class="hljs-params">()</span> </span>&#123;  <br>    <span class="hljs-comment">// 定义一个足够大的字符数组line，用于存储读取的行  </span><br>    <span class="hljs-type">char</span> line[<span class="hljs-number">512</span>];  <br>    <span class="hljs-comment">// 打开当前进程的内存映射文件/proc/self/maps进行读取  </span><br>    FILE* fp = <span class="hljs-built_in">fopen</span>(<span class="hljs-string">&quot;/proc/self/maps&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>);  <br>    <span class="hljs-keyword">if</span> (fp) &#123;  <br>        <span class="hljs-comment">// 如果文件成功打开，循环读取每一行  </span><br>        <span class="hljs-keyword">while</span> (<span class="hljs-built_in">fgets</span>(line, <span class="hljs-built_in">sizeof</span>(line), fp)) &#123;  <br>            <span class="hljs-comment">// 使用strstr函数检查当前行是否包含&quot;frida&quot;字符串  </span><br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strstr</span>(line, <span class="hljs-string">&quot;frida&quot;</span>) || <span class="hljs-built_in">strstr</span>(line, <span class="hljs-string">&quot;gadget&quot;</span>)) &#123;  <br>                <span class="hljs-comment">// 如果找到了&quot;frida&quot;，关闭文件并返回true，表示检测到了恶意库  </span><br>                <span class="hljs-built_in">fclose</span>(fp);  <br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// Evil library is loaded.  </span><br>            &#125;  <br>        &#125;  <br>        <span class="hljs-comment">// 遍历完文件后，关闭文件  </span><br>        <span class="hljs-built_in">fclose</span>(fp);  <br>    &#125; <span class="hljs-keyword">else</span> &#123;  <br>        <span class="hljs-comment">// 如果无法打开文件，记录错误。这可能意味着系统状态异常  </span><br>        <span class="hljs-comment">// 注意：这里的代码没有处理错误，只是注释说明了可能的情况  </span><br>    &#125;  <br>    <span class="hljs-comment">// 如果没有在内存映射文件中找到&quot;frida&quot;，返回false，表示没有检测到恶意库  </span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">// No evil library detected.  </span><br>&#125;  <br></code></pre></td></tr></table></figure>

<p>绕过的方式</p>
<p><code>anti脚本</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// 定义一个函数anti_maps，用于阻止特定字符串的搜索匹配，避免检测到敏感内容如&quot;Frida&quot;或&quot;REJECT&quot;  </span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">anti_maps</span>(<span class="hljs-params"></span>) &#123;  <br>    <span class="hljs-comment">// 查找libc.so库中strstr函数的地址，strstr用于查找字符串中首次出现指定字符序列的位置  </span><br>    <span class="hljs-keyword">var</span> pt_strstr = <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">findExportByName</span>(<span class="hljs-string">&quot;libc.so&quot;</span>, <span class="hljs-string">&#x27;strstr&#x27;</span>);  <br>    <span class="hljs-comment">// 查找libc.so库中strcmp函数的地址，strcmp用于比较两个字符串  </span><br>    <span class="hljs-keyword">var</span> pt_strcmp = <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">findExportByName</span>(<span class="hljs-string">&quot;libc.so&quot;</span>, <span class="hljs-string">&#x27;strcmp&#x27;</span>);  <br>    <span class="hljs-comment">// 使用Interceptor模块附加到strstr函数上，拦截并修改其行为  </span><br>    <span class="hljs-title class_">Interceptor</span>.<span class="hljs-title function_">attach</span>(pt_strstr, &#123;  <br>        <span class="hljs-comment">// 在strstr函数调用前执行的回调  </span><br>        <span class="hljs-attr">onEnter</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">args</span>) &#123;  <br>            <span class="hljs-comment">// 读取strstr的第一个参数（源字符串）和第二个参数（要查找的子字符串）  </span><br>            <span class="hljs-keyword">var</span> str1 = args[<span class="hljs-number">0</span>].<span class="hljs-title function_">readCString</span>();  <br>            <span class="hljs-keyword">var</span> str2 = args[<span class="hljs-number">1</span>].<span class="hljs-title function_">readCString</span>();  <br>            <span class="hljs-comment">// 检查子字符串是否包含&quot;REJECT&quot;或&quot;frida&quot;，如果包含则设置hook标志为true  </span><br>            <span class="hljs-keyword">if</span> (str2.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&quot;REJECT&quot;</span>) !== -<span class="hljs-number">1</span>  || str2.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&quot;frida&quot;</span>) !== -<span class="hljs-number">1</span>) &#123;  <br>                <span class="hljs-variable language_">this</span>.<span class="hljs-property">hook</span> = <span class="hljs-literal">true</span>;  <br>            &#125;  <br>        &#125;,  <br>        <span class="hljs-comment">// 在strstr函数调用后执行的回调  </span><br>        <span class="hljs-attr">onLeave</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">retval</span>) &#123;  <br>            <span class="hljs-comment">// 如果之前设置了hook标志，则将strstr的结果替换为0（表示未找到），从而隐藏敏感信息  </span><br>            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">hook</span>) &#123;  <br>                retval.<span class="hljs-title function_">replace</span>(<span class="hljs-number">0</span>);  <br>            &#125;  <br>        &#125;  <br>    &#125;);  <br>  <br>    <span class="hljs-comment">// 对strcmp函数做类似的处理，防止通过字符串比较检测敏感信息  </span><br>    <span class="hljs-title class_">Interceptor</span>.<span class="hljs-title function_">attach</span>(pt_strcmp, &#123;  <br>        <span class="hljs-attr">onEnter</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">args</span>) &#123;  <br>            <span class="hljs-keyword">var</span> str1 = args[<span class="hljs-number">0</span>].<span class="hljs-title function_">readCString</span>();  <br>            <span class="hljs-keyword">var</span> str2 = args[<span class="hljs-number">1</span>].<span class="hljs-title function_">readCString</span>();  <br>            <span class="hljs-keyword">if</span> (str2.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&quot;REJECT&quot;</span>) !== -<span class="hljs-number">1</span>  || str2.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&quot;frida&quot;</span>) !== -<span class="hljs-number">1</span>) &#123;  <br>                <span class="hljs-variable language_">this</span>.<span class="hljs-property">hook</span> = <span class="hljs-literal">true</span>;  <br>            &#125;  <br>        &#125;,  <br>        <span class="hljs-attr">onLeave</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">retval</span>) &#123;  <br>            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">hook</span>) &#123;  <br>                <span class="hljs-comment">// strcmp返回值为0表示两个字符串相等，这里同样替换为0以避免匹配成功  </span><br>                retval.<span class="hljs-title function_">replace</span>(<span class="hljs-number">0</span>);  <br>            &#125;  <br>        &#125;  <br>    &#125;);  <br>&#125;  <br>  <br></code></pre></td></tr></table></figure>

<p><code>重定向maps</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// 定义一个函数，用于重定向并修改maps文件内容，以隐藏特定的库和路径信息  </span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">mapsRedirect</span>(<span class="hljs-params"></span>) &#123;  <br>    <span class="hljs-comment">// 定义伪造的maps文件路径  </span><br>    <span class="hljs-keyword">var</span> <span class="hljs-title class_">FakeMaps</span> = <span class="hljs-string">&quot;/data/data/com.zj.wuaipojie/maps&quot;</span>;  <br>    <span class="hljs-comment">// 获取libc.so库中&#x27;open&#x27;函数的地址  </span><br>    <span class="hljs-keyword">const</span> openPtr = <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">getExportByName</span>(<span class="hljs-string">&#x27;libc.so&#x27;</span>, <span class="hljs-string">&#x27;open&#x27;</span>);  <br>    <span class="hljs-comment">// 根据地址创建一个新的NativeFunction对象，表示原生的&#x27;open&#x27;函数  </span><br>    <span class="hljs-keyword">const</span> open = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NativeFunction</span>(openPtr, <span class="hljs-string">&#x27;int&#x27;</span>, [<span class="hljs-string">&#x27;pointer&#x27;</span>, <span class="hljs-string">&#x27;int&#x27;</span>]);  <br>    <span class="hljs-comment">// 查找并获取libc.so库中&#x27;read&#x27;函数的地址  </span><br>    <span class="hljs-keyword">var</span> readPtr = <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">findExportByName</span>(<span class="hljs-string">&quot;libc.so&quot;</span>, <span class="hljs-string">&quot;read&quot;</span>);  <br>    <span class="hljs-comment">// 创建新的NativeFunction对象表示原生的&#x27;read&#x27;函数  </span><br>    <span class="hljs-keyword">var</span> read = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NativeFunction</span>(readPtr, <span class="hljs-string">&#x27;int&#x27;</span>, [<span class="hljs-string">&#x27;int&#x27;</span>, <span class="hljs-string">&#x27;pointer&#x27;</span>, <span class="hljs-string">&quot;int&quot;</span>]);  <br>    <span class="hljs-comment">// 分配512字节的内存空间，用于临时存储从maps文件读取的内容  </span><br>    <span class="hljs-keyword">var</span> <span class="hljs-title class_">MapsBuffer</span> = <span class="hljs-title class_">Memory</span>.<span class="hljs-title function_">alloc</span>(<span class="hljs-number">512</span>);  <br>    <span class="hljs-comment">// 创建一个伪造的maps文件，用于写入修改后的内容，模式为&quot;w&quot;（写入）  </span><br>    <span class="hljs-keyword">var</span> <span class="hljs-title class_">MapsFile</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-title class_">FakeMaps</span>, <span class="hljs-string">&quot;w&quot;</span>);  <br>    <span class="hljs-comment">// 使用Interceptor替换原有的&#x27;open&#x27;函数，注入自定义逻辑  </span><br>    <span class="hljs-title class_">Interceptor</span>.<span class="hljs-title function_">replace</span>(openPtr, <span class="hljs-keyword">new</span> <span class="hljs-title class_">NativeCallback</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">pathname, flag</span>) &#123;  <br>        <span class="hljs-comment">// 调用原始的&#x27;open&#x27;函数，并获取文件描述符（FD）  </span><br>        <span class="hljs-keyword">var</span> <span class="hljs-variable constant_">FD</span> = <span class="hljs-title function_">open</span>(pathname, flag);  <br>        <span class="hljs-comment">// 读取并打印尝试打开的文件路径  </span><br>        <span class="hljs-keyword">var</span> ch = pathname.<span class="hljs-title function_">readCString</span>();  <br>        <span class="hljs-keyword">if</span> (ch.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&quot;/proc/&quot;</span>) &gt;= <span class="hljs-number">0</span> &amp;&amp; ch.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&quot;maps&quot;</span>) &gt;= <span class="hljs-number">0</span>) &#123;  <br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;open : &quot;</span>, pathname.<span class="hljs-title function_">readCString</span>());  <br>            <span class="hljs-comment">// 循环读取maps内容，并写入伪造的maps文件中，同时进行字符串替换以隐藏特定信息  </span><br>            <span class="hljs-keyword">while</span> (<span class="hljs-built_in">parseInt</span>(<span class="hljs-title function_">read</span>(<span class="hljs-variable constant_">FD</span>, <span class="hljs-title class_">MapsBuffer</span>, <span class="hljs-number">512</span>)) !== <span class="hljs-number">0</span>) &#123;  <br>                <span class="hljs-keyword">var</span> <span class="hljs-title class_">MBuffer</span> = <span class="hljs-title class_">MapsBuffer</span>.<span class="hljs-title function_">readCString</span>();  <br>                <span class="hljs-title class_">MBuffer</span> = <span class="hljs-title class_">MBuffer</span>.<span class="hljs-title function_">replaceAll</span>(<span class="hljs-string">&quot;/data/local/tmp/re.frida.server/frida-agent-64.so&quot;</span>, <span class="hljs-string">&quot;FakingMaps&quot;</span>);  <br>                <span class="hljs-title class_">MBuffer</span> = <span class="hljs-title class_">MBuffer</span>.<span class="hljs-title function_">replaceAll</span>(<span class="hljs-string">&quot;re.frida.server&quot;</span>, <span class="hljs-string">&quot;FakingMaps&quot;</span>);  <br>                <span class="hljs-title class_">MBuffer</span> = <span class="hljs-title class_">MBuffer</span>.<span class="hljs-title function_">replaceAll</span>(<span class="hljs-string">&quot;frida-agent-64.so&quot;</span>, <span class="hljs-string">&quot;FakingMaps&quot;</span>);  <br>                <span class="hljs-title class_">MBuffer</span> = <span class="hljs-title class_">MBuffer</span>.<span class="hljs-title function_">replaceAll</span>(<span class="hljs-string">&quot;frida-agent-32.so&quot;</span>, <span class="hljs-string">&quot;FakingMaps&quot;</span>);  <br>                <span class="hljs-title class_">MBuffer</span> = <span class="hljs-title class_">MBuffer</span>.<span class="hljs-title function_">replaceAll</span>(<span class="hljs-string">&quot;frida&quot;</span>, <span class="hljs-string">&quot;FakingMaps&quot;</span>);  <br>                <span class="hljs-title class_">MBuffer</span> = <span class="hljs-title class_">MBuffer</span>.<span class="hljs-title function_">replaceAll</span>(<span class="hljs-string">&quot;/data/local/tmp&quot;</span>, <span class="hljs-string">&quot;/data&quot;</span>);  <br>                <span class="hljs-comment">// 将修改后的内容写入伪造的maps文件  </span><br>                <span class="hljs-title class_">MapsFile</span>.<span class="hljs-title function_">write</span>(<span class="hljs-title class_">MBuffer</span>);  <br>            &#125;  <br>            <span class="hljs-comment">// 为返回伪造maps文件的打开操作，分配UTF8编码的文件名字符串  </span><br>            <span class="hljs-keyword">var</span> filename = <span class="hljs-title class_">Memory</span>.<span class="hljs-title function_">allocUtf8String</span>(<span class="hljs-title class_">FakeMaps</span>);  <br>            <span class="hljs-comment">// 返回打开伪造maps文件的文件描述符  </span><br>            <span class="hljs-keyword">return</span> <span class="hljs-title function_">open</span>(filename, flag);  <br>        &#125;  <br>        <span class="hljs-comment">// 如果不是目标maps文件，则直接返回原open调用的结果  </span><br>        <span class="hljs-keyword">return</span> <span class="hljs-variable constant_">FD</span>;  <br>    &#125;, <span class="hljs-string">&#x27;int&#x27;</span>, [<span class="hljs-string">&#x27;pointer&#x27;</span>, <span class="hljs-string">&#x27;int&#x27;</span>]));  <br>&#125;  <br></code></pre></td></tr></table></figure>

<p>用eBPF来hook系统调用并修改参数实现目的，使用bpf_probe_write_user向用户态函数地址写内容直接修改参数</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-built_in">char</span> placeholder[] = <span class="hljs-string">&quot;/data/data/com.zj.wuaipojie/maps&quot;</span>;  <br>bpf_probe_write_user((<span class="hljs-keyword">void</span>*)addr, placeholder, <span class="hljs-keyword">sizeof</span>(placeholder));  <br></code></pre></td></tr></table></figure>





<p><code>检测status(线程名)</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">ls</span> /proc/pid/task 列出线程<span class="hljs-built_in">id</span>  <br><span class="hljs-built_in">cat</span> /proc/pid/task/线程<span class="hljs-built_in">id</span>/status  <br></code></pre></td></tr></table></figure>

<ul>
<li>在 <code>/proc/pid/task</code> 目录下，可以通过查看不同的线程子目录，来获取进程中每个线程的运行时信息。这些信息包括线程的状态、线程的寄存器内容、线程占用的CPU时间、线程的堆栈信息等。通过这些信息，可以实时观察和监控进程中每个线程的运行状态，帮助进行调试、性能优化和问题排查等工作。</li>
<li>在某些app中就会去读取 <code>/proc/stask/线程ID/status</code> 文件，如果是运行frida产生的，则进行反调试。例如：<code>gmain/gdbus/gum-js-loop/pool-frida</code>等</li>
</ul>
<ol>
<li>gmain：Frida 使用 Glib 库，其中的主事件循环被称为 GMainLoop。在 Frida 中，gmain 表示 GMainLoop 的线程。</li>
<li>gdbus：GDBus 是 Glib 提供的一个用于 D-Bus 通信的库。在 Frida 中，gdbus 表示 GDBus 相关的线程。</li>
<li>gum-js-loop：Gum 是 Frida 的运行时引擎，用于执行注入的 JavaScript 代码。gum-js-loop 表示 Gum 引擎执行 JavaScript 代码的线程。</li>
<li>pool-frida：Frida 中的某些功能可能会使用线程池来处理任务，pool-frida 表示 Frida 中的线程池。</li>
<li>linjector 是一种用于 Android 设备的开源工具，它允许用户在运行时向 Android 应用程序注入动态链接库（DLL）文件。通过注入 DLL 文件，用户可以修改应用程序的行为、调试应用程序、监视函数调用等，这在逆向工程、安全研究和动态分析中是非常有用的。<br>PS:由于frida可以随时附加到进程，所以写的检测必须覆盖APP的全周期，或者至少是敏感函数执行前</li>
</ol>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">check_status</span><span class="hljs-params">()</span> </span>&#123;  <br>    DIR *dir = <span class="hljs-built_in">opendir</span>(<span class="hljs-string">&quot;/proc/self/task/&quot;</span>);  <br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">dirent</span> *entry;  <br>    <span class="hljs-type">char</span> status_path[MAX_PATH];  <br>    <span class="hljs-type">char</span> buffer[MAX_BUFFER];  <br>    <span class="hljs-type">int</span> found = <span class="hljs-literal">false</span>;  <br>  <br>    <span class="hljs-keyword">if</span> (dir) &#123;  <br>        <span class="hljs-keyword">while</span> ((entry = <span class="hljs-built_in">readdir</span>(dir)) != <span class="hljs-literal">NULL</span>) &#123;  <br>            <span class="hljs-keyword">if</span> (entry-&gt;d_type == DT_DIR) &#123;  <br>                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(entry-&gt;d_name, <span class="hljs-string">&quot;.&quot;</span>) == <span class="hljs-number">0</span> || <span class="hljs-built_in">strcmp</span>(entry-&gt;d_name, <span class="hljs-string">&quot;..&quot;</span>) == <span class="hljs-number">0</span>) &#123;  <br>                    <span class="hljs-keyword">continue</span>;  <br>                &#125;  <br>                <span class="hljs-built_in">snprintf</span>(status_path, <span class="hljs-built_in">sizeof</span>(status_path), <span class="hljs-string">&quot;/proc/self/task/%s/status&quot;</span>, entry-&gt;d_name);  <br>                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">read_file</span>(status_path, buffer, <span class="hljs-built_in">sizeof</span>(buffer)) == <span class="hljs-number">-1</span>) &#123;  <br>                    <span class="hljs-keyword">continue</span>;  <br>                &#125;  <br>                <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(buffer, <span class="hljs-string">&quot;null&quot;</span>) == <span class="hljs-number">0</span>) &#123;  <br>                    <span class="hljs-keyword">continue</span>;  <br>                &#125;  <br>                <span class="hljs-type">char</span> *line = <span class="hljs-built_in">strtok</span>(buffer, <span class="hljs-string">&quot;\n&quot;</span>);  <br>                <span class="hljs-keyword">while</span> (line) &#123;  <br>                    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strstr</span>(line, <span class="hljs-string">&quot;Name:&quot;</span>) != <span class="hljs-literal">NULL</span>) &#123;  <br>                        <span class="hljs-type">const</span> <span class="hljs-type">char</span> *frida_name = <span class="hljs-built_in">strstr</span>(line, <span class="hljs-string">&quot;gmain&quot;</span>);  <br>                        <span class="hljs-keyword">if</span> (frida_name || <span class="hljs-built_in">strstr</span>(line, <span class="hljs-string">&quot;gum-js-loop&quot;</span>) || <span class="hljs-built_in">strstr</span>(line, <span class="hljs-string">&quot;pool-frida&quot;</span>) || <span class="hljs-built_in">strstr</span>(line, <span class="hljs-string">&quot;gdbus&quot;</span>)) &#123;  <br>                            found = <span class="hljs-literal">true</span>;  <br>                            <span class="hljs-keyword">break</span>;  <br>                        &#125;  <br>                    &#125;  <br>                    line = <span class="hljs-built_in">strtok</span>(<span class="hljs-literal">NULL</span>, <span class="hljs-string">&quot;\n&quot;</span>);  <br>                &#125;  <br>                <span class="hljs-keyword">if</span> (found) <span class="hljs-keyword">break</span>;  <br>            &#125;  <br>        &#125;  <br>        <span class="hljs-built_in">closedir</span>(dir);  <br>    &#125;  <br>    <span class="hljs-keyword">return</span> found;  <br>&#125;  <br></code></pre></td></tr></table></figure>



<p><code>检测inlinehook</code></p>
<p>通过Frida查看一个函数hook之前和之后的机器码，以此来判断是否被Frida的inlinehook注入。</p>
<p><img src="image-20240721023344735.png" srcset="/img/loading.gif" lazyload alt="image-20240721023344735"></p>
<p>下面的方案以内存中字节和本地对应的字节进行比较，如果不一致，那么可以认为内存中的字节被修改了，即被inlinehook了</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;jni.h&gt;</span>  </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string&gt;</span>  </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;dlfcn.h&gt;</span>  </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;dlfcn/local_dlfcn.h&quot;</span>  </span><br>  <br><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">check_inlinehook</span><span class="hljs-params">()</span> </span>&#123;  <br>    <span class="hljs-comment">// 根据系统架构选择对应的libc.so库路径  </span><br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *lib_path;  <br>    <span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> __LP64__  </span><br>    lib_path = <span class="hljs-string">&quot;/system/lib64/libc.so&quot;</span>;  <br>    <span class="hljs-meta">#<span class="hljs-keyword">else</span>  </span><br>    lib_path = <span class="hljs-string">&quot;/system/lib/libc.so&quot;</span>;  <br>    <span class="hljs-meta">#<span class="hljs-keyword">endif</span>  </span><br>  <br>    <span class="hljs-comment">// 定义要比较的字节数  </span><br>    <span class="hljs-type">const</span> <span class="hljs-type">int</span> CMP_COUNT = <span class="hljs-number">8</span>;  <br>    <span class="hljs-comment">// 指定要查找的符号名，这里是&quot;open&quot;函数  </span><br>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *sym_name = <span class="hljs-string">&quot;open&quot;</span>;  <br>  <br>    <span class="hljs-comment">// 使用local_dlopen函数打开指定的共享库，并获取操作句柄  </span><br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">local_dlfcn_handle</span> *handle = <span class="hljs-built_in">static_cast</span>&lt;local_dlfcn_handle *&gt;(<span class="hljs-built_in">local_dlopen</span>(lib_path));  <br>    <span class="hljs-keyword">if</span> (!handle) &#123;  <br>        <span class="hljs-keyword">return</span> JNI_FALSE; <span class="hljs-comment">// 如果无法打开共享库，返回false  </span><br>    &#125;  <br>  <br>    <span class="hljs-comment">// 获取&quot;open&quot;函数在libc.so中的偏移量  </span><br>    <span class="hljs-type">off_t</span> offset = <span class="hljs-built_in">local_dlsym</span>(handle, sym_name);  <br>  <br>    <span class="hljs-comment">// 关闭handle，因为我们接下来使用标准的dlopen/dlsy来获取函数地址  </span><br>    <span class="hljs-built_in">local_dlclose</span>(handle);  <br>  <br>    <span class="hljs-comment">// 打开libc.so文件，准备读取数据  </span><br>    FILE *fp = <span class="hljs-built_in">fopen</span>(lib_path, <span class="hljs-string">&quot;rb&quot;</span>);  <br>    <span class="hljs-keyword">if</span> (!fp) &#123;  <br>        <span class="hljs-keyword">return</span> JNI_FALSE; <span class="hljs-comment">// 如果无法打开文件，返回false  </span><br>    &#125;  <br>  <br>    <span class="hljs-comment">// 定义一个缓冲区，用于存储读取的文件内容  </span><br>    <span class="hljs-type">char</span> file_bytes[CMP_COUNT] = &#123;<span class="hljs-number">0</span>&#125;;  <br>    <span class="hljs-comment">// 读取指定偏移量处的CMP_COUNT个字节  </span><br>    <span class="hljs-built_in">fseek</span>(fp, offset, SEEK_SET);  <br>    <span class="hljs-built_in">fread</span>(file_bytes, <span class="hljs-number">1</span>, CMP_COUNT, fp);  <br>    <span class="hljs-built_in">fclose</span>(fp);  <br>  <br>    <span class="hljs-comment">// 使用dlopen函数打开libc.so共享库，并获取操作句柄  </span><br>    <span class="hljs-type">void</span> *dl_handle = <span class="hljs-built_in">dlopen</span>(lib_path, RTLD_NOW);  <br>    <span class="hljs-keyword">if</span> (!dl_handle) &#123;  <br>        <span class="hljs-keyword">return</span> JNI_FALSE; <span class="hljs-comment">// 如果无法打开共享库，返回false  </span><br>    &#125;  <br>  <br>    <span class="hljs-comment">// 使用dlsym函数获取&quot;open&quot;函数的地址  </span><br>    <span class="hljs-type">void</span> *sym = <span class="hljs-built_in">dlsym</span>(dl_handle, sym_name);  <br>    <span class="hljs-keyword">if</span> (!sym) &#123;  <br>        <span class="hljs-built_in">dlclose</span>(dl_handle);  <br>        <span class="hljs-keyword">return</span> JNI_FALSE; <span class="hljs-comment">// 如果无法找到符号，返回false  </span><br>    &#125;  <br>  <br>    <span class="hljs-comment">// 比较原libc.so中的&quot;open&quot;函数内容与通过dlsym获取的&quot;open&quot;函数内容是否一致  </span><br>    <span class="hljs-type">int</span> is_hook = <span class="hljs-built_in">memcmp</span>(file_bytes, sym, CMP_COUNT) != <span class="hljs-number">0</span>;  <br>  <br>    <span class="hljs-comment">// 关闭dlopen打开的共享库句柄  </span><br>    <span class="hljs-built_in">dlclose</span>(dl_handle);  <br>  <br>    <span class="hljs-comment">// 返回比较结果，如果函数被hook则返回JNI_TRUE，否则返回JNI_FALSE  </span><br>    <span class="hljs-keyword">return</span> is_hook ? JNI_TRUE : JNI_FALSE;  <br>&#125;  <br>  <br></code></pre></td></tr></table></figure>

<p><code>获取hook前字节码的脚本</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">let</span> bytes_count = <span class="hljs-number">8</span>  <br><span class="hljs-keyword">let</span> address = <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">getExportByName</span>(<span class="hljs-string">&quot;libc.so&quot;</span>,<span class="hljs-string">&quot;open&quot;</span>)  <br>  <br><span class="hljs-keyword">let</span> before = <span class="hljs-title function_">ptr</span>(address)  <br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;&quot;</span>)  <br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;[*] before hook: &quot;</span>)  <br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">hexdump</span>(before, &#123;  <br>    <span class="hljs-attr">offset</span>: <span class="hljs-number">0</span>,  <br>    <span class="hljs-attr">length</span>: bytes_count,  <br>    <span class="hljs-attr">header</span>: <span class="hljs-literal">true</span>,  <br>    <span class="hljs-attr">ansi</span>: <span class="hljs-literal">true</span>  <br>  &#125;));  <br>  <br></code></pre></td></tr></table></figure>

<p><code>anti脚本</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hook_memcmp_addr</span>(<span class="hljs-params"></span>)&#123;  <br>    <span class="hljs-comment">//hook反调试  </span><br>    <span class="hljs-keyword">var</span> memcmp_addr = <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">findExportByName</span>(<span class="hljs-string">&quot;libc.so&quot;</span>, <span class="hljs-string">&quot;fread&quot;</span>);  <br>    <span class="hljs-keyword">if</span> (memcmp_addr !== <span class="hljs-literal">null</span>) &#123;  <br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;fread address: &quot;</span>, memcmp_addr);  <br>        <span class="hljs-title class_">Interceptor</span>.<span class="hljs-title function_">attach</span>(memcmp_addr, &#123;  <br>        <span class="hljs-attr">onEnter</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">args</span>) &#123;  <br>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">buffer</span> = args[<span class="hljs-number">0</span>];   <span class="hljs-comment">// 保存 buffer 参数  </span><br>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">size</span> = args[<span class="hljs-number">1</span>];     <span class="hljs-comment">// 保存 size 参数  </span><br>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span> = args[<span class="hljs-number">2</span>];    <span class="hljs-comment">// 保存 count 参数  </span><br>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">stream</span> = args[<span class="hljs-number">3</span>];   <span class="hljs-comment">// 保存 FILE* 参数  </span><br>        &#125;,  <br>        <span class="hljs-attr">onLeave</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">retval</span>) &#123;  <br>            <span class="hljs-comment">// 这里可以修改 buffer 的内容，假设我们知道何时 fread 被用于敏感操作  </span><br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>.<span class="hljs-title function_">toInt32</span>());  <br>            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>.<span class="hljs-title function_">toInt32</span>() == <span class="hljs-number">8</span>) &#123;  <br>                <span class="hljs-comment">// 模拟 fread 读取了预期数据，伪造返回值  </span><br>                <span class="hljs-title class_">Memory</span>.<span class="hljs-title function_">writeByteArray</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">buffer</span>, [<span class="hljs-number">0x50</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x58</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x1f</span>, <span class="hljs-number">0xd6</span>]);  <br>                retval.<span class="hljs-title function_">replace</span>(<span class="hljs-number">8</span>); <span class="hljs-comment">// 填充前8字节  </span><br>                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">hexdump</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">buffer</span>));  <br>            &#125;  <br>        &#125;  <br>    &#125;);  <br>    &#125; <span class="hljs-keyword">else</span> &#123;  <br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Error: memcmp function not found in libc.so&quot;</span>);  <br>    &#125;  <br>&#125;  <br>  <br></code></pre></td></tr></table></figure>



<p><code>Syscall&amp;SVC&amp;自定义strstr</code></p>
<p>在用户空间和内核空间之间，有一个叫做Syscall(系统调用, system call)的中间层，是连接用户态和内核态的桥梁。这样即提高了内核的安全型，也便于移植，只需实现同一套接口即可。Linux系统，用户空间通过向内核空间发出Syscall，产生软中断，从而让程序陷入内核态，执行相应的操作。<br><strong>SVC(软件中断指令)指令</strong>：在ARM架构的系统中，<code>svc</code>是一条特殊的指令，它允许用户态的程序发起一个系统调用。当这条指令被执行时，CPU会从用户态切换到内核态，从而允许内核处理这个请求。</p>
<p>Linux操作系统是一个巨大的图书馆，而<code>syscall</code>就是这个图书馆的前台服务窗口。当一个应用程序（比如一个读者）需要借阅书籍（获取系统资源或服务）时，它不能直接进入图书馆的内部书架去拿书，因为那样可能会造成混乱和损坏。所以，读者需要通过前台服务窗口，也就是<code>syscall</code>，来请求它想要的书籍。</p>
<p><code>svc</code>就像是图书馆前台服务窗口的内部电话。当读者通过前台窗口提出请求时，前台工作人员会通过内部电话（<code>svc</code>）来联系图书馆的内部工作人员，请求他们找到并提供所需的书籍。在Linux系统中，当一个程序通过<code>syscall</code>请求服务时，实际上是通过<code>svc</code>这条指令通知内核，然后由内核来处理这些请求。</p>
<p><img src="informatin/book/笔记/照片/0.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li><p>首先当我们长按开机键（电源按钮）开机，此时会引导芯片开始从固化到ROM中的预设代码处执行，然后加载引导程序到RAM。然后启动加载的引导程序，引导程序主要做一些基本的检查，包括RAM的检查，初始化硬件的参数。</p>
</li>
<li><p>到达内核层的流程后，这里初始化一些进程管理、内存管理、加载各种Driver等相关操作，如Camera Driver、Binder Driver 等。下一步就是内核线程，如软中断线程、内核守护线程。下面一层就是Native层，这里额外提一点知识，层于层之间是不可以直接通信的，所以需要一种中间状态来通信。Native层和Kernel层之间通信用的是syscall，Native层和Java层之间的通信是JNI。</p>
</li>
<li><p>在Native层会初始化init进程，也就是用户组进程的祖先进程。init中加载配置文件init.rc，init.rc中孵化出ueventd、logd、healthd、installd、lmkd等用户守护进程。开机动画启动等操作。核心的一步是孵化出Zygote进程，此进程是所有APP的父进程，这也是Xposed注入的核心，同时也是Android的第一个Java进程（虚拟机进程）。</p>
</li>
<li><p>进入框架层后，加载zygote init类，注册zygote socket套接字，通过此套接字来做进程通信，并加载虚拟机、类、系统资源等。zygote第一个孵化的进程是system_server进程，负责启动和管理整个Java Framework，包含ActivityManager、PowerManager等服务。</p>
</li>
<li><p>应用层的所有APP都是从zygote孵化而来</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java">bool <span class="hljs-title function_">anti_anti_maps</span><span class="hljs-params">()</span> &#123;  <br>    <span class="hljs-comment">// 定义一个足够大的字符数组line，用于存储读取的行  </span><br>    const <span class="hljs-type">int</span> <span class="hljs-variable">buf_size</span> <span class="hljs-operator">=</span> <span class="hljs-number">512</span>;  <br>    <span class="hljs-type">char</span> buf[buf_size];  <br>    <span class="hljs-type">int</span> fd;  <span class="hljs-comment">// 文件描述符  </span><br>    <span class="hljs-comment">// 使用 my_openat 打开当前进程的内存映射文件 /proc/self/maps 进行读取  </span><br>    <span class="hljs-comment">// AT_FDCWD 表示当前工作目录，&quot;r&quot; 表示只读方式打开  </span><br>    fd = my_openat(AT_FDCWD, <span class="hljs-string">&quot;/proc/self/maps&quot;</span>, O_RDONLY | O_CLOEXEC, <span class="hljs-number">0</span>);  <br>    <span class="hljs-keyword">if</span> (fd != -<span class="hljs-number">1</span>) &#123;  <br>        <span class="hljs-comment">// 如果文件成功打开，循环读取每一行  </span><br>        <span class="hljs-keyword">while</span> ((read_line(fd, buf, buf_size)) &gt; <span class="hljs-number">0</span>) &#123;  <br>            <span class="hljs-comment">// 使用strstr函数检查当前行是否包含&quot;frida&quot;字符串  </span><br>            <span class="hljs-keyword">if</span> (strstr(buf, <span class="hljs-string">&quot;frida&quot;</span>) || strstr(buf, <span class="hljs-string">&quot;gadget&quot;</span>)) &#123;  <br>                <span class="hljs-comment">// 如果找到了&quot;frida&quot;，关闭文件并返回true，表示检测到了恶意库  </span><br>                close(fd);  <br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// Evil library is loaded.  </span><br>            &#125;  <br>        &#125;  <br>        <span class="hljs-comment">// 遍历完文件后，关闭文件  </span><br>        close(fd);  <br>    &#125; <span class="hljs-keyword">else</span> &#123;  <br>        <span class="hljs-comment">// 如果无法打开文件，记录错误。这可能意味着系统状态异常  </span><br>        <span class="hljs-comment">// 注意：这里的代码没有处理错误，只是注释说明了可能的情况  </span><br>    &#125;  <br>    <span class="hljs-comment">// 如果没有在内存映射文件中找到&quot;frida&quot;，返回false，表示没有检测到恶意库  </span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">// No evil library detected.  </span><br>&#125;  <br>  <br>ENTRY(my_openat)  <span class="hljs-comment">// 定义函数入口，标签my_openat  </span><br>    mov     x8, __NR_openat  <span class="hljs-comment">// 将openat系统调用号（__NR_openat）移动到x8寄存器，x8用于存储系统调用号  </span><br>    svc     #<span class="hljs-number">0</span>               <span class="hljs-comment">// 触发系统调用异常，进入操作系统执行系统调用  </span><br>    cmn     x0, #(MAX_ERRNO + <span class="hljs-number">1</span>)  <span class="hljs-comment">// 将函数返回值（存储在x0寄存器）与MAX_ERRNO + 1进行无符号比较  </span><br>    cneg    x0, x0, hi       <span class="hljs-comment">// 如果上面的比较结果大于或等于零（即没有错误），则将x0的符号位取反（如果原来是负则变正）  </span><br>    b.hi    __set_errno_internal  <span class="hljs-comment">// 如果上面的比较结果大于或等于零（即发生了错误），则跳转到__set_errno_internal进行错误处理  </span><br>    ret                       <span class="hljs-comment">// 从函数返回，继续执行调用者代码  </span><br>END(my_openat)  <span class="hljs-comment">// 标记函数结束  </span><br></code></pre></td></tr></table></figure>

<p><code>anti脚本</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">anti_svc</span>(<span class="hljs-params"></span>)&#123;  <br>    <span class="hljs-keyword">let</span> target_code_hex;  <span class="hljs-comment">// 用于搜索特定汇编指令序列的十六进制字符串  </span><br>    <span class="hljs-keyword">let</span> call_number_openat;  <span class="hljs-comment">// 系统调用号对应的数值，openat  </span><br>    <span class="hljs-keyword">let</span> arch = <span class="hljs-title class_">Process</span>.<span class="hljs-property">arch</span>;  <span class="hljs-comment">// 获取当前进程的架构  </span><br>  <br>    <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;arm&quot;</span> === arch)&#123;  <span class="hljs-comment">// 如果架构是ARM  </span><br>        target_code_hex = <span class="hljs-string">&quot;00 00 00 EF&quot;</span>;  <span class="hljs-comment">// ARM架构下svc指令的十六进制表示  </span><br>        call_number_openat = <span class="hljs-number">322</span>;  <span class="hljs-comment">// openat在ARM架构中的系统调用号  </span><br>    &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-string">&quot;arm64&quot;</span> === arch)&#123;  <span class="hljs-comment">// 如果架构是ARM64  </span><br>        target_code_hex = <span class="hljs-string">&quot;01 00 00 D4&quot;</span>;  <span class="hljs-comment">// ARM64架构下svc指令的十六进制表示  </span><br>        call_number_openat = <span class="hljs-number">56</span>;  <span class="hljs-comment">// openat在ARM64架构中的系统调用号  </span><br>    &#125;<span class="hljs-keyword">else</span> &#123;  <br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;arch not support!&quot;</span>);  <span class="hljs-comment">// 如果架构不支持，打印错误信息  </span><br>    &#125;  <br>  <br>    <span class="hljs-keyword">if</span> (arch)&#123;  <span class="hljs-comment">// 如果成功获取了架构信息  </span><br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;\nthe_arch = &quot;</span> + arch);  <span class="hljs-comment">// 打印当前架构  </span><br>        <span class="hljs-comment">// 枚举进程的内存范围，寻找只读内存段  </span><br>        <span class="hljs-title class_">Process</span>.<span class="hljs-title function_">enumerateRanges</span>(<span class="hljs-string">&#x27;r--&#x27;</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">range</span>) &#123;  <br>            <span class="hljs-keyword">if</span>(!range.<span class="hljs-property">file</span> || !range.<span class="hljs-property">file</span>.<span class="hljs-property">path</span>)&#123;  <span class="hljs-comment">// 如果内存段没有文件路径，跳过  </span><br>                <span class="hljs-keyword">return</span>;  <br>            &#125;  <br>            <span class="hljs-keyword">let</span> path = range.<span class="hljs-property">file</span>.<span class="hljs-property">path</span>;  <span class="hljs-comment">// 获取内存段的文件路径  </span><br>            <span class="hljs-comment">// 如果文件路径不是以&quot;/data/app/&quot;开头或不以&quot;.so&quot;结尾，跳过  </span><br>            <span class="hljs-keyword">if</span> ((!path.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">&quot;/data/app/&quot;</span>)) || (!path.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">&quot;.so&quot;</span>)))&#123;  <br>                <span class="hljs-keyword">return</span>;  <br>            &#125;  <br>            <span class="hljs-keyword">let</span> baseAddress = <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">getBaseAddress</span>(path);  <span class="hljs-comment">// 获取so库的基址  </span><br>            <span class="hljs-keyword">let</span> soNameList = path.<span class="hljs-title function_">split</span>(<span class="hljs-string">&quot;/&quot;</span>);  <span class="hljs-comment">// 通过路径分割获取so库的名称  </span><br>            <span class="hljs-keyword">let</span> soName = soNameList[soNameList.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>];  <span class="hljs-comment">// 获取so库的名称  </span><br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;\npath = &quot;</span> + path + <span class="hljs-string">&quot; , baseAddress = &quot;</span> + baseAddress +  <br>                        <span class="hljs-string">&quot; , rangeAddress = &quot;</span> + range.<span class="hljs-property">base</span> + <span class="hljs-string">&quot; , size = &quot;</span> + range.<span class="hljs-property">size</span>);  <br>            <span class="hljs-comment">// 在so库的内存范围内搜索target_code_hex对应的指令序列  </span><br>            <span class="hljs-title class_">Memory</span>.<span class="hljs-title function_">scan</span>(range.<span class="hljs-property">base</span>, range.<span class="hljs-property">size</span>, target_code_hex, &#123;  <br>                <span class="hljs-attr">onMatch</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">match</span>)&#123;  <br>                    <span class="hljs-keyword">let</span> code_address = match;  <span class="hljs-comment">// 获取匹配到的指令地址  </span><br>                    <span class="hljs-keyword">let</span> code_address_str = code_address.<span class="hljs-title function_">toString</span>();  <span class="hljs-comment">// 转换为字符串  </span><br>                    <span class="hljs-comment">// 如果地址的最低位是0, 4, 8, c中的任意一个，说明可能是svc指令  </span><br>                    <span class="hljs-keyword">if</span> (code_address_str.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">&quot;0&quot;</span>) || code_address_str.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">&quot;4&quot;</span>) ||  <br>                        code_address_str.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">&quot;8&quot;</span>) || code_address_str.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">&quot;c&quot;</span>))&#123;  <br>                        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;--------------------------&quot;</span>);  <br>                        <span class="hljs-keyword">let</span> call_number = <span class="hljs-number">0</span>;  <span class="hljs-comment">// 初始化系统调用号  </span><br>                        <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;arm&quot;</span> === arch)&#123;  <br>                            <span class="hljs-comment">// 获取svc指令后面的立即数，作为系统调用号  </span><br>                            call_number = (code_address.<span class="hljs-title function_">sub</span>(<span class="hljs-number">0x4</span>).<span class="hljs-title function_">readS32</span>()) &amp; <span class="hljs-number">0xFFF</span>;  <br>                        &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-string">&quot;arm64&quot;</span> === arch)&#123;  <br>                            call_number = (code_address.<span class="hljs-title function_">sub</span>(<span class="hljs-number">0x4</span>).<span class="hljs-title function_">readS32</span>() &gt;&gt; <span class="hljs-number">5</span>) &amp; <span class="hljs-number">0xFFFF</span>;  <br>                        &#125;<span class="hljs-keyword">else</span> &#123;  <br>                            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;the arch get call_number not support!&quot;</span>);  <span class="hljs-comment">// 如果架构不支持，打印错误信息  </span><br>                        &#125;  <br>                        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;find svc : so_name = &quot;</span> + soName + <span class="hljs-string">&quot; , address = &quot;</span> + code_address +  <br>                                    <span class="hljs-string">&quot; , call_number = &quot;</span> + call_number + <span class="hljs-string">&quot; , offset = &quot;</span> + code_address.<span class="hljs-title function_">sub</span>(baseAddress));  <br>                        <span class="hljs-comment">// 如果匹配到的系统调用号是openat，挂钩该地址  </span><br>                        <span class="hljs-keyword">if</span> (call_number_openat === call_number)&#123;  <br>                            <span class="hljs-keyword">let</span> target_hook_addr = code_address;  <br>                            <span class="hljs-keyword">let</span> target_hook_addr_offset = target_hook_addr.<span class="hljs-title function_">sub</span>(baseAddress);  <br>                            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;find svc openat , start inlinehook by frida!&quot;</span>);  <br>                            <span class="hljs-title class_">Interceptor</span>.<span class="hljs-title function_">attach</span>(target_hook_addr, &#123;  <br>                                <span class="hljs-attr">onEnter</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">args</span>)&#123;  <span class="hljs-comment">// 当进入挂钩函数时  </span><br>                                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;\nonEnter_&quot;</span> + target_hook_addr_offset + <span class="hljs-string">&quot; , __NR_openat , args[1] = &quot;</span> +  <br>                                                  args[<span class="hljs-number">1</span>].<span class="hljs-title function_">readCString</span>());  <br>                                    <span class="hljs-comment">// 修改openat的第一个参数为指定路径  </span><br>                                    <span class="hljs-variable language_">this</span>.<span class="hljs-property">new_addr</span> = <span class="hljs-title class_">Memory</span>.<span class="hljs-title function_">allocUtf8String</span>(<span class="hljs-string">&quot;/data/user/0/com.zj.wuaipojie/maps&quot;</span>);  <br>                                    args[<span class="hljs-number">1</span>] = <span class="hljs-variable language_">this</span>.<span class="hljs-property">new_addr</span>;  <br>                                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;onEnter_&quot;</span> + target_hook_addr_offset + <span class="hljs-string">&quot; , __NR_openat , args[1] = &quot;</span> +  <br>                                                  args[<span class="hljs-number">1</span>].<span class="hljs-title function_">readCString</span>());  <br>                                &#125;,  <br>                                <span class="hljs-attr">onLeave</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">retval</span>)&#123;  <span class="hljs-comment">// 当离开挂钩函数时  </span><br>                                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;onLeave_&quot;</span> + target_hook_addr_offset + <span class="hljs-string">&quot; , __NR_openat , retval = &quot;</span> + retval)  <br>                                &#125;  <br>                            &#125;);  <br>                        &#125;  <br>                    &#125;  <br>                &#125;,  <br>                <span class="hljs-attr">onComplete</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;&#125;  <span class="hljs-comment">// 搜索完成后的回调函数  </span><br>            &#125;);  <br>        &#125;);  <br>    &#125;  <br>&#125;  <br></code></pre></td></tr></table></figure>

<p><code>自定义strstr</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">anti_str_maps</span><span class="hljs-params">()</span> </span>&#123;  <br>    <span class="hljs-comment">// 定义一个足够大的字符数组line，用于存储读取的行  </span><br>    <span class="hljs-type">char</span> line[<span class="hljs-number">512</span>];  <br>    <span class="hljs-comment">// 打开当前进程的内存映射文件/proc/self/maps进行读取  </span><br>    FILE* fp = <span class="hljs-built_in">fopen</span>(<span class="hljs-string">&quot;/proc/self/maps&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>);  <br>    <span class="hljs-keyword">if</span> (fp) &#123;  <br>        <span class="hljs-comment">// 如果文件成功打开，循环读取每一行  </span><br>        <span class="hljs-keyword">while</span> (<span class="hljs-built_in">fgets</span>(line, <span class="hljs-built_in">sizeof</span>(line), fp)) &#123;  <br>            <span class="hljs-comment">// 使用自定义strstr函数检查当前行是否包含&quot;frida&quot;指纹  </span><br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">my_strstr</span>(line, <span class="hljs-string">&quot;frida&quot;</span>) || <span class="hljs-built_in">my_strstr</span>(line, <span class="hljs-string">&quot;gadget&quot;</span>)) &#123;  <br>                <span class="hljs-comment">// 如果找到了，关闭文件并返回true，表示检测到了恶意库  </span><br>                <span class="hljs-built_in">fclose</span>(fp);  <br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <br>            &#125;  <br>        &#125;  <br>        <span class="hljs-comment">// 遍历完文件后，关闭文件  </span><br>        <span class="hljs-built_in">fclose</span>(fp);  <br>    &#125; <span class="hljs-keyword">else</span> &#123;  <br>        <span class="hljs-comment">// 如果无法打开文件，记录错误。这可能意味着系统状态异常  </span><br>        <span class="hljs-comment">// 注意：这里的代码没有处理错误，只是注释说明了可能的情况  </span><br>    &#125;  <br>    <span class="hljs-comment">// 如果没有在内存映射文件中找到&quot;frida&quot;，返回false，表示没有检测到恶意库  </span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <br>&#125;  <br>  <br><span class="hljs-comment">//自实现了libc里的几个系统函数  </span><br>__attribute__((always_inline))  <br><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">char</span> *  </span><br><span class="hljs-function"><span class="hljs-title">my_strstr</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *s, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *find)</span>  </span><br><span class="hljs-function"></span>&#123;  <br>    <span class="hljs-type">char</span> c, sc;  <br>    <span class="hljs-type">size_t</span> len;  <br>  <br>    <span class="hljs-keyword">if</span> ((c = *find++) != <span class="hljs-string">&#x27;\0&#x27;</span>) &#123;  <br>        len = <span class="hljs-built_in">my_strlen</span>(find);  <br>        <span class="hljs-keyword">do</span> &#123;  <br>            <span class="hljs-keyword">do</span> &#123;  <br>                <span class="hljs-keyword">if</span> ((sc = *s++) == <span class="hljs-string">&#x27;\0&#x27;</span>)  <br>                    <span class="hljs-keyword">return</span> (<span class="hljs-literal">NULL</span>);  <br>            &#125; <span class="hljs-keyword">while</span> (sc != c);  <br>        &#125; <span class="hljs-keyword">while</span> (<span class="hljs-built_in">my_strncmp</span>(s, find, len) != <span class="hljs-number">0</span>);  <br>        s--;  <br>    &#125;  <br>    <span class="hljs-keyword">return</span> ((<span class="hljs-type">char</span> *)s);  <br>&#125;  <br>  <br></code></pre></td></tr></table></figure>























<h5 id="objection"><a href="#objection" class="headerlink" title="objection"></a>objection</h5><hr>
<p>objection是基于frida的命令行hook集合工具, 可以让你不写代码, 敲几句命令就可以对java函数的高颗粒度hook, 还支持RPC调用。可以实现诸如内存搜索、类和模块搜索、方法hook打印参数返回值调用栈等常用功能，是一个非常方便的，逆向必备、内存漫游神器。</p>
<p>注入命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">objection -g 包名 explore<br><br>-   <span class="hljs-built_in">help</span>：不知道当前命令的效果是什么，在当前命令前加<span class="hljs-built_in">help</span>比如:<span class="hljs-built_in">help</span> <span class="hljs-built_in">env</span>，回车之后会出现当前命令的解释信息<br>-   按空格：不知道输入什么就按空格，会有提示出来<br>-   <span class="hljs-built_in">jobs</span>：可以进行多项hook<br>-   日志：objection的日志文件生成在 C:\Users\Administrator\.objection<br></code></pre></td></tr></table></figure>

<p>启动前就hook</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">objection -<span class="hljs-selector-tag">g</span> 进程名 explore <span class="hljs-attr">--startup-command</span> <span class="hljs-string">&quot;android hooking watch class 路径.类名&quot;</span><br></code></pre></td></tr></table></figure>

<p>objection基础api</p>
<ul>
<li>memory list modules -查看内存中加载的库</li>
</ul>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs vim">memory <span class="hljs-keyword">list</span> modules<br>Save the output by adding `--json modules.json` <span class="hljs-keyword">to</span> this <span class="hljs-keyword">command</span><br>Name                                                              Base          Size                 Path<br>----------------------------------------------------------------  ------------  -------------------  ------------------------------------------------------------------------------<br>app_process64                                                     <span class="hljs-number">0</span>x57867c9000  <span class="hljs-number">40960</span> (<span class="hljs-number">40.0</span> KiB)     /<span class="hljs-built_in">system</span>/bin/app_process64<br>linker64                                                          <span class="hljs-number">0</span>x72e326a000  <span class="hljs-number">229376</span> (<span class="hljs-number">224.0</span> KiB)   /<span class="hljs-built_in">system</span>/bin/linker64<br>libandroid_runtime.<span class="hljs-keyword">so</span>                                             <span class="hljs-number">0</span>x72e164e000  <span class="hljs-number">2113536</span> (<span class="hljs-number">2.0</span> MiB)    /<span class="hljs-built_in">system</span>/lib64/libandroid_runtime.<span class="hljs-keyword">so</span><br>libbase.<span class="hljs-keyword">so</span>                                                        <span class="hljs-number">0</span>x72dfa67000  <span class="hljs-number">81920</span> (<span class="hljs-number">80.0</span> KiB)     /<span class="hljs-built_in">system</span>/lib64/libbase.<span class="hljs-keyword">so</span><br>libbinder.<span class="hljs-keyword">so</span>                                                      <span class="hljs-number">0</span>x72dec1c000  <span class="hljs-number">643072</span> (<span class="hljs-number">628.0</span> KiB)   /<span class="hljs-built_in">system</span>/lib64/libbinder.<span class="hljs-keyword">so</span><br>libcutils.<span class="hljs-keyword">so</span>                                                      <span class="hljs-number">0</span>x72de269000  <span class="hljs-number">86016</span> (<span class="hljs-number">84.0</span> KiB)     /<span class="hljs-built_in">system</span>/lib64/libcutils.<span class="hljs-keyword">so</span><br>libhidlbase.<span class="hljs-keyword">so</span>                                                    <span class="hljs-number">0</span>x72df4cc000  <span class="hljs-number">692224</span> (<span class="hljs-number">676.0</span> KiB)   /<span class="hljs-built_in">system</span>/lib64/libhidlbase.<span class="hljs-keyword">so</span><br>liblog.<span class="hljs-keyword">so</span>                                                         <span class="hljs-number">0</span>x72e0be1000  <span class="hljs-number">98304</span> (<span class="hljs-number">96.0</span> KiB)     /<span class="hljs-built_in">system</span>/lib64/liblog<br></code></pre></td></tr></table></figure>

<ul>
<li>memory list exports so名称 - 查看库的导出函数</li>
</ul>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs ada">memory list exports liblog.so<br>Save the output by adding `<span class="hljs-comment">--json exports.json` to this command</span><br><span class="hljs-keyword">Type</span>      <span class="hljs-type">Name                                  </span>Address<br><span class="hljs-comment">--------  ------------------------------------  ------------</span><br><span class="hljs-keyword">function</span>  <span class="hljs-title">android_log_write_int32</span>               0x72e0be77c8<br><span class="hljs-keyword">function</span>  <span class="hljs-title">android_log_write_list_begin</span>          0x72e0be76f0<br><span class="hljs-keyword">function</span>  <span class="hljs-title">__android_log_bswrite</span>                 0x72e0be9bd8<br><span class="hljs-keyword">function</span>  <span class="hljs-title">__android_log_security</span>                0x72e0bf2144<br><span class="hljs-keyword">function</span>  <span class="hljs-title">__android_log_bwrite</span>                  0x72e0be9a18<br><span class="hljs-keyword">function</span>  <span class="hljs-title">android_log_reset</span>                     0x72e0be75ec<br><span class="hljs-keyword">function</span>  <span class="hljs-title">android_log_write_string8</span>             0x72e0be7a38<br><span class="hljs-keyword">function</span>  <span class="hljs-title">android_logger_list_free</span>              0x72e0be8c04<br><span class="hljs-keyword">function</span>  <span class="hljs-title">__android_log_print</span>                   0x72e0be9728<br><span class="hljs-keyword">function</span>  <span class="hljs-title">__android_logger_property_get_bool</span>    0x72e0bf2248<br><span class="hljs-keyword">function</span>  <span class="hljs-title">android_logger_get_id</span>                 0x72e0be8270<br><span class="hljs-keyword">function</span>  <span class="hljs-title">android_logger_set_prune_list</span>         0x72e0be8948<br></code></pre></td></tr></table></figure>

<ul>
<li>android hooking list activities -查看内存中加载的activity &#x2F;android hooking list services -查看内存中加载的services</li>
</ul>
<p><img src="image-20240719150546826.png" srcset="/img/loading.gif" lazyload alt="image-20240719150546826"></p>
<ul>
<li><p>android intent launch_activity 类名 -启动activity或service(可以用于一些没有验证的activity,在一些简单的ctf中有时候可以出奇效)</p>
</li>
<li><p>关闭ssl校验  android sslpinning disable</p>
</li>
<li><p>关闭root检测  android root disable</p>
</li>
</ul>
<p><strong>objection内存漫游</strong></p>
<ul>
<li>内存搜刮类实例</li>
</ul>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs smali">android heap search instances 类名(命令)<br>Class<span class="hljs-built_in"> instance </span>enumeration complete for com.zj.wuaipojie.Demo  <br> Hashcode  Class                  toString()<br>---------  ---------------------  -----------------------------<br>215120583  com.zj.wuaipojie.Demo  com.zj.wuaipojie.Demo@cd27ac7<br></code></pre></td></tr></table></figure>

<ul>
<li>调用实例的方法</li>
</ul>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs smali">android heap<span class="hljs-built_in"> execute </span>&lt;handle&gt; getPublicInt(实例的hashcode+方法名)<br>如果是带参数的方法，则需要进入编辑器环境  <br>android heap evaluate &lt;handle&gt;  <br>console.log(clazz.a(<span class="hljs-string">&quot;吾爱破解&quot;</span>));<br>按住esc+enter触发<br></code></pre></td></tr></table></figure>

<ul>
<li>android hooking list classes -列出内存中所有的类(结果比静态分析的更准确)</li>
</ul>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs stylus">android hooking list classes <br><br>tw<span class="hljs-selector-class">.idv</span><span class="hljs-selector-class">.palatis</span><span class="hljs-selector-class">.xappdebug</span><span class="hljs-selector-class">.MainApplication</span><br>tw<span class="hljs-selector-class">.idv</span><span class="hljs-selector-class">.palatis</span><span class="hljs-selector-class">.xappdebug</span><span class="hljs-selector-class">.xposed</span><span class="hljs-selector-class">.HookMain</span><br>tw<span class="hljs-selector-class">.idv</span><span class="hljs-selector-class">.palatis</span><span class="hljs-selector-class">.xappdebug</span><span class="hljs-selector-class">.xposed</span>.HookMain<span class="hljs-variable">$a</span><br>tw<span class="hljs-selector-class">.idv</span><span class="hljs-selector-class">.palatis</span><span class="hljs-selector-class">.xappdebug</span><span class="hljs-selector-class">.xposed</span>.HookMain<span class="hljs-variable">$b</span><br>tw<span class="hljs-selector-class">.idv</span><span class="hljs-selector-class">.palatis</span><span class="hljs-selector-class">.xappdebug</span><span class="hljs-selector-class">.xposed</span>.HookMain<span class="hljs-variable">$c</span><br>tw<span class="hljs-selector-class">.idv</span><span class="hljs-selector-class">.palatis</span><span class="hljs-selector-class">.xappdebug</span><span class="hljs-selector-class">.xposed</span>.HookMain<span class="hljs-variable">$d</span><br>tw<span class="hljs-selector-class">.idv</span><span class="hljs-selector-class">.palatis</span><span class="hljs-selector-class">.xappdebug</span><span class="hljs-selector-class">.xposed</span><span class="hljs-selector-class">.HookSelf</span><br>u<br>v<br>void<br>w<br>xposed<span class="hljs-selector-class">.dummy</span><span class="hljs-selector-class">.XResourcesSuperClass</span><br>xposed<span class="hljs-selector-class">.dummy</span><span class="hljs-selector-class">.XTypedArraySuperClass</span><br><br>Found <span class="hljs-number">10798</span> classes<br></code></pre></td></tr></table></figure>

<ul>
<li>android hooking search classes 关键类名 -在内存中所有已加载的类中搜索包含特定关键词的类</li>
</ul>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs stylus">android hooking search classes wuaipojie<br>Note that Java classes are only loaded when they are used, so <span class="hljs-keyword">if</span> the expected class has not been found, it might not have been loaded yet.<br>com<span class="hljs-selector-class">.zj</span><span class="hljs-selector-class">.wuaipojie</span><span class="hljs-selector-class">.Demo</span><br>com<span class="hljs-selector-class">.zj</span><span class="hljs-selector-class">.wuaipojie</span>.Demo<span class="hljs-variable">$Animal</span><br>com<span class="hljs-selector-class">.zj</span><span class="hljs-selector-class">.wuaipojie</span>.Demo<span class="hljs-variable">$Companion</span><br>com<span class="hljs-selector-class">.zj</span><span class="hljs-selector-class">.wuaipojie</span>.Demo<span class="hljs-variable">$InnerClass</span><br>com<span class="hljs-selector-class">.zj</span><span class="hljs-selector-class">.wuaipojie</span>.Demo<span class="hljs-variable">$test</span>$<span class="hljs-number">1</span><br>com<span class="hljs-selector-class">.zj</span><span class="hljs-selector-class">.wuaipojie</span><span class="hljs-selector-class">.MainApplication</span><br>com<span class="hljs-selector-class">.zj</span><span class="hljs-selector-class">.wuaipojie</span><span class="hljs-selector-class">.databinding</span><span class="hljs-selector-class">.ActivityMainBinding</span><br>... <br><br>Found <span class="hljs-number">38</span> classes<br></code></pre></td></tr></table></figure>

<ul>
<li><p>android hooking search methods 关键方法名 -在内存中所有已加载的类的方法中搜索包含特定关键词的方法(一般不建议使用，特别耗时，还可能崩溃)</p>
</li>
<li><p>android hooking list class_methods 类名 -内存漫游类中的所有方法</p>
</li>
</ul>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs stylus">android hooking list class_methods com<span class="hljs-selector-class">.zj</span><span class="hljs-selector-class">.wuaipojie</span><span class="hljs-selector-class">.ui</span><span class="hljs-selector-class">.ChallengeSixth</span><br>private static final void com<span class="hljs-selector-class">.zj</span><span class="hljs-selector-class">.wuaipojie</span><span class="hljs-selector-class">.ui</span><span class="hljs-selector-class">.ChallengeSixth</span>.onCreate<span class="hljs-variable">$lambda</span><span class="hljs-built_in">-0</span>(com<span class="hljs-selector-class">.zj</span><span class="hljs-selector-class">.wuaipojie</span><span class="hljs-selector-class">.ui</span><span class="hljs-selector-class">.ChallengeSixth</span>,android<span class="hljs-selector-class">.view</span>.View)<br>private static final void com<span class="hljs-selector-class">.zj</span><span class="hljs-selector-class">.wuaipojie</span><span class="hljs-selector-class">.ui</span><span class="hljs-selector-class">.ChallengeSixth</span>.onCreate<span class="hljs-variable">$lambda</span><span class="hljs-built_in">-1</span>(com<span class="hljs-selector-class">.zj</span><span class="hljs-selector-class">.wuaipojie</span><span class="hljs-selector-class">.ui</span><span class="hljs-selector-class">.ChallengeSixth</span>,android<span class="hljs-selector-class">.view</span>.View)<br>private static final void com<span class="hljs-selector-class">.zj</span><span class="hljs-selector-class">.wuaipojie</span><span class="hljs-selector-class">.ui</span><span class="hljs-selector-class">.ChallengeSixth</span>.onCreate<span class="hljs-variable">$lambda</span><span class="hljs-built_in">-2</span>(com<span class="hljs-selector-class">.zj</span><span class="hljs-selector-class">.wuaipojie</span><span class="hljs-selector-class">.ui</span><span class="hljs-selector-class">.ChallengeSixth</span>,android<span class="hljs-selector-class">.view</span>.View)<br>private static final void com<span class="hljs-selector-class">.zj</span><span class="hljs-selector-class">.wuaipojie</span><span class="hljs-selector-class">.ui</span><span class="hljs-selector-class">.ChallengeSixth</span>.onCreate<span class="hljs-variable">$lambda</span><span class="hljs-built_in">-3</span>(com<span class="hljs-selector-class">.zj</span><span class="hljs-selector-class">.wuaipojie</span><span class="hljs-selector-class">.ui</span><span class="hljs-selector-class">.ChallengeSixth</span>,android<span class="hljs-selector-class">.view</span>.View)<br>protected void com<span class="hljs-selector-class">.zj</span><span class="hljs-selector-class">.wuaipojie</span><span class="hljs-selector-class">.ui</span><span class="hljs-selector-class">.ChallengeSixth</span><span class="hljs-selector-class">.onCreate</span>(android<span class="hljs-selector-class">.os</span>.Bundle)<br>public final java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.String</span> com<span class="hljs-selector-class">.zj</span><span class="hljs-selector-class">.wuaipojie</span><span class="hljs-selector-class">.ui</span><span class="hljs-selector-class">.ChallengeSixth</span><span class="hljs-selector-class">.hexToString</span>(java<span class="hljs-selector-class">.lang</span>.String)<br>public final java<span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.String</span> com<span class="hljs-selector-class">.zj</span><span class="hljs-selector-class">.wuaipojie</span><span class="hljs-selector-class">.ui</span><span class="hljs-selector-class">.ChallengeSixth</span><span class="hljs-selector-class">.unicodeToString</span>(java<span class="hljs-selector-class">.lang</span>.String)<br>public final void com<span class="hljs-selector-class">.zj</span><span class="hljs-selector-class">.wuaipojie</span><span class="hljs-selector-class">.ui</span><span class="hljs-selector-class">.ChallengeSixth</span><span class="hljs-selector-class">.toastPrint</span>(java<span class="hljs-selector-class">.lang</span>.String)<br>public static void com<span class="hljs-selector-class">.zj</span><span class="hljs-selector-class">.wuaipojie</span><span class="hljs-selector-class">.ui</span><span class="hljs-selector-class">.ChallengeSixth</span>.<span class="hljs-variable">$r8</span><span class="hljs-variable">$lambda</span>$<span class="hljs-number">1</span><span class="hljs-built_in">lrkrgiCEFWXZDHzLRibYURG1h8</span>(com<span class="hljs-selector-class">.zj</span><span class="hljs-selector-class">.wuaipojie</span><span class="hljs-selector-class">.ui</span><span class="hljs-selector-class">.ChallengeSixth</span>,android<span class="hljs-selector-class">.view</span>.View)<br>public static void com<span class="hljs-selector-class">.zj</span><span class="hljs-selector-class">.wuaipojie</span><span class="hljs-selector-class">.ui</span><span class="hljs-selector-class">.ChallengeSixth</span>.<span class="hljs-variable">$r8</span><span class="hljs-variable">$lambda</span><span class="hljs-variable">$IUqwMqbTKaOGiTaeOmvy_GjNBso</span>(com<span class="hljs-selector-class">.zj</span><span class="hljs-selector-class">.wuaipojie</span><span class="hljs-selector-class">.ui</span><span class="hljs-selector-class">.ChallengeSixth</span>,android<span class="hljs-selector-class">.view</span>.View)<br>public static void com<span class="hljs-selector-class">.zj</span><span class="hljs-selector-class">.wuaipojie</span><span class="hljs-selector-class">.ui</span><span class="hljs-selector-class">.ChallengeSixth</span>.<span class="hljs-variable">$r8</span><span class="hljs-variable">$lambda</span><span class="hljs-variable">$Kc_cRYZjjhjsTl6GYNHbgD</span><span class="hljs-built_in">-i6sE</span>(com<span class="hljs-selector-class">.zj</span><span class="hljs-selector-class">.wuaipojie</span><span class="hljs-selector-class">.ui</span><span class="hljs-selector-class">.ChallengeSixth</span>,android<span class="hljs-selector-class">.view</span>.View)<br>public static void com<span class="hljs-selector-class">.zj</span><span class="hljs-selector-class">.wuaipojie</span><span class="hljs-selector-class">.ui</span><span class="hljs-selector-class">.ChallengeSixth</span>.<span class="hljs-variable">$r8</span><span class="hljs-variable">$lambda</span><span class="hljs-variable">$PDKm2AfziZQo6Lv1HEFkJWkUsoE</span>(com<span class="hljs-selector-class">.zj</span><span class="hljs-selector-class">.wuaipojie</span><span class="hljs-selector-class">.ui</span><span class="hljs-selector-class">.ChallengeSixth</span>,android<span class="hljs-selector-class">.view</span>.View)<br><br>Found <span class="hljs-number">12</span> <span class="hljs-built_in">method</span>(s)<br></code></pre></td></tr></table></figure>



<p><strong>objectionHook</strong></p>
<ul>
<li>hook类的所有方法</li>
</ul>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs actionscript">android hooking watch <span class="hljs-keyword">class</span> 类名<br></code></pre></td></tr></table></figure>

<ul>
<li>hook方法的参数、返回值和调用栈</li>
</ul>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle">android hooking watch class_method 类名.方法名 --<span class="hljs-keyword">dump</span>-args --<span class="hljs-keyword">dump</span>-<span class="hljs-keyword">return</span> --<span class="hljs-keyword">dump</span>-backtrace<br></code></pre></td></tr></table></figure>

<ul>
<li>hook 类的构造方法</li>
</ul>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">android</span> hooking watch class_method 类名.<span class="hljs-variable">$init</span><br></code></pre></td></tr></table></figure>

<ul>
<li>hook 方法的所有重载</li>
</ul>
<figure class="highlight ceylon"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ceylon">android hooking watch <span class="hljs-keyword">class</span><span class="hljs-number">_m</span>ethod 类名.方法名<br></code></pre></td></tr></table></figure>







<h5 id="修改参数的change-args-函数"><a href="#修改参数的change-args-函数" class="headerlink" title="修改参数的change_args()函数"></a>修改参数的change_args()函数</h5><hr>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">function</span> change_args&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Script loaded successfully&quot;</span>)<br>    <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Inside java perform function&quot;</span>)<br>        <span class="hljs-keyword">var</span> <span class="hljs-title class_">MainActivity</span> = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&#x27;com.roysue.demo02.MainActivity&#x27;</span>)<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Java.Use.Successfully!&quot;</span>)<br>        <span class="hljs-title class_">MainActivity</span>.<span class="hljs-property">fun</span>.<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">x,y</span>)&#123;<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;orignal args: x=&gt; &quot;</span>,x,<span class="hljs-string">&quot;, y =&gt;  &quot;</span>,y)<br>            <span class="hljs-keyword">var</span> ret_value = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">fun</span>(<span class="hljs-number">2</span>,<span class="hljs-number">5</span>);<br>            <span class="hljs-keyword">return</span> ret_value<br>        &#125;<br>    &#125;)<br>&#125;<br></code></pre></td></tr></table></figure>



<h5 id="setImmediate（Frida的API函数）"><a href="#setImmediate（Frida的API函数）" class="headerlink" title="setImmediate（Frida的API函数）"></a>setImmediate（Frida的API函数）</h5><p>函数传递的参数是要被执行 的函数，比如传入main参数，表示当Frida注入App后立即执行 main()函数。这个函数和setTimeout()函数类似，都是用于指定要执 行的函数，不同的是setTimeout可以用于指定Frida注入App多长时 间后执行函数，往往用于延时注入。</p>
<h5 id="Java层主动调用"><a href="#Java层主动调用" class="headerlink" title="Java层主动调用"></a>Java层主动调用</h5><p>主动调用就是强制调用一个函数去执行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">void</span> <span class="hljs-title function_">secret</span><span class="hljs-params">()</span>&#123;<br>    Log.d(<span class="hljs-string">&quot;r0ysue.secret&quot;</span> , <span class="hljs-string">&quot;this is secret func&quot;</span>);<br>&#125;<br><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">staticSecret</span><span class="hljs-params">()</span> &#123;  <span class="hljs-comment">//加了static修饰词</span><br>  Log.d(<span class="hljs-string">&quot;r0ysue.secret&quot;</span> , <span class="hljs-string">&quot;this is static secretic secrtic func&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>根据这个特殊性，hook的方式也不一样</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"></span>)&#123;<br>     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Script loaded successfully &quot;</span>)<br>     <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-params"><span class="hljs-keyword">function</span></span>)&#123;<br>         <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Inside java perform function&quot;</span>)<br>         <br>         <span class="hljs-comment">//静态函数主动调用,static修饰</span><br>         <span class="hljs-keyword">var</span> <span class="hljs-title class_">MainActivicy</span> = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&#x27;com.roysue.demo02.MainActivity&#x27;</span>)  <span class="hljs-comment">//lei&#x27;mi</span><br>         <span class="hljs-title class_">MainActivity</span>.<span class="hljs-title function_">staticSecret</span>()  <span class="hljs-comment">//调用MainActivity类的静态方法staticSecret()。</span><br>         <br>         <span class="hljs-comment">//动态函数主动调用</span><br>         <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">choose</span>(<span class="hljs-string">&#x27;com.roysue.demo02,MainActivity&#x27;</span>,&#123;<br>              <span class="hljs-attr">onMatch</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">instance</span>)&#123;<br>                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;instance found&#x27;</span>,instance)<br>                    instance.<span class="hljs-title function_">secret</span>() <span class="hljs-comment">//调用实例的secret()方法。</span><br>              &#125;.<br>              <span class="hljs-attr">onComplete</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>                 <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;search Complete&#x27;</span>)<br>              &#125;<br>         &#125;)<br>     &#125;)<br>&#125; <br><span class="hljs-title function_">setImmediate</span>(mian)<br></code></pre></td></tr></table></figure>

<h5 id="RPC及其自动化"><a href="#RPC及其自动化" class="headerlink" title="RPC及其自动化"></a>RPC及其自动化</h5><p>加了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">total</span> <span class="hljs-operator">=</span> “hello”<br><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">secret</span><span class="hljs-params">()</span> &#123;<br>    total += <span class="hljs-string">&quot; secreFunc&quot;</span>;<br>    Log.d(<span class="hljs-string">&quot;r0ysue.secret&quot;</span>,<span class="hljs-string">&quot;this is secret func&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>获取total这个实例变量的值</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">CallSecretFunc</span>(<span class="hljs-params"></span>)&#123;<br>   <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>   <br>   <span class="hljs-comment">//动态函数主动调用</span><br>   <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">choose</span>(<span class="hljs-string">&#x27;com.roysue.demo02.MainActivity&#x27;</span>,&#123;<br>     <span class="hljs-attr">onMatch</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">instance</span>)&#123;<br>         instance.<span class="hljs-title function_">secret</span>()<br>     &#125;,<br>     <span class="hljs-attr">onComplete</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>     &#125;<br>     &#125;)<br>   &#125;)<br>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">gentTotalValue</span>(<span class="hljs-params"></span>)&#123;<br>   <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;Inside java perform function&quot;</span>)<br>      <span class="hljs-keyword">var</span> <span class="hljs-title class_">MainActivity</span> = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">&#x27;com.roysue.demo02.MainActivity&#x27;</span>)<br>      <br>      <span class="hljs-comment">//动态函数主动调用</span><br>      <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">choose</span>(<span class="hljs-string">&#x27;com.roysue.demo02.MainActivity,&#123;</span><br><span class="hljs-string">          onMatch: function(instance)&#123;</span><br><span class="hljs-string">          console.log(&#x27;</span>instance found<span class="hljs-string">&#x27;,instance)</span><br><span class="hljs-string">          instance.secret()</span><br><span class="hljs-string">          console.log(&#x27;</span>total value = <span class="hljs-string">&#x27;,instance.total.value)</span><br><span class="hljs-string">          console.log(&#x27;</span>secret func exec success<span class="hljs-string">&#x27;)&#125;</span><br><span class="hljs-string">          &#125;,</span><br><span class="hljs-string">          onComplete: function()&#123;</span><br><span class="hljs-string">             console.log(&#x27;</span>search <span class="hljs-title class_">Complete</span><span class="hljs-string">&#x27;)</span><br><span class="hljs-string">          &#125;</span><br><span class="hljs-string">      &#125;)</span><br><span class="hljs-string">   &#125;)</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">setImmediate(getTotalValue)</span><br></code></pre></td></tr></table></figure>

<p>如果调用CallSecretFunc()函数，然后再次获取total的值，就会发现total的值已经变为hello secretFunc</p>
<p>loader.py</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">import</span> frida, sys<br><br>def <span class="hljs-title function_">on_message</span>(message, data):<br>    <span class="hljs-keyword">if</span> message[<span class="hljs-string">&#x27;type&#x27;</span>] == <span class="hljs-string">&#x27;send&#x27;</span>:<br>         <span class="hljs-title function_">print</span>(<span class="hljs-string">&quot;[*] &#123;0&#125;&quot;</span>.<span class="hljs-title function_">format</span>(message[<span class="hljs-string">&#x27;payload&#x27;</span>]))<br>     <span class="hljs-attr">else</span>:<br>         <span class="hljs-title function_">print</span>(message)<br>device = frida.<span class="hljs-title function_">get_usb_device</span>()  <span class="hljs-comment">//获取到USB设备句柄</span><br>process = device.<span class="hljs-title function_">attach</span>(<span class="hljs-string">&#x27;com.soysue.demo02&#x27;</span>)  <span class="hljs-comment">//进程注入</span><br><br><span class="hljs-keyword">with</span> <span class="hljs-title function_">open</span>(<span class="hljs-string">&#x27;4.js&#x27;</span>) <span class="hljs-keyword">as</span> <span class="hljs-attr">f</span>:<br>     jscode = f.<span class="hljs-title function_">read</span>()<br>srcipt = process.<span class="hljs-title function_">create_scripy</span>(jscode) <span class="hljs-comment">//加载代码</span><br>sricpt.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;message&#x27;</span>, on_message)  <span class="hljs-comment">//注册自己的消息对应函数</span><br>script.<span class="hljs-title function_">load</span>()<br><br>command = <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-keyword">while</span> <span class="hljs-number">1</span> == <span class="hljs-number">1</span> :<br>       commmand = <span class="hljs-title function_">input</span>(<span class="hljs-string">&quot;\nEnter command:\n1:Exit\n: Call secret function\n3:Get Total Value\nchoice&quot;</span>)<br>       <span class="hljs-keyword">if</span> command == <span class="hljs-string">&quot;1&quot;</span>:<br>          <span class="hljs-keyword">break</span><br>       elif command == <span class="hljs-string">&quot;2&quot;</span>:  <span class="hljs-comment">//在这里调用</span><br>          script.<span class="hljs-property">exports</span>.<span class="hljs-title function_">callsecretfunc</span>()<br>       elif command == <span class="hljs-string">&quot;3&quot;</span>:<br>          script.<span class="hljs-property">exports</span>.<span class="hljs-title function_">gettotalvalue</span>()<br></code></pre></td></tr></table></figure>







<h5 id="frida特征改写"><a href="#frida特征改写" class="headerlink" title="frida特征改写"></a>frida特征改写</h5><hr>
<p>hook</p>
<p>hook libc下的pthread_create，打印so</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hook_func</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">var</span> pthread_creat_addr = <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">findExportByName</span>(<span class="hljs-string">&quot;libc.so&quot;</span>, <span class="hljs-string">&quot;pthread_create&quot;</span>)<br>    <span class="hljs-title class_">Interceptor</span>.<span class="hljs-title function_">attach</span>(pthread_creat_addr,&#123;<br>        <span class="hljs-title function_">onEnter</span>(<span class="hljs-params">args</span>)&#123;<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;call pthread_create...&quot;</span>)<br>            <span class="hljs-keyword">let</span> func_addr = args[<span class="hljs-number">2</span>]<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;The thread function address is &quot;</span> + func_addr)<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;pthread_create called from:\n&#x27;</span><br>            + <span class="hljs-title class_">Thread</span>.<span class="hljs-title function_">backtrace</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, <span class="hljs-title class_">Backtracer</span>.<span class="hljs-property">ACCURATE</span>)<br>            .<span class="hljs-title function_">map</span>(<span class="hljs-title class_">DebugSymbol</span>.<span class="hljs-property">fromAddress</span>)<br>            .<span class="hljs-title function_">join</span>(<span class="hljs-string">&#x27;\n&#x27;</span>)<br>             + <span class="hljs-string">&#x27;\n&#x27;</span>);<br>        &#125;<br>    &#125;)<br>&#125;<br><br></code></pre></td></tr></table></figure>



<p>open查看so的加载进程</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> pth = <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">findExportByName</span>(<span class="hljs-literal">null</span>,<span class="hljs-string">&quot;open&quot;</span>);<br>    <span class="hljs-title class_">Interceptor</span>.<span class="hljs-title function_">attach</span>(<span class="hljs-title function_">ptr</span>(pth),&#123;<br>        <span class="hljs-attr">onEnter</span>:<span class="hljs-keyword">function</span>(<span class="hljs-params">args</span>)&#123;<br>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">filename</span> = args[<span class="hljs-number">0</span>];<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;&quot;</span>,<span class="hljs-variable language_">this</span>.<span class="hljs-property">filename</span>.<span class="hljs-title function_">readCString</span>())<br>            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">filename</span>.<span class="hljs-title function_">readCString</span>().<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&quot;.so&quot;</span>) != -<span class="hljs-number">1</span>)&#123;<br>                args[<span class="hljs-number">0</span>] = <span class="hljs-title function_">ptr</span>(<span class="hljs-number">0</span>)<br> <br>            &#125;<br> <br>        &#125;,<span class="hljs-attr">onLeave</span>:<span class="hljs-keyword">function</span>(<span class="hljs-params">retval</span>)&#123;<br>            <span class="hljs-keyword">return</span> retval;<br>        &#125;<br>    &#125;)<br></code></pre></td></tr></table></figure>

<p>maps检测绕过</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> openPtr = <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">getExportByName</span>(<span class="hljs-string">&#x27;libc.so&#x27;</span>, <span class="hljs-string">&#x27;open&#x27;</span>);  <span class="hljs-comment">//获取libc.so的open函数</span><br>  <span class="hljs-keyword">const</span> open = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NativeFunction</span>(openPtr, <span class="hljs-string">&#x27;int&#x27;</span>, [<span class="hljs-string">&#x27;pointer&#x27;</span>, <span class="hljs-string">&#x27;int&#x27;</span>]); <span class="hljs-comment">//封装为open函数</span><br>  <span class="hljs-keyword">var</span> readPtr = <span class="hljs-title class_">Module</span>.<span class="hljs-title function_">findExportByName</span>(<span class="hljs-string">&quot;libc.so&quot;</span>, <span class="hljs-string">&quot;read&quot;</span>);  <span class="hljs-comment">//获取libc。so的read函数</span><br>  <span class="hljs-keyword">var</span> read = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NativeFunction</span>(readPtr, <span class="hljs-string">&#x27;int&#x27;</span>, [<span class="hljs-string">&#x27;int&#x27;</span>, <span class="hljs-string">&#x27;pointer&#x27;</span>, <span class="hljs-string">&quot;int&quot;</span>]); <span class="hljs-comment">//封装变量</span><br>  <span class="hljs-keyword">var</span> fakePath = <span class="hljs-string">&quot;/data/data/com.app/maps&quot;</span>;<br>  <span class="hljs-keyword">var</span> file = <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(fakePath, <span class="hljs-string">&quot;w&quot;</span>);  <span class="hljs-comment">//在/data/data/com.app/maps创建文件</span><br>  <span class="hljs-keyword">var</span> buffer = <span class="hljs-title class_">Memory</span>.<span class="hljs-title function_">alloc</span>(<span class="hljs-number">512</span>); <span class="hljs-comment">//分配了一个512字节的内存缓冲区，用于读取文件内容。</span><br>  <span class="hljs-title class_">Interceptor</span>.<span class="hljs-title function_">replace</span>(openPtr, <span class="hljs-keyword">new</span> <span class="hljs-title class_">NativeCallback</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">pathnameptr, flag</span>) &#123; <span class="hljs-comment">//将openPrt进行替换，读取pathnameptr指向c语言字符串，然后转化为javascript字符串</span><br>      <span class="hljs-keyword">var</span> pathname = <span class="hljs-title class_">Memory</span>.<span class="hljs-title function_">readUtf8String</span>(pathnameptr);<br>      <span class="hljs-keyword">var</span> realFd = <span class="hljs-title function_">open</span>(pathnameptr, flag); <span class="hljs-comment">//获得真实的文件描述符</span><br>      <span class="hljs-keyword">if</span> (pathname.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&quot;maps&quot;</span>) &gt;= <span class="hljs-number">0</span>) &#123;  <span class="hljs-comment">//筛选“maps”</span><br>          <span class="hljs-keyword">while</span> (<span class="hljs-built_in">parseInt</span>(<span class="hljs-title function_">read</span>(realFd, buffer, <span class="hljs-number">512</span>)) !== <span class="hljs-number">0</span>) &#123;<br>              <span class="hljs-keyword">var</span> oneLine = <span class="hljs-title class_">Memory</span>.<span class="hljs-title function_">readCString</span>(buffer);<br>              <span class="hljs-keyword">if</span> (oneLine.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">&quot;tmp&quot;</span>) === -<span class="hljs-number">1</span>) &#123;  <span class="hljs-comment">//如果pathname中包含&quot;maps&quot;，则进入一个循环，通过read函数读取文件内容，并将非包含&quot;tmp&quot;的每一行写入file文件中。</span><br>                  file.<span class="hljs-title function_">write</span>(oneLine);<br>              &#125;<br>          &#125;<br>          <span class="hljs-keyword">var</span> filename = <span class="hljs-title class_">Memory</span>.<span class="hljs-title function_">allocUtf8String</span>(fakePath); <span class="hljs-comment">//分配一个以fakePath为值的UTF-8字符串filename</span><br>          <span class="hljs-keyword">return</span> <span class="hljs-title function_">open</span>(filename, flag);<br>      &#125;<br>      <span class="hljs-keyword">var</span> fd = <span class="hljs-title function_">open</span>(pathnameptr, flag);<br>      <span class="hljs-keyword">return</span> fd;<br>  &#125;, <span class="hljs-string">&#x27;int&#x27;</span>, [<span class="hljs-string">&#x27;pointer&#x27;</span>, <span class="hljs-string">&#x27;int&#x27;</span>]));<br>&#125;<br><span class="hljs-title function_">setImmediate</span>(main)<br></code></pre></td></tr></table></figure>


                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E7%AC%94%E8%AE%B0/" class="category-chain-item">笔记</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>frida抓包笔记</div>
      <div>http://example.com/2025/03/22/frida抓包笔记/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>hexi</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年3月22日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/03/22/java%E5%B8%B8%E8%A7%84%E6%BC%8F%E6%B4%9E/" title="java常规漏洞">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">java常规漏洞</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/03/22/Apache-Struts2%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E9%80%BB%E8%BE%91%E6%BC%8F%E6%B4%9ES2-067/" title="Apache Struts2文件上传逻辑漏洞S2-067">
                        <span class="hidden-mobile">Apache Struts2文件上传逻辑漏洞S2-067</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
